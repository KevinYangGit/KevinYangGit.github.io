---
title: å…³è”å¯¹è±¡
date: 2020-05-26 11:16:15
tags: OCåº•å±‚åŸç†
---
æ€è€ƒï¼š
* Category èƒ½å¦æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿå¦‚æœå¯ä»¥ï¼Œå¦‚ä½•ç»™ Category æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿ
* ç±»å¯¹è±¡å¯ä»¥å…³è”å¯¹è±¡å—ï¼Ÿ
* å…³è”å¯¹è±¡å­˜å‚¨åœ¨ä»€ä¹ˆä½ç½®ï¼Ÿ
* å¯¹è±¡åŠå…¶å…³è”å¯¹è±¡ä¹‹é—´æœ‰å¼ºå¼•ç”¨å…³ç³»å—ï¼Ÿ
* å¯¹è±¡é‡Šæ”¾åï¼Œå…³è”å¯¹è±¡ä¼šè¢«é‡Šæ”¾å—ï¼Ÿ

<!-- more -->

# Category çš„æˆå‘˜å˜é‡
## _category_t ç»“æ„ä½“
```
struct _category_t {
	const char *name; //ç±»å
	struct _class_t *cls; //çˆ¶ç±»
	const struct _method_list_t *instance_methods; //å¯¹è±¡æ–¹æ³•åˆ—è¡¨
	const struct _method_list_t *class_methods; //ç±»æ–¹æ³•åˆ—è¡¨
	const struct _protocol_list_t *protocols; //åè®®åˆ—è¡¨
	const struct _prop_list_t *properties; //å±æ€§åˆ—è¡¨
};
```

ä» _category_t çš„ç»“æ„ä½“å¯ä»¥çœ‹å‡ºï¼ŒCategory ä¸­å¹¶æ²¡æœ‰å­˜æ”¾æˆå‘˜å˜é‡çš„å®¹å™¨ï¼Œæ‰€ä»¥ Category æœ¬èº«æ˜¯ä¸æ”¯æŒæ·»åŠ æˆå‘˜å˜é‡çš„ã€‚

## åœ¨ Persion.h ä¸­å®šä¹‰å±æ€§
```
@interface Persion : NSObject
@property (nonatomic, assign) int age;
@end
```

åœ¨ Persion.h ä¸­å®šä¹‰äº†å±æ€§åï¼Œç³»ç»Ÿä¼šåœ¨ Persion.m é‡Œè‡ªåŠ¨åšä¸‰ä»¶äº‹ï¼š
```
@implementation Persion
{
    int _age; //ç¬¬ä¸€ä»¶äº‹ï¼šå®šä¹‰æˆå‘˜å˜é‡
}
//ç¬¬äºŒä»¶äº‹ï¼šå®ç° age çš„ set æ–¹æ³•
- (void)setAge:(int)age { 
    _age = age;
}
//ç¬¬ä¸‰ä»¶äº‹ï¼šå®ç° age çš„ get æ–¹æ³•
- (int)age { 
    return _age;
}
@end
```

## åœ¨ Persion+Test.h ä¸­å®šä¹‰å±æ€§
```
@interface Persion (Test)
@property (nonatomic, assign) int weight;
@end
```

åœ¨ Persion+Test.h ä¸­å®šä¹‰äº†å±æ€§åï¼Œç³»ç»Ÿä¼šåœ¨ Persion+Test.h é‡Œè‡ªåŠ¨æ˜¯å®ç°ä¸¤ä»¶äº‹ï¼š
```
@interface Persion (Test)
//ç¬¬ä¸€ä»¶äº‹ï¼šç”Ÿæˆ weight çš„ set æ–¹æ³•çš„å£°æ˜
- (void)setWeight:(int)weight;
//ç¬¬äºŒä»¶äº‹ï¼šç”Ÿæˆ weight çš„ get æ–¹æ³•çš„å£°æ˜
- (int)weight;
@end
```

åœ¨åˆ†ç±»é‡Œå®šä¹‰çš„å±æ€§ï¼Œå¹¶æ²¡æœ‰å¯¹åº”çš„æˆå‘˜å˜é‡å’Œ set/get æ–¹æ³•çš„å®ç°ã€‚å¦‚æœå°è¯•æ‰‹åŠ¨æ·»åŠ ï¼Œç³»ç»Ÿä¼šæŠ¥é”™ã€‚
![å…³è”å¯¹è±¡01](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡01.png)

## å®šä¹‰å…¨å±€å˜é‡ int weight_
```
int weight_;
@implementation Persion (Test)
- (void)setWeight:(int)weight {
    weight_ = weight;
}
- (int)weight {
    return weight_;
}
@end
```

é€šè¿‡å®šä¹‰å…¨å±€å˜é‡ _weight çš„æ–¹å¼å¯ä»¥å®ç°æˆå‘˜å˜é‡çš„æ•ˆæœï¼Œä½†æ˜¯ _weight æ˜¯å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ person ä¼šå…±ç”¨åŒä¸€ä¸ª _weightã€‚è¿™æ ·ä¼šå¯¼è‡´æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ person éƒ½å¯ä»¥ä¿®æ”¹ _weightï¼Œæ— æ³•ä¿è¯å•ä¸ªå®ä¾‹å¯¹è±¡ person ä¸ _weight ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

## å®šä¹‰å…¨å±€å˜é‡ NSMutableDictionary *weights_
```
NSMutableDictionary *weights_;
@implementation Persion (Test)
+ (void)load {
    weights_ = [NSMutableDictionary dictionary];
}
- (void)setWeight:(int)weight {
    NSString *key = [NSString stringWithFormat:@"%p", self];
    weights_[key] = @(weight);
}

- (int)weight {
    NSString *key = [NSString stringWithFormat:@"%p", self];
    return [weights_[key] intValue];
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Persion *persion1 = [[Persion alloc] init];
        persion1.age = 10;
        persion1.weight = 20;
        
        Persion *persion2 = [[Persion alloc] init];
        persion2.age = 30;
        persion2.weight = 40;
        
        NSLog(@"persion1.age = %d, persion1.wight = %d", persion1.age, persion1.weight);
        NSLog(@"persion2.age = %d, persion2.wight = %d",persion2.age, persion2.weight);
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
persion1.age = 10, persion1.wight = 20
persion2.age = 30, persion2.wight = 40
```

* æ³¨æ„ï¼š  
10å’Œ30æ˜¯å­˜å‚¨åœ¨ persion å¯¹è±¡çš„å†…éƒ¨ï¼Œ20å’Œ40æ˜¯å­˜æ”¾åœ¨å…¨å±€çš„å­—å…¸ weights_ å¯¹è±¡é‡Œé¢ã€‚

ä¼˜ç‚¹ï¼šé€šè¿‡å®šä¹‰å…¨å±€å˜é‡å­—å…¸ï¼Œä»¥ persion å¯¹è±¡çš„åœ°å€ä½œ keyï¼Œå±æ€§ weight ä½œ valueï¼Œä¿è¯äº† persion å¯¹è±¡ä¸ weight çš„ä¸€ä¸€å¯¹ç›¸åº”å…³ç³»ã€‚  
ç¼ºç‚¹ï¼šè¿™ç§æ–¹å¼å¯èƒ½ä¼šæœ‰çº¿ç¨‹é—®é¢˜ï¼Œåœ¨ - (void)setWeight:(int)weight æ–¹æ³•é‡Œéœ€è¦åŠ é”ã€‚å¦å¤–æ¯æ·»åŠ ä¸€ä¸ªå±æ€§å°±è¦å®šä¹‰ä¸€ä¸ªæ–°çš„å…¨å±€å˜é‡å­—å…¸ã€‚

## å°ç»“

* Category èƒ½å¦æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿå¦‚æœå¯ä»¥ï¼Œå¦‚ä½•ç»™ Category æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿ  
å› ä¸ºåˆ†ç±»åº•å±‚ç»“æ„çš„é™åˆ¶ï¼Œä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡åˆ°åˆ†ç±»ä¸­ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ¥é—´æ¥å®ç°ã€‚

# åŸºæœ¬ç”¨æ³•

## æ–¹æ³•åˆ—è¡¨
å‚æ•°ï¼š  
id _Nonnull objectï¼šéœ€è¦æ·»åŠ å…³è”å¯¹è±¡çš„å¯¹è±¡ï¼ˆé€šå¸¸å†™æ³•ä¼  selfï¼‰;  
const void * _Nonnull keyï¼šæŒ‡é’ˆç±»å‹ï¼Œä¿å­˜å…³è”å¯¹è±¡çš„keyï¼›  
id _Nullable valueï¼šå…³è”å¯¹è±¡ï¼›  
objc_AssociationPolicy policyï¼šå…³è”ç­–ç•¥ï¼›

æ·»åŠ å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT void
objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key,
                         id _Nullable value, objc_AssociationPolicy policy)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

è·å–å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT id _Nullable
objc_getAssociatedObject(id _Nonnull object, const void * _Nonnull key)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

ç§»é™¤æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT void
objc_removeAssociatedObjects(id _Nonnull object)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

### å…³è”ç­–ç•¥ objc_AssociationPolicy
```
typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) {
    OBJC_ASSOCIATION_ASSIGN = 0,           /**< Specifies a weak reference to the associated object. */
    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**< Specifies a strong reference to the associated object. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**< Specifies that the associated object is copied. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_RETAIN = 01401,       /**< Specifies a strong reference to the associated object.
                                            *   The association is made atomically. */
    OBJC_ASSOCIATION_COPY = 01403          /**< Specifies that the associated object is copied.
                                            *   The association is made atomically. */
};
```

å…³è”ç­–ç•¥ objc_AssociationPolicy ç±»ä¼¼äºå®šä¹‰å±æ€§æ—¶è®¾ç½®çš„å‚æ•°ï¼Œç¡®å®šè¦å…³è”çš„å¯¹è±¡çš„å†…å­˜å†…å­˜ç®¡ç†æ–¹å¼ã€‚

![å…³è”å¯¹è±¡02](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡02.png)

å…³è”ç­–ç•¥ä¸­æ²¡æœ‰ weekï¼Œå› ä¸ºå…³è”å¯¹è±¡çš„å®ç°å¹¶æ²¡æœ‰å¼±å¼•ç”¨æ•ˆæœã€‚

![å…³è”å¯¹è±¡05](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡05.png)

ğŸ‘†é€šè¿‡ OBJC_ASSOCIATION_ASSIGN ç­–ç•¥å…³è”äº†å¯¹è±¡ persion3ï¼Œæ­¤æ—¶åœ¨ ObjcAssociation å¯¹è±¡é‡Œçš„ value è®°ä½çš„æ˜¯å…³è”å¯¹è±¡ persion3 çš„åœ°å€å€¼ï¼Œå½“å…³è”å¯¹è±¡ persion3 ç¦»å¼€å¤§æ‹¬å·é”€æ¯åï¼Œvalue ä¾ç„¶ä¿å­˜ç€å…³è”å¯¹è±¡çš„åœ°å€å€¼ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™å†é€šè¿‡ value å»è®¿é—®å…³è”å¯¹è±¡å°±ä¼šå‡ºç°åå†…å­˜è®¿é—®çš„é”™è¯¯ã€‚

## keyçš„å¸¸è§ç”¨æ³•
å…ˆæ·»åŠ æ‰“å°ï¼š
```
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Persion *persion1 = [[Persion alloc] init];
        persion1.name = @"persion1";
        persion1.weight = 20;
        
        Persion *persion2 = [[Persion alloc] init];
        persion2.name = @"persion2";
        persion2.weight = 40;
        
        NSLog(@"persion1.name = %@, persion1.wight = %d", persion1.name, persion1.weight);
        NSLog(@"persion2.name = %@, persion2.wight = %d",persion2.name, persion2.weight);
    }
    return 0;
}
```

### ç”¨æ³•ä¸€ï¼šstatic const void *Key = &Key;
#### const void *Key;
```
@interface Person (Test)
@property (copy, nonatomic) NSString *name;
@property (assign, nonatomic) int weight;
@end

@implementation Person (Test)
const void *NameKey;
const void *WeightKey;
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, WeightKey) intValue];
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = 20, persion1.wight = 20
persion2.name = 40, persion2.wight = 40
```

å› ä¸ºè¿™ç§æ–¹å¼å®šä¹‰çš„ NameKey/WeightKey æ²¡æœ‰èµ‹å€¼ï¼Œéƒ½æ˜¯ NULLã€‚è¿™æ · name å’Œ weight åœ¨èµ‹å€¼æˆ–å–å€¼çš„æ—¶å€™ç”¨çš„ key éƒ½æ˜¯ NULLï¼Œæ‰€ä»¥æ‰“å°ç»“æœ name == weightã€‚

#### const void *Key = &Key;
ä¿®æ”¹ NameKey/WeightKey çš„å®šä¹‰ï¼š
```
const void *NameKey = &NameKey;
const void *WeightKey = &WeightKey;
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

è¿™æ ·å®šä¹‰çš„ NameKey/WeightKey å†…éƒ¨å­˜å‚¨çš„åˆ†åˆ«æ˜¯ NameKey/WeightKey çš„åœ°å€å€¼ï¼Œè¿™æ ·ä¿è¯äº† name å’Œ weight åœ¨èµ‹å€¼æˆ–å–å€¼çš„æ—¶å€™ç”¨çš„ key æ˜¯ä¸åŒçš„å€¼ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼å®šä¹‰çš„ NameKey/WeightKey æ˜¯å…¨å±€å˜é‡ï¼Œåœ¨å…¶å®ƒæ–‡ä»¶å¯ä»¥é€šè¿‡ exten è®¿é—®åˆ°ï¼š
```
extern const void *NameKey;
extern const void *WeightKey;

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"NameKey = %p, WeightKey = %p", NameKey, WeightKey);
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
NameKey = 0x100002338, WeightKey = 0x100002340
```

#### static const void *Key = &Key;
ä½¿ç”¨ staticï¼Œé™å®šå…¨å±€å˜é‡çš„ä½œç”¨åŸŸï¼Œä¿®æ”¹ NameKey/WeightKey çš„å®šä¹‰ï¼š
```
@implementation Person (Test)
static const void *NameKey = &NameKey;
static const void *WeightKey = &WeightKey;
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, WeightKey) intValue];
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

è¿™ä¸ªæ—¶å€™å†ä½¿ç”¨ extern çš„æ–¹å¼æŸ¥æ‰¾å…¨å±€å˜é‡ NameKey/WeightKey å°±ä¼šæŠ¥é”™ï¼š  
![å…³è”å¯¹è±¡03](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡03.png)

#### å°ç»“ 

* staticï¼šä¿è¯äº†å…¨å±€å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶ã€‚  
* Key = &Keyï¼šKey å†…éƒ¨å­˜å‚¨çš„æ˜¯ Key çš„åœ°å€å€¼ã€‚

### ç”¨æ³•äºŒï¼šstatic const char Key;

#### static const int Key;
const void * _Nonnull key è¦æ±‚çš„å‚æ•°æ˜¯æŒ‡é’ˆï¼ˆåœ°å€å€¼ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ª int Keyï¼Œä¼ å…¥ &Keyã€‚
```
@implementation Persion (Test)
static const int NameKey; //å ç”¨4ä¸ªå­—èŠ‚
static const int WeightKey; //å ç”¨4ä¸ªå­—èŠ‚
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, &NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, &NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, &WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, &WeightKey) intValue];
}

@end
```

#### static const char Key;
int ç±»å‹åœ¨å†…å­˜ä¸­å ç”¨4ä¸ªå­—èŠ‚ï¼Œæ—¢ç„¶åªæ˜¯è¦æ±‚æŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ª char Keyï¼Œä¼ å…¥ &Keyï¼Œè¿™æ ·å°±åªå ç”¨1ä¸ªå­—èŠ‚äº†ğŸ‘‡ã€‚
```
@implementation Persion (Test)
static const char NameKey; //å ç”¨1ä¸ªå­—èŠ‚
static const char WeightKey; //å ç”¨1ä¸ªå­—èŠ‚
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, &NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, &NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, &WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, &WeightKey) intValue];
}

@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

### ç”¨æ³•ä¸‰ï¼šä½¿ç”¨å±æ€§åä½œä¸º key
ä½¿ç”¨å±æ€§åä½œä¸º key å¯ä»¥å¾ˆå¥½çš„å¢åŠ ä»£ç çš„å¯è¯»æ€§ï¼š
```
@implementation Persion (Test)
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, @"name", name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, @"name");
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, @"weight", @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, @"weight") intValue];
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

#### @"name" ä¸ const void * _Nonnull keyã€‚  
å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š
```
NSString *str = @"name";
```

str é‡Œè£…çš„å°±æ˜¯ @"name" çš„åœ°å€å€¼ã€‚å› ä¸º str == @"name"ï¼Œæ‰€ä»¥å­—ç¬¦ä¸² @"name" å°±æ˜¯å…¶åœ°å€å€¼ï¼Œå¯ä»¥ç›´æ¥è®©å­—ç¬¦ä¸² @"name" ä½œ keyã€‚  

å­—ç¬¦ä¸² @"name" æ˜¯æ”¾åœ¨å†…å­˜å¸¸é‡åŒºçš„ï¼Œæ‰€ä»¥ä¸åŒä½ç½®çš„å­—ç¬¦ä¸² @"name" éƒ½æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™æ ·ä¹Ÿèƒ½ä¿è¯äº†å­˜å‚¨å’Œè¯»å–æ—¶ä¼ å…¥çš„ key æ˜¯åŒä¸€ä¸ªåœ°å€å€¼ğŸ‘‡:
```
@implementation Persion (Test)
- (void)logName
{
    NSLog(@"%p", @"name");
    NSLog(@"%p", @"name");
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"main - %p", @"name");
        NSLog(@"main - %p", @"name");

        Persion *persion1 = [[Persion alloc] init];
        [persion1 logName];
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
main - 0x100001080
main - 0x100001080
Persion+Test - 0x100001080
Persion+Test - 0x100001080
```

## ç”¨æ³•å››ï¼šä½¿ç”¨ get æ–¹æ³•çš„ @selecor ä½œä¸º key

### @selecor
```
@implementation Persion (Test)
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, @selector(name));
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, @selector(weight), @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, @selector(weight)) intValue];
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

@selector() æ–¹æ³•æ˜¯ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå³è¿”å›æŸä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼Œæ–¹æ³•åç›¸åŒçš„ @selector() åœ°å€å€¼ç›¸ç­‰ï¼š
```
- (void)setName:(NSString *)name
{
    NSLog(@"selector(name) = %p", @selector(name));
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    NSLog(@"selector(name) = %p", @selector(name));
    return objc_getAssociatedObject(self, @selector(name));
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Persion *persion1 = [[Persion alloc] init];
        persion1.name = @"persion1";
        persion1.weight = 20;

        NSLog(@"persion1.name = %@, persion1.wight = %d", persion1.name, persion1.weight);
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
selector(name) = 0x7fff2e86480f
selector(name) = 0x7fff2e86480f
ersion1.name = persion1, persion1.wight = 20
```

ä½¿ç”¨ @selector() ä½œä¸º keyï¼Œå³å¢åŠ å¯è¯»æ€§ï¼Œåˆåœ¨ç¼–å†™æ—¶ä¼šæœ‰ä»£ç æç¤ºï¼Œå¦‚æœå†™é”™äº†è¿˜ä¼šå‡ºç°æ–¹æ³•ä¸å­˜åœ¨çš„è­¦å‘Šã€‚

### _cmd
åœ¨ get æ–¹æ³•é‡Œå¯ä»¥ä½¿ç”¨ _cmd æ›¿æ¢ @selecor(æ–¹æ³•å)ï¼š
```
@implementation Persion (Test)
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, _cmd);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, @selector(weight), @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, _cmd) intValue];
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

éšå¼å‚æ•°ï¼šOC æ–¹æ³•åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªéšå¼çš„å‚æ•°ä¼ å…¥ï¼Œself å’Œ _cmdã€‚_cmd å°±æ˜¯å½“å‰æ–¹æ³•çš„ SELï¼Œå³ @selecor(name)ï¼š
```
- (NSString *)name:(id)self _cmd:(SEL)_cmd
```

å› ä¸º set æ–¹æ³•ä¸­çš„ _cmd == @selecor(setName:)ï¼Œget æ–¹æ³•ä¸­çš„ _cmd == @selecor(name)ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯å­˜å‚¨å’Œè¯»å–æ—¶ç”¨åˆ°çš„ key æ˜¯åŒä¸€ä¸ªï¼Œset æ–¹æ³•å’Œ get æ–¹æ³•ä¸èƒ½åŒæ—¶ä½¿ç”¨ _cmdã€‚

## ç±»å¯¹è±¡æ·»åŠ å…³è”å¯¹è±¡
```
@implementation Persion (Test)
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject([Persion class], @selector(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject([Persion class], _cmd);
}
@end
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion2, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```

## å°ç»“
* ç±»å¯¹è±¡å¯ä»¥å…³è”å¯¹è±¡å—ï¼Ÿ  
å…³è”å¯¹è±¡æ–¹æ³•å¯ä»¥ç»™ä»»ä½•å¯¹è±¡å…³è”æ–°çš„å¯¹è±¡ï¼Œç±»å¯¹è±¡è‡ªç„¶ä¹Ÿæ˜¯å¯ä»¥å…³è”å¯¹è±¡çš„ã€‚ä½†æ˜¯ç±»å¯¹è±¡åªæœ‰ä¸€ä¸ªï¼Œä¸åŒçš„å®ä¾‹å¯¹è±¡åœ¨ä¿®æ”¹å’Œè¯»å–è¢«æ–°å…³è”çš„å¯¹è±¡æ—¶ï¼Œéƒ½æ˜¯åœ¨æ“ä½œç±»å¯¹è±¡å…³è”çš„è¿™ä¸ªå¯¹è±¡ï¼Œè¿™æ ·åˆä¼šå‡ºç°å®ä¾‹å¯¹è±¡å’Œå…³è”å¯¹è±¡ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚


# å…³è”å¯¹è±¡çš„åŸç†

å®ç°å…³è”å¯¹è±¡æŠ€æœ¯çš„æ ¸å¿ƒå¯¹è±¡æœ‰ï¼š
* AssociationsManagerï¼šå…³è”å¯¹è±¡ç®¡ç†ç±»ï¼Œå†…éƒ¨ç®¡ç†ç€æ‰€æœ‰çš„ AssociationsHashMapï¼› 
* AssociationsHashMapï¼šå­˜å‚¨ç€æ‰€æœ‰æ·»åŠ äº†å…³è”å¯¹è±¡çš„å¯¹è±¡ï¼ŒåŠå…¶æ·»åŠ çš„å…³è”å¯¹è±¡çš„ä¿¡æ¯ï¼›  
* ObjectAssociationMapï¼šå­˜å‚¨ç€æŸä¸€ä¸ªå…³è”å¯¹è±¡çš„ keyã€value å’Œ policy ä¿¡æ¯ï¼›  
* ObjcAssociationï¼šå­˜å‚¨ç€æŸä¸€ä¸ªå…³è”å¯¹è±¡çš„ value å’Œ policy ä¿¡æ¯ï¼›

![å…³è”å¯¹è±¡04](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡04.png)

æ‰“å¼€ runtime æºç  [objc4-781](https://opensource.apple.com/tarballs/objc4/)ï¼Œæ‰¾åˆ° _base_objc_setAssociatedObject æ–¹æ³•çš„å®ç°ğŸ‘‡ï¼š
## _base_objc_setAssociatedObject
```
static void
_base_objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy)
{
  _object_set_associative_reference(object, key, value, policy);
}
```

æ‰¾åˆ° objc-references.mm æ–‡ä»¶é‡Œçš„ _object_set_associative_referenceï¼Œ
Jump To Definition -> _object_set_associative_referenceï¼š
```
void
_object_set_associative_reference(id object, const void *key, id value, uintptr_t policy)
{
    // This code used to work when nil was passed for object and key. Some code
    // probably relies on that to not crash. Check and handle it explicitly.
    // rdar://problem/44094390
    if (!object && !value) return;

    if (object->getIsa()->forbidsAssociatedObjects())
        _objc_fatal("objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects", object, object_getClassName(object));

    DisguisedPtr<objc_object> disguised{(objc_object *)object}; //æ ¹æ®ä¼ å…¥çš„ object å°è£…æˆ DisguisedPtrï¼Œä½œä¸ºè¯»å†™ ObjectAssociationMap çš„ key
    ObjcAssociation association{policy, value}; //æ ¹æ® policy å’Œ value ç”Ÿæˆ ObjcAssociation å¯¹è±¡

    // retain the new value (if any) outside the lock.
    association.acquireValue();

    {
        AssociationsManager manager; //å…³è”å¯¹è±¡ç®¡ç†ç±»
        AssociationsHashMap &associations(manager.get()); //è·å–å…³è”å¯¹è±¡ç®¡ç†ç±»é‡Œçš„ AssociationsHashMapï¼ŒAssociationsHashMap ä¿å­˜äº†æ‰€æœ‰å¯¹è±¡çš„å…³è”å¯¹è±¡ä¿¡æ¯

        if (value) { //ä¼ å…¥çš„å…³è”å¯¹è±¡æœ‰å€¼ï¼ˆvalue != nilï¼‰
            auto refs_result = associations.try_emplace(disguised, ObjectAssociationMap{}); //å¦‚æœé”®ä¸åœ¨ associations ä¸­ï¼Œåˆ™å°†é”®å’Œå€¼å¯¹æ’å…¥åˆ° associations ä¸­
            if (refs_result.second) {
                /* it's the first association we make */
                object->setHasAssociatedObjects(); //æ ‡è®°å…¶è¢«å…³è”çŠ¶æ€
            }

            /* establish or replace the association */
            auto &refs = refs_result.first->second; //ç”Ÿæˆ ObjectAssociationMap å¯¹è±¡
            auto result = refs.try_emplace(key, std::move(association)); //å¦‚æœé”®ä¸åœ¨ refs ä¸­ï¼Œåˆ™å°†é”®å’Œå€¼å¯¹æ’å…¥åˆ° refs ä¸­
            if (!result.second) { //å¦‚æœé”®åœ¨ refs ä¸­ï¼Œæ›´æ–° ObjectAssociation
                association.swap(result.first->second);
            }
        } else { //ä¼ å…¥çš„å…³è”å¯¹è±¡æ²¡æœ‰å€¼ï¼ˆvalue == nilï¼‰
            auto refs_it = associations.find(disguised); //æ‰¾åˆ° ObjectAssociationMap çš„éå†å™¨
            if (refs_it != associations.end()) {
                auto &refs = refs_it->second; //æ‰¾åˆ° ObjectAssociationMap å¯¹è±¡
                auto it = refs.find(key); //æ‰¾åˆ° key å¯¹åº”çš„ ObjcAssociation éå†å™¨
                if (it != refs.end()) {
                    association.swap(it->second);
                    refs.erase(it); //æ“¦é™¤ ObjcAssociation å¯¹è±¡
                    if (refs.size() == 0) { 
                        associations.erase(refs_it); //å¦‚æœéå†å™¨ refs é‡Œæ•°æ®ä¸ºç©ºï¼Œå³ ObjectAssociationMap é‡Œçš„æ•°æ®ä¸ºç©ºï¼Œåˆ™æ“¦é™¤æ‰ ObjectAssociationMap å¯¹è±¡

                    }
                }
            }
        }
    }

    // release the old value (outside of the lock).
    association.releaseHeldValue();
}
```

### AssociationsManager
```
class AssociationsManager {
    using Storage = ExplicitInitDenseMap<DisguisedPtr<objc_object>, ObjectAssociationMap>; 
    static Storage _mapStorage; //å£°æ˜ AssociationsHashMap å¯¹è±¡

public:
    AssociationsManager()   { AssociationsManagerLock.lock(); }
    ~AssociationsManager()  { AssociationsManagerLock.unlock(); }

    AssociationsHashMap &get() {
        return _mapStorage.get(); //è·å– AssociationsHashMap å¯¹è±¡
    }

    static void init() {
        _mapStorage.init();
    }
};
```

### AssociationsHashMap
å¯ä»¥çœ‹åˆ° AssociationsManager ä¸­æœ‰ä¸€ä¸ª AssociationsHashMap å¯¹è±¡ï¼Œå¹¶ä¸” AssociationsHashMap å¯¹è±¡æ˜¯ä¸€ä¸ªé€šè¿‡ DenseMap å®šä¹‰çš„ï¼Œä»¥ DisguisedPtr<objc_object> ä¸º keyï¼ŒObjectAssociationMap ä¸º value çš„å­—å…¸ã€‚ExplicitInitDenseMapï¼š

```
class ExplicitInitDenseMap : public ExplicitInit<DenseMap<Key, Value>> { };
```

### ObjectAssociationMap
```
typedef DenseMap<const void *, ObjcAssociation> ObjectAssociationMap;
```

ğŸ‘†ä» ObjectAssociationMap çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼ŒObjectAssociationMap æ˜¯ä¸€ä¸ªé€šè¿‡ DenseMap å®šä¹‰çš„ï¼Œä»¥æŒ‡é’ˆ(åœ°å€å€¼)ä¸º keyï¼ŒObjcAssociation ä¸º value çš„å­—å…¸ã€‚ObjcAssociationï¼š

### ObjcAssociation
```
class ObjcAssociation {
    uintptr_t _policy; //å…³è”ç­–ç•¥
    id _value; //å…³è”å¯¹è±¡
public:
    ObjcAssociation(uintptr_t policy, id value) : _policy(policy), _value(value) {}
    ObjcAssociation() : _policy(0), _value(nil) {}
    ObjcAssociation(const ObjcAssociation &other) = default;
    ObjcAssociation &operator=(const ObjcAssociation &other) = default;
    ObjcAssociation(ObjcAssociation &&other) : ObjcAssociation() {
        swap(other);
    }

    inline void swap(ObjcAssociation &other) {
        std::swap(_policy, other._policy);
        std::swap(_value, other._value);
    }

    inline uintptr_t policy() const { return _policy; }
    inline id value() const { return _value; }

    inline void acquireValue() {
        if (_value) {
            switch (_policy & 0xFF) {
            case OBJC_ASSOCIATION_SETTER_RETAIN:
                _value = objc_retain(_value);
                break;
            case OBJC_ASSOCIATION_SETTER_COPY:
                _value = ((id(*)(id, SEL))objc_msgSend)(_value, @selector(copy));
                break;
            }
        }
    }

    inline void releaseHeldValue() {
        if (_value && (_policy & OBJC_ASSOCIATION_SETTER_RETAIN)) {
            objc_release(_value);
        }
    }

    inline void retainReturnedValue() {
        if (_value && (_policy & OBJC_ASSOCIATION_GETTER_RETAIN)) {
            objc_retain(_value);
        }
    }

    inline id autoreleaseReturnedValue() {
        if (slowpath(_value && (_policy & OBJC_ASSOCIATION_GETTER_AUTORELEASE))) {
            return objc_autorelease(_value);
        }
        return _value;
    }
};
```

å¯ä»¥çœ‹å‡º ObjcAssociation æœ‰ä¸¤ä¸ªå˜é‡ _policy å’Œ _valueã€‚


## objc_getAssociatedObject
```
id
objc_getAssociatedObject(id object, const void *key)
{
    return _object_get_associative_reference(object, key);
}
```

æ‰¾åˆ° objc-references.mm æ–‡ä»¶é‡Œçš„ _object_get_associative_referenceï¼Œ
Jump To Definition -> _object_get_associative_referenceï¼š
```
id
_object_get_associative_reference(id object, const void *key)
{
    ObjcAssociation association{};

    {
        AssociationsManager manager; //å…³è”å¯¹è±¡ç®¡ç†ç±»
        AssociationsHashMap &associations(manager.get()); //è·å–å…³è”å¯¹è±¡ç®¡ç†ç±»é‡Œçš„ AssociationsHashMapï¼ŒAssociationsHashMap ä¿å­˜äº†æ‰€æœ‰å¯¹è±¡çš„å…³è”å¯¹è±¡ä¿¡æ¯
        AssociationsHashMap::iterator i = associations.find((objc_object *)object); //æ ¹æ® object æ‰¾åˆ° ObjectAssociationMap éå†å™¨ 
        if (i != associations.end()) {
            ObjectAssociationMap &refs = i->second; //è·å–åˆ° ObjectAssociationMap å¯¹è±¡
            ObjectAssociationMap::iterator j = refs.find(key); //æ ¹æ® key æ‰¾åˆ° ObjcAssociation éå†å™¨
            if (j != refs.end()) {
                association = j->second;
                association.retainReturnedValue();
            }
        }
    }

    return association.autoreleaseReturnedValue();
}
```

## å°ç»“
* å…³è”å¯¹è±¡å­˜å‚¨åœ¨ä»€ä¹ˆä½ç½®ï¼Ÿ  
å…³è”å¯¹è±¡å¹¶ä¸æ˜¯å­˜å‚¨åœ¨è¢«å…³è”å¯¹è±¡æœ¬èº«å†…å­˜ä¸­ï¼Œå…³è”å¯¹è±¡å­˜å‚¨åœ¨å…¨å±€çš„ç»Ÿä¸€çš„ä¸€ä¸ª AssociationsManager ä¸­ã€‚
* å¯¹è±¡åŠå…¶å…³è”å¯¹è±¡ä¹‹é—´æœ‰å¼ºå¼•ç”¨å…³ç³»å—ï¼Ÿ  
ä¸å­˜åœ¨ã€‚åœ¨ set æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„ object å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡çš„ disguised æ–¹æ³•å°†ä¼ å…¥çš„ object å¯¹è±¡ç”Ÿæˆäº† DisguisedPtr å¯¹è±¡ï¼Œå¹¶ä½œä¸º keyã€‚
* å¯¹è±¡é‡Šæ”¾åï¼Œå…³è”å¯¹è±¡ä¼šè¢«é‡Šæ”¾å—ï¼Ÿ  
ä¼šé‡Šæ”¾ã€‚å‚è€ƒå†…å­˜ç®¡ç†-releaseã€‚
* è®¾ç½®å…³è”å¯¹è±¡ä¸ºnilï¼Œå°±ç›¸å½“äºæ˜¯ç§»é™¤å…³è”å¯¹è±¡ã€‚