---
title: å…³è”å¯¹è±¡
date: 2020-05-26 11:16:15
tags: OCåº•å±‚åŸç†
---
* æ€è€ƒï¼šCategoryèƒ½å¦æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿå¦‚æœå¯ä»¥ï¼Œå¦‚ä½•ç»™Categoryæ·»åŠ æˆå‘˜å˜é‡ï¼Ÿ

<!-- more -->

# Categoryçš„æˆå‘˜å˜é‡
## _category_t ç»“æ„ä½“
```
struct _category_t {
	const char *name; //ç±»å
	struct _class_t *cls; //çˆ¶ç±»
	const struct _method_list_t *instance_methods; //å¯¹è±¡æ–¹æ³•åˆ—è¡¨
	const struct _method_list_t *class_methods; //ç±»æ–¹æ³•åˆ—è¡¨
	const struct _protocol_list_t *protocols; //åè®®åˆ—è¡¨
	const struct _prop_list_t *properties; //å±æ€§åˆ—è¡¨
};
```

ä» _category_t çš„ç»“æ„ä½“å¯ä»¥çœ‹å‡ºï¼ŒCategory ä¸­å¹¶æ²¡æœ‰å­˜æ”¾æˆå‘˜å˜é‡çš„å®¹å™¨ï¼Œæ‰€ä»¥ Category æœ¬èº«æ˜¯ä¸æ”¯æŒæ·»åŠ æˆå‘˜å˜é‡çš„ã€‚

## åœ¨ Persion.h ä¸­å®šä¹‰å±æ€§
```
@interface Persion : NSObject
@property (nonatomic, assign) int age;
@end
```

åœ¨ Persion.h ä¸­å®šä¹‰äº†å±æ€§åï¼Œç³»ç»Ÿä¼šåœ¨ Persion.m é‡Œè‡ªåŠ¨åšä¸‰ä»¶äº‹ï¼š
```
@implementation Persion
{
    int _age; //ç¬¬ä¸€ä»¶äº‹ï¼šå®šä¹‰æˆå‘˜å˜é‡
}
//ç¬¬äºŒä»¶äº‹ï¼šå®ç° age çš„ set æ–¹æ³•
- (void)setAge:(int)age { 
    _age = age;
}
//ç¬¬ä¸‰ä»¶äº‹ï¼šå®ç° age çš„ get æ–¹æ³•
- (int)age { 
    return _age;
}
@end
```

## åœ¨ Persion+Test.h ä¸­å®šä¹‰å±æ€§
```
@interface Persion (Test)
@property (nonatomic, assign) int weight;
@end
```

åœ¨ Persion+Test.h ä¸­å®šä¹‰äº†å±æ€§åï¼Œç³»ç»Ÿä¼šåœ¨ Persion+Test.h é‡Œè‡ªåŠ¨æ˜¯å®ç°ä¸¤ä»¶äº‹ï¼š
```
@interface Persion (Test)
//ç¬¬ä¸€ä»¶äº‹ï¼šç”Ÿæˆ weight çš„ set æ–¹æ³•çš„å£°æ˜
- (void)setWeight:(int)weight;
//ç¬¬äºŒä»¶äº‹ï¼šç”Ÿæˆ weight çš„ get æ–¹æ³•çš„å£°æ˜
- (int)weight;
@end
```

åœ¨åˆ†ç±»é‡Œå®šä¹‰çš„å±æ€§ï¼Œå¹¶æ²¡æœ‰å¯¹åº”çš„æˆå‘˜å˜é‡å’Œ set/get æ–¹æ³•çš„å®ç°ã€‚å¦‚æœå°è¯•æ‰‹åŠ¨æ·»åŠ ï¼Œç³»ç»Ÿä¼šæŠ¥é”™ã€‚
![å…³è”å¯¹è±¡01](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡01.png)

## å®šä¹‰å…¨å±€å˜é‡ int weight_
```
int weight_;
@implementation Persion (Test)
- (void)setWeight:(int)weight {
    weight_ = weight;
}
- (int)weight {
    return weight_;
}
@end
```

é€šè¿‡å®šä¹‰å…¨å±€å˜é‡ _weight çš„æ–¹å¼å¯ä»¥å®ç°æˆå‘˜å˜é‡çš„æ•ˆæœï¼Œä½†æ˜¯ _weight æ˜¯å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ persion ä¼šå…¬ç”¨åŒä¸€ä¸ª _weightã€‚è¿™æ ·ä¼šå¯¼è‡´æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ persion éƒ½å¯ä»¥ä¿®æ”¹ _weightï¼Œæ— æ³•ä¿è¯å•ä¸ªå®ä¾‹å¯¹è±¡ persion ä¸ _weight ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

## å®šä¹‰å…¨å±€å˜é‡ NSMutableDictionary *weights_
```
NSMutableDictionary *weights_;
@implementation Persion (Test)
+ (void)load {
    weights_ = [NSMutableDictionary dictionary];
}
- (void)setWeight:(int)weight {
    NSString *key = [NSString stringWithFormat:@"%p", self];
    weights_[key] = @(weight);
}

- (int)weight {
    NSString *key = [NSString stringWithFormat:@"%p", self];
    return [weights_[key] intValue];
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Persion *persion1 = [[Persion alloc] init];
        persion1.age = 10;
        persion1.weight = 20;
        
        Persion *persion2 = [[Persion alloc] init];
        persion2.age = 30;
        persion2.weight = 40;
        
        NSLog(@"persion1.age = %d, persion1.wight = %d", persion1.age, persion1.weight);
        NSLog(@"persion2.age = %d, persion2.wight = %d",persion2.age, persion2.weight);
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
persion1.age = 10, persion1.wight = 20
persion2.age = 30, persion2.wight = 40
```

* æ³¨æ„ï¼š  
10å’Œ30æ˜¯å­˜å‚¨åœ¨ persion å¯¹è±¡çš„å†…éƒ¨ï¼Œ20å’Œ40æ˜¯å­˜æ”¾åœ¨å…¨å±€çš„å­—å…¸ weights_ å¯¹è±¡é‡Œé¢ã€‚

ä¼˜ç‚¹ï¼š 
é€šè¿‡å®šä¹‰å…¨å±€å˜é‡å­—å…¸ï¼Œä»¥ persion å¯¹è±¡çš„åœ°å€ä½œ keyï¼Œå±æ€§ weight ä½œ valueï¼Œä¿è¯äº† persion å¯¹è±¡ä¸ weight çš„ä¸€ä¸€å¯¹ç›¸åº”å…³ç³»ã€‚  
ç¼ºç‚¹ï¼šè¿™ç§æ–¹å¼å¯èƒ½ä¼šæœ‰çº¿ç¨‹é—®é¢˜ï¼Œåœ¨ - (void)setWeight:(int)weight æ–¹æ³•é‡Œéœ€è¦åŠ é”ã€‚å¦å¤–æ¯æ·»åŠ ä¸€ä¸ªå±æ€§å°±è¦å®šä¹‰ä¸€ä¸ªæ–°çš„å…¨å±€å˜é‡å­—å…¸ã€‚

å› ä¸ºåˆ†ç±»åº•å±‚ç»“æ„çš„é™åˆ¶ï¼Œä¸èƒ½æ·»åŠ æˆå‘˜å˜é‡åˆ°åˆ†ç±»ä¸­ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ¥é—´æ¥å®ç°ğŸ‘‡ã€‚

# å…³è”å¯¹è±¡
## åŸºæœ¬ç”¨æ³•

å‚æ•°ï¼š  
id _Nonnull objectï¼šéœ€è¦æ·»åŠ å…³è”å¯¹è±¡çš„å¯¹è±¡ï¼ˆé€šå¸¸å†™æ³•ä¼  selfï¼‰;  
const void * _Nonnull keyï¼šæŒ‡é’ˆç±»å‹ï¼ˆvoid *ï¼‰ï¼Œä¿å­˜å…³è”å¯¹è±¡çš„keyï¼›  
id _Nullable valueï¼šå…³è”å¯¹è±¡ï¼›  
objc_AssociationPolicy policyï¼šå…³è”ç­–ç•¥ï¼›

æ·»åŠ å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT void
objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key,
                         id _Nullable value, objc_AssociationPolicy policy)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

è·å–å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT id _Nullable
objc_getAssociatedObject(id _Nonnull object, const void * _Nonnull key)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

ç§»é™¤æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼š
```
OBJC_EXPORT void
objc_removeAssociatedObjects(id _Nonnull object)
    OBJC_AVAILABLE(10.6, 3.1, 9.0, 1.0, 2.0);
```

## å…³è”ç­–ç•¥ objc_AssociationPolicy
```
typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) {
    OBJC_ASSOCIATION_ASSIGN = 0,           /**< Specifies a weak reference to the associated object. */
    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**< Specifies a strong reference to the associated object. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**< Specifies that the associated object is copied. 
                                            *   The association is not made atomically. */
    OBJC_ASSOCIATION_RETAIN = 01401,       /**< Specifies a strong reference to the associated object.
                                            *   The association is made atomically. */
    OBJC_ASSOCIATION_COPY = 01403          /**< Specifies that the associated object is copied.
                                            *   The association is made atomically. */
};
```

å…³è”ç­–ç•¥ objc_AssociationPolicy ç±»ä¼¼äºå®šä¹‰å±æ€§æ—¶è®¾ç½®çš„å‚æ•°ï¼Œç¡®å®šè¦å…³è”çš„å¯¹è±¡çš„å†…å­˜å†…å­˜ç®¡ç†æ–¹å¼ã€‚

![å…³è”å¯¹è±¡02](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡02.png)

# keyçš„å¸¸è§ç”¨æ³•

## ç”¨æ³•ä¸€ï¼šstatic const void *Key = &Key;

### const void *Key;
```
@interface Person (Test)
@property (copy, nonatomic) NSString *name;
@property (assign, nonatomic) int weight;
@end

@implementation Person (Test)
const void *NameKey;
const void *WeightKey;
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, WeightKey) intValue];
}
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Persion *persion1 = [[Persion alloc] init];
        persion1.name = @"persion1";
        persion1.weight = 20;
        
        Persion *persion2 = [[Persion alloc] init];
        persion2.name = @"persion2";
        persion2.weight = 40;
        
        NSLog(@"persion1.name = %@, persion1.wight = %d", persion1.name, persion1.weight);
        NSLog(@"persion2.name = %@, persion2.wight = %d",persion2.name, persion2.weight);
    }
    return 0;
}
```

æ‰“å°ç»“æœï¼š
```
persion1.name = 20, persion1.wight = 20
persion2.name = 40, persion2.wight = 40
```

å› ä¸ºè¿™ç§æ–¹å¼å®šä¹‰çš„ NameKey/WeightKey æ²¡æœ‰èµ‹å€¼ï¼Œéƒ½æ˜¯ NULLã€‚è¿™æ · name å’Œ weight èµ‹å€¼å–å€¼çš„æ—¶å€™ç”¨çš„ key éƒ½æ˜¯ NULLï¼Œæ‰€ä»¥æ‰“å°ç»“æœ name == weightã€‚

### const void *Key = &Key;
ä¿®æ”¹ NameKey/WeightKey çš„å®šä¹‰ï¼š
```
const void *NameKey = &NameKey;
const void *WeightKey = &WeightKey;
```

æ‰“å°ç»“æœï¼š
```
persion1.name = persion1, persion1.wight = 20
persion2.name = persion2, persion2.wight = 40
```  

è¿™æ ·å®šä¹‰çš„ NameKey/WeightKey å†…éƒ¨å­˜å‚¨çš„åˆ†åˆ«æ˜¯ NameKey/WeightKey çš„åœ°å€å€¼ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼å®šä¹‰çš„ NameKey/WeightKey æ˜¯å…¨å±€å˜é‡ï¼Œåœ¨å…¶å®ƒæ–‡ä»¶å¯ä»¥é€šè¿‡ exten è®¿é—®åˆ°ï¼š
```
extern const void *NameKey;
extern const void *WeightKey;

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        NSLog(@"NameKey = %p, WeightKey = %p", NameKey, WeightKey);
        }
    return 0;
}
``` 

æ‰“å°ç»“æœï¼š
```
NameKey = 0x100002338, WeightKey = 0x100002340
```

### static const void *Key = &Key;
ä¿®æ”¹ NameKey/WeightKey çš„å®šä¹‰ï¼š
```
@implementation Person (Test)
static const void *NameKey = &NameKey;
static const void *WeightKey = &WeightKey;
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, WeightKey) intValue];
}
@end
```

è¿™ä¸ªæ—¶å€™å†ä½¿ç”¨ extern çš„æ–¹å¼æŸ¥æ‰¾å…¨å±€å˜é‡ NameKey/WeightKey å°±ä¼šæŠ¥é”™ï¼š  
![å…³è”å¯¹è±¡03](å…³è”å¯¹è±¡/å…³è”å¯¹è±¡03.png)

### å°ç»“ 

* staticï¼šä¿è¯äº†å…¨å±€å˜é‡çš„ä½œç”¨åŸŸä»…é™äºå½“å‰æ–‡ä»¶ã€‚  
* Key = &Keyï¼šKey å†…éƒ¨å­˜å‚¨çš„æ˜¯ Key çš„åœ°å€å€¼ã€‚

## ç”¨æ³•äºŒï¼šstatic const char Key;

### static const int Key;
const void * _Nonnull key è¦æ±‚çš„å‚æ•°æ˜¯æŒ‡é’ˆï¼ˆåœ°å€å€¼ï¼‰ï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ª int Keyï¼Œä¼ å…¥ &Keyã€‚
```
@implementation Persion (Test)
static const int NameKey; //å ç”¨4ä¸ªå­—èŠ‚
static const int WeightKey; //å ç”¨4ä¸ªå­—èŠ‚
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, &NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, &NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, &WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, &WeightKey) intValue];
}

@end
```

### static const char Key;
int ç±»å‹åœ¨å†…å­˜ä¸­å ç”¨4ä¸ªå­—èŠ‚ï¼Œæ—¢ç„¶åªæ˜¯è¦æ±‚æŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ª char Keyï¼Œä¼ å…¥ &Keyï¼Œè¿™æ ·å°±åªå ç”¨1ä¸ªå­—èŠ‚äº†ğŸ‘‡ã€‚
```
@implementation Persion (Test)
static const char NameKey; //å ç”¨1ä¸ªå­—èŠ‚
static const char WeightKey; //å ç”¨1ä¸ªå­—èŠ‚
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, &NameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, &NameKey);
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, &WeightKey, @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, &WeightKey) intValue];
}

@end
```

## ç”¨æ³•ä¸‰ï¼šä½¿ç”¨å±æ€§åä½œä¸ºkey
```
@implementation Persion (Test)
- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self, @"name", name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}
- (NSString *)name
{
    return objc_getAssociatedObject(self, @"name");
}
- (void)setWeight:(int)weight
{
    objc_setAssociatedObject(self, @"weight", @(weight), OBJC_ASSOCIATION_RETAIN_NONATOMIC);
}
- (int)weight
{
    return [objc_getAssociatedObject(self, @"weight") intValue];
}
@end
```

å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š
```
NSString *str = @"name";
```

str é‡Œè£…çš„å°±æ˜¯ @"name" çš„åœ°å€å€¼ã€‚å› ä¸º str == @"name"ï¼Œæ‰€ä»¥å­—ç¬¦ä¸² @"name" å°±æ˜¯å…¶åœ°å€å€¼ï¼Œå¯ä»¥ç›´æ¥è®©å­—ç¬¦ä¸² @"name" ä½œ keyã€‚  

å­—ç¬¦ä¸² @"name" æ˜¯æ”¾åœ¨å†…å­˜å¸¸é‡åŒºçš„ï¼Œæ‰€ä»¥ä¸åŒä½ç½®çš„å­—ç¬¦ä¸² @"name" éƒ½æ˜¯åŒä¸€ä¸ªå­—ç¬¦ä¸² @"name"ï¼Œä¿è¯äº†å­˜å‚¨å’Œè¯»å–æ—¶ä¼ å…¥çš„ key æ˜¯åŒä¸€ä¸ªåœ°å€å€¼ã€‚