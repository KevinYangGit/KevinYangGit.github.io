---
title: å¤šçº¿ç¨‹
date: 2020-07-14 16:31:01
tags: OCåº•å±‚åŸç†
---

æ€è€ƒï¼š
* ä½ ç†è§£çš„å¤šçº¿ç¨‹ï¼Ÿ
* iOSçš„å¤šçº¿ç¨‹æ–¹æ¡ˆæœ‰å“ªå‡ ç§ï¼Ÿä½ æ›´å€¾å‘äºå“ªä¸€ç§ï¼Ÿ
* ä½ åœ¨é¡¹ç›®ä¸­ç”¨è¿‡ GCD å—ï¼Ÿ
* GCD çš„é˜Ÿåˆ—ç±»å‹
* è¯´ä¸€ä¸‹ OperationQueue å’Œ GCD çš„åŒºåˆ«ï¼Œä»¥åŠå„è‡ªçš„ä¼˜åŠ¿
* çº¿ç¨‹å®‰å…¨çš„å¤„ç†æ‰‹æ®µæœ‰å“ªäº›ï¼Ÿ
* OCä½ äº†è§£çš„é”æœ‰å“ªäº›ï¼Ÿåœ¨ä½ å›ç­”åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡æé—®ï¼›  
è¿½é—®ä¸€ï¼šè‡ªæ—‹å’Œäº’æ–¥å¯¹æ¯”ï¼Ÿ  
è¿½é—®äºŒï¼šä½¿ç”¨ä»¥ä¸Šé”éœ€è¦æ³¨æ„å“ªäº›ï¼Ÿ  
è¿½é—®ä¸‰ï¼šç”¨C/OC/C++ï¼Œä»»é€‰å…¶ä¸€ï¼Œå®ç°è‡ªæ—‹æˆ–äº’æ–¥ï¼Ÿ
<!-- more -->
* è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
    });
}

- (void)test
{
    NSLog(@"2");
}
@end
```

* è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)test
{
    NSLog(@"2");
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSThread *thread = [[NSThread alloc] initWithBlock:^{
        NSLog(@"1");
    }];
    [thread start];
    
    [self performSelector:@selector(test) onThread:thread withObject:nil waitUntilDone:YES];
}
@end
```

# GCD

ğŸ‘‰ [GCDæºç ](https://github.com/apple/swift-corelibs-libdispatch)

## iOSä¸­çš„å¸¸è§å¤šçº¿ç¨‹æ–¹æ¡ˆ

<!-- <style>
table th:nth-of-type(1){
    width: 20%;
}
table th:nth-of-type(2){
    width: 25%;
}
table th:nth-of-type(3){
    width: 20%;
}
table th:nth-of-type(4){
    width: 20%;
}
table th:nth-of-type(5){
    width: 15%;
}
</style> -->

| æŠ€æœ¯æ–¹æ¡ˆ | ç®€ä»‹ | è¯­è¨€ | çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ | ä½¿ç”¨é¢‘ç‡ |
| :--: | :-------- | :--: | :--: | :--: |
| phread | 1.ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹APIï¼›<br>2.é€‚ç”¨äºUnix\Linux\Windowsç­‰ç³»ç»Ÿï¼›<br>3.è·¨å¹³å°\å¯ç§»æ¤ï¼›<br>4.ä½¿ç”¨éš¾åº¦å¤§ï¼›| C | å¼€å‘è€…ç®¡ç† | å‡ ä¹ä¸ç”¨ |
| NSThread | 1.ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ï¼›<br>2.ç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ï¼› | OC | å¼€å‘è€…ç®¡ç† | å¶å°”ä½¿ç”¨ |
| GCD | 1.æ—¨åœ¨æ›¿ä»£NSThreadç­‰å¤šçº¿ç¨‹æŠ€æœ¯ï¼› | C | è‡ªåŠ¨ç®¡ç† | ç»å¸¸ä½¿ç”¨ |
| NSOperation | 1.åŸºäºGCDï¼ˆåº•å±‚æ˜¯GCDï¼‰ï¼›<br>2.æ¯”GCDå¤šäº†ä¸€äº›æ›´ç®€å•ä½¿ç”¨çš„åŠŸèƒ½ï¼›<br>3.ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ï¼› | OC | è‡ªåŠ¨ç®¡ç† | ç»å¸¸ä½¿ç”¨ |

phread åœ¨å®é™…å¼€å‘ä¸­å‡ ä¹ä¸ä¼šç”¨åˆ°ï¼Œä¸€èˆ¬åªä¼šåœ¨åŠ é”è§£é”çš„åœ°æ–¹ç”¨åˆ°ã€‚å¦å¤–ï¼ŒNSTheadã€GCD å’Œ NSOperation åº•å±‚éƒ½ä¼šç”¨åˆ° phreadï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹ç­‰ã€‚NSThread å°±æ˜¯å¯¹ phread çš„åŒ…è£…ã€‚

## GCDçš„å¸¸ç”¨å‡½æ•°

GCD ä¸­æœ‰2ä¸ªç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„å‡½æ•°ï¼š
* ç”¨åŒæ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡ï¼ˆqueueï¼šé˜Ÿåˆ—ï¼›blockï¼šä»»åŠ¡ï¼‰  
```
dispatch_sync(dispatch_queue_t queue, dispatch_block_t block);
```

* ç”¨å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡  
```
dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
```

é˜Ÿåˆ—ç›¸å…³å‡½æ•°ï¼š
* è·å–ä¸»é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_get_main_queue();
```

* è·å–å…¨å±€å¹¶å‘é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
```

* æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_CONCURRENT);
```

* æ‰‹åŠ¨åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_queue_create("mySerialQueue", DISPATCH_QUEUE_SERIAL);
```

* æ‰‹åŠ¨åˆ›å»ºé˜Ÿåˆ—ç»„
```
dispatch_group_t group = dispatch_group_create();
```

## GCDçš„é˜Ÿåˆ—

GCDçš„é˜Ÿåˆ—å¯ä»¥åˆ†ä¸º2å¤§ç±»å‹
* å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰  
å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼ˆè‡ªåŠ¨å¼€å¯å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼‰ï¼›  
å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥ï¼ˆdispatch_asyncï¼‰å‡½æ•°ä¸‹æ‰æœ‰æ•ˆï¼›

* ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰  
è®©ä»»åŠ¡ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°æ‰§è¡Œï¼ˆä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰ï¼›

## å®¹æ˜“æ··æ·†çš„æœ¯è¯­

æœ‰4ä¸ªæœ¯è¯­æ¯”è¾ƒå®¹æ˜“æ··æ·†ï¼šåŒæ­¥ã€å¼‚æ­¥ã€å¹¶å‘ã€ä¸²è¡Œ
* åŒæ­¥å’Œå¼‚æ­¥ä¸»è¦å½±å“ï¼šèƒ½ä¸èƒ½å¼€å¯æ–°çš„çº¿ç¨‹  
åŒæ­¥ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼›  
å¼‚æ­¥ï¼šåœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼›

* å¹¶å‘å’Œä¸²è¡Œä¸»è¦å½±å“ï¼šä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼  
å¹¶å‘ï¼šå¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼›  
ä¸²è¡Œï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼›

## å„ç§é˜Ÿåˆ—çš„æ‰§è¡Œæ•ˆæœ

| &nbsp; | å¹¶å‘é˜Ÿåˆ— | æ‰‹åŠ¨ç©¿ä»¶çš„ä¸²è¡Œé˜Ÿåˆ— | ä¸»é˜Ÿåˆ— |
| :--: | :--: | :--: | :--: |
| åŒæ­¥ï¼ˆsyncï¼‰ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ |
| å¼‚æ­¥ï¼ˆasyncï¼‰ | æœ‰å¼€å¯æ–°çº¿ç¨‹<br>å¹¶å‘æ‰§è¡Œä»»åŠ¡ | æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ |

ä½¿ç”¨syncå‡½æ•°å¾€å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¼šå¡ä½å½“å‰çš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆäº§ç”Ÿæ­»é”ï¼‰ã€‚

ä¸»é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œasync æ–¹æ³•åœ¨ä¸»é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶ä¸”æ˜¯ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ã€‚

### å¹¶å‘é˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    /// å…¨å±€å¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    /// ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    /// ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });

    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    /// ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600003595140>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600003595140>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
ä»»åŠ¡5 - <NSThread: 0x600000434d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šå¹¶å‘ï¼Œåˆ›å»ºæ–°çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹03](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹03.png)

### å¹¶å‘é˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    /// å…¨å±€å¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    /// ä»»åŠ¡2
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    /// ä»»åŠ¡3
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    /// ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹04](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹04.png)

### ä¸²è¡Œé˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    /// æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_SERIAL);
    /// ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    /// ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    /// ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
ä»»åŠ¡5 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œåˆ›å»ºæ–°çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹05](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹05.png)

### ä¸²è¡Œé˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    /// æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_SERIAL);
    /// ä»»åŠ¡2
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    /// ä»»åŠ¡3
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    /// ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600001438d40>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600001438d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹06](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹06.png)

### ä¸»é˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    /// æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_main_queue();
    /// ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    /// ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    /// ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600002408d80>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600002408d80>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹07](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹07.png)

### ä¸»é˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰-> æ­»é”

æ­»é”ä¸€ï¼šä½¿ç”¨syncå‡½æ•°å¾€å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¼šå¡ä½å½“å‰çš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆäº§ç”Ÿæ­»é”ï¼‰ï¼š
![å¤šçº¿ç¨‹01](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹01.png)

é—®é¢˜åˆ†æï¼š
![å¤šçº¿ç¨‹02](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹02.png)

`sync` å‡½æ•°åœ¨è¿™é‡Œçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯æ·»åŠ ä»»åŠ¡2ï¼Œç¬¬äºŒä¸ªæ˜¯æ‰§è¡Œä»»åŠ¡2ã€‚å› ä¸ºä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥éµå¾ªå…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼Œåªæœ‰åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡ `viewDidLoad` æ‰§è¡Œå®Œæˆåæ‰èƒ½æ‰§è¡Œä»»åŠ¡2ã€‚ä½†æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡ `viewDidLoad` è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œ `sync` å‡½æ•°ï¼Œè€Œ `sync` å‡½æ•°è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œä»»åŠ¡2ï¼Œè€Œä»»åŠ¡2è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œ `viewDidLoad` ... ... äº§ç”Ÿæ­»é”ã€‚

æ­»é”äºŒï¼š
![å¤šçº¿ç¨‹08](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹08.png)

é—®é¢˜åˆ†æï¼š
![å¤šçº¿ç¨‹09](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹09.png)

## performSelector:withObject:afterDelay:

åœ¨å­çº¿ç¨‹é‡Œè°ƒç”¨ `performSelector:withObject:afterDelay:` æ–¹æ³•ï¼š
```
- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
    });
}
```

æ‰“å°ç»“æœï¼š
```
1
3
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•å¹¶æ²¡æœ‰èµ·ä½œç”¨ã€‚è¿™æ˜¯å› ä¸º `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨ä½¿ç”¨äº† timerï¼Œè€Œå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰ RunLoopï¼Œæ‰€ä»¥ `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨çš„ TImer æ— æ³•è°ƒç”¨ã€‚1å’Œ3å¯ä»¥æ‰“å°æ˜¯å› ä¸º `NSLog()` æ–¹æ³•æ˜¯æ™®é€šçš„ä»£ç ï¼Œä¸éœ€è¦ RunLoopã€‚

è§£å†³æ–¹æ¡ˆ ğŸ‘‰ æ‰‹åŠ¨æ·»åŠ  RunLoopï¼š
```
- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
        
        [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];
    });
}
```

æ‰“å°ç»“æœï¼š
```
1
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001ad0cc0>{number = 6, name = (null)} - (null)
3
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•å¯ä»¥æ­£å¸¸è°ƒç”¨äº†ã€‚è¿™æ˜¯å› ä¸ºæ‰‹åŠ¨ä¸ºå­çº¿ç¨‹æ·»åŠ äº† RunLoopï¼Œæ‰€ä»¥ `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨çš„ timer å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚

çŒœæƒ³ï¼š`performSelector:withObject:afterDelay:` æ–¹æ³•çš„æœ¬è´¨æ˜¯å¾€ RunLoop ä¸­æ·»åŠ å®šæ—¶å™¨ï¼š
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) {
        switch (activity) {
            case kCFRunLoopEntry:
                NSLog(@"kCFRunLoopEntry");
                break;
            case kCFRunLoopBeforeTimers:
                NSLog(@"kCFRunLoopBeforeTimers");
                break;
            case kCFRunLoopBeforeSources:
                NSLog(@"kCFRunLoopBeforeSources");
                break;
            case kCFRunLoopBeforeWaiting:
                NSLog(@"kCFRunLoopBeforeWaiting");
                break;
            case kCFRunLoopAfterWaiting:
                NSLog(@"kCFRunLoopAfterWaiting");
                break;
            case kCFRunLoopExit:
                NSLog(@"kCFRunLoopExit");
                break;
            default:
                break;
        }
    });
    CFRunLoopAddObserver(CFRunLoopGetCurrent(), observer, kCFRunLoopCommonModes);
    CFRelease(observer);
}

- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSLog(@"1");
    [self performSelector:@selector(test) withObject:nil afterDelay:.0];
    NSLog(@"3");
}
```

æ‰“å°ç»“æœï¼š
```
kCFRunLoopAfterWaiting
kCFRunLoopBeforeTimers
kCFRunLoopBeforeSources
1
3
kCFRunLoopBeforeTimers
kCFRunLoopBeforeSources
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600000b5cd40>{number = 1, name = main} - <NSOperationQueue: 0x7fb3f0006020>{name = 'NSOperationQueue Main Queue'}
... ...
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•çš„è°ƒç”¨æ˜¯ä¸€ä¸ª timers äº‹ä»¶ï¼šRunLoop å…ˆå¤„ç†äº† Sources0 äº‹ä»¶ï¼Œå†å¤„ç†çš„ Timersã€‚

### GNUstep

GNUstep æ˜¯ GNU è®¡åˆ’çš„é¡¹ç›®ä¹‹ä¸€ï¼Œå®ƒå°† Cocoa çš„ OC åº“é‡æ–°å¼€æºå®ç°äº†ä¸€éã€‚è™½ç„¶ GNUstep ä¸æ˜¯è‹¹æœå®˜æ–¹æºç ï¼Œä½†è¿˜æ˜¯å…·æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ã€‚ğŸ‘‰ [æºç åœ°å€](http://www.gnustep.org/resources/downloads.php)

æ‰¾åˆ° NSRunLoop.m æ–‡ä»¶æŸ¥çœ‹ `performSelector:withObject:afterDelay:` æ–¹æ³•æºç ï¼š
```
- (void) performSelector: (SEL)aSelector
	      withObject: (id)argument
	      afterDelay: (NSTimeInterval)seconds
{
  NSRunLoop		*loop = [NSRunLoop currentRunLoop];
  GSTimedPerformer	*item;

  //æ ¹æ®ä¼ å…¥å‚æ•°ç”Ÿæˆä¸€ä¸ª GSTimedPerformer å¯¹è±¡ï¼ˆå†…å« NSTimer å®šæ—¶å™¨ï¼‰ï¼Œä½œä¸º Timers äº‹ä»¶æ·»åŠ åˆ° RunLoop ä¸­ã€‚
  item = [[GSTimedPerformer alloc] initWithSelector: aSelector
					     target: self
					   argument: argument
					      delay: seconds];
  [[loop _timedPerformers] addObject: item];
  RELEASE(item);
  [loop addTimer: item->timer forMode: NSDefaultRunLoopMode];
}
```

é€šè¿‡æºç å¯ä»¥å¾—å‡ºç»“è®ºï¼š`performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨æ ¹æ®ä¼ å…¥å‚æ•°ç”Ÿæˆä¸€ä¸ª GSTimedPerformer å¯¹è±¡ï¼ˆå†…å« NSTimer å®šæ—¶å™¨ï¼‰ï¼Œä½œä¸º Timers äº‹ä»¶æ·»åŠ åˆ° RunLoop ä¸­ã€‚

### performSelector:withObject:

`performSelector:withObject:` æ–¹æ³•è·Ÿ `performSelector:withObject:afterDelay:` æ–¹æ³•çš„å®ç°åŸç†ä¸åŒï¼Œ`performSelector:withObject:afterDelay:` æ˜¯å®šä¹‰åœ¨ RunLoop.h æ–‡ä»¶é‡Œçš„ APIï¼Œå†…éƒ¨å®ç°çš„æœ¬è´¨æ˜¯å¾€ RunLoop ä¸­æ·»åŠ å®šæ—¶å™¨ã€‚è€Œ `performSelector:withObject:` æ–¹æ³•çš„æœ¬è´¨æ˜¯è°ƒç”¨ objc_msgSend() æ–¹æ³•ã€‚å¯ä»¥åœ¨ runtime æºç  [objc4-781](https://opensource.apple.com/tarballs/objc4/) é‡Œçœ‹åˆ°å…·ä½“å®ç°ï¼Œæ‰¾åˆ° NSObjec.m æ–‡ä»¶ï¼š
```
- (id)performSelector:(SEL)sel withObject:(id)obj {
    if (!sel) [self doesNotRecognizeSelector:sel];
    return ((id(*)(id, SEL, id))objc_msgSend)(self, sel, obj);
}
```

## é˜Ÿåˆ—ç»„çš„ä½¿ç”¨

å¼‚æ­¥å¹¶å‘æ‰§è¡Œä»»åŠ¡1ã€ä»»åŠ¡2ï¼Œåœ¨ä»»åŠ¡1ã€ä»»åŠ¡2éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå†å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡3ï¼š
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    dispatch_group_t group = dispatch_group_create();
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_CONCURRENT);
    dispatch_group_async(group, queue, ^{
        sleep(1);
        NSLog(@"ä»»åŠ¡1");
    });
    dispatch_group_async(group, queue, ^{
        NSLog(@"ä»»åŠ¡2");
    });
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        NSLog(@"ä»»åŠ¡3");
    });
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡2
ä»»åŠ¡1
ä»»åŠ¡3
```

ä»»åŠ¡3ä¼šç­‰åˆ°ä»»åŠ¡1å’Œä»»åŠ¡2éƒ½æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œã€‚

# GCDæºç åˆ†æ

## dispatch_async()

åœ¨ queue.h æ–‡ä»¶æ‰¾åˆ° `dispatch_async()` æ–¹æ³•çš„å®šä¹‰
```
API_AVAILABLE(macos(10.6), ios(4.0))
DISPATCH_EXPORT DISPATCH_NONNULL_ALL DISPATCH_NOTHROW
void
dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
```

åœ¨ queue.c æ–‡ä»¶æ‰¾åˆ° `dispatch_async()` æ–¹æ³•çš„å®ç°ï¼š
```
void
dispatch_async(dispatch_queue_t dq, dispatch_block_t work)
{
    //å°†ä»»åŠ¡ work æ‰“åŒ…æˆ dispatch_continuation_t ç±»å‹
	dispatch_continuation_t dc = _dispatch_continuation_alloc(); 
    //è®¾ç½®æ ‡å¿—ä½
	uintptr_t dc_flags = DC_FLAG_CONSUME;
	dispatch_qos_t qos;

    //è¿›è¡Œblockåˆå§‹åŒ–
	qos = _dispatch_continuation_init(dc, dq, work, 0, dc_flags);
	_dispatch_continuation_async(dq, dc, qos, dc->dc_flags);
}
```

åœ¨ inline_internal.h æ–‡ä»¶æ‰¾åˆ° `_dispatch_continuation_async()` æ–¹æ³•çš„å®ç°ï¼š
```
DISPATCH_ALWAYS_INLINE
static inline void
_dispatch_continuation_async(dispatch_queue_class_t dqu,
		dispatch_continuation_t dc, dispatch_qos_t qos, uintptr_t dc_flags)
{
#if DISPATCH_INTROSPECTION
	if (!(dc_flags & DC_FLAG_NO_INTROSPECTION)) {
		_dispatch_trace_item_push(dqu, dc); //å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
	}
#else
	(void)dc_flags;
#endif
	return dx_push(dqu._dq, dc, qos);
}
```

åœ¨ trace.h æ–‡ä»¶æ‰¾åˆ° `_dispatch_trace_item_push` æ–¹æ³•çš„å®ç°ï¼š
```
#define _dispatch_trace_item_push(dq, dou) \
		do { (void)(dq); (void)(dou); } while(0)
```

## dispatch_sync()

# å¤šçº¿ç¨‹çš„å®‰å…¨éšæ‚£

èµ„æºå…±äº«ï¼š1å—èµ„æºå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯èƒ½ä¼šè®¿é—®åŒä¸€å—èµ„æºï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ã€åŒä¸€ä¸ªå˜é‡ã€åŒä¸€ä¸ªæ–‡ä»¶ã€‚

å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å—èµ„æºæ—¶ï¼Œå¾ˆå®¹æ˜“å¼•å‘æ•°æ®é”™ä¹±å’Œæ•°æ®å®‰å…¨é—®é¢˜ã€‚

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£ç¤ºä¾‹

### å–ç¥¨
```
@interface ViewController ()
@property (assign, nonatomic) int ticketsCount;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    [self ticketTest];
}

- (void)ticketTest
{
    self.ticketsCount = 15;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
             [self saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self saleTicket];
        }
    });
}

//å–1å¼ ç¥¨
- (void)saleTicket
{
    int oldTicketsCount = self.ticketsCount;
    sleep(.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
@end
```

æ‰“å°ç»“æœï¼š
```
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©13å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©12å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©11å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©10å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©8å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©7å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©6å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©5å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©4å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©3å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
```

å¯ä»¥çœ‹åˆ°ï¼Œåˆšå¼€å§‹ä¸‰ä¸ªçº¿ç¨‹éƒ½å–äº†1å¼ ç¥¨ï¼Œç»“æœè¿˜æ˜¯ä¸‹14å¼ ç¥¨ã€‚åœ¨ä¸‰ä¸ªçº¿ç¨‹èµ°å®Œåæ€»å…±å–äº†15å¼ ç¥¨ï¼Œä½†æ˜¯æœ€åè¿˜å‰©3å¼ ç¥¨ã€‚æ— è®ºæ˜¯åœ¨å–ç¥¨è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯æœ€åå‰©ä½™çš„ç¥¨æ•°éƒ½å‡ºç°äº†å¼‚å¸¸ã€‚

![å¤šçº¿ç¨‹10](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹10.png)
æ€»å…±15å¼ ç¥¨ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å–ç¥¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯æ‹¿15å‡1ï¼Œå¾—åˆ°çš„æ‰‹åŠ¿14å¼ ç¥¨ã€‚ä¸åŒçš„çº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚

### å­˜é’±å–é’±
```
@interface ViewController ()
@property (assign, nonatomic) int money;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self moneyTest];
}

- (void)moneyTest
{
    self.money = 100;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self saveMoney];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self drawMoney];
        }
    });
}

/// å­˜é’±
- (void)saveMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 50;
    self.money = oldMoney;
    
    NSLog(@"å­˜50ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

/// å–é’±
- (void)drawMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    
    NSLog(@"å–20ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}
@end
```

æ‰“å°ç»“æœï¼š
```
å­˜50ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©80å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©110å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©130å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©90å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©140å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©120å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©170å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©200å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©180å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©230å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©210å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©260å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©240å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©290å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©270å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©320å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©300å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©350å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæœ€åè¿˜å‰©350ã€‚ä»£ç ä¸­ï¼ŒåŸæœ¬æœ‰100ï¼Œå­˜äº†500ï¼Œå–äº†200ï¼Œæ‰€ä»¥ç»“æœåº”è¯¥æ˜¯400ã€‚

![å¤šçº¿ç¨‹11](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹11.png)
æ€»å…±100å…ƒï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‹¿åˆ°100å…ƒï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å­˜äº†50å…ƒåä½™é¢è¿˜å‰©150å…ƒï¼Œç¬¬äºŒä¸ªçº¿ç¨‹å»äº†20å…ƒä½™é¢è¿˜å‰©80å…ƒã€‚ä¸åŒçš„çº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£åˆ†æ

çº¿ç¨‹Aå…ˆå–åˆ°å˜é‡çš„å€¼17ï¼Œçº¿ç¨‹Båå–åˆ°å˜é‡çš„å€¼17ã€‚çº¿ç¨‹Aå¯¹å–åˆ°çš„å€¼åŠ ä¸€ï¼ˆ17+1=18ï¼‰ï¼Œçº¿ç¨‹Bå¯¹å–åˆ°çš„å€¼åŠ ä¸€ï¼ˆ17+1=18ï¼‰ã€‚çº¿ç¨‹Aå°†å¤„ç†åçš„å€¼èµ‹å€¼ç»™å˜é‡ï¼ˆ18ï¼‰ï¼Œçº¿ç¨‹Bä¹Ÿå°†å¤„ç†åçš„å€¼èµ‹å€¼ç»™å˜é‡ï¼ˆ18ï¼‰ã€‚è™½ç„¶ä¿®æ”¹äº†ä¸¤æ¬¡å˜é‡ï¼ˆ+1ï¼‰ï¼Œä½†æ˜¯ç»“æœéƒ½æ˜¯18ï¼š
![å¤šçº¿ç¨‹12](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹12.png)

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£çš„è§£å†³æ–¹æ¡ˆ
è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨çº¿ç¨‹åŒæ­¥æŠ€æœ¯ï¼ˆåŒæ­¥ï¼Œå°±æ˜¯ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿›è¡Œï¼‰ã€‚  
å¸¸è§çš„çº¿ç¨‹åŒæ­¥æŠ€æœ¯æ˜¯ï¼šåŠ é”ã€‚
![å¤šçº¿ç¨‹13](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹13.png)

# iOSä¸­çš„çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ

| åŒæ­¥æ–¹æ¡ˆ | ç®€ä»‹ |
| :-- | :-- |
| OSSpinLock | è‡ªæ—‹é” |
| os_unfair_lock | ç”¨äºå–ä»£ä¸å®‰å…¨çš„OSSpinLock |
| pthread_mutex | äº’æ–¥é” |
| dispatch_semaphore | ä¿¡å·é‡ |
| dispatch_queue(DISPATCH_QUEUE_SERIAL) | ä¸²è¡Œé˜Ÿåˆ— |
| NSLock | å¯¹mutexæ™®é€šé”çš„å°è£… |
| NSRecursiveLock | å¯¹mutexé€’å½’é”çš„å°è£…ï¼ŒAPIè·ŸNSLockåŸºæœ¬ä¸€è‡´ |
| NSCondition | å¯¹mutexå’Œcondçš„å°è£… |
| NSConditionLock | å¯¹NSConditionçš„è¿›ä¸€æ­¥å°è£…ï¼Œå¯ä»¥è®¾ç½®å…·ä½“çš„æ¡ä»¶å€¼ |
| @synchronized | å¯¹mutexé€’å½’é”çš„å°è£… |

å°†å–ç¥¨å’Œå­˜é’±å–é’±æµ‹è¯•ä»£ç å°è£…èµ·æ¥ï¼š
```
@interface BaseLockDemo : NSObject
/// å­˜é’±å–é’±
- (void)moneyTest;
/// å–ç¥¨
- (void)ticketTest;
#pragma mark - æš´éœ²ç»™å­ç±»å»ä½¿ç”¨
- (void)__saveMoney;
- (void)__drawMoney;
- (void)__saleTicket;
@end

@interface BaseLockDemo()
@property (assign, nonatomic) int money;
@property (assign, nonatomic) int ticketsCount;
@end

@implementation BaseLockDemo
///------ å­˜é’±ã€å–é’± ------
- (void)moneyTest
{
    self.money = 100;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self __saveMoney];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self __drawMoney];
        }
    });
}

/// å­˜é’±
- (void)__saveMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 50;
    self.money = oldMoney;
    
    NSLog(@"å­˜50ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

/// å–é’±
- (void)__drawMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    
    NSLog(@"å–20ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

///------ å–ç¥¨ ------
- (void)ticketTest
{
    self.ticketsCount = 15;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
}

/// å–1å¼ ç¥¨
- (void)__saleTicket
{
    int oldTicketsCount = self.ticketsCount;
    sleep(.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
@end
```

## OSSpinLock
`OSSpinLock` å«åšâ€è‡ªæ—‹é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºå¿™ç­‰ï¼ˆbusy-waitï¼‰çŠ¶æ€ï¼Œä¸€ç›´å ç”¨ç€CPUèµ„æºã€‚ç›®å‰å·²ç»ä¸å†å®‰å…¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼ˆå¦‚æœç­‰å¾…é”çš„çº¿ç¨‹ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œå®ƒä¼šä¸€ç›´å ç”¨ç€CPUèµ„æºï¼Œä¼˜å…ˆçº§ä½çš„çº¿ç¨‹å°±æ— æ³•é‡Šæ”¾é”ï¼‰ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <libkern/OSAtomic.h>`ã€‚

å¿™ç­‰çŠ¶æ€å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª do-while å¾ªç¯ï¼Œä¸åœçš„ç›‘æµ‹ç€æ˜¯å¦è§£é”ï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¼šä¸€ç›´å ç”¨ç€CPUèµ„æºã€‚æ­£å› ä¸ºæ˜¯å¤„äºå¿™ç­‰çŠ¶æ€ï¼Œæ‰€ä»¥ `OSSpinLock` çš„æ•ˆç‡è¦å…¶å®ƒé”éƒ½é«˜ï¼Œä¸€æ—¦è§£é”ç«‹åˆ»å°±èƒ½ç›‘æµ‹åˆ°å¹¶ç»§ç»­æ‰§è¡Œã€‚ä¸åœ¨å®‰å…¨çš„åŸå› æ˜¯ä¼˜å…ˆçº§è¾ƒé«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…é”æ—¶ï¼ˆå¿™ç­‰ï¼‰ï¼ŒCPUä¸å†åˆ†é…èµ„æºç»™å…¶å®ƒçº¿ç¨‹ï¼Œé‚£ä¹ˆä¸Šé”çš„çº¿ç¨‹è´Ÿè´£è§£é”ï¼Œç”±äºCPUæ²¡æœ‰åˆ†é…èµ„æºä¹Ÿæ— æ³•è§£é”ï¼Œå¯¼è‡´ä¼˜å…ˆçº§è¾ƒé«˜çš„çº¿ç¨‹ä¸€ç›´åœ¨è¿™é‡Œç­‰å¾…ã€‚

* çº¿ç¨‹è°ƒåº¦
è®¡ç®—æœºé€šå¸¸åªæœ‰ä¸€ä¸ªCPUï¼Œåœ¨ä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œæ¯ä¸ªçº¿ç¨‹åªæœ‰è·å¾—CPUçš„ä½¿ç”¨æƒæ‰èƒ½æ‰§è¡ŒæŒ‡ä»¤ã€‚æ‰€è°“å¤šçº¿ç¨‹çš„å¹¶å‘è¿è¡Œï¼Œå…¶å®æ˜¯æŒ‡ä»å®è§‚ä¸Šçœ‹ï¼Œå„ä¸ªçº¿ç¨‹è½®æµè·å¾—CPUçš„ä½¿ç”¨æƒï¼Œåˆ†åˆ«æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ã€‚åœ¨è¿è¡Œæ± ä¸­ï¼Œä¼šæœ‰å¤šä¸ªå¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨ç­‰å¾…CPUï¼ŒJAVAè™šæ‹Ÿæœºçš„ä¸€é¡¹ä»»åŠ¡å°±æ˜¯è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œçº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡æŒ‰ç…§ç‰¹å®šæœºåˆ¶ä¸ºå¤šä¸ªçº¿ç¨‹åˆ†é…CPUçš„ä½¿ç”¨æƒã€‚
* æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦
æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦æ˜¯ä¸€ç§æœ€å¤è€ï¼Œæœ€ç®€å•ï¼Œæœ€å…¬å¹³ä¸”ä½¿ç”¨æœ€å¹¿çš„ç®—æ³•ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ï¼Œå³è¯¥è¿›ç¨‹å…è®¸è¿è¡Œçš„æ—¶é—´ã€‚å¦‚æœåœ¨æ—¶é—´ç‰‡ç»“æŸæ—¶è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œåˆ™CPUå°†è¢«å‰¥å¤ºå¹¶åˆ†é…ç»™å¦ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹åœ¨æ—¶é—´ç‰‡ç»“æŸå‰é˜»å¡æˆ–ç»“æŸï¼Œåˆ™CPUå½“å³è¿›è¡Œåˆ‡æ¢ã€‚è°ƒåº¦ç¨‹åºæ‰€è¦åšçš„å°±æ˜¯ç»´æŠ¤ä¸€å¼ å°±ç»ªè¿›ç¨‹åˆ—è¡¨ï¼Œå½“è¿›ç¨‹ç”¨å®Œå®ƒçš„æ—¶é—´ç‰‡åï¼Œå®ƒè¢«ç§»åˆ°é˜Ÿåˆ—çš„æœ«å°¾ã€‚

### å¸¸ç”¨API
```
/// åˆå§‹åŒ–
OSSpinLock lock = OS_SPINLOCK_INIT;
/// å°è¯•åŠ é”ï¼ˆå¦‚æœéœ€è¦ç­‰å¾…å°±ä¸åŠ é”ï¼Œç›´æ¥è¿”å›falseï¼›å¦‚æœä¸éœ€è¦ç­‰å¾…å°±åŠ é”ï¼Œè¿”å›trueï¼‰
bool result = OSSpinLockTry(&lock);
/// åŠ é”
OSSpinLockLock(&lock);
/// è§£é”
OSSpinLockUnlock(&lock);
```

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ OSSpinLockDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <libkern/OSAtomic.h>

@interface OSSpinLockDemo()
@property (assign, nonatomic) OSSpinLock moneyLock;
@property (assign, nonatomic) OSSpinLock ticketLock;
@end

@implementation OSSpinLockDemo

- (instancetype)init
{
    if (self = [super init]) {
        self.moneyLock = OS_SPINLOCK_INIT;
        self.ticketLock = OS_SPINLOCK_INIT;
    }
    return self;
}
/// å–é’±
- (void)__drawMoney
{
    OSSpinLockLock(&_moneyLock);
    
    [super __drawMoney];
    
    OSSpinLockUnlock(&_moneyLock);
}
/// å­˜é’±
- (void)__saveMoney
{
    OSSpinLockLock(&_moneyLock);
    
    [super __saveMoney];
    
    OSSpinLockUnlock(&_moneyLock);
}
/// å–ç¥¨
- (void)__saleTicket
{
    OSSpinLockLock(&_ticketLock);
    
    [super __saleTicket];
    
    OSSpinLockUnlock(&_ticketLock);
}
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    BaseLockDemo *demo = [[OSSpinLockDemo alloc] init];
    [demo ticketTest];
    [demo moneyTest];
}
@end
```

è°ƒç”¨ `-(void)moneyTest` æ‰“å°ç»“æœï¼š
```
å­˜50ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©200å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©250å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©300å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©350å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©400å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©450å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©500å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©550å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©600å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å–20ï¼Œè¿˜å‰©580å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©560å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©540å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©520å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©500å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©480å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©460å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©440å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©420å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©400å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
```

è°ƒç”¨ `-(void)ticketTest` æ‰“å°ç»“æœï¼š
```
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©13å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©12å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©11å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©10å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©8å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©7å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©6å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©5å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©4å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©3å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©2å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©1å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©0å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
```

å› ä¸ºè¦ä¿®æ”¹çš„æœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯å­˜é’±å–é’±é‡Œçš„ä½™é¢ï¼Œä¸€ä¸ªæ˜¯å–ç¥¨é‡Œçš„å‰©ä½™ç¥¨æ•°ï¼Œæ‰€ä»¥è¦æœ‰ä¸¤æŠŠé”åˆ†åˆ«å¯¹åº”è¿™ä¸¤ä¸ªå˜é‡ã€‚ä¸€æ—¦æœ‰çº¿ç¨‹å¯¹ OSSpinLock ä¸Šé”åï¼Œå…¶å®ƒçº¿ç¨‹å†é‡åˆ° OSSpinLock æ—¶ä¼šé˜»å¡ä½ï¼Œç­‰å¾… OSSpinLock è§£é”åœ¨ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚

ä¸Šé¢ğŸ‘†çš„ä¾‹å­æ˜¯å°† OSSpinLock é”å¯¹è±¡æ”¾åˆ°äº†å®ä¾‹å¯¹è±¡é‡Œï¼Œä¹Ÿå¯ä»¥å°† OSSpinLock é”å¯¹è±¡æ”¾åˆ°ç±»å¯¹è±¡é‡Œï¼š
```
static OSSpinLock moneyLock_;
+ (void)initialize
{
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        moneyLock_ = 0;
    });
}
```

ç±»æ–¹æ³• `+ (void)initialize` åªä¼šè¢«ç³»ç»Ÿè°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯å…è®¸è¢«å¼€å‘è€…è°ƒç”¨ï¼Œæ‰€ä»¥ä½¿ç”¨ `dispatch_once` ä¿è¯ç±»å¯¹è±¡çš„ `moneyLock_` é”åªåˆå§‹åŒ–ä¸€æ¬¡ã€‚

æˆ–è€…ï¼š
```
- (void)__saleTicket
{
    static OSSpinLock ticketLock = OS_SPINLOCK_INIT;
    
    OSSpinLockLock(&ticketLock);
    
    [super __saleTicket];
    
    OSSpinLockUnlock(&ticketLock);
}
```

ä½¿ç”¨ static å…³é”®å­—ï¼Œå°† `ticketLock` é”ä¿å­˜åœ¨å…¨å±€åŒºï¼Œä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡ã€‚

### OSSpinLock æ±‡ç¼–åˆ†æ
* lldb æŒ‡ä»¤ï¼š
  jneï¼šj æ˜¯ jumpï¼Œne æ˜¯æ¡ä»¶ã€‚  
  callqï¼šå‡½æ•°è°ƒç”¨ã€‚  
  setpï¼šæ‰§è¡Œä¸€è¡ŒOCä»£ç ã€‚  
  stepiï¼šstepinstruction çš„ç®€å†™ï¼Œæ‰§è¡Œä¸€è¡Œæ±‡ç¼–ä»£ç ï¼Œä¹Ÿå¯ä»¥ç®€å†™ä¸º siã€‚  
  nextï¼šæ‰§è¡Œä¸€è¡ŒOCä»£ç ã€‚
  nextiï¼šæ‰§è¡Œä¸€è¡Œæ±‡ç¼–ä»£ç ã€‚
  stepi å’Œ nexti çš„åŒºåˆ«ï¼šåœ¨é‡åˆ°å‡½æ•°è°ƒç”¨æ˜¯ï¼Œstepi ä¼šè¿›å…¥è°ƒç”¨çš„å‡½æ•°ï¼Œnexti ä¸ä¼šè¿›å…¥ã€‚  
  cï¼šcontinue çš„ç®€å†™ï¼Œç»§ç»­æ‰§è¡Œã€‚  

ï¼ˆé‡å¤æ•²å›è½¦ä¼šæ‰§è¡Œä¸Šä¸€ä¸ª lldb æŒ‡ä»¤ï¼Œå¦‚æœæ•²çš„è¿‡å¿«å¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ï¼‰  

### æŸ¥çœ‹æ±‡ç¼–ä»£ç æ–¹æ³•
ğŸ‘‰ ä¿®æ”¹ LockBaseDemo ç±»é‡Œçš„ `- (void)__saleTicket` æ–¹æ³•ï¼Œè®¾ç½®ç¡çœ æ—¶é—´ä¸º 60sï¼Œè¿™æ ·å¯ä»¥æœ‰è¶³å¤Ÿçš„æ—¶é—´æŸ¥çœ‹ç¬¬äºŒæ¬¡åŠ é”æ—¶çš„æ±‡ç¼–ä»£ç ã€‚ä¿®æ”¹ `- (void)ticketTest` æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨10æ¬¡ `- (void)__saleTicket` æ–¹æ³•ï¼š
```
- (void)ticketTest
{
    self.ticketsCount = 15;
    
    for (int i=0; i<10; i++) {
        [[[NSThread alloc] initWithTarget:self selector:@selector(__saleTicket) object:nil] start]; 
    }
}

/// å–ç¥¨
- (void)__saleTicket
{
    int oldTicketsCount = self.ticketsCount; //æ–­ç‚¹
    sleep(60.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
```

ç¬¬ä¸€æ¬¡åŠ é”åï¼Œåœ¨ç¬¬äºŒæ¬¡å°è¯•åŠ é”æ—¶ï¼Œå°±å¯ä»¥æœ‰è¶³å¤Ÿå¤šçš„æ—¶é—´æŸ¥çœ‹å…¶æ±‡ç¼–ä»£ç ï¼Œåœ¨æ–­ç‚¹å¤„æŸ¥çœ‹ Debug -> Debug Workflow -> Always Show Disassemblyã€‚

### æŸ¥çœ‹ OSSpinLock æ±‡ç¼–ä»£ç 

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 9 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 10ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 10 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ si æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ OSSpinLocklock å‡½æ•°ï¼š
![å¤šçº¿ç¨‹15](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹15.png)
ä½¿ç”¨ si æŒ‡ä»¤è¿›å…¥åˆ°è°ƒç”¨å‡½æ•°ï¼š
![å¤šçº¿ç¨‹16](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹16.png)
é‡å¤æ‰§è¡Œ si æŒ‡ä»¤ï¼Œåœ¨ç¬¬6è¡Œé€šè¿‡ jne è·³è½¬åˆ° _OSSpinLockLockSlow å‡½æ•°ï¼š
![å¤šçº¿ç¨‹17](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹17.png)
_OSSpinLockLockSlow å‡½æ•°æ˜¯è‡ªæ—‹é”çš„æ ¸å¿ƒä»£ç ï¼Œä»ç¬¬6è¡Œåˆ°ç¬¬19è¡Œæ˜¯ä¸€ä¸ª while å¾ªç¯ï¼ˆğŸ”è‡ªæ—‹é”æ ‡å¿—ï¼‰ã€‚å› ä¸º Thread 9 å·²ç»åŠ è¿‡é”å¹¶ä¸”è¿˜æ²¡æœ‰è§£é”ï¼Œæ‰€ä»¥è¿™é‡Œä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œï¼Œç­‰å¾… Thread 9 è§£é”ã€‚å¯ä»¥çœ‹åˆ°ç¬¬14è¡Œå’Œç¬¬16è¡Œæ˜¯è·³å‡º while å¾ªç¯çš„åˆ¤æ–­ï¼š
![å¤šçº¿ç¨‹18](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹18.png)


## os_unfair_lock
`OSSpinLock` åœ¨ä»¥å‰ç®—æ˜¯æ€§èƒ½æœ€é«˜çš„ä¸€ç§é”ï¼Œä½†æ˜¯ç”±äºä¸å†å®‰å…¨ï¼ˆä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼‰ï¼Œè‹¹æœå·²ç»ä¸å»ºè®®ä½¿ç”¨äº†ï¼Œä» iOS10 å¼€å§‹æ¨å‡ºäº†æ›¿ä»£å®ƒçš„ `os_unfair_lock`ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <os/lock.h>`ã€‚

### å¸¸ç”¨API
```
/// åˆå§‹åŒ–
os_unfair_lock lock = OS_UNFAIR_LOCK_INIT;
/// å°è¯•åŠ é”
os_unfair_lock_trylock(&lock);
/// åŠ é”
os_unfair_lock_lock(&lock);
/// è§£é”
os_unfair_lock_unlock(&lock);
```

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ OSUnfairLockDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <libkern/OSAtomic.h>

@interface OSUnfairLockDemo()
@property (nonatomic, assign) os_unfair_lock moneyLock;
@property (nonatomic, assign) os_unfair_lock ticketLock;
@end

@implementation OSUnfairLockDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.moneyLock = OS_UNFAIR_LOCK_INIT;
        self.ticketLock = OS_UNFAIR_LOCK_INIT;
    }
    return self;
}

/// å–é’±
- (void)__drawMoney
{
    os_unfair_lock_lock(&_moneyLock);
    
    [super __drawMoney];
    
    os_unfair_lock_unlock(&_moneyLock);
}

/// å­˜é’±
- (void)__saveManey
{
    os_unfair_lock_lock(&_moneyLock);
    
    [super __saveManey];
    
    os_unfair_lock_unlock(&_moneyLock);
}

/// å–ç¥¨
- (void)__saleTicket
{
    os_unfair_lock_lock(&_ticketLock);
    
    [super __saleTicket];
    
    os_unfair_lock_unlock(&_ticketLock);
}
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

* æ­»é”  
å¦‚æœåŠ é”åæ²¡æœ‰è§£é”ï¼Œå…¶å®ƒçº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…ï¼Œæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚è¿™ç§ç”±äºæ²¡æœ‰è§£é”é€ æˆçš„å…¶å®ƒçº¿ç¨‹çš„ç­‰å¾…å«åšæ­»é”ã€‚

### os_unfair_lock æ±‡ç¼–åˆ†æ

æ ¹æ®â€œæŸ¥çœ‹æ±‡ç¼–ä»£ç æ–¹æ³•â€æŸ¥çœ‹ os_unfair_lock ç¬¬äºŒæ¬¡å°è¯•åŠ é”çš„æ±‡ç¼–ä»£ç ã€‚  

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 8 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 15ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 15 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ `os_unfair_lock_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹26](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹26.png)
ä½¿ç”¨ `si` æŒ‡ä»¤è¿›å…¥åˆ° `os_unfair_lock_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹27](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹27.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_os_unfair_lock_lock_slow` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹28](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹28.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œç¬¬56è¡Œä¼šè°ƒç”¨ `__ulock_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹29](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹29.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `__ulock_wait`ï¼š
![å¤šçº¿ç¨‹30](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹30.png)
ç¬¬4è¡Œ `syscall` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåï¼ŒXCode å°±åˆå›åˆ°äº†OCä»£ç é¡µé¢ï¼Œçº¿ç¨‹å°±è¿›å…¥ä¼‘çœ çŠ¶æ€äº†ï¼ˆğŸ”äº’æ–¥é”æ ‡å¿—ï¼‰ï¼š
![å¤šçº¿ç¨‹31](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹31.png)

ä»ä¸Šé¢ğŸ‘†å¯¹ os_unfair_lock çš„æ±‡ç¼–åˆ†æï¼Œå¯ä»¥çœ‹å‡º os_unfair_lock æ˜¯ä¸€ä¸ªäº’æ–¥é”ã€‚åœ¨ os_unfair_lock çš„å¤´æ–‡ä»¶ lock.h é‡Œçš„æ³¨é‡Šå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå•è¯ Low-levelï¼ˆä½çº§é”ï¼‰ï¼Œä½çº§é”çš„ç‰¹ç‚¹å°±æ˜¯ä¼‘çœ ã€‚è‡ªæ—‹é” OSSpinLock æ˜¯ä¸€ä¸ªé«˜çº§é”ã€‚

## pthread_mutex

mutex å«åšâ€äº’æ–¥é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <pthread.h>`ã€‚

### å¸¸ç”¨API
```
/// åˆå§‹åŒ–é”çš„å±æ€§
pthread_mutexattr_t attr;
pthread_mutexattr_init(&attr);
pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_NORMAL);
/// åˆå§‹åŒ–é”
pthread_mutex_t mutex;
pthread_mutex_init(&mutex, &attr);
/// å°è¯•åŠ é”
pthread_mutex_trylock(&mutex);
/// åŠ é”
pthread_mutex_lock(&mutex);
/// è§£é”
pthread_mutex_unlock(&mutex);
/// é”€æ¯ç›¸å…³èµ„æº
pthread_mutexattr_destroy(&attr);
pthread_mutex_destroy(&mutex);
```

é”å®šç±»å‹ï¼š
```
#define PTHREAD_MUTEX_NORMAL		0
#define PTHREAD_MUTEX_ERRORCHECK	1
#define PTHREAD_MUTEX_RECURSIVE		2
#define PTHREAD_MUTEX_DEFAULT		PTHREAD_MUTEX_NORMAL
```

### PTHREAD_MUTEX_INITIALIZER
```
/*
 * Mutex variables
 */
#define PTHREAD_MUTEX_INITIALIZER {_PTHREAD_MUTEX_SIG_init, {0}}
```

å¯ä»¥çœ‹åˆ°ï¼ŒPTHREAD_MUTEX_INITIALIZER æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨ PTHREAD_MUTEX_INITIALIZER åˆå§‹åŒ–é”æ—¶ï¼Œç”±äºç»“æ„ä½“è¯­æ³•çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œé™æ€åˆå§‹åŒ–ï¼š
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
    }
    return self;
}
```

å¦‚æœä½¿ç”¨ PTHREAD_MUTEX_INITIALIZER åŠ¨æ€åˆå§‹åŒ– pthread_mutex_t ä¼šæŠ¥é”™ï¼š
![å¤šçº¿ç¨‹14](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹14.png)

### pthread_mutexattr_t
åˆå§‹åŒ– pthread_mutex é”ï¼š 
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        /// åˆå§‹åŒ–å±æ€§
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_DEFAULT);
        /// åˆå§‹åŒ–é”
        pthread_mutex_init(&_moneyMutex, &attr);
        /// é”€æ¯å±æ€§
        pthread_mutexattr_destroy(&attr);
    }
    return self;
}
```

ä¸Šé¢ğŸ‘†åˆå§‹åŒ–é”çš„ä»£ç æ¯”è¾ƒç¹çï¼Œä¸€èˆ¬ä½¿ç”¨ `pthread_mutex_init(&_moneyMutex, NULL)` æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚`pthread_mutex_init()` æ–¹æ³•çš„ç¬¬äºŒå‚æ•°ä¼  `NULL`ï¼Œå°±ç›¸å½“äºè®¾ç½®äº† `PTHREAD_MUTEX_DEFAULT` ç±»å‹çš„ `pthread_mutexattr_t` å±æ€§ã€‚

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ PthreadMutexDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <pthread.h>

@interface PthreadMutexDemo()
@property (nonatomic, assign) pthread_mutex_t moneyMutex;
@property (nonatomic, assign) pthread_mutex_t ticketMutex;
@end

@implementation PthreadMutexDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_moneyMutex, NULL);
        pthread_mutex_init(&_ticketMutex, NULL);
    }
    return self;
}

/// å–é’±
- (void)__drawMoney
{
    pthread_mutex_lock(&_moneyMutex);
    
    [super __drawMoney];
    
    pthread_mutex_unlock(&_moneyMutex);
}

/// å­˜é’±
- (void)__saveManey
{
    pthread_mutex_lock(&_moneyMutex);
    
    [super __saveManey];
    
    pthread_mutex_unlock(&_moneyMutex);
}

/// å–ç¥¨
- (void)__saleTicket
{
    pthread_mutex_lock(&_ticketMutex);
    
    [super __saleTicket];
    
    pthread_mutex_unlock(&_ticketMutex);
}

/// é”€æ¯é”
- (void)dealloc
{
    pthread_mutex_destroy(&_moneyMutex);
    pthread_mutex_destroy(&_ticketMutex);
}

@end
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

ç›¸å¯¹äº `OSSpinLock` å’Œ `os_unfair_lock`ï¼Œ`pthread_mutex` çš„ API é‡Œæä¾›äº†é”€æ¯æ–¹æ³• `pthread_mutex_destroy()`ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `-(void)dealloc` æ–¹æ³•é‡Œå¯¹é”è¿›è¡Œé”€æ¯ã€‚

### pthread_mutex æ±‡ç¼–åˆ†æ

æ ¹æ®â€œæŸ¥çœ‹æ±‡ç¼–ä»£ç æ–¹æ³•â€æŸ¥çœ‹ pthread_mutex ç¬¬äºŒæ¬¡å°è¯•åŠ é”çš„æ±‡ç¼–ä»£ç ã€‚  

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 10 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 14ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 14 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ `phread_mutex_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹19](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹19.png)
ä½¿ç”¨ `si` æŒ‡ä»¤è¿›å…¥åˆ° `phread_mutex_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹20](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹20.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_pthread_mutex_firstfit_lock_slow` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹21](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹21.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_pthread_mutex_firstfit_lock_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹22](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹22.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè°ƒç”¨ `__psynch_mutexwait`ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹23.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `__psynch_mutexwait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹24.png)
ç¬¬4è¡Œ `syscall` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåï¼ŒXCode å°±åˆå›åˆ°äº†OCä»£ç é¡µé¢ï¼Œçº¿ç¨‹å°±è¿›å…¥ä¼‘çœ çŠ¶æ€äº†ï¼ˆğŸ”äº’æ–¥é”æ ‡å¿—ï¼‰ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹25.png)

ä»ä¸Šé¢ğŸ‘†å¯¹ pthread_mutex çš„æ±‡ç¼–åˆ†æï¼Œå¯ä»¥çœ‹å‡º pthread_mutex æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä½çº§é”ã€‚

## pthread_mutex â€“ é€’å½’é”
åˆå§‹åŒ– pthread_mutex é€’å½’é”ï¼š
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        /// åˆå§‹åŒ–å±æ€§
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
        /// åˆå§‹åŒ–é”
        pthread_mutex_init(&_moneyMutex, &attr);
        /// é”€æ¯å±æ€§
        pthread_mutexattr_destroy(&attr);
    }
    return self;
}
```

ç”¨ PTHREAD_MUTEX_RECURSIVE ç±»å‹å®šä¹‰çš„å±æ€§åˆ›å»ºå‡ºæ¥çš„ pthread_mutex é”å°±æ˜¯ pthread_mutex é€’å½’é”ã€‚

### æ­»é”
åœ¨ä½¿ç”¨é”æ—¶å¦‚æœå‡ºç°äº†é€’å½’è°ƒç”¨ï¼Œæˆ–è€…åœ¨åŠ é”åè°ƒç”¨äº†ä¸€ä¸ªä½¿ç”¨åŒä¸€æŠŠé”çš„æ–¹æ³•ï¼Œå°±ä¼šå‡ºç°æ­»é”çš„æƒ…å†µã€‚ä¸ä¸Šé¢ğŸ‘†æåˆ°è¿‡çš„æ­»é”çš„æ¦‚å¿µç›¸åŒã€‚

å®šä¹‰ PthreadMutexRecursiveDemoï¼š
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@implementation PthreadMutexRecursiveDemo
- (void)recursiveMutexTest
{
    NSLog(@"%s", __func__);
    /// é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
......
```

#### æ­»é”æƒ…å†µä¸€ï¼šé€’å½’è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t mutex;
@end

@implementation PthreadMutexRecursiveDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_mutex, NULL);
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    /// é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
    
    pthread_mutex_unlock(&_mutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_mutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
```

å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœé‡Œåªæœ‰ä¸€æ¡æ‰“å°ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºåŠ é”åå†æ¬¡è°ƒç”¨ `-(void)recursiveMutexTest` æ–¹æ³•ï¼Œä¼šå‘ç° `_mutex` å·²ç»ä¸Šé”äº†ï¼Œè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

#### æ­»é”æƒ…å†µäºŒï¼šå‡½æ•°é—´äº’ç›¸è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t mutex;
@end

@implementation PthreadMutexRecursiveDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_mutex, NULL);
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    /// é€’å½’è°ƒç”¨
    [self recursiveMutexTest2];
    
    pthread_mutex_unlock(&_mutex);
}

- (void)recursiveMutexTest2
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    
    pthread_mutex_unlock(&_mutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_mutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
```

å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœé‡Œåªæœ‰ä¸€æ¡æ‰“å°ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œåœ¨ `- (void)recursiveMutexTest` æ–¹æ³•åŠ é”åå†å»è°ƒç”¨ `- (void)recursiveMutexTest2` æ–¹æ³•æ—¶ï¼Œä¼šå‘ç° _mutex å·²ç»ä¸Šé”äº†ï¼Œè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

### é€’å½’é”

å› ä¸ºé€’å½’é”å…è®¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œé‡å¤åŠ é”ï¼Œæ‰€ä»¥é€’å½’é”å¯ä»¥è§£å†³ä¸Šé¢å‡ºç°çš„æ­»é”æƒ…å†µã€‚

#### è§£å†³æ­»é”æƒ…å†µä¸€ï¼šé€’å½’è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t mutex;
@end

@implementation PthreadMutexRecursiveDemo
- (void)initMutex:(pthread_mutex_t *)mutex
{
    /// åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    /// åˆå§‹åŒ–é”
    pthread_mutex_init(mutex, &attr);
    /// é”€æ¯å±æ€§
    pthread_mutexattr_destroy(&attr);
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initMutex:&_mutex];
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    /// é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
    
    pthread_mutex_unlock(&_mutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_mutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
......
```

#### è§£å†³æ­»é”æƒ…å†µäºŒï¼šå‡½æ•°é—´äº’ç›¸è°ƒç”¨ 
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t mutex;
@end

@implementation PthreadMutexRecursiveDemo
- (void)initMutex:(pthread_mutex_t *)mutex
{
    /// åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    /// åˆå§‹åŒ–é”
    pthread_mutex_init(mutex, &attr);
    /// é”€æ¯å±æ€§
    pthread_mutexattr_destroy(&attr);
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initMutex:&_mutex];
    }
    return self;
}


- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    /// é€’å½’è°ƒç”¨
    [self recursiveMutexTest2];
    
    pthread_mutex_unlock(&_mutex);
}

- (void)recursiveMutexTest2
{
    pthread_mutex_lock(&_mutex);
    
    NSLog(@"%s", __func__);
    
    pthread_mutex_unlock(&_mutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_mutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest2]
```

ä½¿ç”¨é€’å½’é”åï¼Œæ­»é”çš„é—®é¢˜ä¸å­˜åœ¨äº†ã€‚ä½†æ˜¯ï¼ŒåŠ äº†é€’å½’é”åçš„æ‰“å°ç»“æœè·Ÿæ²¡åŠ é”ä¸€æ ·ï¼Œè¿™æ ·è¢«åŠ é”çš„ä»£ç å—è¿˜å®‰å…¨å—ï¼Ÿå…¶å®ï¼Œé€’å½’é”åªå¯ä»¥åœ¨å½“å‰çº¿ç¨‹é‡å¤åŠ é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰çº¿ç¨‹åŠ é”åï¼Œåœ¨å½“å‰çº¿ç¨‹å†æ¬¡è°ƒç”¨ `- (void)recursiveMutexTest` æ–¹æ³•è¿˜å¯ä»¥é‡å¤åŠ é”ï¼Œè€Œå…¶å®ƒçº¿ç¨‹åœ¨æ­¤æ—¶è°ƒç”¨ `- (void)recursiveMutexTest` æ–¹æ³•æ—¶åˆ¤æ–­åˆ°å·²ç»åŠ è¿‡é”äº†å°±ä¸å†åŠ é”äº†ï¼Œä¼šè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

## pthread_mutex â€“ æ¡ä»¶

### ç›¸å…³API
```
/// åˆå§‹åŒ–é”
 pthread_mutex_t mutex;
 /// NULLä»£è¡¨ä½¿ç”¨é»˜è®¤å±æ€§
 pthread_mutex_init(&mutex, NULL);
 /// åˆå§‹åŒ–æ¡ä»¶
 pthread_cond_t condition;
 pthread_cond_init(&condition, NULL);
 /// ç­‰å¾…æ¡ä»¶ï¼ˆè¿›å…¥ä¼‘çœ ï¼Œæ”¾å¼€mutexï¼›è¢«å”¤é†’åï¼Œä¼šå†æ¬¡å¯¹mutexåŠ é”ï¼‰
 pthread_cond_wait(&condition, &mutex);
 /// æ¿€æ´»ä¸€ä¸ªç­‰å¾…è¯¥æ¡ä»¶çš„çº¿ç¨‹
 pthread_cond_signal(&condition);
 /// æ¿€æ´»æ‰€æœ‰ç­‰å¾…è¯¥æ¡ä»¶çš„çº¿ç¨‹
 pthread_cond_broadcast(&condition);
 /// é”€æ¯èµ„æº
 pthread_mutex_destroy(&mutex);
 pthread_cond_destroy(&condition);
```

### åº”ç”¨åœºæ™¯
```
#import <pthread.h>

@interface PthreadMutexCondDemo()
@property (nonatomic, assign) pthread_mutex_t mutex;
@property (nonatomic, assign) pthread_cond_t cond;
@property (nonatomic, strong) NSMutableArray *data;
@end

@implementation PthreadMutexCondDemo

- (void)initMutex:(pthread_mutex_t *)mutex cond:(pthread_cond_t *)cond
{
    /// åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    /// åˆå§‹åŒ–é”
    pthread_mutex_init(mutex, &attr);
    /// é”€æ¯å±æ€§
    pthread_mutexattr_destroy(&attr);
    /// åˆå§‹åŒ–æ¡ä»¶
    pthread_cond_init(cond, NULL);
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initMutex:&_mutex cond:&_cond];
        
        self.data = [NSMutableArray array];
    }
    return self;
}

- (void)otherTest
{
    [[[NSThread alloc] initWithTarget:self selector:@selector(remove) object:nil] start];
    
    sleep(2.);
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(add) object:nil] start];
}

/// çº¿ç¨‹1
- (void)remove
{
    pthread_mutex_lock(&_mutex);
    NSLog(@"%s, ä¸Šé”", __func__);
    
    if (self.data.count == 0) {
        NSLog(@"%s, ç­‰å¾…ä¿¡å·", __func__);
        pthread_cond_wait(&_cond, &_mutex);
        NSLog(@"%s, æ”¶åˆ°ä¿¡å·", __func__);
    }
    
    [self.data removeLastObject];
    NSLog(@"%s, åˆ é™¤", __func__);
    
    pthread_mutex_unlock(&_mutex);
    NSLog(@"%s, è§£é”", __func__);
}

/// çº¿ç¨‹2
- (void)add
{
    pthread_mutex_lock(&_mutex);
    NSLog(@"%s, ä¸Šé”", __func__);
    
    [self.data addObject:@"test"];
    NSLog(@"%s, æ·»åŠ ", __func__);
    
    pthread_cond_signal(&_cond);
    NSLog(@"%s, å‘é€ä¿¡å·", __func__);
    
    pthread_mutex_unlock(&_mutex);
    NSLog(@"%s, è§£é”", __func__);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_mutex);
    pthread_cond_destroy(&_cond);
}

@end
```

æ‰“å°ç»“æœï¼š
```
00:35:21.182042+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142356] -[PthreadMutexCondDemo remove], ä¸Šé”
00:35:21.182158+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142356] -[PthreadMutexCondDemo remove], ç­‰å¾…ä¿¡å·
00:35:23.182238+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142386] -[PthreadMutexCondDemo add], ä¸Šé”
00:35:23.182447+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142386] -[PthreadMutexCondDemo add], æ·»åŠ 
00:35:23.182614+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142386] -[PthreadMutexCondDemo add], å‘é€ä¿¡å·
00:35:23.182700+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142386] -[PthreadMutexCondDemo add], è§£é”
00:35:23.182709+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142356] -[PthreadMutexCondDemo remove], æ”¶åˆ°ä¿¡å·
00:35:23.182772+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142356] -[PthreadMutexCondDemo remove], åˆ é™¤
00:35:23.182835+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[7160:142356] -[PthreadMutexCondDemo remove], è§£é”
```

åœ¨ `pthread_cond_wait()` æ–¹æ³•è°ƒç”¨åï¼Œçº¿ç¨‹1ä¼šè§£é”å¹¶è¿›å…¥ç­‰å¾…æ¶ˆæ¯çŠ¶æ€ï¼ˆä¼‘çœ ï¼‰ã€‚çº¿ç¨‹2ç›‘å¬åˆ° pthread_mutex_t é”å·²ç»è§£é”å¼€å§‹æ­£å¸¸æ‰§è¡Œï¼Œæ·»åŠ å®Œæ•°æ®åå‘é€æ¶ˆæ¯ã€‚çº¿ç¨‹1åœ¨æ”¶åˆ°æ¶ˆæ¯åä¼šåˆ¤æ–­ pthread_mutex_t é”æ˜¯å¦å·²ç»ä¸Šé”ï¼Œå¦‚æœå·²ç»ä¸Šé”äº†å°±ç»§ç»­ç­‰å¾…å…¶è§£é”ï¼ˆä¼‘çœ ï¼‰ï¼Œä¸€æ—¦è§£é”äº†ï¼ˆçº¿ç¨‹2ï¼‰å°±ç«‹å³å‘ä¸‹æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚

å› ä¸ºåº”ç”¨åœºæ™¯æ˜¯ä¸åŒçº¿ç¨‹çš„è°ƒç”¨ï¼Œæ‰€ä»¥åˆå§‹åŒ–å±æ€§æ—¶ä¼ å…¥çš„ç¬¬äºŒä¸ªçš„å‚æ•° PTHREAD_MUTEX_RECURSIVE ä¹Ÿå¯ä»¥æ˜¯ PTHREAD_MUTEX_NORMALã€‚

pthread_mutex æ¡ä»¶é”çš„åº”ç”¨åœºæ™¯æ¯”è¾ƒå°‘è§ï¼Œå°±ç®—é‡åˆ°äº†ç±»ä¼¼çš„åœºæ™¯ï¼Œä¼°è®¡ä¹Ÿä¸ä¼šé€‰æ‹©ç”¨è¿™ç§æ–¹å¼è§£å†³ã€‚å®ƒä¸»è¦æ˜¯è§£å†³ä¼˜å…ˆåŠé—®é¢˜ï¼Œä¸Šé¢ğŸ‘†ä»£ç ä¸­ä¸ºäº†ä¸å¯¹ç©ºæ•°ç»„è¿›è¡Œåˆ é™¤æ“ä½œï¼Œç»™é”æ·»åŠ äº†æ¡ä»¶ï¼Œä¿è¯äº†æ•°ç»„çš„åˆ é™¤æ“ä½œåœ¨æ·»åŠ å®Œæ•°æ®åæ‰§è¡Œã€‚

## NSLock

NSLock æ˜¯å¯¹ mutex æ™®é€šé”çš„å°è£…ã€‚

### ç›¸å…³API
```
/// åˆå§‹åŒ–é”
NSLock *lock = [[NSLock alloc] init];
/// åŠ é”
[lock lock];
/// è§£é”
[lock unlock];
```

### åº”ç”¨
```
@interface NSLockDemo()
@property (nonatomic, strong) NSLock *moneyLock;
@property (nonatomic, strong) NSLock *ticketLock;
@end

@implementation NSLockDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.moneyLock = [[NSLock alloc] init];
        self.ticketLock = [[NSLock alloc] init];
    }
    return self;
}

/// å–é’±
- (void)__drawMoney
{
    [self.moneyLock lock];
    
    [super __drawMoney];
    
    [self.moneyLock unlock];
}

/// å­˜é’±
- (void)__saveManey
{
    [self.moneyLock lock];
    
    [super __saveManey];
    
    [self.moneyLock unlock];
}

/// å–ç¥¨
- (void)__saleTicket
{
    [self.ticketLock lock];
    
    [super __saleTicket];
    
    [self.ticketLock unlock];
}

@end
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

### NSLock å®ç°åŸç†

åœ¨ GNUstep é‡Œçš„ source/Foundation ä¸‹é¢å¯ä»¥æ‰¾åˆ° NSLock.m æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶é‡Œå¯ä»¥æ‰¾åˆ° NSLock çš„å…·ä½“å®ç°ï¼š
```
......
/// NSLock.hæ–‡ä»¶ï¼ˆFoundationï¼‰
@protocol NSLocking

- (void)lock;
- (void)unlock;

@end

@interface NSLock : NSObject <NSLocking> {
@private
    void *_priv;
}

/// å°è¯•åŠ é”ï¼Œè¿”å›YESè¡¨ç¤ºåŠ é”æˆåŠŸ
- (BOOL)tryLock;
/// å°è¯•åŠ é”ï¼Œè¿”å›YESè¡¨ç¤ºåŠ é”æˆåŠŸï¼Œåœ¨ç»ˆæ­¢æ—¶é—´ï¼ˆlimtï¼‰å‰å¤„äºåŠ é”çŠ¶æ€ï¼Œåˆ°äº†æ—¶é—´åï¼Œä¼šè‡ªåŠ¨è§£é”
- (BOOL)lockBeforeDate:(NSDate *)limit;

@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));

@end

/// NSLock.mæ–‡ä»¶ï¼ˆGNUstepï¼‰
@implementation NSLock

+ (id) allocWithZone: (NSZone*)z
{
    if (self == baseLockClass && YES == traceLocks)
    {
        return class_createInstance(tracedLockClass, 0);
    }
    return class_createInstance(self, 0);
}

+ (void) initialize
{
  static BOOL	beenHere = NO;

    if (beenHere == NO)
    {
        beenHere = YES;

        pthread_mutexattr_init(&attr_normal);
        pthread_mutexattr_settype(&attr_normal, PTHREAD_MUTEX_NORMAL);
        pthread_mutexattr_init(&attr_reporting);
        pthread_mutexattr_settype(&attr_reporting, PTHREAD_MUTEX_ERRORCHECK);
        pthread_mutexattr_init(&attr_recursive);
        pthread_mutexattr_settype(&attr_recursive, PTHREAD_MUTEX_RECURSIVE);

        pthread_mutex_init(&deadlock, &attr_normal);
        pthread_mutex_lock(&deadlock);

        baseConditionClass = [NSCondition class];
        baseConditionLockClass = [NSConditionLock class];
        baseLockClass = [NSLock class];
        baseRecursiveLockClass = [NSRecursiveLock class];

        tracedConditionClass = [GSTracedCondition class];
        tracedConditionLockClass = [GSTracedConditionLock class];
        tracedLockClass = [GSTracedLock class];
        tracedRecursiveLockClass = [GSTracedRecursiveLock class];

        untracedConditionClass = [GSUntracedCondition class];
        untracedConditionLockClass = [GSUntracedConditionLock class];
        untracedLockClass = [GSUntracedLock class];
        untracedRecursiveLockClass = [GSUntracedRecursiveLock class];
    }
}

MDEALLOC
MDESCRIPTION
MFINALIZE

/* Use an error-checking lock.  This is marginally slower, but lets us throw
 * exceptions when incorrect locking occurs.
 */
- (id) init
{
    if (nil != (self = [super init]))
    {
        if (0 != pthread_mutex_init(&_mutex, &attr_reporting))
        {
            DESTROY(self);
        }
    }
    return self;
}

......
```

## NSRecursiveLock

NSRecursiveLock æ˜¯å¯¹ mutex é€’å½’é”çš„å°è£…ï¼ŒAPI è·Ÿ NSLock åŸºæœ¬ä¸€è‡´ã€‚

### å¸¸ç”¨API
```
/// åˆå§‹åŒ–
NSRecursiveLock *lock = [[NSRecursiveLock alloc] init];
/// åŠ é”
[lock lock];
/// è§£é”
[lock unlock];
```

### åº”ç”¨

#### é€’å½’è°ƒç”¨
```
@interface NSRecursiveLockDemo()
@property (nonatomic, strong) NSRecursiveLock *lock;
@end

@implementation NSRecursiveLockDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.lock = [[NSRecursiveLock alloc] init];
    }
    return self;
}

- (void)test
{
    [self.lock lock];
    
    NSLog(@"%s", __func__);
    
    [self test];
    
    [self.lock unlock];
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[NSRecursiveLockDemo test]
-[NSRecursiveLockDemo test]
-[NSRecursiveLockDemo test]
-[NSRecursiveLockDemo test]
......
```

#### æ–¹æ³•é—´è°ƒç”¨
```
@interface NSRecursiveLockDemo()
@property (nonatomic, strong) NSRecursiveLock *lock;
@end

@implementation NSRecursiveLockDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.lock = [[NSRecursiveLock alloc] init];
    }
    return self;
}

- (void)test
{
    [self.lock lock];
    
    NSLog(@"%s", __func__);
    
    [self test2];
    
    [self.lock unlock];
}

- (void)test2
{
    [self.lock lock];
    
    NSLog(@"%s", __func__);
    
   [self.lock unlock];
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[NSRecursiveLockDemo test]
-[NSRecursiveLockDemo test2]
```

### NSRecursiveLock å®ç°åŸç†
åœ¨ GNUstep é‡Œçš„ source/Foundation ä¸‹é¢å¯ä»¥æ‰¾åˆ° NSLock.m æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶é‡Œå¯ä»¥æ‰¾åˆ° NSRecursiveLock çš„å…·ä½“å®ç°ï¼š
```
/// NSLock.hæ–‡ä»¶ï¼ˆFoundationï¼‰
@protocol NSLocking

- (void)lock;
- (void)unlock;

@end

@interface NSRecursiveLock : NSObject <NSLocking> {
@private
    void *_priv;
}

/// å°è¯•åŠ é”ï¼Œè¿”å›YESè¡¨ç¤ºåŠ é”æˆåŠŸ
- (BOOL)tryLock;
/// å°è¯•åŠ é”ï¼Œè¿”å›YESè¡¨ç¤ºåŠ é”æˆåŠŸï¼Œåœ¨ç»ˆæ­¢æ—¶é—´ï¼ˆlimtï¼‰å‰å¤„äºåŠ é”çŠ¶æ€ï¼Œåˆ°äº†ç»ˆæ­¢æ—¶é—´ä¼šè‡ªåŠ¨è§£é”
- (BOOL)lockBeforeDate:(NSDate *)limit;

@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));

@end

/// NSLock.mæ–‡ä»¶ï¼ˆGNUstepï¼‰
static pthread_mutexattr_t attr_recursive;

@implementation NSRecursiveLock

+ (id) allocWithZone: (NSZone*)z
{
    if (self == baseRecursiveLockClass && YES == traceLocks)
    {
        return class_createInstance(tracedRecursiveLockClass, 0);
    }
    return class_createInstance(self, 0);
}

+ (void) initialize
{
    [NSLock class];	// Ensure mutex attributes are set up.
}

MDEALLOC
MDESCRIPTION
MFINALIZE

- (id) init
{
    if (nil != (self = [super init]))
    {
        if (0 != pthread_mutex_init(&_mutex, &attr_recursive))
        {
            DESTROY(self);
        }
    }
    return self;
}

MISLOCKED
MLOCK
MLOCKBEFOREDATE
MNAME
MSTACK
MTRYLOCK
MUNLOCK
@end
```

å› ä¸º NSRecursiveLock æ˜¯åœ¨ lock.m æ–‡ä»¶å®šä¹‰çš„ï¼Œæ‰€ä»¥ `- (id)init` æ–¹æ³•é‡Œçš„ attr_recursive å±æ€§æ˜¯åœ¨ `+ (void)initialize` æ–¹æ³•ğŸ‘†é‡Œåˆ›å»ºå¥½çš„ï¼š
```
pthread_mutexattr_init(&attr_recursive);
pthread_mutexattr_settype(&attr_recursive, PTHREAD_MUTEX_RECURSIVE);
```

## NSCondition
NSCondition æ˜¯å¯¹ mutex å’Œ cond çš„å°è£…ã€‚

### ç›¸å…³API
```
/// åˆå§‹åŒ–
NSCondition *condition = [[NSCondition alloc] init];
/// åŠ é”
[condition lock];
/// è§£é”
[condition unlock];
/// ç­‰å¾…
[condition wait];
/// å‘ä¿¡å·
[condition signal];
```

### åº”ç”¨
```
@interface NSConditionDemo()
@property (nonatomic, strong) NSCondition *condition;
@property (nonatomic, strong) NSMutableArray *data;
@end

@implementation NSConditionDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        self.condition = [[NSCondition alloc] init];
        self.data = [NSMutableArray array];
    }
    return self;
}

- (void)otherTest
{
    [[[NSThread alloc] initWithTarget:self selector:@selector(remove) object:nil] start];
    
    sleep(2.);
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(add) object:nil] start];
}

- (void)remove
{
    [self.condition lock];
    NSLog(@"%s, ä¸Šé”", __func__);
    
    if (self.data.count == 0) {
        NSLog(@"%s, ç­‰å¾…ä¿¡å·", __func__);
        [self.condition wait];
        NSLog(@"%s, æ”¶åˆ°ä¿¡å·", __func__);
    }
    
    [self.data removeLastObject];
    NSLog(@"%s, åˆ é™¤", __func__);
    
    [self.condition unlock];
    NSLog(@"%s, è§£é”", __func__);
}

- (void)add
{
    [self.condition lock];
    NSLog(@"%s, ä¸Šé”", __func__);
    
    [self.data addObject:@"test"];
    NSLog(@"%s, æ·»åŠ ", __func__);
    
    [self.condition signal];
    NSLog(@"%s, å‘é€ä¿¡å·", __func__);
    
    [self.condition unlock];
    NSLog(@"%s, è§£é”", __func__);
}

@end
```

æ‰“å°ç»“æœï¼š
```
14:30:32.001876+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271952] -[NSConditionDemo remove], ä¸Šé”
14:30:32.002080+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271952] -[NSConditionDemo remove], ç­‰å¾…ä¿¡å·
14:30:34.002046+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271974] -[NSConditionDemo add], ä¸Šé”
14:30:34.002227+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271974] -[NSConditionDemo add], æ·»åŠ 
14:30:34.002313+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271974] -[NSConditionDemo add], å‘é€ä¿¡å·
14:30:34.002384+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271974] -[NSConditionDemo add], è§£é”
14:30:34.002395+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271952] -[NSConditionDemo remove], æ”¶åˆ°ä¿¡å·
14:30:34.002470+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271952] -[NSConditionDemo remove], åˆ é™¤
14:30:34.002556+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[26696:271952] -[NSConditionDemo remove], è§£é”
```

### NSCondition å®ç°åŸç†
åœ¨ GNUstep é‡Œçš„ source/Foundation ä¸‹é¢å¯ä»¥æ‰¾åˆ° NSLock.m æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶é‡Œå¯ä»¥æ‰¾åˆ° NSRecursiveLock çš„å…·ä½“å®ç°ï¼š
```
/// NSLock.hæ–‡ä»¶ï¼ˆFoundationï¼‰
@protocol NSLocking

- (void)lock;
- (void)unlock;

@end

@interface NSCondition : NSObject <NSLocking> {
@private
    void *_priv;
}
/// æ·»åŠ ç­‰å¾…ï¼Œæ”¶åˆ°äº† signal å°±ä¼šå”¤é†’çº¿ç¨‹
- (void)wait;
/// ç­‰å¾…æ¡ä»¶ï¼ˆè¿›å…¥ä¼‘çœ ï¼Œè§£é”ï¼›è¢«å”¤é†’åï¼ŒåŠ é”ï¼‰ã€‚åœ¨ç»ˆæ­¢æ—¶é—´ï¼ˆlimtï¼‰å‰æ”¶åˆ°äº† signal å°±ä¼šå”¤é†’çº¿ç¨‹ã€‚å½“åˆ°è¾¾ç»ˆæ­¢æ—¶é—´çš„æ—¶å€™ï¼Œå³ä½¿æ²¡æœ‰æ”¶åˆ° signalï¼Œä¹Ÿä¼šç›´æ¥å”¤é†’çº¿ç¨‹
- (BOOL)waitUntilDate:(NSDate *)limit;
/// æ¿€æ´»ä¸€ä¸ªç­‰å¾…è¯¥æ¡ä»¶çš„çº¿ç¨‹
- (void)signal;
/// æ¿€æ´»æ‰€æœ‰ç­‰å¾…è¯¥æ¡ä»¶çš„çº¿ç¨‹
- (void)broadcast;

@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));

@end

/// NSLock.mæ–‡ä»¶ï¼ˆGNUstepï¼‰
@implementation NSCondition

+ (id) allocWithZone: (NSZone*)z
{
    if (self == baseConditionClass && YES == traceLocks)
    {
        return class_createInstance(tracedConditionClass, 0);
    }
    return class_createInstance(self, 0);
}

+ (void) initialize
{
    [NSLock class];	// Ensure mutex attributes are set up.
}

- (void) broadcast
{
    pthread_cond_broadcast(&_condition);
}

MDEALLOC
MDESCRIPTION

- (void) finalize
{
    pthread_cond_destroy(&_condition);
    pthread_mutex_destroy(&_mutex);
}

- (id) init
{
    if (nil != (self = [super init]))
    {
        if (0 != pthread_cond_init(&_condition, NULL))
        {
            DESTROY(self);
        }
        else if (0 != pthread_mutex_init(&_mutex, &attr_reporting))
        {
            pthread_cond_destroy(&_condition);
            DESTROY(self);
        }
    }
    return self;
}

MISLOCKED
MLOCK
MLOCKBEFOREDATE
MNAME

- (void) signal
{
    pthread_cond_signal(&_condition);
}

MSTACK
MTRYLOCK
MUNLOCK

- (void) wait
{
    pthread_cond_wait(&_condition, &_mutex);
}

- (BOOL) waitUntilDate: (NSDate*)limit
{
    NSTimeInterval ti = [limit timeIntervalSince1970];
    double secs, subsecs;
    struct timespec timeout;
    int retVal = 0;

    // Split the float into seconds and fractions of a second
    subsecs = modf(ti, &secs);
    timeout.tv_sec = secs;
    // Convert fractions of a second to nanoseconds
    timeout.tv_nsec = subsecs * 1e9;

    /* NB. On timeout the lock is still held even through condition is not met
    */

    retVal = pthread_cond_timedwait(&_condition, &_mutex, &timeout);
    if (retVal == 0)
    {
        return YES;
    }
    if (retVal == ETIMEDOUT)
    {
        return NO;
    }
    if (retVal == EINVAL)
    {
        NSLog(@"Invalid arguments to pthread_cond_timedwait");
    }
    return NO;
}

@end
```

## NSConditionLock

NSConditionLock æ˜¯å¯¹ NSCondition çš„è¿›ä¸€æ­¥å°è£…ï¼Œå¯ä»¥è®¾ç½®å…·ä½“çš„æ¡ä»¶å€¼ã€‚

### ç›¸å…³API
```
/// åˆå§‹åŒ–é”ï¼Œè®¾ç½®é”çš„æ¡ä»¶1
NSConditionLock *conditionLock = [[NSConditionLock alloc] initWithCondition:1];
/// å¦‚æœæ¡ä»¶ä¸º1å°±åŠ é”
[conditionLock lockWhenCondition:1];
/// è§£é”ï¼Œå¹¶è®¾ç½®æ¡ä»¶ä¸º2
[conditionLock unlockWithCondition:2];
```

### åº”ç”¨
```
@interface NSConditionLockDemo()
@property (nonatomic, strong) NSConditionLock *conditionLock;
@property (nonatomic, strong) NSMutableArray *data;
@end

@implementation NSConditionLockDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        self.conditionLock = [[NSConditionLock alloc] initWithCondition:1];
        
        self.data = [NSMutableArray array];
    }
    return self;
}

- (void)otherTest
{
    [[[NSThread alloc] initWithTarget:self selector:@selector(one) object:nil] start];
    
    sleep(2.);
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(two) object:nil] start];
    
    sleep(2.);
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(three) object:nil] start];
}

- (void)one
{
    [self.conditionLock lockWhenCondition:1];
    
    NSLog(@"1");
    
    [self.conditionLock unlockWithCondition:2];
}

- (void)two
{
    [self.conditionLock lockWhenCondition:2];
    
    NSLog(@"2");
    
    [self.conditionLock unlockWithCondition:3];
}

- (void)three
{
    [self.conditionLock lockWhenCondition:3];
    
    NSLog(@"3");
    
    [self.conditionLock unlockWithCondition:4];
}
@end
```

æ‰“å°ç»“æœï¼š
```
16:04:40.425810+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[28831:334816] 1
16:04:42.426001+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[28831:334904] 2
16:04:44.426143+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[28831:334908] 3
```

å¯ä»¥çœ‹åˆ° NSConditionLock å¯ä»¥ç»™çº¿ç¨‹ä¹‹é—´è®¾ç½®ä¼˜å…ˆçº§ã€‚

å¦‚æœä½¿ç”¨ `-(void)lock` æ–¹æ³•åªä¼šåˆ¤æ–­é”æ˜¯å¦å¤„äºåŠ é”çŠ¶æ€ï¼Œå¦‚æœä¸æ˜¯å°±ç›´æ¥åŠ é”ï¼Œä¸ä¼šåˆ¤æ–­æ¡ä»¶ã€‚

### NSConditionLock å®ç°åŸç†
åœ¨ GNUstep é‡Œçš„ source/Foundation ä¸‹é¢å¯ä»¥æ‰¾åˆ° NSLock.m æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶é‡Œå¯ä»¥æ‰¾åˆ° NSConditionLock çš„å…·ä½“å®ç°ï¼š
```
/// NSLock.hæ–‡ä»¶ï¼ˆFoundationï¼‰
@interface NSConditionLock : NSObject <NSLocking> {
@private
    void *_priv;
}

/// åˆå§‹åŒ–
- (instancetype)initWithCondition:(NSInteger)condition NS_DESIGNATED_INITIALIZER;
/// æ¡ä»¶
@property (readonly) NSInteger condition;
/// å¦‚æœæ¡ä»¶æˆç«‹å°±åŠ é”
- (void)lockWhenCondition:(NSInteger)condition;
/// å°è¯•åŠ é”ï¼ŒæˆåŠŸè¿”å›YES
- (BOOL)tryLock;
/// å¦‚æœæ¡ä»¶æˆç«‹å°±å°è¯•åŠ é”ï¼ŒæˆåŠŸè¿”å›YES
- (BOOL)tryLockWhenCondition:(NSInteger)condition;
/// è§£é”å¹¶è®¾ç½®æ¡ä»¶
- (void)unlockWithCondition:(NSInteger)condition;
/// åœ¨ç»ˆæ­¢æ—¶é—´å‰åŠ é”ï¼ŒæˆåŠŸè¿”å›YES
- (BOOL)lockBeforeDate:(NSDate *)limit;
/// åœ¨ç»ˆæ­¢æ—¶é—´å‰ï¼Œå¦‚æœæ¡ä»¶æˆç«‹å°±åŠ é”
- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;

@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));

@end

/// NSLock.mæ–‡ä»¶ï¼ˆGNUstepï¼‰
@implementation NSConditionLock

+ (id) allocWithZone: (NSZone*)z
{
    if (self == baseConditionLockClass && YES == traceLocks)
    {
        return class_createInstance(tracedConditionLockClass, 0);
    }
    return class_createInstance(self, 0);
}

+ (void) initialize
{
    [NSLock class];	// Ensure mutex attributes are set up.
}

- (NSInteger) condition
{
    return _condition_value;
}

- (void) dealloc
{
    [_name release];
    [_condition release];
    [super dealloc];
}

- (id) init
{
    return [self initWithCondition: 0];
}

- (id) initWithCondition: (NSInteger)value
{
    if (nil != (self = [super init]))
    {
        if (nil == (_condition = [NSCondition new]))
        {
            DESTROY(self);
        }
        else
        {
            _condition_value = value;
            [_condition setName:[NSString stringWithFormat: @"condition-for-lock-%p", self]];
        }
    }
    return self;
}

- (BOOL) isLockedByCurrentThread
{
    return [_condition isLockedByCurrentThread];
}

- (void) lock
{
    [_condition lock];
}

- (BOOL) lockBeforeDate: (NSDate*)limit
{
    return [_condition lockBeforeDate: limit];
}

- (void) lockWhenCondition: (NSInteger)value
{
    [_condition lock];
    while (value != _condition_value)
    {
        [_condition wait];
    }
}

- (BOOL) lockWhenCondition: (NSInteger)condition_to_meet
                beforeDate: (NSDate*)limitDate
{
    if (NO == [_condition lockBeforeDate: limitDate])
    {
        return NO;        // Not locked
    }
    if (condition_to_meet == _condition_value)
    {
        return YES;       // Keeping the lock
    }
    while ([_condition waitUntilDate: limitDate])
    {
        if (condition_to_meet == _condition_value)
        {
            return YES;   // Keeping the lock
        }
    }
    [_condition unlock];
    return NO;            // Not locked
}

MNAME
MSTACK

- (BOOL) tryLock
{
    return [_condition tryLock];
}

- (BOOL) tryLockWhenCondition: (NSInteger)condition_to_meet
{
    if ([_condition tryLock])
    {
        if (condition_to_meet == _condition_value)
        {
            return YES; // KEEP THE LOCK
        }
        else
        {
            [_condition unlock];
        }
    }
    return NO;
}

- (void) unlock
{
    [_condition unlock];
}

- (void) unlockWithCondition: (NSInteger)value
{
    _condition_value = value;
    [_condition broadcast];
    [_condition unlock];
}

@end
```

## dispatch_semaphore

semaphore å«åšâ€œä¿¡å·é‡â€ã€‚ä¿¡å·é‡çš„åˆå§‹å€¼ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶çº¿ç¨‹å¹¶å‘è®¿é—®çš„æœ€å¤§æ•°é‡ã€‚ä¿¡å·é‡çš„åˆå§‹å€¼ä¸º1ï¼Œä»£è¡¨åŒæ—¶åªå…è®¸1æ¡çº¿ç¨‹è®¿é—®èµ„æºï¼Œä¿è¯çº¿ç¨‹åŒæ­¥ã€‚

### ç›¸å…³API
```
/// åˆå§‹åŒ–
dispatch_semaphore_t semaphore = dispatch_semaphore_create(5);
/// å¦‚æœä¿¡å·é‡çš„å€¼ >= 0ï¼Œå°±è®©ä¿¡å·é‡çš„å€¼å‡1ï¼Œç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œä»£ç 
/// å¦‚æœä¿¡å·é‡çš„å€¼ <= 0ï¼Œå°±ä¼šä¼‘çœ ç­‰å¾…ï¼›å½“ä¿¡å·é‡çš„å€¼å˜æˆ >0 æ—¶ï¼Œå°±è®©ä¿¡å·é‡çš„å€¼å‡1ï¼Œç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œä»£ç 
/// DISPATCH_TIME_FOREVER è¡¨ç¤ºä¸€ç›´åœ¨è¿™é‡Œç­‰å¾…ä¿¡å·é‡å˜æˆ >0ï¼›DISPATCH_TIME_NOW åˆ¤æ–­å®Œåä¸ç®¡ä¿¡å·é‡çš„å€¼æ˜¯å¦ >0 éƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);
/// è®©ä¿¡å·é‡çš„å€¼+1
dispatch_semaphore_signal(semaphore);
```

### åº”ç”¨ - æ§åˆ¶æœ€å¤§å¹¶å‘æ•°é‡
```
@interface SemaphoreDemo()
@property (nonatomic, strong) dispatch_semaphore_t semaphore;
@end

@implementation SemaphoreDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        self.semaphore = dispatch_semaphore_create(5);
    }
    return self;
}

- (void)otherTest
{
    for (int i=0; i < 20; i++) {
        [[[NSThread alloc] initWithTarget:self selector:@selector(test) object:nil] start];
    }
}

- (void)test
{
    dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);
    
    sleep(2);
    NSLog(@"test - %@", [NSThread currentThread]);
    
    dispatch_semaphore_signal(self.semaphore);
}
@end
```

æ‰“å°ç»“æœï¼š
```
10:16:19.552038+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47431] test - <NSThread: 0x600002deb640>{number = 6, name = (null)}
10:16:19.552041+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47434] test - <NSThread: 0x600002deb880>{number = 9, name = (null)}
10:16:19.552076+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47441] test - <NSThread: 0x600002deba40>{number = 16, name = (null)}
10:16:19.552043+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47433] test - <NSThread: 0x600002deb600>{number = 8, name = (null)}
10:16:19.552082+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47435] test - <NSThread: 0x600002deb8c0>{number = 10, name = (null)}
10:16:21.552319+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47445] test - <NSThread: 0x600002debb40>{number = 20, name = (null)}
10:16:21.552317+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47432] test - <NSThread: 0x600002deb800>{number = 7, name = (null)}
10:16:21.552447+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47439] test - <NSThread: 0x600002deb9c0>{number = 14, name = (null)}
10:16:21.552460+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47438] test - <NSThread: 0x600002deb980>{number = 13, name = (null)}
10:16:21.552463+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47449] test - <NSThread: 0x600002df16c0>{number = 24, name = (null)}
10:16:24.475953+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47436] test - <NSThread: 0x600002deb900>{number = 11, name = (null)}
10:16:24.475953+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47443] test - <NSThread: 0x600002debac0>{number = 18, name = (null)}
10:16:24.475953+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47444] test - <NSThread: 0x600002debb00>{number = 19, name = (null)}
10:16:24.475953+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47450] test - <NSThread: 0x600002da8380>{number = 25, name = (null)}
10:16:24.476004+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47446] test - <NSThread: 0x600002debb80>{number = 21, name = (null)}
10:16:26.476651+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47437] test - <NSThread: 0x600002deb940>{number = 12, name = (null)}
10:16:26.476652+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47448] test - <NSThread: 0x600002debc00>{number = 23, name = (null)}
10:16:26.476658+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47447] test - <NSThread: 0x600002debbc0>{number = 22, name = (null)}
10:16:26.476660+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47442] test - <NSThread: 0x600002deba80>{number = 17, name = (null)}
10:16:26.476658+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[10797:47440] test - <NSThread: 0x600002deba00>{number = 15, name = (null)}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¸€å…±æ‰§è¡Œäº†4æ¬¡ï¼Œæ¯æ¬¡5æ¡çº¿ç¨‹ã€‚è¿™æ˜¯å› ä¸ºåˆå§‹åŒ– semaphore çš„æ¡ä»¶æ˜¯5ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ `dispatch_semaphore_wait` ä¼šå‡1ï¼Œå‡5æ¬¡ç­‰äº0åå°±ä¸åœ¨æ‰§è¡Œå…¶å®ƒçº¿ç¨‹äº†ã€‚æ¯è°ƒç”¨ä¸€æ¬¡ `dispatch_semaphore_signal` ä¼šåŠ 1ï¼Œå°±ä¼šæœ‰æ–°çš„çº¿ç¨‹å¼€å§‹è°ƒç”¨ `dispatch_semaphore_wait` å¯¹æ¡ä»¶å‡1ã€‚ 

### åº”ç”¨ - è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
```
@interface SemaphoreDemo()
@property (nonatomic, strong) dispatch_semaphore_t moneySemaphore;
@property (nonatomic, strong) dispatch_semaphore_t ticketSemaphore;
@end

@implementation SemaphoreDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.moneySemaphore = dispatch_semaphore_create(1);
        self.ticketSemaphore = dispatch_semaphore_create(1);
    }
    return self;
}

/// å–é’±
- (void)__drawMoney
{
    dispatch_semaphore_wait(self.moneySemaphore, DISPATCH_TIME_FOREVER);
    
    [super __drawMoney];
    
    dispatch_semaphore_signal(self.moneySemaphore);
}

/// å­˜é’±
- (void)__saveManey
{
    dispatch_semaphore_wait(self.moneySemaphore, DISPATCH_TIME_FOREVER);
    
    [super __saveManey];
    
    dispatch_semaphore_signal(self.moneySemaphore);
}

/// å–ç¥¨
- (void)__saleTicket
{
    dispatch_semaphore_wait(self.ticketSemaphore, DISPATCH_TIME_FOREVER);
    
    [super __saleTicket];
    
    dispatch_semaphore_signal(self.ticketSemaphore);
}
@end
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

### dispatch_semaphore æ±‡ç¼–åˆ†æ

æŸ¥çœ‹æ–¹å¼ä¸ â€œOSSpinLock æ±‡ç¼–åˆ†æâ€ ç›¸åŒã€‚å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 9 å¯¹ä¿¡å·é‡å‡1ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 11ï¼Œå› ä¸ºæ­¤æ—¶çš„ä¿¡å·é‡ç­‰äº0ï¼Œæ‰€ä»¥ Thread 15 å¤„äºç­‰å¾…ä¿¡å·é‡å˜æˆ >0 çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåˆ°ç¬¬16è¡Œæ—¶ä¼šè°ƒç”¨ `dispatch_semaphore_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹33](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹33.png)
æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `dispatch_semaphore_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹34](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹34.png)
æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `dispatch_semaphore_wait_slow` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹35](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹35.png)
é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåœ¨ç¬¬35è¡Œï¼Œè¿›å…¥ `_dispatch_sema4_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹36](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹36.png)
é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåœ¨ç¬¬8è¡Œï¼Œè°ƒç”¨ `semaphore_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹37](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹37.png)
æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `semaphore_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹38](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹38.png)
æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `semaphore_wait_trap` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹39](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹39.png)
é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåœ¨ç¬¬4è¡Œï¼Œè°ƒç”¨ `syscall` å‡½æ•°ã€‚`syscall` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåï¼ŒXCode å°±åˆå›åˆ°äº†OCä»£ç é¡µé¢ï¼Œçº¿ç¨‹å°±è¿›å…¥ä¼‘çœ çŠ¶æ€äº†ï¼ˆğŸ”äº’æ–¥é”æ ‡å¿—ï¼‰ï¼š
![å¤šçº¿ç¨‹40](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹40.png)

## dispatch_queue

ç›´æ¥ä½¿ç”¨ GCD çš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯å¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥çš„ã€‚å› ä¸ºçº¿ç¨‹åŒæ­¥çš„æœ¬è´¨å°±æ˜¯ä¿è¯å¤šæ¡çº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—å¯ä»¥é€šè¿‡æ§åˆ¶æ‰§è¡Œé¡ºåºæ¥å®ç°çº¿ç¨‹åŒæ­¥ã€‚

è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜ï¼š
```
@interface SerialQueueDemo()
@property (nonatomic, strong) dispatch_queue_t moneyQueue;
@property (nonatomic, strong) dispatch_queue_t ticketQueue;
@end

@implementation SerialQueueDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.moneyQueue = dispatch_queue_create("moneyQueue", nil);
        self.ticketQueue = dispatch_queue_create("ticketQueue", nil);
    }
    return self;
}

/// å–é’±
- (void)__drawMoney
{
    dispatch_sync(self.moneyQueue, ^{
       [super __drawMoney];
    });
}

/// å­˜é’±
- (void)__saveManey
{
    dispatch_sync(self.moneyQueue, ^{
       [super __saveManey];
    });
}

/// å–ç¥¨
- (void)__saleTicket
{
    dispatch_sync(self.ticketQueue, ^{
       [super __saleTicket];
    });
}
@end
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

## @synchronized
`@synchronized` æ˜¯å¯¹ mutex é€’å½’é”çš„å°è£…ï¼Œ`@synchronized(obj)` å†…éƒ¨ä¼šç”Ÿæˆ obj å¯¹åº”çš„é€’å½’é”ï¼Œç„¶åè¿›è¡ŒåŠ é”ã€è§£é”æ“ä½œã€‚æºç æŸ¥çœ‹ï¼š[objc4-781](https://opensource.apple.com/tarballs/objc4/) ä¸­çš„ objc-sync.mm æ–‡ä»¶ã€‚

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜

ä¸ºäº†è§£å†³ä¸åŒå¯¹è±¡è°ƒç”¨çš„é—®é¢˜ï¼Œå­˜é’±å–é’±çš„ `@synchronized()` ä¼ å…¥çš„æ˜¯ç±»å¯¹è±¡ `[self class]`ï¼Œå–ç¥¨ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ NSObject å¯¹è±¡ï¼š
```
@implementation SynchronizeDemo

///å–é’±
- (void)__drawMoney
{
    @synchronized ([self class]) {
        [super __drawMoney];
    }
}

///å­˜é’±
- (void)__saveManey
{
    @synchronized ([self class]) { /// æ–­ç‚¹1
        [super __saveManey];
    }
}

///å–ç¥¨
- (void)__saleTicket
{
    static NSObject *object;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        object = [[NSObject alloc] init];
    });
    @synchronized (object) {
        [super __saleTicket];
    }
}
@end
```

æ‰“å°ç»“æœåŒ OSSpinLockã€‚

### @synchronized å®ç°åŸç†

åœ¨æ–­ç‚¹1å¤„æŸ¥çœ‹æ±‡ç¼–ä»£ç  Debug -> Debug Workflow -> Always Show Disassemblyï¼š
![å¤šçº¿ç¨‹32](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹32.png)

å¯ä»¥çœ‹åˆ° `@synchronized()` åœ¨å¼€å§‹å’Œç»“æŸåˆ†åˆ«è°ƒç”¨äº† `objc_sync_enter()` å’Œ `objc_sync_exit()`ï¼Œå³ï¼š
```
///å­˜é’±
- (void)__saveManey
{
    @synchronized ([self class]) { /// objc_sync_enter()
        [super __saveManey];
    } /// objc_sync_exit()
}
```

æºç æŸ¥çœ‹ï¼š[objc4-781](https://opensource.apple.com/tarballs/objc4/) ä¸­çš„ objc-sync.mm æ–‡ä»¶
```
/// åŠ é”
int objc_sync_enter(id obj)
{
    int result = OBJC_SYNC_SUCCESS;

    if (obj) {
        SyncData* data = id2data(obj, ACQUIRE); /// ä»¥ obj ä¸ºkeyï¼Œè·å–åˆ°å¯¹åº”çš„ spinlock_t
        ASSERT(data);
        data->mutex.lock(); /// è°ƒç”¨ mutex ä¸Šé”
    } else {
        // @synchronized(nil) does nothing
        if (DebugNilSync) {
            _objc_inform("NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug");
        }
        objc_sync_nil();
    }

    return result;
}

/// å°è¯•åŠ é”
BOOL objc_sync_try_enter(id obj)
{
    BOOL result = YES;

    if (obj) {
        SyncData* data = id2data(obj, ACQUIRE);
        ASSERT(data);
        result = data->mutex.tryLock();
    } else {
        // @synchronized(nil) does nothing
        if (DebugNilSync) {
            _objc_inform("NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug");
        }
        objc_sync_nil();
    }

    return result;
}

/// è§£é”
int objc_sync_exit(id obj)
{
    int result = OBJC_SYNC_SUCCESS;
    
    if (obj) {
        SyncData* data = id2data(obj, RELEASE); 
        if (!data) {
            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;
        } else {
            bool okay = data->mutex.tryUnlock(); /// è°ƒç”¨ mutex è§£é”
            if (!okay) {
                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;
            }
        }
    } else {
        // @synchronized(nil) does nothing
    }

    return result;
}
```

`SyncData` å®ç°ï¼š
```
typedef struct alignas(CacheLineSize) SyncData {
    struct SyncData* nextData;
    DisguisedPtr<objc_object> object;
    int32_t threadCount;  // number of THREADS using this block
    recursive_mutex_t mutex; /// å¯¹ os_unfair_recursive_lock é”çš„å°è£…ğŸ‘‡
} SyncData;

#define LOCK_FOR_OBJ(obj) sDataLists[obj].lock
#define LIST_FOR_OBJ(obj) sDataLists[obj].data

static SyncData* id2data(id object, enum usage why)
{
    spinlock_t *lockp = &LOCK_FOR_OBJ(object);
    SyncData **listp = &LIST_FOR_OBJ(object);
    SyncData* result = NULL;

    ......
}
```

`recursive_mutex_tt` å®ç°ï¼š
```
class recursive_mutex_tt : nocopy_t {
    os_unfair_recursive_lock mLock;

  public:
    constexpr recursive_mutex_tt() : mLock(OS_UNFAIR_RECURSIVE_LOCK_INIT) { /// é™æ€åˆå§‹åŒ–æ–¹æ³•ï¼Œé€’å½’é”
        lockdebug_remember_recursive_mutex(this);
    }

    constexpr recursive_mutex_tt(const fork_unsafe_lock_t unsafe)
        : mLock(OS_UNFAIR_RECURSIVE_LOCK_INIT)
    { }

    void lock()
    {
        lockdebug_recursive_mutex_lock(this);
        os_unfair_recursive_lock_lock(&mLock);
    }

    void unlock()
    {
        lockdebug_recursive_mutex_unlock(this);

        os_unfair_recursive_lock_unlock(&mLock);
    }

    void forceReset()
    {
        lockdebug_recursive_mutex_unlock(this);

        bzero(&mLock, sizeof(mLock));
        mLock = os_unfair_recursive_lock OS_UNFAIR_RECURSIVE_LOCK_INIT;
    }

    bool tryLock()
    {
        if (os_unfair_recursive_lock_trylock(&mLock)) {
            lockdebug_recursive_mutex_lock(this);
            return true;
        }
        return false;
    }

    bool tryUnlock()
    {
        if (os_unfair_recursive_lock_tryunlock4objc(&mLock)) {
            lockdebug_recursive_mutex_unlock(this);
            return true;
        }
        return false;
    }

    void assertLocked() {
        lockdebug_recursive_mutex_assert_locked(this);
    }

    void assertUnlocked() {
        lockdebug_recursive_mutex_assert_unlocked(this);
    }
};
```

å› ä¸ºä»æºç ä¸­çœ‹åˆ°é”åœ¨åˆå§‹åŒ–æ—¶ä¼ å…¥çš„æ˜¯ OS_UNFAIR_RECURSIVE_LOCK_INITï¼Œæ‰€ä»¥ @synchronized å…¶å®å°±æ˜¯ä¸€ä¸ªé€’å½’é”ã€‚

éªŒè¯ï¼š
```
- (void)otherTest
{
    @synchronized (self) {
        NSLog(@"%s", __func__);
        [self otherTest];
    }
}
```

æ‰“å°ç»“æœï¼š
```
-[SynchronizeDemo otherTest]
-[SynchronizeDemo otherTest]
-[SynchronizeDemo otherTest]
-[SynchronizeDemo otherTest]
......
```

# iOSçº¿ç¨‹åŒæ­¥æ–¹æ¡ˆæ€§èƒ½æ¯”è¾ƒ

æ€§èƒ½ä»é«˜åˆ°ä½æ’åº
* os_unfair_lock
* OSSpinLock
* dispatch_semaphore
* pthread_mutex
* dispatch_queue(DISPATCH_QUEUE_SERIAL)
* NSLock
* NSCondition
* pthread_mutex(recursive)
* NSRecursiveLock
* NSConditionLock
* @synchronized

æ¨èä½¿ç”¨
* dispatch_semaphore
* pthread_mutex

## dispatch_semaphore
ä¸åŒæ–¹æ³•ä½¿ç”¨ dispatch_semaphore å®ç°çº¿ç¨‹åŒæ­¥ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½éœ€è¦ä¸€æŠŠå±äºè‡ªå·±çš„é”ï¼Œå¯ä»¥è¿™æ ·å®ç°ï¼š
```
/// åŠ é”
#define SemaphoreBegin \
static dispatch_semaphore_t semaphore; \
static dispatch_once_t onceToken; \
dispatch_once(&onceToken, ^{ \
    semaphore = dispatch_semaphore_create(1); \
}); \
dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);

/// è§£é”
#define SemaphoreEnd \
dispatch_semaphore_signal(semaphore);

@interface ViewController ()
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(test1) object:nil] start];
    sleep(2);
    [[[NSThread alloc] initWithTarget:self selector:@selector(test2) object:nil] start];
    sleep(2);
    [[[NSThread alloc] initWithTarget:self selector:@selector(test3) object:nil] start];
}

- (void)test1 {
    SemaphoreBegin
    
    NSLog(@"%s", __func__);
    
    SemaphoreEnd
}

- (void)test2 {
    SemaphoreBegin
    
    NSLog(@"%s", __func__);
    
    SemaphoreEnd
}

- (void)test3 {
    SemaphoreBegin
    
    NSLog(@"%s", __func__);
    
    SemaphoreEnd
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[ViewController test1]
-[ViewController test2]
-[ViewController test3]
```

## pthread_mutex
```
#define PthreadMutexBegain \
static pthread_mutex_t mutex; \
static dispatch_once_t onceToken; \
dispatch_once(&onceToken, ^{ \
    pthread_mutex_init(&mutex, NULL); \
}); \
pthread_mutex_lock(&mutex);

#define PthreadMutexEnd \
pthread_mutex_unlock(&mutex);

@interface ViewController ()
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    [[[NSThread alloc] initWithTarget:self selector:@selector(test1) object:nil] start];
    sleep(2);
    [[[NSThread alloc] initWithTarget:self selector:@selector(test2) object:nil] start];
    sleep(2);
    [[[NSThread alloc] initWithTarget:self selector:@selector(test3) object:nil] start];
}

- (void)test1 {
    PthreadMutexBegain
    
    NSLog(@"%s", __func__);
    
    PthreadMutexEnd
}

- (void)test2 {
    PthreadMutexBegain
    
    NSLog(@"%s", __func__);
    
    PthreadMutexEnd
}

- (void)test3 {
    PthreadMutexBegain
    
    NSLog(@"%s", __func__);
    
    PthreadMutexEnd
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[ViewController test1]
-[ViewController test2]
-[ViewController test3]
```

## è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ

* ä»€ä¹ˆæƒ…å†µä½¿ç”¨è‡ªæ—‹é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ  
é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´å¾ˆçŸ­ï¼›ï¼ˆçº¿ç¨‹1åŠ é”åå¤„ç†çš„äº‹æƒ…å¾ˆå°‘ï¼Œçº¿ç¨‹2ä¸éœ€è¦ç­‰å¤ªå¤šæ—¶é—´ï¼Œå°±æ²¡å¿…è¦å»ä¼‘çœ ï¼Œåªé€šè¿‡ä¸€ä¸ªwhileå¾ªç¯ç¨å¾®ç­‰ä¸€ä¸‹å°±å¥½ï¼‰  
åŠ é”çš„ä»£ç ï¼ˆä¸´ç•ŒåŒºï¼‰ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼›ï¼ˆå¯¹äºå¤šæ¡çº¿ç¨‹åŒæ—¶è°ƒç”¨ä¸´ç•ŒåŒºçš„æƒ…å†µå¾ˆå°‘ï¼Œè€Œä¸”ä¸´ç•ŒåŒºçš„è°ƒç”¨æ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è‡ªæ—‹é”æ•ˆç‡ä¼šæ›´é«˜ï¼‰  
CPUèµ„æºä¸ç´§å¼ ï¼›ï¼ˆè‡ªæ—‹é”çš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œç¼ºç‚¹æ˜¯ä¸€ç›´å ç”¨CPUèµ„æºï¼Œå¦‚æœCPUèµ„æºä¸ç´§å¼ ï¼Œæ¯”å¦‚å¤šæ ¸ï¼Œå°±å¯ä»¥å¿½ç•¥è‡ªæ—‹é”çš„ç¼ºç‚¹ï¼‰  
å¤šæ ¸å¤„ç†å™¨ï¼›

* ä»€ä¹ˆæƒ…å†µä½¿ç”¨äº’æ–¥é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ  
é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´è¾ƒé•¿ï¼›ï¼ˆçº¿ç¨‹1åŠ é”åå¤„ç†çš„äº‹æƒ…å¾ˆå¤šï¼Œæ¯”å¦‚éœ€è¦è€—æ—¶2~3ç§’ï¼Œæ­¤æ—¶è‡ªæ—‹é”æ•ˆç‡é«˜çš„ä¼˜ç‚¹ä¹Ÿæ²¡å•¥ç”¨äº†ï¼Œä¸å¦‚è®©çº¿ç¨‹2å»ä¼‘çœ ï¼Œè¿™æ ·ä¹Ÿå‡å°‘äº†CPUèµ„æºçš„å ç”¨ï¼‰  
å•æ ¸å¤„ç†å™¨ï¼›ï¼ˆè¿™ç§æƒ…å†µä»¥èŠ‚çœCPUèµ„æºä¸ºä¸»ï¼Œå°½é‡ä¸å»å ç”¨CPUèµ„æºï¼‰  
ä¸´ç•ŒåŒºæœ‰IOæ“ä½œï¼›ï¼ˆå› ä¸ºIOæ“ä½œæ˜¯æ¯”è¾ƒå ç”¨CPUèµ„æºçš„ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä»¥èŠ‚çœCPUèµ„æºä¸ºä¸»ï¼‰  
ä¸´ç•ŒåŒºä»£ç å¤æ‚æˆ–è€…å¾ªç¯é‡å¤§ï¼›ï¼ˆå› ä¸ºè¿™ç§æƒ…å†µæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥å¿½ç•¥æ•ˆç‡æ¯”è¾ƒé«˜çš„è‡ªæ—‹é”ï¼Œé€‰æ‹©èŠ‚çœCPUèµ„æºçš„äº’æ–¥é”ï¼‰  
ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆï¼›ï¼ˆå¾ˆå¤šçº¿ç¨‹ä¼šåŒäº‹è°ƒç”¨ä¸´ç•ŒåŒºçš„ä»£ç ï¼Œä¸ºäº†èŠ‚çœCPUèµ„æºï¼Œé€‰æ‹©äº’æ–¥é”ï¼‰

## atomic
atomï¼šåŸå­ï¼Œä¸å¯å†åˆ†å‰²çš„å•ä½ã€‚atomicï¼šåŸå­æ€§ï¼Œç”¨äºä¿è¯å±æ€§ setterã€getter çš„åŸå­æ€§æ“ä½œï¼Œç›¸å½“äºåœ¨ getter å’Œ setter å†…éƒ¨åŠ äº†çº¿ç¨‹åŒæ­¥çš„é”ã€‚

æ‰“å¼€æºç  [objc4-781](https://opensource.apple.com/tarballs/objc4/) çš„ objc-accessors.mm æ–‡ä»¶ï¼ŒæŸ¥çœ‹ setter å’Œ getter æ–¹æ³• çš„å®ç°ï¼š
```
/// setter æ–¹æ³•
static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy)
{
    if (offset == 0) {
        object_setClass(self, newValue);
        return;
    }

    id oldValue;
    id *slot = (id*) ((char*)self + offset);

    if (copy) {
        newValue = [newValue copyWithZone:nil];
    } else if (mutableCopy) {
        newValue = [newValue mutableCopyWithZone:nil];
    } else {
        if (*slot == newValue) return;
        newValue = objc_retain(newValue);
    }

    if (!atomic) {
        /// éåŸå­æ€§çš„ä¸åŠ é”
        oldValue = *slot;
        *slot = newValue;
    } else {
        /// åŸå­æ€§çš„è¦åŠ é”
        spinlock_t& slotlock = PropertyLocks[slot];
        slotlock.lock();
        oldValue = *slot;
        *slot = newValue;        
        slotlock.unlock();
    }

    objc_release(oldValue);
}

/// getter æ–¹æ³•
id objc_getProperty(id self, SEL _cmd, ptrdiff_t offset, BOOL atomic) {
    if (offset == 0) {
        return object_getClass(self);
    }

    id *slot = (id*) ((char*)self + offset);
    /// éåŸå­æ€§çš„ä¸åŠ é”
    if (!atomic) return *slot;
        
    /// åŸå­æ€§çš„è¦åŠ é”
    spinlock_t& slotlock = PropertyLocks[slot];
    slotlock.lock();
    id value = objc_retain(*slot);
    slotlock.unlock();
    
    return objc_autoreleaseReturnValue(value);
}
```

aotmic å¹¶ä¸èƒ½ä¿è¯ä½¿ç”¨å±æ€§çš„è¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š
```
@interface ViewController ()
@property (atomic, copy) NSMutableArray *data;
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];

    self.data = [NSMutableArray array];
    [[[NSThread alloc] initWithTarget:self selector:@selector(test1) object:nil] start];
    [[[NSThread alloc] initWithTarget:self selector:@selector(test2) object:nil] start];
    [[[NSThread alloc] initWithTarget:self selector:@selector(test3) object:nil] start];
}

- (void)test1 {
    [self.data addObject:@"test1"];
}

- (void)test2 {
    [self.data addObject:@"test2"];
}

- (void)test3 {
    [self.data addObject:@"test3"];
}
```

ä¸Šé¢è¿™æ®µä»£ç ä¸­ data æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥ `self.data` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ `addObject` ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œéœ€è¦å•ç‹¬åŠ é”ï¼š
```
- (void)test1 {
    /// åŠ é”
    [self.data addObject:@"test1"];
    /// è§£é”
}

- (void)test2 {
    /// åŠ é”
    [self.data addObject:@"test2"];
    /// è§£é”
}

- (void)test3 {
    /// åŠ é”
    [self.data addObject:@"test3"];
    /// è§£é”
}
```

# iOSä¸­çš„è¯»å†™å®‰å…¨æ–¹æ¡ˆ

* æ€è€ƒå¦‚ä½•å®ç°ä»¥ä¸‹åœºæ™¯  
  åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™çš„æ“ä½œï¼›  
  åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œï¼›  
  åŒä¸€æ—¶é—´ï¼Œä¸å…è®¸æ—¢æœ‰å†™çš„æ“ä½œï¼Œåˆæœ‰è¯»çš„æ“ä½œï¼›  

ä¸Šé¢çš„åœºæ™¯å°±æ˜¯å…¸å‹çš„â€œå¤šè¯»å•å†™â€ï¼Œç»å¸¸ç”¨äºæ–‡ä»¶ç­‰æ•°æ®çš„è¯»å†™æ“ä½œï¼ŒiOSä¸­çš„å®ç°æ–¹æ¡ˆæœ‰ pthread_rwlockï¼ˆè¯»å†™é”ï¼‰å’Œ dispatch_barrier_asyncï¼ˆå¼‚æ­¥æ …æ è°ƒç”¨ï¼‰ã€‚

## pthread_rwlock

### ç›¸å…³APIï¼š
```
/// åˆå§‹åŒ–
pthread_rwlock_t lock;
pthread_rwlock_init(&lock, NULL);
/// è¯»-åŠ é”
pthread_rwlock_rdlock(&lock);
/// è¯»-å°è¯•åŠ é”
pthread_rwlock_tryrdlock(&lock);
/// å†™-åŠ é”
pthread_rwlock_wrlock(&lock);
/// å†™-å°è¯•åŠ é”
pthread_rwlock_trywrlock(&lock);
/// è§£é”
pthread_rwlock_unlock(&lock);
/// é”€æ¯
pthread_rwlock_destroy(&lock);
```

 ### åº”ç”¨
 ```
@interface ViewController ()
@property (nonatomic, assign) pthread_rwlock_t lock;
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    /// åˆå§‹åŒ–
    pthread_rwlock_init(&_lock, NULL);
    
    for (int i=0; i < 5; i++) {
        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            [self read];
        });
        dispatch_async(dispatch_get_global_queue(0, 0), ^{
            [self write];
        });
    }
}

- (void)read
{
    pthread_rwlock_rdlock(&_lock);
    
    NSLog(@"%s", __func__);
    sleep(2);
    
    pthread_rwlock_unlock(&_lock);
}

- (void)write
{
    pthread_rwlock_wrlock(&_lock);
    
    NSLog(@"%s", __func__);
    sleep(2);
    
    pthread_rwlock_unlock(&_lock);
}

- (void)dealloc
{
    pthread_rwlock_destroy(&_lock);
}
@end
 ```

 æ‰“å°ç»“æœï¼š
 ```
10:57:24.915613+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66309] -[ViewController read]
10:57:24.915613+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66290] -[ViewController read]
10:57:26.918756+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66295] -[ViewController write]
10:57:28.921411+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66308] -[ViewController write]
10:57:30.924043+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66299] -[ViewController read]
10:57:32.927292+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66291] -[ViewController write]
10:57:34.927716+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66327] -[ViewController read]
10:57:36.930458+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66328] -[ViewController write]
10:57:38.934914+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66329] -[ViewController read]
10:57:40.940214+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3171:66330] -[ViewController write]
 ```

 ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œread å’Œ read æ“ä½œä¹‹é—´å­˜åœ¨åŒæ—¶è¢«æ‰“å°çš„æƒ…å†µï¼Œä½†æ˜¯ read å’Œ write æ“ä½œã€write å’Œ write æ“ä½œä¹‹é—´ä¸å­˜åœ¨åŒæ—¶è¢«æ‰“å°çš„æƒ…å†µã€‚

 ## dispatch_barrier_async

è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å¹¶å‘é˜Ÿåˆ—å¿…é¡»æ˜¯è‡ªå·±é€šè¿‡ dispatch_queue_cretate åˆ›å»ºçš„ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªä¸²è¡Œæˆ–æ˜¯ä¸€ä¸ªå…¨å±€çš„å¹¶å‘é˜Ÿåˆ—ï¼Œé‚£è¿™ä¸ªå‡½æ•°ä¾¿ç­‰åŒäº dispatch_async å‡½æ•°çš„æ•ˆæœã€‚

`dispatch_barrier_async` æ–¹æ³•èƒ½å¤Ÿä¿è¯å½“å‰åªæœ‰è¿™ä¸€ä¸ªä¸´ç•ŒåŒºåœ¨æ‰§è¡Œï¼Œå°±å¯ä»¥å®ç°åœ¨å†™çš„æ—¶å€™ï¼Œæ²¡æœ‰å…¶å®ƒå†™æ“ä½œå’Œè¯»æ“ä½œã€‚

 ### ç›¸å…³API
 ```
/// åˆå§‹åŒ–é˜Ÿåˆ—
dispatch_queue_t queue = dispatch_queue_create("rw_queue", DISPATCH_QUEUE_CONCURRENT);

/// è¯»
dispatch_async(queue, ^{
    
});

/// å†™
dispatch_barrier_async(queue, ^{
    
});
 ```

 ### åº”ç”¨
 ```
@interface ViewController ()
@property (nonatomic, strong) dispatch_queue_t queue;
@end

@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    self.queue = dispatch_queue_create("rw_queue", DISPATCH_QUEUE_CONCURRENT);
    for (int i=0; i<5; i++) {
        [self read];
        [self read];
        [self read];
        [self write];
        [self write];
        [self write];
    }
}

- (void)read
{
    dispatch_async(self.queue, ^{
        NSLog(@"read");
        sleep(2);
    });
}

- (void)write
{
    dispatch_barrier_async(self.queue, ^{
        NSLog(@"write");
        sleep(2);
    });
}
@end
 ```

 æ‰“å°ç»“æœï¼š
 ```
11:29:28.216697+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] read
11:29:28.216708+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:85991] read
11:29:28.216724+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:85989] read
11:29:30.218087+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
11:29:32.222250+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
11:29:34.226490+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
11:29:36.231180+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] read
11:29:36.231210+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:85983] read
11:29:36.231265+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86132] read
11:29:38.232286+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
11:29:40.232572+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
11:29:42.232894+0800 å¤šçº¿ç¨‹å®‰å…¨éšæ‚£[3903:86003] write
......
 ```

 ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œread æ“ä½œæ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œwrite æ“ä½œåªèƒ½ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œã€‚

# æ€»ç»“

## ä½ ç†è§£çš„å¤šçº¿ç¨‹ï¼Ÿ  
  é€šè¿‡å¤šçº¿ç¨‹å¯ä»¥å¤„ç†è€—æ—¶ä»»åŠ¡ï¼Œå‡å°‘ä¸»çº¿ç¨‹çš„å‹åŠ›ã€‚  
  é€šè¿‡å¤šçº¿ç¨‹å¯ä»¥å¤„ç†ä¸€ä¸ªå¤æ‚ä»»åŠ¡çš„ä¸åŒéƒ¨åˆ†ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºï¼Œæå‡æ•ˆç‡ã€‚

## iOSçš„å¤šçº¿ç¨‹æ–¹æ¡ˆæœ‰å“ªå‡ ç§ï¼Ÿä½ æ›´å€¾å‘äºå“ªä¸€ç§ï¼Ÿ  

### æ€§èƒ½ä»é«˜åˆ°ä½æ’åº
os_unfair_lock  
OSSpinLock  
dispatch_semaphore  
pthread_mutex  
dispatch_queue(DISPATCH_QUEUE_SERIAL)  
NSLock  
NSCondition  
pthread_mutex(recursive)  
NSRecursiveLock  
NSConditionLock  
@synchronized

### æ¨èä½¿ç”¨  
dispatch_semaphore  
pthread_mutex

## ä½ åœ¨é¡¹ç›®ä¸­ç”¨è¿‡ GCD å—ï¼Ÿ  
### å›åˆ°ä¸»çº¿ç¨‹
```
- (void)action
{
    if (![NSThread isMainThread]) {
        dispatch_async(dispatch_get_main_queue(), ^{
            [self action];
            return;
        });
    }
}
```

### ç­‰æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚ç»“æŸåï¼Œå†åˆ·æ–°UI
```
dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
dispatch_queue_t queue = dispatch_queue_create("myRequestQueue", NULL);
dispatch_async(queue, ^{
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER); /// å‡1
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER); /// å‡1
    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER); /// å‡1
    /// è¯·æ±‚å…¨éƒ¨å®Œæˆ
    dispatch_async(dispatch_get_main_queue(), ^{
        /// å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UI
    });
});

/// ç½‘ç»œè¯·æ±‚1
[self.server request1Completion:^(id responseObject) {
    if (semaphore) dispatch_semaphore_signal(semaphore); /// åŠ 1
}];

/// ç½‘ç»œè¯·æ±‚2
[self.server request2Completion:^(id responseObject) {
    if (semaphore) dispatch_semaphore_signal(semaphore); /// åŠ 1
}];

/// ç½‘ç»œè¯·æ±‚3
[self.server request3Completion:^(id responseObject) {
    if (semaphore) dispatch_semaphore_signal(semaphore); /// åŠ 1
}];
```

### å»¶æ—¶æ‰§è¡Œ
```
/// å»¶æ—¶5ç§’æ‰§è¡Œ
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    /// å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œ 
});
```

### å®šæ—¶å™¨
```
@interface ViewController ()
@property (nonatomic, strong) dispatch_source_t timer;
@end

@implementation ViewController

- (void)startTimer {

    __weak typeof(self) weakSelf = self;
    /// åˆå§‹åŒ–
    _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0));
    /// 5ç§’åå¼€å§‹æ‰§è¡Œ
    dispatch_time_t delayTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5.0 * NSEC_PER_SEC));
    /// 5ç§’æ‰§è¡Œä¸€æ¬¡
    dispatch_source_set_timer(_timer, delayTime, 5.0 * NSEC_PER_SEC, 0 * NSEC_PER_SEC);
    dispatch_source_set_event_handler(_timer, ^{
        dispatch_async(dispatch_get_main_queue(), ^{
            [weakSelf cancelTimer];
        });
    });
    dispatch_resume(_timer);
}

- (void)cancelTimer {
    if (_timer) {
        dispatch_source_cancel(_timer);
        _timer = nil;
    }
}
@end
```

## GCD çš„é˜Ÿåˆ—ç±»å‹
GCDçš„é˜Ÿåˆ—å¯ä»¥åˆ†ä¸º2å¤§ç±»å‹
* å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰  
å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼ˆè‡ªåŠ¨å¼€å¯å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼‰ï¼›  
å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥ï¼ˆdispatch_asyncï¼‰å‡½æ•°ä¸‹æ‰æœ‰æ•ˆï¼›

* ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰  
è®©ä»»åŠ¡ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°æ‰§è¡Œï¼ˆä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰ï¼›

ä¸»é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œasync æ–¹æ³•åœ¨ä¸»é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶ä¸”æ˜¯ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ã€‚

## è¯´ä¸€ä¸‹ OperationQueue å’Œ GCD çš„åŒºåˆ«ï¼Œä»¥åŠå„è‡ªçš„ä¼˜åŠ¿
OperationQueue æ˜¯å¯¹ GCD çš„å°è£…ï¼Œæ›´åŠ é¢å‘å¯¹è±¡ã€‚  
GCD ç›¸å¯¹äº OperationQueue æ›´åŠ åº•å±‚ï¼Œæ•ˆç‡æ›´é«˜ã€‚

## çº¿ç¨‹å®‰å…¨çš„å¤„ç†æ‰‹æ®µæœ‰å“ªäº›ï¼Ÿ
çº¿ç¨‹å®‰å…¨çš„å¤„ç†æ˜¯ä½¿ç”¨çº¿ç¨‹åŒæ­¥æŠ€æœ¯ï¼ŒåŒ…æ‹¬åŠ é”ã€ä¿¡å·é‡å’Œä¸²è¡Œé˜Ÿåˆ—ã€‚

## OCä½ äº†è§£çš„é”æœ‰å“ªäº›ï¼Ÿåœ¨ä½ å›ç­”åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡æé—®ï¼›  

æ€§èƒ½ä»é«˜åˆ°ä½æ’åºï¼š  
os_unfair_lock  
OSSpinLock  
dispatch_semaphore  
pthread_mutex   
NSLock  
NSCondition  
pthread_mutex(recursive)  
NSRecursiveLock  
NSConditionLock  
@synchronized

### è¿½é—®ä¸€ï¼šè‡ªæ—‹å’Œäº’æ–¥å¯¹æ¯”ï¼Ÿ
* ä»€ä¹ˆæƒ…å†µä½¿ç”¨è‡ªæ—‹é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ  
é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´å¾ˆçŸ­ï¼›ï¼ˆçº¿ç¨‹1åŠ é”åå¤„ç†çš„äº‹æƒ…å¾ˆå°‘ï¼Œçº¿ç¨‹2ä¸éœ€è¦ç­‰å¤ªå¤šæ—¶é—´ï¼Œå°±æ²¡å¿…è¦å»ä¼‘çœ ï¼Œåªé€šè¿‡ä¸€ä¸ªwhileå¾ªç¯ç¨å¾®ç­‰ä¸€ä¸‹å°±å¥½ï¼‰  
åŠ é”çš„ä»£ç ï¼ˆä¸´ç•ŒåŒºï¼‰ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼›ï¼ˆå¯¹äºå¤šæ¡çº¿ç¨‹åŒæ—¶è°ƒç”¨ä¸´ç•ŒåŒºçš„æƒ…å†µå¾ˆå°‘ï¼Œè€Œä¸”ä¸´ç•ŒåŒºçš„è°ƒç”¨æ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è‡ªæ—‹é”æ•ˆç‡ä¼šæ›´é«˜ï¼‰  
CPUèµ„æºä¸ç´§å¼ ï¼›ï¼ˆè‡ªæ—‹é”çš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œç¼ºç‚¹æ˜¯ä¸€ç›´å ç”¨CPUèµ„æºï¼Œå¦‚æœCPUèµ„æºä¸ç´§å¼ ï¼Œæ¯”å¦‚å¤šæ ¸ï¼Œå°±å¯ä»¥å¿½ç•¥è‡ªæ—‹é”çš„ç¼ºç‚¹ï¼‰  
å¤šæ ¸å¤„ç†å™¨ï¼›

* ä»€ä¹ˆæƒ…å†µä½¿ç”¨äº’æ–¥é”æ¯”è¾ƒåˆ’ç®—ï¼Ÿ  
é¢„è®¡çº¿ç¨‹ç­‰å¾…é”çš„æ—¶é—´è¾ƒé•¿ï¼›ï¼ˆçº¿ç¨‹1åŠ é”åå¤„ç†çš„äº‹æƒ…å¾ˆå¤šï¼Œæ¯”å¦‚éœ€è¦è€—æ—¶2~3ç§’ï¼Œæ­¤æ—¶è‡ªæ—‹é”æ•ˆç‡é«˜çš„ä¼˜ç‚¹ä¹Ÿæ²¡å•¥ç”¨äº†ï¼Œä¸å¦‚è®©çº¿ç¨‹2å»ä¼‘çœ ï¼Œè¿™æ ·ä¹Ÿå‡å°‘äº†CPUèµ„æºçš„å ç”¨ï¼‰  
å•æ ¸å¤„ç†å™¨ï¼›ï¼ˆè¿™ç§æƒ…å†µä»¥èŠ‚çœCPUèµ„æºä¸ºä¸»ï¼Œå°½é‡ä¸å»å ç”¨CPUèµ„æºï¼‰  
ä¸´ç•ŒåŒºæœ‰IOæ“ä½œï¼›ï¼ˆå› ä¸ºIOæ“ä½œæ˜¯æ¯”è¾ƒå ç”¨CPUèµ„æºçš„ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä»¥èŠ‚çœCPUèµ„æºä¸ºä¸»ï¼‰  
ä¸´ç•ŒåŒºä»£ç å¤æ‚æˆ–è€…å¾ªç¯é‡å¤§ï¼›ï¼ˆå› ä¸ºè¿™ç§æƒ…å†µæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥å¿½ç•¥æ•ˆç‡æ¯”è¾ƒé«˜çš„è‡ªæ—‹é”ï¼Œé€‰æ‹©èŠ‚çœCPUèµ„æºçš„äº’æ–¥é”ï¼‰  
ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆï¼›ï¼ˆå¾ˆå¤šçº¿ç¨‹ä¼šåŒäº‹è°ƒç”¨ä¸´ç•ŒåŒºçš„ä»£ç ï¼Œä¸ºäº†èŠ‚çœCPUèµ„æºï¼Œé€‰æ‹©äº’æ–¥é”ï¼‰

### è¿½é—®äºŒï¼šä½¿ç”¨ä»¥ä¸Šé”éœ€è¦æ³¨æ„å“ªäº›ï¼Ÿ  
åŠ é”åä¸€å®šè¦è§£é”ï¼›  

### è¿½é—®ä¸‰ï¼šç”¨C/OC/C++ï¼Œä»»é€‰å…¶ä¸€ï¼Œå®ç°è‡ªæ—‹æˆ–äº’æ–¥ï¼Ÿ
å‚è€ƒä¸Šé¢çš„å†…å®¹ã€‚

## è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
    });
}

- (void)test
{
    NSLog(@"2");
}
@end
```

ä¸Šé¢æœ‰è¯¦è§£ğŸ‘†ã€‚

## è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)test
{
    NSLog(@"2");
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSThread *thread = [[NSThread alloc] initWithBlock:^{
        NSLog(@"1");
    }];
    [thread start];
    
    [self performSelector:@selector(test) onThread:thread withObject:nil waitUntilDone:YES];
}
@end
```

ä¸Šé¢æœ‰è¯¦è§£ğŸ‘†ã€‚