---
title: å¤šçº¿ç¨‹
date: 2020-07-14 16:31:01
tags: OCåº•å±‚åŸç†
---

æ€è€ƒï¼š
* ä½ ç†è§£çš„å¤šçº¿ç¨‹ï¼Ÿ
* iOSçš„å¤šçº¿ç¨‹æ–¹æ¡ˆæœ‰å“ªå‡ ç§ï¼Ÿä½ æ›´å€¾å‘äºå“ªä¸€ç§ï¼Ÿ
* ä½ åœ¨é¡¹ç›®ä¸­ç”¨è¿‡ GCD å—ï¼Ÿ
* GCD çš„é˜Ÿåˆ—ç±»å‹
* è¯´ä¸€ä¸‹ OperationQueue å’Œ GCD çš„åŒºåˆ«ï¼Œä»¥åŠå„è‡ªçš„ä¼˜åŠ¿
* çº¿ç¨‹å®‰å…¨çš„å¤„ç†æ‰‹æ®µæœ‰å“ªäº›ï¼Ÿ
* OCä½ äº†è§£çš„é”æœ‰å“ªäº›ï¼Ÿåœ¨ä½ å›ç­”åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡æé—®ï¼›  
è¿½é—®ä¸€ï¼šè‡ªæ—‹å’Œäº’æ–¥å¯¹æ¯”ï¼Ÿ  
è¿½é—®äºŒï¼šä½¿ç”¨ä»¥ä¸Šé”éœ€è¦æ³¨æ„å“ªäº›ï¼Ÿ  
è¿½é—®ä¸‰ï¼šç”¨C/OC/C++ï¼Œä»»é€‰å…¶ä¸€ï¼Œå®ç°è‡ªæ—‹æˆ–äº’æ–¥ï¼Ÿ
<!-- more -->
* è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)viewDidLoad {
    [super viewDidLoad];
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
    });
}

- (void)test
{
    NSLog(@"2");
}
@end
```

* è¯·é—®ä¸‹é¢ä»£ç çš„æ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
```
@implementation ViewController
- (void)test
{
    NSLog(@"2");
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSThread *thread = [[NSThread alloc] initWithBlock:^{
        NSLog(@"1");
    }];
    [thread start];
    
    [self performSelector:@selector(test) onThread:thread withObject:nil waitUntilDone:YES];
}
@end
```

# GCD

ğŸ‘‰ [GCDæºç ](https://github.com/apple/swift-corelibs-libdispatch)

## iOSä¸­çš„å¸¸è§å¤šçº¿ç¨‹æ–¹æ¡ˆ

<!-- <style>
table th:nth-of-type(1){
    width: 20%;
}
table th:nth-of-type(2){
    width: 25%;
}
table th:nth-of-type(3){
    width: 20%;
}
table th:nth-of-type(4){
    width: 20%;
}
table th:nth-of-type(5){
    width: 15%;
}
</style> -->

| æŠ€æœ¯æ–¹æ¡ˆ | ç®€ä»‹ | è¯­è¨€ | çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ | ä½¿ç”¨é¢‘ç‡ |
| :--: | :-------- | :--: | :--: | :--: |
| phread | 1.ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹APIï¼›<br>2.é€‚ç”¨äºUnix\Linux\Windowsç­‰ç³»ç»Ÿï¼›<br>3.è·¨å¹³å°\å¯ç§»æ¤ï¼›<br>4.ä½¿ç”¨éš¾åº¦å¤§ï¼›| C | å¼€å‘è€…ç®¡ç† | å‡ ä¹ä¸ç”¨ |
| NSThread | 1.ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ï¼›<br>2.ç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ï¼› | OC | å¼€å‘è€…ç®¡ç† | å¶å°”ä½¿ç”¨ |
| GCD | 1.æ—¨åœ¨æ›¿ä»£NSThreadç­‰å¤šçº¿ç¨‹æŠ€æœ¯ï¼› | C | è‡ªåŠ¨ç®¡ç† | ç»å¸¸ä½¿ç”¨ |
| NSOperation | 1.åŸºäºGCDï¼ˆåº•å±‚æ˜¯GCDï¼‰ï¼›<br>2.æ¯”GCDå¤šäº†ä¸€äº›æ›´ç®€å•ä½¿ç”¨çš„åŠŸèƒ½ï¼›<br>3.ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ï¼› | OC | è‡ªåŠ¨ç®¡ç† | ç»å¸¸ä½¿ç”¨ |

phread åœ¨å®é™…å¼€å‘ä¸­å‡ ä¹ä¸ä¼šç”¨åˆ°ï¼Œä¸€èˆ¬åªä¼šåœ¨åŠ é”è§£é”çš„åœ°æ–¹ç”¨åˆ°ã€‚å¦å¤–ï¼ŒNSTheadã€GCD å’Œ NSOperation åº•å±‚éƒ½ä¼šç”¨åˆ° phreadï¼Œæ¯”å¦‚åˆ›å»ºçº¿ç¨‹ç­‰ã€‚NSThread å°±æ˜¯å¯¹ phread çš„åŒ…è£…ã€‚

## GCDçš„å¸¸ç”¨å‡½æ•°

GCD ä¸­æœ‰2ä¸ªç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„å‡½æ•°ï¼š
* ç”¨åŒæ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡ï¼ˆqueueï¼šé˜Ÿåˆ—ï¼›blockï¼šä»»åŠ¡ï¼‰  
```
dispatch_sync(dispatch_queue_t queue, dispatch_block_t block);
```

* ç”¨å¼‚æ­¥çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡  
```
dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
```

é˜Ÿåˆ—ç›¸å…³å‡½æ•°ï¼š
* è·å–ä¸»é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_get_main_queue();
```

* è·å–å…¨å±€å¹¶å‘é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
```

* æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_CONCURRENT);
```

* æ‰‹åŠ¨åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—
```
dispatch_queue_t queue = dispatch_queue_create("mySerialQueue", DISPATCH_QUEUE_SERIAL);
```

* æ‰‹åŠ¨åˆ›å»ºé˜Ÿåˆ—ç»„
```
dispatch_group_t group = dispatch_group_create();
```

## GCDçš„é˜Ÿåˆ—

GCDçš„é˜Ÿåˆ—å¯ä»¥åˆ†ä¸º2å¤§ç±»å‹
* å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰  
å¯ä»¥è®©å¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼ˆè‡ªåŠ¨å¼€å¯å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼‰ï¼›  
å¹¶å‘åŠŸèƒ½åªæœ‰åœ¨å¼‚æ­¥ï¼ˆdispatch_asyncï¼‰å‡½æ•°ä¸‹æ‰æœ‰æ•ˆï¼›

* ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰  
è®©ä»»åŠ¡ä¸€ä¸ªæ¥ç€ä¸€ä¸ªåœ°æ‰§è¡Œï¼ˆä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼‰ï¼›

## å®¹æ˜“æ··æ·†çš„æœ¯è¯­

æœ‰4ä¸ªæœ¯è¯­æ¯”è¾ƒå®¹æ˜“æ··æ·†ï¼šåŒæ­¥ã€å¼‚æ­¥ã€å¹¶å‘ã€ä¸²è¡Œ
* åŒæ­¥å’Œå¼‚æ­¥ä¸»è¦å½±å“ï¼šèƒ½ä¸èƒ½å¼€å¯æ–°çš„çº¿ç¨‹  
åŒæ­¥ï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼›  
å¼‚æ­¥ï¼šåœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼›

* å¹¶å‘å’Œä¸²è¡Œä¸»è¦å½±å“ï¼šä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼  
å¹¶å‘ï¼šå¤šä¸ªä»»åŠ¡å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼›  
ä¸²è¡Œï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼›

## å„ç§é˜Ÿåˆ—çš„æ‰§è¡Œæ•ˆæœ

| &nbsp; | å¹¶å‘é˜Ÿåˆ— | æ‰‹åŠ¨ç©¿ä»¶çš„ä¸²è¡Œé˜Ÿåˆ— | ä¸»é˜Ÿåˆ— |
| :--: | :--: | :--: | :--: |
| åŒæ­¥ï¼ˆsyncï¼‰ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ |
| å¼‚æ­¥ï¼ˆasyncï¼‰ | æœ‰å¼€å¯æ–°çº¿ç¨‹<br>å¹¶å‘æ‰§è¡Œä»»åŠ¡ | æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ | æ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹<br>ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ |

ä½¿ç”¨syncå‡½æ•°å¾€å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¼šå¡ä½å½“å‰çš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆäº§ç”Ÿæ­»é”ï¼‰ã€‚

ä¸»é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œasync æ–¹æ³•åœ¨ä¸»é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶ä¸”æ˜¯ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ã€‚

### å¹¶å‘é˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    ///å…¨å±€å¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    ///ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    ///ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });

    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    ///ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600003595140>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600003595140>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000035c1ec0>{number = 3, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600003588f00>{number = 4, name = (null)}
ä»»åŠ¡5 - <NSThread: 0x600000434d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šå¹¶å‘ï¼Œåˆ›å»ºæ–°çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹03](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹03.png)

### å¹¶å‘é˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    ///å…¨å±€å¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    ///ä»»åŠ¡2
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    ///ä»»åŠ¡3
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    ///ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600002fa4d80>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹04](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹04.png)

### ä¸²è¡Œé˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    ///æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_SERIAL);
    ///ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    ///ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    ///ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x6000004dc740>{number = 5, name = (null)}
ä»»åŠ¡5 - <NSThread: 0x6000004b0d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œåˆ›å»ºæ–°çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹05](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹05.png)

### ä¸²è¡Œé˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    ///æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_SERIAL);
    ///ä»»åŠ¡2
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    ///ä»»åŠ¡3
    dispatch_sync(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    ///ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600001438d40>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600001438d40>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600001438d40>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹06](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹06.png)

### ä¸»é˜Ÿåˆ— & å¼‚æ­¥æ‰§è¡Œï¼ˆasyncï¼‰
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSLog(@"ä»»åŠ¡1 - %@", [NSThread currentThread]);
    
    ///æ‰‹åŠ¨åˆ›å»ºå¹¶å‘é˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_main_queue();
    ///ä»»åŠ¡2
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@", [NSThread currentThread]);
        }
    });
    ///ä»»åŠ¡3
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            NSLog(@"æ‰§è¡Œä»»åŠ¡3 - %@", [NSThread currentThread]);
        }
    });
    
    NSLog(@"ä»»åŠ¡4 - %@", [NSThread currentThread]);
    ///ä¸»çº¿ç¨‹ç¡1ç§’
    sleep(1);
    NSLog(@"ä»»åŠ¡5 - %@", [NSThread currentThread]);
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡1 - <NSThread: 0x600002408d80>{number = 1, name = main}
ä»»åŠ¡4 - <NSThread: 0x600002408d80>{number = 1, name = main}
ä»»åŠ¡5 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
æ‰§è¡Œä»»åŠ¡3 - <NSThread: 0x600002408d80>{number = 1, name = main}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ‰§è¡Œæ–¹å¼ä¸ºï¼šä¸²è¡Œï¼Œä¸»çº¿ç¨‹ã€‚
![å¤šçº¿ç¨‹07](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹07.png)

### ä¸»é˜Ÿåˆ— & åŒæ­¥æ‰§è¡Œï¼ˆsyncï¼‰-> æ­»é”

æ­»é”ä¸€ï¼šä½¿ç”¨syncå‡½æ•°å¾€å½“å‰ä¸²è¡Œé˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ï¼Œä¼šå¡ä½å½“å‰çš„ä¸²è¡Œé˜Ÿåˆ—ï¼ˆäº§ç”Ÿæ­»é”ï¼‰ï¼š
![å¤šçº¿ç¨‹01](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹01.png)

é—®é¢˜åˆ†æï¼š
![å¤šçº¿ç¨‹02](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹02.png)

`sync` å‡½æ•°åœ¨è¿™é‡Œçš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯æ·»åŠ ä»»åŠ¡2ï¼Œç¬¬äºŒä¸ªæ˜¯æ‰§è¡Œä»»åŠ¡2ã€‚å› ä¸ºä¸»é˜Ÿåˆ—æ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥éµå¾ªå…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼Œåªæœ‰åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡ `viewDidLoad` æ‰§è¡Œå®Œæˆåæ‰èƒ½æ‰§è¡Œä»»åŠ¡2ã€‚ä½†æ˜¯ç¬¬ä¸€ä¸ªä»»åŠ¡ `viewDidLoad` è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œ `sync` å‡½æ•°ï¼Œè€Œ `sync` å‡½æ•°è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œä»»åŠ¡2ï¼Œè€Œä»»åŠ¡2è¦æƒ³æ‰§è¡Œå®Œå°±å¿…é¡»æ‰§è¡Œå®Œ `viewDidLoad` ... ... äº§ç”Ÿæ­»é”ã€‚

æ­»é”äºŒï¼š
![å¤šçº¿ç¨‹08](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹08.png)

é—®é¢˜åˆ†æï¼š
![å¤šçº¿ç¨‹09](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹09.png)

## performSelector:withObject:afterDelay:

åœ¨å­çº¿ç¨‹é‡Œè°ƒç”¨ `performSelector:withObject:afterDelay:` æ–¹æ³•ï¼š
```
- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
    });
}
```

æ‰“å°ç»“æœï¼š
```
1
3
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•å¹¶æ²¡æœ‰èµ·ä½œç”¨ã€‚è¿™æ˜¯å› ä¸º `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨ä½¿ç”¨äº† timerï¼Œè€Œå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰ RunLoopï¼Œæ‰€ä»¥ `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨çš„ TImer æ— æ³•è°ƒç”¨ã€‚

è§£å†³æ–¹æ¡ˆ ğŸ‘‰ æ‰‹åŠ¨æ·»åŠ  RunLoopï¼š
```
- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    dispatch_async(queue, ^{
        NSLog(@"1");
        [self performSelector:@selector(test) withObject:nil afterDelay:.0];
        NSLog(@"3");
        
        [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];
    });
}
```

æ‰“å°ç»“æœï¼š
```
1
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600001ad0cc0>{number = 6, name = (null)} - (null)
3
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•å¯ä»¥æ­£å¸¸è°ƒç”¨äº†ã€‚è¿™æ˜¯å› ä¸ºæ‰‹åŠ¨ä¸ºå­çº¿ç¨‹æ·»åŠ äº† RunLoopï¼Œæ‰€ä»¥ `performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨çš„ timer å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚

çŒœæƒ³ï¼š`performSelector:withObject:afterDelay:` æ–¹æ³•çš„æœ¬è´¨æ˜¯å¾€ RunLoop ä¸­æ·»åŠ å®šæ—¶å™¨ï¼š
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) {
        switch (activity) {
            case kCFRunLoopEntry:
                NSLog(@"kCFRunLoopEntry");
                break;
            case kCFRunLoopBeforeTimers:
                NSLog(@"kCFRunLoopBeforeTimers");
                break;
            case kCFRunLoopBeforeSources:
                NSLog(@"kCFRunLoopBeforeSources");
                break;
            case kCFRunLoopBeforeWaiting:
                NSLog(@"kCFRunLoopBeforeWaiting");
                break;
            case kCFRunLoopAfterWaiting:
                NSLog(@"kCFRunLoopAfterWaiting");
                break;
            case kCFRunLoopExit:
                NSLog(@"kCFRunLoopExit");
                break;
            default:
                break;
        }
    });
    CFRunLoopAddObserver(CFRunLoopGetCurrent(), observer, kCFRunLoopCommonModes);
    CFRelease(observer);
}

- (void)test
{
    NSLog(@"æ‰§è¡Œä»»åŠ¡2 - %@ - %@", [NSThread currentThread], [NSOperationQueue currentQueue]);
}

- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event
{
    NSLog(@"1");
    [self performSelector:@selector(test) withObject:nil afterDelay:.0];
    NSLog(@"3");
}
```

æ‰“å°ç»“æœï¼š
```
kCFRunLoopAfterWaiting
kCFRunLoopBeforeTimers
kCFRunLoopBeforeSources
1
3
kCFRunLoopBeforeTimers
kCFRunLoopBeforeSources
æ‰§è¡Œä»»åŠ¡2 - <NSThread: 0x600000b5cd40>{number = 1, name = main} - <NSOperationQueue: 0x7fb3f0006020>{name = 'NSOperationQueue Main Queue'}
... ...
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œ`performSelector:withObject:afterDelay:` æ–¹æ³•çš„è°ƒç”¨æ˜¯ä¸€ä¸ª timers äº‹ä»¶ï¼šRunLoop å…ˆå¤„ç†äº† Sources0 äº‹ä»¶ï¼Œå†å¤„ç†çš„ Timersã€‚

### GNUstep

GNUstep æ˜¯ GNU è®¡åˆ’çš„é¡¹ç›®ä¹‹ä¸€ï¼Œå®ƒå°† Cocoa çš„ OC åº“é‡æ–°å¼€æºå®ç°äº†ä¸€éã€‚è™½ç„¶ GNUstep ä¸æ˜¯è‹¹æœå®˜æ–¹æºç ï¼Œä½†è¿˜æ˜¯å…·æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ã€‚ğŸ‘‰ [æºç åœ°å€](http://www.gnustep.org/resources/downloads.php)

æ‰¾åˆ° NSRunLoop.m æ–‡ä»¶æŸ¥çœ‹ `performSelector:withObject:afterDelay:` æ–¹æ³•æºç ï¼š
```
- (void) performSelector: (SEL)aSelector
	      withObject: (id)argument
	      afterDelay: (NSTimeInterval)seconds
{
  NSRunLoop		*loop = [NSRunLoop currentRunLoop];
  GSTimedPerformer	*item;

  //æ ¹æ®ä¼ å…¥å‚æ•°ç”Ÿæˆä¸€ä¸ª GSTimedPerformer å¯¹è±¡ï¼ˆå†…å« NSTimer å®šæ—¶å™¨ï¼‰ï¼Œä½œä¸º Timers äº‹ä»¶æ·»åŠ åˆ° RunLoop ä¸­ã€‚
  item = [[GSTimedPerformer alloc] initWithSelector: aSelector
					     target: self
					   argument: argument
					      delay: seconds];
  [[loop _timedPerformers] addObject: item];
  RELEASE(item);
  [loop addTimer: item->timer forMode: NSDefaultRunLoopMode];
}
```

é€šè¿‡æºç å¯ä»¥å¾—å‡ºç»“è®ºï¼š`performSelector:withObject:afterDelay:` æ–¹æ³•å†…éƒ¨æ ¹æ®ä¼ å…¥å‚æ•°ç”Ÿæˆä¸€ä¸ª GSTimedPerformer å¯¹è±¡ï¼ˆå†…å« NSTimer å®šæ—¶å™¨ï¼‰ï¼Œä½œä¸º Timers äº‹ä»¶æ·»åŠ åˆ° RunLoop ä¸­ã€‚

### performSelector:withObject:

`performSelector:withObject:` æ–¹æ³•è·Ÿ `performSelector:withObject:afterDelay:` æ–¹æ³•çš„å®ç°åŸç†ä¸åŒï¼Œ`performSelector:withObject:afterDelay:` æ˜¯å®šä¹‰åœ¨ RunLoop.h æ–‡ä»¶é‡Œçš„ APIï¼Œå†…éƒ¨å®ç°çš„æœ¬è´¨æ˜¯å¾€ RunLoop ä¸­æ·»åŠ å®šæ—¶å™¨ã€‚è€Œ `performSelector:withObject:` æ–¹æ³•çš„æœ¬è´¨æ˜¯è°ƒç”¨ objc_msgSend() æ–¹æ³•ã€‚å¯ä»¥åœ¨ runtime æºç  [objc4-781](https://opensource.apple.com/tarballs/objc4/) é‡Œçœ‹åˆ°å…·ä½“å®ç°ï¼Œæ‰¾åˆ° NSObjec.m æ–‡ä»¶ï¼š
```
- (id)performSelector:(SEL)sel withObject:(id)obj {
    if (!sel) [self doesNotRecognizeSelector:sel];
    return ((id(*)(id, SEL, id))objc_msgSend)(self, sel, obj);
}
```

## é˜Ÿåˆ—ç»„çš„ä½¿ç”¨

å¼‚æ­¥å¹¶å‘æ‰§è¡Œä»»åŠ¡1ã€ä»»åŠ¡2ï¼Œåœ¨ä»»åŠ¡1ã€ä»»åŠ¡2éƒ½æ‰§è¡Œå®Œæ¯•åï¼Œå†å›åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡3ï¼š
```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    dispatch_group_t group = dispatch_group_create();
    dispatch_queue_t queue = dispatch_queue_create("myQueue", DISPATCH_QUEUE_CONCURRENT);
    dispatch_group_async(group, queue, ^{
        sleep(1);
        NSLog(@"ä»»åŠ¡1");
    });
    dispatch_group_async(group, queue, ^{
        NSLog(@"ä»»åŠ¡2");
    });
    dispatch_group_notify(group, dispatch_get_main_queue(), ^{
        NSLog(@"ä»»åŠ¡3");
    });
}
```

æ‰“å°ç»“æœï¼š
```
ä»»åŠ¡2
ä»»åŠ¡1
ä»»åŠ¡3
```

ä»»åŠ¡3ä¼šç­‰åˆ°ä»»åŠ¡1å’Œä»»åŠ¡2éƒ½æ‰§è¡Œå®Œæˆä¹‹åå†æ‰§è¡Œã€‚

# GCDæºç åˆ†æ

## dispatch_async()

åœ¨ queue.h æ–‡ä»¶æ‰¾åˆ° `dispatch_async()` æ–¹æ³•çš„å®šä¹‰
```
API_AVAILABLE(macos(10.6), ios(4.0))
DISPATCH_EXPORT DISPATCH_NONNULL_ALL DISPATCH_NOTHROW
void
dispatch_async(dispatch_queue_t queue, dispatch_block_t block);
```

åœ¨ queue.c æ–‡ä»¶æ‰¾åˆ° `dispatch_async()` æ–¹æ³•çš„å®ç°ï¼š
```
void
dispatch_async(dispatch_queue_t dq, dispatch_block_t work)
{
    //å°†ä»»åŠ¡ work æ‰“åŒ…æˆ dispatch_continuation_t ç±»å‹
	dispatch_continuation_t dc = _dispatch_continuation_alloc(); 
    //è®¾ç½®æ ‡å¿—ä½
	uintptr_t dc_flags = DC_FLAG_CONSUME;
	dispatch_qos_t qos;

    //è¿›è¡Œblockåˆå§‹åŒ–
	qos = _dispatch_continuation_init(dc, dq, work, 0, dc_flags);
	_dispatch_continuation_async(dq, dc, qos, dc->dc_flags);
}
```

åœ¨ inline_internal.h æ–‡ä»¶æ‰¾åˆ° `_dispatch_continuation_async()` æ–¹æ³•çš„å®ç°ï¼š
```
DISPATCH_ALWAYS_INLINE
static inline void
_dispatch_continuation_async(dispatch_queue_class_t dqu,
		dispatch_continuation_t dc, dispatch_qos_t qos, uintptr_t dc_flags)
{
#if DISPATCH_INTROSPECTION
	if (!(dc_flags & DC_FLAG_NO_INTROSPECTION)) {
		_dispatch_trace_item_push(dqu, dc); //å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
	}
#else
	(void)dc_flags;
#endif
	return dx_push(dqu._dq, dc, qos);
}
```

åœ¨ trace.h æ–‡ä»¶æ‰¾åˆ° `_dispatch_trace_item_push` æ–¹æ³•çš„å®ç°ï¼š
```
#define _dispatch_trace_item_push(dq, dou) \
		do { (void)(dq); (void)(dou); } while(0)
```

## dispatch_sync()

# å¤šçº¿ç¨‹çš„å®‰å…¨éšæ‚£

èµ„æºå…±äº«ï¼š1å—èµ„æºå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹å¯èƒ½ä¼šè®¿é—®åŒä¸€å—èµ„æºï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ã€åŒä¸€ä¸ªå˜é‡ã€åŒä¸€ä¸ªæ–‡ä»¶ã€‚

å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å—èµ„æºæ—¶ï¼Œå¾ˆå®¹æ˜“å¼•å‘æ•°æ®é”™ä¹±å’Œæ•°æ®å®‰å…¨é—®é¢˜ã€‚

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£ç¤ºä¾‹

### å–ç¥¨
```
@interface ViewController ()
@property (assign, nonatomic) int ticketsCount;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    [self ticketTest];
}

- (void)ticketTest
{
    self.ticketsCount = 15;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
             [self saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self saleTicket];
        }
    });
}

//å–1å¼ ç¥¨
- (void)saleTicket
{
    int oldTicketsCount = self.ticketsCount;
    sleep(.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
@end
```

æ‰“å°ç»“æœï¼š
```
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©13å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©12å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©11å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©10å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©8å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©7å¼ ç¥¨ - <NSThread: 0x600000da81c0>{number = 4, name = (null)}
è¿˜å‰©6å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©5å¼ ç¥¨ - <NSThread: 0x600000d91a80>{number = 6, name = (null)}
è¿˜å‰©4å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
è¿˜å‰©3å¼ ç¥¨ - <NSThread: 0x600000db4040>{number = 5, name = (null)}
```

å¯ä»¥çœ‹åˆ°ï¼Œåˆšå¼€å§‹ä¸‰ä¸ªçº¿ç¨‹éƒ½å–äº†1å¼ ç¥¨ï¼Œç»“æœè¿˜æ˜¯ä¸‹14å¼ ç¥¨ã€‚åœ¨ä¸‰ä¸ªçº¿ç¨‹èµ°å®Œåæ€»å…±å–äº†15å¼ ç¥¨ï¼Œä½†æ˜¯æœ€åè¿˜å‰©3å¼ ç¥¨ã€‚æ— è®ºæ˜¯åœ¨å–ç¥¨è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯æœ€åå‰©ä½™çš„ç¥¨æ•°éƒ½å‡ºç°äº†å¼‚å¸¸ã€‚

![å¤šçº¿ç¨‹10](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹10.png)
æ€»å…±15å¼ ç¥¨ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å–ç¥¨ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯æ‹¿15å‡1ï¼Œå¾—åˆ°çš„æ‰‹åŠ¿14å¼ ç¥¨ã€‚ä¸åŒçš„çº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚

### å­˜é’±å–é’±
```
@interface ViewController ()
@property (assign, nonatomic) int money;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self moneyTest];
}

- (void)moneyTest
{
    self.money = 100;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self saveMoney];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self drawMoney];
        }
    });
}

//å­˜é’±
- (void)saveMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 50;
    self.money = oldMoney;
    
    NSLog(@"å­˜50ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

//å–é’±
- (void)drawMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    
    NSLog(@"å–20ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}
@end
```

æ‰“å°ç»“æœï¼š
```
å­˜50ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©80å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©110å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©130å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©90å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©140å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©120å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©170å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©200å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©180å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©230å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©210å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©260å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©240å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©290å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©270å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©320å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
å–20ï¼Œè¿˜å‰©300å…ƒ - <NSThread: 0x600000928a80>{number = 3, name = (null)}
å­˜50ï¼Œè¿˜å‰©350å…ƒ - <NSThread: 0x60000094bf40>{number = 5, name = (null)}
```

ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæœ€åè¿˜å‰©350ã€‚ä»£ç ä¸­ï¼ŒåŸæœ¬æœ‰100ï¼Œå­˜äº†500ï¼Œå–äº†200ï¼Œæ‰€ä»¥ç»“æœåº”è¯¥æ˜¯400ã€‚

![å¤šçº¿ç¨‹11](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹11.png)
æ€»å…±100å…ƒï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‹¿åˆ°100å…ƒï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å­˜äº†50å…ƒåä½™é¢è¿˜å‰©150å…ƒï¼Œç¬¬äºŒä¸ªçº¿ç¨‹å»äº†20å…ƒä½™é¢è¿˜å‰©80å…ƒã€‚ä¸åŒçš„çº¿ç¨‹æ‹¿åˆ°åŒä¸€ä¸ªå˜é‡è¿›è¡Œä¿®æ”¹ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£åˆ†æ

çº¿ç¨‹Aå…ˆå–åˆ°å˜é‡çš„å€¼17ï¼Œçº¿ç¨‹Båå–åˆ°å˜é‡çš„å€¼17ã€‚çº¿ç¨‹Aå¯¹å–åˆ°çš„å€¼åŠ ä¸€ï¼ˆ17+1=18ï¼‰ï¼Œçº¿ç¨‹Bå¯¹å–åˆ°çš„å€¼åŠ ä¸€ï¼ˆ17+1=18ï¼‰ã€‚çº¿ç¨‹Aå°†å¤„ç†åçš„å€¼èµ‹å€¼ç»™å˜é‡ï¼ˆ18ï¼‰ï¼Œçº¿ç¨‹Bä¹Ÿå°†å¤„ç†åçš„å€¼èµ‹å€¼ç»™å˜é‡ï¼ˆ18ï¼‰ã€‚è™½ç„¶ä¿®æ”¹äº†ä¸¤æ¬¡å˜é‡ï¼ˆ+1ï¼‰ï¼Œä½†æ˜¯ç»“æœéƒ½æ˜¯18ï¼š
![å¤šçº¿ç¨‹12](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹12.png)

## å¤šçº¿ç¨‹å®‰å…¨éšæ‚£çš„è§£å†³æ–¹æ¡ˆ
è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨çº¿ç¨‹åŒæ­¥æŠ€æœ¯ï¼ˆåŒæ­¥ï¼Œå°±æ˜¯ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿›è¡Œï¼‰ã€‚  
å¸¸è§çš„çº¿ç¨‹åŒæ­¥æŠ€æœ¯æ˜¯ï¼šåŠ é”ã€‚
![å¤šçº¿ç¨‹13](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹13.png)

# iOSä¸­çš„çº¿ç¨‹åŒæ­¥æ–¹æ¡ˆ

| åŒæ­¥æ–¹æ¡ˆ | ç®€ä»‹ |
| :-- | :-- |
| OSSpinLock | è‡ªæ—‹é” |
| os_unfair_lock | ç”¨äºå–ä»£ä¸å®‰å…¨çš„OSSpinLock |
| pthread_mutex | äº’æ–¥é” |
| dispatch_semaphore | ä¿¡å·é‡ |
| dispatch_queue(DISPATCH_QUEUE_SERIAL) | ä¸²è¡Œé˜Ÿåˆ— |
| NSLock | å¯¹mutexæ™®é€šé”çš„å°è£… |
| NSRecursiveLock | å¯¹mutexé€’å½’é”çš„å°è£…ï¼ŒAPIè·ŸNSLockåŸºæœ¬ä¸€è‡´ |
| NSCondition | å¯¹mutexå’Œcondçš„å°è£… |
| NSConditionLock | å¯¹NSConditionçš„è¿›ä¸€æ­¥å°è£…ï¼Œå¯ä»¥è®¾ç½®å…·ä½“çš„æ¡ä»¶å€¼ |
| @synchronized | å¯¹mutexé€’å½’é”çš„å°è£… |

å°†å–ç¥¨å’Œå­˜é’±å–é’±æµ‹è¯•ä»£ç å°è£…èµ·æ¥ï¼š
```
@interface BaseLockDemo : NSObject
///å­˜é’±å–é’±
- (void)moneyTest;
///å–ç¥¨
- (void)ticketTest;
#pragma mark - æš´éœ²ç»™å­ç±»å»ä½¿ç”¨
- (void)__saveMoney;
- (void)__drawMoney;
- (void)__saleTicket;
@end

@interface BaseLockDemo()
@property (assign, nonatomic) int money;
@property (assign, nonatomic) int ticketsCount;
@end

@implementation BaseLockDemo
///------ å­˜é’±ã€å–é’±æ¼”ç¤º ------
- (void)moneyTest
{
    self.money = 100;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self __saveMoney];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 10; i++) {
            [self __drawMoney];
        }
    });
}

///å­˜é’±
- (void)__saveMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney += 50;
    self.money = oldMoney;
    
    NSLog(@"å­˜50ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

///å–é’±
- (void)__drawMoney
{
    int oldMoney = self.money;
    sleep(.2);
    oldMoney -= 20;
    self.money = oldMoney;
    
    NSLog(@"å–20ï¼Œè¿˜å‰©%då…ƒ - %@", oldMoney, [NSThread currentThread]);
}

///------ å–ç¥¨æ¼”ç¤º ------
- (void)ticketTest
{
    self.ticketsCount = 15;
    
    dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
    
    dispatch_async(queue, ^{
        for (int i = 0; i < 5; i++) {
            [self __saleTicket];
        }
    });
}

///å–1å¼ ç¥¨
- (void)__saleTicket
{
    int oldTicketsCount = self.ticketsCount;
    sleep(.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
@end
```

## OSSpinLock
`OSSpinLock` å«åšâ€è‡ªæ—‹é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºå¿™ç­‰ï¼ˆbusy-waitï¼‰çŠ¶æ€ï¼Œä¸€ç›´å ç”¨ç€CPUèµ„æºã€‚ç›®å‰å·²ç»ä¸å†å®‰å…¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼ˆå¦‚æœç­‰å¾…é”çš„çº¿ç¨‹ä¼˜å…ˆçº§è¾ƒé«˜ï¼Œå®ƒä¼šä¸€ç›´å ç”¨ç€CPUèµ„æºï¼Œä¼˜å…ˆçº§ä½çš„çº¿ç¨‹å°±æ— æ³•é‡Šæ”¾é”ï¼‰ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <libkern/OSAtomic.h>`ã€‚

å¿™ç­‰çŠ¶æ€å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª do-while å¾ªç¯ï¼Œä¸åœçš„ç›‘æµ‹ç€æ˜¯å¦è§£é”ï¼Œè¿™ä¸ªçŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¼šä¸€ç›´å ç”¨ç€CPUèµ„æºã€‚æ­£å› ä¸ºæ˜¯å¤„äºå¿™ç­‰çŠ¶æ€ï¼Œæ‰€ä»¥ `OSSpinLock` çš„æ•ˆç‡è¦å…¶å®ƒé”éƒ½é«˜ï¼Œä¸€æ—¦è§£é”ç«‹åˆ»å°±èƒ½ç›‘æµ‹åˆ°å¹¶ç»§ç»­æ‰§è¡Œã€‚ä¸åœ¨å®‰å…¨çš„åŸå› æ˜¯ä¼˜å…ˆçº§è¾ƒé«˜çš„çº¿ç¨‹åœ¨ç­‰å¾…é”æ—¶ï¼ˆå¿™ç­‰ï¼‰ï¼ŒCPUä¸å†åˆ†é…èµ„æºç»™å…¶å®ƒçº¿ç¨‹ï¼Œé‚£ä¹ˆä¸Šé”çš„çº¿ç¨‹è´Ÿè´£è§£é”ï¼Œç”±äºCPUæ²¡æœ‰åˆ†é…èµ„æºä¹Ÿæ— æ³•è§£é”ï¼Œå¯¼è‡´ä¼˜å…ˆçº§è¾ƒé«˜çš„çº¿ç¨‹ä¸€ç›´åœ¨è¿™é‡Œç­‰å¾…ã€‚

* çº¿ç¨‹è°ƒåº¦
è®¡ç®—æœºé€šå¸¸åªæœ‰ä¸€ä¸ªCPUï¼Œåœ¨ä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œæ¯ä¸ªçº¿ç¨‹åªæœ‰è·å¾—CPUçš„ä½¿ç”¨æƒæ‰èƒ½æ‰§è¡ŒæŒ‡ä»¤ã€‚æ‰€è°“å¤šçº¿ç¨‹çš„å¹¶å‘è¿è¡Œï¼Œå…¶å®æ˜¯æŒ‡ä»å®è§‚ä¸Šçœ‹ï¼Œå„ä¸ªçº¿ç¨‹è½®æµè·å¾—CPUçš„ä½¿ç”¨æƒï¼Œåˆ†åˆ«æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡ã€‚åœ¨è¿è¡Œæ± ä¸­ï¼Œä¼šæœ‰å¤šä¸ªå¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨ç­‰å¾…CPUï¼ŒJAVAè™šæ‹Ÿæœºçš„ä¸€é¡¹ä»»åŠ¡å°±æ˜¯è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œçº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡æŒ‰ç…§ç‰¹å®šæœºåˆ¶ä¸ºå¤šä¸ªçº¿ç¨‹åˆ†é…CPUçš„ä½¿ç”¨æƒã€‚
* æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦
æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦æ˜¯ä¸€ç§æœ€å¤è€ï¼Œæœ€ç®€å•ï¼Œæœ€å…¬å¹³ä¸”ä½¿ç”¨æœ€å¹¿çš„ç®—æ³•ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ï¼Œå³è¯¥è¿›ç¨‹å…è®¸è¿è¡Œçš„æ—¶é—´ã€‚å¦‚æœåœ¨æ—¶é—´ç‰‡ç»“æŸæ—¶è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œåˆ™CPUå°†è¢«å‰¥å¤ºå¹¶åˆ†é…ç»™å¦ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹åœ¨æ—¶é—´ç‰‡ç»“æŸå‰é˜»å¡æˆ–ç»“æŸï¼Œåˆ™CPUå½“å³è¿›è¡Œåˆ‡æ¢ã€‚è°ƒåº¦ç¨‹åºæ‰€è¦åšçš„å°±æ˜¯ç»´æŠ¤ä¸€å¼ å°±ç»ªè¿›ç¨‹åˆ—è¡¨ï¼Œå½“è¿›ç¨‹ç”¨å®Œå®ƒçš„æ—¶é—´ç‰‡åï¼Œå®ƒè¢«ç§»åˆ°é˜Ÿåˆ—çš„æœ«å°¾ã€‚

### å¸¸ç”¨API
```
/// åˆå§‹åŒ–
OSSpinLock lock = OS_SPINLOCK_INIT;
/// å°è¯•åŠ é”ï¼ˆå¦‚æœéœ€è¦ç­‰å¾…å°±ä¸åŠ é”ï¼Œç›´æ¥è¿”å›falseï¼›å¦‚æœä¸éœ€è¦ç­‰å¾…å°±åŠ é”ï¼Œè¿”å›trueï¼‰
bool result = OSSpinLockTry(&lock);
/// åŠ é”
OSSpinLockLock(&lock);
/// è§£é”
OSSpinLockUnlock(&lock);
```

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ OSSpinLockDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <libkern/OSAtomic.h>

@interface OSSpinLockDemo()
@property (assign, nonatomic) OSSpinLock moneyLock;
@property (assign, nonatomic) OSSpinLock ticketLock;
@end

@implementation OSSpinLockDemo

- (instancetype)init
{
    if (self = [super init]) {
        self.moneyLock = OS_SPINLOCK_INIT;
        self.ticketLock = OS_SPINLOCK_INIT;
    }
    return self;
}
///å–é’±
- (void)__drawMoney
{
    OSSpinLockLock(&_moneyLock);
    
    [super __drawMoney];
    
    OSSpinLockUnlock(&_moneyLock);
}
///å­˜é’±
- (void)__saveMoney
{
    OSSpinLockLock(&_moneyLock);
    
    [super __saveMoney];
    
    OSSpinLockUnlock(&_moneyLock);
}
///å–ç¥¨
- (void)__saleTicket
{
    OSSpinLockLock(&_ticketLock);
    
    [super __saleTicket];
    
    OSSpinLockUnlock(&_ticketLock);
}
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    BaseLockDemo *demo = [[OSSpinLockDemo alloc] init];
    [demo ticketTest];
    [demo moneyTest];
}
@end
```

è°ƒç”¨ `-(void)moneyTest` æ‰“å°ç»“æœï¼š
```
å­˜50ï¼Œè¿˜å‰©150å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©200å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©250å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©300å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©350å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©400å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©450å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©500å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©550å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å­˜50ï¼Œè¿˜å‰©600å…ƒ - <NSThread: 0x600000471080>{number = 4, name = (null)}
å–20ï¼Œè¿˜å‰©580å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©560å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©540å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©520å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©500å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©480å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©460å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©440å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©420å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
å–20ï¼Œè¿˜å‰©400å…ƒ - <NSThread: 0x600000463ec0>{number = 3, name = (null)}
```

è°ƒç”¨ `-(void)ticketTest` æ‰“å°ç»“æœï¼š
```
è¿˜å‰©14å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©13å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©12å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©11å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©10å¼ ç¥¨ - <NSThread: 0x600003a39ec0>{number = 3, name = (null)}
è¿˜å‰©9å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©8å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©7å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©6å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©5å¼ ç¥¨ - <NSThread: 0x600003a6c2c0>{number = 6, name = (null)}
è¿˜å‰©4å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©3å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©2å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©1å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
è¿˜å‰©0å¼ ç¥¨ - <NSThread: 0x600003a4a700>{number = 5, name = (null)}
```

å› ä¸ºè¦ä¿®æ”¹çš„æœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯å­˜é’±å–é’±é‡Œçš„ä½™é¢ï¼Œä¸€ä¸ªæ˜¯å–ç¥¨é‡Œçš„å‰©ä½™ç¥¨æ•°ï¼Œæ‰€ä»¥è¦æœ‰ä¸¤æŠŠé”åˆ†åˆ«å¯¹åº”è¿™ä¸¤ä¸ªå˜é‡ã€‚ä¸€æ—¦æœ‰çº¿ç¨‹å¯¹ OSSpinLock ä¸Šé”åï¼Œå…¶å®ƒçº¿ç¨‹å†é‡åˆ° OSSpinLock æ—¶ä¼šé˜»å¡ä½ï¼Œç­‰å¾… OSSpinLock è§£é”åœ¨ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚

ä¸Šé¢ğŸ‘†çš„ä¾‹å­æ˜¯å°† OSSpinLock é”å¯¹è±¡æ”¾åˆ°äº†å®ä¾‹å¯¹è±¡é‡Œï¼Œä¹Ÿå¯ä»¥å°† OSSpinLock é”å¯¹è±¡æ”¾åˆ°ç±»å¯¹è±¡é‡Œï¼š
```
static OSSpinLock moneyLock_;
+ (void)initialize
{
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        moneyLock_ = 0;
    });
}
```

ç±»æ–¹æ³• `+ (void)initialize` åªä¼šè¢«ç³»ç»Ÿè°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯å…è®¸è¢«å¼€å‘è€…è°ƒç”¨ï¼Œæ‰€ä»¥ä½¿ç”¨ `dispatch_once` ä¿è¯ç±»å¯¹è±¡çš„ `moneyLock_` é”åªåˆå§‹åŒ–ä¸€æ¬¡ã€‚

æˆ–è€…ï¼š
```
- (void)__saleTicket
{
    static OSSpinLock ticketLock = OS_SPINLOCK_INIT;
    
    OSSpinLockLock(&ticketLock);
    
    [super __saleTicket];
    
    OSSpinLockUnlock(&ticketLock);
}
```

ä½¿ç”¨ static å…³é”®å­—ï¼Œå°† `ticketLock` é”ä¿å­˜åœ¨å…¨å±€åŒºï¼Œä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡ã€‚

### OSSpinLock æ±‡ç¼–åˆ†æ
* lldb æŒ‡ä»¤ï¼š
  jneï¼šj æ˜¯ jumpï¼Œne æ˜¯æ¡ä»¶ã€‚  
  callqï¼šå‡½æ•°è°ƒç”¨ã€‚  
  setpï¼šæ‰§è¡Œä¸€è¡ŒOCä»£ç ã€‚  
  stepiï¼šstepinstruction çš„ç®€å†™ï¼Œæ‰§è¡Œä¸€è¡Œæ±‡ç¼–ä»£ç ï¼Œä¹Ÿå¯ä»¥ç®€å†™ä¸º siã€‚  
  nextï¼šæ‰§è¡Œä¸€è¡ŒOCä»£ç ã€‚
  nextiï¼šæ‰§è¡Œä¸€è¡Œæ±‡ç¼–ä»£ç ã€‚
  stepi å’Œ nexti çš„åŒºåˆ«ï¼šåœ¨é‡åˆ°å‡½æ•°è°ƒç”¨æ˜¯ï¼Œstepi ä¼šè¿›å…¥è°ƒç”¨çš„å‡½æ•°ï¼Œnexti ä¸ä¼šè¿›å…¥ã€‚  
  cï¼šcontinue çš„ç®€å†™ï¼Œç»§ç»­æ‰§è¡Œã€‚  

ï¼ˆé‡å¤æ•²å›è½¦ä¼šæ‰§è¡Œä¸Šä¸€ä¸ª lldb æŒ‡ä»¤ï¼Œå¦‚æœæ•²çš„è¿‡å¿«å¯èƒ½ä¼šå‡ºç°å¼‚å¸¸ï¼‰  

ä¿®æ”¹ LockBaseDemo ç±»é‡Œçš„ `- (void)__saleTicket` æ–¹æ³•ï¼Œè®¾ç½®ç¡çœ æ—¶é—´ä¸º 60sï¼Œè¿™æ ·å¯ä»¥æœ‰è¶³å¤Ÿçš„æ—¶é—´æŸ¥çœ‹ç¬¬äºŒæ¬¡åŠ é”æ—¶çš„æ±‡ç¼–ä»£ç ã€‚ä¿®æ”¹ `- (void)ticketTest` æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨10æ¬¡ `- (void)__saleTicket` æ–¹æ³•ï¼š
```
///å–ç¥¨æ¼”ç¤º
- (void)ticketTest
{
    self.ticketsCount = 15;
    
    for (int i=0; i<10; i++) {
        [[[NSThread alloc] initWithTarget:self selector:@selector(__saleTicket) object:nil] start]; 
    }
}

///å–ç¥¨
- (void)__saleTicket
{
    int oldTicketsCount = self.ticketsCount;
    sleep(60.2);
    oldTicketsCount--;
    self.ticketsCount = oldTicketsCount;
    NSLog(@"è¿˜å‰©%då¼ ç¥¨ - %@", oldTicketsCount, [NSThread currentThread]);
}
```

Debug -> Debug Workflow -> Always Show Disassembly æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼š

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 9 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 10ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 10 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ si æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ OSSpinLocklock å‡½æ•°ï¼š
![å¤šçº¿ç¨‹15](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹15.png)
ä½¿ç”¨ si æŒ‡ä»¤è¿›å…¥åˆ°è°ƒç”¨å‡½æ•°ï¼š
![å¤šçº¿ç¨‹16](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹16.png)
é‡å¤æ‰§è¡Œ si æŒ‡ä»¤ï¼Œåœ¨ç¬¬6è¡Œé€šè¿‡ jne è·³è½¬åˆ° _OSSpinLockLockSlow å‡½æ•°ï¼š
![å¤šçº¿ç¨‹17](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹17.png)
_OSSpinLockLockSlow å‡½æ•°æ˜¯è‡ªæ—‹é”çš„æ ¸å¿ƒä»£ç ï¼Œä»ç¬¬6è¡Œåˆ°ç¬¬19è¡Œæ˜¯ä¸€ä¸ª while å¾ªç¯ï¼ˆğŸ”è‡ªæ—‹é”æ ‡å¿—ï¼‰ã€‚å› ä¸º Thread 9 å·²ç»åŠ è¿‡é”å¹¶ä¸”è¿˜æ²¡æœ‰è§£é”ï¼Œæ‰€ä»¥è¿™é‡Œä¼šä¸€ç›´å¾ªç¯æ‰§è¡Œï¼Œç­‰å¾… Thread 9 è§£é”ã€‚å¯ä»¥çœ‹åˆ°ç¬¬14è¡Œå’Œç¬¬16è¡Œæ˜¯è·³å‡º while å¾ªç¯çš„åˆ¤æ–­ï¼š
![å¤šçº¿ç¨‹18](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹18.png)


## os_unfair_lock
`OSSpinLock` åœ¨ä»¥å‰ç®—æ˜¯æ€§èƒ½æœ€é«˜çš„ä¸€ç§é”ï¼Œä½†æ˜¯ç”±äºä¸å†å®‰å…¨ï¼ˆä¼˜å…ˆçº§åè½¬é—®é¢˜ï¼‰ï¼Œè‹¹æœå·²ç»ä¸å»ºè®®ä½¿ç”¨äº†ï¼Œä» iOS10 å¼€å§‹æ¨å‡ºäº†æ›¿ä»£å®ƒçš„ `os_unfair_lock`ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <os/lock.h>`ã€‚

### å¸¸ç”¨API
```
///åˆå§‹åŒ–
os_unfair_lock lock = OS_UNFAIR_LOCK_INIT;
///å°è¯•åŠ é”
os_unfair_lock_trylock(&lock);
///åŠ é”
os_unfair_lock_lock(&lock);
///è§£é”
os_unfair_lock_unlock(&lock);
```

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ OSUnfairLockDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <libkern/OSAtomic.h>

@interface OSUnfairLockDemo()
@property (nonatomic, assign) os_unfair_lock moneyLock;
@property (nonatomic, assign) os_unfair_lock ticketLock;
@end

@implementation OSUnfairLockDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        self.moneyLock = OS_UNFAIR_LOCK_INIT;
        self.ticketLock = OS_UNFAIR_LOCK_INIT;
    }
    return self;
}

///å–é’±
- (void)__drawMoney
{
    os_unfair_lock_lock(&_moneyLock);
    
    [super __drawMoney];
    
    os_unfair_lock_unlock(&_moneyLock);
}

///å­˜é’±
- (void)__saveManey
{
    os_unfair_lock_lock(&_moneyLock);
    
    [super __saveManey];
    
    os_unfair_lock_unlock(&_moneyLock);
}

///å–ç¥¨
- (void)__saleTicket
{
    os_unfair_lock_lock(&_ticketLock);
    
    [super __saleTicket];
    
    os_unfair_lock_unlock(&_ticketLock);
}
```

* æ­»é”  
å¦‚æœåŠ é”åæ²¡æœ‰è§£é”ï¼Œå…¶å®ƒçº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…ï¼Œæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚è¿™ç§ç”±äºæ²¡æœ‰è§£é”é€ æˆçš„å…¶å®ƒçº¿ç¨‹çš„ç­‰å¾…å«åšæ­»é”ã€‚

### os_unfair_lock æ±‡ç¼–åˆ†æ

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 8 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 15ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 15 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ `os_unfair_lock_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹26](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹26.png)
ä½¿ç”¨ `si` æŒ‡ä»¤è¿›å…¥åˆ° `os_unfair_lock_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹27](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹27.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_os_unfair_lock_lock_slow` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹28](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹28.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œç¬¬56è¡Œä¼šè°ƒç”¨ `__ulock_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹29](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹29.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `__ulock_wait`ï¼š
![å¤šçº¿ç¨‹30](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹30.png)
ç¬¬4è¡Œ `syscall` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåï¼ŒXCode å°±åˆå›åˆ°äº†OCä»£ç é¡µé¢ï¼Œçº¿ç¨‹å°±è¿›å…¥ä¼‘çœ çŠ¶æ€äº†ï¼ˆğŸ”äº’æ–¥é”æ ‡å¿—ï¼‰ï¼š
![å¤šçº¿ç¨‹31](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹31.png)

ä»ä¸Šé¢ğŸ‘†å¯¹ os_unfair_lock çš„æ±‡ç¼–åˆ†æï¼Œå¯ä»¥çœ‹å‡º os_unfair_lock æ˜¯ä¸€ä¸ªäº’æ–¥é”ã€‚åœ¨ os_unfair_lock çš„å¤´æ–‡ä»¶ lock.h é‡Œçš„æ³¨é‡Šå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå•è¯ Low-levelï¼ˆä½çº§é”ï¼‰ï¼Œä½çº§é”çš„ç‰¹ç‚¹å°±æ˜¯ä¼‘çœ ã€‚è‡ªæ—‹é” OSSpinLock æ˜¯ä¸€ä¸ªé«˜çº§é”ã€‚

## pthread_mutex

mutex å«åšâ€äº’æ–¥é”â€ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€ã€‚éœ€è¦å¯¼å…¥å¤´æ–‡ä»¶ `#import <pthread.h>`ã€‚

### å¸¸ç”¨API
```
///åˆå§‹åŒ–é”çš„å±æ€§
pthread_mutexattr_t attr;
pthread_mutexattr_init(&attr);
pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_NORMAL);
///åˆå§‹åŒ–é”
pthread_mutex_t mutex;
pthread_mutex_init(&mutex, &attr);
///å°è¯•åŠ é”
pthread_mutex_trylock(&mutex);
///åŠ é”
pthread_mutex_lock(&mutex);
///è§£é”
pthread_mutex_unlock(&mutex);
///é”€æ¯ç›¸å…³èµ„æº
pthread_mutexattr_destroy(&attr);
pthread_mutex_destroy(&mutex);
```

é”å®šç±»å‹ï¼š
```
#define PTHREAD_MUTEX_NORMAL		0
#define PTHREAD_MUTEX_ERRORCHECK	1
#define PTHREAD_MUTEX_RECURSIVE		2
#define PTHREAD_MUTEX_DEFAULT		PTHREAD_MUTEX_NORMAL
```

### PTHREAD_MUTEX_INITIALIZER
```
/*
 * Mutex variables
 */
#define PTHREAD_MUTEX_INITIALIZER {_PTHREAD_MUTEX_SIG_init, {0}}
```

å¯ä»¥çœ‹åˆ°ï¼ŒPTHREAD_MUTEX_INITIALIZER æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨ PTHREAD_MUTEX_INITIALIZER åˆå§‹åŒ–é”æ—¶ï¼Œç”±äºç»“æ„ä½“è¯­æ³•çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œé™æ€åˆå§‹åŒ–ï¼š
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
    }
    return self;
}
```

å¦‚æœä½¿ç”¨ PTHREAD_MUTEX_INITIALIZER åŠ¨æ€åˆå§‹åŒ– pthread_mutex_t ä¼šæŠ¥é”™ï¼š
![å¤šçº¿ç¨‹14](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹14.png)

### pthread_mutexattr_t
åˆå§‹åŒ– pthread_mutex é”ï¼š 
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        ///åˆå§‹åŒ–å±æ€§
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_DEFAULT);
        ///åˆå§‹åŒ–é”
        pthread_mutex_init(&_moneyMutex, &attr);
        ///é”€æ¯å±æ€§
        pthread_mutexattr_destroy(&attr);
    }
    return self;
}
```

ä¸Šé¢ğŸ‘†åˆå§‹åŒ–é”çš„ä»£ç æ¯”è¾ƒç¹çï¼Œä¸€èˆ¬ä½¿ç”¨ `pthread_mutex_init(&_moneyMutex, NULL)` æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚`pthread_mutex_init()` æ–¹æ³•çš„ç¬¬äºŒå‚æ•°ä¼  `NULL`ï¼Œå°±ç›¸å½“äºè®¾ç½®äº† `PTHREAD_MUTEX_DEFAULT` ç±»å‹çš„ `pthread_mutexattr_t` å±æ€§ã€‚

### è§£å†³å–ç¥¨å’Œå­˜é’±å–é’±é—®é¢˜
å®šä¹‰ PthreadMutexDemo ç»§æ‰¿è‡ª LockBaseDemoã€‚
```
#import <pthread.h>

@interface PthreadMutexDemo()
@property (nonatomic, assign) pthread_mutex_t moneyMutex;
@property (nonatomic, assign) pthread_mutex_t ticketMutex;
@end

@implementation PthreadMutexDemo

- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_moneyMutex, NULL);
        pthread_mutex_init(&_ticketMutex, NULL);
    }
    return self;
}

///å–é’±
- (void)__drawMoney
{
    pthread_mutex_lock(&_moneyMutex);
    
    [super __drawMoney];
    
    pthread_mutex_unlock(&_moneyMutex);
}

///å­˜é’±
- (void)__saveManey
{
    pthread_mutex_lock(&_moneyMutex);
    
    [super __saveManey];
    
    pthread_mutex_unlock(&_moneyMutex);
}

///å–ç¥¨
- (void)__saleTicket
{
    pthread_mutex_lock(&_ticketMutex);
    
    [super __saleTicket];
    
    pthread_mutex_unlock(&_ticketMutex);
}

///é”€æ¯é”
- (void)dealloc
{
    pthread_mutex_destroy(&_moneyMutex);
    pthread_mutex_destroy(&_ticketMutex);
}

@end
```

ç›¸å¯¹äº `OSSpinLock` å’Œ `os_unfair_lock`ï¼Œ`pthread_mutex` çš„ API é‡Œæä¾›äº†é”€æ¯æ–¹æ³• `pthread_mutex_destroy()`ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `-(void)dealloc` æ–¹æ³•é‡Œå¯¹é”è¿›è¡Œé”€æ¯ã€‚

### pthread_mutex æ±‡ç¼–åˆ†æ

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 10 å¹¶åŠ é”ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨ `- (void)__saleTicket` æ–¹æ³•æ˜¯åœ¨ Thread 14ï¼Œå› ä¸ºæ­¤æ—¶çš„è‡ªæ—‹é”å¤„äºä¸Šé”çŠ¶æ€ï¼Œæ‰€ä»¥ Thread 14 å¤„äºç­‰å¾…é”çš„çŠ¶æ€ã€‚é‡å¤æ‰§è¡Œ `si` æŒ‡ä»¤ï¼Œåˆ°ç¬¬11è¡Œæ—¶ä¼šè°ƒç”¨ `phread_mutex_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹19](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹19.png)
ä½¿ç”¨ `si` æŒ‡ä»¤è¿›å…¥åˆ° `phread_mutex_lock` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹20](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹20.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_pthread_mutex_firstfit_lock_slow` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹21](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹21.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `_pthread_mutex_firstfit_lock_wait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹22](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹22.png)
é‡å¤ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè°ƒç”¨ `__psynch_mutexwait`ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹23.png)
ä½¿ç”¨ `si` æŒ‡ä»¤ï¼Œè¿›å…¥ `__psynch_mutexwait` å‡½æ•°ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹24.png)
ç¬¬4è¡Œ `syscall` æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåï¼ŒXCode å°±åˆå›åˆ°äº†OCä»£ç é¡µé¢ï¼Œçº¿ç¨‹å°±è¿›å…¥ä¼‘çœ çŠ¶æ€äº†ï¼ˆğŸ”äº’æ–¥é”æ ‡å¿—ï¼‰ï¼š
![å¤šçº¿ç¨‹23](å¤šçº¿ç¨‹/å¤šçº¿ç¨‹25.png)

ä»ä¸Šé¢ğŸ‘†å¯¹ pthread_mutex çš„æ±‡ç¼–åˆ†æï¼Œå¯ä»¥çœ‹å‡º pthread_mutex æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä½çº§é”ã€‚

## pthread_mutex â€“ é€’å½’é”
åˆå§‹åŒ– pthread_mutex é€’å½’é”ï¼š
```
- (instancetype)init
{
    self = [super init];
    if (self) {
        ///åˆå§‹åŒ–å±æ€§
        pthread_mutexattr_t attr;
        pthread_mutexattr_init(&attr);
        pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
        ///åˆå§‹åŒ–é”
        pthread_mutex_init(&_moneyMutex, &attr);
        ///é”€æ¯å±æ€§
        pthread_mutexattr_destroy(&attr);
    }
    return self;
}
```

ç”¨ PTHREAD_MUTEX_RECURSIVE ç±»å‹å®šä¹‰çš„å±æ€§åˆ›å»ºå‡ºæ¥çš„ pthread_mutex é”å°±æ˜¯ pthread_mutex é€’å½’é”ã€‚

### æ­»é”
åœ¨ä½¿ç”¨é”æ—¶å¦‚æœå‡ºç°äº†é€’å½’è°ƒç”¨ï¼Œæˆ–è€…åœ¨åŠ é”åè°ƒç”¨äº†ä¸€ä¸ªä½¿ç”¨åŒä¸€æŠŠé”çš„æ–¹æ³•ï¼Œå°±ä¼šå‡ºç°æ­»é”çš„æƒ…å†µã€‚ä¸ä¸Šé¢ğŸ‘†æåˆ°è¿‡çš„æ­»é”çš„æ¦‚å¿µç›¸åŒã€‚

å®šä¹‰ PthreadMutexRecursiveDemoï¼š
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@implementation PthreadMutexRecursiveDemo
- (void)recursiveMutexTest
{
    NSLog(@"%s", __func__);
    ///é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
......
```

#### æ­»é”æƒ…å†µä¸€ï¼šé€’å½’è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t recursiveMutex;
@end

@implementation PthreadMutexRecursiveDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_recursiveMutex, NULL);
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    ///é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_recursiveMutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
```

å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœé‡Œåªæœ‰ä¸€æ¡æ‰“å°ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºåŠ é”åå†æ¬¡è°ƒç”¨ `-(void)recursiveMutexTest` æ–¹æ³•ï¼Œä¼šå‘ç° `_recursiveMutex` å·²ç»ä¸Šé”äº†ï¼Œè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

#### æ­»é”æƒ…å†µäºŒï¼šå‡½æ•°é—´äº’ç›¸è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t recursiveMutex;
@end

@implementation PthreadMutexRecursiveDemo
- (instancetype)init
{
    self = [super init];
    if (self) {
        pthread_mutex_init(&_recursiveMutex, NULL);
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    ///é€’å½’è°ƒç”¨
    [self recursiveMutexTest2];
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)recursiveMutexTest2
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_recursiveMutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
```

å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœé‡Œåªæœ‰ä¸€æ¡æ‰“å°ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œåœ¨ `- (void)recursiveMutexTest` æ–¹æ³•åŠ é”åå†å»è°ƒç”¨ `- (void)recursiveMutexTest2` æ–¹æ³•æ—¶ï¼Œä¼šå‘ç° _recursiveMutex å·²ç»ä¸Šé”äº†ï¼Œè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

### é€’å½’é”

å› ä¸ºé€’å½’é”å…è®¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œé‡å¤åŠ é”ï¼Œæ‰€ä»¥é€’å½’é”å¯ä»¥è§£å†³ä¸Šé¢å‡ºç°çš„æ­»é”æƒ…å†µã€‚

#### è§£å†³æ­»é”æƒ…å†µä¸€ï¼šé€’å½’è°ƒç”¨
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t recursiveMutex;
@end

@implementation PthreadMutexRecursiveDemo
- (void)initMutex:(pthread_mutex_t)mutex
{
    ///åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    ///åˆå§‹åŒ–é”
    pthread_mutex_init(&mutex, &attr);
    ///é”€æ¯å±æ€§
    pthread_mutexattr_destroy(&attr);
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initMutex:_recursiveMutex];
    }
    return self;
}

- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    ///é€’å½’è°ƒç”¨
    [self recursiveMutexTest];
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_recursiveMutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest]
......
```

#### è§£å†³æ­»é”æƒ…å†µäºŒï¼šå‡½æ•°é—´äº’ç›¸è°ƒç”¨ 
```
@interface PthreadMutexRecursiveDemo : LockBaseDemo
- (void)recursiveMutexTest;
@end

@interface PthreadMutexRecursiveDemo()
@property (nonatomic, assign) pthread_mutex_t recursiveMutex;
@end

@implementation PthreadMutexRecursiveDemo
- (void)initMutex:(pthread_mutex_t)mutex
{
    ///åˆå§‹åŒ–å±æ€§
    pthread_mutexattr_t attr;
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);
    ///åˆå§‹åŒ–é”
    pthread_mutex_init(&mutex, &attr);
    ///é”€æ¯å±æ€§
    pthread_mutexattr_destroy(&attr);
}

- (instancetype)init
{
    self = [super init];
    if (self) {
        [self initMutex:_recursiveMutex];
    }
    return self;
}


- (void)recursiveMutexTest
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    ///é€’å½’è°ƒç”¨
    [self recursiveMutexTest2];
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)recursiveMutexTest2
{
    pthread_mutex_lock(&_recursiveMutex);
    
    NSLog(@"%s", __func__);
    
    pthread_mutex_unlock(&_recursiveMutex);
}

- (void)dealloc
{
    pthread_mutex_destroy(&_recursiveMutex);
}
@end
```

æ‰“å°ç»“æœï¼š
```
-[PthreadMutexRecursiveDemo recursiveMutexTest]
-[PthreadMutexRecursiveDemo recursiveMutexTest2]
```

ä½¿ç”¨é€’å½’é”åï¼Œæ­»é”çš„é—®é¢˜ä¸å­˜åœ¨äº†ã€‚ä½†æ˜¯ï¼ŒåŠ äº†é€’å½’é”åçš„æ‰“å°ç»“æœè·Ÿæ²¡åŠ é”ä¸€æ ·ï¼Œè¿™æ ·è¢«åŠ é”çš„ä»£ç å—è¿˜å®‰å…¨å—ï¼Ÿå…¶å®ï¼Œé€’å½’é”åªå¯ä»¥åœ¨å½“å‰çº¿ç¨‹é‡å¤åŠ é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰çº¿ç¨‹åŠ é”åï¼Œåœ¨å½“å‰çº¿ç¨‹å†æ¬¡è°ƒç”¨ `- (void)recursiveMutexTest` æ–¹æ³•è¿˜å¯ä»¥é‡å¤åŠ é”ï¼Œè€Œå…¶å®ƒçº¿ç¨‹åœ¨æ­¤æ—¶è°ƒç”¨ `- (void)recursiveMutexTest` æ–¹æ³•æ—¶åˆ¤æ–­åˆ°å·²ç»åŠ è¿‡é”äº†å°±ä¸å†åŠ é”äº†ï¼Œä¼šè¿›å…¥ä¼‘çœ ç­‰å¾…è§£é”ã€‚

## pthread_mutex â€“ æ¡ä»¶

## NSLockã€NSRecursiveLock

## NSCondition

## NSConditionLock

## dispatch_semaphore

## dispatch_queue

## @synchronized

## è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ