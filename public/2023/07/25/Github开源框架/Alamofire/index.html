<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Swift," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Alamofire 用法 高级用法 相关文档： apple - Property Wrappers apple - Key Path Member Lookup Alamofire源码学习目录合集 链式调用与@dynamicMemberLookup SwiftUI 和 Swift 5.1 新特性(3) Key Path Member Lookup">
<meta name="keywords" content="Swift">
<meta property="og:type" content="article">
<meta property="og:title" content="Alamofire">
<meta property="og:url" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/index.html">
<meta property="og:site_name" content="Kevin&#39;s  blog">
<meta property="og:description" content="Alamofire 用法 高级用法 相关文档： apple - Property Wrappers apple - Key Path Member Lookup Alamofire源码学习目录合集 链式调用与@dynamicMemberLookup SwiftUI 和 Swift 5.1 新特性(3) Key Path Member Lookup">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/01.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/02.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/03.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/04.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/05.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/06.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/07.png">
<meta property="og:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/08.png">
<meta property="og:updated_time" content="2023-12-23T13:28:08.224Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Alamofire">
<meta name="twitter:description" content="Alamofire 用法 高级用法 相关文档： apple - Property Wrappers apple - Key Path Member Lookup Alamofire源码学习目录合集 链式调用与@dynamicMemberLookup SwiftUI 和 Swift 5.1 新特性(3) Key Path Member Lookup">
<meta name="twitter:image" content="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/"/>





  <title>Alamofire | Kevin's  blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a073c6e38282486853e19b272e9e7c34";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin's  blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/07/25/Github开源框架/Alamofire/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myAvatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's  blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Alamofire</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-07-25T16:03:03+08:00">
                2023-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://github.com/Alamofire/Alamofire/tree/master" target="_blank" rel="external">Alamofire</a></p>
<p><a href="https://github.com/Alamofire/Alamofire/blob/master/Documentation/Usage.md" target="_blank" rel="external">用法</a></p>
<p><a href="https://github.com/Alamofire/Alamofire/blob/master/Documentation/AdvancedUsage.md" target="_blank" rel="external">高级用法</a></p>
<p>相关文档：</p>
<p><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0258-property-wrappers.md" target="_blank" rel="external">apple - Property Wrappers</a></p>
<p><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0252-keypath-dynamic-member-lookup.md" target="_blank" rel="external">apple - Key Path Member Lookup</a></p>
<p><a href="https://juejin.cn/post/6914685327172960263/" target="_blank" rel="external">Alamofire源码学习目录合集</a></p>
<p><a href="https://juejin.cn/post/6844903863951032327" target="_blank" rel="external">链式调用与@dynamicMemberLookup</a></p>
<p><a href="https://juejin.cn/post/6844903863951032327" target="_blank" rel="external">SwiftUI 和 Swift 5.1 新特性(3) Key Path Member Lookup</a></p>
<a id="more"></a>
<h2 id="Protected"><a href="#Protected" class="headerlink" title="Protected"></a>Protected</h2><p>定义一个协议 <code>Lock</code>，让实现该协议的类拥有<code>lock()</code>、<code>unlock()</code>、<code>around()</code>能力，其中<code>lock()</code>、<code>unlock()</code>需要遵循协议的类自定义实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Lock</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">lock</span><span class="params">()</span></span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">unlock</span><span class="params">()</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Lock</span> </span>&#123;</div><div class="line">    <span class="comment">/// 在获取锁的同时执行返回值的闭包。</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Parameter closure: 要运行的闭包。</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Returns:           闭包生成的值。</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">around</span>&lt;T&gt;<span class="params">(<span class="number">_</span> closure: <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">T</span> &#123;</div><div class="line">        lock(); <span class="keyword">defer</span> &#123; unlock() &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">try</span> closure()</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/// 获取锁时执行闭包。</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">around</span><span class="params">(<span class="number">_</span> closure: <span class="params">()</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">Void</span>) <span class="keyword">rethrows</span> &#123;</div><div class="line">        lock(); <span class="keyword">defer</span> &#123; unlock() &#125;</div><div class="line">        <span class="keyword">try</span> closure()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义锁 <code>UnfairLock</code> 遵循 <code>Lock</code> 协议，并自定义实现<code>lock()</code>、<code>unlock()</code>能力。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UnfairLock</span>: <span class="title">Lock</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">let</span> unfairLock: os_unfair_lock_t</div><div class="line"></div><div class="line">    <span class="keyword">init</span>() &#123;</div><div class="line">        unfairLock = .allocate(capacity: <span class="number">1</span>)</div><div class="line">        unfairLock.initialize(to: os_unfair_lock())</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">deinit</span> &#123;</div><div class="line">        unfairLock.deinitialize(<span class="built_in">count</span>: <span class="number">1</span>)</div><div class="line">        unfairLock.deallocate()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">lock</span><span class="params">()</span></span> &#123;</div><div class="line">        os_unfair_lock_lock(unfairLock)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">fileprivate</span> <span class="function"><span class="keyword">func</span> <span class="title">unlock</span><span class="params">()</span></span> &#123;</div><div class="line">        os_unfair_lock_unlock(unfairLock)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 <code>@propertyWrapper</code> 和 <code>@dynamicMemberLookup</code> 两个批注，自定义属性包裹器 <code>Protected</code>，实现属性的读写安全。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">@propertyWrapper</div><div class="line">@dynamicMemberLookup</div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Protected</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">let</span> lock = <span class="type">UnfairLock</span>()</div><div class="line">    <span class="keyword">private</span> <span class="keyword">var</span> value: <span class="type">T</span></div><div class="line"></div><div class="line">    <span class="keyword">init</span>(<span class="number">_</span> value: <span class="type">T</span>) &#123;</div><div class="line">        <span class="keyword">self</span>.value = value</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// propertyWrapper修饰必须要有的属性, 用来保存包裹的值</span></div><div class="line">    <span class="comment">/// 只保证读写安全</span></div><div class="line">    <span class="keyword">var</span> wrappedValue: <span class="type">T</span> &#123;</div><div class="line">        <span class="keyword">get</span> &#123; lock.around &#123; value &#125; &#125;</div><div class="line">        <span class="keyword">set</span> &#123; lock.around &#123; value = newValue &#125; &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// projectedValue 是 Swift 的语法糖，支持 `$` 访问</span></div><div class="line">    <span class="keyword">var</span> projectedValue: <span class="type">Protected</span>&lt;<span class="type">T</span>&gt; &#123; <span class="keyword">self</span> &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// 允许为包装后的值提供初始值</span></div><div class="line">    <span class="keyword">init</span>(wrappedValue: <span class="type">T</span>) &#123;</div><div class="line">        value = wrappedValue</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// 同步读取或转换包含的值。</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Parameter closure: 要执行的闭包。</span></div><div class="line">    <span class="comment">///</span></div><div class="line">    <span class="comment">/// - Returns:           传递的闭包的返回值。</span></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">read</span>&lt;U&gt;<span class="params">(<span class="number">_</span> closure: <span class="params">(T)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">U</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">U</span> &#123;</div><div class="line">        <span class="keyword">try</span> lock.around &#123; <span class="keyword">try</span> closure(<span class="keyword">self</span>.value) &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// 同步修改受保护的值。</span></div><div class="line">    @discardableResult</div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">write</span>&lt;U&gt;<span class="params">(<span class="number">_</span> closure: <span class="params">(<span class="keyword">inout</span> T)</span></span></span> <span class="keyword">throws</span> -&gt; <span class="type">U</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">U</span> &#123;</div><div class="line">        <span class="keyword">try</span> lock.around &#123; <span class="keyword">try</span> closure(&amp;<span class="keyword">self</span>.value) &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">subscript</span>&lt;<span class="type">Property</span>&gt;(dynamicMember keyPath: <span class="type">WritableKeyPath</span>&lt;<span class="type">T</span>, <span class="type">Property</span>&gt;) -&gt; <span class="type">Property</span> &#123;</div><div class="line">        <span class="keyword">get</span> &#123; lock.around &#123; value[keyPath: keyPath] &#125; &#125;</div><div class="line">        <span class="keyword">set</span> &#123; lock.around &#123; value[keyPath: keyPath] = newValue &#125; &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">subscript</span>&lt;<span class="type">Property</span>&gt;(dynamicMember keyPath: <span class="type">KeyPath</span>&lt;<span class="type">T</span>, <span class="type">Property</span>&gt;) -&gt; <span class="type">Property</span> &#123;</div><div class="line">        lock.around &#123; value[keyPath: keyPath] &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>应用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">  @<span class="type">Protected</span></div><div class="line">  <span class="keyword">var</span> p: <span class="type">Int</span> = <span class="number">3</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> test = <span class="type">Test</span>()</div><div class="line"><span class="keyword">let</span> a = test.p   <span class="comment">// 3</span></div><div class="line"><span class="keyword">let</span> b = test.$p  <span class="comment">// 此时 b 为 Protected&lt;Int&gt; 类型，可以调用 Protected 类中定义的方法</span></div><div class="line">b.read &#123;</div><div class="line">  $<span class="number">0</span>             <span class="comment">// 3</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="string">"a = <span class="subst">\(a)</span>"</span>)  <span class="comment">// Prints "a = 3"</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"b = <span class="subst">\(b)</span>"</span>)  <span class="comment">// Prints "b = __lldb_expr_15.Protected&lt;Swift.Int&gt;"</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"b = <span class="subst">\(b.read&#123; $<span class="number">0</span> &#125;)</span>"</span>)  <span class="comment">// Prints "b = 3"</span></div></pre></td></tr></table></figure>
<h3 id="propertyWrapper"><a href="#propertyWrapper" class="headerlink" title="@propertyWrapper"></a>@propertyWrapper</h3><p>属性包装器是一种通用结构，用于封装属性的读写访问，或添加其他行为。比如限制可用的属性值、向读写访问添加额外逻辑、添加方法等。</p>
<p>Swift 5.1 为创建属性包装器提供了一种新的解决方案，使用<code>@propertyWrapper</code><strong>批注</strong>标记属性包装器。</p>
<p><code>wrappedValue</code>：使用<code>@propertyWrapper</code>的包装器，要求包装器对象必须包含一个<strong>被包装的值的非静态属性</strong>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// propertyWrapper修饰必须要有的属性, 用来保存包裹的值</span></div><div class="line"><span class="comment">/// 只保证读写安全</span></div><div class="line"><span class="keyword">var</span> wrappedValue: <span class="type">T</span> &#123;</div><div class="line">    <span class="keyword">get</span> &#123; lock.around &#123; value &#125; &#125;</div><div class="line">    <span class="keyword">set</span> &#123; lock.around &#123; value = newValue &#125; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/// 允许为包装后的值提供初始值</span></div><div class="line"><span class="keyword">init</span>(wrappedValue: <span class="type">T</span>) &#123;</div><div class="line">    value = wrappedValue</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>projectedValue</code>：<code>@propertyWrapper</code> 提供了另一种语法糖——投影值，通过在属性前加<code>$</code>前缀来访问属性值。</p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/01.png" alt="01"></p>
<h3 id="dynamicMemberLookup"><a href="#dynamicMemberLookup" class="headerlink" title="@dynamicMemberLookup"></a>@dynamicMemberLookup</h3><p><code>@dynamicMemberLookup</code> 称为<strong>动态成员查找</strong>，是Swift的一项功能特性，允许动态成员查找调用看起来像范文类型属性的常规调用。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> dic = [<span class="string">"name"</span>: <span class="string">"zhangsan"</span>]</div><div class="line"><span class="keyword">let</span> name = dic.name</div></pre></td></tr></table></figure>
<p><code>name</code>是从字典中查找的，而不是作为 <code>dic</code> 的属性访问的。</p>
<p>实现支持动态查找的<code>People</code>类：</p>
<ol>
<li>使用<code>@dynamicMemberLookup</code>标注<code>People</code>的类型；</li>
<li>实现 <code>subscript(dynamicMember key:)</code> 方法。</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@dynamicMemberLookup</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">People</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">var</span> <span class="built_in">map</span> = [<span class="string">"name"</span>: <span class="string">"zhangsna"</span>, <span class="string">"age"</span>: <span class="string">"18"</span>]</div><div class="line">  <span class="keyword">subscript</span>(dynamicMember key: <span class="type">String</span>) -&gt; <span class="type">String</span> &#123;</div><div class="line">    <span class="built_in">map</span>[key] ?? <span class="string">"undefine"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> zhangsan = <span class="type">People</span>()</div><div class="line"><span class="built_in">print</span>(<span class="string">"name = <span class="subst">\(zhangsan.name)</span>"</span>)  <span class="comment">// Prints "name = zhangsna"</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"age = <span class="subst">\(zhangsan.age)</span>"</span>)    <span class="comment">// Prints "age = 18"</span></div></pre></td></tr></table></figure>
<p>没有使用 <code>@dynamicMemberLookup</code> 标注的情况会报错：</p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/02.png" alt="02"></p>
<h4 id="1-KeyPath"><a href="#1-KeyPath" class="headerlink" title="1. KeyPath"></a>1. KeyPath</h4><p><code>KeyPath&lt;Root, Value&gt;</code> 泛型类型，用来表示从 <code>Root</code> 类型到 <code>Value</code> 属性的访问路径。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">  <span class="keyword">let</span> age: <span class="type">Int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> keyPath = \<span class="type">Person</span>.name</div><div class="line"><span class="keyword">let</span> p = <span class="type">Person</span>(name: <span class="string">"zhangsna"</span>, age: <span class="number">18</span>)</div><div class="line"><span class="built_in">print</span>(p[keyPath: keyPath])</div><div class="line"><span class="comment">// Prints "zhangsna"</span></div></pre></td></tr></table></figure>
<p>这里用到了一个语法 <code>\Person.name</code>，它的类型是 <code>KeyPath&lt;Person, String&gt;</code></p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/03.png" alt="03"></p>
<ul>
<li><p>同一类型 <code>KeyPath&lt;Root, Value&gt;</code> 可以代表多种获取路径：<code>KeyPath&lt;Person, Int&gt;</code> 既可以表示<code>\Person.age</code>，也可以表示<code>\Person.name.count</code>。</p>
</li>
<li><p>两个 KeyPath 可以拼接成一个新的 KeyPath：<code>KeyPath1</code> 的类型是 <code>KeyPath&lt;Person, String&gt;</code>，<code>\String.count</code> 的类型是 <code>KeyPath&lt;String, Int&gt;</code>，调用 <code>appending</code> 函数后变成了 <code>KeyPath&lt;Person, Int&gt;</code> 类型。</p>
</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> keyPath1 = \<span class="type">Person</span>.name</div><div class="line"><span class="keyword">let</span> keyPath2 = \<span class="type">String</span>.<span class="built_in">count</span></div><div class="line"><span class="keyword">let</span> keyPath3 = keyPath1.appending(path: \<span class="type">String</span>.<span class="built_in">count</span>)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(type(of: keyPath))   <span class="comment">// Prints "KeyPath&lt;Person, String&gt;"</span></div><div class="line"><span class="built_in">print</span>(type(of: keyPath2))  <span class="comment">// Prints "KeyPath&lt;String, Int&gt;"</span></div><div class="line"><span class="built_in">print</span>(type(of: keyPath3))  <span class="comment">// Prints "KeyPath&lt;Person, Int&gt;"</span></div></pre></td></tr></table></figure>
<ul>
<li><p><code>KeyPath</code> 是 <code>WriteableKeyPath</code> 的父类，<code>WriteableKeyPath</code> 是 <code>ReferenceWritableKeyPath</code> 的父类。</p>
</li>
<li><p><code>KeyPath</code> 的能力是最弱的，只能以只读的方式访问属性。</p>
</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> name: <span class="type">String</span></div><div class="line">  <span class="keyword">let</span> age: <span class="type">Int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> keyPath = \<span class="type">Person</span>.name</div><div class="line"><span class="keyword">let</span> p = <span class="type">Person</span>(name: <span class="string">"zhangsna"</span>, age: <span class="number">18</span>)</div><div class="line"><span class="built_in">print</span>(p[keyPath: keyPath])</div><div class="line"><span class="comment">// Prints "zhangsna"</span></div></pre></td></tr></table></figure>
<ul>
<li><code>WriteableKeyPath</code> 可以对可变属性进行读写操作。将 <code>let</code> 改成 <code>var</code>，则 <code>person.name</code> 的类型就变成了 <code>WriteableKeyPath</code>，可以直接修改 <code>p[keyPath: keyPath] = &quot;lisi&quot;</code></li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> name: <span class="type">String</span></div><div class="line">  <span class="keyword">let</span> age: <span class="type">Int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> keyPath = \<span class="type">Person</span>.name</div><div class="line"><span class="keyword">var</span> p = <span class="type">Person</span>(name: <span class="string">"zhangsna"</span>, age: <span class="number">18</span>)</div><div class="line">p[keyPath: keyPath] = <span class="string">"lisi"</span></div><div class="line"><span class="built_in">print</span>(p[keyPath: keyPath])</div><div class="line"><span class="comment">// Prints "lisi"</span></div></pre></td></tr></table></figure>
<ul>
<li><code>ReferenceWritableKeyPath</code> 可以对<strong>引用类型</strong>的可变属性进行写入。将<code>struct</code>改成<code>class</code>，则 <code>Person.name</code> 的类型变成 <code>ReferenceWritableKeyPath</code></li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> name: <span class="type">String</span> = <span class="string">""</span></div><div class="line">  <span class="keyword">let</span> age: <span class="type">Int</span> = <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> keyPath = \<span class="type">Person</span>.name</div><div class="line"><span class="keyword">var</span> p = <span class="type">Person</span>()</div><div class="line">p[keyPath: keyPath] = <span class="string">"lisi"</span></div><div class="line"><span class="built_in">print</span>(p[keyPath: keyPath])</div><div class="line"><span class="comment">// Prints "lisi"</span></div></pre></td></tr></table></figure>
<h4 id="2-动态成员查找-Dynamic-Member-Lookup"><a href="#2-动态成员查找-Dynamic-Member-Lookup" class="headerlink" title="2. 动态成员查找 Dynamic Member Lookup"></a>2. 动态成员查找 Dynamic Member Lookup</h4><p>Swift4.2 引入了<strong>动态成员查找</strong>特性，实现使用静态的语法做动态的查找。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@dynamicMemberLookup</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">People</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">var</span> <span class="built_in">map</span> = [<span class="string">"name"</span>: <span class="string">"zhangsna"</span>, <span class="string">"age"</span>: <span class="string">"18"</span>]</div><div class="line">  <span class="keyword">subscript</span>(dynamicMember key: <span class="type">String</span>) -&gt; <span class="type">String</span> &#123;</div><div class="line">    <span class="built_in">map</span>[key] ?? <span class="string">"undefine"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> zhangsan = <span class="type">People</span>()</div><div class="line"><span class="built_in">print</span>(<span class="string">"name = <span class="subst">\(zhangsan.name)</span>"</span>)  <span class="comment">// Prints "name = zhangsna"</span></div><div class="line"><span class="built_in">print</span>(<span class="string">"age = <span class="subst">\(zhangsan.age)</span>"</span>)    <span class="comment">// Prints "age = 18"</span></div></pre></td></tr></table></figure>
<p>支持动态成员查找的类型首先需要用 <code>@dynamicMemberLookup</code> 来修饰，然后实现动态查找方法<code>subscript(dynamicMember member: String)</code>。</p>
<p>直接使用 <code>.property</code> 的语法访问属性<strong>貌似静态实则动态</strong>，该语法实际上调用的是<code>subscript(dynamicMember member: String)</code>方法。</p>
<h4 id="3-成员查找-Key-Path-Member-Lookup"><a href="#3-成员查找-Key-Path-Member-Lookup" class="headerlink" title="3. 成员查找 Key Path Member Lookup"></a>3. 成员查找 Key Path Member Lookup</h4><p>Swift5.1 引入的成员查找。</p>
<p>编译器可以从 <code>KeyPath</code> 查询所有的目标，以及它们的类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@dynamicMemberLookup</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Info</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> name: <span class="type">String</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">var</span> info: <span class="type">Info</span></div><div class="line">  <span class="keyword">subscript</span>&lt;<span class="type">Property</span>&gt;(dynamicMember keyPath: <span class="type">WritableKeyPath</span>&lt;<span class="type">Info</span>, <span class="type">Property</span>&gt;) -&gt; <span class="type">Property</span> &#123;</div><div class="line">    <span class="keyword">get</span> &#123; info[keyPath: keyPath] &#125;</div><div class="line">    <span class="keyword">set</span> &#123; info[keyPath: keyPath] = newValue &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> person = <span class="type">Person</span>(info: <span class="type">Person</span>.<span class="type">Info</span>(name: <span class="string">"zhangsan"</span>))</div><div class="line">person.name = <span class="string">"lisi"</span></div><div class="line"><span class="built_in">print</span>(person.name)</div><div class="line"><span class="comment">// Prints "lisi"</span></div></pre></td></tr></table></figure>
<p><code>person.info.name</code> 可以直接写成 <code>person.name</code>。</p>
<p><code>@dynamicMemberLookup</code> 非常适用于包装类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> name: <span class="type">String</span></div><div class="line">  <span class="keyword">var</span> age: <span class="type">Int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">@dynamicMemberLookup</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Wrapper</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">var</span> value: <span class="type">T</span></div><div class="line"></div><div class="line">  <span class="keyword">init</span>(value: <span class="type">T</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.value = value</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">subscript</span>&lt;<span class="type">Property</span>&gt;(dynamicMember keyPath: <span class="type">WritableKeyPath</span>&lt;<span class="type">T</span>, <span class="type">Property</span>&gt;) -&gt; <span class="type">Property</span> &#123;</div><div class="line">    <span class="keyword">get</span> &#123; value[keyPath: keyPath] &#125;</div><div class="line">    <span class="keyword">set</span> &#123; value[keyPath: keyPath] = newValue &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> teacher = <span class="type">Wrapper</span>(value: <span class="type">Person</span>(name: <span class="string">"zhangsan"</span>, age: <span class="number">18</span>))</div><div class="line">teacher.age = <span class="number">35</span></div><div class="line"><span class="built_in">print</span>(teacher.age)</div><div class="line"><span class="comment">// Prints "35"</span></div></pre></td></tr></table></figure>
<h4 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h4><p>通过回传 <code>self</code>，实现链式调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Label</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> text: <span class="type">String</span>?</div><div class="line">  <span class="keyword">var</span> textColor: <span class="type">UIColor</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/// setter</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Label</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">text</span><span class="params">(<span class="number">_</span> text: String)</span></span> -&gt; <span class="type">Label</span> &#123;</div><div class="line">    <span class="keyword">self</span>.text = text</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">textColor</span><span class="params">(<span class="number">_</span> textColor: UIColor)</span></span> -&gt; <span class="type">Label</span> &#123;</div><div class="line">    <span class="keyword">self</span>.textColor = textColor</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">Label</span>()</div><div class="line">  .text(<span class="string">"name"</span>)</div><div class="line">  .textColor(.black)</div></pre></td></tr></table></figure>
<p>这种方法被动性比较大，如果 <code>Label</code> 的属性变化，则对应的 <code>setter</code> 方法也得改变。</p>
<p>使用<strong>动态成员查找</strong>实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Label</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> text: <span class="type">String</span>?</div><div class="line">  <span class="keyword">var</span> textColor: <span class="type">UIColor</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line">@dynamicMemberLookup</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Setter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">var</span> object: <span class="type">T</span></div><div class="line">  </div><div class="line">  <span class="keyword">subscript</span>&lt;<span class="type">Property</span>&gt;(dynamicMember keyPath: <span class="type">WritableKeyPath</span>&lt;<span class="type">T</span>, <span class="type">Property</span>&gt;) -&gt; ((<span class="type">Property</span>) -&gt; <span class="type">Setter</span>&lt;<span class="type">T</span>&gt;) &#123;</div><div class="line">    <span class="comment">// 获取到真正的对象</span></div><div class="line">    <span class="keyword">var</span> object = <span class="keyword">self</span>.object</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> &#123; newValue <span class="keyword">in</span></div><div class="line">      object[keyPath: keyPath] = newValue</div><div class="line">      <span class="comment">// 因为使用 Setter 链式调用，而不是 object 本身，所以回传的类型是 Setter，而不是 object</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">self</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> s = <span class="type">Setter</span>(object: <span class="type">Label</span>()).text(<span class="string">"zhangsan"</span>).textColor(.blue).object</div><div class="line"><span class="built_in">print</span>(s.text)</div><div class="line"><span class="comment">// Prints "Optional("zhangsan")"</span></div></pre></td></tr></table></figure>
<p>创建一个 <code>UILabel</code>：</p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/04.png" alt="04"></p>
<h2 id="线程安全的属性-MutableState"><a href="#线程安全的属性-MutableState" class="headerlink" title="线程安全的属性 MutableState"></a>线程安全的属性 MutableState</h2><p>在 Request.swift 文件中，Alamofire 使用 <code>@Protected</code> 标注，实现了一个线程安全的对象 <code>mutableState</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 受保护的`MutableState`值，该值提供对状态值的线程安全访问。</span></div><div class="line">@<span class="type">Protected</span></div><div class="line"><span class="keyword">fileprivate</span> <span class="keyword">var</span> mutableState = <span class="type">MutableState</span>()</div></pre></td></tr></table></figure>
<p><code>MutableState</code> 中定义了很多变量，这些变量可能在异步线程调用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 封装可变状态的类型，他们可能在从“underlyingQueue”以外的任何位置访问。</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MutableState</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/// `Request`的状态</span></div><div class="line">    <span class="keyword">var</span> state: <span class="type">State</span> = .initialized</div><div class="line">    </div><div class="line">    <span class="comment">/// 为上传进度回调提供的`ProgressHandler`和`DispatchQueue`。</span></div><div class="line">    <span class="keyword">var</span> uploadProgressHandler: (handler: <span class="type">ProgressHandler</span>, queue: <span class="type">DispatchQueue</span>)?</div><div class="line">    </div><div class="line">    <span class="comment">/// 为下载进度回调提供的`ProgressHandler`和`DispatchQueue`。</span></div><div class="line">    <span class="keyword">var</span> downloadProgressHandler: (handler: <span class="type">ProgressHandler</span>, queue: <span class="type">DispatchQueue</span>)?</div><div class="line">    </div><div class="line">    <span class="comment">/// 为处理请求重定向提供的`RedirectHandler`</span></div><div class="line">    <span class="keyword">var</span> redirectHandler: <span class="type">RedirectHandler</span>?</div><div class="line">    </div><div class="line">    <span class="comment">/// 为处理响应缓存提供的`CachedResponseHandler`</span></div><div class="line">    <span class="keyword">var</span> cachedResponseHandler: <span class="type">CachedResponseHandler</span>?</div><div class="line">    </div><div class="line">    <span class="comment">/// 当`Request`能够创建其自身的cURL描述时，调用队列和闭包。</span></div><div class="line">    <span class="keyword">var</span> cURLHandler: (queue: <span class="type">DispatchQueue</span>, handler: (<span class="type">String</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    </div><div class="line">    <span class="comment">/// 当`Request`创建`URLRequest`时调用队列和闭包。</span></div><div class="line">    <span class="keyword">var</span> urlRequestHandler: (queue: <span class="type">DispatchQueue</span>, handler: (<span class="type">URLRequest</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    </div><div class="line">    <span class="comment">/// `Request`创建`URLSessionTask`时调用的队列和闭包。</span></div><div class="line">    <span class="keyword">var</span> urlSessionTaskHandler: (queue: <span class="type">DispatchQueue</span>, handler: (<span class="type">URLSessionTask</span>) -&gt; <span class="type">Void</span>)?</div><div class="line">    </div><div class="line">    <span class="comment">/// 处理响应解析的响应序列化闭包。</span></div><div class="line">    <span class="keyword">var</span> responseSerializers: [() -&gt; <span class="type">Void</span>] = []</div><div class="line">    </div><div class="line">    <span class="comment">/// 所有响应序列化程序完成后执行的响应序列化完成闭包。</span></div><div class="line">    <span class="keyword">var</span> responseSerializerCompletions: [() -&gt; <span class="type">Void</span>] = []</div><div class="line">    </div><div class="line">    <span class="comment">/// 响应序列化程序处理是否完成。</span></div><div class="line">    <span class="keyword">var</span> responseSerializerProcessingFinished = <span class="literal">false</span></div><div class="line">    </div><div class="line">    <span class="comment">/// `URLCredential `用于身份验证质询。</span></div><div class="line">    <span class="keyword">var</span> credential: <span class="type">URLCredential</span>?</div><div class="line">    </div><div class="line">    <span class="comment">/// Alamofire代表请求创建的所有URLRequest。</span></div><div class="line">    <span class="keyword">var</span> requests: [<span class="type">URLRequest</span>] = []</div><div class="line">    </div><div class="line">    <span class="comment">/// Alamofire代表请求创建的所有URLSessionTask。</span></div><div class="line">    <span class="keyword">var</span> tasks: [<span class="type">URLSessionTask</span>] = []</div><div class="line">    </div><div class="line">    <span class="comment">/// Alamofire代表`Request`收集的所有`URLSessionTaskMetrics`值。应与创建的“任务”完全对应。</span></div><div class="line">    <span class="comment">/// 「PS：对发送请求/DNS查询/TLS握手/请求响应等各种环节时间上的统计」</span></div><div class="line">    <span class="keyword">var</span> metrics: [<span class="type">URLSessionTaskMetrics</span>] = []</div><div class="line">    </div><div class="line">    <span class="comment">/// 提供的任何重试器重试“请求”的次数。</span></div><div class="line">    <span class="keyword">var</span> retryCount = <span class="number">0</span></div><div class="line">    </div><div class="line">    <span class="comment">/// `Request`的最终`AFError`，无论是来自各种内部Alamofire调用还是作为“任务”的结果。</span></div><div class="line">    <span class="keyword">var</span> error: <span class="type">AFError</span>?</div><div class="line">    </div><div class="line">    <span class="comment">/// 实例是否已调用`finish()`并正在运行序列化程序。将来应该用状态机中的表示替换。</span></div><div class="line">    <span class="keyword">var</span> isFinishing = <span class="literal">false</span></div><div class="line">    </div><div class="line">    <span class="comment">/// 请求完成时要运行的操作。用于并发支持。</span></div><div class="line">    <span class="keyword">var</span> finishHandlers: [() -&gt; <span class="type">Void</span>] = []</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 当代表实例创建了初始“URLRequest”时调用。如果“RequestAdapter”处于活跃状态，则“URLRequest”将在发出之前进行调整。</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// - Parameter request: 已创建“URLRequest”。</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">didCreateInitialURLRequest</span><span class="params">(<span class="number">_</span> request: URLRequest)</span></span> &#123;</div><div class="line">    dispatchPrecondition(condition: .onQueue(underlyingQueue))</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">    1. 通过 $mutableState.write 调用一个线程安全的闭包，`$` 保证闭包线程安全</span></div><div class="line"><span class="comment">    2. 将 request 添加到 .requets 数组中，`$` 保证 setter 方法线程安全</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    $mutableState.write &#123; $<span class="number">0</span>.requests.append(request) &#125;</div><div class="line"></div><div class="line">    eventMonitor?.request(<span class="keyword">self</span>, didCreateInitialURLRequest: request)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 完成此“请求”并启动响应序列化程序。</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// - Parameter error: 实例结束时可能出现的“错误”。</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">finish</span><span class="params">(error: AFError? = <span class="literal">nil</span>)</span></span> &#123;</div><div class="line">   dispatchPrecondition(condition: .onQueue(underlyingQueue))</div><div class="line"></div><div class="line">   <span class="keyword">guard</span> !$mutableState.isFinishing <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line"></div><div class="line">   <span class="comment">// `$` 保证了 setter 方法是线程安全的</span></div><div class="line">   $mutableState.isFinishing = <span class="literal">true</span></div><div class="line"></div><div class="line">   <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123; <span class="keyword">self</span>.error = error &#125;</div><div class="line"></div><div class="line">   <span class="comment">// Start response handlers</span></div><div class="line">   processNextResponseSerializer()</div><div class="line"></div><div class="line">   eventMonitor?.requestDidFinish(<span class="keyword">self</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="AlamofireExtended"><a href="#AlamofireExtended" class="headerlink" title="AlamofireExtended"></a>AlamofireExtended</h2><p>Alamofire 扩展包裹器，用来对系统类进行扩展时包裹使用，避免方法入侵。</p>
<h3 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h3><p>通过添加全局方法的方式扩展两个新的方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">method2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> button = <span class="type">UIButton</span>(type: .custom)</div><div class="line">button.method1()</div></pre></td></tr></table></figure>
<p>通过这种方式添加的方法，在所有能访问到该扩展的地方都可以调用。调用时，扩展的方法直接出现在 <code>UIButton</code> 提示的方法列表中。这有一个问题，一方面会给调用者造成困惑，另一方发面会存在同名的风险，造成方法污染👇：</p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/05.png" alt="05"></p>
<h3 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h3><p>写一个包裹器，将 UIButton 包裹起来，在包裹器中添加需要扩展的方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UIButtonWrapper</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> button: <span class="type">UIButton</span></div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">method1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">method2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> wrapper: <span class="type">UIButtonWrapper</span> &#123;</div><div class="line">    <span class="keyword">get</span> &#123; <span class="type">UIButtonWrapper</span>.<span class="keyword">init</span>(button: <span class="keyword">self</span>) &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> button = <span class="type">UIButton</span>(type: .custom)</div><div class="line">button.wrapper.method1()</div></pre></td></tr></table></figure>
<p>通过实现一个包裹器<code>wrapper</code>，扩展的方法只会出现在<code>wrapper</code>的调用提示方法列表里，<code>UIButton</code>的调用提示方法列表里只新增了一个 wrapper，从而避免了对<code>UIButton</code>的方法污染。</p>
<p><code>UIButtonWrapper</code> 是针对<code>UIButton</code>设计的一个包裹器，只适用于UIButton。可以借用Swift<strong>泛型</strong>与<strong>扩展约束</strong>的力量，实现一个泛型包裹器，从而实现为需要的任何类型扩展方法。</p>
<h3 id="第三种方式"><a href="#第三种方式" class="headerlink" title="第三种方式"></a>第三种方式</h3><p>使用泛型和扩展约束，实现一个泛型包裹器：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">AlamofireExtension</span>&lt;<span class="title">ExtendedType</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> type: <span class="type">ExtendedType</span></div><div class="line">  </div><div class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> type: <span class="type">ExtendedType</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.type = type</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MARK: —— UIButton Extension</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtension</span> <span class="title">where</span> <span class="title">ExtendedType</span> == <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">UIButton</span>&gt; &#123;</div><div class="line">    <span class="comment">// AlamofireExtension.init(self)</span></div><div class="line">    <span class="keyword">get</span> &#123; <span class="type">AlamofireExtension</span>(<span class="keyword">self</span>) &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MARK: —— UILabel Extension</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtension</span> <span class="title">where</span> <span class="title">ExtendedType</span> == <span class="title">UILabel</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForLabel1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForLabel2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UILabel</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">UILabel</span>&gt; &#123;</div><div class="line">    <span class="keyword">get</span> &#123; <span class="type">AlamofireExtension</span>(<span class="keyword">self</span>) &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> button = <span class="type">UIButton</span>(type: .custom)</div><div class="line">button.af.methodForButton1()</div><div class="line"></div><div class="line"><span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">label.af.methodForLabel1()</div></pre></td></tr></table></figure>
<p>通过泛型 <code>AlamofireExtension&lt;ExtendedType&gt;</code> 实现了对<code>UIButton</code>和<code>UILabel</code>的同时支持，扩展约束 <code>where ExtendedType == UIButton</code> 实现了对<code>UIButton</code>和<code>UILabel</code>扩展方法的区分，这种区分可以从调用提示方法列表中看出来：</p>
<p><code>UILabel</code>提示方法列表：<br><img src="/2023/07/25/Github开源框架/Alamofire/06.png" alt="06"></p>
<p><code>UIButton</code>提示方法列表：<br><img src="/2023/07/25/Github开源框架/Alamofire/07.png" alt="07"></p>
<p>通过<code>UIButton</code>和<code>UILabel</code>的扩展方式可以看出，在为类型扩展方法时，首先需要添加 <code>af</code> 计算属性来返回泛型包裹器<code>AlamofireExtension&lt;ExtendedType&gt;</code>。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">UIButton</span>&gt; &#123;</div><div class="line">  <span class="comment">// AlamofireExtension.init(self)</span></div><div class="line">  <span class="keyword">get</span> &#123; <span class="type">AlamofireExtension</span>(<span class="keyword">self</span>) &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以使用<strong>泛型协议</strong>和<strong>扩展</strong>的方式，添加默认实现，从而省略掉这一步。</p>
<h3 id="第四种方式"><a href="#第四种方式" class="headerlink" title="第四种方式"></a>第四种方式</h3><p>使用<strong>泛型协议</strong>和<strong>扩展</strong>的，实现<code>af</code>计算属性：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MARK: —— 通用扩展类型</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">AlamofireExtension</span>&lt;<span class="title">ExtendedType</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> type: <span class="type">ExtendedType</span></div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(<span class="number">_</span> type: <span class="type">ExtendedType</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.type = type</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// MARK: —— 描述“通用拓展类型”的协议</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">AlamofireExtended</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 正在扩展的类型</span></div><div class="line">  associatedtype <span class="type">ExtendedType</span></div><div class="line">  </div><div class="line">  <span class="comment">// 静态包裹器</span></div><div class="line">  <span class="keyword">static</span> <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">ExtendedType</span>&gt;.<span class="type">Type</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 实例包裹器</span></div><div class="line">  <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">ExtendedType</span>&gt; &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtended</span> </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 静态包裹器默认实现</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">Self</span>&gt;.<span class="type">Type</span> &#123;</div><div class="line">    <span class="keyword">get</span> &#123; <span class="type">AlamofireExtension</span>&lt;<span class="type">Self</span>&gt;.<span class="keyword">self</span> &#125;</div><div class="line">    <span class="keyword">set</span> &#123;&#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="comment">// 实例包裹器默认实现</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">var</span> af: <span class="type">AlamofireExtension</span>&lt;<span class="type">Self</span>&gt; &#123;</div><div class="line">    <span class="keyword">get</span> &#123; <span class="type">AlamofireExtension</span>(<span class="keyword">self</span>) &#125;</div><div class="line">    <span class="keyword">set</span> &#123;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>应用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 扩展方法</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtension</span> <span class="title">where</span> <span class="title">ExtendedType</span> == <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtension</span> <span class="title">where</span> <span class="title">ExtendedType</span> == <span class="title">UILabel</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForLabel1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForLabel2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 采纳协议</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UIButton</span>: <span class="title">AlamofireExtended</span> </span>&#123;&#125;</div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">UILabel</span>: <span class="title">AlamofireExtended</span> </span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">let</span> button = <span class="type">UIButton</span>()</div><div class="line">button.af.methodForButton1()</div><div class="line"></div><div class="line"><span class="keyword">let</span> label = <span class="type">UILabel</span>()</div><div class="line">label.af.methodForLabel1()</div></pre></td></tr></table></figure>
<p>静态包裹器扩展了类型方法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AlamofireExtension</span> <span class="title">where</span> <span class="title">ExtendedType</span> == <span class="title">UIButton</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton1</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">methodForButton2</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">methodForButton3</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">methodForButton4</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="type">UIButton</span>.af.methodForButton3()</div></pre></td></tr></table></figure>
<p>扩展的类型方法，也有对应的提示方法列表：</p>
<p><img src="/2023/07/25/Github开源框架/Alamofire/08.png" alt="08"></p>
<h2 id="EventMonitor"><a href="#EventMonitor" class="headerlink" title="EventMonitor"></a>EventMonitor</h2><p><code>protocol EventMonitor</code> 协议概述了 Alamofire 生命周期里的内部事件。EventMonitor 既包括从各种 <code>URLSession</code> 委托协议接收的事件，也包括<code>Request</code> 及其子类生命周期内的各种事件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">EventMonitor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/// 调度事件的调度队列，默认是主队列</span></div><div class="line">    <span class="keyword">var</span> queue: <span class="type">DispatchQueue</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"></div><div class="line">    <span class="comment">// MARK: - URLSession Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: URLSessionDelegate Events</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: URLSessionTaskDelegate Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: URLSessionDataDelegate Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: URLSessionDownloadDelegate Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: - Request Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: DataRequest Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: DataStreamRequest Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: UploadRequest Events</span></div><div class="line"></div><div class="line">    <span class="comment">// MARK: DownloadRequest Events</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实例代码中只展示了<code>URLSessionDelegate</code>协议相关方法的声明，其它协议的声明省略。</p>
<p>在 <code>EventMonitor</code> 协议声明完方法后，还要对这些方法提供默认实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">EventMonitor</span> </span>&#123;</div><div class="line">  </div><div class="line">    <span class="comment">/// 调度事件的调度队列，默认是主队列</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> queue: <span class="type">DispatchQueue</span> &#123; .main &#125;</div><div class="line"></div><div class="line">    <span class="comment">// MARK: Default Implementations</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           task: URLSessionTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didReceive challenge: URLAuthenticationChallenge)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           task: URLSessionTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didSendBodyData bytesSent: Int64,</span></span></div><div class="line"><span class="function"><span class="params">                           totalBytesSent: Int64,</span></span></div><div class="line"><span class="function"><span class="params">                           totalBytesExpectedToSend: Int64)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, taskNeedsNewBodyStream task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           task: URLSessionTask,</span></span></div><div class="line"><span class="function"><span class="params">                           willPerformHTTPRedirection response: HTTPURLResponse,</span></span></div><div class="line"><span class="function"><span class="params">                           newRequest request: URLRequest)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           task: URLSessionTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didFinishCollecting metrics: URLSessionTaskMetrics)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, taskIsWaitingForConnectivity task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, dataTask: URLSessionDataTask, didReceive data: Data)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           dataTask: URLSessionDataTask,</span></span></div><div class="line"><span class="function"><span class="params">                           willCacheResponse proposedResponse: CachedURLResponse)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           downloadTask: URLSessionDownloadTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didResumeAtOffset fileOffset: Int64,</span></span></div><div class="line"><span class="function"><span class="params">                           expectedTotalBytes: Int64)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           downloadTask: URLSessionDownloadTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didWriteData bytesWritten: Int64,</span></span></div><div class="line"><span class="function"><span class="params">                           totalBytesWritten: Int64,</span></span></div><div class="line"><span class="function"><span class="params">                           totalBytesExpectedToWrite: Int64)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           downloadTask: URLSessionDownloadTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didFinishDownloadingTo location: URL)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCreateInitialURLRequest urlRequest: URLRequest)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didFailToCreateURLRequestWithError error: AFError)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request,</span></span></div><div class="line"><span class="function"><span class="params">                        didAdaptInitialRequest initialRequest: URLRequest,</span></span></div><div class="line"><span class="function"><span class="params">                        to adaptedRequest: URLRequest)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request,</span></span></div><div class="line"><span class="function"><span class="params">                        didFailToAdaptURLRequest initialRequest: URLRequest,</span></span></div><div class="line"><span class="function"><span class="params">                        withError error: AFError)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCreateURLRequest urlRequest: URLRequest)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCreateTask task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didGatherMetrics metrics: URLSessionTaskMetrics)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didFailTask task: URLSessionTask, earlyWithError error: AFError)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCompleteTask task: URLSessionTask, with error: AFError?)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestIsRetrying</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidFinish</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidResume</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didResumeTask task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidSuspend</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didSuspendTask task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidCancel</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCancelTask task: URLSessionTask)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DataRequest,</span></span></div><div class="line"><span class="function"><span class="params">                        didValidateRequest urlRequest: URLRequest?,</span></span></div><div class="line"><span class="function"><span class="params">                        response: HTTPURLResponse,</span></span></div><div class="line"><span class="function"><span class="params">                        data: Data?,</span></span></div><div class="line"><span class="function"><span class="params">                        withResult result: Request.ValidationResult)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DataRequest, didParseResponse response: DataResponse&lt;Data?, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span>&lt;Value&gt;<span class="params">(<span class="number">_</span> request: DataRequest, didParseResponse response: DataResponse&lt;Value, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DataStreamRequest,</span></span></div><div class="line"><span class="function"><span class="params">                        didValidateRequest urlRequest: URLRequest?,</span></span></div><div class="line"><span class="function"><span class="params">                        response: HTTPURLResponse,</span></span></div><div class="line"><span class="function"><span class="params">                        withResult result: Request.ValidationResult)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span>&lt;Value&gt;<span class="params">(<span class="number">_</span> request: DataStreamRequest, didParseStream result: Result&lt;Value, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: UploadRequest, didCreateUploadable uploadable: UploadRequest.Uploadable)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: UploadRequest, didFailToCreateUploadableWithError error: AFError)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: UploadRequest, didProvideInputStream stream: InputStream)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DownloadRequest, didFinishDownloadingUsing task: URLSessionTask, with result: Result&lt;URL, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DownloadRequest, didCreateDestinationURL url: URL)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DownloadRequest,</span></span></div><div class="line"><span class="function"><span class="params">                        didValidateRequest urlRequest: URLRequest?,</span></span></div><div class="line"><span class="function"><span class="params">                        response: HTTPURLResponse,</span></span></div><div class="line"><span class="function"><span class="params">                        fileURL: URL?,</span></span></div><div class="line"><span class="function"><span class="params">                        withResult result: Request.ValidationResult)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: DownloadRequest, didParseResponse response: DownloadResponse&lt;URL?, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span>&lt;Value&gt;<span class="params">(<span class="number">_</span> request: DownloadRequest, didParseResponse response: DownloadResponse&lt;Value, AFError&gt;)</span></span> &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 <code>EventMonitor</code> 协议包含了 URLSession 和 Request 的各种事件，所以方法比较多。实现中什么也没做，只是提供了默认实现。</p>
<p><code>EventMonitor</code> 协议就像一个显示器，完整且全面的展示了 Alamofire 内部发生的各种事件，透过它可以大概了解 Alamofire 都做了些什么。然而，<code>EventMonitor</code> 只是一个抽象类，在Alamofire的逻辑代码部分用到的并不是它，而是遵循了 <code>EventMonitor</code> 协议的类 <code>CompositeEventMonitor</code>，负责处理 Alamofire 中的各种事件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// `EventMonitor`包含在所有实例中。`[AlamofireNotifications（）]`默认情况下。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">let</span> defaultEventMonitors: [<span class="type">EventMonitor</span>] = [<span class="type">AlamofireNotifications</span>()]</div><div class="line"></div><div class="line"><span class="comment">/// Session 的初始化方法</span></div><div class="line"><span class="comment">///   - eventMonitors:            实例使用的其他“EventMonitor”们（自定义）。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">init</span>(session: <span class="type">URLSession</span>,</div><div class="line">          delegate: <span class="type">SessionDelegate</span>,</div><div class="line">          rootQueue: <span class="type">DispatchQueue</span>,</div><div class="line">          startRequestsImmediately: <span class="type">Bool</span> = <span class="literal">true</span>,</div><div class="line">          requestQueue: <span class="type">DispatchQueue</span>? = <span class="literal">nil</span>,</div><div class="line">          serializationQueue: <span class="type">DispatchQueue</span>? = <span class="literal">nil</span>,</div><div class="line">          interceptor: <span class="type">RequestInterceptor</span>? = <span class="literal">nil</span>,</div><div class="line">          serverTrustManager: <span class="type">ServerTrustManager</span>? = <span class="literal">nil</span>,</div><div class="line">          redirectHandler: <span class="type">RedirectHandler</span>? = <span class="literal">nil</span>,</div><div class="line">          cachedResponseHandler: <span class="type">CachedResponseHandler</span>? = <span class="literal">nil</span>,</div><div class="line">          eventMonitors: [<span class="type">EventMonitor</span>] = []) &#123;</div><div class="line">  <span class="built_in">precondition</span>(session.configuration.identifier == <span class="literal">nil</span>,</div><div class="line">               <span class="string">"Alamofire does not support background URLSessionConfigurations."</span>)</div><div class="line">  <span class="built_in">precondition</span>(session.delegateQueue.underlyingQueue === rootQueue,</div><div class="line">               <span class="string">"Session(session:) initializer must be passed the DispatchQueue used as the delegateQueue's underlyingQueue as rootQueue."</span>)</div><div class="line"></div><div class="line">  <span class="keyword">self</span>.session = session</div><div class="line">  <span class="keyword">self</span>.delegate = delegate</div><div class="line">  </div><div class="line">  <span class="comment">// ...</span></div><div class="line"></div><div class="line">  <span class="comment">// 设置内部事件监听器们</span></div><div class="line">  eventMonitor = <span class="type">CompositeEventMonitor</span>(monitors: defaultEventMonitors + eventMonitors)</div><div class="line">  delegate.eventMonitor = eventMonitor</div><div class="line"></div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="CompositeEventMonitor"><a href="#CompositeEventMonitor" class="headerlink" title="CompositeEventMonitor"></a>CompositeEventMonitor</h3><p><code>CompositeEventMonitor</code>，负责处理 Alamofire 中的各种事件。从命名就可以看出，这是一个<strong>批量处理事件</strong>的“管理类”，可以称为事件监视器集合。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeEventMonitor</span>: <span class="title">EventMonitor</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">let</span> queue = <span class="type">DispatchQueue</span>(label: <span class="string">"org.alamofire.compositeEventMonitor"</span>, qos: .utility)</div><div class="line"></div><div class="line">    <span class="keyword">let</span> monitors: [<span class="type">EventMonitor</span>]</div><div class="line"></div><div class="line">    <span class="keyword">init</span>(monitors: [<span class="type">EventMonitor</span>]) &#123;</div><div class="line">        <span class="keyword">self</span>.monitors = monitors</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">performEvent</span><span class="params">(<span class="number">_</span> event: @escaping <span class="params">(EventMonitor)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">        queue.async &#123;</div><div class="line">            <span class="keyword">for</span> monitor <span class="keyword">in</span> <span class="keyword">self</span>.monitors &#123;</div><div class="line">                monitor.queue.async &#123; event(monitor) &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span> &#123;</div><div class="line">        performEvent &#123; $<span class="number">0</span>.urlSession(session, didBecomeInvalidWithError: error) &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession,</span></span></div><div class="line"><span class="function"><span class="params">                           task: URLSessionTask,</span></span></div><div class="line"><span class="function"><span class="params">                           didReceive challenge: URLAuthenticationChallenge)</span></span> &#123;</div><div class="line">        performEvent &#123; $<span class="number">0</span>.urlSession(session, task: task, didReceive: challenge) &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 省略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CompositeEventMonitor</code> 遵循了 <code>EventMonitor</code> 协议，并且实现了全部方法。这里也只提供两个方法，其它方法省略。</p>
<p><code>CompositeEventMonitor</code> 实现这些方法为了是使用队列来调度方法的调用，所以方法实现部分都是一样的，都调用了 <code>performEvent</code> 方法:</p>
<ol>
<li>在 Session 和 Request 事件回调时，最终都会来到 <code>performEvent</code> 方法；</li>
<li>依次取出数组里的事件监视器，放到同步队列里执行。</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">performEvent</span><span class="params">(<span class="number">_</span> event: @escaping <span class="params">(EventMonitor)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">  queue.async &#123;</div><div class="line">      <span class="keyword">for</span> monitor <span class="keyword">in</span> <span class="keyword">self</span>.monitors &#123;</div><div class="line">          monitor.queue.async &#123; event(monitor) &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>event(monitor)</code> 调用了闭包，闭包内部实现👇，<code>$0</code> 是参数 <code>monitor</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$<span class="number">0</span>.urlSession(session, didBecomeInvalidWithError: error)</div></pre></td></tr></table></figure>
<h3 id="defaultEventMonitors"><a href="#defaultEventMonitors" class="headerlink" title="defaultEventMonitors"></a>defaultEventMonitors</h3><p>在 Session 的初始化方法里👆🏻，eventMonitors 数组里包含两个部分，一个是默认的 <code>defaultEventMonitors</code>，另一个是调用者添加的自定义事件监听器：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eventMonitor = <span class="type">CompositeEventMonitor</span>(monitors: defaultEventMonitors + eventMonitors)</div></pre></td></tr></table></figure>
<p><code>defaultEventMonitors</code> 的定义：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">let</span> defaultEventMonitors: [<span class="type">EventMonitor</span>] = [<span class="type">AlamofireNotifications</span>()]</div></pre></td></tr></table></figure>
<p><code>AlamofireNotifications</code> 提供Alamofire通知的事件监视器。</p>
<ol>
<li>遵循 EventMonitor 协议；</li>
<li>实现需要监听的方法；</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AlamofireNotifications</span>: <span class="title">EventMonitor</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidResume</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didResumeNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidSuspend</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didSuspendNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidCancel</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didCancelNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requestDidFinish</span><span class="params">(<span class="number">_</span> request: Request)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didFinishNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didResumeTask task: URLSessionTask)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didResumeTaskNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didSuspendTask task: URLSessionTask)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didSuspendTaskNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCancelTask task: URLSessionTask)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didCancelTaskNotification, with: request)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">request</span><span class="params">(<span class="number">_</span> request: Request, didCompleteTask task: URLSessionTask, with error: AFError?)</span></span> &#123;</div><div class="line">        <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.postNotification(named: <span class="type">Request</span>.didCompleteTaskNotification, with: request)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>CompositeEventMonitor</code> 的 <code>performEvent</code> 方法里，<code>event(monitor)</code> 会调用 <code>AlamofireNotifications</code>，触发对应的方法。</p>
<h3 id="ClosureEventMonitor"><a href="#ClosureEventMonitor" class="headerlink" title="ClosureEventMonitor"></a>ClosureEventMonitor</h3><p>事件监视器——允许将可选闭包设置为接收事件。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">ClosureEventMonitor</span>: <span class="title">EventMonitor</span> </span>&#123;</div><div class="line">    <span class="comment">/// 用于 `urlSession(_:didBecomeInvalidWithError:)` 事件调用的闭包</span></div><div class="line">    <span class="keyword">open</span> <span class="keyword">var</span> sessionDidBecomeInvalidWithError: ((<span class="type">URLSession</span>, <span class="type">Error</span>?) -&gt; <span class="type">Void</span>)?</div><div class="line"></div><div class="line">    <span class="comment">/// 用于 `urlSession(_:task:didReceive:completionHandler:)` 事件调用的闭包.</span></div><div class="line">    <span class="keyword">open</span> <span class="keyword">var</span> taskDidReceiveChallenge: ((<span class="type">URLSession</span>, <span class="type">URLSessionTask</span>, <span class="type">URLAuthenticationChallenge</span>) -&gt; <span class="type">Void</span>)?</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">let</span> queue: <span class="type">DispatchQueue</span></div><div class="line"></div><div class="line">    <span class="comment">/// 用于执行事件闭包的队列</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(queue: <span class="type">DispatchQueue</span> = .main) &#123;</div><div class="line">        <span class="keyword">self</span>.queue = queue</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span> &#123;</div><div class="line">        sessionDidBecomeInvalidWithError?(session, error)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, task: URLSessionTask, didReceive challenge: URLAuthenticationChallenge)</span></span> &#123;</div><div class="line">        taskDidReceiveChallenge?(session, task, challenge)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>1、CompositeEventMonitor 的 performEvent，获取到 ClosureEventMonitor，将事件放入队列中；</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">performEvent</span><span class="params">(<span class="number">_</span> event: @escaping <span class="params">(EventMonitor)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line">  queue.async &#123;</div><div class="line">      <span class="keyword">for</span> monitor <span class="keyword">in</span> <span class="keyword">self</span>.monitors &#123;</div><div class="line">          monitor.queue.async &#123; event(monitor) &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、ClosureEventMonitor 调用实现的代理方法；</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$<span class="number">0</span>.urlSession(session, didBecomeInvalidWithError: error)</div></pre></td></tr></table></figure>
<p>3、从而调用对应的闭包</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">open</span> <span class="function"><span class="keyword">func</span> <span class="title">urlSession</span><span class="params">(<span class="number">_</span> session: URLSession, didBecomeInvalidWithError error: Error?)</span></span> &#123;</div><div class="line">  sessionDidBecomeInvalidWithError?(session, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h2><p>async-await</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> startTime = <span class="type">Date</span>.now</div><div class="line"><span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">20</span></div><div class="line"><span class="keyword">var</span> finish = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">// 4.280519008636475-</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(<span class="number">_</span> action: String)</span></span> &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_①"</span>)</div><div class="line">  sleep(<span class="number">2</span>)</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_②"</span>)</div><div class="line">    sleep(<span class="number">1</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_③"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_④"</span>)</div><div class="line">  sleep(<span class="number">2</span>)</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_⑤"</span>)</div><div class="line">  finish += <span class="number">1</span></div><div class="line">  <span class="keyword">if</span> finish == <span class="built_in">count</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(Date.now.timeIntervalSince1970 - startTime.timeIntervalSince1970)</span>"</span> + <span class="string">"-"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="built_in">count</span> &#123;</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    work(<span class="string">"<span class="subst">\(i)</span>"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>_①</div><div class="line"><span class="number">2</span>_①</div><div class="line"><span class="number">3</span>_①</div><div class="line"><span class="number">4</span>_①</div><div class="line"><span class="number">5</span>_①</div><div class="line"><span class="number">6</span>_①</div><div class="line"><span class="number">7</span>_①</div><div class="line"><span class="number">8</span>_①</div><div class="line"><span class="number">9</span>_①</div><div class="line"><span class="number">10</span>_①</div><div class="line"><span class="number">1</span>_②</div><div class="line"><span class="number">1</span>_④</div><div class="line"><span class="number">2</span>_④</div><div class="line"><span class="number">2</span>_②</div><div class="line"><span class="number">3</span>_④</div><div class="line"><span class="number">9</span>_④</div><div class="line"><span class="number">4</span>_④</div><div class="line"><span class="number">5</span>_④</div><div class="line"><span class="number">7</span>_④</div><div class="line"><span class="number">6</span>_④</div><div class="line"><span class="number">8</span>_④</div><div class="line"><span class="number">10</span>_④</div><div class="line"><span class="number">1</span>_③</div><div class="line"><span class="number">3</span>_②</div><div class="line"><span class="number">2</span>_③</div><div class="line"><span class="number">4</span>_②</div><div class="line"><span class="number">1</span>_⑤</div><div class="line"><span class="number">5</span>_②</div><div class="line"><span class="number">2</span>_⑤</div><div class="line"><span class="number">3</span>_③</div><div class="line"><span class="number">8</span>_②</div><div class="line"><span class="number">3</span>_⑤</div><div class="line"><span class="number">9</span>_②</div><div class="line"><span class="number">7</span>_②</div><div class="line"><span class="number">9</span>_⑤</div><div class="line"><span class="number">7</span>_⑤</div><div class="line"><span class="number">5</span>_⑤</div><div class="line"><span class="number">4</span>_⑤</div><div class="line"><span class="number">4</span>_③</div><div class="line"><span class="number">10</span>_⑤</div><div class="line"><span class="number">6</span>_⑤</div><div class="line"><span class="number">6</span>_②</div><div class="line"><span class="number">8</span>_⑤</div><div class="line"><span class="number">10</span>_②</div><div class="line"><span class="number">4.024436950683594</span>-</div><div class="line"><span class="number">5</span>_③</div><div class="line"><span class="number">8</span>_③</div><div class="line"><span class="number">9</span>_③</div><div class="line"><span class="number">7</span>_③</div><div class="line"><span class="number">6</span>_③</div><div class="line"><span class="number">10</span>_③</div></pre></td></tr></table></figure>
<p>增加测试数据：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> startTime = <span class="type">Date</span>.now</div><div class="line"><span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">20</span></div><div class="line"><span class="keyword">var</span> finish = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">// 8.030163764953613-</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(<span class="number">_</span> action: String)</span></span> &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_①"</span>)</div><div class="line">  sleep(<span class="number">2</span>)</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_②"</span>)</div><div class="line">    sleep(<span class="number">1</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_③"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_④"</span>)</div><div class="line">  sleep(<span class="number">2</span>)</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_⑤"</span>)</div><div class="line">  finish += <span class="number">1</span></div><div class="line">  <span class="keyword">if</span> finish == <span class="built_in">count</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(Date.now.timeIntervalSince1970 - startTime.timeIntervalSince1970)</span>"</span> + <span class="string">"-"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="built_in">count</span> &#123;</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    work(<span class="string">"<span class="subst">\(i)</span>"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>_①</div><div class="line"><span class="number">2</span>_①</div><div class="line"><span class="number">3</span>_①</div><div class="line"><span class="number">4</span>_①</div><div class="line"><span class="number">5</span>_①</div><div class="line"><span class="number">6</span>_①</div><div class="line"><span class="number">7</span>_①</div><div class="line"><span class="number">8</span>_①</div><div class="line"><span class="number">9</span>_①</div><div class="line"><span class="number">10</span>_①</div><div class="line"><span class="number">11</span>_①</div><div class="line"><span class="number">12</span>_①</div><div class="line"><span class="number">3</span>_④</div><div class="line"><span class="number">8</span>_④</div><div class="line"><span class="number">1</span>_④</div><div class="line"><span class="number">10</span>_④</div><div class="line"><span class="number">11</span>_④</div><div class="line"><span class="number">6</span>_④</div><div class="line"><span class="number">5</span>_④</div><div class="line"><span class="number">12</span>_④</div><div class="line"><span class="number">7</span>_④</div><div class="line"><span class="number">9</span>_④</div><div class="line"><span class="number">4</span>_④</div><div class="line"><span class="number">2</span>_④</div><div class="line"><span class="number">7</span>_⑤</div><div class="line"><span class="number">1</span>_⑤</div><div class="line"><span class="number">11</span>_⑤</div><div class="line"><span class="number">10</span>_⑤</div><div class="line"><span class="number">9</span>_⑤</div><div class="line"><span class="number">5</span>_⑤</div><div class="line"><span class="number">3</span>_⑤</div><div class="line"><span class="number">6</span>_⑤</div><div class="line"><span class="number">12</span>_⑤</div><div class="line"><span class="number">8</span>_⑤</div><div class="line"><span class="number">4</span>_⑤</div><div class="line"><span class="number">2</span>_⑤</div><div class="line"><span class="number">13</span>_①</div><div class="line"><span class="number">15</span>_①</div><div class="line"><span class="number">18</span>_①</div><div class="line"><span class="number">14</span>_①</div><div class="line"><span class="number">16</span>_①</div><div class="line"><span class="number">19</span>_①</div><div class="line"><span class="number">4</span>_②</div><div class="line"><span class="number">17</span>_①</div><div class="line"><span class="number">20</span>_①</div><div class="line"><span class="number">10</span>_②</div><div class="line"><span class="number">1</span>_②</div><div class="line"><span class="number">6</span>_②</div><div class="line"><span class="number">10</span>_③</div><div class="line"><span class="number">4</span>_③</div><div class="line"><span class="number">1</span>_③</div><div class="line"><span class="number">3</span>_②</div><div class="line"><span class="number">8</span>_②</div><div class="line"><span class="number">6</span>_③</div><div class="line"><span class="number">11</span>_②</div><div class="line"><span class="number">5</span>_②</div><div class="line"><span class="number">11</span>_③</div><div class="line"><span class="number">5</span>_③</div><div class="line"><span class="number">16</span>_④</div><div class="line"><span class="number">14</span>_④</div><div class="line"><span class="number">3</span>_③</div><div class="line"><span class="number">18</span>_④</div><div class="line"><span class="number">15</span>_④</div><div class="line"><span class="number">20</span>_④</div><div class="line"><span class="number">19</span>_④</div><div class="line"><span class="number">17</span>_④</div><div class="line"><span class="number">9</span>_②</div><div class="line"><span class="number">12</span>_②</div><div class="line"><span class="number">13</span>_④</div><div class="line"><span class="number">8</span>_③</div><div class="line"><span class="number">7</span>_②</div><div class="line"><span class="number">2</span>_②</div><div class="line"><span class="number">9</span>_③</div><div class="line"><span class="number">12</span>_③</div><div class="line"><span class="number">2</span>_③</div><div class="line"><span class="number">14</span>_②</div><div class="line"><span class="number">7</span>_③</div><div class="line"><span class="number">15</span>_②</div><div class="line"><span class="number">19</span>_②</div><div class="line"><span class="number">18</span>_②</div><div class="line"><span class="number">16</span>_⑤</div><div class="line"><span class="number">20</span>_⑤</div><div class="line"><span class="number">17</span>_⑤</div><div class="line"><span class="number">14</span>_⑤</div><div class="line"><span class="number">19</span>_⑤</div><div class="line"><span class="number">15</span>_⑤</div><div class="line"><span class="number">18</span>_⑤</div><div class="line"><span class="number">13</span>_②</div><div class="line"><span class="number">17</span>_②</div><div class="line"><span class="number">20</span>_②</div><div class="line"><span class="number">13</span>_⑤</div><div class="line"><span class="number">16</span>_②</div><div class="line"><span class="number">8.013674974441528</span>-</div><div class="line"><span class="number">14</span>_③</div><div class="line"><span class="number">19</span>_③</div><div class="line"><span class="number">15</span>_③</div><div class="line"><span class="number">18</span>_③</div><div class="line"><span class="number">13</span>_③</div><div class="line"><span class="number">17</span>_③</div><div class="line"><span class="number">16</span>_③</div><div class="line"><span class="number">20</span>_③</div></pre></td></tr></table></figure>
<p>使用 <code>Task.sleep(nanoseconds:)</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> startTime = <span class="type">Date</span>.now</div><div class="line"><span class="keyword">var</span> <span class="built_in">count</span> = <span class="number">20</span></div><div class="line"><span class="keyword">var</span> finish = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">// 4.280519008636475-</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(<span class="number">_</span> action: String)</span></span> async <span class="keyword">throws</span> &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_①"</span>)</div><div class="line">  <span class="keyword">try</span> await <span class="type">Task</span>.sleep(nanoseconds: <span class="number">2</span> * <span class="number">1_000_000_000</span>)</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_②"</span>)</div><div class="line">    <span class="keyword">try</span> await <span class="type">Task</span>.sleep(nanoseconds: <span class="number">1</span> * <span class="number">1_000_000_000</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_③"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_④"</span>)</div><div class="line">  <span class="keyword">try</span> await <span class="type">Task</span>.sleep(nanoseconds: <span class="number">2</span> * <span class="number">1_000_000_000</span>)</div><div class="line">  <span class="built_in">print</span>(<span class="string">"<span class="subst">\(action)</span>_⑤"</span>)</div><div class="line">  finish += <span class="number">1</span></div><div class="line">  <span class="keyword">if</span> finish == <span class="built_in">count</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"<span class="subst">\(Date.now.timeIntervalSince1970 - startTime.timeIntervalSince1970)</span>"</span> + <span class="string">"-"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span>...<span class="built_in">count</span> &#123;</div><div class="line">  <span class="type">Task</span> &#123;</div><div class="line">    <span class="keyword">try</span> await work(<span class="string">"<span class="subst">\(i)</span>"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>_①</div><div class="line"><span class="number">2</span>_①</div><div class="line"><span class="number">3</span>_①</div><div class="line"><span class="number">4</span>_①</div><div class="line"><span class="number">5</span>_①</div><div class="line"><span class="number">6</span>_①</div><div class="line"><span class="number">7</span>_①</div><div class="line"><span class="number">8</span>_①</div><div class="line"><span class="number">9</span>_①</div><div class="line"><span class="number">10</span>_①</div><div class="line"><span class="number">11</span>_①</div><div class="line"><span class="number">12</span>_①</div><div class="line"><span class="number">13</span>_①</div><div class="line"><span class="number">14</span>_①</div><div class="line"><span class="number">15</span>_①</div><div class="line"><span class="number">16</span>_①</div><div class="line"><span class="number">17</span>_①</div><div class="line"><span class="number">18</span>_①</div><div class="line"><span class="number">19</span>_①</div><div class="line"><span class="number">20</span>_①</div><div class="line"><span class="number">2</span>_④</div><div class="line"><span class="number">1</span>_④</div><div class="line"><span class="number">3</span>_④</div><div class="line"><span class="number">7</span>_④</div><div class="line"><span class="number">6</span>_④</div><div class="line"><span class="number">2</span>_②</div><div class="line"><span class="number">4</span>_④</div><div class="line"><span class="number">9</span>_④</div><div class="line"><span class="number">12</span>_④</div><div class="line"><span class="number">5</span>_④</div><div class="line"><span class="number">8</span>_④</div><div class="line"><span class="number">3</span>_②</div><div class="line"><span class="number">6</span>_②</div><div class="line"><span class="number">1</span>_②</div><div class="line"><span class="number">12</span>_②</div><div class="line"><span class="number">10</span>_④</div><div class="line"><span class="number">11</span>_④</div><div class="line"><span class="number">8</span>_②</div><div class="line"><span class="number">9</span>_②</div><div class="line"><span class="number">13</span>_④</div><div class="line"><span class="number">10</span>_②</div><div class="line"><span class="number">14</span>_④</div><div class="line"><span class="number">7</span>_②</div><div class="line"><span class="number">4</span>_②</div><div class="line"><span class="number">20</span>_④</div><div class="line"><span class="number">5</span>_②</div><div class="line"><span class="number">17</span>_④</div><div class="line"><span class="number">11</span>_②</div><div class="line"><span class="number">18</span>_②</div><div class="line"><span class="number">15</span>_④</div><div class="line"><span class="number">19</span>_④</div><div class="line"><span class="number">16</span>_④</div><div class="line"><span class="number">13</span>_②</div><div class="line"><span class="number">16</span>_②</div><div class="line"><span class="number">15</span>_②</div><div class="line"><span class="number">14</span>_②</div><div class="line"><span class="number">18</span>_④</div><div class="line"><span class="number">17</span>_②</div><div class="line"><span class="number">20</span>_②</div><div class="line"><span class="number">19</span>_②</div><div class="line"><span class="number">2</span>_③</div><div class="line"><span class="number">3</span>_③</div><div class="line"><span class="number">12</span>_③</div><div class="line"><span class="number">8</span>_③</div><div class="line"><span class="number">10</span>_③</div><div class="line"><span class="number">1</span>_③</div><div class="line"><span class="number">18</span>_③</div><div class="line"><span class="number">7</span>_③</div><div class="line"><span class="number">6</span>_③</div><div class="line"><span class="number">5</span>_③</div><div class="line"><span class="number">16</span>_③</div><div class="line"><span class="number">15</span>_③</div><div class="line"><span class="number">9</span>_③</div><div class="line"><span class="number">13</span>_③</div><div class="line"><span class="number">14</span>_③</div><div class="line"><span class="number">20</span>_③</div><div class="line"><span class="number">17</span>_③</div><div class="line"><span class="number">11</span>_③</div><div class="line"><span class="number">4</span>_③</div><div class="line"><span class="number">19</span>_③</div><div class="line"><span class="number">2</span>_⑤</div><div class="line"><span class="number">1</span>_⑤</div><div class="line"><span class="number">9</span>_⑤</div><div class="line"><span class="number">8</span>_⑤</div><div class="line"><span class="number">12</span>_⑤</div><div class="line"><span class="number">5</span>_⑤</div><div class="line"><span class="number">11</span>_⑤</div><div class="line"><span class="number">3</span>_⑤</div><div class="line"><span class="number">10</span>_⑤</div><div class="line"><span class="number">4</span>_⑤</div><div class="line"><span class="number">7</span>_⑤</div><div class="line"><span class="number">6</span>_⑤</div><div class="line"><span class="number">13</span>_⑤</div><div class="line"><span class="number">17</span>_⑤</div><div class="line"><span class="number">18</span>_⑤</div><div class="line"><span class="number">14</span>_⑤</div><div class="line"><span class="number">19</span>_⑤</div><div class="line"><span class="number">16</span>_⑤</div><div class="line"><span class="number">20</span>_⑤</div><div class="line"><span class="number">15</span>_⑤</div><div class="line"><span class="number">4.280519008636475</span>-</div></pre></td></tr></table></figure>
<p><code>await Task.sleep(nanoseconds:)</code> 方法有可能会调用失败，所以需要加 <code>try</code>：</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Swift/" rel="tag"># Swift</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/06/22/Github开源框架/Masonry/" rel="next" title="Masonry">
                <i class="fa fa-chevron-left"></i> Masonry
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/10/10/Flutter/Flutter之环境搭建/" rel="prev" title="Flutter之环境搭建">
                Flutter之环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/myAvatar.gif"
              alt="Kevin" />
          
            <p class="site-author-name" itemprop="name">Kevin</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/KevinYangGit" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:yangqioffice@gmail.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_YangQI" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>Twitter</a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.cnblogs.com/mjios" title="M了个J" target="_blank">M了个J</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Protected"><span class="nav-number">1.</span> <span class="nav-text">Protected</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#propertyWrapper"><span class="nav-number">1.1.</span> <span class="nav-text">@propertyWrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dynamicMemberLookup"><span class="nav-number">1.2.</span> <span class="nav-text">@dynamicMemberLookup</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-KeyPath"><span class="nav-number">1.2.1.</span> <span class="nav-text">1. KeyPath</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-动态成员查找-Dynamic-Member-Lookup"><span class="nav-number">1.2.2.</span> <span class="nav-text">2. 动态成员查找 Dynamic Member Lookup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-成员查找-Key-Path-Member-Lookup"><span class="nav-number">1.2.3.</span> <span class="nav-text">3. 成员查找 Key Path Member Lookup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#链式调用"><span class="nav-number">1.2.4.</span> <span class="nav-text">链式调用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#线程安全的属性-MutableState"><span class="nav-number">2.</span> <span class="nav-text">线程安全的属性 MutableState</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AlamofireExtended"><span class="nav-number">3.</span> <span class="nav-text">AlamofireExtended</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一种方式"><span class="nav-number">3.1.</span> <span class="nav-text">第一种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二种方式"><span class="nav-number">3.2.</span> <span class="nav-text">第二种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第三种方式"><span class="nav-number">3.3.</span> <span class="nav-text">第三种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第四种方式"><span class="nav-number">3.4.</span> <span class="nav-text">第四种方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventMonitor"><span class="nav-number">4.</span> <span class="nav-text">EventMonitor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CompositeEventMonitor"><span class="nav-number">4.1.</span> <span class="nav-text">CompositeEventMonitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#defaultEventMonitors"><span class="nav-number">4.2.</span> <span class="nav-text">defaultEventMonitors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ClosureEventMonitor"><span class="nav-number">4.3.</span> <span class="nav-text">ClosureEventMonitor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Concurrency"><span class="nav-number">5.</span> <span class="nav-text">Concurrency</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '82b6ced795961ee1fcca',
      clientSecret: '4a2f24a39c6fcd85813d80031c6e0262a65404f5',
      repo: 'KevinYangGit.github.io',
      owner: 'KevinYangGit',
      admin: ['KevinYangGit'],
      id: md5(location.pathname),
      distractionFreeMode: 'true'
    })
    gitalk.render('gitalk-container')
  </script>

  





  

  

  

  
  


  

  

</body>
</html>
