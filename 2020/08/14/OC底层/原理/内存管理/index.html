<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="OC底层原理," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta name="keywords" content="OC底层原理">
<meta property="og:type" content="article">
<meta property="og:title" content="内存管理">
<meta property="og:url" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/index.html">
<meta property="og:site_name" content="Kevin&#39;s  blog">
<meta property="og:description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理01.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理02.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理03.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理04.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理05.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理06.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理07.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理08.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理09.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理10.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理11.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理12.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理17.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理12.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理14.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理15.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理18.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理19.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理20.png">
<meta property="og:updated_time" content="2020-08-31T02:33:52.109Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="内存管理">
<meta name="twitter:description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta name="twitter:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/"/>





  <title>内存管理 | Kevin's  blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin's  blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myAvatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's  blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">内存管理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-14T17:16:33+08:00">
                2020-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考：</p>
<ul>
<li>使用 CADisplayLink、NSTimer 有什么注意点？</li>
<li>介绍下内存的几大区域</li>
<li>讲一下你对 iOS 内存管理的理解</li>
<li>ARC 都帮我们做了什么？(LLVM + Runtime)</li>
<li>weak 指针的实现原理</li>
<li>autorelease 对象在什么时机会被调用 release</li>
<li>方法里有局部对象， 出了方法后会立即释放吗?<a id="more"></a>
</li>
</ul>
<h1 id="CADisplayLink、NSTimer-定时器"><a href="#CADisplayLink、NSTimer-定时器" class="headerlink" title="CADisplayLink、NSTimer 定时器"></a>CADisplayLink、NSTimer 定时器</h1><p>CADisplayLink、NSTimer 会对 target 产生强引用，如果 target 又对它们产生强引用，那么就会引发循环引用。</p>
<h2 id="循环引用问题"><a href="#循环引用问题" class="headerlink" title="循环引用问题"></a>循环引用问题</h2><h3 id="CADisplayLink"><a href="#CADisplayLink" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h3><p>CADisplayLink 保证调用 <code>-(void)timerTest</code> 方法的频率和屏幕的刷新帧频率一致，60FPS。实际的调用频率可能不太一样，根据任务的耗时情况会有减少。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">......</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，进入 TimerViewController 控制器后返回，会发现 TimerViewController 没有释放，CADisplayLink 定时器还在继续运行。</p>
<h3 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">......</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，进入 TimerViewController 控制器后返回，会发现 TimerViewController 没有释放，NSTimer 定时器还在继续运行。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理01.png" alt="内存管理01"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：使用-block"><a href="#方案一：使用-block" class="headerlink" title="方案一：使用 block"></a>方案一：使用 block</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> repeats:<span class="literal">YES</span> block:^(<span class="built_in">NSTimer</span> * _Nonnull timer) &#123;</div><div class="line">        [weakSelf timerTest];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<p>在使用 NSTimer 的时候，使用 block 的方式传入 weakSelf 可以有效解决循环引用的问题。并且以 scheduled 开头的方法会自动将 timer 添加到当前的 runloop 中并使用 default mode。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (<span class="selector-tag">NSTimer</span> *)<span class="selector-tag">scheduledTimerWithTimeInterval</span><span class="selector-pseudo">:(NSTimeInterval)interval</span> <span class="selector-tag">repeats</span><span class="selector-pseudo">:(BOOL)repeats</span> <span class="selector-tag">block</span><span class="selector-pseudo">:(void</span> (^)(<span class="selector-tag">NSTimer</span> *<span class="selector-tag">timer</span>))<span class="selector-tag">block</span> <span class="selector-tag">API_AVAILABLE</span>(<span class="selector-tag">macosx</span>(10<span class="selector-class">.12</span>), <span class="selector-tag">ios</span>(10<span class="selector-class">.0</span>), <span class="selector-tag">watchos</span>(3<span class="selector-class">.0</span>), <span class="selector-tag">tvos</span>(10<span class="selector-class">.0</span>));</div></pre></td></tr></table></figure></p>
<p>target 传入 weakSelf 并不能解决循环引用个问题，因为 NSTimer 内部对传入的 target 也是强引用的，而且 weakSelf 只是用来解决 block 循环引用问题的方案。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti target:(<span class="keyword">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div></pre></td></tr></table></figure></p>
<p>CADisplayLink 没有 block 相关的 API。</p>
<h3 id="方案二：使用中间对象"><a href="#方案二：使用中间对象" class="headerlink" title="方案二：使用中间对象"></a>方案二：使用中间对象</h3><p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理02.png" alt="内存管理02"></p>
<p>定义中间对象：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQProxy</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target</div><div class="line">&#123;</div><div class="line">    YQProxy *proxy = [[YQProxy alloc] init];</div><div class="line">    proxy.target = target;</div><div class="line">    <span class="keyword">return</span> proxy;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.target;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h4 id="NSTimer-1"><a href="#NSTimer-1" class="headerlink" title="NSTimer"></a>NSTimer</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="comment">//@property (nonatomic, strong) CADisplayLink *link;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> target:[YQProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<h4 id="CADisplayLink-1"><a href="#CADisplayLink-1" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:[YQProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<p>传给定时器的 target 是 YQProxy 对象，在 YQProxy 对象尝试调用 <code>-(void)timerTest</code> 方法时，发现没有实现后会调用 <code>- (id)forwardingTargetForSelector:(SEL)aSelector</code> 方法走消息转发的逻辑，在该方法内部返回已经实现了 <code>-(void)timerTest</code> 方法的对象，就可以正常实现 timer 定时器调用 <code>-(void)timerTest</code> 方法的逻辑了。 </p>
<p>因为 YQProxy 对象没有实现 <code>-(void)timerTest</code> 方法，所以需要添加消息转发逻辑。如果 YQProxy 中没有添加消息转发的逻辑会出现如下报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理03.png" alt="内存管理03"> </p>
<p>YQProxy 会在其类对象以及父类的类对象里查找 <code>-(void)timerTest</code> 方法，查找了一圈后发现找不到，就会抛出错误。</p>
<h2 id="使用代理对象（NSProxy）"><a href="#使用代理对象（NSProxy）" class="headerlink" title="使用代理对象（NSProxy）"></a>使用代理对象（NSProxy）</h2><p>定义 YQTimerProxy 继承自 NSProxy：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQTimerProxy</span> : <span class="title">NSProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQTimerProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target</div><div class="line">&#123;</div><div class="line">    YQTimerProxy *proxy = [YQTimerProxy alloc];</div><div class="line">    proxy.target = target;</div><div class="line">    <span class="keyword">return</span> proxy;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.target methodSignatureForSelector:sel];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation</div><div class="line">&#123;</div><div class="line">    [invocation invokeWithTarget:<span class="keyword">self</span>.target];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>NSProxy 对象没有 <code>-(instancetype)init</code> 方法，直接 alloc 就可以了。</p>
<h3 id="NSTimer-2"><a href="#NSTimer-2" class="headerlink" title="NSTimer"></a>NSTimer</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></div><div class="line">                                                  target:[YQTimerProxy proxyWithTarget:<span class="keyword">self</span>]</div><div class="line">                                                selector:<span class="keyword">@selector</span>(timerTest)</div><div class="line">                                                userInfo:<span class="literal">nil</span></div><div class="line">                                                 repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<h3 id="CADisplayLink-2"><a href="#CADisplayLink-2" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:[YQTimerProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>传给定时器的 target 是 YQTimerProxy 对象，YQTimerProxy 对象不会尝试调用 <code>-(void)timerTest</code> 方法，而是直接走消息转发逻辑，在对应的消息转发的方法里返回已经实现了 <code>-(void)timerTest</code> 方法的对象，就可以正常实现 timer 定时器调用 <code>-(void)timerTest</code> 方法的逻辑了。</p>
<p>因为 YQTimerProxy 对象不会尝试调用 <code>-(void)timerTest</code> 方法，而是直接调用 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法，所以需要添加消息转发逻辑。如果 YQTimerProxy 中没有添加消息转发的逻辑会出现如下报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理04.png" alt="内存管理04"> </p>
<p>可以看到 YQTimerProxy 没有去查找 <code>-(void)timerTest</code> 方法，而是直接查找的 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法。这一点可以通过 <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUStep</a> 查看 NSProxy 的源码找到原因。NSProxy 内部的方法的实现都是直接调用的 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法，因此 NSProxy 作为代理对象效率更高。</p>
<h2 id="NSProxy"><a href="#NSProxy" class="headerlink" title="NSProxy"></a>NSProxy</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    YQProxy *proxy1 = [YQProxy proxyWithTarget:<span class="keyword">self</span>];</div><div class="line">    YQTimerProxy *proxy2 = [YQTimerProxy proxyWithTarget:<span class="keyword">self</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%d %d"</span>, [proxy1 isKindOfClass:[ViewController <span class="keyword">class</span>]], [proxy2 isKindOfClass:[ViewController <span class="keyword">class</span>]]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">0 </span><span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，YQProxy 的实例对象和 YQTimerProxy 的实列对象在判断是否是 ViewController 的对象类型的时候结果不同。这是因为 YQTimerProxy 继承自 NSProxy，NSProxy 的 <code>-(BOOL) isKindOfClass:(Class)aClass</code> 方法的实现与普通的 OC 对象同。通过 <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUStep</a> 查看 NSProxy 的源码：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">BOOL)isKindOfClass:(Class)aClass</span></div><div class="line"><span class="keyword">&#123;</span></div><div class="line"><span class="keyword"> </span>   NSMethodSignature	*sig<span class="comment">;</span></div><div class="line">    NSInvocation		*inv<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL	</span>		ret<span class="comment">;</span></div><div class="line"></div><div class="line">    sig = [self methodSignatureForSelector: _cmd]<span class="comment">;</span></div><div class="line">    inv = [NSInvocation invocationWithMethodSignature: sig]<span class="comment">;</span></div><div class="line">    [inv setSelector: _cmd]<span class="comment">;</span></div><div class="line">    [inv setArgument: &amp;aClass atIndex: <span class="number">2</span>]<span class="comment">;</span></div><div class="line">    [self forwardInvocation: inv]<span class="comment">;</span></div><div class="line">    [inv getReturnValue: &amp;ret]<span class="comment">;</span></div><div class="line">    return ret<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，NSProxy 的 <code>-(BOOL)isKindOfClass:(Class)aClass</code> 方法内部直接调用了 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法。</p>
<p>普通 OC 对象的 <code>-(BOOL)isKindOfClass:(Class)aClass</code> 方法实现 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> ：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</div><div class="line">    <span class="keyword">for</span> (Class tcls = [<span class="keyword">self</span> <span class="keyword">class</span>]; tcls; tcls = tcls-&gt;superclass) &#123;</div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="GCD-定时器"><a href="#GCD-定时器" class="headerlink" title="GCD 定时器"></a>GCD 定时器</h1><p>CADisplayLink 和 NSTimer 依赖于 RunLoop，如果 RunLoop 的任务过于繁重，可能会导致 CADisplayLink 和 NSTimer 不准时。GCD 的定时器会更加准时。</p>
<h2 id="block-回调："><a href="#block-回调：" class="headerlink" title="block 回调："></a>block 回调：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"GCD timer"</span>);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:38.889349+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">-</span><span class="selector-attr">[ViewController viewDidLoad]</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:40.889609+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:41.889685+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:42.889624+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="函数回调："><a href="#函数回调：" class="headerlink" title="函数回调："></a>函数回调：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler_f(timer, timerFire);</div><div class="line">    </div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> timerFire(<span class="keyword">void</span> *param)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"GCD timer - %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">01.629410</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] -[ViewController viewDidLoad]</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">03.629774</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">04.629784</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">05.629800</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="自定义队列"><a href="#自定义队列" class="headerlink" title="自定义队列"></a>自定义队列</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 自定义队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"GCDTimer"</span>, <span class="literal">NULL</span>);</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler_f(timer, timerFire);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> timerFire(<span class="keyword">void</span> *param)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"GCD timer - %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">20</span>:<span class="number">39</span>:<span class="number">58.857389</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28690</span>] -[ViewController viewDidLoad]</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">00.857845</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28836</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x<span class="number">600002119280</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">01.857692</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28835</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x60<span class="number">00021272c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">02.857792</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28836</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x<span class="number">600002119280</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="封装-GCD"><a href="#封装-GCD" class="headerlink" title="封装 GCD"></a>封装 GCD</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQGCDTimer</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">block 回调</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="built_in">NSString</span> *)execTask:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))task</div><div class="line">                 start:(<span class="built_in">NSTimeInterval</span>)start</div><div class="line">              interval:(<span class="built_in">NSTimeInterval</span>)interval</div><div class="line">               repeats:(<span class="built_in">BOOL</span>)repeats</div><div class="line">                 async:(<span class="built_in">BOOL</span>)async;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">函数回调</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="built_in">NSString</span> *)execTaskWithTarget:(<span class="keyword">id</span>)target</div><div class="line">                        selector:(SEL)selector</div><div class="line">                           start:(<span class="built_in">NSTimeInterval</span>)start</div><div class="line">                        interval:(<span class="built_in">NSTimeInterval</span>)interval</div><div class="line">                         repeats:(<span class="built_in">BOOL</span>)repeats</div><div class="line">                           async:(<span class="built_in">BOOL</span>)async;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">取消</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="keyword">void</span>)cancelTask:(<span class="built_in">NSString</span> *)name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">NSInteger</span> index_;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *timers_;</div><div class="line">dispatch_semaphore_t semaphore_;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQGCDTimer</span></span></div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)initialize</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        timers_ = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">        semaphore_ = dispatch_semaphore_create(<span class="number">1</span>);</div><div class="line">        index_ = <span class="number">0</span>;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSString</span> *)execTask:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))task start:(<span class="built_in">NSTimeInterval</span>)start interval:(<span class="built_in">NSTimeInterval</span>)interval repeats:(<span class="built_in">BOOL</span>)repeats async:(<span class="built_in">BOOL</span>)async</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!task || start &lt; <span class="number">0</span> || (interval &lt;= <span class="number">0</span> &amp;&amp; repeats)) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    <span class="comment">// 队列（全局串行队列或主队列）</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = async ? dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>) : dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, start * <span class="built_in">NSEC_PER_SEC</span>), interval * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        task();</div><div class="line">        <span class="comment">// 不需要重复任务</span></div><div class="line">        <span class="keyword">if</span> (!repeats) &#123;</div><div class="line">            dispatch_source_cancel(timer);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 加锁</span></div><div class="line">    dispatch_semaphore_wait(semaphore_, DISPATCH_TIME_FOREVER);</div><div class="line">    <span class="comment">// 定时器唯一标识</span></div><div class="line">    <span class="built_in">NSString</span> *identify = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>, (<span class="keyword">long</span>)index_++];</div><div class="line">    <span class="comment">// 保存</span></div><div class="line">    timers_[identify] = timer;</div><div class="line">    <span class="comment">// 解锁</span></div><div class="line">    dispatch_semaphore_signal(semaphore_);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">return</span> identify;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSString</span> *)execTaskWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector start:(<span class="built_in">NSTimeInterval</span>)start interval:(<span class="built_in">NSTimeInterval</span>)interval repeats:(<span class="built_in">BOOL</span>)repeats async:(<span class="built_in">BOOL</span>)async</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> execTask:^&#123;</div><div class="line">        <span class="keyword">if</span> ([target respondsToSelector:selector]) &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-performSelector-leaks"</span></span></div><div class="line">            [target performSelector:selector];</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        &#125;</div><div class="line">    &#125; start:start interval:interval repeats:repeats async:async];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)cancelTask:(<span class="built_in">NSString</span> *)name</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (name.length == <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line">    <span class="comment">// 加锁</span></div><div class="line">    dispatch_semaphore_wait(semaphore_, DISPATCH_TIME_FOREVER);</div><div class="line">    dispatch_source_t timer = timers_[name];</div><div class="line">    <span class="keyword">if</span> (timer) &#123;</div><div class="line">        dispatch_source_cancel(timer);</div><div class="line">        [timers_ removeObjectForKey:name];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 解锁</span></div><div class="line">    dispatch_semaphore_signal(semaphore_);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>调用 block 回调方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *task;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">self</span>.task = [YQGCDTimer execTask:^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"GCD timer"</span>);</div><div class="line">    &#125; start:<span class="number">2</span> interval:<span class="number">1</span> repeats:<span class="literal">YES</span> async:<span class="literal">NO</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    [YQGCDTimer cancelTask:<span class="keyword">self</span>.task];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>调用函数回调方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *task;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">self</span>.task = [YQGCDTimer execTaskWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest) start:<span class="number">2</span> interval:<span class="number">1</span> repeats:<span class="literal">YES</span> async:<span class="literal">NO</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    [YQGCDTimer cancelTask:<span class="keyword">self</span>.task];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:01.050592+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">-</span><span class="selector-attr">[TimerViewController viewDidLoad]</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:03.050800+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:04.050986+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:05.050943+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div></pre></td></tr></table></figure></p>
<p>去掉警告：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">+</span> <span class="string">(NSString</span> <span class="string">*)execTaskWithTarget:(id)target</span> <span class="attr">selector:(SEL)selector</span> <span class="attr">start:(NSTimeInterval)start</span> <span class="attr">interval:(NSTimeInterval)interval</span> <span class="attr">repeats:(BOOL)repeats</span> <span class="attr">async:(BOOL)async</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">    <span class="string">return</span> <span class="string">[self</span> <span class="attr">execTask:^&#123;</span></div><div class="line">        <span class="string">if</span> <span class="string">([target</span> <span class="attr">respondsToSelector:selector])</span> <span class="string">&#123;</span></div><div class="line"><span class="comment">#pragma clang diagnostic push</span></div><div class="line"><span class="comment">#pragma clang diagnostic ignored "-Warc-performSelector-leaks"</span></div><div class="line">            <span class="string">[target</span> <span class="attr">performSelector:selector];</span></div><div class="line"><span class="comment">#pragma clang diagnostic pop</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">    <span class="string">&#125;</span> <span class="attr">start:start</span> <span class="attr">interval:interval</span> <span class="attr">repeats:repeats</span> <span class="attr">async:async];</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure></p>
<p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理05.png" alt="内存管理05"> </p>
<h1 id="iOS程序的内存布局"><a href="#iOS程序的内存布局" class="headerlink" title="iOS程序的内存布局"></a>iOS程序的内存布局</h1><ul>
<li>代码段：编译之后的代码</li>
<li>数据段：<br>字符串常量<br>已初始化数据<br>未初始化数据</li>
<li>栈：函数调用开销，比如局部变量。（分配的内存空间地址越来越小）</li>
<li>堆：通过 alloc、malloc、calloc 等动态分配的空间，分配的内存空间地址越来越大<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理06.png" alt="内存管理06"> </li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 已初始化的全局变量</span></div><div class="line"><span class="keyword">int</span> a = <span class="number">10</span>;</div><div class="line"><span class="comment">// 未初始化的全局变量</span></div><div class="line"><span class="keyword">int</span> b;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">// 已初始化的静态变量</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> c = <span class="number">20</span>;</div><div class="line">        <span class="comment">// 未初始化的静态变量</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> d;</div><div class="line">        <span class="comment">// 栈</span></div><div class="line">        <span class="keyword">int</span> e;</div><div class="line">        <span class="keyword">int</span> f = <span class="number">20</span>;</div><div class="line">        <span class="comment">// 字符串常量</span></div><div class="line">        <span class="built_in">NSString</span> *str = <span class="string">@"123"</span>;</div><div class="line">        <span class="comment">// 堆</span></div><div class="line">        <span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"\n&amp;a=%p\n&amp;b=%p\n&amp;c=%p\n&amp;d=%p\n&amp;e=%p\n&amp;f=%p\nstr=%p\nobj1=%p\nobj2=%p\n"</span>,</div><div class="line">              &amp;a, &amp;b, &amp;c, &amp;d, &amp;e, &amp;f, str, obj1, obj2);</div><div class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&amp;<span class="attribute">a</span>=0x105bbee38</div><div class="line">&amp;<span class="attribute">b</span>=0x105bbef04</div><div class="line">&amp;<span class="attribute">c</span>=0x105bbee3c</div><div class="line">&amp;<span class="attribute">d</span>=0x105bbef00</div><div class="line">&amp;<span class="attribute">e</span>=0x7ffeea042c2c</div><div class="line">&amp;<span class="attribute">f</span>=0x7ffeea042c28</div><div class="line"><span class="attribute">str</span>=0x105bbe070</div><div class="line"><span class="attribute">obj1</span>=0x600002528110</div><div class="line"><span class="attribute">obj2</span>=0x600002528120</div></pre></td></tr></table></figure></p>
<p>打印结果解析（内地地址从小到大排序）：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 字符串常量</span></div><div class="line">str=<span class="number">0x105bbe070</span></div><div class="line"></div><div class="line"><span class="comment">// 已初始化的全局变量、静态变量</span></div><div class="line">&amp;a=<span class="number">0x105bbee38</span></div><div class="line">&amp;c=<span class="number">0x105bbee3c</span></div><div class="line"></div><div class="line"><span class="comment">// 未初始化的全局变量、静态变量</span></div><div class="line">&amp;d=<span class="number">0x105bbef00</span></div><div class="line">&amp;b=<span class="number">0x105bbef04</span></div><div class="line"></div><div class="line"><span class="comment">// 堆</span></div><div class="line">obj1=<span class="number">0x600002528110</span></div><div class="line">obj2=<span class="number">0x600002528120</span></div><div class="line"></div><div class="line"><span class="comment">// 栈</span></div><div class="line">&amp;f=<span class="number">0x7ffeea042c28</span></div><div class="line">&amp;e=<span class="number">0x7ffeea042c2c</span></div></pre></td></tr></table></figure></p>
<p>内存地址大小比较：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">str &lt; <span class="selector-tag">a</span> &lt; c &lt; d &lt; <span class="selector-tag">b</span> &lt; obj1 &lt; obj2 &lt; f &lt; e</div></pre></td></tr></table></figure></p>
<p>数据段：str &lt; a &lt; c &lt; d &lt; b，空间地址越来越大。<br>堆区：obj1 比 b 多了3位数，这3位数的空间都属于数据段。obj1 的内存地址首位数字为6，obj1 &lt; obj2，分配的内存空间越来越大（越来越逼近栈区）。<br>栈区：e 的内存地址首位数字为7，f &lt; e，分配的内存空间越来越小（越来越逼近堆区）。  </p>
<h1 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h1><ul>
<li>从64bit开始，iOS 引入了 Tagged Pointer 技术，用于优化 NSNumber、NSDate、NSString 等小对象的存储。</li>
<li>在没有使用 Tagged Pointer 之前，NSNumber 等对象需要动态分配内存、维护引用计数等，NSNumber 等对象的指针存储的是堆中 NSNumber 对象的地址值。</li>
<li>使用 Tagged Pointer 之后，NSNumber 指针里面存储的数据变成了：Tag + Data，也就是将数据直接存储在了指针中。</li>
<li>当指针不够存储数据时，才会使用动态分配内存的方式来存储数据。</li>
<li><code>objc_msgSend()</code> 能识别 Tagged Pointer，比如 NSNumber 的 intValue 方法，直接从指针提取数据，节省了以前的调用开销。</li>
<li>如何判断一个指针是否为Tagged Pointer？<br>iOS平台，最高有效位是1（第64bit）<br>Mac平台，最低有效位是1  </li>
</ul>
<h2 id="NSNumber"><a href="#NSNumber" class="headerlink" title="NSNumber"></a>NSNumber</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSNumber</span> *number1 = @<span class="number">4</span>;</div><div class="line">        <span class="built_in">NSNumber</span> *number2 = @<span class="number">5</span>;</div><div class="line">        <span class="built_in">NSNumber</span> *number3 = @(<span class="number">0xFFFFFFFFFFFFFFFF</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, number1, number2, number3);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> a = [number1 intValue];</div><div class="line"></div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0xb0d1e4bcdb858740</span> <span class="number">0xb0d1e4bcdb858750</span> <span class="number">0x600000b4c080</span></div></pre></td></tr></table></figure></p>
<p><code>0xb0d1e4bcdb858740</code> 和 <code>0xb0d1e4bcdb858750</code> 去掉前面相同的部分后是 <code>0x40</code> 和 <code>0x50</code>，可以看出数据直接存储在了指针中。当指针不够存储数据时，如 <code>@(0xFFFFFFFFFFFFFFFF)</code> 打印出来的内存地址是 <code>0x600000b4c080</code>（堆空间里 NSNumber 对象的地址值），是使用了动态分配内存的方式来存储数据。</p>
<p>因为 <code>objc_msgSend()</code> 能识别 Tagged Pointer，所以在 number1 调用 <code>intValue</code> 方法时，<code>objc_msgSend()</code> 直接从指针提取数据。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">int a</span> = [number1 intValue];</div></pre></td></tr></table></figure></p>
<p>可以看出 Tagged Pointer 技术不仅仅是内存空间的优化，也对使用过程进行了优化。</p>
<h2 id="NSString"><a href="#NSString" class="headerlink" title="NSString"></a>NSString</h2><h3 id="例一："><a href="#例一：" class="headerlink" title="例一："></a>例一：</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>运行后报错（坏内存访问）：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理07.png" alt="内存管理07"></p>
<p>因为 <code>name</code> 是非原子性（<code>nonatomic</code>）的，多条线程同时访问 <code>name</code> 的 set 方法时，如果有一条线程已经将 <code>_name</code> 释放了，其它线程再次对 <code>_name</code> 进行释放操作就会出现坏内存访问的错误：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)<span class="built_in">setName</span>:(NSString *)<span class="built_in">name</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="variable">_name</span> != <span class="built_in">name</span>) &#123;</div><div class="line">        [<span class="variable">_name</span> release]; <span class="comment">// 多条线程同时操作这一行，如果 `_name` 已经被释放了，其它线程再次对 `_name` 进行 release 操作，坏内存访问</span></div><div class="line">        <span class="variable">_name</span> = [<span class="built_in">name</span> copy];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="解决方案一："><a href="#解决方案一：" class="headerlink" title="解决方案一："></a>解决方案一：</h4><p>将 <code>name</code> 改成原子性的：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">property</span> (atomic, <span class="keyword">copy</span>) NSString *<span class="built_in">name</span>;</div></pre></td></tr></table></figure></p>
<p>程序运行正常。</p>
<p>将 <code>name</code> 改成原子性后，<code>name</code> 的 set 方法就是线程安全的了，不会出现多条线程同时对 <code>name</code> 进行 release 操作。</p>
<h4 id="解决方案二："><a href="#解决方案二：" class="headerlink" title="解决方案二："></a>解决方案二：</h4><p>将 <code>name</code> 改成原子性后，任何地方、任何时候调用 <code>name</code> 的 get 方法都是有锁的。因为 <code>name</code> 只需要在异步线程访问时加锁，如果在主线程的话没有必要加锁，所以不使用 <code>atomic</code> 而是选择手动加锁，哪里需要就在哪里加锁，尽可能的提升效率节省资源：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 加锁</span></div><div class="line"><span class="meta">#define SemaphoreBegin \</span></div><div class="line"><span class="keyword">static</span> dispatch_semaphore_t semaphore; \</div><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</div><div class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</div><div class="line">    semaphore = dispatch_semaphore_create(<span class="number">1</span>); \</div><div class="line">&#125;); \</div><div class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line"><span class="comment">/// 解锁</span></div><div class="line"><span class="meta">#define SemaphoreEnd \</span></div><div class="line">dispatch_semaphore_signal(semaphore);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="comment">// 加锁</span></div><div class="line">            SemaphoreBegin;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">            <span class="comment">// 解锁</span></div><div class="line">            SemaphoreEnd;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>程序运行正常。</p>
<h3 id="例二："><a href="#例二：" class="headerlink" title="例二："></a>例二：</h3><p>将 <code>@&quot;abcdefghijk&quot;</code> 改成 <code>@&quot;abc&quot;</code>：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abc"</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>运行正常。  </p>
<p>同样是多线程访问、没有加锁，但是将 <code>@&quot;abcdefghijk&quot;</code> 改成 <code>@&quot;abc&quot;</code> 后，就不会出现坏内存访问的错误，难道是没有调用 <code>name</code> 的 set 方法吗？是的。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSString</span> *str1 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">    <span class="built_in">NSString</span> *str2 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abc"</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%p %p"</span>, str1, str2);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ %@"</span>, [str1 <span class="keyword">class</span>], [str2 <span class="keyword">class</span>]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x600002aefd</span>c0 <span class="number">0x9cedd</span>15798132057</div><div class="line">__NSCFString NSTaggedPointerString</div></pre></td></tr></table></figure></p>
<p>str1 是一个 <code>__NSCFString</code>，其内存地址是6开头的，说明 str1 是存储在堆空间里的。<br>str2 是一个 <code>NSTaggedPointerString</code>，<code>@&quot;abc&quot;</code> 存储在 str2 指针里，不会调用 set 方法，取值时也不会调用 get 方法而是直接从指针里取值。</p>
<h2 id="判断是否是-Tagged-Pointer"><a href="#判断是否是-Tagged-Pointer" class="headerlink" title="判断是否是 Tagged Pointer"></a>判断是否是 Tagged Pointer</h2><p><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 objc-internal.h 文件里：</p>
<p><code>_OBJC_TAG_MASK</code> 定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span></div><div class="line">    <span class="comment">// 64-bit Mac - tag bit is LSB</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 0 <span class="comment">// Mac</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="comment">// Everything else - tag bit is MSB</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 1 <span class="comment">// iPhone（真机/模拟器）</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> OBJC_MSB_TAGGED_POINTERS</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK 1UL </span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>判断是否是 tagged pointer：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> </div><div class="line">_objc_isTaggedPointer(<span class="keyword">const</span> <span class="keyword">void</span> * _Nullable ptr)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果是 mac，<code>_OBJC_TAG_MASK</code> 等于1。如果不是 mac， <code>_OBJC_TAG_MASK</code> 等于 1UL&lt;&lt;63。<code>_OBJC_TAG_MASK</code> 和指针地址进行与运算，判断结果是否是 <code>_OBJC_TAG_MASK</code>，如果是的话，那这个指针就是 tagged pointer。<br>在 iOS 平台，如果指针转成2进制后它的最高位（64位）为1的话，那么这个指针就是 tagged pointer。<br>在 Mac 平台，如果指针转成2进制后它的最低位为1的话，那么这个指针就是 tagged pointer。</p>
<h1 id="MRC"><a href="#MRC" class="headerlink" title="MRC"></a>MRC</h1><ul>
<li>在 iOS 中，使用引用计数来管理 OC 对象的内存。  </li>
<li>一个新创建的 OC 对象引用计数默认是1，当引用计数减为0，OC 对象就会销毁，释放其占用的内存空间。  </li>
<li>调用 retain 会让 OC 对象的引用计数+1，调用 release 会让 OC 对象的引用计数-1。  </li>
<li>内存管理的经验总结：<br>当调用 alloc、new、copy、mutableCopy 方法返回了一个对象，在不需要这个对象时，要调用 release 或者 autorelease 来释放它。<br>想拥有某个对象，就让它的引用计数+1；不想再拥有某个对象，就让它的引用计数-1。  </li>
<li>可以通过以下私有函数来查看自动释放池的情况  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">void</span> _objc_autoreleasePoolPrint(<span class="keyword">void</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>👉 使用 MRC：Build Setting -&gt; Objective-C Automatic Referencd Counting 设置为 YES。</p>
<p>定义 Person 类：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Person</div><div class="line">- (void)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="selector-attr">[super dealloc]</span>;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<h2 id="release"><a href="#release" class="headerlink" title="release"></a>release</h2><p>创建 person 对象：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init]; <span class="comment">// Person *person = [Person new];</span></div><div class="line">        NSLog(@<span class="string">"%zd"</span>, person.retainCount);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，person 对象调用完 <code>alloc</code> 方法后引用计数是1，没有被释放。</p>
<p>添加 release：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        <span class="comment">// 使用 person 对象</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, person.retainCount);</div><div class="line"></div><div class="line">        [person release];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，因为 person 对象调用完 <code>alloc</code> 方法后引用计数是1，调用完 <code>release</code> 方法后引用计数减1等于0，所以 person 对象在调用 <code>release</code> 的那一刻就被释放了。</p>
<p>MRC 下 <code>alloc</code> 方法和 <code>release</code> 方法是一一对应的，每个对象使用完成后都要调用一下 <code>release</code> 方法，这样才能避免内存泄漏。另外，在使用 <code>release</code> 方法管理 person 对象时，要保证在调用 <code>release</code> 方法之前使用 person 对象。</p>
<h2 id="autorelease"><a href="#autorelease" class="headerlink" title="autorelease"></a>autorelease</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[[Person alloc] init] autorelease];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, person.retainCount);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div><div class="line"><span class="number">111</span></div><div class="line">-[Person dealloc]</div><div class="line"><span class="number">222</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，因为 person 对象调用完 <code>alloc</code> 方法又调用了 <code>autorelease</code> 后引用计数是1，直到 <code>@autoreleasepool {}</code> 执行完那一刻才被释放。  </p>
<p>在 <code>@autoreleasepool {}</code> 执行完那一刻，会对调用了 <code>autorelease</code> 方法的对象进行 <code>release</code> 操作：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv<span class="comment">[]</span>) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="keyword">Person</span> *person1 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        <span class="keyword">Person</span> *person2 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        NSLog(@<span class="string">"111"</span>);</div><div class="line">    &#125; // <span class="comment">[person release]</span>、<span class="comment">[person release]</span></div><div class="line">    NSLog(@<span class="string">"222"</span>);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>使用 <code>autorelease</code> 方法管理 person 对象的内存，只需要在调用 <code>alloc</code> 方法的同时调用一下 <code>autorelease</code> 方法，就可以放心的使用 person 对象了，当然是在 <code>@autoreleasepool {}</code> 内部使用。不用再关心 person 对象的释放问题，在 <code>@autoreleasepool {}</code> 执行完那一刻，person 对象会自动调用 <code>release</code> 方法。</p>
<h2 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h2><p>错误演示：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Dog</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Dog</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Dog</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Person</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">&#123;</div><div class="line">    Dog *_dog;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog;</div><div class="line">- (Dog *)dog;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    _dog = dog;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// 调用</span></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// 引用计数：1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person setDog:dog];</div><div class="line">        </div><div class="line">        [dog release]; <span class="comment">// 引用计数：0</span></div><div class="line">        </div><div class="line">        [[person dog] run];</div><div class="line">        </div><div class="line">        [person release];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印信息：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Dog dealloc]</span></div></pre></td></tr></table></figure></p>
<p><code>[[person dog] run]</code> 这个时候 dog 对象因为引用计数为0已经被释放了。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理08.png" alt="内存管理08"></p>
<p><code>[person setDog:dog]</code> 方法表示 person 对象想要用于 dog 对象，那么 person 对象应该对 dog 的引用计数加1，只要 person 对象还在，dog 对象就不可以被释放。</p>
<p>上面的写法有两个地方需要优化：<br>1、Person 类的 <code>- (void)setDog:(Dog *)dog</code> 方法在获取 dog 对象时，引用计数需要加1。<br>2、Person 类的 <code>- (void)dealloc</code> 方法需要对 dog 对象进行 <code>release</code> 操作。  </p>
<p>Person 类优化后：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc]; <span class="comment">// 父类的 dealloc 放到子类后</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    _dog = [dog <span class="keyword">retain</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog run]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>创建两个 person 对象引用 dog 对象：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// dog 引用计数：1</span></div><div class="line">        </div><div class="line">        Person *person1 = [[Person alloc] init];</div><div class="line">        [<span class="meta">person1 setDog:dog</span>]; <span class="comment">// dog 引用计数：2</span></div><div class="line">        </div><div class="line">        Person *person2 = [[Person alloc] init];</div><div class="line">        [<span class="meta">person2 setDog:dog</span>]; <span class="comment">// dog 引用计数：3</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog release</span>]; <span class="comment">// dog 引用计数：2</span></div><div class="line">        </div><div class="line">        [<span class="meta">person1 release</span>]; <span class="comment">// dog 引用计数：1</span></div><div class="line">        </div><div class="line">        [<span class="meta">[person2 dog</span>] run];</div><div class="line">        </div><div class="line">        [<span class="meta">person2 release</span>]; <span class="comment">// dog 引用计数：0</span></div><div class="line">        </div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby">-[Dog run]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h2 id="set-方法"><a href="#set-方法" class="headerlink" title="set 方法"></a>set 方法</h2><p>上面 Person 类里的 set 方法还有问题，在 person 对象替换 dog 对象时会出现不释放的问题：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog1 = [[Dog alloc] init]; <span class="comment">// dog1 : 1</span></div><div class="line">        Dog *dog2 = [[Dog alloc] init]; <span class="comment">// dog2 : 1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog1</span>]; <span class="comment">// dog1 : 2</span></div><div class="line">        [<span class="meta">person setDog:dog2</span>]; <span class="comment">// dog2 : 2</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog1 release</span>]; <span class="comment">// dog1 : 1</span></div><div class="line">        [<span class="meta">dog2 release</span>]; <span class="comment">// dog2 : 1</span></div><div class="line">        [<span class="meta">person release</span>]; <span class="comment">// dog0 : 0</span></div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果和注释可以看到，dog1 最后的引用计数是1，没有释放。这是因为 person 对象在拥有 dog1 时，将 <code>_dog</code> 指向了 dog1 并对其引用计数加1，后又将 <code>_dog</code> 指向了 dog2 并对其引用计数加1，所以 person 对象在调用 <code>[_dog release]</code> 时的 <code>_dog</code> 是 dog2 对象，dog1 对象因此少调用了一次 release 方法，最后的引用计数最后为1无法释放。</p>
<p>优化 set 方法：在 person 对象引用新的 dog 对象时，需要先将之前的 dog 对象进行 release 操作。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = [dog <span class="keyword">retain</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，dog1 和 dog2 对象都被释放调用。但是优化后的 set 方法还不够完善，person 对象在重复设置同一个 dog 对象的时候还是有问题：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// dog1 : 1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog</span>]; <span class="comment">// dog1 : 2</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog release</span>]; <span class="comment">// dog1 : 1</span></div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog</span>]; <span class="comment">// dog1 : 0</span></div><div class="line">        </div><div class="line">        [<span class="meta">person release</span>];</div><div class="line">        </div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>错误信息：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理09.png" alt="内存管理09"></p>
<p>问题出在 Person 类的 set 方法：<br>第一次赋值，dog 对象的引用计数加一，此时 dog 对象的引用计数等于2。<br>dog 对象调用了一次 release 方法，此时 dog 对象的引用计数等于1。<br>第二次赋值，会先调用 <code>[_dog release]</code>, 此时 dog 对象的引用计数等于0，dog 对象被释放。再调用 <code>_dog = [dog retain]</code>，此时 dog 指向的内存已经被销毁了：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    [_dog <span class="built_in">release</span>]; <span class="comment">// dog : 0</span></div><div class="line">    _dog = [dog retain]; <span class="comment">// dog 指向的内存已经被销毁</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因此，在 set 方法里对 <code>_dog</code> 处理前，需要先判断一下 <code>_dog</code> 是否等于传入的 dog 对象。因为一个 person 对象在拥有一个 dog 对象时只需要对其 retain 一次，所以如果 <code>_dog == dog</code> 就不做处理。</p>
<p>优化 Person 类里的 set 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (_dog != dog) &#123;</div><div class="line">        [_dog release];</div><div class="line">        _dog = [dog <span class="keyword">retain</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h2 id="property-属性"><a href="#property-属性" class="headerlink" title="property 属性"></a>property 属性</h2><p>在 .h 文件通过 property 声明的属性，编译器会自动生成成员变量和属性的 setter、getter 实现。</p>
<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, assign) int age;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure>
<p>编译器自动生成：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"></div><div class="line"><span class="meta">@synthesize</span> age = _age;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">setAge:</span>(<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    _age = age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _age;</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="对象类型"><a href="#对象类型" class="headerlink" title="对象类型"></a>对象类型</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, retain) Dog *dog;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure>
<p>编译器自动生成：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line"><span class="keyword">@synthesize</span> dog = _dog;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (_dog != dog) &#123;</div><div class="line">        [_dog release];</div><div class="line">        _dog = [dog <span class="keyword">retain</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>如果是在 MRC 环境下，这种情况下还需要在 delloc 方法里手动调用 _dog 的 release 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="常用代码解析"><a href="#常用代码解析" class="headerlink" title="常用代码解析"></a>常用代码解析</h2><p>创建一个 iOS 项目，设置 MRC 环境。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSMutableArray</span> *data;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *data = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    <span class="keyword">self</span>.data = data;</div><div class="line">    [data release];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.data = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>简化：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad]<span class="comment">;</span></div><div class="line">    </div><div class="line">    self<span class="meta">.data</span> = [[NSMutableArray alloc] init]<span class="comment">;</span></div><div class="line">    [self<span class="meta">.data</span> release]<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>autorelease</code>：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    <span class="comment">[super viewDidLoad]</span>;</div><div class="line">    </div><div class="line">    self.data = <span class="comment">[<span class="comment">[<span class="comment">[NSMutableArray alloc]</span> init]</span> autorelease]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>+array</code>：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.data = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不是通过 <code>alloc</code> 方法初始化的，而是通过类方法初始化的，在类方法内部已经调用过 <code>autorelease</code> 了。类方法 <code>+array</code> 大概是这样：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)array</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[[<span class="built_in">NSMutableArray</span> alloc] init] autorelease];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)person;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)person</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[[Person alloc] init] autorelease];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        </div><div class="line">        Person *person = [Person person];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h1 id="copy和mutableCopy"><a href="#copy和mutableCopy" class="headerlink" title="copy和mutableCopy"></a>copy和mutableCopy</h1><ul>
<li><p>拷贝的目的：产生一个副本对象，跟原对象互不影响<br>修改了原对象，不会影响副本对象<br>修改了副本对象，不会影响原对象  </p>
</li>
<li><p>iOS 提供了两个拷贝方法<br>1、copy，不可变拷贝，产生不可变副本<br>2、mutableCopy，可变拷贝，产生可变副本  </p>
</li>
</ul>
<h2 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h2><h3 id="NSString-1"><a href="#NSString-1" class="headerlink" title="NSString"></a>NSString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 返回的是 NSString</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 返回的是 NSMutableString</span></div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [str1 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str2 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str3 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0 0 1</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是 str1 和 str2 是不可变字符串，str3 是可变字符串。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<h3 id="NSMutableString"><a href="#NSMutableString" class="headerlink" title="NSMutableString"></a>NSMutableString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableString</span> *str1 = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [str1 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str2 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str3 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">1 0 1</div></pre></td></tr></table></figure></p>
<p>不管是可变字符串还是不可变字符串，调用 <code>copy</code> 返回的都是不可变字符串，调用 <code>mutableCopy</code> 返回的都是可变字符串。</p>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>在 MRC 环境下，调用 alloc、new、copy、mutableCopy 方法返回了一个对象，在不需要这个对象时，要调用 release 或者 autorelease 来释放它。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line"></div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="深拷贝和浅拷贝"><a href="#深拷贝和浅拷贝" class="headerlink" title="深拷贝和浅拷贝"></a>深拷贝和浅拷贝</h2><ul>
<li>深拷贝：内容拷贝，产生新的对象</li>
<li>浅拷贝：指针拷贝，没有产生新的对象</li>
</ul>
<h3 id="NSString-2"><a href="#NSString-2" class="headerlink" title="NSString"></a>NSString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝：指针拷贝，没有产生新对象</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 深拷贝：内容拷贝，又产生新对象</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, str1, str2, str3);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0x100001018 0x100001018 0x1007bb4e0</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是 str1 和 str2 指向的是同一个内存地址，str3 指向的是另一个内存地址。即 str1 通过 <code>copy</code> 方法拷贝出来的副本 str2 还是原对象（str1），而 str1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 str3 是一个新的对象。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理10.png" alt="内存管理10"></p>
<p>👉 拷贝的目的：产生一个副本对象，跟原对象互不影响。<br>str1 是一个不可变字符串对象，通过 <code>copy</code> 方法拷贝出来的副本也是不可变字符串对象。因为不可变字符串对象不可以被修改，不可以被修改就不会互相影响，所以 str1 和 str2 指向同一个对象满足拷贝的原则（互不影响）。而且将 str1 和 str2 指向同一个对象还节省了内存。<br>str1 是一个不可变字符串对象，通过 <code>mutableCopy</code> 方法拷贝出来的副本是可变字符串对象。因为可变字符串对象可以被修改，所以 str3 指向的是一个新的对象，保证在修改 str3 时不会影响到 str1。  </p>
<p>（总的来看，既要保证互不影响，也要做到节省资源）</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str3 = [str2 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSString</span> *str4 = <span class="string">@"test"</span>;</div><div class="line">        <span class="built_in">NSMutableString</span> *str5 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@ %@ %@ %@"</span>, <span class="string">@"test"</span>, str1, str2, str3, str4, str5);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p %p %p %p"</span>, <span class="string">@"test"</span>, str1, str2, str3, str4, str5);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test test test test</div><div class="line">0x100002040 0x100002040 0x100002040 0x100002040 0x100002040 0x1006bd980</div></pre></td></tr></table></figure></p>
<p>str1、str2、str3 和 str4 都是 <code>@&quot;test&quot;</code> 对象。</p>
<p>引用计数：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test111111111"</span>]; <span class="comment">// str1 : 1</span></div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// str1 : 2</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, str1.retainCount);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，str1 在调用 <code>copy</code> 方法后，引用计数加1，相当于调用了一次 <code>retain</code> 方法。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test111111111"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str3 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, [str1 <span class="keyword">class</span>], [str2 <span class="keyword">class</span>], [str3 <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd %zd %zd"</span>, str1.retainCount, str2.retainCount, str3.retainCount);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__NSCFString NSTaggedPointerString __NSCFConstantString</div><div class="line"><span class="number">1</span> <span class="number">-1</span> <span class="number">-1</span></div></pre></td></tr></table></figure></p>
<p>使用 <code>initWithFormat:</code> 方法初始化字符串，字符串长度足够长，创建出来的是 <code>__NSCFString</code> 类型的字符串。<code>__NSCFString</code> 类型的字符串是通过引用计数管理内存的。<br>使用 <code>initWithFormat:</code> 方法初始化字符串，字符串长度不够长，创建出来的是 <code>NSTaggedPointerString</code> 类型的字符串。<code>NSTaggedPointerString</code> 类型的字符串不是通过引用计数管理内存的。<br>使用 <code>initWithString:</code> 方法初始化字符串，不管字符串长度，创建出来的是 <code>__NSCFConstantString</code> 类型的字符串。<code>__NSCFConstantString</code> 类型的字符串不是通过引用计数管理内存的。</p>
<p>ps：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = <span class="string">@"test"</span>;</div><div class="line">        <span class="built_in">NSString</span> *str1_1 = <span class="string">@"test"</span>;</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *str2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2_1 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *str3 = [<span class="built_in">NSString</span> stringWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str3_1 = [<span class="built_in">NSString</span> stringWithString:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *str4 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str4_1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSString</span> *str5 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str5_1 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str1);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str1_1);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str2);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str2_1);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str3_1);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str4);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str4_1);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str5);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, str5_1);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str1_1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str2_1 release];</div><div class="line">        [str3 release];</div><div class="line">        [str3_1 release];</div><div class="line">        [str4 release];</div><div class="line">        [str4_1 release];</div><div class="line">        [str5 release];</div><div class="line">        [str5_1 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">0x100002040</div><div class="line">0x100002040</div><div class="line">------------------</div><div class="line">0x100002040</div><div class="line">0x100002040</div><div class="line">------------------</div><div class="line">0x100002040</div><div class="line">0x100002040</div><div class="line">------------------</div><div class="line">0x1f9d08801e47ec0b</div><div class="line">0x1f9d08801e47ec0b</div><div class="line">------------------</div><div class="line">0x1f9d08801e47ec0b</div><div class="line">0x1f9d08801e47ec0b</div></pre></td></tr></table></figure></p>
<p>通过 <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUStep</a> 查看源码：<br>以 Format 结尾的方法最终调用的都是这个方法：<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(id)</span>initWithFormat:<span class="params">(NSString*)</span>format locale:<span class="params">(NSDictionary*)</span>locale arguments:<span class="params">(va_list)</span>argList;</div></pre></td></tr></table></figure></p>
<p>以 String 结尾的方法最终调用的都是这个方法：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">id</span>)initWithString:(NSString*)<span class="built_in">string</span>;</div></pre></td></tr></table></figure></p>
<h3 id="NSMutableString-1"><a href="#NSMutableString-1" class="headerlink" title="NSMutableString"></a>NSMutableString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableString</span> *str1 = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, str1, str2, str3);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0x103aaab50 0x48301b1a78a3a9e5 0x103aab150</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是他们指向的都是不同的内存地址。即 str1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 str2 和 str3 都是一个新的对象。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理11.png" alt="内存管理11"></p>
<h3 id="NSArray"><a href="#NSArray" class="headerlink" title="NSArray"></a>NSArray</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSArray</span> *arr1 = [[<span class="built_in">NSArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [arr1 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr2 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr3 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">)</div><div class="line"><span class="number">0x1004bfc20</span> <span class="number">0x1004bfc20</span> <span class="number">0x1004c0100</span></div><div class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>arr1 和 arr2 是不可变数组，arr3 是可变数组。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<p>arr1、arr2 和 arr3 打印出来都是同样的内容，但是 arr1 和 arr2 指向的是同一个内存地址，arr3 指向的是另一个内存地址。即 arr1 通过 <code>copy</code> 方法拷贝出来的副本 arr2 还是原对象（arr1），而 arr1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 arr3 是一个新的对象。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSArray</span> *arr1 = [[<span class="built_in">NSArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p %p"</span>, @[<span class="string">@"1"</span>, <span class="string">@"2"</span>], arr1, arr2, arr3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x100713270</span> <span class="number">0x100712d60</span> <span class="number">0x100712d60</span> <span class="number">0x100713240</span></div></pre></td></tr></table></figure></p>
<p>NSArray 和 NSString 不同，<code>@[@&quot;1&quot;, @&quot;2&quot;]</code>、arr1 和 arr2 虽然内容相同，但是它们是不同的对象（arr1 和 arr2 是同一个对象）。</p>
<h3 id="NSMutableArray"><a href="#NSMutableArray" class="headerlink" title="NSMutableArray"></a>NSMutableArray</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableArray</span> *arr1 = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [arr1 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr2 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr3 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">)</div><div class="line"><span class="number">0x100535780</span> <span class="number">0x1005358f0</span> <span class="number">0x100535910</span></div><div class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>arr1 和 arr3 是可变数组，arr2 是不可变数组。即：<br>[可变 copy] -&gt; 不可变<br>[可变 mutableCopy] -&gt; 可变  </p>
<p>arr1、arr2 和 arr3 打印出来都是同样的内容，但是他们指向的都是不同的内存地址。即 arr1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 arr2 和 arr3 都是一个新的对象。</p>
<h3 id="NSDictionary"><a href="#NSDictionary" class="headerlink" title="NSDictionary"></a>NSDictionary</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *dict1 = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value"</span>, <span class="string">@"key"</span>, <span class="literal">nil</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *dict2 = [dict1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict3 = [dict1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, dict1, dict2, dict3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, dict1, dict2, dict3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125;</div><div class="line"><span class="number">0x100491ff0</span> <span class="number">0x100491ff0</span> <span class="number">0x1004923f0</span></div></pre></td></tr></table></figure></p>
<p>dict1 和 dict2 是不可变字典，dict3 是可变字典。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<p>dict1、dict2 和 dict3 打印出来都是同样的内容，但是 dict1 和 dict2 指向的是同一个内存地址，dict3 指向的是另一个内存地址。即 dict1 通过 <code>copy</code> 方法拷贝出来的副本 dict2 还是原对象（dict1），而 dict1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 dict3 是一个新的对象。</p>
<h3 id="NSMutableDictionary"><a href="#NSMutableDictionary" class="headerlink" title="NSMutableDictionary"></a>NSMutableDictionary</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict1 = [<span class="built_in">NSMutableDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value"</span>, <span class="string">@"key"</span>, <span class="literal">nil</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *dict2 = [dict1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict3 = [dict1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, dict1, dict2, dict3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, dict1, dict2, dict3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125;</div><div class="line"><span class="number">0x100463300</span> <span class="number">0x100463900</span> <span class="number">0x100463920</span></div></pre></td></tr></table></figure></p>
<p>dict1 和 dict3 是可变字典，dict2 是不可变字典。即：<br>[可变 copy] -&gt; 不可变<br>[可变 mutableCopy] -&gt; 可变  </p>
<p>dict1、dict2 和 dict3 打印出来都是同样的内容，但是他们指向的都是不同的内存地址。即 dict1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 dict2 和 dict3 都是一个新的对象。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">copy</th>
<th style="text-align:left">mutableCopy</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">NSString</td>
<td style="text-align:left">NSString<br><font color="#FF0000"> 浅拷贝 </font></td>
<td style="text-align:left">NSMutableString<br>深拷贝</td>
</tr>
<tr>
<td style="text-align:left">NSMutableString</td>
<td style="text-align:left">NSString<br>深拷贝</td>
<td style="text-align:left">NSMutableString<br>深拷贝</td>
</tr>
<tr>
<td style="text-align:left">NSArray</td>
<td style="text-align:left">NSArray<br><font color="#FF0000"> 浅拷贝 </font></td>
<td style="text-align:left">NSMutableArray<br>深拷贝</td>
</tr>
<tr>
<td style="text-align:left">NSMutableArray</td>
<td style="text-align:left">NSArray<br>深拷贝</td>
<td style="text-align:left">NSMutableArray<br>深拷贝</td>
</tr>
<tr>
<td style="text-align:left">NSDictionary</td>
<td style="text-align:left">NSDictionary<br><font color="#FF0000"> 浅拷贝 </font></td>
<td style="text-align:left">NSMutableDictionary<br>深拷贝</td>
</tr>
<tr>
<td style="text-align:left">NSMutableDictionary</td>
<td style="text-align:left">NSDictionary<br>深拷贝</td>
<td style="text-align:left">NSDictionary<br>深拷贝</td>
</tr>
</tbody>
</table>
<h2 id="copy策略的property"><a href="#copy策略的property" class="headerlink" title="copy策略的property"></a>copy策略的property</h2><p>定义 Person<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableArray</span> *data;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.data = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">        [person.data addObject:<span class="string">@"123"</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理12.png" alt="内存管理12"></p>
<p><code>data</code> 是 Person 用 <code>copy</code> 策略定义的 <code>NSMutableArray</code>，<code>data</code> 的 set 方法是：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">@implementation Person</span></div><div class="line">- (void)setData:(NSMutableArray *)<span class="meta">data</span></div><div class="line">&#123;</div><div class="line">    <span class="meta">if</span> (_<span class="meta">data</span> != <span class="meta">data</span>) &#123;</div><div class="line">        [_<span class="meta">data</span> release]<span class="comment">;</span></div><div class="line">        _<span class="meta">data</span> = [<span class="meta">data</span> copy]<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">@end</span></div></pre></td></tr></table></figure></p>
<p>在 <code>person.data = [NSMutableArray array]</code> 赋值的这一刻，虽然传入的是一个 <code>NSMutableArray</code>，但是因为是 <code>copy</code> 策略，所以在赋值时需要进行 <code>copy</code> 操作 <code>_data = [data copy]</code>，所以 <code>_data</code> 是一个 <code>NSArray</code> 类型的不可变数组。</p>
<p>对于可变类型的变量，在声明时使用 <code>strong</code> 策略。<br>对于不可变类型的变量，在声明时使用 <code>copy</code> 策略。</p>
<p>比如 <code>UITextField</code> 里的 text、attributedText 和 placeholder 等，都是使用的 copy 策略，保证不管传入的是可变类型还是不可变类型，<code>UITextField</code> 内部使用的都是不可变类型：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UITextField</span> : <span class="title">UIControl</span> &lt;<span class="title">UITextInput</span>, <span class="title">NSCoding</span>, <span class="title">UIContentSizeCategoryAdjusting</span>&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)   <span class="built_in">NSString</span>               *text;                 <span class="comment">// default is nil</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)   <span class="built_in">NSAttributedString</span>     *attributedText API_AVAILABLE(ios(<span class="number">6.0</span>)); <span class="comment">// default is nil</span></div><div class="line">......</div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)   <span class="built_in">NSString</span>               *placeholder;          <span class="comment">// default is nil. string is drawn 70% gray</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nullable</span>, <span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)   <span class="built_in">NSAttributedString</span>     *attributedPlaceholder API_AVAILABLE(ios(<span class="number">6.0</span>)); <span class="comment">// default is nil</span></div></pre></td></tr></table></figure></p>
<h2 id="copyWithZone"><a href="#copyWithZone" class="headerlink" title="copyWithZone:"></a>copyWithZone:</h2><p>对象类型进行 <code>copy</code> 操作，首先要遵守 <code>&lt;NSCopying&gt;</code> 协议，然后实现 <code>- (id)copyWithZone:(struct _NSZone *)zone</code> 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> &lt;<span class="title">NSCopying</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> weight;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">id</span>)copyWithZone:(<span class="keyword">struct</span> _NSZone *)zone</div><div class="line">&#123;</div><div class="line">    Person *person = [Person allocWithZone:zone];</div><div class="line">    <span class="comment">// 设置需要拷贝的属性</span></div><div class="line">    person.age = <span class="keyword">self</span>.age;</div><div class="line">    person.weight = <span class="keyword">self</span>.weight;</div><div class="line">    <span class="keyword">return</span> person;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSString</span> *)description</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"age = %d, weight = %d"</span>, <span class="keyword">self</span>.age, <span class="keyword">self</span>.weight];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.age = <span class="number">10</span>;</div><div class="line">        person.weight = <span class="number">20</span>;</div><div class="line">        </div><div class="line">        Person *person2 = [person <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"&#123;%@&#125; &#123;%@&#125;"</span>, person, person2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;age = <span class="number">10</span>, weight = <span class="number">20</span>&#125; &#123;age = <span class="number">10</span>, weight = <span class="number">20</span>&#125;</div></pre></td></tr></table></figure></p>
<h1 id="引用计数的存储"><a href="#引用计数的存储" class="headerlink" title="引用计数的存储"></a>引用计数的存储</h1><p>在 64bit 中，引用计数可以直接存储在优化过的 isa 指针中，也可能存储在 SideTable 类中。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></div><div class="line">    <span class="keyword">spinlock_t</span> slock;</div><div class="line">    RefcountMap refcnts; <span class="comment">// 一个存放着对象引用计数的散列表</span></div><div class="line">    <span class="keyword">weak_table_t</span> weak_table; <span class="comment">// 弱引用表</span></div><div class="line">    ......</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在 objc-weak.h 文件查看 <code>weak_table_t</code> 定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_table_t</span> &#123;</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *weak_entries; <span class="comment">// 数组地址（首元素地址）</span></div><div class="line">    <span class="keyword">size_t</span>    num_entries; <span class="comment">// 数组的数量</span></div><div class="line">    <span class="keyword">uintptr_t</span> mask; <span class="comment">// 数组下标最大值（weak_table_t的size-1）</span></div><div class="line">    <span class="keyword">uintptr_t</span> max_hash_displacement; <span class="comment">// 最大hash偏移量</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="retainCount"><a href="#retainCount" class="headerlink" title="retainCount"></a>retainCount</h2><p>在 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 NSObject.mm 文件中查看 <code>retainCount</code>：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (NSUInteger)retainCount &#123;</div><div class="line">    <span class="keyword">return</span> _objc_rootRetainCount(<span class="built_in">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="params">...</span><span class="params">...</span></div><div class="line"></div><div class="line">uintptr_t</div><div class="line">_objc_rootRetainCount(id obj)</div><div class="line">&#123;</div><div class="line">    ASSERT(obj);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj-&gt;rootRetainCount();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 objc-object.h 文件中查看 <code>rootRetainCount()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> <span class="keyword">uintptr_t</span> </div><div class="line">objc_object::rootRetainCount()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>)<span class="keyword">this</span>;</div><div class="line"></div><div class="line">    sidetable_lock();</div><div class="line">    <span class="keyword">isa_t</span> bits = LoadExclusive(&amp;isa.bits);</div><div class="line">    ClearExclusive(&amp;isa.bits);</div><div class="line">    <span class="keyword">if</span> (bits.nonpointer) &#123; <span class="comment">// 非指针类型（优化过的isa指针）</span></div><div class="line">        <span class="keyword">uintptr_t</span> rc = <span class="number">1</span> + bits.extra_rc;</div><div class="line">        <span class="keyword">if</span> (bits.has_sidetable_rc) &#123; <span class="comment">// 引用计数不是存储在isa中，而是存储在sidetable中</span></div><div class="line">            rc += sidetable_getExtraRC_nolock();</div><div class="line">        &#125;</div><div class="line">        sidetable_unlock();</div><div class="line">        <span class="keyword">return</span> rc;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sidetable_unlock();</div><div class="line">    <span class="keyword">return</span> sidetable_retainCount();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 NSObject.mm 文件中查看 <code>sidetable_getExtraRC_nolock()</code> 方法：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">size_t </div><div class="line">objc_object::sidetable_getExtraRC_nolock()</div><div class="line">&#123;</div><div class="line">    ASSERT(isa.nonpointer);</div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>); <span class="comment">//取出对象对应的散列表</span></div><div class="line">    <span class="keyword">if</span> (it == table.refcnts.end()) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>has_sidetable_rc</code>：引用计数器是否过大无法存储在 isa 中，如果为1，那么引用计数会存储在一个叫 SideTable 的类的属性中。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理17.png" alt="内存管理17"></p>
<h2 id="release-1"><a href="#release-1" class="headerlink" title="release"></a>release</h2><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (oneway <span class="literal">void</span>)release &#123;</div><div class="line">    _objc_rootRelease(<span class="built_in">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="params">...</span><span class="params">...</span></div><div class="line"></div><div class="line">NEVER_INLINE <span class="literal">void</span></div><div class="line">_objc_rootRelease(id obj)</div><div class="line">&#123;</div><div class="line">    ASSERT(obj);</div><div class="line"></div><div class="line">    obj-&gt;rootRelease();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 objc-object.h 文件中查看 <code>rootRelease()</code> 方法：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line">ALWAYS_INLINE bool </div><div class="line">objc_object:<span class="type"></span>:rootRelease(bool performDealloc, bool handleUnderflow)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">    bool sideTableLocked = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    isa_t oldisa;</div><div class="line">    isa_t <span class="keyword">new</span><span class="type">isa</span>;</div><div class="line"></div><div class="line"> retry:<span class="type"></span></div><div class="line"><span class="type">    do </span>&#123;</div><div class="line">        oldisa = LoadExclusive(&amp;isa.bits);</div><div class="line">        <span class="keyword">new</span><span class="type">isa</span> = oldisa;</div><div class="line">        <span class="keyword">if</span> (slowpath(!<span class="keyword">new</span><span class="type">isa</span>.nonpointer)) &#123;</div><div class="line">            <span class="comment">// 不是优化过的isa指针</span></div><div class="line">            ClearExclusive(&amp;isa.bits);</div><div class="line">            <span class="keyword">if</span> (rawISA()-&gt;isMetaClass()) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</div><div class="line">            <span class="keyword">return</span> sidetable_release(performDealloc);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// don't check newisa.fast_rr; we already called any RR overrides</span></div><div class="line">        uintptr_t carry;</div><div class="line">        <span class="keyword">new</span><span class="type">isa</span>.bits = subc(<span class="keyword">new</span><span class="type">isa</span>.bits, RC_ONE, <span class="number">0</span>, &amp;carry);  <span class="comment">// extra_rc--</span></div><div class="line">        <span class="comment">// 相减后下溢出</span></div><div class="line">        <span class="keyword">if</span> (slowpath(carry)) &#123;</div><div class="line">            <span class="comment">// don't ClearExclusive()</span></div><div class="line">            goto underflow;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (slowpath(!StoreReleaseExclusive(&amp;isa.bits, </div><div class="line">                                             oldisa.bits, <span class="keyword">new</span><span class="type">isa</span>.bits)));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line"> underflow:<span class="type"></span></div><div class="line"><span class="type">    </span>// <span class="keyword">new</span><span class="type">isa</span>.extra_rc-- underflowed: <span class="type">borrow from side table or deallocate</span></div><div class="line"><span class="type"></span></div><div class="line"><span class="type">    </span>// abandon <span class="keyword">new</span><span class="type">isa</span> to undo the decrement</div><div class="line">    <span class="keyword">new</span><span class="type">isa</span> = oldisa;</div><div class="line"></div><div class="line">    <span class="comment">// 引用计数不是存储在isa中，而是存储在sidetable中 </span></div><div class="line">    <span class="keyword">if</span> (slowpath(<span class="keyword">new</span><span class="type">isa</span>.has_sidetable_rc)) &#123;</div><div class="line">        <span class="keyword">if</span> (!handleUnderflow) &#123;</div><div class="line">            ClearExclusive(&amp;isa.bits);</div><div class="line">            <span class="comment">// 再执行 rootRelease 一次，处理下溢出</span></div><div class="line">            <span class="keyword">return</span> rootRelease_underflow(performDealloc);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Transfer retain count from side table to inline storage.</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!sideTableLocked) &#123;</div><div class="line">            ClearExclusive(&amp;isa.bits);</div><div class="line">            sidetable_lock();</div><div class="line">            sideTableLocked = <span class="literal">true</span>;</div><div class="line">            <span class="comment">// Need to start over to avoid a race against </span></div><div class="line">            <span class="comment">// the nonpointer -&gt; raw pointer transition.</span></div><div class="line">            goto retry;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 下面是从 sideTable 借 RC_HALF 的引用计数放到 extra_rc 上, 借不到的情况，对象需要被销毁了</span></div><div class="line">        <span class="comment">// Try to remove some retain counts from the side table.        </span></div><div class="line">        size_t borrowed = sidetable_subExtraRC_nolock(RC_HALF);</div><div class="line"></div><div class="line">        <span class="comment">// To avoid races, has_sidetable_rc must remain set </span></div><div class="line">        <span class="comment">// even if the side table count is now zero.</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (borrowed &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// Side table retain count decreased.</span></div><div class="line">            <span class="comment">// Try to add them to the inline count.</span></div><div class="line">            <span class="keyword">new</span><span class="type">isa</span>.extra_rc = borrowed - <span class="number">1</span>;  <span class="comment">// redo the original decrement too</span></div><div class="line">            bool stored = StoreReleaseExclusive(&amp;isa.bits, </div><div class="line">                                                oldisa.bits, <span class="keyword">new</span><span class="type">isa</span>.bits);</div><div class="line">            <span class="keyword">if</span> (!stored) &#123;</div><div class="line">                <span class="comment">// Inline update failed. </span></div><div class="line">                <span class="comment">// Try it again right now. This prevents livelock on LL/SC </span></div><div class="line">                <span class="comment">// architectures where the side table access itself may have </span></div><div class="line">                <span class="comment">// dropped the reservation.</span></div><div class="line">                isa_t oldisa2 = LoadExclusive(&amp;isa.bits);</div><div class="line">                isa_t <span class="keyword">new</span><span class="type">isa2</span> = oldisa2;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">isa2</span>.nonpointer) &#123;</div><div class="line">                    uintptr_t overflow;</div><div class="line">                    <span class="keyword">new</span><span class="type">isa2</span>.bits = </div><div class="line">                        addc(<span class="keyword">new</span><span class="type">isa2</span>.bits, RC_ONE * (borrowed<span class="number">-1</span>), <span class="number">0</span>, &amp;overflow);</div><div class="line">                    <span class="keyword">if</span> (!overflow) &#123;</div><div class="line">                        stored = StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </div><div class="line">                                                       <span class="keyword">new</span><span class="type">isa2</span>.bits);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!stored) &#123;</div><div class="line">                <span class="comment">// Inline update failed.</span></div><div class="line">                <span class="comment">// Put the retains back in the side table.</span></div><div class="line">                sidetable_addExtraRC_nolock(borrowed);</div><div class="line">                goto retry;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Decrement successful after borrowing from side table.</span></div><div class="line">            <span class="comment">// This decrement cannot be the deallocating decrement - the side </span></div><div class="line">            <span class="comment">// table lock and has_sidetable_rc bit ensure that if everyone </span></div><div class="line">            <span class="comment">// else tried to -release while we worked, the last one would block.</span></div><div class="line">            sidetable_unlock();</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Side table is empty after all. Fall-through to the dealloc path.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Really deallocate.</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(<span class="keyword">new</span><span class="type">isa</span>.deallocating)) &#123;</div><div class="line">        ClearExclusive(&amp;isa.bits);</div><div class="line">        <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</div><div class="line">        <span class="keyword">return</span> overrelease_error();</div><div class="line">        <span class="comment">// does not actually return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">new</span><span class="type">isa</span>.deallocating = <span class="literal">true</span>;</div><div class="line">    <span class="keyword">if</span> (!StoreExclusive(&amp;isa.bits, oldisa.bits, <span class="keyword">new</span><span class="type">isa</span>.bits)) goto retry;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</div><div class="line"></div><div class="line">    __c11_atomic_thread_fence(__ATOMIC_ACQUIRE);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (performDealloc) &#123;</div><div class="line">        ((void(*)(objc_object *, SEL))objc_msgSend)(<span class="built_in">this</span>, @selector(dealloc));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 NSObject.mm 文件中查看 <code>sidetable_release()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SIDE_TABLE_RC_ONE            (1UL&lt;&lt;2)  <span class="comment">// MSB-ward of deallocating bit</span></span></div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">uintptr_t</span></div><div class="line">objc_object::sidetable_release(<span class="keyword">bool</span> performDealloc)</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></div><div class="line">    ASSERT(!isa.nonpointer);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line"></div><div class="line">    <span class="keyword">bool</span> do_dealloc = <span class="literal">false</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//----- 对引用计数减操作 -----</span></div><div class="line">    table.lock();</div><div class="line">    <span class="keyword">auto</span> it = table.refcnts.try_emplace(<span class="keyword">this</span>, SIDE_TABLE_DEALLOCATING);</div><div class="line">    <span class="keyword">auto</span> &amp;refcnt = it.first-&gt;second;</div><div class="line">    <span class="keyword">if</span> (it.second) &#123;</div><div class="line">        do_dealloc = <span class="literal">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refcnt &lt; SIDE_TABLE_DEALLOCATING) &#123;</div><div class="line">        <span class="comment">// SIDE_TABLE_WEAKLY_REFERENCED may be set. Don't change it.</span></div><div class="line">        do_dealloc = <span class="literal">true</span>;</div><div class="line">        refcnt |= SIDE_TABLE_DEALLOCATING;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! (refcnt &amp; SIDE_TABLE_RC_PINNED)) &#123;</div><div class="line">        refcnt -= SIDE_TABLE_RC_ONE;</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">    <span class="comment">//----- 对引用计数减操作 end -----</span></div><div class="line"></div><div class="line">    <span class="comment">// 是否要执行 dealloc</span></div><div class="line">    <span class="keyword">if</span> (do_dealloc  &amp;&amp;  performDealloc) &#123;</div><div class="line">        ((<span class="keyword">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, @selector(dealloc));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> do_dealloc;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="retain-1"><a href="#retain-1" class="headerlink" title="retain()"></a>retain()</h2><p>在 objc-object.h 文件中查看 <code>retain()</code> 方法：<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">inline id </div><div class="line">objc_object::retain()</div><div class="line">&#123;</div><div class="line">    ASSERT(!isTaggedPointer());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="function"><span class="params">(fastpath(!ISA()-&gt;hasCustomRR()))</span> &#123;</span></div><div class="line"><span class="function">        <span class="title">return</span> <span class="title">sidetable_retain</span><span class="params">()</span>;</span></div><div class="line"><span class="function">    &#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">    <span class="title">return</span> <span class="params">((id(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, @selector(retain))</span>;</span></div><div class="line"><span class="function">&#125;</span></div></pre></td></tr></table></figure></p>
<p>在 NSObject.mm 文件中查看 <code>sidetable_retain()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">id</div><div class="line">objc_object::sidetable_retain()</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></div><div class="line">    ASSERT(!isa.nonpointer);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</div><div class="line">    </div><div class="line">    <span class="comment">//----- 对引用计数加操作 -----</span></div><div class="line">    table.lock();</div><div class="line">    <span class="keyword">size_t</span>&amp; refcntStorage = table.refcnts[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">if</span> (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123;</div><div class="line">        refcntStorage += SIDE_TABLE_RC_ONE;</div><div class="line">    &#125;</div><div class="line">    table.unlock();</div><div class="line">    <span class="comment">//----- 对引用计数加操作 end -----</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> (id)<span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="weak指针的原理"><a href="#weak指针的原理" class="headerlink" title="weak指针的原理"></a>weak指针的原理</h1><h2 id="局部变量的内存管理"><a href="#局部变量的内存管理" class="headerlink" title="局部变量的内存管理"></a>局部变量的内存管理</h2><p>创建局部变量 person：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h3 id="strong"><a href="#strong" class="headerlink" title="__strong"></a>__strong</h3><p>使用 <code>__strong</code> 修饰的局部变量 person：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">strong</span> Person *strongPerson;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        strongPerson = person;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, strongPerson);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">222</div><div class="line">&lt;<span class="keyword">Person</span>: 0x60000177c310&gt;</div><div class="line">-<span class="comment">[Person dealloc]</span></div></pre></td></tr></table></figure></p>
<h3 id="weak"><a href="#weak" class="headerlink" title="__weak"></a>__weak</h3><p>使用 <code>__weak</code> 修饰的局部变量 person：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">weak</span> Person *weakPerson;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        weakPerson = person;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, weakPerson);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div><div class="line"><span class="ruby">(null)</span></div></pre></td></tr></table></figure></p>
<p><code>weakPerson</code> 指针指向的内存地址被销毁后，<code>weakPerson</code> 指针会自动置为 nil。</p>
<h3 id="unsafe-unretained"><a href="#unsafe-unretained" class="headerlink" title="__unsafe_unretained"></a>__unsafe_unretained</h3><p>使用 <code>__unsafe_unretained</code> 修饰的局部变量 person：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">unsafe_unretained</span> Person *unsafePerson;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        unsafePerson = person;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理12.png" alt="内存管理12"></p>
<p>报错的原因是指针 <code>unsafePerson</code> 还在，但是它指向的内存地址已经不存在了。这也是跟 <code>weakPerson</code> 指针相比不同也是不够安全的地方。</p>
<h2 id="dealloc"><a href="#dealloc" class="headerlink" title="dealloc"></a>dealloc</h2><p><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 查看源码：  </p>
<p>NSObject.mm 文件：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- <span class="comment">(void)</span>dealloc &#123;</div><div class="line">    _objc_rootDealloc<span class="comment">(self)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">void</div><div class="line">_objc_rootDealloc<span class="comment">(id obj)</span></div><div class="line">&#123;</div><div class="line">    ASSERT<span class="comment">(obj)</span>;</div><div class="line"></div><div class="line">    obj-&gt;rootDealloc<span class="comment">()</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 objc-object.h 文件查看 <code>rootDealloc()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span></div><div class="line">objc_object::rootDealloc()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span>;  <span class="comment">// fixme necessary?</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fastpath(isa.nonpointer  &amp;&amp;  </div><div class="line">                 !isa.weakly_referenced  &amp;&amp;  </div><div class="line">                 !isa.has_assoc  &amp;&amp;  </div><div class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </div><div class="line">                 !isa.has_sidetable_rc))</div><div class="line">    &#123;</div><div class="line">        assert(!sidetable_present());</div><div class="line">        <span class="built_in">free</span>(<span class="keyword">this</span>);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        object_dispose((id)<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>nonpointer<br>0，代表普通的指针，isa 只存储着 Class、Meta-Class 对象的内存地址<br>1，代表优化过，isa 使用位域存储更多的信息</li>
<li>has_assoc<br>是否有设置过关联对象，如果没有，释放时会更快</li>
<li>has_cxx_dtor<br>是否有 C++ 的析构函数（.cxx_destruct），如果没有，释放时会更快</li>
<li>weakly_referenced<br>是否有被弱引用指向过，如果没有，释放时会更快</li>
<li>has_sidetable_rc<br>引用计数器是否过大无法存储在 isa 中，如果为1，那么引用计数会存储在一个叫 SideTable 的类的属性中</li>
</ul>
<p>如果条件不成立会走到 objc-runtime-new.mm 文件的 <code>object_dispose()</code> 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">id</span> </div><div class="line">object_dispose(<span class="keyword">id</span> obj)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    objc_destructInstance(obj);    </div><div class="line">    free(obj);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line"><span class="keyword">void</span> *objc_destructInstance(<span class="keyword">id</span> obj) </div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj) &#123;</div><div class="line">        <span class="comment">// Read all of the flags at once for performance.</span></div><div class="line">        <span class="keyword">bool</span> cxx = obj-&gt;hasCxxDtor();</div><div class="line">        <span class="keyword">bool</span> assoc = obj-&gt;hasAssociatedObjects();</div><div class="line"></div><div class="line">        <span class="comment">// This order is important.</span></div><div class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj); <span class="comment">// 清除成员变量</span></div><div class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj); <span class="comment">// 移除关联对象</span></div><div class="line">        obj-&gt;clearDeallocating(); <span class="comment">// 将指向当前对象的弱指针置为nil</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 objc-object.h 文件查看 <code>clearDeallocating()</code> 方法：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">inline void </div><div class="line">objc_object::clearDeallocating()</div><div class="line">&#123;</div><div class="line">   <span class="built_in"> if </span>(slowpath(!isa.nonpointer)) &#123; // 是否是普通的isa指针</div><div class="line">        // Slow path for raw pointer isa.</div><div class="line">        sidetable_clearDeallocating();</div><div class="line">    &#125;</div><div class="line">    else<span class="built_in"> if </span>(slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123; // 是否有被弱引用指向过 || // 是否是优化过的isa指针</div><div class="line">        // Slow path for non-pointer isa with weak refs<span class="built_in"> and/or </span>side table data.</div><div class="line">        clearDeallocating_slow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    assert(!sidetable_present());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 NSObject.mm 文件 查看 <code>clearDeallocating_slow()</code> 方法：<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">NEVER_INLINE <span class="keyword">void</span></div><div class="line">objc_object::clearDeallocating_slow()</div><div class="line">&#123;</div><div class="line">    ASSERT(isa<span class="variable">.nonpointer</span>  &amp;&amp;  (isa<span class="variable">.weakly_referenced</span> || isa<span class="variable">.has_sidetable_rc</span>));</div><div class="line"></div><div class="line">    SideTable&amp; <span class="keyword">table</span> = SideTables()[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">table</span><span class="variable">.lock</span>();</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.weakly_referenced</span>) &#123;</div><div class="line">        weak_clear_no_lock(&amp;<span class="keyword">table</span><span class="variable">.weak_table</span>, (id)<span class="keyword">this</span>); <span class="comment">// 清除弱应用</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.has_sidetable_rc</span>) &#123;</div><div class="line">        <span class="keyword">table</span><span class="variable">.refcnts</span><span class="variable">.erase</span>(<span class="keyword">this</span>); <span class="comment">// 清空引用计数</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">table</span><span class="variable">.unlock</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 objc-weak.mm 文件查看 <code>weak_clear_no_lock()</code> 方法：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">void </div><div class="line">weak_clear_no_lock(weak_table_t *weak_table, id referent_id) </div><div class="line">&#123;</div><div class="line">    <span class="comment">// 获取当前对象</span></div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line"></div><div class="line">    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent); <span class="comment">// 传入弱引用表和当前对象的地址值，找到对应的弱引用数组</span></div><div class="line">    <span class="keyword">if</span> (entry == <span class="literal">nil</span>) &#123;</div><div class="line">        return; <span class="comment">// 如果没有表示当前对象没有弱引用，不用处理直接返回</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// zero out references</span></div><div class="line">    weak_referrer_t *referrers;</div><div class="line">    size_t count;</div><div class="line">    </div><div class="line">    <span class="function"><span class="title">if</span> (entry-&gt;</span>out_of_line()) &#123;</div><div class="line">        <span class="function"><span class="title">referrers</span> = entry-&gt;</span>referrers;</div><div class="line">        count = TABLE_SIZE(entry);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="function"><span class="title">referrers</span> = entry-&gt;</span>inline_referrers;</div><div class="line">        count = WEAK_INLINE_COUNT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        objc_object **referrer = referrers[i];</div><div class="line">        <span class="keyword">if</span> (referrer) &#123;</div><div class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</div><div class="line">                *referrer = <span class="literal">nil</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</div><div class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></div><div class="line">                             <span class="string">"This is probably incorrect use of "</span></div><div class="line">                             <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></div><div class="line">                             <span class="string">"Break on objc_weak_error to debug.\n"</span>, </div><div class="line">                             referrer, (void*)*referrer, (void*)referent);</div><div class="line">                objc_weak_error();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    weak_entry_remove(weak_table, entry);</div><div class="line">&#125;</div><div class="line"></div><div class="line">......</div><div class="line"></div><div class="line">static weak_entry_t *</div><div class="line">weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent)</div><div class="line">&#123;</div><div class="line">    ASSERT(referent);</div><div class="line"></div><div class="line">    <span class="function"><span class="title">weak_entry_t</span> *weak_entries = weak_table-&gt;</span>weak_entries; <span class="comment">// 在weak_table中取出weak_entry_t数组</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!weak_entries) return <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="title">size_t</span> begin = hash_pointer(referent) &amp; weak_table-&gt;</span><span class="function"><span class="title">mask</span>; // 通过hash实例对象的地址 &amp; weak_table-&gt;</span>mask得到begin(没有hash冲突的index)，因为是 &amp; mask(<span class="number">2</span>的n次方-<span class="number">1</span>，类似<span class="number">00001111</span>)，所以保证了begin在mask范围内(&lt;=mask)</div><div class="line">    size_t index = begin;</div><div class="line">    size_t hash_displacement = <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="title">while</span> (weak_table-&gt;</span>weak_entries[index].referent != referent) &#123; <span class="comment">// while循环检测hash冲突，如果有冲突,index+1，hash_displacement++（hash冲突偏移量）</span></div><div class="line">        <span class="function"><span class="title">index</span> = (index+1) &amp; weak_table-&gt;</span>mask;</div><div class="line">        <span class="function"><span class="title">if</span> (index == begin) bad_weak_table(weak_table-&gt;</span>weak_entries);</div><div class="line">        hash_displacement++;</div><div class="line">        <span class="function"><span class="title">if</span> (hash_displacement &gt; weak_table-&gt;</span>max_hash_displacement) &#123;</div><div class="line">            return <span class="literal">nil</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="title">return</span> &amp;weak_table-&gt;</span>weak_entries[index];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="自动释放池"><a href="#自动释放池" class="headerlink" title="自动释放池"></a>自动释放池</h1><p>自动释放池的主要底层数据结构是：<code>__AtAutoreleasePool</code>、<code>AutoreleasePoolPage</code>，调用了 <code>autorelease</code> 的对象最终都是通过 <code>AutoreleasePoolPage</code> 对象来管理的。</p>
<h2 id="AtAutoreleasePool"><a href="#AtAutoreleasePool" class="headerlink" title="__AtAutoreleasePool"></a>__AtAutoreleasePool</h2><p>堆代码：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[[Person alloc] init] autorelease];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>找到 main.m 所在文件，在终端输入：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> xcrun -sdk iphoneos clang -arch arm64  -rewrite-objc main.m</span></div></pre></td></tr></table></figure></p>
<p>上面的代码转成 C++ 代码后就是这个样子：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">int main(<span class="name">int</span> argc, const char * argv[]) &#123;</div><div class="line">    &#123;</div><div class="line">        __AtAutoreleasePool __autoreleasepool; </div><div class="line">        Person *person = ((<span class="name">Person</span> *(*)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)((Person *(<span class="name">*</span>)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)((Person *(<span class="name">*</span>)(<span class="name">id</span>, SEL))(<span class="name">void</span> *)objc_msgSend)((id)objc_getClass("Person"), sel_registerName("alloc")), sel_registerName("init")), sel_registerName("autorelease"));</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>简化一下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    &#123;</div><div class="line">        __AtAutoreleasePool __autoreleasepool; </div><div class="line">        Person *person = [[[Person alloc] init] autorelease];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在生成的 main.mm 文件中搜索 <code>__AtAutoreleasePool</code>，<code>__AtAutoreleasePool</code> 是一个 C++ 结构体：<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct __AtAutoreleasePool &#123;</div><div class="line">    <span class="comment">// 构造函数，在创建结构体的时候调用</span></div><div class="line">    __AtAutoreleasePool<span class="comment">()</span> &#123;</div><div class="line">        atautoreleasepoolobj = objc_autoreleasePoolPush<span class="comment">()</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 析构函数，在结构体销毁的时候调用</span></div><div class="line">    ~__AtAutoreleasePool<span class="comment">()</span> &#123;</div><div class="line">        objc_autoreleasePoolPop<span class="comment">(atautoreleasepoolobj)</span>;</div><div class="line">    &#125;</div><div class="line">    void * atautoreleasepoolobj;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>认识了 <code>__AtAutoreleasePool</code> 结构体后，通过 clang 生成的 C++ 代码可以看做：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    atautoreleasepoolobj = objc_autoreleasePoolPush();</div><div class="line"> </div><div class="line">    MJPerson *person = [[[MJPerson alloc] init] autorelease];</div><div class="line"> </div><div class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的摸索，<code>@autoreleasepool {}</code> 的第一个大括号其实是调用了 <code>objc_autoreleasePoolPush()</code> 方法，第二个大括号是调用 <code>objc_autoreleasePoolPop()</code> 方法，<code>objc_autoreleasePoolPop()</code> 方法的参数是 <code>objc_autoreleasePoolPush()</code> 方法生成的 <code>atautoreleasepoolobj</code>。</p>
<p>如果有多个 <code>@autoreleasepool {}</code> 嵌套的话就是这样：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123; <span class="comment">// objc_autoreleasePoolPush()</span></div><div class="line">        </div><div class="line">        <span class="meta">@autoreleasepool</span> &#123; <span class="comment">// objc_autoreleasePoolPush()</span></div><div class="line">            </div><div class="line">            <span class="meta">@autoreleasepool</span> &#123; <span class="comment">// objc_autoreleasePoolPush()</span></div><div class="line">               </div><div class="line">                Person *person = [[[Person alloc] init] autorelease];</div><div class="line">            </div><div class="line">            &#125; <span class="comment">// objc_autoreleasePoolPop()</span></div><div class="line">        </div><div class="line">        &#125; <span class="comment">// objc_autoreleasePoolPop()</span></div><div class="line">    </div><div class="line">    &#125; <span class="comment">// objc_autoreleasePoolPop()</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看 <code>objc_autoreleasePoolPush()</code> 源码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> *</div><div class="line">objc_autoreleasePoolPush(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> AutoreleasePoolPage::push();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看 <code>objc_autoreleasePoolPop()</code> 源码：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NEVER_INLINE</span></div><div class="line"><span class="selector-tag">void</span></div><div class="line"><span class="selector-tag">objc_autoreleasePoolPop</span>(<span class="selector-tag">void</span> *<span class="selector-tag">ctxt</span>)</div><div class="line">&#123;</div><div class="line">    <span class="attribute">AutoreleasePoolPage</span>::<span class="built_in">pop</span>(ctxt);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从源码可以看到，<code>objc_autoreleasePoolPush()</code> 和 <code>objc_autoreleasePoolPop()</code> 方法内部都是通过 <code>AutoreleasePoolPage</code> 实现的。</p>
<h2 id="AutoreleasePoolPage"><a href="#AutoreleasePoolPage" class="headerlink" title="AutoreleasePoolPage"></a>AutoreleasePoolPage</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>在 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 NSObject-internal.h 文件可以看到 AutoreleasePoolPage 的定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span>;</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AutoreleasePoolPageData</span></span></div><div class="line"><span class="class">&#123;</span></div><div class="line">	<span class="keyword">magic_t</span> <span class="keyword">const</span> magic; <span class="comment">// 用于校验内存是否损坏</span></div><div class="line">	__unsafe_unretained id *next; <span class="comment">// 指向了下一个能存放autorelease对象地址的区域</span></div><div class="line">	<span class="keyword">pthread_t</span> <span class="keyword">const</span> thread; <span class="comment">// 线程</span></div><div class="line">	AutoreleasePoolPage * <span class="keyword">const</span> parent; <span class="comment">// 前驱结点，指向前一个page</span></div><div class="line">	AutoreleasePoolPage *child; <span class="comment">// 后继结点，指向下一个page</span></div><div class="line">	<span class="keyword">uint32_t</span> <span class="keyword">const</span> depth;</div><div class="line">	<span class="keyword">uint32_t</span> hiwat;</div><div class="line"></div><div class="line">	AutoreleasePoolPageData(__unsafe_unretained id* _next, <span class="keyword">pthread_t</span> _thread, AutoreleasePoolPage* _parent, <span class="keyword">uint32_t</span> _depth, <span class="keyword">uint32_t</span> _hiwat)</div><div class="line">		: magic(), next(_next), thread(_thread),</div><div class="line">		  parent(_parent), child(nil),</div><div class="line">		  depth(_depth), hiwat(_hiwat)</div><div class="line">	&#123;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutoreleasePoolPage</span> :</span> <span class="keyword">private</span> AutoreleasePoolPageData</div><div class="line">&#123;</div><div class="line">    ......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>AutoreleasePoolPage</code> 结构体的 thread 存储的是其对应的线程，也表示一个 <code>AutoreleasePoolPage</code> 对应一个线程。</p>
<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>每个 <code>AutoreleasePoolPage</code> 对象占用4096字节内存，除了用来存放它内部的成员变量，剩下的空间用来存放 <code>autorelease</code> 对象的地址，所有的 <code>AutoreleasePoolPage</code> 对象通过双向链表的形式连接在一起。</p>
<p>假设 <code>AutoreleasePoolPage</code> 对象的内存地址从 <code>0x1000</code> 开始：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理14.png" alt="内存管理14"><br>从 <code>0x1000</code> 到 <code>0x2000</code> 共4096个字节（<code>0x1000</code>）。<br>从 <code>0x1000</code> 到 <code>0x1038</code> 共56个字节（<code>0x38</code>），即 <code>AutoreleasePoolPage</code> 结构体内部的成员变量大小之和。<br>从 <code>0x1038</code> 到 <code>0x2000</code> 共4040个字节，分别是 <code>begain()</code> 和 <code>end()</code> 方法调用的位置，这段内存用来保存调用了 <code>autorelease</code> 方法的对象的地址值。  </p>
<p>查看 <code>begain()</code> 方法源码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">id * <span class="title">begin</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (id *) ((<span class="keyword">uint8_t</span> *)<span class="keyword">this</span>+<span class="keyword">sizeof</span>(*<span class="keyword">this</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <code>begain()</code> 方法内部直接返回的是 <code>AutoreleasePoolPage</code> 内存地址开始位置加上其自身占用内存大小（<code>0x1000</code> + <code>0x38</code> = <code>0x1038</code>）。</p>
<p>查看 <code>end()</code> 方法源码：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">id</span> * <span class="keyword">end</span>() &#123;</div><div class="line"><span class="built_in">    return</span> (<span class="built_in">id</span> *) ((uint8_t *)this+SIZE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到 <code>end()</code> 方法内部直接返回的是 <code>AutoreleasePoolPage</code> 内存地址开始位置加上 <code>SIZE</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> I386_PGBYTES            4096            <span class="comment">/* bytes per 80386 page */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE               I386_PGBYTES</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_MAX_SIZE           PAGE_SIZE</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="keyword">const</span> SIZE =</div><div class="line">#<span class="keyword">if</span> PROTECT_AUTORELEASEPOOL</div><div class="line">		PAGE_MAX_SIZE;  <span class="comment">// must be multiple of vm page size</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">		PAGE_MIN_SIZE;  <span class="comment">// size and alignment, power of 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>一个 <code>AutoreleasePoolPage</code> 结构体能够存放的 <code>autorelease</code> 对象的地址是有限的，如果超出存储最大值，会新创建一个 <code>AutoreleasePoolPage</code> 结构体用来存储剩下的部分。多个 <code>AutoreleasePoolPage</code> 结构体通过机构体中的 child 指向下一个 <code>AutoreleasePoolPage</code> 结构体，通过 parent 指向上一个 <code>AutoreleasePoolPage</code> 结构体，构成双向链表结构：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理15.png" alt="内存管理15"></p>
<ul>
<li>👉 双向链表也叫双链表，是链表的一种，它的每个数据结点中都有两个指针，分别指向直接后继和直接前驱。所以，从双向链表中的任意一个结点开始，都可以很方便地访问它的前驱结点和后继结点。</li>
<li>👉 循环链表是另一种形式的链式存贮结构。它的特点是表中最后一个结点的指针域指向头结点，整个链表形成一个环。</li>
</ul>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>调用 <code>push</code> 方法会将一个 <code>POOL_BOUNDARY</code> 入栈，并且返回其存放的内存地址。<br>调用 <code>pop</code> 方法时传入一个 <code>POOL_BOUNDARY</code> 的内存地址，会从最后一个入栈的对象开始发送 <code>release</code> 消息，直到遇到这个 <code>POOL_BOUNDARY</code>。<br><code>id *next</code> 指向了下一个能存放 <code>autorelease</code> 对象地址的区域。    </p>
<p>比如在 <code>@autoreleasepool {}</code> 内创建1000个 person 对象调用 <code>autorelease</code>。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">            Person *person = [[[Person alloc] init] autorelease];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一个 person 对象的指针占8个字节，1000个 person 对象就是8000个字节。一个 <code>AutoreleasePoolPage</code> 对象可以保存4040个字节，所以会再创建一个 <code>AutoreleasePoolPage</code> 对象用来保存剩下的 person 对象的地址值。</p>
<p>将 <code>@autoreleasepool {}</code> 转成 <code>__AtAutoreleasePool</code>：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    atautoreleasepoolobj = objc_autoreleasePoolPush(); <span class="comment">// atautoreleasepoolobj = 0x1038</span></div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        Person *person = [[[Person alloc] init] autorelease];</div><div class="line">    &#125; <span class="comment">// 8000个字节</span></div><div class="line"></div><div class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj); <span class="comment">// atautoreleasepoolobj = 0x1038</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>objc_autoreleasePoolPush()</code> 会调用 <code>AutoreleasePoolPage</code> 对象的 <code>push()</code> 方法，将一个 <code>POOL_BOUNDARY</code> 入栈，并且返回其存放的内存地址（<code>0x1038</code>）：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理18.png" alt="内存管理18"></p>
<p>每个调用 <code>autorelease</code> 方法的 person 对象都会添加到 <code>AutoreleasePoolPage</code> 对象中：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理19.png" alt="内存管理19"><br>正如上面提到的一样，一个 <code>AutoreleasePoolPage</code> 对象可以保存4040个字节，所以会创建一个新的 <code>AutoreleasePoolPage</code> 对象用来保存剩下的 person 对象的地址值。</p>
<p><code>objc_autoreleasePoolPop(atautoreleasepoolobj)</code> 方法传入的 <code>atautoreleasepoolobj</code> 是 <code>objc_autoreleasePoolPush()</code> 方法返回的 <code>POOL_BOUNDARY</code> 的地址值（<code>0x1038</code>），即 <code>objc_autoreleasePoolPop(POOL_BOUNDARY)</code>。拿到 <code>POOL_BOUNDARY</code> 后，<code>objc_autoreleasePoolPop()</code> 方法内部会从最后一个加入到 <code>AutoreleasePoolPage</code> 里的对象开始，依次调用 <code>release</code> 方法，直到 <code>POOL_BOUNDARY</code> 完成释放工作。</p>
<p>在整个过程中，<code>next</code> 指向 page 中下一个将要存放的对象的地址, 通过 <code>*next++ = obj</code> 来实现对象的存入并 <code>next</code> 指针的累加, 用 <code>id obj = *--page-&gt;next</code> 来取出要 <code>release</code> 的对象并实现 <code>next</code> 的递减。</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>可以通过以下私有函数来查看自动释放池的情况：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">void</span> _objc_autoreleasePoolPrint(<span class="keyword">void</span>);</div></pre></td></tr></table></figure></p>
<p><code>_objc_autoreleasePoolPrint()</code> 方法是定义在 Runtime 里的，所以是不开源的。但是可以通过 <code>extern</code> 关键字在 main.m 文件中声明，编译器就会自动去找到这个方法，从而实现调用。<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">extern void _objc_autoreleasePoolPrint(void);</div><div class="line"></div><div class="line">int main(int argc, const char * argv<span class="comment">[]</span>) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line"></div><div class="line">        _objc_autoreleasePoolPrint(); // 位置0</div><div class="line"></div><div class="line">        <span class="keyword">Person</span> *person1 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        <span class="keyword">Person</span> *person2 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        </div><div class="line">        //_objc_autoreleasePoolPrint(); // 位置1</div><div class="line"></div><div class="line">        @autoreleasepool &#123;</div><div class="line">            <span class="keyword">Person</span> *person3 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">            <span class="keyword">Person</span> *person4 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line"></div><div class="line">            //_objc_autoreleasePoolPrint(); // 位置2</div><div class="line"></div><div class="line">            @autoreleasepool &#123;</div><div class="line">                <span class="keyword">Person</span> *person5 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">                <span class="keyword">Person</span> *person6 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line"></div><div class="line">                //_objc_autoreleasePoolPrint(); // 位置3</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            //_objc_autoreleasePoolPrint(); // 位置4</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //_objc_autoreleasePoolPrint(); // 位置5</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //_objc_autoreleasePoolPrint(); // 位置6</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>位置0，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13812</span>]: ##############</div><div class="line">objc[<span class="number">13812</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13812</span>]: <span class="number">0</span> releases pending.</div><div class="line">objc[<span class="number">13812</span>]: [<span class="number">0x1</span>]  ................  PAGE (placeholder)</div><div class="line">objc[<span class="number">13812</span>]: [<span class="number">0x1</span>]  ################  POOL (placeholder)</div><div class="line">objc[<span class="number">13812</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置1，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13633</span>]: ##############</div><div class="line">objc[<span class="number">13633</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13633</span>]: <span class="number">3</span> releases pending.</div><div class="line">objc[<span class="number">13633</span>]: [<span class="number">0x10400a000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13633</span>]: [<span class="number">0x10400a038</span>]  ################  POOL <span class="number">0x10400a038</span></div><div class="line">objc[<span class="number">13633</span>]: [<span class="number">0x10400a040</span>]       <span class="number">0x10293c6e0</span>  Person</div><div class="line">objc[<span class="number">13633</span>]: [<span class="number">0x10400a048</span>]       <span class="number">0x10293b7a0</span>  Person</div><div class="line">objc[<span class="number">13633</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置2，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13658</span>]: ##############</div><div class="line">objc[<span class="number">13658</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13658</span>]: <span class="number">6</span> releases pending.</div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a038</span>]  ################  POOL <span class="number">0x10400a038</span></div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a040</span>]       <span class="number">0x102974880</span>  Person</div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a048</span>]       <span class="number">0x102973940</span>  Person</div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a050</span>]  ################  POOL <span class="number">0x10400a050</span></div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a058</span>]       <span class="number">0x1029722e0</span>  Person</div><div class="line">objc[<span class="number">13658</span>]: [<span class="number">0x10400a060</span>]       <span class="number">0x102973800</span>  Person</div><div class="line">objc[<span class="number">13658</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置3，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13677</span>]: ##############</div><div class="line">objc[<span class="number">13677</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13677</span>]: <span class="number">9</span> releases pending.</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d038</span>]  ################  POOL <span class="number">0x10280d038</span></div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d040</span>]       <span class="number">0x1006addd0</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d048</span>]       <span class="number">0x1006ace90</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d050</span>]  ################  POOL <span class="number">0x10280d050</span></div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d058</span>]       <span class="number">0x1006ab830</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d060</span>]       <span class="number">0x1006acd50</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d068</span>]  ################  POOL <span class="number">0x10280d068</span></div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d070</span>]       <span class="number">0x1006aba20</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: [<span class="number">0x10280d078</span>]       <span class="number">0x1006ab4f0</span>  Person</div><div class="line">objc[<span class="number">13677</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置4，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13703</span>]: ##############</div><div class="line">objc[<span class="number">13703</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13703</span>]: <span class="number">6</span> releases pending.</div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d038</span>]  ################  POOL <span class="number">0x10080d038</span></div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d040</span>]       <span class="number">0x100437c20</span>  Person</div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d048</span>]       <span class="number">0x100436ce0</span>  Person</div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d050</span>]  ################  POOL <span class="number">0x10080d050</span></div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d058</span>]       <span class="number">0x100435680</span>  Person</div><div class="line">objc[<span class="number">13703</span>]: [<span class="number">0x10080d060</span>]       <span class="number">0x100436ba0</span>  Person</div><div class="line">objc[<span class="number">13703</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置5，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13735</span>]: ##############</div><div class="line">objc[<span class="number">13735</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13735</span>]: <span class="number">3</span> releases pending.</div><div class="line">objc[<span class="number">13735</span>]: [<span class="number">0x10480a000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13735</span>]: [<span class="number">0x10480a038</span>]  ################  POOL <span class="number">0x10480a038</span></div><div class="line">objc[<span class="number">13735</span>]: [<span class="number">0x10480a040</span>]       <span class="number">0x10322c4d0</span>  Person</div><div class="line">objc[<span class="number">13735</span>]: [<span class="number">0x10480a048</span>]       <span class="number">0x10322b590</span>  Person</div><div class="line">objc[<span class="number">13735</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>位置6，打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13751</span>]: ##############</div><div class="line">objc[<span class="number">13751</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13751</span>]: <span class="number">0</span> releases pending.</div><div class="line">objc[<span class="number">13751</span>]: [<span class="number">0x10300d000</span>]  ................  PAGE  (hot) (cold)</div><div class="line">objc[<span class="number">13751</span>]: ##############</div><div class="line">Program ended <span class="keyword">with</span> exit <span class="keyword">code</span>: <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>打印结果中的 <code>POOL</code> 代表的就是 <code>POOL_BOUNDARY</code>，person 代表的就是调用 <code>autorelease</code> 方法的对象。<code>releases pending</code> 表示当前自动释放池里的对象个数。 </p>
<p>多个 <code>AutoreleasePoolPage</code> 对象的情况：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">extern void _objc_autoreleasePoolPrint(void);</div><div class="line"></div><div class="line">int main(int argc, const char * argv<span class="comment">[]</span>) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="keyword">Person</span> *person1 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        <span class="keyword">Person</span> *person2 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line"></div><div class="line">        @autoreleasepool &#123;</div><div class="line">            for (int i=0; i&lt;600; i++) &#123;</div><div class="line">                <span class="keyword">Person</span> *person3 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            @autoreleasepool &#123;</div><div class="line">                <span class="keyword">Person</span> *person5 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">                <span class="keyword">Person</span> *person6 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line"></div><div class="line">                _objc_autoreleasePoolPrint();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">objc[<span class="number">13947</span>]: ##############</div><div class="line">objc[<span class="number">13947</span>]: AUTORELEASE POOLS for thread <span class="number">0x1000d3dc0</span></div><div class="line">objc[<span class="number">13947</span>]: <span class="number">607</span> releases pending.</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c000</span>]  ................  PAGE (full)  (cold)</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c038</span>]  ################  POOL <span class="number">0x10280c038</span></div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c040</span>]       <span class="number">0x10067bc20</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c048</span>]       <span class="number">0x10067a1d0</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c050</span>]  ################  POOL <span class="number">0x10280c050</span></div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c058</span>]       <span class="number">0x100679d60</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c060</span>]       <span class="number">0x100678e20</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c068</span>]       <span class="number">0x1006777c0</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280c070</span>]       <span class="number">0x100678ce0</span>  Person</div><div class="line">...</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280cff8</span>]       <span class="number">0x100681ba0</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a000</span>]  ................  PAGE  (hot) </div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a038</span>]       <span class="number">0x100681bb0</span>  Person</div><div class="line">...</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a348</span>]       <span class="number">0x1006821d0</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a350</span>]  ################  POOL <span class="number">0x10280a350</span></div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a358</span>]       <span class="number">0x1006821e0</span>  Person</div><div class="line">objc[<span class="number">13947</span>]: [<span class="number">0x10280a360</span>]       <span class="number">0x1006821f0</span>  Person</div></pre></td></tr></table></figure></p>
<p>从打印结果中可以看到，第一个 page 里有两个 <code>POOL_BOUNDARY</code>，由于对象太多超出了第一个 page 的存储范围，所以创建出了第二个 page。第二个 page 中存储了多出来的 person 对象，还有一个 <code>POOL_BOUNDARY</code>。<br><code>PAGE  (hot)</code> 表示该 page 为当前页，<code>PAGE (full)  (cold)</code> 中的 full 表示这一页已经满了，cold 表示该 page 不是当前页。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><code>objc_autoreleasePoolPush()</code> 方法的实现原理是调用 <code>AutoreleasePoolPage</code> 对象的 <code>push()</code> 方法。<br><code>objc_autoreleasePoolPop()</code> 方法的实现原理是调用 <code>AutoreleasePoolPage</code> 对象的 <code>pop()</code> 方法。<br><code>autorelease</code> 方法的实现原理则是调用了 <code>AutoreleasePoolPage</code> 对象的 <code>autorelease()</code> 方法。</p>
<p>在 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 中的 NSObject.mm 文件查看。</p>
<h4 id="objc-autoreleasePoolPush-void"><a href="#objc-autoreleasePoolPush-void" class="headerlink" title="objc_autoreleasePoolPush(void)"></a>objc_autoreleasePoolPush(void)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> *</div><div class="line">objc_autoreleasePoolPush(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> AutoreleasePoolPage::push();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>push()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    id *dest;</div><div class="line">    <span class="keyword">if</span> (slowpath(DebugPoolAllocation)) &#123;</div><div class="line">        dest = autoreleaseNewPage(POOL_BOUNDARY); <span class="comment">// 传入 POOL_BOUNDARY 来新建一个 AutoreleasePoolPage 对象</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        dest = autoreleaseFast(POOL_BOUNDARY); <span class="comment">// AutoreleasePoolPage 对象已经存在就直接添加</span></div><div class="line">    &#125;</div><div class="line">    ASSERT(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY);</div><div class="line">    <span class="keyword">return</span> dest;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果 page 不存在就调用 <code>autoreleaseNewPage()</code> 方法传入 <code>POOL_BOUNDARY</code> 创建：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">static __attribute__((noinline))</div><div class="line">id *autoreleaseNewPage(id obj)</div><div class="line">&#123;</div><div class="line">    AutoreleasePoolPage *<span class="built_in">page</span> = hotPage(); <span class="comment">// 获取当前 page</span></div><div class="line">    <span class="keyword">if</span> (<span class="built_in">page</span>) return autoreleaseFullPage(obj, <span class="built_in">page</span>);</div><div class="line">    <span class="keyword">else</span> return autoreleaseNoPage(obj);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static inline AutoreleasePoolPage *hotPage() </div><div class="line">&#123;</div><div class="line">    AutoreleasePoolPage *result = (AutoreleasePoolPage *)</div><div class="line">        tls_get_direct(key);</div><div class="line">    <span class="keyword">if</span> ((id *)result == EMPTY_POOL_PLACEHOLDER) return <span class="literal">nil</span>;</div><div class="line">    <span class="function"><span class="title">if</span> (result) result-&gt;</span>fastcheck();</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static __attribute__((noinline))</div><div class="line">id *autoreleaseFullPage(id obj, AutoreleasePoolPage *<span class="built_in">page</span>)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// The hot page is full. </span></div><div class="line">    <span class="comment">// Step to the next non-full page, adding a new page if necessary.</span></div><div class="line">    <span class="comment">// Then add the object to that page.</span></div><div class="line">    ASSERT(<span class="built_in">page</span> == hotPage());</div><div class="line">    ASSERT(<span class="function"><span class="title">page</span>-&gt;</span>full()  ||  DebugPoolAllocation);</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="function"><span class="title">if</span> (<span class="built_in">page</span>-&gt;</span><span class="function"><span class="title">child</span>) <span class="built_in">page</span> = <span class="built_in">page</span>-&gt;</span>child;</div><div class="line">        <span class="keyword">else</span> <span class="built_in">page</span> = new AutoreleasePoolPage(<span class="built_in">page</span>);</div><div class="line">    &#125; <span class="function"><span class="title">while</span> (<span class="built_in">page</span>-&gt;</span>full());</div><div class="line"></div><div class="line">    setHotPage(<span class="built_in">page</span>);</div><div class="line">    <span class="function"><span class="title">return</span> <span class="built_in">page</span>-&gt;</span>add(obj); <span class="comment">// 入栈 POOL_BOUNDARY</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果 <code>AutoreleasePoolPage</code> 对象已经存在就直接调用 <code>autoreleaseFast()</code> 方法添加 <code>POOL_BOUNDARY</code>：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static inline id *autoreleaseFast(id obj)</div><div class="line">&#123;</div><div class="line">    AutoreleasePoolPage *<span class="built_in">page</span> = hotPage();</div><div class="line">    <span class="function"><span class="title">if</span> (<span class="built_in">page</span> &amp;&amp; !<span class="built_in">page</span>-&gt;</span>full()) &#123; <span class="comment">// page 存在 &amp;&amp; page 没有满</span></div><div class="line">        <span class="function"><span class="title">return</span> <span class="built_in">page</span>-&gt;</span>add(obj); <span class="comment">// 添加 obj</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">page</span>) &#123; <span class="comment">// page 存在 &amp;&amp; page 满了</span></div><div class="line">        return autoreleaseFullPage(obj, <span class="built_in">page</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// page 不存在</span></div><div class="line">        return autoreleaseNoPage(obj);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="id-autorelease"><a href="#id-autorelease" class="headerlink" title="- (id)autorelease"></a>- (id)autorelease</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">id</span>)autorelease &#123;</div><div class="line">    <span class="keyword">return</span> _objc_rootAutorelease(<span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">NEVER_INLINE <span class="keyword">id</span></div><div class="line">_objc_rootAutorelease(<span class="keyword">id</span> obj)</div><div class="line">&#123;</div><div class="line">    ASSERT(obj);</div><div class="line">    <span class="keyword">return</span> obj-&gt;rootAutorelease();</div><div class="line">&#125;</div><div class="line"></div><div class="line">__attribute__((noinline,used))</div><div class="line"><span class="keyword">id</span> </div><div class="line">objc_object::rootAutorelease2()</div><div class="line">&#123;</div><div class="line">    ASSERT(!isTaggedPointer());</div><div class="line">    <span class="keyword">return</span> AutoreleasePoolPage::autorelease((<span class="keyword">id</span>)<span class="keyword">this</span>); <span class="comment">// 将当前对象 this 加入 page</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>autorelease((id)this)</code> 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">id</span> autorelease(<span class="keyword">id</span> obj)</div><div class="line">&#123;</div><div class="line">    ASSERT(obj);</div><div class="line">    ASSERT(!obj-&gt;isTaggedPointer());</div><div class="line">    <span class="keyword">id</span> *dest __unused = autoreleaseFast(obj); <span class="comment">// 添加 obj</span></div><div class="line">    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  *dest == obj);</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用 <code>autoreleaseFast()</code> 方法添加 obj：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static inline id *autoreleaseFast(id obj)</div><div class="line">&#123;</div><div class="line">    AutoreleasePoolPage *<span class="built_in">page</span> = hotPage();</div><div class="line">    <span class="function"><span class="title">if</span> (<span class="built_in">page</span> &amp;&amp; !<span class="built_in">page</span>-&gt;</span>full()) &#123; <span class="comment">// page 存在 &amp;&amp; page 没有满</span></div><div class="line">        <span class="function"><span class="title">return</span> <span class="built_in">page</span>-&gt;</span>add(obj); <span class="comment">// 添加 obj</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">page</span>) &#123; <span class="comment">// page 存在 &amp;&amp; page 满了</span></div><div class="line">        return autoreleaseFullPage(obj, <span class="built_in">page</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// page 不存在</span></div><div class="line">        return autoreleaseNoPage(obj);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>autorelease</code> 方法最终是通过调用 <code>autoreleaseFast()</code> 方法，将调用了 <code>autorelease</code> 方法的对象保存到了 page 中。</p>
<h4 id="objc-autoreleasePoolPop-void-ctxt"><a href="#objc-autoreleasePoolPop-void-ctxt" class="headerlink" title="objc_autoreleasePoolPop(void *ctxt)"></a>objc_autoreleasePoolPop(void *ctxt)</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NEVER_INLINE</span></div><div class="line"><span class="selector-tag">void</span></div><div class="line"><span class="selector-tag">objc_autoreleasePoolPop</span>(<span class="selector-tag">void</span> *<span class="selector-tag">ctxt</span>)</div><div class="line">&#123;</div><div class="line">    <span class="attribute">AutoreleasePoolPage</span>::<span class="built_in">pop</span>(ctxt);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>pop()</code> 方法：<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">static inline void</div><div class="line"><span class="keyword">pop</span>(void *<span class="built_in">token</span>)</div><div class="line">&#123;</div><div class="line">    AutoreleasePoolPage *page;</div><div class="line">    id *<span class="keyword">stop</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="built_in">token</span> == (void*)EMPTY_POOL_PLACEHOLDER) &#123;</div><div class="line">        page = hotPage(); <span class="comment">// 从当前的 page 开始 pop</span></div><div class="line">        <span class="keyword">if</span> (!page) &#123;</div><div class="line">            <span class="comment">// Pool was never used. Clear the placeholder.</span></div><div class="line">            <span class="keyword">return</span> setHotPage(nil);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Pool was used. Pop its contents normally.</span></div><div class="line">        <span class="comment">// Pool pages remain allocated for re-use as usual.</span></div><div class="line">        page = coldPage();</div><div class="line">        <span class="built_in">token</span> = page-&gt;begin();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        page = pageForPointer(<span class="built_in">token</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">stop</span> = (id *)<span class="built_in">token</span>;</div><div class="line">    <span class="keyword">if</span> (*<span class="keyword">stop</span> != POOL_BOUNDARY) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">stop</span> == page-&gt;begin()  &amp;&amp;  !page-&gt;parent) &#123;</div><div class="line">            <span class="comment">// Start of coldest page may correctly not be POOL_BOUNDARY:</span></div><div class="line">            <span class="comment">// 1. top-level pool is popped, leaving the cold page in place</span></div><div class="line">            <span class="comment">// 2. an object is autoreleased with no pool</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Error. For bincompat purposes this is not </span></div><div class="line">            <span class="comment">// fatal in executables built with old SDKs.</span></div><div class="line">            <span class="keyword">return</span> badPop(<span class="built_in">token</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(PrintPoolHiwat || DebugPoolAllocation || DebugMissingPools)) &#123;</div><div class="line">        <span class="keyword">return</span> popPageDebug(<span class="built_in">token</span>, page, <span class="keyword">stop</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> popPage&lt;false&gt;(<span class="built_in">token</span>, page, <span class="keyword">stop</span>); <span class="comment">// 释放对象</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>popPageDebug()</code> 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">__attribute__((noinline, cold))</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span></div><div class="line">popPageDebug(<span class="keyword">void</span> *token, AutoreleasePoolPage *page, id *stop)</div><div class="line">&#123;</div><div class="line">    popPage&lt;<span class="literal">true</span>&gt;(token, page, stop);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>popPage()</code> 方法：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">template&lt;bool allowDebug&gt;</div><div class="line">static void</div><div class="line">popPage(void *token, AutoreleasePoolPage *<span class="built_in">page</span>, id *stop)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (allowDebug &amp;&amp; PrintPoolHiwat) printHiwat();</div><div class="line"></div><div class="line">    <span class="function"><span class="title">page</span>-&gt;</span>releaseUntil(stop); <span class="comment">// 释放 page 里的所有对象，知道遇到 stop 才停止</span></div><div class="line"></div><div class="line">    <span class="comment">// memory: delete empty children</span></div><div class="line">    <span class="function"><span class="title">if</span> (allowDebug &amp;&amp; DebugPoolAllocation  &amp;&amp;  <span class="built_in">page</span>-&gt;</span>empty()) &#123;</div><div class="line">        <span class="comment">// special case: delete everything during page-per-pool debugging</span></div><div class="line">        A<span class="function"><span class="title">utoreleasePoolPage</span> *parent = <span class="built_in">page</span>-&gt;</span>parent;</div><div class="line">        <span class="function"><span class="title">page</span>-&gt;</span>kill();</div><div class="line">        setHotPage(parent);</div><div class="line">    &#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (allowDebug &amp;&amp; DebugMissingPools  &amp;&amp;  <span class="built_in">page</span>-&gt;</span><span class="function"><span class="title">empty</span>()  &amp;&amp;  !<span class="built_in">page</span>-&gt;</span>parent) &#123;</div><div class="line">        <span class="comment">// special case: delete everything for pop(top)</span></div><div class="line">        <span class="comment">// when debugging missing autorelease pools</span></div><div class="line">        <span class="function"><span class="title">page</span>-&gt;</span>kill();</div><div class="line">        setHotPage(<span class="literal">nil</span>);</div><div class="line">    &#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (<span class="built_in">page</span>-&gt;</span>child) &#123;</div><div class="line">        <span class="comment">// hysteresis: keep one empty child if page is more than half full</span></div><div class="line">        <span class="function"><span class="title">if</span> (<span class="built_in">page</span>-&gt;</span>lessThanHalfFull()) &#123;</div><div class="line">            <span class="function"><span class="title">page</span>-&gt;</span><span class="function"><span class="title">child</span>-&gt;</span>kill();</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="title">else</span> <span class="keyword">if</span> (<span class="built_in">page</span>-&gt;</span><span class="function"><span class="title">child</span>-&gt;</span>child) &#123;</div><div class="line">            <span class="function"><span class="title">page</span>-&gt;</span><span class="function"><span class="title">child</span>-&gt;</span><span class="function"><span class="title">child</span>-&gt;</span>kill();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>releaseUntil()</code> 方法：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">void releaseUntil(id *stop) </div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="title">while</span> (this-&gt;</span>next != stop) &#123;</div><div class="line">        AutoreleasePoolPage *<span class="built_in">page</span> = hotPage(); <span class="comment">// 取出当前 page</span></div><div class="line"></div><div class="line">        <span class="function"><span class="title">while</span> (<span class="built_in">page</span>-&gt;</span>empty()) &#123;</div><div class="line">            <span class="function"><span class="title">page</span> = <span class="built_in">page</span>-&gt;</span>parent;</div><div class="line">            setHotPage(<span class="built_in">page</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="title">page</span>-&gt;</span>unprotect();</div><div class="line">        <span class="function"><span class="title">id</span> obj = *--<span class="built_in">page</span>-&gt;</span>next; <span class="comment">// 取出最后面的一个 obj</span></div><div class="line">        <span class="function"><span class="title">memset</span>((void*)<span class="built_in">page</span>-&gt;</span><span class="function"><span class="title">next</span>, SCRIBBLE, sizeof(*<span class="built_in">page</span>-&gt;</span>next));</div><div class="line">        <span class="function"><span class="title">page</span>-&gt;</span>protect();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123;</div><div class="line">            objc_release(obj); <span class="comment">// 调用obj的release方法</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    setHotPage(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>pop()</code> 方法最终是通过调用 <code>releaseUntil()</code> 方法，将 page 里的对象依次调用 <code>objc_release(obj)</code> 方法释放掉了。</p>
<h2 id="autorelease-释放时机"><a href="#autorelease-释放时机" class="headerlink" title="autorelease 释放时机"></a>autorelease 释放时机</h2><p>创建一个 iOS 项目，选择 MRC 环境，修改 main.m 文件（当前XCode版本11.6）。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>定义 Person 类，添加打印：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    Person *person = [[[Person alloc] init] autorelease];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidAppear:(<span class="built_in">BOOL</span>)animated</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[ViewController viewDidLoad]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewWillAppear:</span>]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewDidAppear:</span>]</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，person 对象是在 <code>viewWillAppear</code> 方法执行完成后被释放的。</p>
<h3 id="Runloop和Autorelease"><a href="#Runloop和Autorelease" class="headerlink" title="Runloop和Autorelease"></a>Runloop和Autorelease</h3><p>iOS 在主线程的 Runloop 中注册了两个 Observer：<br>第一个 Observer 监听了 <code>kCFRunLoopEntry</code> 事件，会调用 <code>objc_autoreleasePoolPush()</code>。<br>第二个 Observer 监听了 <code>kCFRunLoopBeforeWaiting</code> 事件，会调用 <code>objc_autoreleasePoolPop()</code>、<code>objc_autoreleasePoolPush()</code>，监听了 <code>kCFRunLoopBeforeExit</code> 事件，会调用 <code>objc_autoreleasePoolPop()</code>。</p>
<p>打印当前的 RunLoop，查看 Observers：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    Person *person = [[[Person alloc] init] autorelease];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSRunLoop</span> currentRunLoop]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果里有很多内容，这里是摘出来的跟 Autorelease 相关的两个 Observe：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">observers = (</div><div class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000009fc1e0 [0x7fff8062d750]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff4931eaa4), context = &lt;CFArray 0x60000368ce70 [0x7fff8062d750]&gt;&#123;type = mutable-small, count = 1, values = (<span class="subst">\n</span><span class="subst">\t</span>0 : &lt;0x7fdaef00a048&gt;<span class="subst">\n</span>)&#125;&#125;"</span>,</div><div class="line"></div><div class="line">    <span class="string">"&lt;CFRunLoopObserver 0x6000009fc280 [0x7fff8062d750]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x7fff4931eaa4), context = &lt;CFArray 0x60000368ce70 [0x7fff8062d750]&gt;&#123;type = mutable-small, count = 1, values = (<span class="subst">\n</span><span class="subst">\t</span>0 : &lt;0x7fdaef00a048&gt;<span class="subst">\n</span>)&#125;&#125;"</span></div><div class="line">),</div></pre></td></tr></table></figure></p>
<p><code>_wrapRunLoopWithAutoreleasePoolHandler</code> 是回调方法，在收到消息时用来处理 Autorelease 相关操作。</p>
<p>第一个 observe 的 <code>activities</code> 是 <code>0x1</code>，第二个 observe 的 <code>activities</code> 是 <code>0xa0</code>。</p>
<p><code>activities</code> 对应的枚举：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</div><div class="line">    kCFRunLoopEntry = (<span class="number">1</span>UL &lt;&lt; <span class="number">0</span>),          <span class="comment">// 1（十进制）</span></div><div class="line">    kCFRunLoopBeforeTimers = (<span class="number">1</span>UL &lt;&lt; <span class="number">1</span>),   <span class="comment">// 2</span></div><div class="line">    kCFRunLoopBeforeSources = (<span class="number">1</span>UL &lt;&lt; <span class="number">2</span>),  <span class="comment">// 4</span></div><div class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1</span>UL &lt;&lt; <span class="number">5</span>),  <span class="comment">// 32</span></div><div class="line">    kCFRunLoopAfterWaiting = (<span class="number">1</span>UL &lt;&lt; <span class="number">6</span>),   <span class="comment">// 64</span></div><div class="line">    kCFRunLoopExit = (<span class="number">1</span>UL &lt;&lt; <span class="number">7</span>),           <span class="comment">// 128</span></div><div class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>因为：<br><code>0x1</code>（十六进制）-&gt; 1（十进制）<br><code>0xa0</code>（十六进制）-&gt; 160（十进制）<br>所以：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x1</span>：kCFRunLoopEntry</div><div class="line"><span class="number">0xa0</span>：kCFRunLoopAfterWaiting | kCFRunLoopExit</div></pre></td></tr></table></figure></p>
<p>所以第一个 observe 监听的状态就是 <code>kCFRunLoopEntry</code>，第二个 observe 监听的状态就是 <code>kCFRunLoopAfterWaiting</code> 和 <code>kCFRunLoopExit</code>。 </p>
<p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理20.png" alt="内存管理20"></p>
<ul>
<li>第一次循环：<br>01 状态是 <code>kCFRunLoopEntry</code>，RunLoop 会调用 <code>objc_autoreleasePoolPush()</code> 方法；<br>07 状态是 <code>kCFRunLoopAfterWaiting</code>，RunLoop 会先调用 <code>objc_autoreleasePoolPop()</code> 方法，然后调用 <code>objc_autoreleasePoolPush()</code> 方法； </li>
<li>非第一次循环：<br>10-1 回到 02 继续循环至 07；<br>07 状态是 <code>kCFRunLoopAfterWaiting</code>，RunLoop 会先调用 <code>objc_autoreleasePoolPop()</code> 方法，然后调用 <code>objc_autoreleasePoolPush()</code> 方法；<br>10-1 回到 02 继续循环至 07；  </li>
<li>结束循环：<br>10-2 退出 RunLoop；<br>11 状态是 <code>kCFRunLoopExit</code>，RunLoop 会调用 <code>objc_autoreleasePoolPop()</code> 方法。</li>
</ul>
<p>因为 02 会先调用 <code>objc_autoreleasePoolPop()</code> 方法，然后调用 <code>objc_autoreleasePoolPush()</code> 方法，所以 <code>push()</code> 和 <code>pop()</code> 实现了一一对应的关系。</p>
<p>在看打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[ViewController viewDidLoad]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewWillAppear:</span>]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewDidAppear:</span>]</span></div></pre></td></tr></table></figure></p>
<p>在 <code>viewWillAppear</code> 执行完成后，RunLoop 到了 02 的位置。此时 RunLoop 监听到了 <code>kCFRunLoopAfterWaiting</code> 状态，会先调用 <code>objc_autoreleasePoolPop()</code> 方法，然后调用 <code>objc_autoreleasePoolPush()</code> 方法。在调用 <code>objc_autoreleasePoolPop()</code> 方法时，Autorelease 中的 person 对象就被释放了。</p>
<p>另外，打印结果也说明了 <code>viewDidLoad</code> 和 <code>viewWillAppear</code> 方法是在同一个循环中执行的。</p>
<h3 id="ARC环境下的release"><a href="#ARC环境下的release" class="headerlink" title="ARC环境下的release"></a>ARC环境下的release</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewWillAppear:(<span class="built_in">BOOL</span>)animated</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewWillAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidAppear:(<span class="built_in">BOOL</span>)animated</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> viewDidAppear:animated];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[ViewController viewDidLoad]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewWillAppear:</span>]</span></div><div class="line"><span class="ruby">-[ViewController <span class="symbol">viewDidAppear:</span>]</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，person 对象在 <code>viewDidLoad</code> 方法执行完就释放了。所以在 ARC 环境下，在方法最后结束前，对方法内部的局部变量调用了 release 方法：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    <span class="comment">[super viewDidLoad]</span>;</div><div class="line">    <span class="keyword">Person</span> *<span class="keyword">person</span> = <span class="comment">[<span class="comment">[Person alloc]</span> init]</span>;</div><div class="line">    NSLog(@<span class="string">"%s"</span>, __func__);</div><div class="line">    </div><div class="line">    // <span class="comment">[person release]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>使用 CADisplayLink、NSTimer 有什么注意点？<br>CADisplayLink 和 NSTimer 依赖于 RunLoop，如果 RunLoop 的任务过于繁重，可能会导致 CADisplayLink 和 NSTimer 不准时。<br>CADisplayLink 和 NSTimer 有可能会造成循环引用问题，CADisplayLink 可以通过使用代理对象（NSProxy）解决，NSTimer 除了可以通过使用代理对象（NSProxy）解决外，还可以使用带有 block 回调的初始化方法。  </p>
</li>
<li><p>介绍下内存的几大区域<br>代码段：编译之后的代码<br>数据段：字符串常量、已初始化数据和未初始化数据<br>栈：函数调用开销，比如局部变量。（分配的内存空间地址越来越小）<br>堆：通过 alloc、malloc、calloc 等动态分配的空间，分配的内存空间地址越来越大</p>
</li>
<li><p>讲一下你对 iOS 内存管理的理解<br>在 iOS 中，使用引用计数来管理 OC 对象的内存。<br>一个新创建的 OC 对象引用计数默认是1，当引用计数减为0，OC 对象就会销毁，释放其占用的内存空间。<br>调用 retain 会让 OC 对象的引用计数+1，调用 release 会让 OC 对象的引用计数-1。<br>内存管理的经验总结：<br>当调用 alloc、new、copy、mutableCopy 方法返回了一个对象，在不需要这个对象时，要调用 release 或者 autorelease 来释放它。<br>想拥有某个对象，就让它的引用计数+1；不想再拥有某个对象，就让它的引用计数-1。  </p>
</li>
<li><p>ARC 都帮我们做了什么？(LLVM + Runtime)<br>ARC 是 LLVM 编译器和 Runtime 协作协作实现的。ARC 利用 LLVM 编译器自动生成 release、retain 和 autorelease 等内存管理相关的代码，利用 Runtime 实现在运行时对弱引用的管理（添加和清除）。</p>
</li>
<li><p>weak 指针的实现原理<br>将弱引用存储在一个弱引用表（哈希表）里面，在对象要销毁时，就以对象的地址值 &amp; mask 得到一个索引取出对应的弱引用表，并把弱引用表里存储的弱引用都清除掉。</p>
</li>
<li><p>autorelease 对象在什么时机会被调用 release？<br>autorelease 对象在什么时候调用 release 是由 RunLoop 控制的，在 RunLoop 监听到 <code>kCFRunLoopAfterWaiting</code> 或 <code>kCFRunLoopExit</code> 状态时会调用 <code>objc_autoreleasePoolPop()</code> 方法，此时 autorelease 对象会调用 release。即在 RunLoop 进入休眠或者退出时调用 release。</p>
</li>
<li><p>方法里有局部对象， 出了方法后会立即释放吗?<br>会。在方法结束前，runtime 会自动为方法内部的局部对象调用 release 方法进行释放。</p>
</li>
</ul>
<p>相关阅读：<br><a href="https://www.infoq.cn/article/deep-understanding-of-tagged-pointer/" target="_blank" rel="external">深入理解 Tagged Pointer</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OC底层原理/" rel="tag"># OC底层原理</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/14/OC底层/原理/多线程/" rel="next" title="多线程">
                <i class="fa fa-chevron-left"></i> 多线程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/myAvatar.gif"
              alt="Kevin" />
          
            <p class="site-author-name" itemprop="name">Kevin</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/KevinYangGit" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_YangQI" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>Twitter</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CADisplayLink、NSTimer-定时器"><span class="nav-number">1.</span> <span class="nav-text">CADisplayLink、NSTimer 定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#循环引用问题"><span class="nav-number">1.1.</span> <span class="nav-text">循环引用问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CADisplayLink"><span class="nav-number">1.1.1.</span> <span class="nav-text">CADisplayLink</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSTimer"><span class="nav-number">1.1.2.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题分析"><span class="nav-number">1.1.3.</span> <span class="nav-text">问题分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决方案"><span class="nav-number">1.2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案一：使用-block"><span class="nav-number">1.2.1.</span> <span class="nav-text">方案一：使用 block</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案二：使用中间对象"><span class="nav-number">1.2.2.</span> <span class="nav-text">方案二：使用中间对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSTimer-1"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CADisplayLink-1"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">CADisplayLink</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用代理对象（NSProxy）"><span class="nav-number">1.3.</span> <span class="nav-text">使用代理对象（NSProxy）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSTimer-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CADisplayLink-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">CADisplayLink</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSProxy"><span class="nav-number">1.4.</span> <span class="nav-text">NSProxy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GCD-定时器"><span class="nav-number">2.</span> <span class="nav-text">GCD 定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#block-回调："><span class="nav-number">2.1.</span> <span class="nav-text">block 回调：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数回调："><span class="nav-number">2.2.</span> <span class="nav-text">函数回调：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义队列"><span class="nav-number">2.3.</span> <span class="nav-text">自定义队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#封装-GCD"><span class="nav-number">2.4.</span> <span class="nav-text">封装 GCD</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS程序的内存布局"><span class="nav-number">3.</span> <span class="nav-text">iOS程序的内存布局</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tagged-Pointer"><span class="nav-number">4.</span> <span class="nav-text">Tagged Pointer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NSNumber"><span class="nav-number">4.1.</span> <span class="nav-text">NSNumber</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSString"><span class="nav-number">4.2.</span> <span class="nav-text">NSString</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例一："><span class="nav-number">4.2.1.</span> <span class="nav-text">例一：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案一："><span class="nav-number">4.2.1.1.</span> <span class="nav-text">解决方案一：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案二："><span class="nav-number">4.2.1.2.</span> <span class="nav-text">解决方案二：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例二："><span class="nav-number">4.2.2.</span> <span class="nav-text">例二：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#判断是否是-Tagged-Pointer"><span class="nav-number">4.3.</span> <span class="nav-text">判断是否是 Tagged Pointer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MRC"><span class="nav-number">5.</span> <span class="nav-text">MRC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#release"><span class="nav-number">5.1.</span> <span class="nav-text">release</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#autorelease"><span class="nav-number">5.2.</span> <span class="nav-text">autorelease</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#retain"><span class="nav-number">5.3.</span> <span class="nav-text">retain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#set-方法"><span class="nav-number">5.4.</span> <span class="nav-text">set 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#property-属性"><span class="nav-number">5.5.</span> <span class="nav-text">property 属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本数据类型"><span class="nav-number">5.6.</span> <span class="nav-text">基本数据类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象类型"><span class="nav-number">5.7.</span> <span class="nav-text">对象类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用代码解析"><span class="nav-number">5.8.</span> <span class="nav-text">常用代码解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工厂方法"><span class="nav-number">5.9.</span> <span class="nav-text">工厂方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#copy和mutableCopy"><span class="nav-number">6.</span> <span class="nav-text">copy和mutableCopy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#拷贝"><span class="nav-number">6.1.</span> <span class="nav-text">拷贝</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSString-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">NSString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableString"><span class="nav-number">6.1.2.</span> <span class="nav-text">NSMutableString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理"><span class="nav-number">6.1.3.</span> <span class="nav-text">内存管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#深拷贝和浅拷贝"><span class="nav-number">6.2.</span> <span class="nav-text">深拷贝和浅拷贝</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSString-2"><span class="nav-number">6.2.1.</span> <span class="nav-text">NSString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableString-1"><span class="nav-number">6.2.2.</span> <span class="nav-text">NSMutableString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSArray"><span class="nav-number">6.2.3.</span> <span class="nav-text">NSArray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableArray"><span class="nav-number">6.2.4.</span> <span class="nav-text">NSMutableArray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSDictionary"><span class="nav-number">6.2.5.</span> <span class="nav-text">NSDictionary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableDictionary"><span class="nav-number">6.2.6.</span> <span class="nav-text">NSMutableDictionary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">6.2.7.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#copy策略的property"><span class="nav-number">6.3.</span> <span class="nav-text">copy策略的property</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#copyWithZone"><span class="nav-number">6.4.</span> <span class="nav-text">copyWithZone:</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#引用计数的存储"><span class="nav-number">7.</span> <span class="nav-text">引用计数的存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#retainCount"><span class="nav-number">7.1.</span> <span class="nav-text">retainCount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#release-1"><span class="nav-number">7.2.</span> <span class="nav-text">release</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#retain-1"><span class="nav-number">7.3.</span> <span class="nav-text">retain()</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#weak指针的原理"><span class="nav-number">8.</span> <span class="nav-text">weak指针的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#局部变量的内存管理"><span class="nav-number">8.1.</span> <span class="nav-text">局部变量的内存管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#strong"><span class="nav-number">8.1.1.</span> <span class="nav-text">__strong</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#weak"><span class="nav-number">8.1.2.</span> <span class="nav-text">__weak</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafe-unretained"><span class="nav-number">8.1.3.</span> <span class="nav-text">__unsafe_unretained</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dealloc"><span class="nav-number">8.2.</span> <span class="nav-text">dealloc</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#自动释放池"><span class="nav-number">9.</span> <span class="nav-text">自动释放池</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AtAutoreleasePool"><span class="nav-number">9.1.</span> <span class="nav-text">__AtAutoreleasePool</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AutoreleasePoolPage"><span class="nav-number">9.2.</span> <span class="nav-text">AutoreleasePoolPage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义"><span class="nav-number">9.2.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结构"><span class="nav-number">9.2.2.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原理"><span class="nav-number">9.2.3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">9.2.4.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码分析"><span class="nav-number">9.2.5.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#objc-autoreleasePoolPush-void"><span class="nav-number">9.2.5.1.</span> <span class="nav-text">objc_autoreleasePoolPush(void)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#id-autorelease"><span class="nav-number">9.2.5.2.</span> <span class="nav-text">- (id)autorelease</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#objc-autoreleasePoolPop-void-ctxt"><span class="nav-number">9.2.5.3.</span> <span class="nav-text">objc_autoreleasePoolPop(void *ctxt)</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#autorelease-释放时机"><span class="nav-number">9.3.</span> <span class="nav-text">autorelease 释放时机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Runloop和Autorelease"><span class="nav-number">9.3.1.</span> <span class="nav-text">Runloop和Autorelease</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARC环境下的release"><span class="nav-number">9.3.2.</span> <span class="nav-text">ARC环境下的release</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://rawgit.com/qhh0205/78e9e0b1f3114db6737f3ed8cdd51d3a/raw/3894c5be5aa2378336b1f5ee0f296fa0b22d06e9/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '82b6ced795961ee1fcca',
          clientSecret: '4a2f24a39c6fcd85813d80031c6e0262a65404f5',
          repo: 'KevinYangGit.github.io',
          owner: '',
          admin: [''],
          id: md5(location.pathname),
          distractionFreeMode: ''
        })
        gitalk.render('gitalk-container')
    </script>

  





  

  

  

  

  

  

</body>
</html>
