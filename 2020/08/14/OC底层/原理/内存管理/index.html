<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="OC底层原理," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta name="keywords" content="OC底层原理">
<meta property="og:type" content="article">
<meta property="og:title" content="内存管理">
<meta property="og:url" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/index.html">
<meta property="og:site_name" content="Kevin&#39;s  blog">
<meta property="og:description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理01.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理02.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理03.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理04.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理05.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理06.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理07.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理08.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理09.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理10.png">
<meta property="og:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理11.png">
<meta property="og:updated_time" content="2020-08-24T06:48:32.082Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="内存管理">
<meta name="twitter:description" content="思考：  使用 CADisplayLink、NSTimer 有什么注意点？ 介绍下内存的几大区域 讲一下你对 iOS 内存管理的理解 ARC 都帮我们做了什么？(LLVM + Runtime) weak 指针的实现原理 autorelease 对象在什么时机会被调用 release 方法里有局部对象， 出了方法后会立即释放吗?">
<meta name="twitter:image" content="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/内存管理01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/"/>





  <title>内存管理 | Kevin's  blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin's  blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/14/OC底层/原理/内存管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myAvatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's  blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">内存管理</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-14T17:16:33+08:00">
                2020-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考：</p>
<ul>
<li>使用 CADisplayLink、NSTimer 有什么注意点？</li>
<li>介绍下内存的几大区域</li>
<li>讲一下你对 iOS 内存管理的理解</li>
<li>ARC 都帮我们做了什么？(LLVM + Runtime)</li>
<li>weak 指针的实现原理</li>
<li>autorelease 对象在什么时机会被调用 release</li>
<li>方法里有局部对象， 出了方法后会立即释放吗?<a id="more"></a>
</li>
</ul>
<h1 id="CADisplayLink、NSTimer-定时器"><a href="#CADisplayLink、NSTimer-定时器" class="headerlink" title="CADisplayLink、NSTimer 定时器"></a>CADisplayLink、NSTimer 定时器</h1><p>CADisplayLink、NSTimer 会对 target 产生强引用，如果 target 又对它们产生强引用，那么就会引发循环引用。</p>
<h2 id="循环引用问题"><a href="#循环引用问题" class="headerlink" title="循环引用问题"></a>循环引用问题</h2><h3 id="CADisplayLink"><a href="#CADisplayLink" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h3><p>CADisplayLink 保证调用 <code>-(void)timerTest</code> 方法的频率和屏幕的刷新帧频率一致，60FPS。实际的调用频率可能不太一样，根据任务的耗时情况会有减少。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">......</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，进入 TimerViewController 控制器后返回，会发现 TimerViewController 没有释放，CADisplayLink 定时器还在继续运行。</p>
<h3 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">......</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，进入 TimerViewController 控制器后返回，会发现 TimerViewController 没有释放，NSTimer 定时器还在继续运行。</p>
<h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理01.png" alt="内存管理01"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="方案一：使用-block"><a href="#方案一：使用-block" class="headerlink" title="方案一：使用 block"></a>方案一：使用 block</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> repeats:<span class="literal">YES</span> block:^(<span class="built_in">NSTimer</span> * _Nonnull timer) &#123;</div><div class="line">        [weakSelf timerTest];</div><div class="line">    &#125;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<p>在使用 NSTimer 的时候，使用 block 的方式传入 weakSelf 可以有效解决循环引用的问题。并且以 scheduled 开头的方法会自动将 timer 添加到当前的 runloop 中并使用 default mode。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (<span class="selector-tag">NSTimer</span> *)<span class="selector-tag">scheduledTimerWithTimeInterval</span><span class="selector-pseudo">:(NSTimeInterval)interval</span> <span class="selector-tag">repeats</span><span class="selector-pseudo">:(BOOL)repeats</span> <span class="selector-tag">block</span><span class="selector-pseudo">:(void</span> (^)(<span class="selector-tag">NSTimer</span> *<span class="selector-tag">timer</span>))<span class="selector-tag">block</span> <span class="selector-tag">API_AVAILABLE</span>(<span class="selector-tag">macosx</span>(10<span class="selector-class">.12</span>), <span class="selector-tag">ios</span>(10<span class="selector-class">.0</span>), <span class="selector-tag">watchos</span>(3<span class="selector-class">.0</span>), <span class="selector-tag">tvos</span>(10<span class="selector-class">.0</span>));</div></pre></td></tr></table></figure></p>
<p>target 传入 weakSelf 并不能解决循环引用个问题，因为 NSTimer 内部对传入的 target 也是强引用的，而且 weakSelf 只是用来解决 block 循环引用问题的方案。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+ (<span class="built_in">NSTimer</span> *)scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti target:(<span class="keyword">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo repeats:(<span class="built_in">BOOL</span>)yesOrNo;</div></pre></td></tr></table></figure></p>
<p>CADisplayLink 没有 block 相关的 API。</p>
<h3 id="方案二：使用中间对象"><a href="#方案二：使用中间对象" class="headerlink" title="方案二：使用中间对象"></a>方案二：使用中间对象</h3><p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理02.png" alt="内存管理02"></p>
<p>定义中间对象：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQProxy</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target</div><div class="line">&#123;</div><div class="line">    YQProxy *proxy = [[YQProxy alloc] init];</div><div class="line">    proxy.target = target;</div><div class="line">    <span class="keyword">return</span> proxy;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.target;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h4 id="NSTimer-1"><a href="#NSTimer-1" class="headerlink" title="NSTimer"></a>NSTimer</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="comment">//@property (nonatomic, strong) CADisplayLink *link;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span> target:[YQProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<h4 id="CADisplayLink-1"><a href="#CADisplayLink-1" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:[YQProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<p>传给定时器的 target 是 YQProxy 对象，在 YQProxy 对象尝试调用 <code>-(void)timerTest</code> 方法时，发现没有实现后会调用 <code>- (id)forwardingTargetForSelector:(SEL)aSelector</code> 方法走消息转发的逻辑，在该方法内部返回已经实现了 <code>-(void)timerTest</code> 方法的对象，就可以正常实现 timer 定时器调用 <code>-(void)timerTest</code> 方法的逻辑了。 </p>
<p>因为 YQProxy 对象没有实现 <code>-(void)timerTest</code> 方法，所以需要添加消息转发逻辑。如果 YQProxy 中没有添加消息转发的逻辑会出现如下报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理03.png" alt="内存管理03"> </p>
<p>YQProxy 会在其类对象以及父类的类对象里查找 <code>-(void)timerTest</code> 方法，查找了一圈后发现找不到，就会抛出错误。</p>
<h2 id="使用代理对象（NSProxy）"><a href="#使用代理对象（NSProxy）" class="headerlink" title="使用代理对象（NSProxy）"></a>使用代理对象（NSProxy）</h2><p>定义 YQTimerProxy 继承自 NSProxy：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQTimerProxy</span> : <span class="title">NSProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> target;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQTimerProxy</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target</div><div class="line">&#123;</div><div class="line">    YQTimerProxy *proxy = [YQTimerProxy alloc];</div><div class="line">    proxy.target = target;</div><div class="line">    <span class="keyword">return</span> proxy;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.target methodSignatureForSelector:sel];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation</div><div class="line">&#123;</div><div class="line">    [invocation invokeWithTarget:<span class="keyword">self</span>.target];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>NSProxy 对象没有 <code>-(instancetype)init</code> 方法，直接 alloc 就可以了。</p>
<h3 id="NSTimer-2"><a href="#NSTimer-2" class="headerlink" title="NSTimer"></a>NSTimer</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></div><div class="line">                                                  target:[YQTimerProxy proxyWithTarget:<span class="keyword">self</span>]</div><div class="line">                                                selector:<span class="keyword">@selector</span>(timerTest)</div><div class="line">                                                userInfo:<span class="literal">nil</span></div><div class="line">                                                 repeats:<span class="literal">YES</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.timer invalidate];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController timerTest]</span></div><div class="line"><span class="ruby">-[TimerViewController dealloc]</span></div></pre></td></tr></table></figure></p>
<h3 id="CADisplayLink-2"><a href="#CADisplayLink-2" class="headerlink" title="CADisplayLink"></a>CADisplayLink</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">CADisplayLink</span> *link;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.link = [<span class="built_in">CADisplayLink</span> displayLinkWithTarget:[YQTimerProxy proxyWithTarget:<span class="keyword">self</span>] selector:<span class="keyword">@selector</span>(timerTest)];</div><div class="line">    [<span class="keyword">self</span>.link addToRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    [<span class="keyword">self</span>.link invalidate];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>传给定时器的 target 是 YQTimerProxy 对象，YQTimerProxy 对象不会尝试调用 <code>-(void)timerTest</code> 方法，而是直接走消息转发逻辑，在对应的消息转发的方法里返回已经实现了 <code>-(void)timerTest</code> 方法的对象，就可以正常实现 timer 定时器调用 <code>-(void)timerTest</code> 方法的逻辑了。</p>
<p>因为 YQTimerProxy 对象不会尝试调用 <code>-(void)timerTest</code> 方法，而是直接调用 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法，所以需要添加消息转发逻辑。如果 YQTimerProxy 中没有添加消息转发的逻辑会出现如下报错：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理04.png" alt="内存管理04"> </p>
<p>可以看到 YQTimerProxy 没有去查找 <code>-(void)timerTest</code> 方法，而是直接查找的 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法。这一点可以通过 <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUStep</a> 查看 NSProxy 的源码找到原因。NSProxy 内部的方法的实现都是直接调用的 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法，因此 NSProxy 作为代理对象效率更高。</p>
<h2 id="NSProxy"><a href="#NSProxy" class="headerlink" title="NSProxy"></a>NSProxy</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    YQProxy *proxy1 = [YQProxy proxyWithTarget:<span class="keyword">self</span>];</div><div class="line">    YQTimerProxy *proxy2 = [YQTimerProxy proxyWithTarget:<span class="keyword">self</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%d %d"</span>, [proxy1 isKindOfClass:[ViewController <span class="keyword">class</span>]], [proxy2 isKindOfClass:[ViewController <span class="keyword">class</span>]]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">0 </span><span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，YQProxy 的实例对象和 YQTimerProxy 的实列对象在判断是否是 ViewController 的对象类型的时候结果不同。这是因为 YQTimerProxy 继承自 NSProxy，NSProxy 的 <code>-(BOOL) isKindOfClass:(Class)aClass</code> 方法的实现与普通的 OC 对象同。通过 <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="external">GNUStep</a> 查看 NSProxy 的源码：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">BOOL)isKindOfClass:(Class)aClass</span></div><div class="line"><span class="keyword">&#123;</span></div><div class="line"><span class="keyword"> </span>   NSMethodSignature	*sig<span class="comment">;</span></div><div class="line">    NSInvocation		*inv<span class="comment">;</span></div><div class="line">    <span class="keyword">BOOL	</span>		ret<span class="comment">;</span></div><div class="line"></div><div class="line">    sig = [self methodSignatureForSelector: _cmd]<span class="comment">;</span></div><div class="line">    inv = [NSInvocation invocationWithMethodSignature: sig]<span class="comment">;</span></div><div class="line">    [inv setSelector: _cmd]<span class="comment">;</span></div><div class="line">    [inv setArgument: &amp;aClass atIndex: <span class="number">2</span>]<span class="comment">;</span></div><div class="line">    [self forwardInvocation: inv]<span class="comment">;</span></div><div class="line">    [inv getReturnValue: &amp;ret]<span class="comment">;</span></div><div class="line">    return ret<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，NSProxy 的 <code>-(BOOL)isKindOfClass:(Class)aClass</code> 方法内部直接调用了 <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code> 方法。</p>
<p>普通 OC 对象的 <code>-(BOOL)isKindOfClass:(Class)aClass</code> 方法实现 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> ：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</div><div class="line">    <span class="keyword">for</span> (Class tcls = [<span class="keyword">self</span> <span class="keyword">class</span>]; tcls; tcls = tcls-&gt;superclass) &#123;</div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="GCD-定时器"><a href="#GCD-定时器" class="headerlink" title="GCD 定时器"></a>GCD 定时器</h1><p>CADisplayLink 和 NSTimer 依赖于 RunLoop，如果 RunLoop 的任务过于繁重，可能会导致 CADisplayLink 和 NSTimer 不准时。GCD 的定时器会更加准时。</p>
<h2 id="block-回调："><a href="#block-回调：" class="headerlink" title="block 回调："></a>block 回调：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"GCD timer"</span>);</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:38.889349+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">-</span><span class="selector-attr">[ViewController viewDidLoad]</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:40.889609+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:41.889685+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">18<span class="selector-pseudo">:16</span><span class="selector-pseudo">:42.889624+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[15880:352867]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="函数回调："><a href="#函数回调：" class="headerlink" title="函数回调："></a>函数回调：</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler_f(timer, timerFire);</div><div class="line">    </div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> timerFire(<span class="keyword">void</span> *param)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"GCD timer - %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">01.629410</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] -[ViewController viewDidLoad]</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">03.629774</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">04.629784</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line"><span class="number">20</span>:<span class="number">37</span>:<span class="number">05.629800</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1363:25276</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x6<span class="number">00001b70d40</span>&gt;&#123;number = <span class="number">1</span>, name = main&#125;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="自定义队列"><a href="#自定义队列" class="headerlink" title="自定义队列"></a>自定义队列</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) dispatch_source_t timer;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="comment">// 自定义队列</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"GCDTimer"</span>, <span class="literal">NULL</span>);</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间（定时器，延迟执行时间，执行时间间隔，误差）</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>), <span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler_f(timer, timerFire);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">self</span>.timer = timer;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> timerFire(<span class="keyword">void</span> *param)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"GCD timer - %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">20</span>:<span class="number">39</span>:<span class="number">58.857389</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28690</span>] -[ViewController viewDidLoad]</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">00.857845</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28836</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x<span class="number">600002119280</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">01.857692</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28835</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x60<span class="number">00021272c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;</div><div class="line"><span class="number">20</span>:<span class="number">40</span>:<span class="number">02.857792</span>+<span class="number">0800</span> 内存管理-定时器[<span class="number">1460:28836</span>] GCD timer - &lt;NSThread: <span class="number">0</span>x<span class="number">600002119280</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;</div><div class="line">......</div></pre></td></tr></table></figure></p>
<h2 id="封装-GCD"><a href="#封装-GCD" class="headerlink" title="封装 GCD"></a>封装 GCD</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">YQGCDTimer</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">block 回调</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="built_in">NSString</span> *)execTask:(<span class="keyword">void</span>(^)(<span class="keyword">void</span>))task</div><div class="line">                 start:(<span class="built_in">NSTimeInterval</span>)start</div><div class="line">              interval:(<span class="built_in">NSTimeInterval</span>)interval</div><div class="line">               repeats:(<span class="built_in">BOOL</span>)repeats</div><div class="line">                 async:(<span class="built_in">BOOL</span>)async;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">函数回调</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="built_in">NSString</span> *)execTaskWithTarget:(<span class="keyword">id</span>)target</div><div class="line">                        selector:(SEL)selector</div><div class="line">                           start:(<span class="built_in">NSTimeInterval</span>)start</div><div class="line">                        interval:(<span class="built_in">NSTimeInterval</span>)interval</div><div class="line">                         repeats:(<span class="built_in">BOOL</span>)repeats</div><div class="line">                           async:(<span class="built_in">BOOL</span>)async;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">取消</span></div><div class="line"><span class="comment">*/</span></div><div class="line">+ (<span class="keyword">void</span>)cancelTask:(<span class="built_in">NSString</span> *)name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">NSInteger</span> index_;</div><div class="line"><span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *timers_;</div><div class="line">dispatch_semaphore_t semaphore_;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">YQGCDTimer</span></span></div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)initialize</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        timers_ = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">        semaphore_ = dispatch_semaphore_create(<span class="number">1</span>);</div><div class="line">        index_ = <span class="number">0</span>;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSString</span> *)execTask:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))task start:(<span class="built_in">NSTimeInterval</span>)start interval:(<span class="built_in">NSTimeInterval</span>)interval repeats:(<span class="built_in">BOOL</span>)repeats async:(<span class="built_in">BOOL</span>)async</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!task || start &lt; <span class="number">0</span> || (interval &lt;= <span class="number">0</span> &amp;&amp; repeats)) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    <span class="comment">// 队列（全局串行队列或主队列）</span></div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = async ? dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>) : dispatch_get_main_queue();</div><div class="line">    <span class="comment">// 创建定时器</span></div><div class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</div><div class="line">    <span class="comment">// 设置时间</span></div><div class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, start * <span class="built_in">NSEC_PER_SEC</span>), interval * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</div><div class="line">    <span class="comment">// 回调</span></div><div class="line">    dispatch_source_set_event_handler(timer, ^&#123;</div><div class="line">        task();</div><div class="line">        <span class="comment">// 不需要重复任务</span></div><div class="line">        <span class="keyword">if</span> (!repeats) &#123;</div><div class="line">            dispatch_source_cancel(timer);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// 加锁</span></div><div class="line">    dispatch_semaphore_wait(semaphore_, DISPATCH_TIME_FOREVER);</div><div class="line">    <span class="comment">// 定时器唯一标识</span></div><div class="line">    <span class="built_in">NSString</span> *identify = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%ld"</span>, (<span class="keyword">long</span>)index_++];</div><div class="line">    <span class="comment">// 保存</span></div><div class="line">    timers_[identify] = timer;</div><div class="line">    <span class="comment">// 解锁</span></div><div class="line">    dispatch_semaphore_signal(semaphore_);</div><div class="line">    <span class="comment">// 启动定时器</span></div><div class="line">    dispatch_resume(timer);</div><div class="line">    <span class="keyword">return</span> identify;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">NSString</span> *)execTaskWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector start:(<span class="built_in">NSTimeInterval</span>)start interval:(<span class="built_in">NSTimeInterval</span>)interval repeats:(<span class="built_in">BOOL</span>)repeats async:(<span class="built_in">BOOL</span>)async</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> execTask:^&#123;</div><div class="line">        <span class="keyword">if</span> ([target respondsToSelector:selector]) &#123;</div><div class="line"><span class="meta">#pragma clang diagnostic push</span></div><div class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Warc-performSelector-leaks"</span></span></div><div class="line">            [target performSelector:selector];</div><div class="line"><span class="meta">#pragma clang diagnostic pop</span></div><div class="line">        &#125;</div><div class="line">    &#125; start:start interval:interval repeats:repeats async:async];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)cancelTask:(<span class="built_in">NSString</span> *)name</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (name.length == <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line">    <span class="comment">// 加锁</span></div><div class="line">    dispatch_semaphore_wait(semaphore_, DISPATCH_TIME_FOREVER);</div><div class="line">    dispatch_source_t timer = timers_[name];</div><div class="line">    <span class="keyword">if</span> (timer) &#123;</div><div class="line">        dispatch_source_cancel(timer);</div><div class="line">        [timers_ removeObjectForKey:name];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 解锁</span></div><div class="line">    dispatch_semaphore_signal(semaphore_);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>调用 block 回调方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *task;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">self</span>.task = [YQGCDTimer execTask:^&#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"GCD timer"</span>);</div><div class="line">    &#125; start:<span class="number">2</span> interval:<span class="number">1</span> repeats:<span class="literal">YES</span> async:<span class="literal">NO</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    [YQGCDTimer cancelTask:<span class="keyword">self</span>.task];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>调用函数回调方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *task;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">self</span>.task = [YQGCDTimer execTaskWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerTest) start:<span class="number">2</span> interval:<span class="number">1</span> repeats:<span class="literal">YES</span> async:<span class="literal">NO</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)timerTest</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    [YQGCDTimer cancelTask:<span class="keyword">self</span>.task];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:01.050592+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">-</span><span class="selector-attr">[TimerViewController viewDidLoad]</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:03.050800+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:04.050986+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div><div class="line">21<span class="selector-pseudo">:18</span><span class="selector-pseudo">:05.050943+0800</span> 内存管理<span class="selector-tag">-</span>定时器<span class="selector-attr">[2321:52592]</span> <span class="selector-tag">GCD</span> <span class="selector-tag">timer</span></div></pre></td></tr></table></figure></p>
<p>去掉警告：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="string">+</span> <span class="string">(NSString</span> <span class="string">*)execTaskWithTarget:(id)target</span> <span class="attr">selector:(SEL)selector</span> <span class="attr">start:(NSTimeInterval)start</span> <span class="attr">interval:(NSTimeInterval)interval</span> <span class="attr">repeats:(BOOL)repeats</span> <span class="attr">async:(BOOL)async</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">    <span class="string">return</span> <span class="string">[self</span> <span class="attr">execTask:^&#123;</span></div><div class="line">        <span class="string">if</span> <span class="string">([target</span> <span class="attr">respondsToSelector:selector])</span> <span class="string">&#123;</span></div><div class="line"><span class="comment">#pragma clang diagnostic push</span></div><div class="line"><span class="comment">#pragma clang diagnostic ignored "-Warc-performSelector-leaks"</span></div><div class="line">            <span class="string">[target</span> <span class="attr">performSelector:selector];</span></div><div class="line"><span class="comment">#pragma clang diagnostic pop</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">    <span class="string">&#125;</span> <span class="attr">start:start</span> <span class="attr">interval:interval</span> <span class="attr">repeats:repeats</span> <span class="attr">async:async];</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure></p>
<p><img src="/2020/08/14/OC底层/原理/内存管理/内存管理05.png" alt="内存管理05"> </p>
<h1 id="iOS程序的内存布局"><a href="#iOS程序的内存布局" class="headerlink" title="iOS程序的内存布局"></a>iOS程序的内存布局</h1><ul>
<li>代码段：编译之后的代码</li>
<li>数据段：<br>字符串常量<br>已初始化数据<br>未初始化数据</li>
<li>栈：函数调用开销，比如局部变量。（分配的内存空间地址越来越小）</li>
<li>堆：通过 alloc、malloc、calloc 等动态分配的空间，分配的内存空间地址越来越大<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理06.png" alt="内存管理06"> </li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 已初始化的全局变量</span></div><div class="line"><span class="keyword">int</span> a = <span class="number">10</span>;</div><div class="line"><span class="comment">// 未初始化的全局变量</span></div><div class="line"><span class="keyword">int</span> b;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">// 已初始化的静态变量</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> c = <span class="number">20</span>;</div><div class="line">        <span class="comment">// 未初始化的静态变量</span></div><div class="line">        <span class="keyword">static</span> <span class="keyword">int</span> d;</div><div class="line">        <span class="comment">// 栈</span></div><div class="line">        <span class="keyword">int</span> e;</div><div class="line">        <span class="keyword">int</span> f = <span class="number">20</span>;</div><div class="line">        <span class="comment">// 字符串常量</span></div><div class="line">        <span class="built_in">NSString</span> *str = <span class="string">@"123"</span>;</div><div class="line">        <span class="comment">// 堆</span></div><div class="line">        <span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"\n&amp;a=%p\n&amp;b=%p\n&amp;c=%p\n&amp;d=%p\n&amp;e=%p\n&amp;f=%p\nstr=%p\nobj1=%p\nobj2=%p\n"</span>,</div><div class="line">              &amp;a, &amp;b, &amp;c, &amp;d, &amp;e, &amp;f, str, obj1, obj2);</div><div class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&amp;<span class="attribute">a</span>=0x105bbee38</div><div class="line">&amp;<span class="attribute">b</span>=0x105bbef04</div><div class="line">&amp;<span class="attribute">c</span>=0x105bbee3c</div><div class="line">&amp;<span class="attribute">d</span>=0x105bbef00</div><div class="line">&amp;<span class="attribute">e</span>=0x7ffeea042c2c</div><div class="line">&amp;<span class="attribute">f</span>=0x7ffeea042c28</div><div class="line"><span class="attribute">str</span>=0x105bbe070</div><div class="line"><span class="attribute">obj1</span>=0x600002528110</div><div class="line"><span class="attribute">obj2</span>=0x600002528120</div></pre></td></tr></table></figure></p>
<p>打印结果解析（内地地址从小到大排序）：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 字符串常量</span></div><div class="line">str=<span class="number">0x105bbe070</span></div><div class="line"></div><div class="line"><span class="comment">// 已初始化的全局变量、静态变量</span></div><div class="line">&amp;a=<span class="number">0x105bbee38</span></div><div class="line">&amp;c=<span class="number">0x105bbee3c</span></div><div class="line"></div><div class="line"><span class="comment">// 未初始化的全局变量、静态变量</span></div><div class="line">&amp;d=<span class="number">0x105bbef00</span></div><div class="line">&amp;b=<span class="number">0x105bbef04</span></div><div class="line"></div><div class="line"><span class="comment">// 堆</span></div><div class="line">obj1=<span class="number">0x600002528110</span></div><div class="line">obj2=<span class="number">0x600002528120</span></div><div class="line"></div><div class="line"><span class="comment">// 栈</span></div><div class="line">&amp;f=<span class="number">0x7ffeea042c28</span></div><div class="line">&amp;e=<span class="number">0x7ffeea042c2c</span></div></pre></td></tr></table></figure></p>
<p>内存地址大小比较：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">str &lt; <span class="selector-tag">a</span> &lt; c &lt; d &lt; <span class="selector-tag">b</span> &lt; obj1 &lt; obj2 &lt; f &lt; e</div></pre></td></tr></table></figure></p>
<p>数据段：str &lt; a &lt; c &lt; d &lt; b，空间地址越来越大。<br>堆区：obj1 比 b 多了3位数，这3位数的空间都属于数据段。obj1 的内存地址首位数字为6，obj1 &lt; obj2，分配的内存空间越来越大（越来越逼近栈区）。<br>栈区：e 的内存地址首位数字为7，f &lt; e，分配的内存空间越来越小（越来越逼近堆区）。  </p>
<h1 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h1><ul>
<li>从64bit开始，iOS 引入了 Tagged Pointer 技术，用于优化 NSNumber、NSDate、NSString 等小对象的存储。</li>
<li>在没有使用 Tagged Pointer 之前，NSNumber 等对象需要动态分配内存、维护引用计数等，NSNumber 等对象的指针存储的是堆中 NSNumber 对象的地址值。</li>
<li>使用 Tagged Pointer 之后，NSNumber 指针里面存储的数据变成了：Tag + Data，也就是将数据直接存储在了指针中。</li>
<li>当指针不够存储数据时，才会使用动态分配内存的方式来存储数据。</li>
<li><code>objc_msgSend()</code> 能识别 Tagged Pointer，比如 NSNumber 的 intValue 方法，直接从指针提取数据，节省了以前的调用开销。</li>
<li>如何判断一个指针是否为Tagged Pointer？<br>iOS平台，最高有效位是1（第64bit）<br>Mac平台，最低有效位是1  </li>
</ul>
<h2 id="NSNumber"><a href="#NSNumber" class="headerlink" title="NSNumber"></a>NSNumber</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        </div><div class="line">        <span class="built_in">NSNumber</span> *number1 = @<span class="number">4</span>;</div><div class="line">        <span class="built_in">NSNumber</span> *number2 = @<span class="number">5</span>;</div><div class="line">        <span class="built_in">NSNumber</span> *number3 = @(<span class="number">0xFFFFFFFFFFFFFFFF</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, number1, number2, number3);</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> a = [number1 intValue];</div><div class="line"></div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0xb0d1e4bcdb858740</span> <span class="number">0xb0d1e4bcdb858750</span> <span class="number">0x600000b4c080</span></div></pre></td></tr></table></figure></p>
<p><code>0xb0d1e4bcdb858740</code> 和 <code>0xb0d1e4bcdb858750</code> 去掉前面相同的部分后是 <code>0x40</code> 和 <code>0x50</code>，可以看出数据直接存储在了指针中。当指针不够存储数据时，如 <code>@(0xFFFFFFFFFFFFFFFF)</code> 打印出来的内存地址是 <code>0x600000b4c080</code>（堆空间里 NSNumber 对象的地址值），是使用了动态分配内存的方式来存储数据。</p>
<p>因为 <code>objc_msgSend()</code> 能识别 Tagged Pointer，所以在 number1 调用 <code>intValue</code> 方法时，<code>objc_msgSend()</code> 直接从指针提取数据。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">int a</span> = [number1 intValue];</div></pre></td></tr></table></figure></p>
<p>可以看出 Tagged Pointer 技术不仅仅是内存空间的优化，也对使用过程进行了优化。</p>
<h2 id="NSString"><a href="#NSString" class="headerlink" title="NSString"></a>NSString</h2><h3 id="例一："><a href="#例一：" class="headerlink" title="例一："></a>例一：</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>运行后报错（坏内存访问）：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理07.png" alt="内存管理07"></p>
<p>因为 <code>name</code> 是非原子性（<code>nonatomic</code>）的，多条线程同时访问 <code>name</code> 的 set 方法时，如果有一条线程已经将 <code>_name</code> 释放了，其它线程再次对 <code>_name</code> 进行释放操作就会出现坏内存访问的错误：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)<span class="built_in">setName</span>:(NSString *)<span class="built_in">name</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="variable">_name</span> != <span class="built_in">name</span>) &#123;</div><div class="line">        [<span class="variable">_name</span> release]; <span class="comment">// 多条线程同时操作这一行，如果 `_name` 已经被释放了，其它线程再次对 `_name` 进行 release 操作，坏内存访问</span></div><div class="line">        <span class="variable">_name</span> = [<span class="built_in">name</span> copy];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="解决方案一："><a href="#解决方案一：" class="headerlink" title="解决方案一："></a>解决方案一：</h4><p>将 <code>name</code> 改成原子性的：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">property</span> (atomic, <span class="keyword">copy</span>) NSString *<span class="built_in">name</span>;</div></pre></td></tr></table></figure></p>
<p>程序运行正常。</p>
<p>将 <code>name</code> 改成原子性后，<code>name</code> 的 set 方法就是线程安全的了，不会出现多条线程同时对 <code>name</code> 进行 release 操作。</p>
<h4 id="解决方案二："><a href="#解决方案二：" class="headerlink" title="解决方案二："></a>解决方案二：</h4><p>将 <code>name</code> 改成原子性后，任何地方、任何时候调用 <code>name</code> 的 get 方法都是有锁的。因为 <code>name</code> 只需要在异步线程访问时加锁，如果在主线程的话没有必要加锁，所以不使用 <code>atomic</code> 而是选择手动加锁，哪里需要就在哪里加锁，尽可能的提升效率节省资源：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 加锁</span></div><div class="line"><span class="meta">#define SemaphoreBegin \</span></div><div class="line"><span class="keyword">static</span> dispatch_semaphore_t semaphore; \</div><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken; \</div><div class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; \</div><div class="line">    semaphore = dispatch_semaphore_create(<span class="number">1</span>); \</div><div class="line">&#125;); \</div><div class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line"><span class="comment">/// 解锁</span></div><div class="line"><span class="meta">#define SemaphoreEnd \</span></div><div class="line">dispatch_semaphore_signal(semaphore);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="comment">// 加锁</span></div><div class="line">            SemaphoreBegin;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">            <span class="comment">// 解锁</span></div><div class="line">            SemaphoreEnd;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>程序运行正常。</p>
<h3 id="例二："><a href="#例二：" class="headerlink" title="例二："></a>例二：</h3><p>将 <code>@&quot;abcdefghijk&quot;</code> 改成 <code>@&quot;abc&quot;</code>：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</div><div class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abc"</span>];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>运行正常。  </p>
<p>同样是多线程访问、没有加锁，但是将 <code>@&quot;abcdefghijk&quot;</code> 改成 <code>@&quot;abc&quot;</code> 后，就不会出现坏内存访问的错误，难道是没有调用 <code>name</code> 的 set 方法吗？是的。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSString</span> *str1 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghijk"</span>];</div><div class="line">    <span class="built_in">NSString</span> *str2 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abc"</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%p %p"</span>, str1, str2);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ %@"</span>, [str1 <span class="keyword">class</span>], [str2 <span class="keyword">class</span>]);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x600002aefd</span>c0 <span class="number">0x9cedd</span>15798132057</div><div class="line">__NSCFString NSTaggedPointerString</div></pre></td></tr></table></figure></p>
<p>str1 是一个 <code>__NSCFString</code>，其内存地址是6开头的，说明 str1 是存储在堆空间里的。<br>str2 是一个 <code>NSTaggedPointerString</code>，<code>@&quot;abc&quot;</code> 存储在 str2 指针里，不会调用 set 方法，取值时也不会调用 get 方法而是直接从指针里取值。</p>
<h2 id="判断是否是-Tagged-Pointer"><a href="#判断是否是-Tagged-Pointer" class="headerlink" title="判断是否是 Tagged Pointer"></a>判断是否是 Tagged Pointer</h2><p><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 objc-internal.h 文件里：</p>
<p><code>_OBJC_TAG_MASK</code> 定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span></div><div class="line">    <span class="comment">// 64-bit Mac - tag bit is LSB</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 0 <span class="comment">// Mac</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="comment">// Everything else - tag bit is MSB</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> OBJC_MSB_TAGGED_POINTERS 1 <span class="comment">// iPhone（真机/模拟器）</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> OBJC_MSB_TAGGED_POINTERS</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> _OBJC_TAG_MASK 1UL </span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>判断是否是 tagged pointer：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> </div><div class="line">_objc_isTaggedPointer(<span class="keyword">const</span> <span class="keyword">void</span> * _Nullable ptr)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果是 mac，<code>_OBJC_TAG_MASK</code> 等于1。如果不是 mac， <code>_OBJC_TAG_MASK</code> 等于 1UL&lt;&lt;63。<code>_OBJC_TAG_MASK</code> 和指针地址进行与运算，判断结果是否是 <code>_OBJC_TAG_MASK</code>，如果是的话，那这个指针就是 tagged pointer。<br>在 iOS 平台，如果指针转成2进制后它的最高位（64位）为1的话，那么这个指针就是 tagged pointer。<br>在 Mac 平台，如果指针转成2进制后它的最低位为1的话，那么这个指针就是 tagged pointer。</p>
<h1 id="MRC"><a href="#MRC" class="headerlink" title="MRC"></a>MRC</h1><ul>
<li>在 iOS 中，使用引用计数来管理 OC 对象的内存。  </li>
<li>一个新创建的 OC 对象引用计数默认是1，当引用计数减为0，OC 对象就会销毁，释放其占用的内存空间。  </li>
<li>调用 retain 会让 OC 对象的引用计数+1，调用 release 会让 OC 对象的引用计数-1。  </li>
<li>内存管理的经验总结：<br>当调用 alloc、new、copy、mutableCopy 方法返回了一个对象，在不需要这个对象时，要调用 release 或者 autorelease 来释放它。<br>想拥有某个对象，就让它的引用计数+1；不想再拥有某个对象，就让它的引用计数-1。  </li>
<li>可以通过以下私有函数来查看自动释放池的情况  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="keyword">void</span> _objc_autoreleasePoolPrint(<span class="keyword">void</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>👉 使用 MRC：Build Setting -&gt; Objective-C Automatic Referencd Counting 设置为 YES。</p>
<p>定义 Person 类：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Person</div><div class="line">- (void)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="selector-attr">[super dealloc]</span>;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<h2 id="release"><a href="#release" class="headerlink" title="release"></a>release</h2><p>创建 person 对象：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init]; <span class="comment">// Person *person = [Person new];</span></div><div class="line">        NSLog(@<span class="string">"%zd"</span>, person.retainCount);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，person 对象调用完 <code>alloc</code> 方法后引用计数是1，没有被释放。</p>
<p>添加 release：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        <span class="comment">// 使用 person 对象</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, person.retainCount);</div><div class="line"></div><div class="line">        [person release];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，因为 person 对象调用完 <code>alloc</code> 方法后引用计数是1，调用完 <code>release</code> 方法后引用计数减1等于0，所以 person 对象在调用 <code>release</code> 的那一刻就被释放了。</p>
<p>MRC 下 <code>alloc</code> 方法和 <code>release</code> 方法是一一对应的，每个对象使用完成后都要调用一下 <code>release</code> 方法，这样才能避免内存泄漏。另外，在使用 <code>release</code> 方法管理 person 对象时，要保证在调用 <code>release</code> 方法之前使用 person 对象。</p>
<h2 id="autorelease"><a href="#autorelease" class="headerlink" title="autorelease"></a>autorelease</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[[Person alloc] init] autorelease];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, person.retainCount);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span></div><div class="line"><span class="number">111</span></div><div class="line">-[Person dealloc]</div><div class="line"><span class="number">222</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，因为 person 对象调用完 <code>alloc</code> 方法又调用了 <code>autorelease</code> 后引用计数是1，直到 <code>@autoreleasepool {}</code> 执行完那一刻才被释放。  </p>
<p>在 <code>@autoreleasepool {}</code> 执行完那一刻，会对调用了 <code>autorelease</code> 方法的对象进行 <code>release</code> 操作：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv<span class="comment">[]</span>) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="keyword">Person</span> *person1 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        <span class="keyword">Person</span> *person2 = <span class="comment">[<span class="comment">[<span class="comment">[Person alloc]</span> init]</span> autorelease]</span>;</div><div class="line">        NSLog(@<span class="string">"111"</span>);</div><div class="line">    &#125; // <span class="comment">[person release]</span>、<span class="comment">[person release]</span></div><div class="line">    NSLog(@<span class="string">"222"</span>);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>使用 <code>autorelease</code> 方法管理 person 对象的内存，只需要在调用 <code>alloc</code> 方法的同时调用一下 <code>autorelease</code> 方法，就可以放心的使用 person 对象了，当然是在 <code>@autoreleasepool {}</code> 内部使用。不用再关心 person 对象的释放问题，在 <code>@autoreleasepool {}</code> 执行完那一刻，person 对象会自动调用 <code>release</code> 方法。</p>
<h2 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h2><p>错误演示：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Dog</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Dog</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Dog</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// Person</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">&#123;</div><div class="line">    Dog *_dog;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog;</div><div class="line">- (Dog *)dog;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    _dog = dog;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// 调用</span></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// 引用计数：1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person setDog:dog];</div><div class="line">        </div><div class="line">        [dog release]; <span class="comment">// 引用计数：0</span></div><div class="line">        </div><div class="line">        [[person dog] run];</div><div class="line">        </div><div class="line">        [person release];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印信息：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Dog dealloc]</span></div></pre></td></tr></table></figure></p>
<p><code>[[person dog] run]</code> 这个时候 dog 对象因为引用计数为0已经被释放了。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理08.png" alt="内存管理08"></p>
<p><code>[person setDog:dog]</code> 方法表示 person 对象想要用于 dog 对象，那么 person 对象应该对 dog 的引用计数加1，只要 person 对象还在，dog 对象就不可以被释放。</p>
<p>上面的写法有两个地方需要优化：<br>1、Person 类的 <code>- (void)setDog:(Dog *)dog</code> 方法在获取 dog 对象时，引用计数需要加1。<br>2、Person 类的 <code>- (void)dealloc</code> 方法需要对 dog 对象进行 <code>release</code> 操作。  </p>
<p>Person 类优化后：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc]; <span class="comment">// 父类的 dealloc 放到子类后</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    _dog = [dog <span class="keyword">retain</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog run]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>创建两个 person 对象引用 dog 对象：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// dog 引用计数：1</span></div><div class="line">        </div><div class="line">        Person *person1 = [[Person alloc] init];</div><div class="line">        [<span class="meta">person1 setDog:dog</span>]; <span class="comment">// dog 引用计数：2</span></div><div class="line">        </div><div class="line">        Person *person2 = [[Person alloc] init];</div><div class="line">        [<span class="meta">person2 setDog:dog</span>]; <span class="comment">// dog 引用计数：3</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog release</span>]; <span class="comment">// dog 引用计数：2</span></div><div class="line">        </div><div class="line">        [<span class="meta">person1 release</span>]; <span class="comment">// dog 引用计数：1</span></div><div class="line">        </div><div class="line">        [<span class="meta">[person2 dog</span>] run];</div><div class="line">        </div><div class="line">        [<span class="meta">person2 release</span>]; <span class="comment">// dog 引用计数：0</span></div><div class="line">        </div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby">-[Dog run]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h2 id="set-方法"><a href="#set-方法" class="headerlink" title="set 方法"></a>set 方法</h2><p>上面 Person 类里的 set 方法还有问题，在 person 对象替换 dog 对象时会出现不释放的问题：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog1 = [[Dog alloc] init]; <span class="comment">// dog1 : 1</span></div><div class="line">        Dog *dog2 = [[Dog alloc] init]; <span class="comment">// dog2 : 1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog1</span>]; <span class="comment">// dog1 : 2</span></div><div class="line">        [<span class="meta">person setDog:dog2</span>]; <span class="comment">// dog2 : 2</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog1 release</span>]; <span class="comment">// dog1 : 1</span></div><div class="line">        [<span class="meta">dog2 release</span>]; <span class="comment">// dog2 : 1</span></div><div class="line">        [<span class="meta">person release</span>]; <span class="comment">// dog0 : 0</span></div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果和注释可以看到，dog1 最后的引用计数是1，没有释放。这是因为 person 对象在拥有 dog1 时，将 <code>_dog</code> 指向了 dog1 并对其引用计数加1，后又将 <code>_dog</code> 指向了 dog2 并对其引用计数加1，所以 person 对象在调用 <code>[_dog release]</code> 时的 <code>_dog</code> 是 dog2 对象，dog1 对象因此少调用了一次 release 方法，最后的引用计数最后为1无法释放。</p>
<p>优化 set 方法：在 person 对象引用新的 dog 对象时，需要先将之前的 dog 对象进行 release 操作。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    [_dog release];</div><div class="line">    _dog = [dog <span class="keyword">retain</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，dog1 和 dog2 对象都被释放调用。但是优化后的 set 方法还不够完善，person 对象在重复设置同一个 dog 对象的时候还是有问题：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span>(<span class="params"><span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]</span>) </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Dog *dog = [[Dog alloc] init]; <span class="comment">// dog1 : 1</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog</span>]; <span class="comment">// dog1 : 2</span></div><div class="line">        </div><div class="line">        [<span class="meta">dog release</span>]; <span class="comment">// dog1 : 1</span></div><div class="line">        </div><div class="line">        [<span class="meta">person setDog:dog</span>]; <span class="comment">// dog1 : 0</span></div><div class="line">        </div><div class="line">        [<span class="meta">person release</span>];</div><div class="line">        </div><div class="line">        NSLog(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    NSLog(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>错误信息：<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理09.png" alt="内存管理09"></p>
<p>问题出在 Person 类的 set 方法：<br>第一次赋值，dog 对象的引用计数加一，此时 dog 对象的引用计数等于2。<br>dog 对象调用了一次 release 方法，此时 dog 对象的引用计数等于1。<br>第二次赋值，会先调用 <code>[_dog release]</code>, 此时 dog 对象的引用计数等于0，dog 对象被释放。再调用 <code>_dog = [dog retain]</code>，此时 dog 指向的内存已经被销毁了：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    [_dog <span class="built_in">release</span>]; <span class="comment">// dog : 0</span></div><div class="line">    _dog = [dog retain]; <span class="comment">// dog 指向的内存已经被销毁</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因此，在 set 方法里对 <code>_dog</code> 处理前，需要先判断一下 <code>_dog</code> 是否等于传入的 dog 对象。因为一个 person 对象在拥有一个 dog 对象时只需要对其 retain 一次，所以如果 <code>_dog == dog</code> 就不做处理。</p>
<p>优化 Person 类里的 set 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (_dog != dog) &#123;</div><div class="line">        [_dog release];</div><div class="line">        _dog = [dog <span class="keyword">retain</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Dog dealloc]</span></div><div class="line"><span class="ruby">-[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">111</span></span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h2 id="property-属性"><a href="#property-属性" class="headerlink" title="property 属性"></a>property 属性</h2><p>在 .h 文件通过 property 声明的属性，编译器会自动生成成员变量和属性的 setter、getter 实现。</p>
<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, assign) int age;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure>
<p>编译器自动生成：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"></div><div class="line"><span class="meta">@synthesize</span> age = _age;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">setAge:</span>(<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    _age = age;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _age;</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="对象类型"><a href="#对象类型" class="headerlink" title="对象类型"></a>对象类型</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, retain) Dog *dog;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure>
<p>编译器自动生成：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line"><span class="keyword">@synthesize</span> dog = _dog;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setDog:(Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (_dog != dog) &#123;</div><div class="line">        [_dog release];</div><div class="line">        _dog = [dog <span class="keyword">retain</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (Dog *)dog</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _dog;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>如果是在 MRC 环境下，这种情况下还需要在 delloc 方法里手动调用 _dog 的 release 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.dog = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="常用代码解析"><a href="#常用代码解析" class="headerlink" title="常用代码解析"></a>常用代码解析</h2><p>创建一个 iOS 项目，设置 MRC 环境。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSMutableArray</span> *data;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *data = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    <span class="keyword">self</span>.data = data;</div><div class="line">    [data release];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span>.data = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>简化：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad]<span class="comment">;</span></div><div class="line">    </div><div class="line">    self<span class="meta">.data</span> = [[NSMutableArray alloc] init]<span class="comment">;</span></div><div class="line">    [self<span class="meta">.data</span> release]<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>autorelease</code>：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    <span class="comment">[super viewDidLoad]</span>;</div><div class="line">    </div><div class="line">    self.data = <span class="comment">[<span class="comment">[<span class="comment">[NSMutableArray alloc]</span> init]</span> autorelease]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>+array</code>：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.data = [<span class="built_in">NSMutableArray</span> array];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不是通过 <code>alloc</code> 方法初始化的，而是通过类方法初始化的，在类方法内部已经调用过 <code>autorelease</code> 了。类方法 <code>+array</code> 大概是这样：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)array</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[[<span class="built_in">NSMutableArray</span> alloc] init] autorelease];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)person;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">instancetype</span>)person</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [[[Person alloc] init] autorelease];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> dealloc];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        </div><div class="line">        Person *person = [Person person];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"111"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"222"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">111</div><div class="line">-<span class="ruby">[Person dealloc]</span></div><div class="line"><span class="ruby"><span class="number">222</span></span></div></pre></td></tr></table></figure></p>
<h1 id="copy和mutableCopy"><a href="#copy和mutableCopy" class="headerlink" title="copy和mutableCopy"></a>copy和mutableCopy</h1><ul>
<li><p>拷贝的目的：产生一个副本对象，跟原对象互不影响<br>修改了原对象，不会影响副本对象<br>修改了副本对象，不会影响原对象  </p>
</li>
<li><p>iOS 提供了两个拷贝方法<br>1、copy，不可变拷贝，产生不可变副本<br>2、mutableCopy，可变拷贝，产生可变副本  </p>
</li>
</ul>
<h2 id="例一"><a href="#例一" class="headerlink" title="例一"></a>例一</h2><h3 id="NSString-1"><a href="#NSString-1" class="headerlink" title="NSString"></a>NSString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 返回的是 NSString</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 返回的是 NSMutableString</span></div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [str1 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str2 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str3 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0 0 1</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是 str1 和 str2 是不可变字符串，str3 是可变字符串。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<h3 id="NSMutableString"><a href="#NSMutableString" class="headerlink" title="NSMutableString"></a>NSMutableString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableString</span> *str1 = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [str1 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str2 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]],</div><div class="line">              [str3 isKindOfClass:[<span class="built_in">NSMutableString</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">1 0 1</div></pre></td></tr></table></figure></p>
<p>不管是可变字符串还是不可变字符串，调用 <code>copy</code> 返回的都是不可变字符串，调用 <code>mutableCopy</code> 返回的都是可变字符串。</p>
<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>在 MRC 环境下，调用 alloc、new、copy、mutableCopy 方法返回了一个对象，在不需要这个对象时，要调用 release 或者 autorelease 来释放它。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line"></div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="深拷贝和浅拷贝"><a href="#深拷贝和浅拷贝" class="headerlink" title="深拷贝和浅拷贝"></a>深拷贝和浅拷贝</h3><ul>
<li>深拷贝：内容拷贝，产生新的对象</li>
<li>浅拷贝：指针拷贝，没有产生新的对象</li>
</ul>
<h3 id="NSString-2"><a href="#NSString-2" class="headerlink" title="NSString"></a>NSString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝：指针拷贝，没有产生新对象</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 深拷贝：内容拷贝，又产生新对象</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, str1, str2, str3);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0x100001018 0x100001018 0x1007bb4e0</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是 str1 和 str2 指向的是同一个内存地址，str3 指向的是另一个内存地址。即 str1 通过 <code>copy</code> 方法拷贝出来的副本 str2 还是原对象（str1），而 str1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 str3 是一个新的对象。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理10.png" alt="内存管理10"></p>
<p>👉 拷贝的目的：产生一个副本对象，跟原对象互不影响。<br>str1 是一个不可变字符串对象，通过 <code>copy</code> 方法拷贝出来的副本也是不可变字符串对象。因为不可变字符串对象不可以被修改，不可以被修改就不会互相影响，所以 str1 和 str2 指向同一个对象满足拷贝的原则（互不影响）。而且将 str1 和 str2 指向同一个对象还节省了内存。<br>str1 是一个不可变字符串对象，通过 <code>mutableCopy</code> 方法拷贝出来的副本是可变字符串对象。因为可变字符串对象可以被修改，所以 str3 指向的是一个新的对象，保证在修改 str3 时不会影响到 str1。  </p>
<p>（总的来看，既要保证互不影响，也要做到节省资源）</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str3 = [str2 <span class="keyword">copy</span>];</div><div class="line">        <span class="built_in">NSString</span> *str4 = <span class="string">@"test"</span>;</div><div class="line">        <span class="built_in">NSMutableString</span> *str5 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@ %@ %@ %@"</span>, <span class="string">@"test"</span>, str1, str2, str3, str4, str5);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p %p %p %p"</span>, <span class="string">@"test"</span>, str1, str2, str3, str4, str5);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>str1、str2、str3 和 str4 都是 <code>@&quot;test&quot;</code> 对象。</p>
<p>引用计数：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test111111111"</span>]; <span class="comment">// str1 : 1</span></div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// str1 : 2</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, str1.retainCount);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，str1 在调用 <code>copy</code> 方法后，引用计数加1，相当于调用了一次 <code>retain</code> 方法。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSString</span> *str1 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test111111111"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str3 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, [str1 <span class="keyword">class</span>], [str2 <span class="keyword">class</span>], [str3 <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd %zd %zd"</span>, str1.retainCount, str2.retainCount, str3.retainCount);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__NSCFString NSTaggedPointerString __NSCFConstantString</div><div class="line"><span class="number">1</span> <span class="number">-1</span> <span class="number">-1</span></div></pre></td></tr></table></figure></p>
<p>使用 <code>initWithFormat:</code> 方法初始化字符串，字符串长度足够长，创建出来的是 <code>__NSCFString</code> 类型的字符串。<code>__NSCFString</code> 类型的字符串是通过引用计数管理内存的。<br>使用 <code>initWithFormat:</code> 方法初始化字符串，字符串长度不够长，创建出来的是 <code>NSTaggedPointerString</code> 类型的字符串。<code>NSTaggedPointerString</code> 类型的字符串不是通过引用计数管理内存的。<br>使用 <code>initWithString:</code> 方法初始化字符串，不管字符串长度，创建出来的是 <code>__NSCFConstantString</code> 类型的字符串。<code>__NSCFConstantString</code> 类型的字符串不是通过引用计数管理内存的。</p>
<h3 id="NSMutableString-1"><a href="#NSMutableString-1" class="headerlink" title="NSMutableString"></a>NSMutableString</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableString</span> *str1 = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"test"</span>];</div><div class="line">        <span class="built_in">NSString</span> *str2 = [str1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableString</span> *str3 = [str1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, str1, str2, str3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, str1, str2, str3);</div><div class="line">        </div><div class="line">        [str1 release];</div><div class="line">        [str2 release];</div><div class="line">        [str3 release];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test test</span> test</div><div class="line">0x103aaab50 0x48301b1a78a3a9e5 0x103aab150</div></pre></td></tr></table></figure></p>
<p>str1、str2 和 str3 打印出来都是 test，但是他们指向的都是不同的内存地址。即 str1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 str2 和 str3 都是一个新的对象。<br><img src="/2020/08/14/OC底层/原理/内存管理/内存管理11.png" alt="内存管理11"></p>
<h3 id="NSArray"><a href="#NSArray" class="headerlink" title="NSArray"></a>NSArray</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSArray</span> *arr1 = [[<span class="built_in">NSArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [arr1 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr2 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr3 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">)</div><div class="line"><span class="number">0x1004bfc20</span> <span class="number">0x1004bfc20</span> <span class="number">0x1004c0100</span></div><div class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>arr1 和 arr2 是不可变数组，arr3 是可变数组。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<p>arr1、arr2 和 arr3 打印出来都是同样的内容，但是 arr1 和 arr2 指向的是同一个内存地址，arr3 指向的是另一个内存地址。即 arr1 通过 <code>copy</code> 方法拷贝出来的副本 arr2 还是原对象（arr1），而 arr1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 arr3 是一个新的对象。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSArray</span> *arr1 = [[<span class="built_in">NSArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p %p"</span>, @[<span class="string">@"1"</span>, <span class="string">@"2"</span>], arr1, arr2, arr3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x100713270</span> <span class="number">0x100712d60</span> <span class="number">0x100712d60</span> <span class="number">0x100713240</span></div></pre></td></tr></table></figure></p>
<p>NSArray 和 NSString 不同，<code>@[@&quot;1&quot;, @&quot;2&quot;]</code>、arr1 和 arr2 虽然内容相同，但是它们是不同的对象（arr1 和 arr2 是同一个对象）。</p>
<h3 id="NSMutableArray"><a href="#NSMutableArray" class="headerlink" title="NSMutableArray"></a>NSMutableArray</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableArray</span> *arr1 = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:@[<span class="string">@"1"</span>, <span class="string">@"2"</span>]];</div><div class="line">        <span class="built_in">NSArray</span> *arr2 = [arr1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableArray</span> *arr3 = [arr1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, arr1, arr2, arr3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>,</div><div class="line">              [arr1 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr2 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]],</div><div class="line">              [arr3 isKindOfClass:[<span class="built_in">NSMutableArray</span> <span class="keyword">class</span>]]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">) (</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span></div><div class="line">)</div><div class="line"><span class="number">0x100535780</span> <span class="number">0x1005358f0</span> <span class="number">0x100535910</span></div><div class="line"><span class="number">1</span> <span class="number">0</span> <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>arr1 和 arr3 是可变数组，arr2 是不可变数组。即：<br>[可变 copy] -&gt; 不可变<br>[可变 mutableCopy] -&gt; 可变  </p>
<p>arr1、arr2 和 arr3 打印出来都是同样的内容，但是他们指向的都是不同的内存地址。即 arr1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 arr2 和 arr3 都是一个新的对象。</p>
<h3 id="NSDictionary"><a href="#NSDictionary" class="headerlink" title="NSDictionary"></a>NSDictionary</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *dict1 = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value"</span>, <span class="string">@"key"</span>, <span class="literal">nil</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *dict2 = [dict1 <span class="keyword">copy</span>]; <span class="comment">// 浅拷贝</span></div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict3 = [dict1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, dict1, dict2, dict3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, dict1, dict2, dict3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125;</div><div class="line"><span class="number">0x100491ff0</span> <span class="number">0x100491ff0</span> <span class="number">0x1004923f0</span></div></pre></td></tr></table></figure></p>
<p>dict1 和 dict2 是不可变字典，dict3 是可变字典。即：<br>[不可变 copy] -&gt; 不可变<br>[不可变 mutableCopy] -&gt; 可变  </p>
<p>dict1、dict2 和 dict3 打印出来都是同样的内容，但是 dict1 和 dict2 指向的是同一个内存地址，dict3 指向的是另一个内存地址。即 dict1 通过 <code>copy</code> 方法拷贝出来的副本 dict2 还是原对象（dict1），而 dict1 通过 <code>mutableCopy</code> 方法拷贝出来的副本 dict3 是一个新的对象。</p>
<h3 id="NSMutableDictionary"><a href="#NSMutableDictionary" class="headerlink" title="NSMutableDictionary"></a>NSMutableDictionary</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict1 = [<span class="built_in">NSMutableDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value"</span>, <span class="string">@"key"</span>, <span class="literal">nil</span>];</div><div class="line">        <span class="built_in">NSDictionary</span> *dict2 = [dict1 <span class="keyword">copy</span>]; <span class="comment">// 深拷贝</span></div><div class="line">        <span class="built_in">NSMutableDictionary</span> *dict3 = [dict1 mutableCopy]; <span class="comment">// 深拷贝</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ %@ %@"</span>, dict1, dict2, dict3);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p %p %p"</span>, dict1, dict2, dict3);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125; &#123;</div><div class="line">    <span class="type">key</span> = value;</div><div class="line">&#125;</div><div class="line"><span class="number">0x100463300</span> <span class="number">0x100463900</span> <span class="number">0x100463920</span></div></pre></td></tr></table></figure></p>
<p>dict1 和 dict3 是可变字典，dict2 是不可变字典。即：<br>[可变 copy] -&gt; 不可变<br>[可变 mutableCopy] -&gt; 可变  </p>
<p>dict1、dict2 和 dict3 打印出来都是同样的内容，但是他们指向的都是不同的内存地址。即 dict1 通过 <code>copy</code> 和 <code>mutableCopy</code> 方法拷贝出来的副本 dict2 和 dict3 都是一个新的对象。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OC底层原理/" rel="tag"># OC底层原理</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/14/OC底层/原理/多线程/" rel="next" title="多线程">
                <i class="fa fa-chevron-left"></i> 多线程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/myAvatar.gif"
              alt="Kevin" />
          
            <p class="site-author-name" itemprop="name">Kevin</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/KevinYangGit" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_YangQI" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>Twitter</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CADisplayLink、NSTimer-定时器"><span class="nav-number">1.</span> <span class="nav-text">CADisplayLink、NSTimer 定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#循环引用问题"><span class="nav-number">1.1.</span> <span class="nav-text">循环引用问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CADisplayLink"><span class="nav-number">1.1.1.</span> <span class="nav-text">CADisplayLink</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSTimer"><span class="nav-number">1.1.2.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题分析"><span class="nav-number">1.1.3.</span> <span class="nav-text">问题分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决方案"><span class="nav-number">1.2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案一：使用-block"><span class="nav-number">1.2.1.</span> <span class="nav-text">方案一：使用 block</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案二：使用中间对象"><span class="nav-number">1.2.2.</span> <span class="nav-text">方案二：使用中间对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSTimer-1"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CADisplayLink-1"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">CADisplayLink</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用代理对象（NSProxy）"><span class="nav-number">1.3.</span> <span class="nav-text">使用代理对象（NSProxy）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSTimer-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">NSTimer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CADisplayLink-2"><span class="nav-number">1.3.2.</span> <span class="nav-text">CADisplayLink</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSProxy"><span class="nav-number">1.4.</span> <span class="nav-text">NSProxy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GCD-定时器"><span class="nav-number">2.</span> <span class="nav-text">GCD 定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#block-回调："><span class="nav-number">2.1.</span> <span class="nav-text">block 回调：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#函数回调："><span class="nav-number">2.2.</span> <span class="nav-text">函数回调：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义队列"><span class="nav-number">2.3.</span> <span class="nav-text">自定义队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#封装-GCD"><span class="nav-number">2.4.</span> <span class="nav-text">封装 GCD</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iOS程序的内存布局"><span class="nav-number">3.</span> <span class="nav-text">iOS程序的内存布局</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tagged-Pointer"><span class="nav-number">4.</span> <span class="nav-text">Tagged Pointer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NSNumber"><span class="nav-number">4.1.</span> <span class="nav-text">NSNumber</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NSString"><span class="nav-number">4.2.</span> <span class="nav-text">NSString</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#例一："><span class="nav-number">4.2.1.</span> <span class="nav-text">例一：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案一："><span class="nav-number">4.2.1.1.</span> <span class="nav-text">解决方案一：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案二："><span class="nav-number">4.2.1.2.</span> <span class="nav-text">解决方案二：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#例二："><span class="nav-number">4.2.2.</span> <span class="nav-text">例二：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#判断是否是-Tagged-Pointer"><span class="nav-number">4.3.</span> <span class="nav-text">判断是否是 Tagged Pointer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MRC"><span class="nav-number">5.</span> <span class="nav-text">MRC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#release"><span class="nav-number">5.1.</span> <span class="nav-text">release</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#autorelease"><span class="nav-number">5.2.</span> <span class="nav-text">autorelease</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#retain"><span class="nav-number">5.3.</span> <span class="nav-text">retain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#set-方法"><span class="nav-number">5.4.</span> <span class="nav-text">set 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#property-属性"><span class="nav-number">5.5.</span> <span class="nav-text">property 属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本数据类型"><span class="nav-number">5.6.</span> <span class="nav-text">基本数据类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象类型"><span class="nav-number">5.7.</span> <span class="nav-text">对象类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用代码解析"><span class="nav-number">5.8.</span> <span class="nav-text">常用代码解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工厂方法"><span class="nav-number">5.9.</span> <span class="nav-text">工厂方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#copy和mutableCopy"><span class="nav-number">6.</span> <span class="nav-text">copy和mutableCopy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#例一"><span class="nav-number">6.1.</span> <span class="nav-text">例一</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSString-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">NSString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableString"><span class="nav-number">6.1.2.</span> <span class="nav-text">NSMutableString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内存管理"><span class="nav-number">6.1.3.</span> <span class="nav-text">内存管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#深拷贝和浅拷贝"><span class="nav-number">6.1.4.</span> <span class="nav-text">深拷贝和浅拷贝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSString-2"><span class="nav-number">6.1.5.</span> <span class="nav-text">NSString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableString-1"><span class="nav-number">6.1.6.</span> <span class="nav-text">NSMutableString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSArray"><span class="nav-number">6.1.7.</span> <span class="nav-text">NSArray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableArray"><span class="nav-number">6.1.8.</span> <span class="nav-text">NSMutableArray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSDictionary"><span class="nav-number">6.1.9.</span> <span class="nav-text">NSDictionary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSMutableDictionary"><span class="nav-number">6.1.10.</span> <span class="nav-text">NSMutableDictionary</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://rawgit.com/qhh0205/78e9e0b1f3114db6737f3ed8cdd51d3a/raw/3894c5be5aa2378336b1f5ee0f296fa0b22d06e9/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '82b6ced795961ee1fcca',
          clientSecret: '4a2f24a39c6fcd85813d80031c6e0262a65404f5',
          repo: 'KevinYangGit.github.io',
          owner: '',
          admin: [''],
          id: md5(location.pathname),
          distractionFreeMode: ''
        })
        gitalk.render('gitalk-container')
    </script>

  





  

  

  

  

  

  

</body>
</html>
