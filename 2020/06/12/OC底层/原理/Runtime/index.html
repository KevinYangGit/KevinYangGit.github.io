<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="OCåº•å±‚åŸç†," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="æ€è€ƒï¼š  è®²ä¸€ä¸‹ OC çš„æ¶ˆæ¯æœºåˆ¶ æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹ ä»€ä¹ˆæ˜¯ Runtimeï¼Ÿå¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡ä¹ˆï¼Ÿ Runtime çš„å…·ä½“åº”ç”¨">
<meta name="keywords" content="OCåº•å±‚åŸç†">
<meta property="og:type" content="article">
<meta property="og:title" content="Runtime">
<meta property="og:url" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/index.html">
<meta property="og:site_name" content="Kevin&#39;s  blog">
<meta property="og:description" content="æ€è€ƒï¼š  è®²ä¸€ä¸‹ OC çš„æ¶ˆæ¯æœºåˆ¶ æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹ ä»€ä¹ˆæ˜¯ Runtimeï¼Ÿå¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡ä¹ˆï¼Ÿ Runtime çš„å…·ä½“åº”ç”¨">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime01.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime02.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime05.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime04.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime06.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime07.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime03.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime08.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime09.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime10.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime11.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime12.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime17.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime18.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime13.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime14.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime19.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime15.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime16.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime20.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime21.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime22.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime26.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime23.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime24.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime25.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime27.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime28.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime29.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime30.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime31.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime32.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime33.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime35.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime36.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime34.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime38.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime39.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime37.png">
<meta property="og:updated_time" content="2020-08-12T16:35:04.440Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Runtime">
<meta name="twitter:description" content="æ€è€ƒï¼š  è®²ä¸€ä¸‹ OC çš„æ¶ˆæ¯æœºåˆ¶ æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹ ä»€ä¹ˆæ˜¯ Runtimeï¼Ÿå¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡ä¹ˆï¼Ÿ Runtime çš„å…·ä½“åº”ç”¨">
<meta name="twitter:image" content="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/"/>





  <title>Runtime | Kevin's  blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin's  blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            å…¬ç›Š404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/12/OCåº•å±‚/åŸç†/Runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myAvatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's  blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Runtime</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2020-06-12T18:27:54+08:00">
                2020-06-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>æ€è€ƒï¼š</p>
<ul>
<li>è®²ä¸€ä¸‹ OC çš„æ¶ˆæ¯æœºåˆ¶</li>
<li>æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹</li>
<li>ä»€ä¹ˆæ˜¯ Runtimeï¼Ÿå¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡ä¹ˆï¼Ÿ</li>
<li>Runtime çš„å…·ä½“åº”ç”¨</li>
</ul>
<a id="more"></a>
<ul>
<li><p>æ‰“å°ç»“æœåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ‰“å°1</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self class] = %@"</span>, [<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super class] = %@"</span>, [<span class="keyword">super</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self superclass] = %@"</span>, [<span class="keyword">self</span> superclass]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super superclass] = %@"</span>, [<span class="keyword">super</span> superclass]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//æ‰“å°2</span></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">BOOL</span> res1 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res2 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res3 = [[Person <span class="keyword">class</span>] isKindOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res4 = [[Person <span class="keyword">class</span>] isMemberOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d %d"</span>, res1, res2, res3, res4);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ä»¥ä¸‹ä»£ç èƒ½ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Ÿå¦‚æœå¯ä»¥ï¼Œæ‰“å°ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)print;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)print &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"my name's %@"</span>, <span class="keyword">self</span>.name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj print];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>Objective-C æ˜¯ä¸€é—¨åŠ¨æ€æ€§æ¯”è¾ƒå¼ºçš„ç¼–ç¨‹è¯­è¨€ï¼Œè·Ÿ Cã€C++ ç­‰è¯­è¨€æœ‰ç€å¾ˆå¤§çš„ä¸åŒï¼ŒObjective-C çš„åŠ¨æ€æ€§æ˜¯ç”± Runtime API æ¥æ”¯æ’‘çš„ï¼ŒRuntime API æä¾›çš„æ¥å£åŸºæœ¬éƒ½æ˜¯ C è¯­è¨€çš„ï¼Œæºç ç”± C\C++\æ±‡ç¼–è¯­è¨€ç¼–å†™ã€‚</p>
<h1 id="isa-è¯¦è§£"><a href="#isa-è¯¦è§£" class="headerlink" title="isa è¯¦è§£"></a>isa è¯¦è§£</h1><p>å­¦ä¹  Runtimeï¼Œé¦–å…ˆè¦äº†è§£å®ƒåº•å±‚çš„ä¸€äº›å¸¸ç”¨æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ isa æŒ‡é’ˆã€‚åœ¨ arm64 æ¶æ„ä¹‹å‰ï¼Œisa å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚ä» arm64 æ¶æ„å¼€å§‹ï¼Œå¯¹ isa è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå˜æˆäº†ä¸€ä¸ªå…±ç”¨ä½“ï¼ˆunionï¼‰ç»“æ„ï¼Œè¿˜ä½¿ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ã€‚</p>
<h2 id="ä½è¿ç®—"><a href="#ä½è¿ç®—" class="headerlink" title="ä½è¿ç®—"></a>ä½è¿ç®—</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isTall) <span class="built_in">BOOL</span> tall;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isRich) <span class="built_in">BOOL</span> rich;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isHandsome) <span class="built_in">BOOL</span> handsome;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        person.rich = <span class="literal">YES</span>;</div><div class="line">        person.handsome = <span class="literal">YES</span>;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tallï¼š%d, richï¼š%d, handsomeï¼š%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"personçš„å¤§å°ï¼š%zd"</span>, class_getInstanceSize([person <span class="keyword">class</span>]));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">1</span>, richï¼š<span class="number">1</span>, handsomeï¼š<span class="number">1</span></div><div class="line">personçš„å¤§å°ï¼š<span class="number">16</span></div></pre></td></tr></table></figure></p>
<p>tallï¼ˆ1ä¸ªå­—èŠ‚ï¼‰+ richï¼ˆ1ä¸ªå­—èŠ‚ï¼‰+ handsomeï¼ˆ1ä¸ªå­—èŠ‚ï¼‰+ isaï¼ˆ8ä¸ªå­—èŠ‚ï¼‰= 11ä¸ªå­—èŠ‚ã€‚æ ¹æ®å†…å­˜å¯¹é½åŸåˆ™ï¼Œperson çš„å†…å­˜å¤§å°æ˜¯16ä¸ªå­—èŠ‚ã€‚</p>
<p>å› ä¸º tallã€rich å’Œ handsome éƒ½æ˜¯ BOOL ç±»å‹ï¼Œå®ƒä»¬çš„å€¼åªæœ‰0å’Œ1ï¼Œæ‰€ä»¥å¯ä»¥ç”¨3ä¸ªäºŒè¿›åˆ¶ä½æ¥å­˜å‚¨ä»–ä»¬çš„å€¼ã€‚</p>
<h3 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h3><p>å®šä¹‰ä¸€ä¸ª char ç±»å‹çš„å˜é‡ _tallRichHandsome ç”¨æ¥å­˜å‚¨3ä¸ª BOOL ç±»å‹å˜é‡çš„å€¼ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome; <span class="comment">//0b 0000 0000</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>_tallRichHandsome å 1ä¸ªå­—èŠ‚ï¼ˆ8ä½ï¼š<code>0b 0000 0000</code>ï¼‰ï¼Œè®©å®ƒæœ€å³è¾¹çš„3ä½ï¼ˆ<code>0b00000111</code>ï¼‰åˆ†åˆ«å­˜å‚¨ tallã€rich å’Œ handsomeï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0111</span> <span class="comment">//_tallRichHandsomeï¼ˆtallï¼šYES, richï¼šYES, handsomeï¼šYESï¼‰</span></div><div class="line"></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0001</span> <span class="comment">//tall</span></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0010</span> <span class="comment">//rich</span></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0100</span> <span class="comment">//handsome</span></div></pre></td></tr></table></figure></p>
<h3 id="å–å€¼"><a href="#å–å€¼" class="headerlink" title="å–å€¼"></a>å–å€¼</h3><ul>
<li>æŒ‰ä½ä¸è¿ç®—ç¬¦ï¼ˆ<code>&amp;</code>ï¼‰<br>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€œä¸â€è¿ç®—ã€‚<br>è¿ç®—è§„åˆ™ï¼š<code>0&amp;0=0</code>ï¼Œ<code>0&amp;1=0</code>ï¼Œ<code>1&amp;0=0</code>ï¼Œ<code>1&amp;1=1</code>ã€‚<br>æ€»ç»“ï¼šä¸¤ä½åŒæ—¶ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼Œå¦åˆ™ç»“æœä¸º0ã€‚ </li>
</ul>
<p>å› ä¸ºâ€œä¸â€è¿ç®—å¯ä»¥è·å–åˆ°ç‰¹å®šä½çš„å€¼ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡â€œä¸â€è¿ç®—åˆ†åˆ«è·å–ä¸‰ä¸ªå˜é‡çš„å€¼ï¼š</p>
<p>åˆå§‹åŒ– _tallRichHandsome<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_tallRichHandsome = <span class="number">0b00000101</span>; //ï¼ˆtallï¼šYES, richï¼šNO, handsomeï¼šYESï¼‰</div></pre></td></tr></table></figure></p>
<p>è·å– tallï¼ˆ<code>_tallRichHandsome &amp; 0b00000001</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000001</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000001</span></div></pre></td></tr></table></figure></p>
<p>è·å– richï¼ˆ<code>_tallRichHandsome &amp; 0b00000010</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000010</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000000</span></div></pre></td></tr></table></figure></p>
<p>è·å– handsomeï¼ˆ<code>_tallRichHandsome &amp; 0b00000100</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000100</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000100</span></div></pre></td></tr></table></figure></p>
<p>ä»£ç å®ç°ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="built_in">BOOL</span>)isTall;</div><div class="line">- (<span class="built_in">BOOL</span>)isRich;</div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        _tallRichHandsome = <span class="number">0</span>b00000101;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">1</span>); <span class="comment">//1ï¼ˆåè¿›åˆ¶ï¼‰== 0b 0000 0001ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">2</span>); <span class="comment">//2ï¼ˆåè¿›åˆ¶ï¼‰== 0b 0000 0010ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">4</span>); <span class="comment">//4ï¼ˆåè¿›åˆ¶ï¼‰== 0b 0000 0100ï¼ˆäºŒè¿›åˆ¶ï¼‰</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tallï¼š%d, richï¼š%d, handsomeï¼š%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">1</span>, richï¼š<span class="number">0</span>, handsomeï¼š<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>å› ä¸ºè¿”å›çš„æ˜¯ BOOL ç±»å‹ï¼Œè€Œâ€œä¸â€è¿ç®—å–å‡ºçš„æ˜¯æœ‰å€¼ï¼ˆ<code>0b00000001</code>ã€<code>0b00000100</code>ï¼‰å’Œ0ï¼ˆ<code>0b00000000</code>ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†å¯ä»¥è·å–åˆ° YES å’Œ NOï¼Œå¯ä»¥åœ¨â€œä¸â€è¿ç®—çš„ç»“æœå‰åŠ <code>!!</code>å–åä¸¤æ¬¡ï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">!(<span class="number">0b00000000</span>)   YES</div><div class="line">!!(<span class="number">0b00000000</span>)  NO   //!!(_tallRichHandsome &amp; <span class="number">2</span>)</div><div class="line"> </div><div class="line">!(<span class="number">0b00000001</span>)   NO</div><div class="line">!!(<span class="number">0b00000001</span>)  YES  //!!(_tallRichHandsome &amp; <span class="number">1</span>)</div><div class="line"></div><div class="line">!(<span class="number">0b00000100</span>)   NO</div><div class="line">!!(<span class="number">0b00000100</span>)  YES  //!!(_tallRichHandsome &amp; <span class="number">4</span>)</div></pre></td></tr></table></figure></p>
<h3 id="æ©ç "><a href="#æ©ç " class="headerlink" title="æ©ç "></a>æ©ç </h3><p>ä¸Šé¢ğŸ‘†çš„å®ç°å¤ªæŠ½è±¡ï¼Œå¯ä»¥ä½¿ç”¨æ©ç å¢åŠ å¯è¯»æ€§ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask 4</span></div></pre></td></tr></table></figure></p>
<p>ç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶å®šä¹‰æ©ç ä¼šæ›´ç›´è§‚ï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask <span class="number">0b00000001</span></div><div class="line">#<span class="built_in">define</span> RichMask <span class="number">0b00000010</span></div><div class="line">#<span class="built_in">define</span> HandsomeMask <span class="number">0b00000100</span></div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨ä½ç§»è¿ç®—ç¬¦ï¼Œç®€åŒ–ä»£ç ï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask (<span class="number">1</span>&lt;&lt;<span class="number">0</span>)     //å·¦ç§»<span class="number">0</span>ä½ï¼š<span class="number">0b00000001</span>ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œ<span class="number">1</span>ï¼ˆåè¿›åˆ¶ï¼‰</div><div class="line">#<span class="built_in">define</span> RichMask (<span class="number">1</span>&lt;&lt;<span class="number">1</span>)     //å·¦ç§»<span class="number">1</span>ä½ï¼š<span class="number">0b00000010</span>ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œ<span class="number">2</span>ï¼ˆåè¿›åˆ¶ï¼‰</div><div class="line">#<span class="built_in">define</span> HandsomeMask (<span class="number">1</span>&lt;&lt;<span class="number">2</span>) //å·¦ç§»<span class="number">2</span>ä½ï¼š<span class="number">0b00000100</span>ï¼ˆäºŒè¿›åˆ¶ï¼‰ï¼Œ<span class="number">4</span>ï¼ˆåè¿›åˆ¶ï¼‰</div></pre></td></tr></table></figure></p>
<ul>
<li>å·¦ç§»è¿ç®—ç¬¦ï¼ˆ<code>&lt;&lt;</code>ï¼‰<br>å®šä¹‰ï¼šå°†ä¸€ä¸ªè¿ç®—å¯¹è±¡çš„å„äºŒè¿›åˆ¶ä½å…¨éƒ¨å·¦ç§»è‹¥å¹²ä½ï¼ˆå·¦è¾¹çš„äºŒè¿›åˆ¶ä½ä¸¢å¼ƒï¼Œå³è¾¹è¡¥0ï¼‰ã€‚</li>
</ul>
<p>æœ€ç»ˆå®ç°ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">TallMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">0</span>)</div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">RichMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">1</span>)</div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">HandsomeMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">2</span>)</div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isTall</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isRich</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isHandsome</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<h3 id="è®¾å€¼"><a href="#è®¾å€¼" class="headerlink" title="è®¾å€¼"></a>è®¾å€¼</h3><ul>
<li><p>æŒ‰ä½æˆ–è¿ç®—ç¬¦ï¼ˆ<code>|</code>ï¼‰<br>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€œæˆ–â€è¿ç®—ã€‚<br>è¿ç®—è§„åˆ™ï¼š<code>0|0=0</code>ï¼Œ<code>0|1=1</code>ï¼Œ<code>1|0=1</code>ï¼Œ<code>1|1=1</code>ã€‚<br>æ€»ç»“ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡åªè¦æœ‰ä¸€ä¸ªä¸º1ï¼Œå…¶å€¼ä¸º1ã€‚</p>
</li>
<li><p>å–åè¿ç®—ç¬¦ (<code>~</code>)<br>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸€ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶è¿›è¡Œâ€œå–åâ€è¿ç®—ã€‚<br>è¿ç®—è§„åˆ™ï¼š<code>~1=0</code>ï¼Œ<code>~0=1</code>ã€‚<br>æ€»ç»“ï¼šå¯¹ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æŒ‰ä½å–åï¼Œå³å°†0å˜1ï¼Œ1å˜0ã€‚</p>
</li>
</ul>
<p>è®¾ç½® YES æ—¶ï¼Œè·Ÿ _tallRichHandsome è¿›è¡ŒæŒ‰ä½â€œæˆ–â€è¿ç®—ï¼Œä¿®æ”¹ç‰¹å®šä½ç½®çš„å€¼ã€‚<br>è®¾ç½® NO æ—¶ï¼Œå…ˆå¯¹ rich çš„äºŒè¿›åˆ¶æ•°æŒ‰ä½å–åï¼Œå†è·Ÿ _tallRichHandsome è¿›è¡ŒæŒ‰ä½â€œä¸â€è¿ç®—ã€‚</p>
<p>åˆå§‹åŒ– _tallRichHandsome<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_tallRichHandsome = <span class="number">0b00000010</span>; //ï¼ˆtallï¼šNO, richï¼šYES, handsomeï¼šNOï¼‰</div></pre></td></tr></table></figure></p>
<p>è®¾ç½® tall ä¸º YESï¼ˆ<code>_tallRichHandsome |= 0b00000001</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">| <span class="number">0b00000001</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000011</span></div></pre></td></tr></table></figure></p>
<p>è®¾ç½® rich ä¸º NOï¼ˆ<code>_tallRichHandsome &amp;= ~0b00000010</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">&amp; <span class="number">0b11111101</span>  //~<span class="number">0b00000010</span>ï¼ˆæŒ‰ä½å–åï¼‰ </div><div class="line">-------------</div><div class="line">  <span class="number">0b00000000</span></div></pre></td></tr></table></figure></p>
<p>è®¾ç½® handsome ä¸º YESï¼ˆ<code>_tallRichHandsome |= 0b00000001</code>ï¼‰<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">| <span class="number">0b00000100</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000110</span></div></pre></td></tr></table></figure></p>
<p>ä»£ç å®ç°ï¼š<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall;</div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich;</div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome;</div><div class="line">- (BOOL)isTall;</div><div class="line">- (BOOL)isRich;</div><div class="line">- (BOOL)isHandsome;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (1&lt;&lt;1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (1&lt;&lt;2)</span></div><div class="line"></div><div class="line"></div><div class="line">@interface Person()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line">@implementation Person</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall &#123;</div><div class="line">    <span class="built_in">if</span> (tall) &#123;</div><div class="line">        _tallRichHandsome |= TallMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~TallMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich &#123;</div><div class="line">    <span class="built_in">if</span> (rich) &#123;</div><div class="line">        _tallRichHandsome |= RichMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~RichMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome &#123;</div><div class="line">    <span class="built_in">if</span> (handsome) &#123;</div><div class="line">        _tallRichHandsome |= HandsomeMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~HandsomeMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isTall &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isRich &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isHandsome &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = YES;</div><div class="line">        person.rich = NO;</div><div class="line">        person.handsome = YES;</div><div class="line">        NSLog(@<span class="string">"tallï¼š%d, richï¼š%d, handsomeï¼š%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">1</span>, richï¼š<span class="number">0</span>, handsomeï¼š<span class="number">1</span></div></pre></td></tr></table></figure></p>
<h2 id="ä½åŸŸ"><a href="#ä½åŸŸ" class="headerlink" title="ä½åŸŸ"></a>ä½åŸŸ</h2><p>ä½åŸŸï¼ŒC è¯­è¨€å…è®¸åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­ä»¥ä½ä¸ºå•ä½æ¥æŒ‡å®šå…¶æˆå‘˜æ‰€å å†…å­˜é•¿åº¦ï¼Œè¿™ç§ä»¥ä½ä¸ºå•ä½çš„æˆå‘˜ç§°ä¸ºâ€œä½æ®µâ€æˆ–ç§°â€œä½åŸŸâ€( bit field) ã€‚åˆ©ç”¨ä½æ®µèƒ½å¤Ÿç”¨è¾ƒå°‘çš„ä½æ•°å­˜å‚¨æ•°æ®ã€‚</p>
<p>æœºæ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡åœ¨ç»“æ„ä½“å†…å­˜çš„æœ€å³è¾¹ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå…¶å®ƒå˜é‡ä¾æ¬¡ä»å·¦å¾€å³æ’ã€‚</p>
<p>ä½¿ç”¨ä½åŸŸå¢åŠ å¯è¯»æ€§ã€‚å®šä¹‰ç»“æ„ä½“ _tallRichHandsomeï¼Œæˆå‘˜å˜é‡ tallï¼Œå¹¶é€šè¿‡â€œ<code>:</code>â€è®¾ç½® tall åœ¨å†…å­˜ä¸­åªå 1ä½ã€‚<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">char</span> tall : <span class="number">1</span>; <span class="comment">//1ä½</span></div><div class="line">    &#125; _tallRichHandsome; <span class="comment">//1ä¸ªå­—èŠ‚</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall &#123;</div><div class="line">    _tallRichHandsome.tall = tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="built_in">BOOL</span> ret = _tallRichHandsome.tall;</div><div class="line">    <span class="keyword">return</span> ret; <span class="comment">//æ–­ç‚¹2</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tallï¼š%d"</span>, person.isTall); <span class="comment">//æ–­ç‚¹1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">-1</span></div></pre></td></tr></table></figure></p>
<p>åœ¨æ–­ç‚¹1å¤„æŸ¥çœ‹ _tallRichHandsome çš„å†…å­˜ï¼š<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp;(person-&gt;_tallRichHandsome)</div><div class="line">((anonymous struct) *) $0 = 0x0000000100493d98</div><div class="line">(lldb) x 0x0000000100493d98</div><div class="line">0x100493d98:<span class="number"> 01 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 2d 5b 4e<span class="number"> 53 </span>54<span class="number"> 61 </span>62<span class="number"> 50 </span> ........-[NSTabP</div><div class="line">0x100493da8:<span class="number"> 69 </span>63 6b<span class="number"> 65 </span>72<span class="number"> 56 </span>69<span class="number"> 65 </span>77<span class="number"> 43 </span>6f 6e<span class="number"> 74 </span>72 6f 6c  ickerViewControl</div></pre></td></tr></table></figure></p>
<p>å†…å­˜ä¸­çš„â€œ01â€æ˜¯åå…­è¿›åˆ¶çš„ï¼Œè½¬æˆäºŒè¿›åˆ¶å°±æ˜¯<code>0b 0000 0001</code>ã€‚å³ tallï¼šYESã€‚</p>
<p>åœ¨æ–­ç‚¹2å¤„æŸ¥çœ‹ ret çš„å†…å­˜ï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp; ret</div><div class="line">(BOOL *) <span class="variable">$0</span> = 0x00007ffeefbff4ff 255</div><div class="line">(lldb) x 0x00007ffeefbff4ff</div><div class="line">0x7ffeefbff4ff: ff b1 4e cb 5e ff 7f 00 00 90 81 16 03 01 00 00  <span class="built_in">..</span>N.^<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</div><div class="line">0x7ffeefbff50f: 00 50 f5 bf ef fe 7f 00 00 90 0c 00 00 01 00 00  .P<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></div></pre></td></tr></table></figure></p>
<p>å†…å­˜ä¸­çš„â€œffâ€æ˜¯åå…­è¿›åˆ¶çš„ï¼ˆ0xFFï¼‰ï¼Œè½¬æˆäºŒè¿›åˆ¶å°±æ˜¯<code>0b11111111</code>ï¼Œè½¬æˆåè¿›åˆ¶æ˜¯255ï¼ˆæ— ç¬¦å·ï¼‰æˆ–-1ï¼ˆæœ‰ç¬¦å·ï¼‰ã€‚è¿™æ˜¯å› ä¸º tall åŸæœ¬æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå³ tallï¼š0b1ï¼Œè€Œè¿”å›å€¼è¦æ±‚çš„æ˜¯ BOOL ç±»å‹çš„å€¼ï¼ˆ8ä½ï¼š<code>0b00000000</code>ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿”å›æ—¶ tall å¼ºè½¬æˆäº†ä¸€ä¸ª8ä½çš„å€¼ï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0b1</span> -&gt; <span class="number">0b</span> <span class="number">1111</span> <span class="number">1111</span>ï¼ˆäºŒè¿›åˆ¶ï¼‰ //<span class="number">0xff</span>ï¼ˆåå…­è¿›åˆ¶ï¼‰</div></pre></td></tr></table></figure></p>
<p>å› ä¸ºåœ¨ç³»ç»Ÿä¸­æ•´æ•°æ˜¯ä»¥è¡¥ç å½¢å¼å­˜æ”¾çš„ï¼Œæ‰€ä»¥è¦æƒ³æ‰¾åˆ°æ‰“å°ç»“æœä¸ºâ€œ-1â€çš„åŸå› éœ€è¦å…ˆç®—å‡º <code>0b11111111</code> çš„åŸç ã€‚</p>
<ul>
<li>è¡¥ç æ±‚åŸç <br>å¦‚æœè¡¥ç çš„ç¬¦å·ä½ä¸ºâ€œ0â€ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œå…¶åŸç å°±æ˜¯è¡¥ç ã€‚<br>å¦‚æœè¡¥ç çš„ç¬¦å·ä½ä¸ºâ€œ1â€ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œé‚£ä¹ˆæ±‚ç»™å®šçš„è¿™ä¸ªè¡¥ç çš„è¡¥ç å°±æ˜¯è¦æ±‚çš„åŸç ã€‚  </li>
</ul>
<p>å› ä¸º tall æ˜¯ä¸€ä¸ª char ç±»å‹çš„æ•´å‹å˜é‡ï¼Œæ˜¯æœ‰ç¬¦å·çš„ï¼ˆLLVMï¼‰ï¼Œæ‰€ä»¥æ­¤æ—¶çš„ <code>0b11111111</code> æ˜¯æœ‰ç¬¦å·çš„ã€‚</p>
<p>å› ä¸º <code>0b11111111</code> çš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ä¸ºâ€œ1â€ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œæ‰€ä»¥è¯¥ä½ä¸å˜ï¼Œä»ä¸ºâ€œ1â€ã€‚å…¶ä½™ä¸ƒä½å–ååä¸º <code>0b10000000</code>ï¼›å†åŠ 1ï¼Œæ‰€ä»¥æ˜¯ <code>0b10000001</code>ï¼Œåè¿›åˆ¶å°±æ˜¯ -1ã€‚æ‰€ä»¥ tall åœ¨è®¾ç½®ä¸º YES æ—¶ï¼Œæ‰“å°ç»“æœæ˜¯ -1ã€‚</p>
<p>å¦‚æœå°† tall è®¾ç½®ä¸º NO çš„è¯ï¼Œ_tallRichHandsome å’Œ ret çš„å†…å­˜éƒ½æ˜¯ <code>0b00000000</code>ã€‚<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp;(person-&gt;_tallRichHandsome)</div><div class="line">((anonymous struct) *) $1 = 0x0000000102c6fb28</div><div class="line">(lldb) x 0x0000000102c6fb28</div><div class="line">0x102c6fb28:<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 2d 5b 4e<span class="number"> 53 </span>56<span class="number"> 69 </span>62<span class="number"> 72 </span> ........-[NSVibr</div><div class="line">0x102c6fb38:<span class="number"> 61 </span>6e<span class="number"> 74 </span>53<span class="number"> 70 </span>6c<span class="number"> 69 </span>74<span class="number"> 44 </span>69<span class="number"> 76 </span>69<span class="number"> 64 </span>65<span class="number"> 72 </span>56  antSplitDividerV</div><div class="line"></div><div class="line">(lldb) p/x &amp; ret</div><div class="line">(BOOL *) $0 = 0x00007ffeefbff4ff NO</div><div class="line">(lldb) x 0x00007ffeefbff4ff</div><div class="line">0x7ffeefbff4ff:<span class="number"> 00 </span>b1 4e cb 5e ff 7f<span class="number"> 00 </span>00<span class="number"> 20 </span>fb c6<span class="number"> 02 </span>01<span class="number"> 00 </span>00  ..N.^.... ......</div><div class="line">0x7ffeefbff50f:<span class="number"> 00 </span>50 f5 bf ef fe 7f<span class="number"> 00 </span>00 8d 0c<span class="number"> 00 </span>00<span class="number"> 01 </span>00<span class="number"> 00 </span> .P..............</div></pre></td></tr></table></figure></p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨å¯¹ tall è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šæœ‰ä¸¤ä¸ªè¿”å›å€¼â€œ-1â€å’Œâ€œ0â€ã€‚ä¸ºäº†ä¿è¯è¿”å›çš„ç»“æœæ­£ç¡®ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šé¢ğŸ‘†æåˆ°è¿‡çš„å–åä¸¤æ¬¡<code>!!</code>ã€‚</p>
<p>æœ€ç»ˆå®ç°ï¼š<br>å®šä¹‰ç»“æ„ä½“ _tallRichHandsomeï¼ŒåŒæ—¶å®šä¹‰æˆå‘˜å˜é‡ tallã€rich å’Œ handsomeï¼Œå¹¶é€šè¿‡â€œ:â€è®¾ç½®å¥¹ä»¬åœ¨å†…å­˜ä¸­åªå 1ä½ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">char</span> tall : <span class="number">1</span>; <span class="comment">//åªå 1ä½</span></div><div class="line">        <span class="keyword">char</span> rich : <span class="number">1</span>;</div><div class="line">        <span class="keyword">char</span> handsome : <span class="number">1</span>;</div><div class="line">    &#125; _tallRichHandsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall &#123;</div><div class="line">    _tallRichHandsome.tall = tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(<span class="built_in">BOOL</span>)rich &#123;</div><div class="line">    _tallRichHandsome.rich = rich;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(<span class="built_in">BOOL</span>)handsome &#123;</div><div class="line">    _tallRichHandsome.handsome = handsome;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.rich;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.handsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        person.rich = <span class="literal">NO</span>;</div><div class="line">        person.handsome = <span class="literal">YES</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tallï¼š%d, richï¼š%d, handsomeï¼š%d"</span>, person.isTall, person.isRich, person.isHandsome); <span class="comment">//æ–­ç‚¹1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">1</span>, richï¼š<span class="number">0</span>, handsomeï¼š<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>_tallRichHandsome çš„äºŒçº§åˆ¶å°±æ˜¯<code>0b00000111</code>ï¼Œtall æ˜¯ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡åœ¨æœ€å³è¾¹ï¼Œç„¶åä¾æ¬¡ä»å·¦å¾€å³æ’ã€‚</p>
<h2 id="å…±ç”¨ä½“ï¼ˆunionï¼‰"><a href="#å…±ç”¨ä½“ï¼ˆunionï¼‰" class="headerlink" title="å…±ç”¨ä½“ï¼ˆunionï¼‰"></a>å…±ç”¨ä½“ï¼ˆunionï¼‰</h2><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><p>struct ç»“æ„ä½“é‡Œçš„æˆå‘˜å˜é‡å„è‡ªæ‹¥æœ‰ä¸€å—å†…å­˜ï¼Œå•ç‹¬å­˜åœ¨ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime01.png" alt="Runtime01"></p>
<p>å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ Dateï¼Œå†…éƒ¨æœ‰ä¸‰ä¸ª int ç±»å‹çš„æˆå‘˜å˜é‡ yearã€month å’Œ dayï¼š<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct Date &#123;</div><div class="line">    <span class="built_in">int</span> <span class="built_in">year</span>;  <span class="comment">//4ä¸ªå­—èŠ‚</span></div><div class="line">    <span class="built_in">int</span> <span class="built_in">month</span>; <span class="comment">//4ä¸ªå­—èŠ‚</span></div><div class="line">    <span class="built_in">int</span> <span class="built_in">day</span>;   <span class="comment">//4ä¸ªå­—èŠ‚</span></div><div class="line">&#125;; <span class="comment">//12ä¸ªå­—èŠ‚</span></div><div class="line"></div><div class="line"><span class="built_in">int</span> main(<span class="built_in">int</span> argc, <span class="keyword">const</span> <span class="built_in">char</span> * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="comment">//struct Date date = &#123;2020, 6, 17&#125;;</span></div><div class="line">        struct Date date;</div><div class="line">        date.<span class="built_in">year</span> = <span class="number">2020</span>;</div><div class="line">        date.<span class="built_in">month</span> = <span class="number">6</span>;</div><div class="line">        date.<span class="built_in">day</span> = <span class="number">17</span>;</div><div class="line">        NSLog(@<span class="string">"yearï¼š%d, monthï¼š%d, dayï¼š%d"</span>, date.<span class="built_in">year</span>, date.<span class="built_in">month</span>, date.<span class="built_in">day</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>ï¼š<span class="number">2020</span>, <span class="built_in">month</span>ï¼š<span class="number">6</span>, <span class="built_in">day</span>ï¼š<span class="number">17</span></div></pre></td></tr></table></figure></p>
<p>å› ä¸ºä¸‰ä¸ªå˜é‡å„è‡ªæ‹¥æœ‰è‡ªå·±çš„å†…å­˜ï¼Œæ‰€ä»¥æ‰“å°ç»“æœå„ä¸ç›¸åŒã€‚</p>
<h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><p>union å…±ç”¨ä½“é‡Œçš„æˆå‘˜å˜é‡å…±ç”¨ä¸€å—å†…å­˜ï¼Œå…±ç”¨ä½“çš„å†…å­˜å¤§å°ä»¥æˆå‘˜å˜é‡çš„æœ€å¤§å†…å­˜ä¸ºå‡†ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime02.png" alt="Runtime02"></p>
<p>å®šä¹‰å…±ç”¨ä½“ Dateï¼Œå†…éƒ¨æœ‰ä¸‰ä¸ª int ç±»å‹çš„å˜é‡ yearã€month å’Œ dayï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">union</span> <span class="title">Date</span> &#123;</span></div><div class="line">    int year;  <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line">    int month; <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line">    int day;   <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line">&#125;; <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="class"><span class="keyword">union</span> <span class="title">Date</span> <span class="title">date</span>;</span></div><div class="line">        date.year = <span class="number">2020</span>;</div><div class="line">        NSLog(@<span class="string">"yearï¼š%d, monthï¼š%d, dayï¼š%d"</span>, date.year, date.month, date.day);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>ï¼š<span class="number">2020</span>, <span class="built_in">month</span>ï¼š<span class="number">2020</span>, <span class="built_in">day</span>ï¼š<span class="number">2020</span></div></pre></td></tr></table></figure></p>
<p>å› ä¸ºä¸‰ä¸ªå˜é‡å…±ç”¨ä¸€å—å†…å­˜ï¼Œæ‰€ä»¥ä¸‰ä¸ªå˜é‡è®¿é—®çš„å†…å­˜æ˜¯åŒä¸€å—å†…å­˜åœ°å€ã€‚</p>
<p>å®šä¹‰å…±ç”¨ä½“ Dateï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª int ç±»å‹çš„å˜é‡ year å’Œä¸€ä¸ª char ç±»å‹çš„å˜é‡ monthï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">union</span> <span class="title">Date</span> &#123;</span></div><div class="line">    int year;   <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line">    char month; <span class="regexp">//</span><span class="number">1</span>ä¸ªå­—èŠ‚</div><div class="line">&#125;; <span class="regexp">//</span><span class="number">4</span>ä¸ªå­—èŠ‚</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="class"><span class="keyword">union</span> <span class="title">Date</span> <span class="title">date</span>;</span></div><div class="line">        date.year = <span class="number">2020</span>;</div><div class="line">        NSLog(@<span class="string">"yearï¼š%d, monthï¼š%d"</span>, date.year, date.month);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>ï¼š<span class="number">2020</span>, <span class="built_in">month</span>ï¼š<span class="number">2020</span></div></pre></td></tr></table></figure></p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>å°†ä½è¿ç®—å’Œä½åŸŸç»“åˆåœ¨ä¸€èµ·å®šä¹‰ä¸€ä¸ªå…±ç”¨ä½“ï¼Œç”¨ä½è¿ç®—è¯»å–/å†™å…¥å˜é‡çš„å€¼ï¼Œç”¨ä½åŸŸå¢åŠ å¯è¯»æ€§ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (1&lt;&lt;1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (1&lt;&lt;2)</span></div><div class="line"></div><div class="line">@<span class="function">interface <span class="title">Person</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">char</span> bits;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            <span class="keyword">char</span> tall : <span class="number">1</span>;</div><div class="line">            <span class="keyword">char</span> rich : <span class="number">1</span>;</div><div class="line">            <span class="keyword">char</span> handsome : <span class="number">1</span>;</div><div class="line">        &#125;;</div><div class="line">    &#125;_tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Person</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall &#123;</div><div class="line">    <span class="keyword">if</span> (tall) &#123;</div><div class="line">        _tallRichHandsome.bits |= TallMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~TallMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich &#123;</div><div class="line">    <span class="keyword">if</span> (rich) &#123;</div><div class="line">        _tallRichHandsome.bits |= RichMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~RichMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome &#123;</div><div class="line">    <span class="keyword">if</span> (handsome) &#123;</div><div class="line">        _tallRichHandsome.bits |= HandsomeMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~HandsomeMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = NO;</div><div class="line">        person.rich = NO;</div><div class="line">        person.handsome = YES;</div><div class="line">        NSLog(@<span class="string">"tallï¼š%d, richï¼š%d, handsomeï¼š%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tallï¼š<span class="number">0</span>, richï¼š<span class="number">0</span>, handsomeï¼š<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œå®šä¹‰çš„ tallã€rich å’Œ handsome éƒ½æ˜¯å 1ä¸ªäºŒè¿›åˆ¶ä½çš„ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹å®ƒä»¬å äºŒè¿›åˆ¶ä½çš„ä¸ªæ•°ï¼Œbits ä¹Ÿè¦ä¿®æ”¹ä¸ºç›¸åº”çš„å®šä¹‰ï¼š</p>
<p>tallã€rich å’Œ handsome éƒ½æ˜¯å 4ä¸ªäºŒè¿›åˆ¶ä½ï¼Œé‚£ bits å°±éœ€è¦å®šä¹‰æˆ int ç±»å‹ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰ï¼Œæ©ç ä¹Ÿéœ€è¦å 4ä¸ªäºŒè¿›åˆ¶ä½ï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="comment">#define RichMask (1&lt;&lt;4)</span></div><div class="line"><span class="comment">#define HandsomeMask (1&lt;&lt;8)</span></div><div class="line"></div><div class="line">@interface Person()</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></div><div class="line">        int bits;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            char tall : <span class="number">4</span>;</div><div class="line">            char rich : <span class="number">4</span>;</div><div class="line">            char handsome : <span class="number">4</span>;</div><div class="line">        &#125;;</div><div class="line">    &#125;_tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@<span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>æ©ç ä¹Ÿå¯ä»¥å†™æˆï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">0</span>)</div><div class="line">#<span class="built_in">define</span> RichMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">4</span>)</div><div class="line">#<span class="built_in">define</span> HandsomeMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">8</span>)</div></pre></td></tr></table></figure></p>
<p>æˆ–è€…<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (15&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (15&lt;&lt;4)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (15&lt;&lt;8)</span></div></pre></td></tr></table></figure></p>
<h2 id="isa"><a href="#isa" class="headerlink" title="isa"></a>isa</h2><p>åœ¨æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> ä¸­æŸ¥æ‰¾ isa çš„å®šä¹‰ã€‚  </p>
<p>æ‰¾åˆ° OC å¯¹è±¡çš„ç»“æ„ä½“ objc_objectï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line">    </div><div class="line">    Â·Â·Â· <span class="comment">//çœç•¥ä¸€å †æ–¹æ³•</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="isa-t"><a href="#isa-t" class="headerlink" title="isa_t"></a>isa_t</h3><p>å¯ä»¥çœ‹åˆ° isa æ˜¯ä¸€ä¸ª isa_t ç±»å‹çš„å˜é‡ï¼ŒJump To Definition -&gt; isa_tï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">union</span> <span class="keyword">isa_t</span> &#123;</div><div class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</div><div class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    <span class="keyword">uintptr_t</span> bits;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ISA_BITFIELD)</span></div><div class="line">    <span class="comment">//ä½åŸŸ</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> </div><div class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></div><div class="line">    &#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>ä½åŸŸä¸­æ˜¯ä¸€ä¸ªå® ISA_BITFIELDï¼ŒISA_BITFIELD åœ¨ <code>__arm64__</code>ï¼ˆçœŸæœºï¼‰ å’Œ <code>__x86_64__</code>ï¼ˆmacç”µè„‘/æ¨¡æ‹Ÿå™¨ï¼‰ æ¶æ„æœ‰ä¸åŒçš„å®šä¹‰ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># <span class="meta-keyword">if</span> __arm64__ <span class="comment">//çœŸæœºä¸Šå¸‚ arm64</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                      \</span></div><div class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</div><div class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">19</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></div><div class="line"></div><div class="line"><span class="meta"># <span class="meta-keyword">elif</span> __x86_64__ <span class="comment">//æ¨¡æ‹Ÿå™¨æ˜¯ x86 æ¶æ„</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x00007ffffffffff8ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x001f800000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x001d800000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                        \</span></div><div class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">44</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/</span> \</div><div class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">8</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;56)</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;7)</span></div><div class="line"></div><div class="line"><span class="meta"># <span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">error</span> unknown architecture for packed isa</span></div><div class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>å°†å® <code>ISA_BITFIELD</code> æ›¿æ¢æ‰ï¼Œä¿ç•™çœŸæœºï¼ˆarm64ï¼‰ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„ isa_tï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime05.png" alt="Runtime05"></p>
<p> å› ä¸º isa æŒ‡é’ˆçš„å®šä¹‰åŒºåˆ† <code>__arm64__</code>ï¼ˆçœŸæœºï¼‰å’Œ <code>__x86_64__</code>ï¼ˆmac/æ¨¡æ‹Ÿå™¨ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ç”¨çœŸæœºè¿è¡Œé¡¹ç›®æ‰èƒ½çœ‹åˆ° <code>ISA_BITFIELD</code> æ­£ç¡®çš„æˆå‘˜å˜é‡çš„å€¼ï¼š<br> <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ person å¯¹è±¡çš„ isa æŒ‡é’ˆçš„å†…å­˜ï¼š<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x person-&gt;isa</div><div class="line">(<span class="keyword">Class</span>) $<span class="number">0</span> = <span class="number">0x1A100455641</span> Person</div></pre></td></tr></table></figure></p>
<p>è½¬æˆäºŒè¿›åˆ¶ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime04.png" alt="Runtime04"></p>
<h3 id="ä½åŸŸ-1"><a href="#ä½åŸŸ-1" class="headerlink" title="ä½åŸŸ"></a>ä½åŸŸ</h3><ul>
<li>nonpointer<br>0ï¼Œä»£è¡¨æ™®é€šçš„æŒ‡é’ˆï¼Œisa åªå­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€<br>1ï¼Œä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œisa ä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯</li>
<li>has_assoc<br>æ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>has_cxx_dtor<br>æ˜¯å¦æœ‰ C++ çš„ææ„å‡½æ•°ï¼ˆ.cxx_destructï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>shiftcls<br>å­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</li>
<li>magic<br>ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</li>
<li>weakly_referenced<br>æ˜¯å¦æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>deallocating<br>å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</li>
<li>extra_rc<br>é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å™¨å‡1</li>
<li>has_sidetable_rc<br>å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨ isa ä¸­ï¼Œå¦‚æœä¸º1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå« SideTable çš„ç±»çš„å±æ€§ä¸­</li>
</ul>
<p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime06.png" alt="Runtime06"><br>nonpointerï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œåœ¨æœ€ä½ä½ä¸º1ï¼ˆç¬¬0ä½ï¼‰ã€‚<br>has_assocï¼ˆhas_associateï¼‰ï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆç¬¬1ä½ï¼‰ã€‚<br>has_cxx_dtorï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆç¬¬2ä½ï¼‰ã€‚<br>shiftclsï¼šå 33ä¸ªäºŒè¿›åˆ¶ä½ï¼ˆä»ç¬¬3ä½åˆ°ç¬¬35ä½ï¼‰ã€‚<br>magicï¼šå 6ä¸ªäºŒè¿›åˆ¶ä½ï¼ˆä»ç¬¬36ä½åˆ°ç¬¬41ä½ï¼‰ã€‚magic çš„å€¼å¯ä»¥ä»å® <code>ISA_MAGIC_VALUE</code> çœ‹åˆ°ï¼ˆ1aï¼‰ã€‚magic == 1a è¡¨ç¤ºåˆå§‹åŒ–æˆåŠŸã€‚<br>weakly_referencedï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆç¬¬42ä½ï¼‰ã€‚<br>deallocatingï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆç¬¬43ä½ï¼‰ã€‚<br>has_sidetable_rcï¼šå 1ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆç¬¬44ä½ï¼‰ã€‚<br>extra_rcï¼ˆextra_retain_countï¼‰ï¼šå 19ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸º0ï¼ˆä»ç¬¬45ä½åˆ°63ä½ï¼‰ã€‚</p>
<h4 id="has-assoc-å’Œ-weakly-referenced"><a href="#has-assoc-å’Œ-weakly-referenced" class="headerlink" title="has_assoc å’Œ weakly_referenced"></a>has_assoc å’Œ weakly_referenced</h4><p>has_assoc å’Œ weakly_referenced æ ‡è®°çš„æ˜¯æ›¾ç»æ˜¯å¦è®¾ç½®è¿‡ï¼Œå¦‚æœæ·»åŠ äº† __weak å’Œå…³è”å¯¹è±¡å†ç§»é™¤æ‰ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å€¼ä¾ç„¶æ˜¯1ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    __<span class="keyword">weak</span> Person *weakPerson = person;</div><div class="line">    weakPerson = <span class="literal">nil</span>;</div><div class="line">    objc_setAssociatedObject(person, <span class="string">@"name"</span>, <span class="string">@"Tom"</span>, OBJC_ASSOCIATION_COPY_NONATOMIC); <span class="comment">//æ·»åŠ å…³è”å¯¹è±¡</span></div><div class="line">    objc_setAssociatedObject(person, <span class="string">@"name"</span>, <span class="literal">nil</span>, OBJC_ASSOCIATION_COPY_NONATOMIC); <span class="comment">//ç§»é™¤å…³è”å¯¹è±¡</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹å†…å­˜ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime07.png" alt="Runtime07"></p>
<h4 id="å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«"><a href="#å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«" class="headerlink" title="å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«"></a>å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</h4><p>å¦‚æœ has_assocã€has_cxx_dtor å’Œ weakly_referenced ä¸º0ï¼Œå³æ²¡æœ‰æ·»åŠ è¿‡å…³è”å¯¹è±¡ã€æ²¡æœ‰ææ„å‡½æ•°å’Œæ²¡æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œä¼šè®©å®ä¾‹å¯¹è±¡çš„é‡Šæ”¾å˜å¾—æ›´å¿«ã€‚è¿™ç‚¹å¯ä»¥ä»æºç é‡Œçœ‹å‡ºæ¥ã€‚  </p>
<p>é”€æ¯å®åˆ—å¯¹è±¡çš„æ–¹æ³• objc_destructInstanceï¼š<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>objc_destructInstance</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Destroys </span>an<span class="markdown"> instance without freeing memory. </span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Calls C++ destructors.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Calls ARC ivar cleanup.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Removes associative references.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Returns <span class="code">`obj`</span>. Does nothing if <span class="code">`obj`</span> is nil.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></div><div class="line"><span class="keyword">void</span> *objc_destructInstance(id obj) </div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj) &#123;</div><div class="line">        <span class="comment">// Read all of the flags at once for performance.</span></div><div class="line">        <span class="built_in">bool</span> cxx = obj-&gt;hasCxxDtor();</div><div class="line">        <span class="built_in">bool</span> assoc = obj-&gt;hasAssociatedObjects();</div><div class="line"></div><div class="line">        <span class="comment">// This order is important.</span></div><div class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);</div><div class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</div><div class="line">        obj-&gt;clearDeallocating();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨é”€æ¯å®ä¾‹å¯¹è±¡çš„æ–¹æ³•é‡Œï¼Œåˆ¤æ–­äº†æœ‰æ²¡æœ‰ææ„å‡½æ•°å’Œå…³è”å¯¹è±¡ï¼Œå¦‚æœæœ‰çš„è¯éœ€è¦å…ˆå¤„ç†ææ„å‡½æ•°å’Œå…³è”å¯¹è±¡ã€‚</p>
<p>Jump To Definition -&gt; clearDeallocatingï¼š<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">inline void </div><div class="line">objc_object::clearDeallocating()</div><div class="line">&#123;</div><div class="line">   <span class="built_in"> if </span>(slowpath(!isa.nonpointer)) &#123;</div><div class="line">        // Slow path for raw pointer isa.</div><div class="line">        sidetable_clearDeallocating();</div><div class="line">    &#125;</div><div class="line">    else<span class="built_in"> if </span>(slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</div><div class="line">        // Slow path for non-pointer isa with weak refs<span class="built_in"> and/or </span>side table data.</div><div class="line">        clearDeallocating_slow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    assert(!sidetable_present());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Jump To Definition -&gt; clearDeallocating_slowï¼š<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Slow path of clearDeallocating() </span></div><div class="line"><span class="comment">// for objects with nonpointer isa</span></div><div class="line"><span class="comment">// that were ever weakly referenced </span></div><div class="line"><span class="comment">// or whose retain count ever overflowed to the side table.</span></div><div class="line">NEVER_INLINE <span class="keyword">void</span></div><div class="line">objc_object::clearDeallocating_slow()</div><div class="line">&#123;</div><div class="line">    ASSERT(isa<span class="variable">.nonpointer</span>  &amp;&amp;  (isa<span class="variable">.weakly_referenced</span> || isa<span class="variable">.has_sidetable_rc</span>));</div><div class="line"></div><div class="line">    SideTable&amp; <span class="keyword">table</span> = SideTables()[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">table</span><span class="variable">.lock</span>();</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.weakly_referenced</span>) &#123;</div><div class="line">        weak_clear_no_lock(&amp;<span class="keyword">table</span><span class="variable">.weak_table</span>, (id)<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.has_sidetable_rc</span>) &#123;</div><div class="line">        <span class="keyword">table</span><span class="variable">.refcnts</span><span class="variable">.erase</span>(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">table</span><span class="variable">.unlock</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ <code>clearDeallocating()</code> æ–¹æ³•é‡Œåˆ¤æ–­äº†æ˜¯å¦æœ‰å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œå¦‚æœæœ‰çš„è¯éœ€è¦åœ¨ <code>clearDeallocating_slow()</code> æ–¹æ³•é‡Œå¤„ç† weakly_referencedã€‚</p>
<h3 id="ISA-MASK"><a href="#ISA-MASK" class="headerlink" title="ISA_MASK"></a>ISA_MASK</h3><p>é€šè¿‡ <code>isa &amp; ISA_MASK</code> èƒ½å¤Ÿå–å‡º shiftcls çš„å€¼ï¼ˆClassã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯ï¼‰ã€‚å› ä¸º <code>ISA_MASK</code> æœ€åé¢ä¸‰ä½éƒ½æ˜¯0ï¼Œæ‰€ä»¥è·å–åˆ°çš„ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€çš„æœ€åä¸‰ä½è‚¯å®šä¹Ÿä¸º0ã€‚<code>ISA_MASK</code>ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime03.png" alt="Runtime03"></p>
<p>è¯æ˜ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> ViewController()</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> ViewController</div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    <span class="selector-attr">[super viewDidLoad]</span>;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, [ViewController class]);</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, object_getClass([ViewController class]));</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, [Person class]);</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, object_getClass([Person class]));</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>x<span class="number">1007d5550</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d5578</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d5618</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d55f0</span></div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœçš„æœ€åä¸€ä½éƒ½æ˜¯â€8â€œæˆ–â€0â€œï¼Œå³â€<code>1000</code>â€œæˆ–â€<code>0000</code>â€œã€‚æ‰€ä»¥ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€çš„æœ€åä¸‰ä¸ºä¸º0ã€‚</p>
<h2 id="ä½è¿ç®—è¡¥å……"><a href="#ä½è¿ç®—è¡¥å……" class="headerlink" title="ä½è¿ç®—è¡¥å……"></a>ä½è¿ç®—è¡¥å……</h2><p>ç”¨å·¦ç§»å®šä¹‰æšä¸¾çš„æˆå‘˜å˜é‡ï¼Œç”¨â€æˆ–â€œè¿ç®—ä¼ å…¥å¤šä¸ªå€¼ï¼Œç”¨â€ä¸â€œè¿ç®—è·å–ä¼ å…¥çš„éƒ½æœ‰å“ªäº›å€¼ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</div><div class="line">    OptionsOne = <span class="number">1</span>&lt;&lt;<span class="number">0</span>,</div><div class="line">    OptionsTwo = <span class="number">1</span>&lt;&lt;<span class="number">1</span>,</div><div class="line">    OptionsThree = <span class="number">1</span>&lt;&lt;<span class="number">2</span>,</div><div class="line">    OptionsFour = <span class="number">1</span>&lt;&lt;<span class="number">3</span></div><div class="line">&#125; Options;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)setOptions:(Options)option &#123;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsOne) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsOne"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsTwo) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsTwo"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsThree) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsThree"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsFour) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsFour"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    [<span class="keyword">self</span> setOptions:OptionsOne | OptionsTwo | OptionsFour];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">OptionsOne</span></div><div class="line"><span class="attribute">OptionsTwo</span></div><div class="line"><span class="attribute">OptionsFour</span></div></pre></td></tr></table></figure></p>
<h1 id="Class-çš„ç»“æ„"><a href="#Class-çš„ç»“æ„" class="headerlink" title="Class çš„ç»“æ„"></a>Class çš„ç»“æ„</h1><p>ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡éƒ½æ˜¯ Class ç±»å‹çš„å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å¯¹è±¡ã€‚</p>
<p>åœ¨æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> ä¸­æŸ¥æ‰¾ objc_class çš„å®šä¹‰ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line"></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</div><div class="line">    <span class="comment">// Class ISA;</span></div><div class="line">    Class superclass;</div><div class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></div><div class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></div><div class="line"></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç»“æ„å›¾ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime08.png" alt="Runtime08"></p>
<p>ç»“æ„å›¾é‡Œå‡ºç°çš„ <code>rw</code>å’Œ <code>ro</code> åˆ†åˆ«è¡¨ç¤º readwrite å’Œ readonlyã€‚</p>
<h2 id="class-rw-t"><a href="#class-rw-t" class="headerlink" title="class_rw_t"></a>class_rw_t</h2><p>class_rw_t é‡Œé¢çš„ methodsã€propertiesã€protocols æ˜¯äºŒç»´æ•°ç»„ï¼Œæ˜¯å¯è¯»å¯å†™çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ã€åˆ†ç±»çš„å†…å®¹ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_ext_t</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</div><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div><div class="line">    <span class="keyword">char</span> *demangledName;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">    explicit_atomic&lt;<span class="keyword">uintptr_t</span>&gt; ro_or_rw_ext;</div><div class="line"></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime09.png" alt="Runtime09"></p>
<p>ç±»çš„ä¿¡æ¯åœ¨ç¼–è¯‘æ—¶æ˜¯æ”¾åœ¨ class_ro_t é‡Œçš„ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œä¼šå°†ç±»çš„ class_ro_t é‡Œçš„ä¿¡æ¯å’Œåˆ†ç±»çš„ä¿¡æ¯ï¼ˆæ³¨æ„é¡ºåºï¼‰åˆå¹¶èµ·æ¥æ”¾åˆ° class_rw_t é‡Œã€‚æ‰¾åˆ°åˆå¹¶åˆ†ç±»ä¿¡æ¯çš„æ–¹æ³• <code>realizeClassWithoutSwift()</code>ï¼š<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">static Class realizeClassWithoutSwift(Class cls, Class previously)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    class_rw_t *rw;</div><div class="line">    Class supercls;</div><div class="line">    Class metacls;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!cls) return <span class="literal">nil</span>;</div><div class="line">    <span class="function"><span class="title">if</span> (cls-&gt;</span>isRealized()) return cls;</div><div class="line">    ASSERT(cls == remapClass(cls));</div><div class="line"></div><div class="line">    <span class="comment">// fixme verify class is not in an un-dlopened part of the shared cache?</span></div><div class="line"></div><div class="line">    <span class="function"><span class="title">auto</span> ro = (const class_ro_t *)cls-&gt;</span><span class="keyword">data</span>(); <span class="comment">//å–å‡ºç±»ä¿¡æ¯ ro</span></div><div class="line">    <span class="function"><span class="title">auto</span> isMeta = ro-&gt;</span>flags &amp; RO_META;</div><div class="line">    <span class="function"><span class="title">if</span> (ro-&gt;</span>flags &amp; RO_FUTURE) &#123;</div><div class="line">        <span class="comment">// This was a future class. rw data is already allocated.</span></div><div class="line">        <span class="function"><span class="title">rw</span> = cls-&gt;</span><span class="keyword">data</span>();</div><div class="line">        <span class="function"><span class="title">ro</span> = cls-&gt;</span><span class="function"><span class="title">data</span>()-&gt;</span>ro();</div><div class="line">        ASSERT(!isMeta);</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Normal class. Allocate writeable class data.</span></div><div class="line">        rw = objc::zalloc&lt;class_rw_t&gt;(); <span class="comment">//åˆå§‹åŒ– rw</span></div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>set_ro(ro); <span class="comment">//æ·»åŠ ç±»ä¿¡æ¯ ro</span></div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>flags = RW_REALIZED|RW_REALIZING|isMeta;</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>setData(rw);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...<span class="comment">//ä¸€å †æ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="comment">// Attach categories</span></div><div class="line">    methodizeClass(cls, previously); <span class="comment">//æ·»åŠ åˆ†ç±»ä¿¡æ¯</span></div><div class="line"></div><div class="line">    return cls;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨å¤„ç†åˆ†ç±»çš„ä¿¡æ¯ä¹‹å‰ï¼Œå…ˆä»ç±»é‡Œå–å‡ºäº†ç±»ä¿¡æ¯ roï¼Œç„¶ååˆå§‹åŒ–äº† rwï¼Œå†å°† ro ä¿å­˜åˆ° rw é‡Œã€‚</p>
<h3 id="method-array-t"><a href="#method-array-t" class="headerlink" title="method_array_t"></a>method_array_t</h3><p>methods æ˜¯ç”¨ method_array_t å®šä¹‰çš„ï¼Œmethod_array_t æ˜¯ä¸€ä¸ª list_array_tt ç±»å‹çš„äºŒç»´æ•°ç»„ï¼Œmethod_array_t é‡Œå­˜å‚¨çš„æ˜¯æ•°ç»„ method_list_tï¼Œæ•°ç»„ method_list_t é‡Œå­˜å‚¨çš„æ˜¯ method_tï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">method_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">method_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">method_array_t</span>(<span class="keyword">method_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">method_list_t</span> * <span class="function"><span class="keyword">const</span> *<span class="title">beginCategoryMethodLists</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> beginLists();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">method_list_t</span> * <span class="function"><span class="keyword">const</span> *<span class="title">endCategoryMethodLists</span><span class="params">(Class cls)</span> <span class="keyword">const</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">method_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">method_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å¦‚æœæ˜¯ç±»å¯¹è±¡ï¼Œmethods é‡Œä¿å­˜çš„æ˜¯å¯¹è±¡æ–¹æ³•ï¼Œå¦‚æœæ˜¯å…ƒç±»å¯¹è±¡ï¼Œmethods é‡Œä¿å­˜çš„æ˜¯ç±»æ–¹æ³•ã€‚  </p>
<h3 id="property-array-t"><a href="#property-array-t" class="headerlink" title="property_array_t"></a>property_array_t</h3><p>properties æ˜¯ç”¨ property_array_t å®šä¹‰çš„ï¼Œproperty_array_t æ˜¯ä¸€ä¸ª list_array_tt ç±»å‹çš„äºŒç»´æ•°ç»„ï¼Œproperty_array_t é‡Œå­˜å‚¨çš„æ˜¯æ•°ç»„ property_tï¼Œæ•°ç»„ property_t å­˜å‚¨çš„æ˜¯ property_tï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">property_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">property_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">property_array_t</span>(<span class="keyword">property_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">property_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">property_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="protocol-array-t"><a href="#protocol-array-t" class="headerlink" title="protocol_array_t"></a>protocol_array_t</h3><p>protocols æ˜¯ç”¨ protocol_array_t å®šä¹‰çš„ï¼Œprotocol_array_t æ˜¯ä¸€ä¸ª list_array_tt ç±»å‹çš„äºŒç»´æ•°ç»„ï¼Œprotocol_array_t é‡Œå­˜å‚¨çš„æ˜¯æ•°ç»„ protocol_ref_tï¼Œæ•°ç»„ protocol_ref_t å­˜å‚¨çš„æ˜¯ protocol_ref_tï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">protocol_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">protocol_ref_t</span>, <span class="keyword">protocol_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">protocol_ref_t</span>, <span class="keyword">protocol_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">protocol_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">protocol_array_t</span>(<span class="keyword">protocol_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protocol_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">protocol_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="class-ro-t"><a href="#class-ro-t" class="headerlink" title="class_ro_t"></a>class_ro_t</h2><p>class_ro_t é‡Œé¢çš„ baseMethodListã€baseProtocolsã€ivarsã€baseProperties æ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ˜¯åªè¯»çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹å†…å®¹ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</div><div class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</div><div class="line">    </div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">    <span class="keyword">property_list_t</span> *baseProperties;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime10.png" alt="Runtime10"></p>
<h3 id="method-list-tã€ivar-list-t-å’Œ-property-list-t"><a href="#method-list-tã€ivar-list-t-å’Œ-property-list-t" class="headerlink" title="method_list_tã€ivar_list_t å’Œ property_list_t"></a>method_list_tã€ivar_list_t å’Œ property_list_t</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>, <span class="number">0x3</span>&gt; &#123;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isUniqued</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isFixedUp</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setFixedUp</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">uint32_t</span> indexOfMethod(<span class="keyword">const</span> <span class="keyword">method_t</span> *meth) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">uint32_t</span> i = </div><div class="line">            (<span class="keyword">uint32_t</span>)(((<span class="keyword">uintptr_t</span>)meth - (<span class="keyword">uintptr_t</span>)<span class="keyword">this</span>) / entsize());</div><div class="line">        ASSERT(i &lt; count);</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ivar_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">ivar_t</span>, <span class="keyword">ivar_list_t</span>, <span class="number">0</span>&gt; &#123;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">containsIvar</span><span class="params">(Ivar ivar)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (ivar &gt;= (Ivar)&amp;*begin()  &amp;&amp;  ivar &lt; (Ivar)&amp;*end());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>, <span class="number">0</span>&gt; &#123;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="method-t"><a href="#method-t" class="headerlink" title="method_t"></a>method_t</h2><p>method_t æ˜¯å¯¹æ–¹æ³•\å‡½æ•°çš„å°è£…ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> MethodListIMP = IMP;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_t</span> &#123;</span></div><div class="line">    SEL name;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types;</div><div class="line">    MethodListIMP imp;</div><div class="line"></div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime11.png" alt="Runtime11"></p>
<h3 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h3><p><code>IMP</code> ä»£è¡¨å‡½æ•°çš„å…·ä½“å®ç°ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime12.png" alt="Runtime12"></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__); <span class="comment">//æ–­ç‚¹2</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    </div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    </div><div class="line">    [person test]; <span class="comment">//æ–­ç‚¹1</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ–­ç‚¹1æ‰“å° impï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime17.png" alt="Runtime17"></p>
<p>æ–­ç‚¹2æŸ¥çœ‹ <code>-(void)test</code> çš„å†…å­˜ï¼ˆé€‰æ‹© Debug -&gt; Debug Workflow -&gt; Always Show Disassemblyï¼‰ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime18.png" alt="Runtime10"></p>
<p>ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œimp æŒ‡å‘çš„å†…å­˜åœ°å€å°±æ˜¯ <code>-(void)test</code> æ–¹æ³•çš„å†…å­˜åœ°å€ã€‚</p>
<h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><p><code>SEL</code> ä»£è¡¨æ–¹æ³•\å‡½æ•°åï¼Œä¸€èˆ¬å«åšé€‰æ‹©å™¨ï¼Œåº•å±‚ç»“æ„è·Ÿ <code>char *</code> ç±»ä¼¼ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime13.png" alt="Runtime13"></p>
<ul>
<li>å¯ä»¥é€šè¿‡ <code>@selector()</code> å’Œ <code>sel_registerName()</code> è·å¾—ã€‚</li>
<li>å¯ä»¥é€šè¿‡ <code>sel_getName()</code> å’Œ <code>NSStringFromSelector()</code> è½¬æˆå­—ç¬¦ä¸²ã€‚</li>
<li>ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œæ‰€å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„</li>
</ul>
<p>ä¸‹é¢çš„ä»£ç éœ€è¦ç”¨åˆ° ClassInfo.hï¼Œå¹¶ä¸”éœ€è¦çœŸæœºè¿è¡Œï¼š<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">int main(<span class="name">int</span> argc, char * argv[]) &#123;</div><div class="line">    NSString * appDelegateClassName<span class="comment">;</span></div><div class="line">    @autoreleasepool &#123;</div><div class="line">        appDelegateClassName = NSStringFromClass([AppDelegate class])<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //SELï¼ˆ@selector()ï¼‰å°±æ˜¯å­—ç¬¦ä¸²</div><div class="line">    NSLog(@<span class="string">"%s, %s"</span>, <span class="string">"test"</span>, @selector(<span class="name">test</span>))<span class="comment">;</span></div><div class="line">    </div><div class="line">    //å¯ä»¥é€šè¿‡@selector()å’Œsel_registerName()è·å¾—</div><div class="line">    SEL sel1 = @selector(<span class="name">test</span>)<span class="comment">;</span></div><div class="line">    SEL sel2 = sel_registerName(<span class="string">"test"</span>)<span class="comment">;</span></div><div class="line">    NSLog(@<span class="string">"sel1ï¼š%s, sel2ï¼š%s"</span>, sel1, sel2)<span class="comment">;</span></div><div class="line">    </div><div class="line">    //å¯ä»¥é€šè¿‡sel_getName()å’ŒNSStringFromSelector()è½¬æˆå­—ç¬¦ä¸²</div><div class="line">    char *selString1 = sel_getName(sel1);</div><div class="line">    NSString *selString2 = NSStringFromSelector(<span class="name">sel2</span>)<span class="comment">;</span></div><div class="line">    NSLog(@<span class="string">"selString1ï¼š%s, selString2ï¼š%@"</span>, selString1, selString2)<span class="comment">;</span></div><div class="line">    </div><div class="line">    //ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œæ‰€å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„</div><div class="line">    NSLog(@<span class="string">"%p, %p, %p"</span>, @selector(<span class="name">test</span>), @selector(<span class="name">test</span>), sel_registerName(<span class="string">"test"</span>))<span class="comment">;</span></div><div class="line">    </div><div class="line">    return UIApplicationMain(<span class="name">argc</span>, argv, <span class="literal">nil</span>, appDelegateClassName)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test</span>, <span class="keyword">test</span></div><div class="line">sel1ï¼š<span class="keyword">test</span>, sel2ï¼š<span class="keyword">test</span></div><div class="line">selString1ï¼š<span class="keyword">test</span>, selString2ï¼š<span class="keyword">test</span></div><div class="line"><span class="number">0x7fff5281ed06</span>, <span class="number">0x7fff5281ed06</span>, <span class="number">0x7fff5281ed06</span></div></pre></td></tr></table></figure></p>
<h3 id="types"><a href="#types" class="headerlink" title="types"></a>types</h3><p>types åŒ…å«äº†å‡½æ•°è¿”å›å€¼ã€å‚æ•°ç¼–ç çš„å­—ç¬¦ä¸²ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime14.png" alt="Runtime14"></p>
<p>ä¸‹é¢çš„ä»£ç éœ€è¦ç”¨åˆ° ClassInfo.hï¼Œå¹¶ä¸”éœ€è¦çœŸæœºè¿è¡Œï¼Œå°† main.m æ”¹æˆ main.mmï¼š<br>ä¾‹1ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    </div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    [person test]; <span class="comment">//æ–­ç‚¹1</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ–­ç‚¹1å‡ºæ‰“å° typesï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime19.png" alt="Runtime19"><br>â€œv16@0:8â€ æ˜¯ç±»å‹ç¼–ç ï¼š<code>v</code>ï¼šè¿”å›å€¼ç±»å‹ voidï¼Œ<code>16</code>ï¼šå‚æ•°å çš„å­—èŠ‚æ•°ä¹‹å’Œï¼ˆidï¼ˆ8ä¸ªå­—èŠ‚ï¼‰ + SELï¼ˆ8ä¸ªå­—èŠ‚ï¼‰ï¼‰ï¼Œ<code>@</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ idï¼Œ<code>0</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°å†…å­˜çš„å¼€å§‹ä½ç½®ï¼Œ<code>:</code>ï¼šç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ SELï¼Œ<code>8</code>ï¼šç¬¬äºŒä¸ªå‚æ•°å†…å­˜çš„å¼€å§‹ä½ç½®ï¼ˆid å äº†8ä¸ªå­—èŠ‚ï¼‰ã€‚  </p>
<p>ä¸‹é¢çš„ä»£ç éœ€è¦ç”¨åˆ° ClassInfo.hï¼Œå¹¶ä¸”éœ€è¦çœŸæœºè¿è¡Œï¼Œå°† main.m æ”¹æˆ main.mmï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// v 16 @ 0 : 8</span></div><div class="line"><span class="comment">//- (void)test:(id)self _cmd:(SEL)_cmd</span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>ä¾‹2ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">int</span>)test:(<span class="keyword">int</span>)age height:(<span class="keyword">float</span>)height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">int</span>)test:(<span class="keyword">int</span>)age height:(<span class="keyword">float</span>)height &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    [person test:<span class="number">20</span> height:<span class="number">30</span>]; <span class="comment">//æ–­ç‚¹1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ–­ç‚¹1å‡ºæ‰“å° typesï¼šï¼š<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">P<span class="function"><span class="title">rinting</span> description of <span class="keyword">data</span>-&gt;</span><span class="function"><span class="title">methods</span>-&gt;</span>first.types:</div><div class="line">(const char *) types = <span class="number">0</span>x0000000100087d4d <span class="string">"i24@0:8i16f20"</span></div></pre></td></tr></table></figure></p>
<p>â€œi24@0:8i16f20â€ æ˜¯ç±»å‹ç¼–ç ï¼š<code>i</code>ï¼šèŒƒå›´å€¼ç±»å‹ intï¼Œ<code>24</code>ï¼šå‚æ•°å çš„å­—èŠ‚æ•°ä¹‹å’Œï¼ˆidï¼ˆ8ä¸ªå­—èŠ‚ï¼‰ + SELï¼ˆ8ä¸ªå­—èŠ‚ï¼‰+ intï¼ˆ4ä¸ªå­—èŠ‚ï¼‰+ floatï¼ˆ4ä¸ªå­—èŠ‚ï¼‰ï¼‰ï¼Œ<code>@</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ idï¼Œ<code>0</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°å†…å­˜çš„å¼€å§‹ä½ç½®ï¼Œ<code>:</code>ï¼šç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹ SELï¼Œ<code>8</code>ï¼šç¬¬äºŒä¸ªå‚æ•°å†…å­˜çš„å¼€å§‹ä½ç½®ï¼ˆid å äº†8ä¸ªå­—èŠ‚ï¼‰ï¼Œ<code>i</code>ï¼šç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹ intï¼Œ<code>16</code>ï¼šç¬¬ä¸‰ä¸ªå‚æ•°çš„å¼€å§‹ä½ç½®ï¼ˆid å äº†8ä¸ªå­—èŠ‚ + SEL å äº†8ä¸ªå­—èŠ‚ï¼‰ï¼Œ<code>f</code>ï¼šç¬¬å››ä¸ªå‚æ•°çš„ç±»å‹ floatï¼Œ<code>20</code>ï¼šç¬¬å››ä¸ªå‚æ•°çš„å¼€å§‹ä½ç½®ï¼ˆid å äº†8ä¸ªå­—èŠ‚ + SEL å äº†8ä¸ªå­—èŠ‚ + int å äº†4ä¸ªå­—èŠ‚ï¼‰ã€‚<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// i 24 @ 0 : 8 i 16 f 20</span></div><div class="line"><span class="comment">// int test:(id self, SEL _cmd, int age, float height)</span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="Type-Encoding"><a href="#Type-Encoding" class="headerlink" title="Type Encoding"></a>Type Encoding</h3><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">Type Encodings</a> æ˜¯ iOS ä¸­æä¾›çš„ä¸€ä¸ªå«åš @encode çš„æŒ‡ä»¤ï¼Œå¯ä»¥å°†å…·ä½“çš„ç±»å‹è¡¨ç¤ºæˆå­—ç¬¦ä¸²ç¼–ç ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime15.png" alt="Runtime15"></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"id == %sï¼ŒSEL == %s"</span>, <span class="keyword">@encode</span>(<span class="keyword">id</span>), <span class="keyword">@encode</span>(SEL));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">id</span> == @ï¼ŒSEL == :</div></pre></td></tr></table></figure></p>
<h2 id="æ–¹æ³•ç¼“å­˜"><a href="#æ–¹æ³•ç¼“å­˜" class="headerlink" title="æ–¹æ³•ç¼“å­˜"></a>æ–¹æ³•ç¼“å­˜</h2><p>Class å†…éƒ¨ç»“æ„ä¸­æœ‰ä¸ªæ–¹æ³•ç¼“å­˜ cacheï¼ˆcache_tï¼‰ï¼Œç”¨æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰æ¥ç¼“å­˜æ›¾ç»è°ƒç”¨è¿‡çš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜æ–¹æ³•çš„æŸ¥æ‰¾é€Ÿåº¦ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime16.png" alt="Runtime16"></p>
<p>ç¼“å­˜æŸ¥æ‰¾ï¼šobjc-cache.mm -&gt; <code>bucket_t * cache_t::find(cache_key_t k, id receiver)</code></p>
<p>cache_t é‡Œé€šè¿‡ _buckets ç¼“å­˜æ–¹æ³•ï¼Œé€šè¿‡ _mask è®¡ç®—ç´¢å¼•ï¼Œé€šè¿‡ _occupied ç»Ÿè®¡å·²ç»ç¼“å­˜çš„æ–¹æ³•çš„æ•°é‡ã€‚_buckets é‡Œç¼“å­˜çš„æ˜¯ bucke_t ç»“æ„ä½“ï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">_key</span> = @selector(æ–¹æ³•å)</div><div class="line"><span class="attr">_imp</span> = æ–¹æ³•çš„å‡½æ•°åœ°å€</div></pre></td></tr></table></figure></p>
<h3 id="mask"><a href="#mask" class="headerlink" title="_mask"></a>_mask</h3><p>_mask çš„å€¼æ˜¯æ•£åˆ—è¡¨çš„é•¿åº¦-1ï¼Œä¿è¯â€œä¸â€è¿ç®—çš„ç»“æœä¸ä¼šè¶…å‡ºæ•£åˆ—è¡¨çš„é•¿åº¦ï¼ˆ&amp;_mask &lt;= _maskï¼‰ï¼Œå³è®¡ç®—å‡ºçš„ç´¢å¼•ä¸ä¼šè¶Šç•Œã€‚</p>
<p>å‡è®¾ _mask = 0b0000 1000ï¼š<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b0100</span> <span class="number">1101</span></div><div class="line">&amp; <span class="number">0b0000</span> <span class="number">1000</span></div><div class="line">--------------</div><div class="line">  <span class="number">0b0000</span> <span class="number">1000</span></div></pre></td></tr></table></figure></p>
<p>æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰çš„å®ç°é€»è¾‘ï¼š<br>1ã€å®ç°ä¸€ä¸ªæ–¹æ³•1å¯ä»¥è®¡ç®—å‡ºç´¢å¼•ï¼›<br>2ã€å®ç°ä¸€ä¸ªæ–¹æ³•2å¯ä»¥è§£å†³ç´¢å¼•å†²çªï¼ˆå¦‚ï¼šå¯¹ç´¢å¼•å‡ 1 è®¡ç®—å‡ºæ–°çš„ç´¢å¼•å€¼ï¼‰ï¼›</p>
<p>ä½¿ç”¨æ±‚ä½™ <code>%</code> ä¹Ÿå¯ä»¥å®ç°æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰ï¼Œé€šè¿‡æ±‚ä½™è®¡ç®—å‡ºçš„ç´¢å¼•ä¹Ÿå¯ä»¥ä¿è¯ä¸è¶Šç•Œã€‚</p>
<h3 id="buckets"><a href="#buckets" class="headerlink" title="_buckets"></a>_buckets</h3><p>_buckets åœ¨åˆå§‹åŒ–æ—¶çš„ç©ºé—´å¤§å°æ˜¯æŒ‡å®šå¥½çš„ï¼Œå¹¶ä¸”å†…éƒ¨çš„æ•°æ®éƒ½æ˜¯ NULLï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰ã€‚å¦‚æœ _buckets é‡Œçš„æ•°æ®æ»¡äº†ï¼Œ_buckets ä¼šå°†æ•°æ®æ¸…ç©º -&gt; æ‰©å®¹x2ï¼ˆä¸€å€ï¼‰-&gt; é‡æ–°ç¼“å­˜ã€‚</p>
<p>å…ˆé€šè¿‡ <code>mask_t begin = cache_hash(sel, m)</code> è®¡ç®—å‡ºç´¢å¼• beginï¼š<br>å¦‚æœ begin å¤„æ²¡æœ‰å€¼ï¼Œç¼“å­˜ã€‚<br>å¦‚æœ begin å¤„æœ‰å€¼ï¼Œæ˜¯å½“å‰éœ€è¦ç¼“å­˜çš„æ–¹æ³•ï¼Œè¡¨ç¤ºå·²ç»ç¼“å­˜è¿‡äº†ç›´æ¥è¿”å›ã€‚<br>å¦‚æœ begin å¤„æœ‰å€¼ï¼Œä¸æ˜¯å½“å‰éœ€è¦ç¼“å­˜çš„æ–¹æ³•ï¼Œé€šè¿‡ <code>(i = cache_next(i, m)</code> è®¡ç®—å‡ºæ–°çš„ç´¢å¼•ï¼Œå¦‚æœæ–°çš„ç´¢å¼•ä¸ç­‰äº begin åˆ™é‡æ–°åˆ¤æ–­ï¼Œå¦‚æœæ–°çš„ç´¢å¼•ç­‰äº begin åˆ™å»æ‰©å®¹ï¼ˆbad_cache()ï¼‰ã€‚<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">void cache_t:<span class="type"></span>:insert(Class cls, SEL sel, IMP imp, id receiver)</div><div class="line">&#123;</div><div class="line">    ...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">    <span class="comment">// Use the cache as-is if it is less than 3/4 full</span></div><div class="line">    mask_t <span class="keyword">new</span><span class="type">Occupied</span> = occupied() + <span class="number">1</span>; <span class="comment">//occupied() æ•£åˆ—è¡¨é•¿åº¦ï¼ŒnewOccupied æ·»åŠ åçš„é•¿åº¦</span></div><div class="line">    unsigned oldCapacity = capacity(), capacity = oldCapacity;</div><div class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123; <span class="comment">//ç¬¬ä¸€æ¬¡</span></div><div class="line">        <span class="comment">// Cache is read-only. Replace it.</span></div><div class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(<span class="keyword">new</span><span class="type">Occupied</span> + CACHE_END_MARKER &lt;= capacity / <span class="number">4</span> * <span class="number">3</span>)) &#123; <span class="comment">//å·²ç»ç¼“å­˜çš„æ•°æ®ä¸è¶³3/4</span></div><div class="line">        <span class="comment">// Cache is less than 3/4 full. Use it as-is.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        capacity = capacity ? capacity * <span class="number">2</span> : <span class="type">INIT_CACHE_SIZE</span>; <span class="comment">//æ‰©å®¹x2</span></div><div class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</div><div class="line">            capacity = MAX_CACHE_SIZE;</div><div class="line">        &#125;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>); <span class="comment">//æ¸…ç©ºæ•°æ® -&gt; æ‰©å®¹</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bucket_t *b = buckets();</div><div class="line">    mask_t m = capacity - <span class="number">1</span>;</div><div class="line">    mask_t begin = cache_hash(sel, m); <span class="comment">//è®¡ç®—å‡ºç´¢å¼•</span></div><div class="line">    mask_t i = begin;</div><div class="line"></div><div class="line">    <span class="comment">// Scan for the first unused slot and insert there.</span></div><div class="line">    <span class="comment">// There is guaranteed to be an empty slot because the</span></div><div class="line">    <span class="comment">// minimum size is 4 and we resized at 3/4 full.</span></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (fastpath(b[i].sel() == <span class="number">0</span>)) &#123; <span class="comment">//å¦‚æœ begin å¤„æ²¡æœ‰å€¼ï¼Œç¼“å­˜</span></div><div class="line">            incrementOccupied();</div><div class="line">            b[i].<span class="keyword">set</span>&lt;Atomic, Encoded&gt;(sel, imp, cls);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (b[i].sel() == sel) &#123; <span class="comment">//ç´¢å¼•å¤„æœ‰å€¼ï¼Œæ˜¯å½“å‰éœ€è¦ç¼“å­˜çš„æ–¹æ³•</span></div><div class="line">            <span class="comment">// The entry was added to the cache by some other thread</span></div><div class="line">            <span class="comment">// before we grabbed the cacheUpdateLock.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (fastpath((i = cache_next(i, m)) != begin)); <span class="comment">//è®¡ç®—å‡ºæ–°çš„ç´¢å¼•ï¼Œåˆ¤æ–­æ–°çš„ç´¢å¼•æ˜¯å¦ç­‰äº beginï¼Œå¦‚æœç­‰äº begin åˆ™é‡æ–°åˆ¤æ–­ï¼Œå¦‚æœä¸ç­‰äº begin åˆ™è°ƒç”¨ bad_cache() å¤„ç†å¼‚å¸¸ç¼“å­˜</span></div><div class="line"></div><div class="line">    cache_t:<span class="type"></span>:bad_cache(receiver, (SEL)sel, cls);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">void cache_t:<span class="type"></span>:reallocate(mask_t oldCapacity, mask_t <span class="keyword">new</span><span class="type">Capacity</span>, bool freeOld)</div><div class="line">&#123;</div><div class="line">    bucket_t *oldBuckets = buckets(); <span class="comment">//æ—§çš„æ•£åˆ—è¡¨</span></div><div class="line">    bucket_t *<span class="keyword">new</span><span class="type">Buckets</span> = allocateBuckets(<span class="keyword">new</span><span class="type">Capacity</span>); <span class="comment">//æ–°çš„æ•£åˆ—è¡¨</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache's old contents are not propagated. </span></div><div class="line">    <span class="comment">// This is thought to save cache memory at the cost of extra cache fills.</span></div><div class="line">    <span class="comment">// fixme re-measure this</span></div><div class="line"></div><div class="line">    ASSERT(<span class="keyword">new</span><span class="type">Capacity</span> &gt; <span class="number">0</span>);</div><div class="line">    ASSERT((uintptr_t)(mask_t)(<span class="keyword">new</span><span class="type">Capacity</span>-<span class="number">1</span>) == <span class="keyword">new</span><span class="type">Capacity</span>-<span class="number">1</span>);</div><div class="line"></div><div class="line">    setBucketsAndMask(<span class="keyword">new</span><span class="type">Buckets</span>, <span class="keyword">new</span><span class="type">Capacity</span> - <span class="number">1</span>); <span class="comment">//ä½¿ç”¨æ–°çš„æ•£åˆ—è¡¨ï¼Œ_mask = newCapacity - 1</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (freeOld) &#123;</div><div class="line">        cache_collect_free(oldBuckets, oldCapacity); <span class="comment">//æ¸…ç©ºæ—§çš„æ•°æ®</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>__arm64__</code> ä¸‹çš„ cache_next æ–¹æ³•ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> mask_t <span class="title">cache_next</span><span class="params">(<span class="keyword">mask_t</span> i, <span class="keyword">mask_t</span> mask)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> i ? i<span class="number">-1</span> : mask;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="ç©ºé—´æ¢æ—¶é—´"><a href="#ç©ºé—´æ¢æ—¶é—´" class="headerlink" title="ç©ºé—´æ¢æ—¶é—´"></a>ç©ºé—´æ¢æ—¶é—´</h3><p>æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰éå†å…ƒç´ çš„æ•ˆç‡æ¯”æ•°ç»„é«˜çš„åŸå› æ˜¯ç‰ºç‰²äº†ä¸€å®šçš„ç©ºé—´æ¢å–äº†æ—¶é—´ã€‚  </p>
<h4 id="ä¾‹1ï¼š"><a href="#ä¾‹1ï¼š" class="headerlink" title="ä¾‹1ï¼š"></a>ä¾‹1ï¼š</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init]<span class="comment">;</span></div><div class="line">        test_objc_class *cls = (__bridge test_objc_class*)[Person class]<span class="comment">;</span></div><div class="line"></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line"></div><div class="line">        NSLog(@<span class="string">"--------"</span>)<span class="comment">; //æ–­ç‚¹</span></div><div class="line"></div><div class="line">        <span class="keyword">cache_t </span><span class="keyword">cache </span>= cls-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>       <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>       for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">            <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>           if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">10</span>) &#123;</div><div class="line">                NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125; else &#123;</div><div class="line">                NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--------</div><div class="line">init <span class="number">0x7ffe558b5aa</span></div><div class="line">testPerson <span class="number">0xc5e8</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x600000781640</span></div></pre></td></tr></table></figure></p>
<p>æ–­ç‚¹å¤„æŸ¥çœ‹ _mask å’Œ _occupiedï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime20.png" alt="Runtime20"></p>
<table>
<thead>
<tr>
<th>ç´¢å¼•</th>
<th>ç¼“å­˜çš„æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bucket_tï¼ˆ_key = @selector(init), _impï¼‰</td>
</tr>
<tr>
<td>1</td>
<td>bucket_tï¼ˆ_key = @selector(testPerson), _impï¼‰</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>[person testPerson]</code> å³ <code>objc_msgSend(objc_getClass(&quot;Person&quot;), sel_registerName(&quot;testPerson&quot;))</code> å‘ person å®ä¾‹å¯¹è±¡å‘é€ä¸€æ¡ <code>sel_registerName(&quot;testPerson&quot;)</code> æ¶ˆæ¯ï¼Œperson ä¼šé€šè¿‡ isa æ‰¾åˆ° Person ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)testPerson</code> æ–¹æ³•ï¼Œå…ˆæŸ¥ cacheï¼ˆ_bucketsï¼‰ï¼Œæ²¡æŸ¥åˆ°ï¼Œå†é€šè¿‡ bits æ‰¾åˆ° class_rw_t é‡Œçš„ methods æŸ¥ï¼ŒæŸ¥åˆ°åè¿”å›ã€‚ï¼ˆå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†é€šè¿‡ superclass æ‰¾åˆ°çˆ¶ç±»çš„ç±»å¯¹è±¡ç»§ç»­æŸ¥æ‰¾ï¼ˆæŸ¥æ‰¾æ–¹å¼ç›¸åŒï¼‰ã€‚å‡è®¾åœ¨æŸ¥æ‰¾åˆ°åŸºç±»çš„ç±»å¯¹è±¡æ—¶æ‰¾åˆ°äº† <code>-(void)testPerson</code> æ–¹æ³•ï¼Œå®åˆ—å¯¹è±¡ person ä¼šæŠŠ <code>-(void)testPerson</code> æ–¹æ³•ç¼“å­˜åˆ° _buckets é‡Œç„¶åè¿”å›ã€‚ï¼‰</p>
<p>åœ¨ç¼“å­˜ <code>@selector(testPerson)</code> æ–¹æ³•æ—¶ï¼Œå…ˆè®¡ç®—å‡ºç´¢å¼•ï¼ˆ1ï¼‰ï¼Œç„¶åæ£€æŸ¥ç´¢å¼•å¤„æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼ï¼Œå°† <code>@selector(testPerson)</code> ç¼“å­˜åˆ°å¯¹è±¡çš„ç´¢å¼•å¤„ã€‚</p>
<p>ç¬¬äºŒæ¬¡è°ƒç”¨ <code>[person testPerson]</code> ä¼šå…ˆå»å®ä¾‹å¯¹è±¡ person çš„ _buckets é‡Œæ‰¾ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•å¤„çš„å€¼åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰æ–¹æ³• <code>@selector(testPerson)</code>ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥è¿”å›ã€‚ï¼ˆå¦‚æœä¸æ˜¯å°±å°†ç´¢å¼•å‡ 1 ç»§ç»­åœ¨ _buckets é‡ŒæŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†å°±ç›´æ¥è¿”å›ã€‚å¦‚æœæ‰¾äº†ä¸€åœˆè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œä¼šåŒç¬¬ä¸€æ¬¡ä¸€æ ·å»ç±»å¯¹è±¡å’Œçˆ¶ç±»çš„ç±»å¯¹è±¡æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åç¼“å­˜åˆ° _buckets é‡Œå¹¶è¿”å›ã€‚ï¼‰</p>
<h4 id="ä¾‹2ï¼š"><a href="#ä¾‹2ï¼š" class="headerlink" title="ä¾‹2ï¼š"></a>ä¾‹2ï¼š</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init]<span class="comment">;</span></div><div class="line">        test_objc_class *cls = (__bridge test_objc_class*)[Person class]<span class="comment">;</span></div><div class="line"></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testStudent]<span class="comment">;</span></div><div class="line">        [person testStudent2]<span class="comment">;</span></div><div class="line"></div><div class="line">        NSLog(@<span class="string">"--------"</span>)<span class="comment">; //æ–­ç‚¹</span></div><div class="line"></div><div class="line">        <span class="keyword">cache_t </span><span class="keyword">cache </span>= cls-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>       <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>       for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">            <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>           if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">10</span>) &#123;</div><div class="line">                NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125; else &#123;</div><div class="line">                NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">--------</div><div class="line">testStudent2 <span class="number">0xc5</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">testStudent <span class="number">0xc5d</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x600001008500</span></div></pre></td></tr></table></figure></p>
<p>æ–­ç‚¹å¤„æŸ¥çœ‹ _mask å’Œ _occupiedï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime21.png" alt="Runtime21"></p>
<table>
<thead>
<tr>
<th>ç´¢å¼•</th>
<th>ç¼“å­˜çš„æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bucket_tï¼ˆ_key = @selector(testStudent2), _impï¼‰</td>
</tr>
<tr>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>bucket_tï¼ˆ_key = @selector(testStudent), _impï¼‰</td>
</tr>
<tr>
<td>4</td>
<td>NULL</td>
</tr>
<tr>
<td>5</td>
<td>NULL</td>
</tr>
<tr>
<td>6</td>
<td>NULL</td>
</tr>
<tr>
<td>7</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>åœ¨ç¼“å­˜ <code>@selector(testStudent)</code> æ–¹æ³•æ—¶ï¼Œ_buckets çš„ç©ºé—´ä¸å¤Ÿäº†ï¼Œ_buckets æ¸…ç©ºæ•°æ® -&gt; æ‰©å®¹x2ï¼ˆ8ï¼‰ -&gt; é‡æ–°ç¼“å­˜ã€‚å…ˆè®¡ç®—å‡ºç´¢å¼•ï¼ˆ3ï¼‰ï¼Œç„¶åæ£€æŸ¥ç´¢å¼•å¤„æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼ï¼Œå°† <code>@selector(testPerson)</code> ç¼“å­˜åˆ°å¯¹è±¡çš„ç´¢å¼•å¤„ã€‚</p>
<p>åœ¨ç¼“å­˜ <code>@selector(testStudent2)</code> æ–¹æ³•æ—¶ï¼Œå…ˆè®¡ç®—å‡ºç´¢å¼•ï¼ˆ0ï¼‰ï¼Œç„¶åæ£€æŸ¥ç´¢å¼•å¤„æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼ï¼Œå°† <code>@selector(testStudent2)</code> ç¼“å­˜åˆ°å¯¹è±¡çš„ç´¢å¼•å¤„ã€‚ï¼ˆå¦‚æœç´¢å¼•å€¼ä¸ <code>@selector(testStudent)</code> ç›¸åŒï¼ˆ3ï¼‰ï¼Œæ£€æŸ¥åˆ°ç´¢å¼•å¤„æœ‰å€¼ï¼Œç„¶åå°†ç´¢å¼•å‡ 1 è·å–åˆ°æ–°çš„ç´¢å¼•ï¼ˆ2ï¼‰ï¼Œå†æ£€æŸ¥æ–°çš„ç´¢å¼•å¤„æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼ï¼Œå°† <code>@selector(testStudent2)</code> ç¼“å­˜åˆ°å¯¹è±¡çš„ç´¢å¼•å¤„ã€‚ï¼‰</p>
<h4 id="ä¾‹3"><a href="#ä¾‹3" class="headerlink" title="ä¾‹3"></a>ä¾‹3</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    NSString * appDelegateClassName<span class="comment">;</span></div><div class="line">    @autoreleasepool &#123;</div><div class="line">        appDelegateClassName = NSStringFromClass([AppDelegate class])<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Teacher *teacher = [[Teacher alloc] init]<span class="comment">;</span></div><div class="line">    test_objc_class *teacherClass = (__bridge test_objc_class *)[Teacher class]<span class="comment">;</span></div><div class="line"></div><div class="line">    [teacher teacherTest]<span class="comment">;</span></div><div class="line">    [teacher studentTest]<span class="comment">;</span></div><div class="line">    [teacher personTest]<span class="comment">;</span></div><div class="line"></div><div class="line">    NSLog(@<span class="string">"--------"</span>)<span class="comment">; //æ–­ç‚¹</span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t </span><span class="keyword">cache </span>= teacherClass-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>   <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>   for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">        <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>       if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">1</span>) &#123;</div><div class="line">            NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>       &#125; else &#123;</div><div class="line">            NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>       &#125;</div><div class="line">    &#125;</div><div class="line">    return UIApplicationMain(argc, argv, nil, appDelegateClassName)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">studentTest <span class="number">0x5aa</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">personTest <span class="number">0x44c8</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x6000025f8380</span></div></pre></td></tr></table></figure></p>
<p>æ–­ç‚¹å¤„æŸ¥çœ‹ _mask å’Œ _occupiedï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime22.png" alt="Runtime22"></p>
<table>
<thead>
<tr>
<th>ç´¢å¼•</th>
<th>ç¼“å­˜çš„æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>NULL</td>
</tr>
<tr>
<td>1</td>
<td>bucket_tï¼ˆ_key = @selector(studentTest), _impï¼‰</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>NULL</td>
</tr>
<tr>
<td>4</td>
<td>NULL</td>
</tr>
<tr>
<td>5</td>
<td>bucket_tï¼ˆ_key = @selector(personTest), _impï¼‰</td>
</tr>
<tr>
<td>6</td>
<td>NULL</td>
</tr>
<tr>
<td>7</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>è°ƒç”¨ <code>[teacher teacherTest]</code> å³ <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;teacherTest&quot;))</code> å‘ teacher å®ä¾‹å¯¹è±¡å‘é€ä¸€æ¡ <code>sel_registerName(&quot;teacherTest&quot;)</code> æ¶ˆæ¯ï¼Œteacher ä¼šé€šè¿‡ isa æ‰¾åˆ° Teacher ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)teacherTest</code> æ–¹æ³•ï¼Œå…ˆæŸ¥ cacheï¼ˆ_bucketsï¼‰ï¼Œæ²¡æŸ¥åˆ°ï¼Œå†é€šè¿‡ bits æ‰¾åˆ° class_rw_t é‡Œçš„ methods æŸ¥ï¼ŒæŸ¥åˆ°åç¼“å­˜åˆ° _buckets é‡Œå¹¶è¿”å›ã€‚</p>
<p>è°ƒç”¨ <code>[teacher studentTest]</code> å³ <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;studentTest&quot;))</code> å‘ teacher å®ä¾‹å¯¹è±¡å‘é€ä¸€æ¡ <code>sel_registerName(&quot;studentTest&quot;)</code> æ¶ˆæ¯ï¼Œteacher ä¼šé€šè¿‡ isa æ‰¾åˆ° Teacher ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)studentTest</code> æ–¹æ³•ï¼Œå…ˆæŸ¥ cacheï¼ˆ_bucketsï¼‰ï¼Œæ²¡æŸ¥åˆ°ï¼Œå†é€šè¿‡ bits æ‰¾åˆ° class_rw_t é‡Œçš„ methods æŸ¥ï¼Œæ²¡æŸ¥åˆ°ã€‚ Teacher ç±»å¯¹è±¡é€šè¿‡ superclass æ‰¾åˆ°çˆ¶ç±» Student ç±»å¯¹è±¡ï¼Œå¹¶åœ¨ Student ç±»å¯¹è±¡çš„ _buckets é‡ŒæŸ¥æ‰¾ï¼Œæ²¡æ‰¾åˆ°ï¼Œå†é€šè¿‡åˆ° class_rw_t é‡ŒæŸ¥æ‰¾ï¼ŒæŸ¥åˆ°åç¼“å­˜åˆ° Teacher ç±»å¯¹è±¡çš„ _buckets é‡Œå¹¶è¿”å›ã€‚</p>
<p>è°ƒç”¨ <code>[teacher personTest]</code> å³ <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;personTest&quot;))</code> å‘ teacher å®ä¾‹å¯¹è±¡å‘é€ä¸€æ¡ <code>sel_registerName(&quot;personTest&quot;)</code> æ¶ˆæ¯ï¼Œteacher ä¼šé€šè¿‡ isa æ‰¾åˆ° Teacher ç±»å¯¹è±¡æŸ¥æ‰¾ï¼Œå…ˆæŸ¥æ‰¾ _bucketsï¼Œæ²¡æŸ¥åˆ°ï¼Œå†åˆ° class_rw_t é‡Œçš„æ–¹æ³•åˆ—è¡¨ methods æŸ¥æ‰¾ï¼Œæ²¡æŸ¥åˆ°ã€‚Teacher ç±»å¯¹è±¡ä¼šé€šè¿‡ superclass æ‰¾åˆ°çˆ¶ç±» Student ç±»å¯¹è±¡ï¼Œå¹¶åœ¨ Student ç±»å¯¹è±¡çš„ _buckets é‡ŒæŸ¥æ‰¾ï¼Œæ²¡æ‰¾åˆ°ï¼Œå†åˆ° class_rw_t é‡ŒæŸ¥æ‰¾ï¼Œæ²¡æŸ¥åˆ°ã€‚ Student ç±»å¯¹è±¡ä¼šé€šè¿‡ superclass æ‰¾åˆ°çˆ¶ç±» Person ç±»å¯¹è±¡ï¼Œå¹¶åœ¨ Person ç±»å¯¹è±¡çš„ _buckets é‡ŒæŸ¥æ‰¾ï¼Œæ²¡æŸ¥åˆ°ï¼Œå†åˆ° class_rw_t é‡ŒæŸ¥æ‰¾ï¼ŒæŸ¥åˆ°åç¼“å­˜åˆ° Teacher ç±»å¯¹è±¡çš„ _buckets é‡Œå¹¶è¿”å›ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><ol>
<li>å…ˆæŸ¥å½“å‰ç±»å¯¹è±¡çš„ç¼“å­˜ _bucketsï¼Œå†æŸ¥å½“å‰ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ class_rw_t -&gt; methods;</li>
<li>å…ˆæŸ¥çˆ¶ç±»ç±»å¯¹è±¡çš„ç¼“å­˜ _bucketsï¼Œå†æŸ¥çˆ¶ç±»ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ class_rw_t -&gt; methods;</li>
<li>åœ¨å½“å‰ç±»å¯¹è±¡çš„ç¼“å­˜ _buckets é‡ŒæŸ¥åˆ°åç›´æ¥è¿”å›ï¼›</li>
<li>åœ¨å½“å‰ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ class_rw_t -&gt; methods é‡ŒæŸ¥åˆ°åï¼Œå…ˆç¼“å­˜åˆ°å½“å‰ç±»å¯¹è±¡çš„ _buckets é‡Œï¼Œå†è¿”å›ï¼›</li>
<li>åœ¨çˆ¶ç±»ç±»å¯¹è±¡çš„ç¼“å­˜ _buckets é‡ŒæŸ¥åˆ°åï¼Œå…ˆç¼“å­˜åˆ°å½“å‰ç±»å¯¹è±¡çš„ _buckets é‡Œï¼Œå†è¿”å›ï¼›</li>
<li>åœ¨çˆ¶ç±»ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ class_rw_t -&gt; methods é‡ŒæŸ¥åˆ°åï¼Œå…ˆç¼“å­˜åˆ°å½“å‰ç±»å¯¹è±¡çš„ _buckets é‡Œï¼Œå†è¿”å›ï¼›</li>
</ol>
<h1 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h1><p>OC ä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶å®éƒ½æ˜¯è½¬æ¢ä¸º objc_msgSend å‡½æ•°çš„è°ƒç”¨ã€‚objc_msgSend çš„æ‰§è¡Œæµç¨‹å¯ä»¥åˆ†ä¸ºä¸‰å¤§é˜¶æ®µï¼Œå³æ¶ˆæ¯å‘é€ã€åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘ã€‚</p>
<h2 id="objc-msgSend-æ‰§è¡Œæµç¨‹"><a href="#objc-msgSend-æ‰§è¡Œæµç¨‹" class="headerlink" title="objc_msgSend æ‰§è¡Œæµç¨‹"></a>objc_msgSend æ‰§è¡Œæµç¨‹</h2><p>_objc_msgSend çš„å…¥å£åœ¨æ±‡ç¼–æ–‡ä»¶ objc-msg-arm64.s é‡Œã€‚runtime çš„å®ç°æ˜¯ç”¨ cã€c++ å’Œæ±‡ç¼–è¯­è¨€ç»„æˆçš„ï¼Œå¯¹äºä¸€äº›è°ƒç”¨é¢‘æ¬¡æ¯”è¾ƒé«˜çš„æ–¹æ³•ä¸€èˆ¬ä½¿ç”¨æ±‡ç¼–è¯­è¨€å®ç°ã€‚å¯¹äº _objc_msgSend ç­‰æ–¹æ³•ï¼Œä¸ºäº†æé«˜æ•ˆç‡éƒ½æ˜¯ä½¿ç”¨æ±‡ç¼–è¯­è¨€å®ç°çš„ã€‚</p>
<p>åœ¨æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> ä¸­æŸ¥æ‰¾ _objc_msgSend çš„å®ç°ã€‚  </p>
<h3 id="objc-msgSend-1"><a href="#objc-msgSend-1" class="headerlink" title="_objc_msgSend"></a>_objc_msgSend</h3><p>ENTRY çš„å®šä¹‰ï¼ŒENTRY æ˜¯ä¸€ä¸ªå®ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//macro æ˜¯å®çš„æ„æ€</span></div><div class="line"><span class="selector-class">.macro</span> ENTRY <span class="comment">/* name */</span></div><div class="line">	<span class="selector-class">.text</span>         <span class="comment">//æ•°æ®æ®µ</span></div><div class="line">	<span class="selector-class">.align</span> <span class="number">5</span></div><div class="line">	<span class="selector-class">.globl</span>    $<span class="number">0</span>  <span class="comment">//å…¨å±€åå­—</span></div><div class="line">$<span class="number">0</span>:</div><div class="line">.endmacro</div></pre></td></tr></table></figure></p>
<p>_objc_msgSend çš„å®šä¹‰ï¼Œä» ENTRY å¼€å§‹ï¼Œåˆ° END_ENTRY ç»“æŸï¼š<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">ENTRY _objc_msgSend</div><div class="line">    //---------------------------- æ¶ˆæ¯å‘é€ start ----------------------------</div><div class="line">	UNWIND _objc_msgSend, NoFrame</div><div class="line">        //p<span class="number">0</span>å¯„å­˜å™¨ï¼šæ¶ˆæ¯æ¥å—è€…ï¼Œreceiverï¼ˆ_objc_msgSend çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰</div><div class="line">	cmp	p<span class="number">0</span>, <span class="symbol">#0</span>			// nil check <span class="keyword">and</span> tagged pointer check</div><div class="line">#if SUPPORT_TAGGED_POINTERS</div><div class="line">        //bï¼šè·³è½¬ã€è°ƒç”¨ã€‚leï¼šå°äºç­‰äºã€‚å¦‚æœ p<span class="number">0</span> å°äºç­‰äº <span class="number">0</span>ï¼Œå°±è·³è½¬åˆ° LNilOrTagged æ–¹æ³•ï¼ˆå¦‚æœæ¶ˆæ¯æ¥æ”¶è€…æ˜¯ nil å°±è·³è½¬åˆ° LNilOrTaggedï¼‰</div><div class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</div><div class="line">#else</div><div class="line">	b.<span class="keyword">eq</span>	LReturnZero</div><div class="line">#endif</div><div class="line">	ldr	p<span class="number">13</span>, [<span class="keyword">x</span><span class="number">0</span>]		// p<span class="number">13</span> = isa</div><div class="line">	GetClassFromIsa_p<span class="number">16</span> p<span class="number">13</span>		// p<span class="number">16</span> = class</div><div class="line">LGetIsaDone:</div><div class="line">	// calls imp <span class="keyword">or</span> objc_msgSend_uncached</div><div class="line">	CacheLookup NORMAL, _objc_msgSend //æŸ¥æ‰¾ç¼“å­˜ï¼Œå‚æ•° NORMALã€‚ï¼ˆå®ç°ğŸ‘‡ï¼‰</div><div class="line"></div><div class="line">#if SUPPORT_TAGGED_POINTERS</div><div class="line">LNilOrTagged:</div><div class="line">        // è·³è½¬åˆ° LReturnZero æ–¹æ³•</div><div class="line">	b.<span class="keyword">eq</span>	LReturnZero		// nil check</div><div class="line"></div><div class="line">	// tagged</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGEOFF</span></div><div class="line">	ubfx	<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#60</span>, <span class="symbol">#4</span></div><div class="line">	ldr	<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer<span class="title">@PAGEOFF</span></div><div class="line">	cmp	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">16</span></div><div class="line">	b.<span class="keyword">ne</span>	LGetIsaDone</div><div class="line"></div><div class="line">	// ext tagged</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGEOFF</span></div><div class="line">	ubfx	<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#52</span>, <span class="symbol">#8</span></div><div class="line">	ldr	<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</div><div class="line">	b	LGetIsaDone</div><div class="line">// SUPPORT_TAGGED_POINTERS</div><div class="line">#endif</div><div class="line"></div><div class="line">LReturnZero:</div><div class="line">	// <span class="keyword">x</span><span class="number">0</span> is already zero</div><div class="line">	mov	<span class="keyword">x</span><span class="number">1</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">0</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">1</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">2</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">3</span>, <span class="symbol">#0</span></div><div class="line">	<span class="keyword">ret</span> //ç›¸å½“äº <span class="keyword">c</span> è¯­è¨€çš„ return</div><div class="line"></div><div class="line">	END_ENTRY _objc_msgSend</div></pre></td></tr></table></figure></p>
<p>_objc_msgSend æ¶‰åŠç›¸å…³æ–¹æ³•çš„å®ç°<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ğŸ‘‰ CacheLookup çš„å®ç°ï¼ŒæŸ¥æ‰¾ç¼“å­˜ï¼ˆåœ¨å½“å‰ç±»å¯¹è±¡çš„ cache ä¸­æŸ¥æ‰¾ï¼‰</span></div><div class="line">.macro CacheLookup</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">// Restart protocol:</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   As soon as we're past the LLookupStart$1 label we may have loaded</span></div><div class="line">	<span class="comment">//   an invalid cache pointer or mask.</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   When task_restartable_ranges_synchronize() is called,</span></div><div class="line">	<span class="comment">//   (or when a signal hits us) before we're past LLookupEnd$1,</span></div><div class="line">	<span class="comment">//   then our PC will be reset to LLookupRecover$1 which forcefully</span></div><div class="line">	<span class="comment">//   jumps to the cache-miss codepath which have the following</span></div><div class="line">	<span class="comment">//   requirements:</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   GETIMP:</span></div><div class="line">	<span class="comment">//     The cache-miss is just returning NULL (setting x0 to 0)</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   NORMAL and LOOKUP:</span></div><div class="line">	<span class="comment">//   - x0 contains the receiver</span></div><div class="line">	<span class="comment">//   - x1 contains the selector</span></div><div class="line">	<span class="comment">//   - x16 contains the isa</span></div><div class="line">	<span class="comment">//   - other registers are set as per calling conventions</span></div><div class="line">	<span class="comment">//</span></div><div class="line">LLookupStart$<span class="number">1</span>:</div><div class="line"></div><div class="line">	<span class="comment">// p1 = SEL, p16 = isa</span></div><div class="line">	ldr	p11, [x16, <span class="meta">#CACHE]				<span class="comment">// p11 = mask|buckets</span></span></div><div class="line"></div><div class="line"><span class="meta">#if CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_HIGH_16</span></div><div class="line">	<span class="keyword">and</span>	p10, p11, <span class="meta">#0x0000ffffffffffff	<span class="comment">// p10 = buckets (ç¼“å­˜)</span></span></div><div class="line">	<span class="keyword">and</span>	p12, p1, p11, LSR <span class="meta">#48		<span class="comment">// x12 = _cmd &amp; mask (é€šè¿‡â€œä¸â€è¿ç®—è®¡ç®—ç´¢å¼•)</span></span></div><div class="line"><span class="meta">#elif CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_LOW_4</span></div><div class="line">	<span class="keyword">and</span>	p10, p11, <span class="meta">#~0xf			<span class="comment">// p10 = buckets</span></span></div><div class="line">	<span class="keyword">and</span>	p11, p11, <span class="meta">#0xf			<span class="comment">// p11 = maskShift</span></span></div><div class="line">	mov	p12, <span class="meta">#0xffff</span></div><div class="line">	lsr	p11, p12, p11				<span class="comment">// p11 = mask = 0xffff &gt;&gt; p11</span></div><div class="line">	<span class="keyword">and</span>	p12, p1, p11				<span class="comment">// x12 = _cmd &amp; mask</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#error Unsupported cache mask storage for ARM64.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"></div><div class="line">	add	p12, p10, p12, LSL <span class="meta">#(1+PTRSHIFT)</span></div><div class="line">		             <span class="comment">// p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span></div><div class="line"></div><div class="line">	ldp	p17, p9, [x12]		<span class="comment">// &#123;imp, sel&#125; = *bucket</span></div><div class="line"><span class="number">1</span>:	cmp	p9, p1			<span class="comment">// if (bucket-&gt;sel != _cmd)</span></div><div class="line">	b.ne	<span class="number">2</span>f			<span class="comment">//     scan more</span></div><div class="line">	CacheHit $<span class="number">0</span>			<span class="comment">// call or return imp (æŸ¥æ‰¾åˆ°å‡½æ•°åœ°å€ï¼Œè°ƒç”¨æˆ–è€…è¿”å›ã€‚hitï¼šå‘½ä¸­ï¼Œæ‰¾åˆ°ã€‚)</span></div><div class="line">	</div><div class="line"><span class="number">2</span>:	<span class="comment">// not hit: p12 = not-hit bucketï¼ˆæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼‰</span></div><div class="line">	CheckMiss $<span class="number">0</span>			<span class="comment">// miss if bucket-&gt;sel == 0 (å®ç°ğŸ‘‡)</span></div><div class="line">	cmp	p12, p10		<span class="comment">// wrap if bucket == buckets</span></div><div class="line">	b.eq	<span class="number">3</span>f</div><div class="line">	ldp	p17, p9, [x12, <span class="meta">#-BUCKET_SIZE]!	<span class="comment">// &#123;imp, sel&#125; = *--bucket</span></span></div><div class="line">	b	<span class="number">1</span>b			<span class="comment">// loop</span></div><div class="line"></div><div class="line"><span class="number">3</span>:	<span class="comment">// wrap: p12 = first bucket, w11 = mask</span></div><div class="line"><span class="meta">#if CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_HIGH_16</span></div><div class="line">	add	p12, p12, p11, LSR <span class="meta">#(48 - (1+PTRSHIFT))</span></div><div class="line">					<span class="comment">// p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span></div><div class="line"><span class="meta">#elif CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_LOW_4</span></div><div class="line">	add	p12, p12, p11, LSL <span class="meta">#(1+PTRSHIFT)</span></div><div class="line">					<span class="comment">// p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#error Unsupported cache mask storage for ARM64.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">	<span class="comment">// Clone scanning loop to miss instead of hang when cache is corrupt.</span></div><div class="line">	<span class="comment">// The slow path may detect any corruption and halt later.</span></div><div class="line"></div><div class="line">	ldp	p17, p9, [x12]		<span class="comment">// &#123;imp, sel&#125; = *bucket</span></div><div class="line"><span class="number">1</span>:	cmp	p9, p1			<span class="comment">// if (bucket-&gt;sel != _cmd)</span></div><div class="line">	b.ne	<span class="number">2</span>f			<span class="comment">//     scan more</span></div><div class="line">	CacheHit $<span class="number">0</span>			<span class="comment">// call or return imp</span></div><div class="line">	</div><div class="line"><span class="number">2</span>:	<span class="comment">// not hit: p12 = not-hit bucket</span></div><div class="line">	CheckMiss $<span class="number">0</span>			<span class="comment">// miss if bucket-&gt;sel == 0</span></div><div class="line">	cmp	p12, p10		<span class="comment">// wrap if bucket == buckets</span></div><div class="line">	b.eq	<span class="number">3</span>f</div><div class="line">	ldp	p17, p9, [x12, <span class="meta">#-BUCKET_SIZE]!	<span class="comment">// &#123;imp, sel&#125; = *--bucket</span></span></div><div class="line">	b	<span class="number">1</span>b			<span class="comment">// loop</span></div><div class="line"></div><div class="line">LLookupEnd$<span class="number">1</span>:</div><div class="line">LLookupRecover$<span class="number">1</span>:</div><div class="line"><span class="number">3</span>:	<span class="comment">// double wrap</span></div><div class="line">	JumpMiss $<span class="number">0</span></div><div class="line"></div><div class="line">.endmacro</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ CheckMiss çš„å®ç°</span></div><div class="line">.macro CheckMiss</div><div class="line">	<span class="comment">// miss if bucket-&gt;sel == 0</span></div><div class="line">.<span class="keyword">if</span> $<span class="number">0</span> == GETIMP</div><div class="line">	cbz	p9, LGetImpMiss</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == NORMAL <span class="comment">//è°ƒç”¨ CacheLookup æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯ NORMAL</span></div><div class="line">	cbz	p9, __objc_msgSend_uncached <span class="comment">//è°ƒç”¨ __objc_msgSend_uncached æ–¹æ³•ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == LOOKUP</div><div class="line">	cbz	p9, __objc_msgLookup_uncached</div><div class="line">.<span class="keyword">else</span></div><div class="line">.abort oops</div><div class="line">.<span class="keyword">endif</span></div><div class="line">.endmacro</div><div class="line"></div><div class="line">.macro JumpMiss</div><div class="line">.<span class="keyword">if</span> $<span class="number">0</span> == GETIMP</div><div class="line">	b	LGetImpMiss</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == NORMAL</div><div class="line">	b	__objc_msgSend_uncached</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == LOOKUP</div><div class="line">	b	__objc_msgLookup_uncached</div><div class="line">.<span class="keyword">else</span></div><div class="line">.abort oops</div><div class="line">.<span class="keyword">endif</span></div><div class="line">.endmacro</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ __objc_msgSend_uncached çš„å®ç°</span></div><div class="line">STATIC_ENTRY __objc_msgSend_uncached</div><div class="line">UNWIND __objc_msgSend_uncached, FrameWithNoSaves</div><div class="line"></div><div class="line"><span class="comment">// THIS IS NOT A CALLABLE C FUNCTION</span></div><div class="line"><span class="comment">// Out-of-band p16 is the class to search</span></div><div class="line"></div><div class="line">MethodTableLookup <span class="comment">//æŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">TailCallFunctionPointer x17</div><div class="line"></div><div class="line">END_ENTRY __objc_msgSend_uncached</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ MethodTableLookup çš„å®ç°</span></div><div class="line">.macro MethodTableLookup</div><div class="line">	</div><div class="line">	<span class="comment">// push frame</span></div><div class="line">	SignLR</div><div class="line">	stp	fp, lr, [sp, <span class="meta">#-16]!</span></div><div class="line">	mov	fp, sp</div><div class="line"></div><div class="line">	<span class="comment">// save parameter registers: x0..x8, q0..q7</span></div><div class="line">	sub	sp, sp, <span class="meta">#(10*8 + 8*16)</span></div><div class="line">	stp	q0, q1, [sp, <span class="meta">#(0*16)]</span></div><div class="line">	stp	q2, q3, [sp, <span class="meta">#(2*16)]</span></div><div class="line">	stp	q4, q5, [sp, <span class="meta">#(4*16)]</span></div><div class="line">	stp	q6, q7, [sp, <span class="meta">#(6*16)]</span></div><div class="line">	stp	x0, x1, [sp, <span class="meta">#(8*16+0*8)]</span></div><div class="line">	stp	x2, x3, [sp, <span class="meta">#(8*16+2*8)]</span></div><div class="line">	stp	x4, x5, [sp, <span class="meta">#(8*16+4*8)]</span></div><div class="line">	stp	x6, x7, [sp, <span class="meta">#(8*16+6*8)]</span></div><div class="line">	str	x8,     [sp, <span class="meta">#(8*16+8*8)]</span></div><div class="line"></div><div class="line">        <span class="comment">// è¿™æ¡æ³¨é‡Šå¯ä»¥çœ‹åˆ°åœ¨è°ƒç”¨ lookUpImpOrForward å‡½æ•°æ—¶çš„å‚æ•°    </span></div><div class="line">	<span class="comment">// lookUpImpOrForward(obj, sel, cls, LOOKUP_INITIALIZE | LOOKUP_RESOLVER)</span></div><div class="line">	<span class="comment">// receiver and selector already in x0 and x1</span></div><div class="line">	mov	x2, x16</div><div class="line">	mov	x3, <span class="meta">#3</span></div><div class="line">	bl	_lookUpImpOrForward <span class="comment">//_lookUpImpOrForward æ–¹æ³•è¿”å›çš„æ˜¯å‡½æ•°åœ°å€ impï¼Œbl impï¼šè·³è½¬\è°ƒç”¨impã€‚ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line"></div><div class="line">	<span class="comment">// IMP in x0</span></div><div class="line">	mov	x17, x0</div><div class="line">	</div><div class="line">	<span class="comment">// restore registers and return</span></div><div class="line">	ldp	q0, q1, [sp, <span class="meta">#(0*16)]</span></div><div class="line">	ldp	q2, q3, [sp, <span class="meta">#(2*16)]</span></div><div class="line">	ldp	q4, q5, [sp, <span class="meta">#(4*16)]</span></div><div class="line">	ldp	q6, q7, [sp, <span class="meta">#(6*16)]</span></div><div class="line">	ldp	x0, x1, [sp, <span class="meta">#(8*16+0*8)]</span></div><div class="line">	ldp	x2, x3, [sp, <span class="meta">#(8*16+2*8)]</span></div><div class="line">	ldp	x4, x5, [sp, <span class="meta">#(8*16+4*8)]</span></div><div class="line">	ldp	x6, x7, [sp, <span class="meta">#(8*16+6*8)]</span></div><div class="line">	ldr	x8,     [sp, <span class="meta">#(8*16+8*8)]</span></div><div class="line"></div><div class="line">	mov	sp, fp</div><div class="line">	ldp	fp, lr, [sp], <span class="meta">#16</span></div><div class="line">	AuthenticateLR</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure></p>
<h3 id="lookUpImpOrForward"><a href="#lookUpImpOrForward" class="headerlink" title="_lookUpImpOrForward"></a>_lookUpImpOrForward</h3><p>ğŸ‘‰ _lookUpImpOrForward çš„å®ç°åœ¨ objc-runtime-new.mm æ–‡ä»¶ã€‚è€ç‰ˆæœ¬çš„ runtime æºç åœ¨è¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>__class_lookupMethodAndLoadCache3</code>ï¼Œ<code>_class_lookupMethodAndLoadCache3</code> å‡½æ•°é‡Œè°ƒç”¨çš„æ‰æ˜¯ lookUpImpOrForwardï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">IMP _class_lookupMethodAndLoadCache3(<span class="keyword">id</span> obj, SEL sel, Class cls) &#123;</div><div class="line">    <span class="keyword">return</span> lookUpImpOrForward(cls, sel, obj, <span class="literal">YES</span><span class="comment">/*initalize*/</span>, <span class="literal">NO</span><span class="comment">/*cache*/</span>, <span class="literal">YES</span><span class="comment">/*reslover*/</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>_lookUpImpOrForward æ˜¯ä¸€ä¸ªé€šè¿‡ c è¯­è¨€å®ç°çš„å‡½æ•°ï¼ˆå¯¹äºå‡½æ•°åï¼Œæ±‡ç¼–è¯­è¨€è½¬ c è¯­è¨€éœ€è¦å»æ‰ä¸€ä¸ªâ€œ<code>_</code>â€ï¼‰ã€‚<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">IMP lookUpImpOrForward(id inst, SEL sel, Class <span class="keyword">cls</span>, int behavior)</div><div class="line">&#123;</div><div class="line">    const IMP forward_imp = (IMP)_objc_msgForward_impcache; <span class="comment">//é»˜è®¤æ¶ˆæ¯è½¬å‘ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">    IMP imp = nil;</div><div class="line">    Class curClass;</div><div class="line"></div><div class="line">    runtimeLock.assertUnlocked();</div><div class="line"></div><div class="line">    <span class="comment">// Optimistic cache lookup</span></div><div class="line">    <span class="keyword">if</span> (fastpath(behavior &amp; LOOKUP_CACHE)) &#123; <span class="comment">//ä¼ å…¥çš„ behavior æ˜¯ LOOKUP_INITIALIZE | LOOKUP_RESOLVERï¼Œæ¡ä»¶ä¸æˆç«‹</span></div><div class="line">        imp = cache_getImp(<span class="keyword">cls</span>, sel); <span class="comment">//åœ¨ç¼“å­˜é‡ŒæŸ¥æ‰¾</span></div><div class="line">        <span class="keyword">if</span> (imp) <span class="keyword">goto</span> done_nolock; <span class="comment">//è·³è½¬åˆ° done_nolock æ–¹æ³•</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// runtimeLock is held during isRealized and isInitialized checking</span></div><div class="line">    <span class="comment">// to prevent races against concurrent realization.</span></div><div class="line"></div><div class="line">    <span class="comment">// runtimeLock is held during method search to make</span></div><div class="line">    <span class="comment">// method-lookup + cache-fill atomic with respect to method addition.</span></div><div class="line">    <span class="comment">// Otherwise, a category could be added but ignored indefinitely because</span></div><div class="line">    <span class="comment">// the cache was re-filled with the old value after the cache flush on</span></div><div class="line">    <span class="comment">// behalf of the category.</span></div><div class="line"></div><div class="line">    runtimeLock.lock();</div><div class="line"></div><div class="line">    <span class="comment">// We don't want people to be able to craft a binary blob that looks like</span></div><div class="line">    <span class="comment">// a class but really isn't one and do a CFI attack.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// To make these harder we want to make sure this is a class that was</span></div><div class="line">    <span class="comment">// either built into the binary or legitimately registered through</span></div><div class="line">    <span class="comment">// objc_duplicateClass, objc_initializeClassPair or objc_allocateClassPair.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> this check is quite costly during process startup.</span></div><div class="line">    checkIsKnownClass(<span class="keyword">cls</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(!<span class="keyword">cls</span>-&gt;isRealized())) &#123;</div><div class="line">        <span class="keyword">cls</span> = realizeClassMaybeSwiftAndLeaveLocked(<span class="keyword">cls</span>, runtimeLock);</div><div class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath((behavior &amp; LOOKUP_INITIALIZE) &amp;&amp; !<span class="keyword">cls</span>-&gt;isInitialized())) &#123;</div><div class="line">        <span class="keyword">cls</span> = initializeAndLeaveLocked(<span class="keyword">cls</span>, inst, runtimeLock);</div><div class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></div><div class="line"></div><div class="line">        <span class="comment">// If sel == initialize, class_initialize will send +initialize and </span></div><div class="line">        <span class="comment">// then the messenger will send +initialize again after this </span></div><div class="line">        <span class="comment">// procedure finishes. Of course, if this is not being called </span></div><div class="line">        <span class="comment">// from the messenger then it won't happen. 2778172</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    runtimeLock.assertLocked();</div><div class="line">    curClass = <span class="keyword">cls</span>;</div><div class="line"></div><div class="line">    <span class="comment">// The code used to lookpu the class's cache again right after</span></div><div class="line">    <span class="comment">// we take the lock but for the vast majority of the cases</span></div><div class="line">    <span class="comment">// evidence shows this is a miss most of the time, hence a time loss.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The only codepath calling into this without having performed some</span></div><div class="line">    <span class="comment">// kind of cache lookup is class_getInstanceMethod().</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (unsigned attempts = unreasonableClassCount();;) &#123;</div><div class="line">        <span class="comment">// curClass method list.ï¼ˆcurClass çš„æ–¹æ³•åˆ—è¡¨ï¼‰</span></div><div class="line">        <span class="comment">// for å¾ªç¯ç¬¬ä¸€æ¬¡æ—¶ï¼ŒcurClass ä»£è¡¨å½“å‰ç±»</span></div><div class="line">        <span class="comment">// for å¾ªç¯éç¬¬ä¸€æ¬¡æ—¶ï¼ŒcurClass ä»£è¡¨çˆ¶ç±»</span></div><div class="line">        Method meth = getMethodNoSuper_nolock(curClass, sel); <span class="comment">//åˆ° curClass çš„æ–¹æ³•åˆ—è¡¨é‡Œé¢æ‰¾ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (meth) &#123; <span class="comment">//å¦‚æœæ‰¾åˆ°äº†</span></div><div class="line">            imp = meth-&gt;imp; <span class="comment">//å–å‡ºæ–¹æ³•çš„å‡½æ•°åœ°å€</span></div><div class="line">            <span class="keyword">goto</span> done; <span class="comment">//è·³è½¬åˆ° done æ–¹æ³•</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// æ‰§è¡Œ curClass = curClass-&gt;superclassï¼Œæ‰¾åˆ°æ›´ä¸Šå±‚çˆ¶ç±»ï¼Œå¹¶åˆ¤æ–­æ–°èµ‹å€¼çš„ curClass æ˜¯å¦ä¸º nilï¼ˆé€šè¿‡ for å¾ªç¯é‡å¤æ‰§è¡Œï¼Œéå†çˆ¶ç±»ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (slowpath((curClass = curClass-&gt;superclass) == nil)) &#123; </div><div class="line">            <span class="comment">// No implementation found, and method resolver didn't help.</span></div><div class="line">            <span class="comment">// Use forwarding.</span></div><div class="line">            imp = forward_imp; <span class="comment">//å¦‚æœæ–°èµ‹å€¼çš„ curClass ä¸º nilï¼Œè¯´æ˜æ²¡æœ‰æ›´ä¸Šå±‚çˆ¶ç±»äº†ï¼Œåˆ™è®¾ç½® imp = forward_impï¼ˆæ¶ˆæ¯è½¬å‘ï¼‰</span></div><div class="line">            <span class="keyword">break</span>; <span class="comment">//è·³å‡º for å¾ªç¯</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Halt if there is a cycle in the superclass chain.</span></div><div class="line">        <span class="keyword">if</span> (slowpath(--attempts == <span class="number">0</span>)) &#123; <span class="comment">//åˆ¤æ–­ attempts - 1 åæ˜¯å¦ç­‰äº 0</span></div><div class="line">            _objc_fatal(<span class="string">"Memory corruption in class list."</span>); <span class="comment">//å¦‚æœç­‰äº 0 æŠ¥é”™</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Superclass cache.</span></div><div class="line">        imp = cache_getImp(curClass, sel); <span class="comment">//åˆ°çˆ¶ç±»çš„ç¼“å­˜é‡ŒæŸ¥æ‰¾ï¼ˆæ­¤æ—¶ curClass ä»£è¡¨çˆ¶ç±»ï¼‰</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (slowpath(imp == forward_imp)) &#123;</div><div class="line">            <span class="comment">// Found a forward:: entry in a superclass.</span></div><div class="line">            <span class="comment">// Stop searching, but don't cache yet; call method</span></div><div class="line">            <span class="comment">// resolver for this class first.</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (fastpath(imp)) &#123;</div><div class="line">            <span class="comment">// Found the method in a superclass. Cache it in this class.</span></div><div class="line">            <span class="keyword">goto</span> done; <span class="comment">//å¦‚æœåœ¨çˆ¶ç±»çš„ç¼“å­˜é‡Œæ‰¾åˆ°äº†ï¼Œè·³è½¬åˆ° done æ–¹æ³•</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//---------------------------- æ¶ˆæ¯å‘é€ end ----------------------------</span></div><div class="line"></div><div class="line">    <span class="comment">//---------------------------- åŠ¨æ€æ–¹æ³•è§£æ start ----------------------------</span></div><div class="line">    <span class="comment">// No implementation found. Try method resolver once.</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (slowpath(behavior &amp; LOOKUP_RESOLVER)) &#123; <span class="comment">//behavior é‡Œæ˜¯å¦åŒ…å« LOOKUP_RESOLVERï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¿‡åŠ¨æ€æ–¹æ³•è§£æäº†ï¼ˆä¼ å…¥çš„ behavior æ˜¯ LOOKUP_INITIALIZE | LOOKUP_RESOLVERï¼‰</span></div><div class="line">        behavior ^= LOOKUP_RESOLVER; <span class="comment">//å†åŠ ä¸€ä¸ª LOOKUP_RESOLVERï¼ˆåŠ¨æ€æ–¹æ³•è§£ææ‰§è¡Œå®Œæˆåï¼Œä¼šå†èµ°ä¸€é lookUpImpOrForwardï¼Œä¿è¯åªæ“ä½œä¸€æ¬¡åŠ¨æ€æ–¹æ³•è§£æï¼‰</span></div><div class="line">        <span class="keyword">return</span> resolveMethod_locked(inst, sel, <span class="keyword">cls</span>, behavior); <span class="comment">//å®ç°ğŸ‘‡</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//---------------------------- åŠ¨æ€æ–¹æ³•è§£æ end ----------------------------</span></div><div class="line"></div><div class="line"> done:</div><div class="line">    log_and_fill_cache(<span class="keyword">cls</span>, imp, sel, inst, curClass); <span class="comment">//å°†ä» curClass ç±»é‡Œæ‰¾åˆ°çš„å‡½æ•°åœ°å€ imp å¡«å……åˆ° clsï¼ˆobjc_msgSendçš„æ¥æ”¶è€…ï¼‰çš„ç¼“å­˜é‡Œï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">    runtimeLock.unlock();</div><div class="line"> done_nolock:</div><div class="line">    <span class="keyword">if</span> (slowpath((behavior &amp; LOOKUP_NIL) &amp;&amp; imp == forward_imp)) &#123;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> imp; <span class="comment">//è¿”å›å‡½æ•°åœ°å€</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ¶ˆæ¯å‘é€ç›¸å…³æ–¹æ³•å®ç°<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ğŸ‘‰ getMethodNoSuper_nolock çš„å®ç°</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">getMethodNoSuper_nolock(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    ASSERT(cls-&gt;isRealized());</div><div class="line">    <span class="comment">// fixme nil cls? </span></div><div class="line">    <span class="comment">// fixme nil sel?</span></div><div class="line"></div><div class="line">    <span class="keyword">auto</span> <span class="keyword">const</span> methods = cls-&gt;data()-&gt;methods(); <span class="comment">//cls-&gt;data() è¿”å›åˆ°æ˜¯ class_rw_tï¼Œå³ class_rw_t-&gt;methods()</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> mlists = methods.beginLists(),</div><div class="line">              end = methods.endLists();</div><div class="line">         mlists != end;</div><div class="line">         ++mlists)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// &lt;rdar://problem/46904873&gt; getMethodNoSuper_nolock is the hottest</span></div><div class="line">        <span class="comment">// caller of search_method_list, inlining it turns</span></div><div class="line">        <span class="comment">// getMethodNoSuper_nolock into a frame-less function and eliminates</span></div><div class="line">        <span class="comment">// any store from this codepath.</span></div><div class="line">        <span class="keyword">method_t</span> *m = search_method_list_inline(*mlists, sel); <span class="comment">//åˆ°æ–¹æ³•åˆ—è¡¨é‡ŒæŸ¥æ‰¾ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">        <span class="keyword">if</span> (m) <span class="keyword">return</span> m;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ search_method_list_inline çš„å®ç°</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">search_method_list_inline(<span class="keyword">const</span> <span class="keyword">method_list_t</span> *mlist, SEL sel)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> methodListIsFixedUp = mlist-&gt;isFixedUp();</div><div class="line">    <span class="keyword">int</span> methodListHasExpectedSize = mlist-&gt;entsize() == <span class="keyword">sizeof</span>(<span class="keyword">method_t</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (fastpath(methodListIsFixedUp &amp;&amp; methodListHasExpectedSize)) &#123; <span class="comment">//æ˜¯å¦æ˜¯æ’å¥½åºçš„æ–¹æ³•åˆ—è¡¨</span></div><div class="line">        <span class="keyword">return</span> findMethodInSortedMethodList(sel, mlist); <span class="comment">//åœ¨å·²ç»æ’å¥½åºçš„æ–¹æ³•åˆ—è¡¨é‡Œé¢æŸ¥æ‰¾ï¼ˆäºŒåˆ†æŸ¥æ‰¾ï¼‰ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// åœ¨æ²¡æœ‰æ’å¥½åºçš„æ–¹æ³•åˆ—è¡¨é‡Œéå†æŸ¥æ‰¾</span></div><div class="line">        <span class="comment">// Linear search of unsorted method list</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; meth : *mlist) &#123; </div><div class="line">            <span class="keyword">if</span> (meth.name == sel) <span class="keyword">return</span> &amp;meth;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></div><div class="line">    <span class="comment">// sanity-check negative results</span></div><div class="line">    <span class="keyword">if</span> (mlist-&gt;isFixedUp()) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; meth : *mlist) &#123;</div><div class="line">            <span class="keyword">if</span> (meth.name == sel) &#123;</div><div class="line">                _objc_fatal(<span class="string">"linear search worked when binary search did not"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ findMethodInSortedMethodList çš„å®ç°</span></div><div class="line">ALWAYS_INLINE <span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">findMethodInSortedMethodList(SEL key, <span class="keyword">const</span> <span class="keyword">method_list_t</span> *<span class="built_in">list</span>)</div><div class="line">&#123;</div><div class="line">    ASSERT(<span class="built_in">list</span>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> * <span class="keyword">const</span> first = &amp;<span class="built_in">list</span>-&gt;first;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> *base = first;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> *probe;</div><div class="line">    <span class="keyword">uintptr_t</span> keyValue = (<span class="keyword">uintptr_t</span>)key;</div><div class="line">    <span class="keyword">uint32_t</span> count;</div><div class="line">    <span class="comment">//äºŒåˆ†æŸ¥æ‰¾</span></div><div class="line">    <span class="keyword">for</span> (count = <span class="built_in">list</span>-&gt;count; count != <span class="number">0</span>; count &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">        probe = base + (count &gt;&gt; <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">uintptr_t</span> probeValue = (<span class="keyword">uintptr_t</span>)probe-&gt;name;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (keyValue == probeValue) &#123;</div><div class="line">            <span class="comment">// `probe` is a match.</span></div><div class="line">            <span class="comment">// Rewind looking for the *first* occurrence of this value.</span></div><div class="line">            <span class="comment">// This is required for correct category overrides.</span></div><div class="line">            <span class="keyword">while</span> (probe &gt; first &amp;&amp; keyValue == (<span class="keyword">uintptr_t</span>)probe[<span class="number">-1</span>].name) &#123;</div><div class="line">                probe--;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">method_t</span> *)probe;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (keyValue &gt; probeValue) &#123;</div><div class="line">            base = probe + <span class="number">1</span>;</div><div class="line">            count--;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ log_and_fill_cache çš„å®ç°</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span></div><div class="line">log_and_fill_cache(Class cls, IMP imp, SEL sel, id receiver, Class implementer)</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_MESSAGE_LOGGING</span></div><div class="line">    <span class="keyword">if</span> (slowpath(objcMsgLogEnabled &amp;&amp; implementer)) &#123;</div><div class="line">        <span class="keyword">bool</span> cacheIt = logMessageSend(implementer-&gt;isMetaClass(), </div><div class="line">                                      cls-&gt;nameForLogging(),</div><div class="line">                                      implementer-&gt;nameForLogging(), </div><div class="line">                                      sel);</div><div class="line">        <span class="keyword">if</span> (!cacheIt) <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    cache_fill(cls, sel, imp, receiver); <span class="comment">//å¡«å……åˆ°ç¼“å­˜</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//cache_fill çš„å®ç°åœ¨ objc-cache.mm æ–‡ä»¶</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_fill</span><span class="params">(Class cls, SEL sel, IMP imp, id receiver)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !DEBUG_TASK_THREADS</span></div><div class="line">    <span class="comment">// Never cache before +initialize is done</span></div><div class="line">    <span class="keyword">if</span> (cls-&gt;isInitialized()) &#123;</div><div class="line">        <span class="keyword">cache_t</span> *cache = getCache(cls);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(cacheUpdateLock);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        cache-&gt;insert(cls, sel, imp, receiver); <span class="comment">//å¡«å……åˆ°ç¼“å­˜çš„å…·ä½“å®ç°ï¼ˆå®ç°ğŸ‘‡ï¼‰</span></div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    _collecting_in_critical();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ cache_t::insert çš„å®ç°</span></div><div class="line">ALWAYS_INLINE</div><div class="line"><span class="keyword">void</span> <span class="keyword">cache_t</span>::insert(Class cls, SEL sel, IMP imp, id receiver)</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    ASSERT(sel != <span class="number">0</span> &amp;&amp; cls-&gt;isInitialized());</div><div class="line"></div><div class="line">    <span class="comment">// Use the cache as-is if it is less than 3/4 full</span></div><div class="line">    <span class="keyword">mask_t</span> newOccupied = occupied() + <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> oldCapacity = capacity(), capacity = oldCapacity;</div><div class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123;</div><div class="line">        <span class="comment">// Cache is read-only. Replace it.</span></div><div class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(newOccupied + CACHE_END_MARKER &lt;= capacity / <span class="number">4</span> * <span class="number">3</span>)) &#123; <span class="comment">//åˆ¤æ–­æ·»åŠ åçš„å‰©ä½™ç©ºé—´</span></div><div class="line">        <span class="comment">// Cache is less than 3/4 full. Use it as-is.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123; <span class="comment">//æ‰©å®¹x2</span></div><div class="line">        capacity = capacity ? capacity * <span class="number">2</span> : INIT_CACHE_SIZE;</div><div class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</div><div class="line">            capacity = MAX_CACHE_SIZE;</div><div class="line">        &#125;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">bucket_t</span> *b = buckets();</div><div class="line">    <span class="keyword">mask_t</span> m = capacity - <span class="number">1</span>;</div><div class="line">    <span class="keyword">mask_t</span> begin = cache_hash(sel, m); <span class="comment">//è®¡ç®—ç´¢å¼•</span></div><div class="line">    <span class="keyword">mask_t</span> i = begin;</div><div class="line"></div><div class="line">    <span class="comment">// Scan for the first unused slot and insert there.</span></div><div class="line">    <span class="comment">// There is guaranteed to be an empty slot because the</span></div><div class="line">    <span class="comment">// minimum size is 4 and we resized at 3/4 full.</span></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (fastpath(b[i].sel() == <span class="number">0</span>)) &#123; <span class="comment">//ç´¢å¼•å¤„æ²¡æœ‰æ–¹æ³•</span></div><div class="line">            incrementOccupied();</div><div class="line">            b[i].<span class="built_in">set</span>&lt;Atomic, Encoded&gt;(sel, imp, cls); <span class="comment">//æ·»åŠ åˆ°ç¼“å­˜ä¸­å¯¹åº”çš„ç´¢å¼•å¤„</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (b[i].sel() == sel) &#123;  <span class="comment">//ç´¢å¼•å¤„æœ‰æ–¹æ³•å¹¶ä¸”æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œè¡¨ç¤ºå·²ç»å­˜å‚¨è¿‡äº†ï¼Œè¿”å›</span></div><div class="line">            <span class="comment">// The entry was added to the cache by some other thread</span></div><div class="line">            <span class="comment">// before we grabbed the cacheUpdateLock.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (fastpath((i = cache_next(i, m)) != begin)); <span class="comment">//é‡æ–°è®¡ç®—ç´¢å¼•ï¼ˆå½“å‰ç´¢å¼•å‡ 1ï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦æŸ¥äº†ä¸€åœˆäº†</span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t</span>::bad_cache(receiver, (SEL)sel, cls);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="resolveMethod-locked"><a href="#resolveMethod-locked" class="headerlink" title="resolveMethod_locked()"></a>resolveMethod_locked()</h3><p>åŠ¨æ€æ–¹æ³•è§£æç›¸å…³æ–¹æ³•å®ç°<br><figure class="highlight hsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ğŸ‘‰ resolveMethod_locked çš„å®ç°</span></div><div class="line">static NEVER_INLINE IMP</div><div class="line">resolveMethod_locked(id inst, SEL sel, Class <span class="keyword">cls</span>, <span class="keyword">int</span> behavior)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line"></div><div class="line">    runtimeLock.unlock()<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">cls</span>-&gt;isMetaClass()) &#123; </div><div class="line">        <span class="comment">// ä¸æ˜¯å…ƒç±»å¯¹è±¡</span></div><div class="line">        <span class="comment">// try [cls resolveInstanceMethod:sel]</span></div><div class="line">        resolveInstanceMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //å®ç°ğŸ‘‡</span></div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// æ˜¯å…ƒç±»å¯¹è±¡</span></div><div class="line">        <span class="comment">// try [nonMetaClass resolveClassMethod:sel]</span></div><div class="line">        <span class="comment">// and [cls resolveInstanceMethod:sel]</span></div><div class="line">        resolveClassMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //å®ç°ğŸ‘‡</span></div><div class="line">        <span class="keyword">if</span> (!lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)) &#123;</div><div class="line">            resolveInstanceMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //å®ç°ğŸ‘‡</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// chances are that calling the resolver have populated the cache</span></div><div class="line">    <span class="comment">// so attempt using it</span></div><div class="line">    <span class="keyword">return</span> lookUpImpOrForward(inst, sel, <span class="keyword">cls</span>, behavior | LOOKUP_CACHE)<span class="comment">; //åŠ¨æ€æ–¹æ³•è§£æç›¸å…³æ–¹æ³•è°ƒç”¨å®Œæˆåï¼Œä¼šå†èµ°ä¸€é lookUpImpOrForward æ–¹æ³•ï¼Œå³æ¶ˆæ¯å‘é€çš„ç¬¬äºŒæ­¥ï¼ˆå®ç°ğŸ‘†ï¼‰</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ resolveInstanceMethod çš„å®ç°</span></div><div class="line">static void resolveInstanceMethod(id inst, SEL sel, Class <span class="keyword">cls</span>)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertUnlocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line">    SEL resolve_sel = @selector(resolveInstanceMethod:)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!lookUpImpOrNil(<span class="keyword">cls</span>, resolve_sel, <span class="keyword">cls</span>-&gt;ISA())) &#123;</div><div class="line">        <span class="comment">// Resolver not implemented.</span></div><div class="line">        <span class="keyword">return</span><span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend<span class="comment">;</span></div><div class="line">    bool resolved = msg(<span class="keyword">cls</span>, resolve_sel, sel)<span class="comment">; //è®© cls è°ƒç”¨ resolve_sel æ–¹æ³•</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache the result (good or bad) so the resolver doesn't fire next time.</span></div><div class="line">    <span class="comment">// +resolveInstanceMethod adds to self a.k.a. cls</span></div><div class="line">    IMP imp = lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (resolved  &amp;&amp;  PrintResolving) &#123;</div><div class="line">        <span class="keyword">if</span> (imp) &#123;</div><div class="line">            _objc_inform(<span class="string">"RESOLVE: method %c[%s %s] "</span></div><div class="line">                         <span class="string">"dynamically resolved to %p"</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), imp)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Method resolver didn't add anything?</span></div><div class="line">            _objc_inform(<span class="string">"RESOLVE: +[%s resolveInstanceMethod:%s] returned YES"</span></div><div class="line">                         <span class="string">", but no new implementation of %c[%s %s] was found"</span>,</div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel))<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ğŸ‘‰ resolveClassMethod çš„å®ç°</span></div><div class="line">static void resolveClassMethod(id inst, SEL sel, Class <span class="keyword">cls</span>)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertUnlocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isMetaClass())<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!lookUpImpOrNil(inst, @selector(resolveClassMethod:), <span class="keyword">cls</span>)) &#123;</div><div class="line">        <span class="comment">// Resolver not implemented.</span></div><div class="line">        <span class="keyword">return</span><span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Class nonmeta<span class="comment">;</span></div><div class="line">    &#123;</div><div class="line">        mutex_locker_t lock(runtimeLock)<span class="comment">;</span></div><div class="line">        nonmeta = getMaybeUnrealizedNonMetaClass(<span class="keyword">cls</span>, inst)<span class="comment">;</span></div><div class="line">        <span class="comment">// +initialize path should have realized nonmeta already</span></div><div class="line">        <span class="keyword">if</span> (!nonmeta-&gt;isRealized()) &#123;</div><div class="line">            _objc_fatal(<span class="string">"nonmeta class %s (%p) unexpectedly not realized"</span>,</div><div class="line">                        nonmeta-&gt;nameForLogging(), nonmeta)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend<span class="comment">;</span></div><div class="line">    bool resolved = msg(nonmeta, @selector(resolveClassMethod:), sel)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache the result (good or bad) so the resolver doesn't fire next time.</span></div><div class="line">    <span class="comment">// +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls</span></div><div class="line">    IMP imp = lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (resolved  &amp;&amp;  PrintResolving) &#123;</div><div class="line">        <span class="keyword">if</span> (imp) &#123;</div><div class="line">            _objc_inform(<span class="string">"RESOLVE: method %c[%s %s] "</span></div><div class="line">                         <span class="string">"dynamically resolved to %p"</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), imp)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Method resolver didn't add anything?</span></div><div class="line">            _objc_inform(<span class="string">"RESOLVE: +[%s resolveClassMethod:%s] returned YES"</span></div><div class="line">                         <span class="string">", but no new implementation of %c[%s %s] was found"</span>,</div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel))<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="objc-msgForward-impcache"><a href="#objc-msgForward-impcache" class="headerlink" title="__objc_msgForward_impcache"></a>__objc_msgForward_impcache</h3><p>æ¶ˆæ¯è½¬å‘ç›¸å…³æ–¹æ³•çš„å®ç°<br>ğŸ‘‰ __objc_msgForward_impcache æ–¹æ³•çš„å®ç°åœ¨æ±‡ç¼–æ–‡ä»¶ objc-msg-arm64.s<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">STATIC_ENTRY <span class="variable">__objc_msgForward_impcache</span></div><div class="line"></div><div class="line"><span class="comment">// No stret specialization.</span></div><div class="line">b	<span class="variable">__objc_msgForward</span></div><div class="line"></div><div class="line">END_ENTRY <span class="variable">__objc_msgForward_impcache</span></div><div class="line"></div><div class="line"></div><div class="line">ENTRY <span class="variable">__objc_msgForward</span></div><div class="line"></div><div class="line">adrp	x17, <span class="variable">__objc_forward_handler</span>@PAGE</div><div class="line">ldr	p17, [x17, <span class="variable">__objc_forward_handler</span>@PAGEOFF] <span class="comment">//å®ç°ğŸ‘‡</span></div><div class="line">TailCallFunctionPointer x17</div><div class="line"></div><div class="line">END_ENTRY <span class="variable">__objc_msgForward</span></div></pre></td></tr></table></figure></p>
<p>ğŸ‘‰ _objc_forward_handler çš„å®ç°åœ¨ C è¯­è¨€æ–‡ä»¶ objc-runtime.mmã€‚<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line"></div><div class="line"><span class="comment">// Default forward handler (nil) goes to forward:: dispatch.</span></div><div class="line"><span class="keyword">void</span> *_objc_forward_handler = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">void</span> *_objc_forward_stret_handler = <span class="literal">nil</span>;</div><div class="line"></div><div class="line"><span class="meta">#else</span></div><div class="line"></div><div class="line"><span class="comment">// Default forward handler halts the process.</span></div><div class="line">__attribute__((noreturn, cold)) <span class="keyword">void</span></div><div class="line">objc_defaultForwardHandler(<span class="keyword">id</span> <span class="keyword">self</span>, SEL sel)</div><div class="line">&#123;</div><div class="line">    _objc_fatal(<span class="string">"%c[%s %s]: unrecognized selector sent to instance %p "</span></div><div class="line">                <span class="string">"(no message forward handler is installed)"</span>, </div><div class="line">                class_isMetaClass(object_getClass(<span class="keyword">self</span>)) ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                object_getClassName(<span class="keyword">self</span>), sel_getName(sel), <span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> *_objc_forward_handler = (<span class="keyword">void</span>*)objc_defaultForwardHandler;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„ _objc_forward_handler æŒ‡é’ˆå­˜å‚¨çš„æ˜¯ objc_defaultForwardHandler çš„å‡½æ•°åœ°å€ã€‚å› ä¸º _objc_forward_handler æ²¡æœ‰å¼€æºï¼Œæ‰€ä»¥çœ‹ä¸åˆ°å…¶å…·ä½“çš„å†…éƒ¨å®ç°ï¼Œå³æ— æ³•çŸ¥é“è¯¥æ–¹æ³•åœ¨æ¶ˆæ¯è½¬å‘é˜¶æ®µå…·ä½“åšäº†ä»€ä¹ˆã€‚åœ¨æŠ¥é”™ä¿¡æ¯é‡Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯è½¬å‘æœ€åè°ƒç”¨äº† <code>__forwarding__</code> æ–¹æ³•ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŠ¥é”™ä¿¡æ¯ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime26.png" alt="Runtime26"></p>
<p>é€šè¿‡åç¼–è¯‘å¯ä»¥çœ‹åˆ° _objc_forward_handler çš„å…·ä½“å®ç°ï¼Œè¿™é‡Œæœ‰ä¸€ä»½æ ¹æ®æ±‡ç¼–ä»£ç ç¿»è¯‘æˆçš„ C è¯­è¨€ä¼ªä»£ç  <code>__forwarding__.c</code>ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ä¼ªä»£ç </span></div><div class="line"><span class="keyword">int</span> __forwarding__(<span class="keyword">void</span> *frameStackPointer, <span class="keyword">int</span> isStret) &#123;</div><div class="line">    <span class="keyword">id</span> receiver = *(<span class="keyword">id</span> *)frameStackPointer;</div><div class="line">    SEL sel = *(SEL *)(frameStackPointer + <span class="number">8</span>);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(sel);</div><div class="line">    Class receiverClass = object_getClass(receiver);</div><div class="line"></div><div class="line">    <span class="comment">// è°ƒç”¨ forwardingTargetForSelector:</span></div><div class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardingTargetForSelector:))) &#123;</div><div class="line">        <span class="keyword">id</span> forwardingTarget = [receiver forwardingTargetForSelector:sel]; <span class="comment">//å®ä¾‹å¯¹è±¡ - å¯¹è±¡æ–¹æ³•ï¼Œç±»å¯¹è±¡ - ç±»æ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (forwardingTarget &amp;&amp; forwardingTarget != receiver) &#123;</div><div class="line">            <span class="keyword">if</span> (isStret == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">int</span> ret;</div><div class="line">                objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> objc_msgSend(forwardingTarget, sel, ...); <span class="comment">//è¿”å›å€¼ forwardingTarget è°ƒç”¨æ–¹æ³•</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// åƒµå°¸å¯¹è±¡</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *className = class_getName(receiverClass);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *zombiePrefix = <span class="string">"_NSZombie_"</span>;</div><div class="line">    size_t prefixLen = strlen(zombiePrefix); <span class="comment">// 0xa</span></div><div class="line">    <span class="keyword">if</span> (strncmp(className, zombiePrefix, prefixLen) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelError,</div><div class="line">              <span class="string">@"*** -[%s %s]: message sent to deallocated instance %p"</span>,</div><div class="line">              className + prefixLen,</div><div class="line">              selName,</div><div class="line">              receiver);</div><div class="line">        &lt;breakpoint-interrupt&gt;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// è°ƒç”¨ methodSignatureForSelector è·å–ç±»å‹ç¼–ç åå†è°ƒç”¨ forwardInvocation</span></div><div class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(methodSignatureForSelector:))) &#123;</div><div class="line">        <span class="built_in">NSMethodSignature</span> *methodSignature = [receiver methodSignatureForSelector:sel]; <span class="comment">//å®ä¾‹å¯¹è±¡ - å¯¹è±¡æ–¹æ³•ï¼Œç±»å¯¹è±¡ - ç±»æ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (methodSignature) &#123;</div><div class="line">            <span class="built_in">BOOL</span> signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</div><div class="line">            <span class="keyword">if</span> (signatureIsStret != isStret) &#123;</div><div class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">                      <span class="string">@"*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of '%s'.  Signature thinks it does%s return a struct, and compiler thinks it does%s."</span>,</div><div class="line">                      selName,</div><div class="line">                      signatureIsStret ? <span class="string">""</span> : not,</div><div class="line">                      isStret ? <span class="string">""</span> : not);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardInvocation:))) &#123;</div><div class="line">                <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</div><div class="line"></div><div class="line">                [receiver forwardInvocation:invocation];</div><div class="line"></div><div class="line">                <span class="keyword">void</span> *returnValue = <span class="literal">NULL</span>;</div><div class="line">                [invocation getReturnValue:&amp;value];</div><div class="line">                <span class="keyword">return</span> returnValue;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">                      <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement forwardInvocation: -- dropping message"</span>,</div><div class="line">                      receiver,</div><div class="line">                      className);</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SEL *registeredSel = sel_getUid(selName);</div><div class="line"></div><div class="line">    <span class="comment">// selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡</span></div><div class="line">    <span class="keyword">if</span> (sel != registeredSel) &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">              <span class="string">@"*** NSForwarding: warning: selector (%p) for message '%s' does not match selector known to Objective C runtime (%p)-- abort"</span>,</div><div class="line">              sel,</div><div class="line">              selName,</div><div class="line">              registeredSel);</div><div class="line">    &#125; <span class="comment">// doesNotRecognizeSelector</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (class_respondsToSelector(receiverClass,<span class="keyword">@selector</span>(doesNotRecognizeSelector:))) &#123;</div><div class="line">        [receiver doesNotRecognizeSelector:sel];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">              <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement doesNotRecognizeSelector: -- abort"</span>,</div><div class="line">              receiver,</div><div class="line">              className);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The point of no return.</span></div><div class="line">    kill(getpid(), <span class="number">9</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h2><p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime23.png" alt="Runtime23"></p>
<ul>
<li>receiver é€šè¿‡ isa æŒ‡é’ˆæ‰¾åˆ° receiverClassï¼ŒreceiverClass é€šè¿‡superclass æŒ‡é’ˆæ‰¾åˆ° superClass</li>
<li>å¦‚æœæ˜¯ä»class_rw_tä¸­æŸ¥æ‰¾æ–¹æ³•<br>å·²ç»æ’åºçš„ï¼ŒäºŒåˆ†æŸ¥æ‰¾<br>æ²¡æœ‰æ’åºçš„ï¼Œéå†æŸ¥æ‰¾</li>
</ul>
<p>æµç¨‹è§£æï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­ receiver æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœ receiver ä¸ºç©ºç›´æ¥é€€å‡ºï¼Œå¦‚æœ receiver ä¸ä¸ºç©ºåˆ™åˆ° receiverClass çš„ cache ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼›  </li>
<li>ä» receiverClass çš„ cache ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°äº†æ–¹æ³•ï¼Œåˆ™è°ƒç”¨æ–¹æ³•ç»“æŸæŸ¥æ‰¾ã€‚æ²¡æ‰¾åˆ°æ–¹æ³•ï¼Œåˆ™ä» receiverClass çš„ class_rw_t ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼›</li>
<li>ä» receiverClass çš„ class_rw_t ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°äº†æ–¹æ³•ï¼Œåˆ™å°†æ–¹æ³•ç¼“å­˜åˆ° receiverClass çš„ cache ä¸­ï¼Œå¹¶è°ƒç”¨æ–¹æ³•ç»“æŸæŸ¥æ‰¾ã€‚æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œåˆ™ä» superclass çš„ cache ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼›</li>
<li>ä» superclass çš„ cache ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°äº†æ–¹æ³•ï¼Œå°†æ–¹æ³•ç¼“å­˜åˆ° receiverClass çš„ cache ä¸­ï¼Œå¹¶è°ƒç”¨æ–¹æ³•ç»“æŸæŸ¥æ‰¾ã€‚æ²¡æ‰¾åˆ°æ–¹æ³•ï¼Œåˆ™ä» superclass çš„ class_rw_t ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼›</li>
<li>ä» superclass çš„ class_rw_t ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°äº†æ–¹æ³•ï¼Œåˆ™å°†æ–¹æ³•ç¼“å­˜åˆ° receiverClass çš„ cache ä¸­ï¼Œå¹¶è°ƒç”¨æ–¹æ³•ç»“æŸæŸ¥æ‰¾ã€‚æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œåˆ™åˆ¤æ–­ä¸Šå±‚æ˜¯å¦è¿˜æœ‰ superclassï¼›</li>
<li>åˆ¤æ–­ä¸Šå±‚æ˜¯å¦è¿˜æœ‰ superclassï¼Œæœ‰ï¼Œåˆ™å›åˆ°ç¬¬4æ­¥ã€‚æ²¡æœ‰ï¼Œåˆ™å¼€å§‹åŠ¨æ€æ–¹æ³•è§£æï¼›</li>
</ol>
<h2 id="åŠ¨æ€æ–¹æ³•è§£æ"><a href="#åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="åŠ¨æ€æ–¹æ³•è§£æ"></a>åŠ¨æ€æ–¹æ³•è§£æ</h2><p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime24.png" alt="Runtime24"></p>
<ul>
<li><p>å¼€å‘è€…å¯ä»¥å®ç°ä»¥ä¸‹æ–¹æ³•ï¼Œæ¥åŠ¨æ€æ·»åŠ æ–¹æ³•å®ç°</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</div><div class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveClassMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>åŠ¨æ€è§£æè¿‡åï¼Œä¼šé‡æ–°èµ°â€œæ¶ˆæ¯å‘é€â€çš„æµç¨‹ï¼ˆâ€œä» receiverClassçš„cache ä¸­æŸ¥æ‰¾æ–¹æ³•â€è¿™ä¸€æ­¥å¼€å§‹æ‰§è¡Œï¼‰</p>
</li>
</ul>
<h3 id="åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•"><a href="#åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•" class="headerlink" title="åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•"></a>åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//è·å–å…¶å®ƒæ–¹æ³•</span></div><div class="line">        Method method = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="comment">//åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, method_getImplementation(method), method_getTypeEncoding(method));</div><div class="line">        <span class="comment">//è¿”å›YESä»£è¡¨æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Person other]</span></div></pre></td></tr></table></figure></p>
<p>Method æ˜¯æŒ‡å‘ç»“æ„ä½“ method_t çš„æŒ‡é’ˆï¼Œå³ struct objc_method == struct method_tï¼Œæ‰€ä»¥ <code>class_getInstanceMethod(self, @selector(other))</code> è¿”å›çš„æ˜¯ç»“æ„ä½“ method_tã€‚Method çš„å®šä¹‰ï¼š<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_method *<span class="function"><span class="keyword">Method</span>;</span></div></pre></td></tr></table></figure></p>
<p>è¯æ˜ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> method_t &#123;</div><div class="line">    SEL sel;</div><div class="line">    <span class="keyword">char</span> *types;</div><div class="line">    IMP imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//è·å–å…¶å®ƒæ–¹æ³•</span></div><div class="line">        <span class="keyword">struct</span> method_t *method = (<span class="keyword">struct</span> method_t *)class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s %p"</span>, method-&gt;sel, method-&gt;types, method-&gt;imp);</div><div class="line">        <span class="comment">//åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, method-&gt;imp, method-&gt;types);</div><div class="line">        <span class="comment">//è¿”å›YESä»£è¡¨æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">other</span> <span class="selector-tag">v16</span>@<span class="selector-tag">0</span><span class="selector-pseudo">:8</span> <span class="selector-tag">0x100000b40</span></div><div class="line"><span class="selector-tag">-</span><span class="selector-attr">[Person other]</span></div></pre></td></tr></table></figure></p>
<h3 id="åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°"><a href="#åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°" class="headerlink" title="åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°"></a>åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">void</span> c_other(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"c_other - %@ - %@"</span>, <span class="keyword">self</span>, <span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼ŒCè¯­è¨€çš„å‡½æ•°åœ°å€==å‡½æ•°åï¼Œå‡½æ•°ç¼–ç "v16@0:8"ï¼ˆä¹Ÿå¯ä»¥å†™æˆ v@:ï¼‰</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)c_other, <span class="string">"v16@0:8"</span>);</div><div class="line">        <span class="comment">//è¿”å›YESä»£è¡¨æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•"><a href="#åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•" class="headerlink" title="åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•"></a>åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//è·å–å…¶å®ƒæ–¹æ³•</span></div><div class="line">        Method method = class_getClassMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="comment">//åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        class_addMethod(object_getClass(<span class="keyword">self</span>), sel, method_getImplementation(method), method_getTypeEncoding(method));</div><div class="line">        <span class="comment">//è¿”å›YESä»£è¡¨æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveClassMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        [Person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Person other]</span></div></pre></td></tr></table></figure></p>
<h2 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h2><p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime25.png" alt="Runtime25"></p>
<ul>
<li>å¼€å‘è€…å¯ä»¥åœ¨ forwardInvocation: æ–¹æ³•ä¸­è‡ªå®šä¹‰ä»»ä½•é€»è¾‘</li>
<li>ä»¥ä¸Šæ–¹æ³•éƒ½æœ‰å¯¹è±¡æ–¹æ³•ã€ç±»æ–¹æ³•2ä¸ªç‰ˆæœ¬ï¼ˆå‰é¢å¯ä»¥æ˜¯åŠ å·+ï¼Œä¹Ÿå¯ä»¥æ˜¯å‡å·-ï¼‰</li>
</ul>
<h3 id="å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"><a href="#å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘" class="headerlink" title="å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"></a>å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘</h3><h4 id="forwardingTargetForSelector-æ–¹æ³•"><a href="#forwardingTargetForSelector-æ–¹æ³•" class="headerlink" title="-forwardingTargetForSelector: æ–¹æ³•"></a>-forwardingTargetForSelector: æ–¹æ³•</h4><p><code>-forwardingTargetForSelector:</code> æ–¹æ³•æœ‰è¿”å›å€¼æ—¶ï¼Œè¿”å›å€¼è°ƒç”¨æ–¹æ³•ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> [[Student alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<h4 id="methodSignatureForSelector-æ–¹æ³•"><a href="#methodSignatureForSelector-æ–¹æ³•" class="headerlink" title="-methodSignatureForSelector: æ–¹æ³•"></a>-methodSignatureForSelector: æ–¹æ³•</h4><p><code>-forwardingTargetForSelector:</code> æ–¹æ³•æ²¡æœ‰è¿”å›å€¼æ—¶ï¼Œä¼šè°ƒç”¨ <code>-methodSignatureForSelector:</code> æ–¹æ³•è·å–ç±»å‹ç¼–ç ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//ç±»å‹ç¼–ç ï¼šè¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹</span></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">"v16@0:8"</span>]; <span class="comment">//ä¹Ÿå¯ä»¥å†™æˆ v@:</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     anInvocation.target = [[Student alloc] init];</span></div><div class="line"><span class="comment">     [anInvocation invoke]; //è°ƒç”¨</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    [anInvocation invokeWithTarget:[[Student alloc] init]]; <span class="comment">//ä¼ å…¥ Target è°ƒç”¨</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>å¦‚æœ <code>-methodSignatureForSelector:</code> æ–¹æ³•æ²¡æœ‰è¿”å›ç±»å‹ç¼–ç ï¼Œåˆ™ä¼šæŠ¥é”™ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime27.png" alt="Runtime27"></p>
<p>ä»è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ°åœç•™åœ¨äº† <code>doesNotRecognizeSelector:</code> æ–¹æ³•ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime28.png" alt="Runtime28"></p>
<p>ç±»å‹ç¼–ç çš„å¦ä¸€ç§è¿”å›æ–¹å¼ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (NSMethodSignature *)<span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(<span class="attribute">test</span>:)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[[[Student alloc]</span> <span class="selector-tag">init</span>] <span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:aSelector</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super methodSignatureForSelector:aSelector]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å› ä¸º Student å®ç°äº† <code>-(void)test:(int)age</code> æ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨ Student çš„ <code>methodSignatureForSelector:</code> æ–¹æ³•å¯ä»¥è¿”å› <code>-(void)test:(int)age</code> æ–¹æ³•çš„ç±»å‹ç¼–ç ã€‚</p>
<h3 id="ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"><a href="#ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘" class="headerlink" title="ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"></a>ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘</h3><h4 id="forwardingTargetForSelector-æ–¹æ³•-1"><a href="#forwardingTargetForSelector-æ–¹æ³•-1" class="headerlink" title="+forwardingTargetForSelector: æ–¹æ³•"></a>+forwardingTargetForSelector: æ–¹æ³•</h4><p>åœ¨ <code>+forwardingTargetForSelector:</code> æ–¹æ³•é‡Œè¿”å›ç±»å¯¹è±¡ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">+ (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">+ (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123; <span class="comment">//ç±»æ–¹æ³•å’Œå¯¹è±¡æ–¹æ³•çš„æ–¹æ³•åéƒ½æ˜¯ "test"</span></div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[Student class]</span>;         <span class="comment">//objc_msgSend([Student class], @selector("test"))</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">main</span>(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>åœ¨ <code>+forwardingTargetForSelector:</code> æ–¹æ³•é‡Œè¿”å›å®åˆ—å¯¹è±¡ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">- (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">- (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123; <span class="comment">//ç±»æ–¹æ³•å’Œå¯¹è±¡æ–¹æ³•çš„æ–¹æ³•åéƒ½æ˜¯ "test"</span></div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[[Student alloc]</span> <span class="selector-tag">init</span>];  <span class="comment">//objc_msgSend([[Student alloc] init], @selector("test"))</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">main</span>(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<h4 id="methodSignatureForSelector-æ–¹æ³•-1"><a href="#methodSignatureForSelector-æ–¹æ³•-1" class="headerlink" title="+methodSignatureForSelector: æ–¹æ³•"></a>+methodSignatureForSelector: æ–¹æ³•</h4><p><code>+forwardingTargetForSelector:</code> æ–¹æ³•æ²¡æœ‰è¿”å›å€¼æ—¶ï¼Œä¼šè°ƒç”¨ <code>+methodSignatureForSelector:</code> æ–¹æ³•è·å–ç±»å‹ç¼–ç ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">+ (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">+ (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-tag">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSMethodSignature *)<span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[NSMethodSignature signatureWithObjCTypes:"v16@0:8"]</span>; <span class="comment">//ä¹Ÿå¯ä»¥å†™æˆ v@:</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super methodSignatureForSelector:aSelector]</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (void)<span class="selector-tag">forwardInvocation</span><span class="selector-pseudo">:(NSInvocation</span> *)<span class="selector-tag">anInvocation</span> &#123;</div><div class="line">    <span class="selector-attr">[anInvocation invokeWithTarget:[Student class]</span>];</div><div class="line">&#125;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>[Person test] çš„æœ¬è´¨æ˜¯ objc_msgSend([Person class], @selector(test))ï¼Œä¼šå…ˆèµ°ä¸€éâ€œæ¶ˆæ¯å‘é€â€æµç¨‹ã€‚å› ä¸º Person æ²¡æœ‰å®ç° <code>-(void)test</code> æ–¹æ³•ï¼Œæ‰€ä»¥</p>
<h4 id="NSInvocation"><a href="#NSInvocation" class="headerlink" title="NSInvocation"></a>NSInvocation</h4><p>NSInvocation å°è£…äº†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï¼ŒåŒ…æ‹¬ï¼šæ–¹æ³•è°ƒç”¨è€…ã€æ–¹æ³•åã€æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ï¼ˆç±»å‹ç¼–ç å†³å®š NSInvocation çš„æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ï¼‰ã€‚<br>anInvocation.target æ–¹æ³•è°ƒç”¨è€…<br>anInvocation.selector æ–¹æ³•å<br>[anInvocation getArgument:NULL atIndex:0] æ–¹æ³•å‚æ•°</p>
<p>ç¤ºä¾‹ä»£ç ï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> <span class="string">Student :</span> NSObject</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Student</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    NSLog(@<span class="string">"%sï¼Œage == %d"</span>, __func__, age);</div><div class="line">    <span class="keyword">return</span> age * <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@interface</span> <span class="string">Person :</span> NSObject</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"></div><div class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="meta">@selector</span>(<span class="string">test:</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">forwardingTargetForSelector:</span>aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="meta">@selector</span>(<span class="string">test:</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> [NSMethodSignature <span class="string">signatureWithObjCTypes:</span><span class="string">"i24@0:8i16"</span>];;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    <span class="comment">// to do ğŸ‘‡</span></div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, const <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person <span class="string">test:</span><span class="number">15</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ğŸ‘‰ é€šè¿‡ <code>getArgument:atIndex:</code> æ–¹æ³•è·å–å‚æ•°ï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    <span class="keyword">int</span> age;</div><div class="line">    [anInvocation <span class="string">getArgument:</span>&amp;age <span class="string">atIndex:</span><span class="number">2</span>]; <span class="comment">//ä¼ å…¥ age çš„åœ°å€å’Œä¸‹æ ‡</span></div><div class="line">    NSLog(@<span class="string">"age == %d"</span>, age);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">age</span> == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<p>å› ä¸º <code>-(void)test:(int)age</code> çš„ C è¯­è¨€å®ç°æ˜¯ <code>void test(id self, SEL _cmd, int age)</code>ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå‚æ•°é¡ºåºï¼šreceiverã€selector å’Œ other argumentï¼Œæ‰€ä»¥å‚æ•° age çš„ä¸‹æ ‡æ˜¯ 2ã€‚</p>
<p>ğŸ‘‰ è°ƒç”¨ <code>invokeWithTarget:</code> æ–¹æ³•ï¼Œå°†æ¶ˆæ¯è½¬å‘ç»™ Student çš„å®ä¾‹å¯¹è±¡ï¼š<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</div><div class="line">    /**</div><div class="line">     anInvocation.target == personå¯¹è±¡</div><div class="line">     anInvocation.selector == test:</div><div class="line">     anInvocation çš„å‚æ•°ï¼š<span class="number">15</span></div><div class="line">     */</div><div class="line">    [anInvocation invokeWithTarget:<span class="string">[[Student alloc] init]]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test:]</span>ï¼Œage == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<p>åœ¨è°ƒç”¨ <code>invokeWithTarget:</code> æ–¹æ³•å‰ï¼ŒanInvocation çš„ target æ˜¯ person å¯¹è±¡ï¼Œselector æ˜¯ <code>-(void)test:(int)age</code> æ–¹æ³•ï¼Œå‚æ•°æ˜¯ 15ã€‚åœ¨è°ƒç”¨ <code>invokeWithTarget:</code> æ–¹æ³•åï¼Œ anInvocation çš„ target å°±å˜æˆäº† student å¯¹è±¡äº†ã€‚ç›¸å½“äºå‘ student å¯¹è±¡å‘é€äº†ä¸€æ¡â€œtest:â€æ¶ˆæ¯ <code>objc_msgSend([[Student alloc] init], @selector(test:))</code>ã€‚</p>
<p>ğŸ‘‰ è°ƒç”¨ <code>getReturnValue:</code> æ–¹æ³•è·å–è¿”å›å€¼ï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    [anInvocation <span class="string">invokeWithTarget:</span>[[Student alloc] init]];</div><div class="line">    <span class="keyword">int</span> returnAge;</div><div class="line">    [anInvocation <span class="string">getReturnValue:</span>&amp;returnAge];</div><div class="line">    NSLog(@<span class="string">"returnAge == %d"</span>, returnAge);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Student <span class="symbol">test:</span>]ï¼Œage == <span class="number">15</span></span></div><div class="line"><span class="ruby">returnAge == <span class="number">30</span></span></div></pre></td></tr></table></figure></p>
<h3 id="synthesizeã€-dynamic"><a href="#synthesizeã€-dynamic" class="headerlink" title="@synthesizeã€@dynamic"></a>@synthesizeã€@dynamic</h3><p>@synthesize ä¼šè‡ªåŠ¨ç”Ÿæˆå±æ€§ age çš„æˆå‘˜å˜é‡ _ageï¼ŒåŒæ—¶ç”Ÿæˆå±æ€§ age çš„ setter å’Œ getter æ–¹æ³•çš„å®ç°ã€‚ç°åœ¨çš„ xcode éƒ½æ˜¯é»˜è®¤ç”Ÿæˆäº†ï¼Œä¸ç”¨æ‰‹å†™äº†ã€‚<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line"><span class="keyword">@synthesize</span> age = _age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *student = [[Student alloc] init];</div><div class="line">        student.age = <span class="number">20</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"student.age == %d"</span>, student.age);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">student<span class="selector-class">.age</span> == <span class="number">20</span></div></pre></td></tr></table></figure></p>
<p>@dynamic æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸éœ€è¦è‡ªåŠ¨ç”Ÿæˆå±æ€§ age çš„æˆå‘˜å˜é‡ _ageï¼Œä¹Ÿä¸éœ€è¦ç”Ÿæˆå±æ€§ age çš„ setter å’Œ getter æ–¹æ³•çš„å®ç°ã€‚<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age; <span class="comment">//å£°æ˜ age çš„ setter å’Œ getter æ–¹æ³•</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line"><span class="keyword">@dynamic</span> age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *student = [[Student alloc] init];</div><div class="line">        student.age = <span class="number">20</span>; <span class="comment">//[student setAge:20]ï¼Œæœ‰ setter å’Œ getter æ–¹æ³•çš„å£°æ˜ï¼Œæ²¡æœ‰ setter å’Œ getter æ–¹æ³•çš„å®ç°</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"student.age == %d"</span>, student.age);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŠ¥é”™ï¼šunrecognized selector sent to instance<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime29.png" alt="Runtime29"></p>
<p>ä½¿ç”¨åŠ¨æ€æ–¹æ³•è§£æè§£å†³è¿™ä¸ªé—®é¢˜ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, assign) int age;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line"></div><div class="line"><span class="variable">@dynamic</span> age;</div><div class="line"></div><div class="line"><span class="selector-tag">void</span> <span class="selector-tag">setAge</span>(id self, SEL _cmd, int age)</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"age is %d"</span>, age);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">age</span>(id self, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-tag">15</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (BOOL)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (sel == <span class="variable">@selector</span>(<span class="attribute">setAge</span>:)) &#123;</div><div class="line">        <span class="selector-tag">class_addMethod</span>(self, sel, (IMP)setAge, <span class="string">"v@:i"</span>);</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-tag">YES</span>;</div><div class="line">    &#125; <span class="selector-tag">else</span> <span class="selector-tag">if</span> (sel == <span class="variable">@selector</span>(age)) &#123;</div><div class="line">        <span class="selector-tag">class_addMethod</span>(self, sel, (IMP)age, <span class="string">"i@:"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super resolveInstanceMethod:sel]</span>;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">age is <span class="number">20</span></div><div class="line">student.age == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul>
<li><code>forwardingTargetForSelector:</code>ã€<code>methodSignatureForSelector:</code> å’Œ <code>forwardInvocation:</code> æ–¹æ³•æœ¬èº«å¹¶æ²¡æœ‰åŒºåˆ†å¯¹è±¡æ–¹æ³•å’Œç±»æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ _objc_forward_handler çš„å®ç°ä¸­ï¼Œreceiver ï¼ˆå®åˆ—å¯¹è±¡/ç±»å¯¹è±¡ï¼‰ä¼šè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼ˆå¯¹è±¡æ–¹æ³•/ç±»æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥å®ç°çš„æ–¹æ³•ç±»å‹éœ€è¦è·Ÿè¿”å›çš„ç±»å‹ç»Ÿä¸€ã€‚æ¶ˆæ¯è½¬å‘ä¸­ï¼Œä¸è¦åœ¨æ„æ–¹æ³•æ˜¯å¯¹è±¡æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œæœ¬è´¨è¿˜æ˜¯ objc_msgSend çš„æ¶ˆæ¯æ¥æ”¶è€…å’Œæ–¹æ³•åï¼ˆå®ä¾‹å¯¹è±¡ - å¯¹è±¡æ–¹æ³•ï¼Œç±»å¯¹è±¡ - ç±»æ–¹æ³•ï¼‰ã€‚</li>
</ul>
<h1 id="super-çš„æœ¬è´¨"><a href="#super-çš„æœ¬è´¨" class="headerlink" title="super çš„æœ¬è´¨"></a>super çš„æœ¬è´¨</h1><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self class] = %@"</span>, [<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self superclass] = %@"</span>, [<span class="keyword">self</span> superclass]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"----------------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super class] = %@"</span>, [<span class="keyword">super</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super superclass] = %@"</span>, [<span class="keyword">super</span> superclass]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *stu = [[Student alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>] = <span class="title">Student</span></span></div><div class="line">[<span class="built_in">self</span> superclass] = Person</div><div class="line">----------------------------</div><div class="line">[<span class="built_in">super</span> <span class="class"><span class="keyword">class</span>] = <span class="title">Student</span></span></div><div class="line">[<span class="built_in">super</span> superclass] = Person</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„ self å°±æ˜¯ person å®ä¾‹å¯¹è±¡ï¼Œ<code>[self class]</code> è¿”å›çš„æ˜¯ person å®ä¾‹å¯¹è±¡çš„ç±»å¯¹è±¡ï¼Œ<code>[self superclass]</code> è¿”å›çš„æ˜¯çˆ¶ç±» Person çš„ç±»å¯¹è±¡ã€‚  </p>
<p>æ€è€ƒï¼š<br>super ä»£è¡¨çš„æ˜¯ student çš„çˆ¶ç±» personï¼Œé‚£ä¹ˆ <code>[super class]</code> åº”è¯¥å°±ç­‰äº <code>[person class]</code>ï¼Œæ‰“å°ç»“æœåº”è¯¥æ˜¯ Personï¼Œè€Œ <code>[super class]</code>  çš„æ‰“å°ç»“æœå´æ˜¯ Studentâ“åŒæ ·çš„ <code>[super superclass]</code> åº”è¯¥å°±ç­‰äº <code>[person superclass]</code>ï¼Œæ‰“å°ç»“æœåº”è¯¥æ˜¯ NSObjectï¼Œè€Œ <code>[super superclass]</code> æ‰“å°ç»“æœå´æ˜¯ Personâ“</p>
<h2 id="objc-super-ç»“æ„ä½“"><a href="#objc-super-ç»“æ„ä½“" class="headerlink" title="objc_super ç»“æ„ä½“"></a>objc_super ç»“æ„ä½“</h2><p>å®šä¹‰ä¸€ä¸ª <code>-(void)run</code> æ–¹æ³•ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line">- (void)run;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Person</div><div class="line">- (void)run</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%@"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Student</span> : <span class="selector-tag">Person</span></div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">run</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Student</span></div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">run</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-attr">[super run]</span>;</div><div class="line">&#125;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure></p>
<p>é€šè¿‡ç»ˆç«¯å‘½ä»¤ <code>xcrun -sdk iphoneos clang -arch arm64  -rewrite-objc Student.m</code> ç”Ÿæˆ c++ ä»£ç  Student.cppï¼ŒæŸ¥çœ‹ <code>-(void)run</code> æ–¹æ³•çš„ c++ å®ç°ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_Student_run(Student * <span class="keyword">self</span>, SEL _cmd) &#123;</div><div class="line">    <span class="comment">//[super run];</span></div><div class="line">    ((<span class="keyword">void</span> (*)(__rw_objc_super *, SEL))(<span class="keyword">void</span> *)objc_msgSendSuper)((__rw_objc_super)&#123;(<span class="keyword">id</span>)<span class="keyword">self</span>, (<span class="keyword">id</span>)class_getSuperclass(objc_getClass(<span class="string">"Student"</span>))&#125;, sel_registerName(<span class="string">"run"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç®€åŒ–åçš„ <code>[super run]</code>ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">objc_msgSendSuper</span><span class="params">( (__rw_objc_super)</span></span>&#123;</div><div class="line">                        self, <span class="comment">//student å®ä¾‹å¯¹è±¡</span></div><div class="line">                        class_getSuperclass(objc_getClass(<span class="string">"Student"</span>)) <span class="comment">//[Person class]</span></div><div class="line">                    &#125;, <span class="comment">//__rw_objc_super ç»“æ„ä½“</span></div><div class="line">                    sel_registerName(<span class="string">"run"</span>) <span class="comment">//@selector(run)) );</span></div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° <code>[super run]</code> çš„åº•å±‚å®ç°è°ƒç”¨çš„æ˜¯ <code>objc_msgSendSuper()</code> æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>__rw_objc_super</code> ç»“æ„ä½“ï¼Œç¬¬äºŒå‚æ•°æ˜¯ <code>@selector(run)</code>ã€‚æ‰€ä»¥ super çš„æœ¬è´¨å°±æ˜¯ <code>__rw_objc_super</code> ç»“æ„ä½“ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__rw_objc_super</span></span> &#123; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *object; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *superClass; </div><div class="line">	__rw_objc_super(<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *o, <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *s) : object(o), superClass(s) &#123;&#125; </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>__rw_objc_super</code> ç»“æ„ä½“æ˜¯åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆçš„ï¼Œå¹¶å°†å‚æ•°ä¼ å…¥ objc_msgSendSuper() æ–¹æ³•ã€‚ä½†æ˜¯ objc_msgSendSuper() åœ¨å®šä¹‰æ—¶è¯¥ä½ç½®çš„å‚æ•°æ˜¯ä¸€ä¸ª objc_super ç»“æ„ä½“ï¼š<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct objc_super &#123;</div><div class="line">    <span class="comment">/// Specifies an instance of a class.</span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> id receiver;</div><div class="line"></div><div class="line">    <span class="comment">/// Specifies the particular superclass of the instance to message. </span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span></div><div class="line">    <span class="comment">/* For compatibility with old objc-runtime.h header */</span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> Class class;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> Class super_class;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="comment">/* super_class is the first class to search */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å› ä¸º <code>__rw_objc_super</code> å’Œ objc_super çš„ç»“æ„åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥ <code>__rw_objc_super</code> ç»“æ„ä½“ç®—æ˜¯ä¸€ä¸ªè‡ªå®šçš„ objc_superï¼Œä½œä¸ºå‚æ•°ä¼ ç»™ objc_msgSendSuper()ã€‚</p>
<p>å› ä¸ºç°åœ¨ä½¿ç”¨çš„æ˜¯ <code>__OBJC2__</code>ï¼Œæ‰€ä»¥ objc_super å¯ä»¥ç®€åŒ–ä¸ºï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_super &#123;</div><div class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull <span class="keyword">id</span> receiver; <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…</span></div><div class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull Class super_class; <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±»</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° objc_super ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¶ˆæ¯æ¥æ”¶è€…ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±»ã€‚æ‰€ä»¥ <code>[super run]</code> çš„åº•å±‚å®ç°å°±æ˜¯ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> __rw_objc_super arg = &#123; </div><div class="line">    <span class="keyword">self</span>, <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…</span></div><div class="line">    [Person <span class="keyword">class</span>] <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…çš„çˆ¶ç±» </span></div><div class="line">&#125;;</div><div class="line">objc_msgSendSuper(arg, <span class="keyword">@selector</span>(run));</div></pre></td></tr></table></figure></p>
<h2 id="objc-msgSendSuper-æ–¹æ³•"><a href="#objc-msgSendSuper-æ–¹æ³•" class="headerlink" title="objc_msgSendSuper() æ–¹æ³•"></a>objc_msgSendSuper() æ–¹æ³•</h2><p>é€šè¿‡ç»ˆç«¯å‘½ä»¤ <code>xcrun -sdk iphoneos clang -arch arm64  -rewrite-objc Student.m</code> ç”Ÿæˆçš„ c++ ä»£ç  Student.cppï¼ŒæŸ¥çœ‹ <code>[super run]</code> çš„ c++ å®ç°æ˜¯è°ƒç”¨çš„ objc_msgSendSuper() æ–¹æ³•ã€‚  </p>
<p>å…³äº <code>[super run]</code> è°ƒç”¨çš„æ–¹æ³• objc_msgSendSuper()ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * Sends a message with a simple return value to the superclass of an instance of a class.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> super A pointer to an \c objc_super data structure. Pass values identifying the</span></div><div class="line"><span class="comment"> *  context the message was sent to, including the instance of the class that is to receive the</span></div><div class="line"><span class="comment"> *  message and the superclass at which to start searching for the method implementation.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> op A pointer of type SEL. Pass the selector of the method that will handle the message.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> ...</span></div><div class="line"><span class="comment"> *   A variable argument list containing the arguments to the method.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> The return value of the method identified by \e op.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> objc_msgSend</span></div><div class="line"><span class="comment"> */</span></div><div class="line">OBJC_EXPORT id _Nullable</div><div class="line">objc_msgSendSuper(struct objc_super * _Nonnull super, SEL _Nonnull op, ...)</div><div class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</div></pre></td></tr></table></figure></p>
<p>objc_msgSendSuperï¼šå‘å®ä¾‹å¯¹è±¡çš„ super å‘é€å¸¦æœ‰ç®€å•è¿”å›å€¼çš„æ¶ˆæ¯ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ï¼šsuperï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼šopï¼ˆæ–¹æ³•çš„é€‰æ‹©å™¨ SELï¼‰ã€‚  </p>
<ul>
<li>superï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘ <code>objc_super</code> ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œåœ¨ç»“æ„ä½“çš„å†…éƒ¨æœ‰æ¥æ”¶æ¶ˆæ¯çš„å®ä¾‹å¯¹è±¡å’Œå¼€å§‹æœç´¢æ–¹æ³•å®ç°çš„ç±»å¯¹è±¡ï¼ˆä»è¯¥ç±»å¯¹è±¡å¼€å§‹æœç´¢æ–¹æ³•çš„å®ç°ï¼‰ã€‚  </li>
<li>opï¼šSEL ç±»å‹çš„æŒ‡é’ˆã€‚ä¼ é€’æ–¹æ³•çš„é€‰æ‹©å™¨ï¼ˆ@selector(run)ï¼‰ï¼Œè¯¥æ–¹æ³•å°±æ˜¯è¦å¤„ç†çš„æ¶ˆæ¯ã€‚</li>
</ul>
<p>é€šè¿‡æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“ objc_msgSendSuper() æœ‰ä¸¤ä¸ªå‚æ•° super å’Œ SELï¼Œå…¶ä¸­ super é‡Œæœ‰ä¸€ä¸ªæ¶ˆæ¯æ¥æ”¶è€…å’Œä¸€ä¸ªç±»å¯¹è±¡ã€‚objc_msgSendSuper() ä¼šä» super é‡Œçš„ç±»å¯¹è±¡å¼€å§‹æŸ¥æ‰¾ SELï¼Œæ‰¾åˆ°åäº¤ç»™ super é‡Œçš„æ¶ˆæ¯æ¥æ”¶è€…å¤„ç†ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼š<br><code>[super run]</code>ï¼šè®¾ç½®æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ selfï¼ˆstudent å®ä¾‹å¯¹è±¡ï¼‰ï¼Œå¹¶ä» Person ç±»å¯¹è±¡å¼€å§‹æŸ¥æ‰¾ <code>-(void)run</code> æ–¹æ³•ï¼š<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; <span class="keyword">self</span>, [Person <span class="class"><span class="keyword">class</span>] &#125;, @<span class="title">selector</span>(<span class="title">run</span>));</span></div></pre></td></tr></table></figure></p>
<p><code>[super method]</code> æµç¨‹å›¾ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime30.png" alt="Runtime30"></p>
<h2 id="objc-msgSendSuper2"><a href="#objc-msgSendSuper2" class="headerlink" title="objc_msgSendSuper2()"></a>objc_msgSendSuper2()</h2><h3 id="æŸ¥çœ‹æ±‡ç¼–ä»£ç "><a href="#æŸ¥çœ‹æ±‡ç¼–ä»£ç " class="headerlink" title="æŸ¥çœ‹æ±‡ç¼–ä»£ç "></a>æŸ¥çœ‹æ±‡ç¼–ä»£ç </h3><p>åœ¨ <code>[super superclass];</code> å¤„æ·»åŠ æ–­ç‚¹ï¼Œé€‰æ‹© Debug -&gt; Debug Workflow -&gt; Always Show Disassemblyï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime31.png" alt="Runtime31"><br>å¯ä»¥çœ‹åˆ° <code>[super class]</code> å’Œ <code>[super superclass]</code> åº•å±‚å®ç°è°ƒç”¨çš„å¹¶ä¸æ˜¯ <code>objc_msgSendSuper()</code> æ–¹æ³•è€Œæ˜¯ <code>objc_msgSendSuper2()</code> æ–¹æ³•ã€‚</p>
<p><code>objc_msgSendSuper2()</code> æ–¹æ³•çš„å…·ä½“å®ç°åœ¨æ±‡ç¼–æ–‡ä»¶ objc-msg-arm64.s é‡Œï¼š<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ENTRY _objc_msgSendSuper2</div><div class="line">UNWIND _objc_msgSendSuper2, NoFrame</div><div class="line"></div><div class="line">ldp	p0, p16, <span class="selector-attr">[x0]</span>		<span class="comment">// p0 = real receiver, p16 = class</span></div><div class="line">ldr	p16, <span class="selector-attr">[x16, #SUPERCLASS]</span>	<span class="comment">// p16 = class-&gt;superclass</span></div><div class="line">CacheLookup <span class="attribute">NORMAL</span>, _objc_msgSendSuper2</div><div class="line"></div><div class="line">END_ENTRY _objc_msgSendSuper2</div></pre></td></tr></table></figure></p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡é€‰æ‹© Product -&gt; Perform Action -&gt; Assemble â€œStudent.mâ€ å°† OC ä»£ç è½¬æˆæ±‡ç¼–ä»£ç ï¼Œæœç´¢ â€œ:21â€ï¼ˆç¬¬21è¡Œï¼‰æ‰¾åˆ°å…·ä½“çš„ä»£ç å®ç°ï¼š<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">......<span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line">Ltmp0:</div><div class="line">	.loc	<span class="number">3</span> <span class="number">21</span> <span class="number">5</span> prologue_end     ## Runtime-test2/Student.m:<span class="number">21</span>:<span class="number">5</span> <span class="comment">//Student.m æ–‡ä»¶çš„ç¬¬ 21 è¡Œ</span></div><div class="line">	movq	<span class="number">-8</span>(%rbp), %rax</div><div class="line">	movq	%rax, <span class="number">-32</span>(%rbp)</div><div class="line">	movq	_OBJC_CLASSLIST_SUP_REFS_$_(%rip), %rax</div><div class="line">	movq	%rax, <span class="number">-24</span>(%rbp)</div><div class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</div><div class="line">	leaq	<span class="number">-32</span>(%rbp), %rdi</div><div class="line">	callq	_objc_msgSendSuper2</div><div class="line">	.loc	<span class="number">3</span> <span class="number">22</span> <span class="number">1</span>                  ## Runtime-test2/Student.m:<span class="number">22</span>:<span class="number">1</span></div><div class="line">	addq	$32, %rsp</div><div class="line">	popq	%rbp</div><div class="line">	retq</div><div class="line"></div><div class="line">......<span class="comment">//çœç•¥</span></div></pre></td></tr></table></figure></p>
<p>å³è¾¹çš„æ³¨é‡Šä»£è¡¨çš„æ˜¯ Student.m ç¬¬21è¡Œï¼ˆ:21ï¼‰ã€‚åœ¨è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ° <code>[super run]</code> è°ƒç”¨çš„æ˜¯ <code>_objc_msgSendSuper2</code> æ–¹æ³•ã€‚</p>
<h3 id="æŸ¥çœ‹-LLVM-çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰"><a href="#æŸ¥çœ‹-LLVM-çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰" class="headerlink" title="æŸ¥çœ‹ LLVM çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰"></a>æŸ¥çœ‹ LLVM çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰</h3><p>Objective-C åœ¨å˜ä¸ºæœºå™¨ä»£ç ä¹‹å‰ï¼Œä¼šè¢« LLVM ç¼–è¯‘å™¨è½¬æ¢ä¸º<a href="https://llvm.org/docs/LangRef.html" target="_blank" rel="external">ä¸­é—´ä»£ç ï¼ˆIntermediate Representationï¼‰</a>ã€‚</p>
<table>
<thead>
<tr>
<th>è¯­æ³•</th>
<th>ç®€ä»‹</th>
</tr>
</thead>
<tbody>
<tr>
<td>@</td>
<td>å…¨å±€å˜é‡</td>
</tr>
<tr>
<td>%</td>
<td>å±€éƒ¨å˜é‡</td>
</tr>
<tr>
<td>alloca</td>
<td>åœ¨å½“å‰æ‰§è¡Œçš„å‡½æ•°çš„å †æ ˆå¸§ä¸­åˆ†é…å†…å­˜ï¼Œå½“è¯¥å‡½æ•°è¿”å›åˆ°å…¶è°ƒç”¨è€…æ—¶ï¼Œå°†è‡ªåŠ¨é‡Šæ”¾å†…å­˜</td>
</tr>
<tr>
<td>i32</td>
<td>32ä½4å­—èŠ‚çš„æ•´æ•°</td>
</tr>
<tr>
<td>align</td>
<td>å¯¹é½</td>
</tr>
<tr>
<td>load</td>
<td>è¯»å‡º</td>
</tr>
<tr>
<td>store</td>
<td>å†™å…¥</td>
</tr>
<tr>
<td>icmp</td>
<td>ä¸¤ä¸ªæ•´æ•°å€¼æ¯”è¾ƒï¼Œè¿”å›å¸ƒå°”å€¼</td>
</tr>
<tr>
<td>br</td>
<td>é€‰æ‹©åˆ†æ”¯ï¼Œæ ¹æ®æ¡ä»¶æ¥è½¬å‘ labelï¼Œä¸æ ¹æ®æ¡ä»¶è·³è½¬çš„è¯ç±»ä¼¼ goto</td>
</tr>
<tr>
<td>label</td>
<td>ä»£ç æ ‡ç­¾</td>
</tr>
<tr>
<td>call</td>
<td>è°ƒç”¨å‡½æ•°</td>
</tr>
</tbody>
</table>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> <span class="string">Person :</span> NSObject</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"><span class="keyword">void</span> test(<span class="keyword">int</span> param)</div><div class="line">&#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [NSMethodSignature <span class="string">signatureWithObjCTypes:</span>@<span class="string">"v@:"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> <span class="string">forwardInvocation:</span>anInvocation];</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</div><div class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</div><div class="line">    <span class="keyword">int</span> c = a + b;</div><div class="line">    test(c);</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¡ŒæŒ‡ä»¤ç”Ÿæˆä¸­é—´ä»£ç  Person.llï¼š<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-emit-llvm</span> <span class="selector-tag">-S</span> <span class="selector-tag">Person</span><span class="selector-class">.m</span></div></pre></td></tr></table></figure></p>
<p>æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•å®ç°ï¼š<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">......//çœç•¥</div><div class="line">//<span class="symbol">%1</span>*ï¼šselfï¼Œ<span class="keyword">i8</span>*ï¼š_cmdï¼Œ<span class="symbol">%2</span>*ï¼šanInvocation</div><div class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void @<span class="string">"\01-[Person forwardInvocation:]"</span>(<span class="symbol">%1</span>*, <span class="keyword">i8</span>*, <span class="symbol">%2</span>*) <span class="symbol">#2</span> &#123;</div><div class="line">  <span class="symbol">%4</span> = <span class="keyword">alloca</span> <span class="symbol">%1</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%5</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%6</span> = <span class="keyword">alloca</span> <span class="symbol">%2</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%7</span> = <span class="keyword">alloca</span> <span class="symbol">%struct._objc_super</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%8</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="symbol">%9</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="symbol">%10</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="keyword">store</span> <span class="symbol">%1</span>* <span class="symbol">%0</span>, <span class="symbol">%1</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%1</span>, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="keyword">store</span> <span class="symbol">%2</span>* <span class="symbol">%2</span>, <span class="symbol">%2</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%11</span> = <span class="keyword">load</span> <span class="symbol">%1</span>*, <span class="symbol">%1</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%12</span> = <span class="keyword">load</span> <span class="symbol">%2</span>*, <span class="symbol">%2</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%13</span> = <span class="keyword">bitcast</span> <span class="symbol">%1</span>* <span class="symbol">%11</span> <span class="keyword">to</span> <span class="keyword">i8</span>*</div><div class="line">  <span class="symbol">%14</span> = <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="symbol">%struct._objc_super</span>, <span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i32</span> <span class="number">0</span>, <span class="keyword">i32</span> <span class="number">0</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%13</span>, <span class="keyword">i8</span>** <span class="symbol">%14</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%15</span> = <span class="keyword">load</span> <span class="symbol">%struct._class_t</span>*, <span class="symbol">%struct._class_t</span>** @<span class="string">"OBJC_CLASSLIST_SUP_REFS_$_"</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%16</span> = <span class="keyword">bitcast</span> <span class="symbol">%struct._class_t</span>* <span class="symbol">%15</span> <span class="keyword">to</span> <span class="keyword">i8</span>*</div><div class="line">  <span class="symbol">%17</span> = <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="symbol">%struct._objc_super</span>, <span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i32</span> <span class="number">0</span>, <span class="keyword">i32</span> <span class="number">1</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%16</span>, <span class="keyword">i8</span>** <span class="symbol">%17</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%18</span> = <span class="keyword">load</span> <span class="keyword">i8</span>*, <span class="keyword">i8</span>** <span class="title">@OBJC_SELECTOR_REFERENCES_.2</span>, <span class="keyword">align</span> <span class="number">8</span>, <span class="title">!invariant.load</span> !<span class="number">9</span></div><div class="line">  //è°ƒç”¨ objc_msgSendSuper<span class="number">2</span>ï¼Œå‚æ•°ä¸€ï¼š_objc_superï¼Œå‚æ•°äºŒï¼š<span class="keyword">i8</span>* _cmd</div><div class="line">  <span class="keyword">call</span> void <span class="keyword">bitcast</span> (<span class="keyword">i8</span>* (<span class="symbol">%struct._objc_super</span>*, <span class="keyword">i8</span>*, ...)* <span class="title">@objc_msgSendSuper2</span> <span class="keyword">to</span> void (<span class="symbol">%struct._objc_super</span>*, <span class="keyword">i8</span>*, <span class="symbol">%2</span>*)*)(<span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i8</span>* <span class="symbol">%18</span>, <span class="symbol">%2</span>* <span class="symbol">%12</span>)</div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="number">10</span>, <span class="keyword">i32</span>* <span class="symbol">%8</span>, <span class="keyword">align</span> <span class="number">4</span>    //å°†<span class="number">10</span>å†™å…¥åˆ°<span class="symbol">%8</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="number">20</span>, <span class="keyword">i32</span>* <span class="symbol">%9</span>, <span class="keyword">align</span> <span class="number">4</span>    //å°†<span class="number">20</span>å†™å…¥åˆ°<span class="symbol">%9</span></div><div class="line">  <span class="symbol">%19</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%8</span>, <span class="keyword">align</span> <span class="number">4</span>  //å°†<span class="symbol">%8</span>è¯»å‡ºåˆ°<span class="symbol">%19</span></div><div class="line">  <span class="symbol">%20</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%9</span>, <span class="keyword">align</span> <span class="number">4</span>  //å°†<span class="symbol">%9</span>è¯»å‡ºåˆ°<span class="symbol">%20</span></div><div class="line">  <span class="symbol">%21</span> = <span class="keyword">add</span> <span class="keyword">nsw</span> <span class="keyword">i32</span> <span class="symbol">%19</span>, <span class="symbol">%20</span>        //å°†<span class="symbol">%19</span>åŠ ä¸Š<span class="symbol">%20</span>èµ‹å€¼ç»™<span class="symbol">%21</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="symbol">%21</span>, <span class="keyword">i32</span>* <span class="symbol">%10</span>, <span class="keyword">align</span> <span class="number">4</span>  //å°†<span class="symbol">%21</span>å†™å…¥åˆ°<span class="symbol">%10</span></div><div class="line">  <span class="symbol">%22</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%10</span>, <span class="keyword">align</span> <span class="number">4</span> //å°†<span class="symbol">%10</span>è¯»å‡ºåˆ°<span class="symbol">%22</span></div><div class="line">  <span class="keyword">call</span> void <span class="title">@test</span>(<span class="keyword">i32</span> <span class="symbol">%22</span>)          //è°ƒç”¨ test(<span class="symbol">%22</span>)</div><div class="line">  <span class="keyword">ret</span> void</div><div class="line">&#125;</div><div class="line"></div><div class="line">......//çœç•¥</div></pre></td></tr></table></figure></p>
<h3 id="å°ç»“-2"><a href="#å°ç»“-2" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>é€šè¿‡ç»ˆç«¯å‘½ä»¤è¡Œç”Ÿæˆçš„ c++ ä»£ç ä¸­ <code>[super run]</code> çš„åº•å±‚å®ç°æ˜¯ <code>objc_msgSendSuper()</code> æ–¹æ³•ï¼Œé€šè¿‡æŸ¥çœ‹æ±‡ç¼–ä»£ç å’Œ LLVM çš„ä¸­é—´ä»£ç å¯ä»¥çœ‹åˆ° <code>[super run]</code> çš„åº•å±‚å®ç°æ˜¯ <code>objc_msgSendSuper2()</code> æ–¹æ³•ã€‚è¿™ä¸ªé—®é¢˜è¿˜æ˜¯ä¹‹å‰æåˆ°è¿‡çš„ï¼Œé€šè¿‡ç»ˆç«¯å‘½ä»¤ç”Ÿæˆçš„ç¼–è¯‘æ–‡ä»¶å¾ˆè¿è¡Œæ—¶ç”Ÿæˆçš„ç¼–è¯‘æ–‡ä»¶ç›¸æ¯”ï¼Œåœ¨æŸäº›ç»†èŠ‚çš„åœ°æ–¹è¿˜æ˜¯æœ‰åŒºåˆ«çš„ã€‚ä¸è¿‡å¹¶ä¸å½±å“ç†è§£å…·ä½“çš„å®ç°é€»è¾‘ã€‚</p>
<h2 id="selfã€class-å’Œ-superclass-çš„åº•å±‚å®ç°"><a href="#selfã€class-å’Œ-superclass-çš„åº•å±‚å®ç°" class="headerlink" title="selfã€class å’Œ superclass çš„åº•å±‚å®ç°"></a>selfã€class å’Œ superclass çš„åº•å±‚å®ç°</h2><p>selfã€class å’Œ superclass çš„åº•å±‚å®ç°åœ¨æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> çš„ NSObject.mm æ–‡ä»¶ã€‚<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">+ (id)<span class="built_in">self</span> &#123;</div><div class="line">    <span class="keyword">return</span> (id)<span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)<span class="built_in">self</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="class"><span class="keyword">Class</span>)<span class="title">class</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="class"><span class="keyword">Class</span>)<span class="title">class</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> object_getClass(<span class="built_in">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>-&gt;superclass;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> [<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>]-&gt;<span class="title">superclass</span>;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>[super class]</code> è®¾ç½®çš„æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ selfï¼ˆstudent å®ä¾‹å¯¹è±¡ï¼‰ï¼Œå¹¶ä» Person ç±»å¯¹è±¡å¼€å§‹æŸ¥æ‰¾å¯¹è±¡æ–¹æ³• <code>-(Class)class</code>ã€‚åœ¨ Person ç±»å¯¹è±¡é‡Œæ²¡æœ‰æ‰¾åˆ°ï¼Œé€šè¿‡ superclass æŒ‡é’ˆæ‰¾åˆ°çˆ¶ç±»çš„ç±»å¯¹è±¡ NSObjectï¼Œåœ¨ NSObject ç±»å¯¹è±¡é‡Œæ‰¾åˆ°äº†å¯¹è±¡æ–¹æ³• <code>-(Class)class</code> åäº¤ç»™æ¶ˆæ¯æ¥æ”¶è€…å¤„ç†ã€‚å› ä¸ºæ˜¯ç”±æ¶ˆæ¯æ¥æ”¶è€…å¤„ç†å¯¹è±¡æ–¹æ³• <code>-(Class)class</code>ï¼Œæ‰€ä»¥å¯¹è±¡æ–¹æ³• <code>- (Class)class</code> çš„å‚æ•° self è‡ªç„¶å°±æ˜¯æ¶ˆæ¯æ¥æ”¶è€…æœ¬èº«äº†ã€‚æ‰€ä»¥ <code>[super class]</code> æœ€ç»ˆçš„è¿”å›å€¼å°±æ˜¯ Studentï¼ˆ<code>[student class]</code>ï¼‰ã€‚<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; self, [Person <span class="class"><span class="keyword">class</span>] &#125;, <span class="type">@selector</span></span>(<span class="class"><span class="keyword">class</span>));</span></div></pre></td></tr></table></figure></p>
<p><code>[super superclass]</code> è®¾ç½®çš„æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ selfï¼ˆstudent å®ä¾‹å¯¹è±¡ï¼‰ï¼Œå¹¶ä» Person ç±»å¯¹è±¡å¼€å§‹æŸ¥æ‰¾å¯¹è±¡æ–¹æ³• <code>-(Class)superclass</code>ã€‚åœ¨ Person ç±»å¯¹è±¡é‡Œæ²¡æœ‰æ‰¾åˆ°ï¼Œé€šè¿‡ superclass æŒ‡é’ˆæ‰¾åˆ°çˆ¶ç±»çš„ç±»å¯¹è±¡ NSObjectï¼Œåœ¨ NSObject ç±»å¯¹è±¡é‡Œæ‰¾åˆ°äº†å¯¹è±¡æ–¹æ³• <code>-(Class)superclass</code> åäº¤ç»™æ¶ˆæ¯æ¥æ”¶è€…å¤„ç†ã€‚å› ä¸ºæ˜¯ç”±æ¶ˆæ¯æ¥æ”¶è€…å¤„ç†å¯¹è±¡æ–¹æ³• <code>-(Class)superclass</code>ï¼Œæ‰€ä»¥å¯¹è±¡æ–¹æ³• <code>- (Class)superclass</code> çš„å‚æ•° self è‡ªç„¶å°±æ˜¯æ¶ˆæ¯æ¥æ”¶è€…æœ¬èº«äº†ã€‚æ‰€ä»¥ <code>[super superclass]</code> çš„è¿”å›å€¼å°±æ˜¯ Personï¼ˆ<code>[student superclass]</code>ï¼‰ã€‚<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; <span class="keyword">self</span>, [Person <span class="class"><span class="keyword">class</span>] &#125;, @<span class="title">selector</span>(<span class="title">superclass</span>));</span></div></pre></td></tr></table></figure></p>
<p>ç°åœ¨å†çœ‹è¿™å››ä¸ªæ–¹æ³•ï¼Œå°±å¾ˆæ¸…æ™°äº†ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> <span class="keyword">class</span>];       <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…ï¼šstudentï¼Œè°ƒç”¨æ–¹æ³•ï¼š-(void)class</span></div><div class="line">        [<span class="keyword">self</span> superclass];  <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…ï¼šstudentï¼Œè°ƒç”¨æ–¹æ³•ï¼š-(void)superclass</span></div><div class="line"></div><div class="line">        [<span class="keyword">super</span> <span class="keyword">class</span>];      <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…ï¼šstudentï¼Œè°ƒç”¨æ–¹æ³•ï¼š-(void)class</span></div><div class="line">        [<span class="keyword">super</span> superclass]; <span class="comment">//æ¶ˆæ¯æ¥æ”¶è€…ï¼šstudentï¼Œè°ƒç”¨æ–¹æ³•ï¼š-(void)superclass</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="isKindOfClass-å’Œ-isMemberOfClass"><a href="#isKindOfClass-å’Œ-isMemberOfClass" class="headerlink" title="isKindOfClass: å’Œ isMemberOfClass:"></a>isKindOfClass: å’Œ isMemberOfClass:</h2><p><code>isKindOfClass:</code> å’Œ <code>isMemberOfClass:</code> çš„åº•å±‚å®ç°åœ¨æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> çš„ NSObject.mm æ–‡ä»¶ã€‚<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+ (BOOL)isMemberOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>-&gt;ISA() == cls;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isMemberOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> [<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>] == <span class="title">cls</span>;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (BOOL)isKindOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">for</span> (<span class="class"><span class="keyword">Class</span> <span class="title">tcls</span> = <span class="title">self</span>-&gt;<span class="title">ISA</span>(); <span class="title">tcls</span>; <span class="title">tcls</span> = <span class="title">tcls</span>-&gt;<span class="title">superclass</span>) &#123;</span></div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> NO;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isKindOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">for</span> (<span class="class"><span class="keyword">Class</span> <span class="title">tcls</span> = [<span class="title">self</span> <span class="title">class</span>]; <span class="title">tcls</span>; <span class="title">tcls</span> = <span class="title">tcls</span>-&gt;<span class="title">superclass</span>) &#123;</span></div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><p><code>-isMemberOfClass:</code>ï¼šè·å– self çš„ç±»å¯¹è±¡ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚</p>
</li>
<li><p><code>+isMemberOfClass:</code>ï¼šå› ä¸ºè‡ªèº«æ˜¯ç±»æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ‹¿ self-&gt;ISA()ï¼ˆå…ƒç±»ï¼‰ä½œä¸º tcls ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚</p>
</li>
<li><p><code>+isKindOfClass:</code>ï¼šæ–¹æ³•å†…éƒ¨æ˜¯ä¸€ä¸ª for å¾ªç¯ï¼Œå› ä¸ºè‡ªèº«æ˜¯ç±»æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ‹¿ self-&gt;ISA()ï¼ˆå…ƒç±»ï¼‰ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸ç›¸ç­‰å†éå† tcls çš„ superclass ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚éå†è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªç›¸ç­‰å°±ç»“æŸéå†è¿”å› YESï¼Œéå†ç»“æŸåæ²¡æœ‰æ‰¾åˆ°ç›¸ç­‰çš„ç±»å°±è¿”å› NOã€‚</p>
</li>
<li><p><code>-isKindOfClass:</code>ï¼šæ–¹æ³•å†…éƒ¨æ˜¯ä¸€ä¸ª for å¾ªç¯ï¼Œå…ˆè·å–åˆ° self çš„ç±»å¯¹è±¡ tcls ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸ç›¸ç­‰å†éå† tcls çš„ superclass ä¸ä¼ å…¥çš„ cls è¿›è¡Œæ¯”è¾ƒã€‚éå†è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªç›¸ç­‰å°±ç»“æŸéå†è¿”å› YESï¼Œéå†ç»“æŸåæ²¡æœ‰æ‰¾åˆ°ç›¸ç­‰çš„ç±»å°±è¿”å› NOã€‚</p>
</li>
</ul>
<h3 id="isMemberOfClass-å’Œ-isKindOfClass"><a href="#isMemberOfClass-å’Œ-isKindOfClass" class="headerlink" title="+isMemberOfClass: å’Œ +isKindOfClass:"></a>+isMemberOfClass: å’Œ +isKindOfClass:</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">BOOL</span> res1 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];   <span class="comment">//1</span></div><div class="line">        <span class="built_in">BOOL</span> res2 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]; <span class="comment">//2</span></div><div class="line">        <span class="built_in">BOOL</span> res3 = [[Person <span class="keyword">class</span>] isKindOfClass:[Person <span class="keyword">class</span>]];       <span class="comment">//3</span></div><div class="line">        <span class="built_in">BOOL</span> res4 = [[Person <span class="keyword">class</span>] isMemberOfClass:[Person <span class="keyword">class</span>]];     <span class="comment">//4</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d"</span>, res1, res2, res3, res4);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœè§£æï¼š<br><code>+isKindOfClass:</code> æ–¹æ³•ï¼Œå…ˆé€šè¿‡ self-&gt;ISA() æ‰¾åˆ° NSObject å…ƒç±»å¯¹è±¡ï¼Œä¸ç­‰äº NSObject ç±»å¯¹è±¡ã€‚å†é€šè¿‡ NSObject å…ƒç±»å¯¹è±¡çš„ superclass æŒ‡é’ˆæ‰¾åˆ° NSObject ç±»å¯¹è±¡ï¼Œç­‰äº NSObject ç±»å¯¹è±¡ã€‚æ‰€ä»¥ç»“æœç­‰äº YESï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//1</span></div><div class="line"></div><div class="line"><span class="comment">//ç­‰äº</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [<span class="built_in">NSObject</span> isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>+isMemberOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ self-&gt;ISA() æ‰¾åˆ° NSObject å…ƒç±»å¯¹è±¡ï¼Œä¸ç­‰äº NSObject ç±»å¯¹è±¡ã€‚æ‰€ä»¥ç»“æœç­‰äº NOï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//0</span></div><div class="line"><span class="comment">//ç­‰äº</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [<span class="built_in">NSObject</span> isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<p><code>+isKindOfClass:</code> æ–¹æ³•ï¼Œå…ˆé€šè¿‡ self-&gt;ISA() æ‰¾åˆ° Person å…ƒç±»å¯¹è±¡ï¼Œä¸ç­‰äº Person ç±»å¯¹è±¡ã€‚å†é€šè¿‡ Person å…ƒç±»å¯¹è±¡çš„ superclass æŒ‡é’ˆæ‰¾åˆ° NSObject å…ƒç±»å¯¹è±¡ï¼Œä¸ç­‰äº Person ç±»å¯¹è±¡ã€‚å†é€šè¿‡ NSObject å…ƒç±»å¯¹è±¡çš„ superclass æŒ‡é’ˆæ‰¾åˆ° NSObject ç±»å¯¹è±¡ï¼Œä¸ç­‰äº Person ç±»å¯¹è±¡ã€‚æ‰€ä»¥ç»“æœç­‰äº NOï¼š<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>] <span class="title">isKindOfClass</span></span>:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div><div class="line"><span class="comment">//ç­‰äº</span></div><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="type">Person</span> isKindOfClass:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<p><code>+isMemberOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ self-&gt;ISA() æ‰¾åˆ° Person å…ƒç±»å¯¹è±¡ï¼Œä¸ç­‰äº Person ç±»å¯¹è±¡ã€‚æ‰€ä»¥ç»“æœç­‰äº NOï¼š<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>] <span class="title">isMemberOfClass</span></span>:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div><div class="line"><span class="comment">//ç­‰äº</span></div><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="type">Person</span> isMemberOfClass:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<h4 id="å°ç»“-3"><a href="#å°ç»“-3" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å› ä¸ºå½“ç±»å¯¹è±¡è°ƒç”¨ç±»æ–¹æ³• <code>+isMemberOfClass:</code> å’Œ <code>+isKindOfClass:</code> æ—¶ï¼Œæ˜¯æ‹¿ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡è·Ÿä¼ å…¥çš„å¯¹è±¡åšå¯¹æ¯”ï¼Œæ‰€ä»¥é™¤ NSObject å¤–ï¼Œå…¶å®ƒç±»å¯¹è±¡è°ƒç”¨è¿™ä¸¤ä¸ªç±»æ–¹æ³•æ—¶ï¼Œå³è¾¹ä¼ å…¥çš„è‡³å°‘åº”è¯¥æ˜¯å…ƒç±»å¯¹è±¡æ‰æœ‰æ„ä¹‰ã€‚</p>
<h3 id="isMemberOfClass-å’Œ-isKindOfClass-1"><a href="#isMemberOfClass-å’Œ-isKindOfClass-1" class="headerlink" title="-isMemberOfClass: å’Œ -isKindOfClass:"></a>-isMemberOfClass: å’Œ -isKindOfClass:</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        <span class="built_in">NSObject</span> *object = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">        <span class="built_in">BOOL</span> res5 = [object isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res6 = [object isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res7 = [person isKindOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res8 = [person isMemberOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d"</span>, res5, res6, res7, res8);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p><code>-isKindOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ [self class] æ‰¾åˆ° NSObject ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœç­‰äº YESï¼š<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="class"><span class="keyword">object</span> <span class="title">isKindOfClass</span></span>:[<span class="type">NSObject</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isMemberOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ [self class] æ‰¾åˆ° NSObject ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœç­‰äº YESï¼š<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="class"><span class="keyword">object</span> <span class="title">isMemberOfClass</span></span>:[<span class="type">NSObject</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isKindOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ [self class] æ‰¾åˆ° Person ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœç­‰äº YESï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"%d"</span>, [person <span class="attribute">isKindOfClass</span>:[Person class]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isMemberOfClass:</code> æ–¹æ³•ï¼Œé€šè¿‡ [self class] æ‰¾åˆ° Person ç±»å¯¹è±¡ï¼Œæ‰€ä»¥ç»“æœç­‰äº YESï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"%d"</span>, [person <span class="attribute">isMemberOfClass</span>:[Person class]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<h4 id="å°ç»“-4"><a href="#å°ç»“-4" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å› ä¸ºå½“å®ä¾‹å¯¹è±¡è°ƒç”¨å¯¹è±¡æ–¹æ³• <code>-isMemberOfClass:</code> å’Œ <code>-isKindOfClass:</code> æ—¶ï¼Œæ˜¯æ‹¿å®ä¾‹å¯¹è±¡çš„ç±»å¯¹è±¡è·Ÿä¼ å…¥çš„å¯¹è±¡åšå¯¹æ¯”ï¼Œæ‰€ä»¥åœ¨å®ä¾‹å¯¹è±¡è°ƒç”¨è¿™ä¸¤ä¸ªå¯¹è±¡æ–¹æ³•æ—¶ï¼Œå³è¾¹ä¼ å…¥çš„è‡³å°‘åº”è¯¥æ˜¯ç±»å¯¹è±¡æ‰æœ‰æ„ä¹‰ã€‚</p>
<h2 id="å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†"><a href="#å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†" class="headerlink" title="å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†"></a>å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†</h2><h3 id="æ­£å¸¸è°ƒç”¨"><a href="#æ­£å¸¸è°ƒç”¨" class="headerlink" title="æ­£å¸¸è°ƒç”¨"></a>æ­£å¸¸è°ƒç”¨</h3><p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime32.png" alt="Runtime32"><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person -run %@"</span>, <span class="keyword">self</span>-&gt;_name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    [person run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="builtin-name">run</span> (<span class="literal">null</span>)</div></pre></td></tr></table></figure></p>
<p>æŒ‡é’ˆ person å­˜å‚¨ç€ person å®ä¾‹å¯¹è±¡çš„åœ°å€ï¼ˆperson å®ä¾‹å¯¹è±¡çš„ isa åœ°å€ï¼‰ï¼Œè€Œ person å®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆé‡Œå­˜å‚¨ç€ Person ç±»å¯¹è±¡çš„åœ°å€ï¼ˆPerson ç±»å¯¹è±¡çš„ isa åœ°å€ï¼‰ã€‚<code>[person run]</code> æ˜¯é€šè¿‡ person å®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæ‰¾åˆ° Person ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)run</code> æ–¹æ³•ï¼Œ<code>-(void)run</code> æ–¹æ³•å†…éƒ¨çš„ self å°±æ˜¯æ¶ˆæ¯æ¥æ”¶è€…ï¼ˆperson å®ä¾‹å¯¹è±¡ï¼‰ã€‚person å®ä¾‹å¯¹è±¡å†…éƒ¨å­˜å‚¨ç€ isa æŒ‡é’ˆå’Œæˆå‘˜å˜é‡ï¼Œ<code>self-&gt;_name</code> æ˜¯ä» isa çš„åœ°å€å¼€å§‹åœ¨ person å®ä¾‹å¯¹è±¡çš„å†…å­˜é‡Œå‘ä¸‹æŸ¥æ‰¾æˆå‘˜å˜é‡ _nameã€‚</p>
<h3 id="è‡ªå®šä¹‰è°ƒç”¨"><a href="#è‡ªå®šä¹‰è°ƒç”¨" class="headerlink" title="è‡ªå®šä¹‰è°ƒç”¨"></a>è‡ªå®šä¹‰è°ƒç”¨</h3><p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime33.png" alt="Runtime33"><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person -run %@"</span>, <span class="keyword">self</span>.name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad]; <span class="comment">//é«˜åœ°å€</span></div><div class="line">    </div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="keyword">run</span><span class="bash"> &lt;ViewController: 0x7fd88fb0a400&gt;</span></div></pre></td></tr></table></figure></p>
<p>æ€è€ƒï¼š  </p>
<ol>
<li><code>[(__bridge id)obj run]</code> ä¸ºä»€ä¹ˆèƒ½å¤Ÿè°ƒç”¨æˆåŠŸï¼Ÿ  </li>
<li>ä¸ºä»€ä¹ˆ self.name å˜æˆäº† ViewController?  </li>
</ol>
<p>å±€éƒ¨å˜é‡çš„å†…å­˜åˆ†é…åœ¨æ ˆç©ºé—´ï¼Œä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼š<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> test()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> a = <span class="number">1</span>; <span class="comment">//0x7ffeefbff518ï¼ˆé«˜åœ°å€ï¼‰</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> b = <span class="number">2</span>; <span class="comment">//0x7ffeefbff510   â†“</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> c = <span class="number">3</span>; <span class="comment">//0x7ffeefbff508   â†“</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d = <span class="number">4</span>; <span class="comment">//0x7ffeefbff500ï¼ˆä½åœ°å€ï¼‰</span></div><div class="line">    NSLog(@<span class="string">"%p, %p, %p, %p"</span>, &amp;a, &amp;b, &amp;c, &amp;d);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        test();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x7ffeefbff</span>518, <span class="number">0x7ffeefbff</span>510, <span class="number">0x7ffeefbff</span>508, <span class="number">0x7ffeefbff</span>500</div></pre></td></tr></table></figure></p>
<p>ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ° aã€bã€cã€d çš„å†…å­˜åˆ†é…é¡ºåºæ˜¯ä»é«˜åœ°å€åˆ°ä½åœ°å€ã€‚</p>
<p><code>[(__bridge id)obj run]</code> å›¾è§£ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime35.png" alt="Runtime35"> </p>
<p>å›¾ä¸­å¯ä»¥çœ‹åˆ° objã€cls å’Œ self çš„å†…å­˜éƒ½åˆ†é…åœ¨æ ˆç©ºé—´ï¼Œ<code>[UIViewController class]</code> åœ¨å…¨å±€åŒºï¼Œself çš„åœ°å€å€¼æœ€å¤§ï¼Œobj çš„åœ°å€å€¼æœ€å°ã€‚self å’Œ <code>[UIViewController class]</code> æ¥è‡ª <code>[super viewDidLoad]</code> çš„ç»“æ„ä½“ <code>__rw_objc_super</code>ï¼Œ<code>__rw_objc_super</code> ä¹Ÿæ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">rw_objc_super</span> <span class="title">arg</span> = &#123;</span> </div><div class="line">    self, </div><div class="line">    [ViewController <span class="class"><span class="keyword">class</span>] </span></div><div class="line"><span class="class">&#125;;</span></div><div class="line">objc_msgSendSuper(arg, @selector(viewDidLoad));</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡æ‰“å°å†…å­˜è¿›è¡ŒéªŒè¯ï¼ˆ<code>x/4g</code>ï¼šæ‰“å°4ä¸ªæ•°æ®ï¼Œæ¯ä¸ªæ•°æ®8ä¸ªå­—èŠ‚ï¼‰ï¼š<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x obj</div><div class="line">(Person *) <span class="number">$0</span> = <span class="number">0x00007ffeea236178</span></div><div class="line">(lldb) x/4g <span class="number">0x00007ffeea236178</span></div><div class="line"><span class="number">0x7ffeea236178</span>: <span class="number">0x00000001059cb5c0</span> <span class="number">0x00007fc0cb00a9b0</span></div><div class="line"><span class="number">0x7ffeea236188</span>: <span class="number">0x00000001059cb4f8</span> <span class="number">0x00007fff51ec8b0c</span></div><div class="line">(lldb) p (Class)<span class="number">0x00000001059cb5c0</span></div><div class="line">(Class) <span class="number">$1</span> = Person</div><div class="line">(lldb) po <span class="number">0x00007fc0cb00a9b0</span></div><div class="line">&lt;ViewController: <span class="number">0x7fc0cb00a9b0</span>&gt;</div><div class="line"></div><div class="line">(lldb) p (Class)<span class="number">0x00000001059cb4f8</span></div><div class="line">(Class) <span class="number">$3</span> = ViewController</div></pre></td></tr></table></figure></p>
<p>ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œä¾æ¬¡æ˜¯ Person ç±»å¯¹è±¡ã€<viewcontroller: 0x7fc0cb00a9b0=""> å®åˆ—å¯¹è±¡å’Œ ViewController ç±»å¯¹è±¡ã€‚</viewcontroller:></p>
<p>æ³¨é‡Šæ‰ <code>[super viewDidLoad]</code> å°±ä¼šæŠ¥åå†…å­˜è®¿é—®çš„é”™è¯¯ï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime36.png" alt="Runtime36"></p>
<p>ä¿®æ”¹ ViewController.m å®ç°ï¼Œæ·»åŠ æˆå‘˜å˜é‡ testï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *test = <span class="string">@"123"</span>;</div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="keyword">run</span><span class="bash"> 123</span></div></pre></td></tr></table></figure></p>
<p>æŒ‡é’ˆ obj å­˜å‚¨ç€ cls çš„åœ°å€ï¼Œè€Œ cls å­˜å‚¨ç€ Person ç±»å¯¹è±¡çš„åœ°å€ï¼ˆPerson ç±»å¯¹è±¡çš„ isa åœ°å€ï¼‰ã€‚<code>[(__bridge id)obj run]</code> æ˜¯é€šè¿‡ cls æ‰¾åˆ° Person ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)run</code> æ–¹æ³•ï¼Œ<code>-(void)run</code> æ–¹æ³•å†…éƒ¨çš„ self å°±æ˜¯æ¶ˆæ¯æ¥æ”¶è€… objã€‚ä» obj çš„å†…å­˜å¼€å§‹åœ¨ obj æ‰€åœ¨çš„å†…å­˜ä¸­å‘ä¸‹æŸ¥æ‰¾æˆå‘˜å˜é‡ _nameï¼Œæœ€åæ‰¾åˆ°çš„å´æ˜¯ cls ä¸‹é¢çš„å±€éƒ¨å˜é‡ testï¼š<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime34.png" alt="Runtime34"> </p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ° objã€cls å’Œ test ä¸‰ä¸ªå˜é‡çš„å†…å­˜éƒ½åˆ†é…åœ¨æ ˆç©ºé—´ï¼Œtest çš„åœ°å€å€¼æœ€å¤§ï¼Œobj çš„åœ°å€å€¼æœ€å°ã€‚</p>
<ul>
<li><code>[(__bridge id)obj run]</code> ä¸ºä»€ä¹ˆèƒ½å¤Ÿè°ƒç”¨æˆåŠŸï¼Ÿ<br>å› ä¸ºæŒ‡é’ˆ obj å­˜å‚¨ç€ cls çš„åœ°å€ï¼Œè€Œ cls å­˜å‚¨ç€ Person ç±»å¯¹è±¡çš„åœ°å€ï¼ˆPerson ç±»å¯¹è±¡çš„ isa åœ°å€ï¼‰ï¼Œæ‰€ä»¥ <code>[(__bridge id)obj run]</code> æ˜¯é€šè¿‡ cls æ‰¾åˆ° Person ç±»å¯¹è±¡æŸ¥æ‰¾ <code>-(void)run</code> æ–¹æ³•(è¿™é‡Œçš„ cls ç›¸å½“äº person å®ä¾‹å¯¹è±¡çš„ isa)ã€‚</li>
<li>ä¸ºä»€ä¹ˆ self.name å˜æˆäº† ViewControllerï¼Ÿ<br>å› ä¸º <code>-(void)run</code> æ–¹æ³•å†…éƒ¨çš„ self å°±æ˜¯æ¶ˆæ¯æ¥æ”¶è€… objï¼Œ<code>obj-&gt;_name</code> æ˜¯åœ¨ obj æ‰€åœ¨çš„å†…å­˜ä¸­ä» obj çš„åœ°å€å¼€å§‹å‘ä¸‹æŸ¥æ‰¾æˆå‘˜å˜é‡ _nameï¼Œè€Œ obj æ‰€åœ¨çš„å†…å­˜ï¼ˆæ ˆåŒºï¼‰å‘ä¸‹æ‰¾åˆ°çš„æ˜¯ cls ä¸‹é¢çš„æŒ‡é’ˆ selfï¼ˆViewController å®ä¾‹å¯¹è±¡ï¼‰ï¼Œæ‰€ä»¥æœ€ç»ˆçš„æ‰“å°ç»“æœæ˜¯ <code>&lt;ViewController: 0x7fd88fb0a400&gt;</code>ã€‚</li>
</ul>
<h1 id="Runtime-API"><a href="#Runtime-API" class="headerlink" title="Runtime API"></a>Runtime API</h1><h2 id="ç±»"><a href="#ç±»" class="headerlink" title="ç±»"></a>ç±»</h2><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</code></td>
<td>åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼ˆå‚æ•°ï¼šçˆ¶ç±»ï¼Œç±»åï¼Œé¢å¤–çš„å†…å­˜ç©ºé—´ï¼‰</td>
</tr>
<tr>
<td><code>void objc_registerClassPair(Class cls)</code></td>
<td>æ³¨å†Œä¸€ä¸ªç±»ï¼ˆè¦åœ¨ç±»æ³¨å†Œä¹‹å‰æ·»åŠ æˆå‘˜å˜é‡ï¼‰</td>
</tr>
<tr>
<td><code>void objc_disposeClassPair(Class cls)</code></td>
<td>é”€æ¯ä¸€ä¸ªç±»</td>
</tr>
<tr>
<td><code>Class object_getClass(id obj)</code></td>
<td>è·å– isa æŒ‡å‘çš„ Class</td>
</tr>
<tr>
<td><code>Class object_setClass(id obj, Class cls)</code></td>
<td>è®¾ç½® isa æŒ‡å‘çš„ Class</td>
</tr>
<tr>
<td><code>BOOL object_isClass(id obj)</code></td>
<td>åˆ¤æ–­ä¸€ä¸ª OC å¯¹è±¡æ˜¯å¦ä¸º Class</td>
</tr>
<tr>
<td><code>BOOL class_isMetaClass(Class cls)</code></td>
<td>åˆ¤æ–­ä¸€ä¸ª Class æ˜¯å¦ä¸ºå…ƒç±»</td>
</tr>
<tr>
<td><code>Class class_getSuperclass(Class cls)</code></td>
<td>è·å–çˆ¶ç±»</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼Œæ³¨å†Œä¸€ä¸ªç±»"</span>);</div><div class="line">        Class Teacher = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">"Teacher"</span>, <span class="number">0</span>); <span class="comment">//åˆ›å»ºç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡</span></div><div class="line">        objc_registerClassPair(Teacher); <span class="comment">//æ³¨å†Œç±»</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Teacher çš„å†…å­˜å¤§å°%zdä¸ªå­—èŠ‚"</span>, class_getInstanceSize(Teacher)); <span class="comment">//8ä¸ªå­—èŠ‚</span></div><div class="line">        </div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å– isa æŒ‡å‘çš„ Class"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ç±»å¯¹è±¡ï¼š%pï¼Œç±»å¯¹è±¡ï¼š%p"</span>, [Person <span class="keyword">class</span>], object_getClass(person));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ç±»å¯¹è±¡ï¼š%pï¼Œå…ƒç±»å¯¹è±¡ï¼š%p"</span>, [Person <span class="keyword">class</span>], object_getClass([Person <span class="keyword">class</span>]));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è®¾ç½® isa æŒ‡å‘çš„ Class"</span>);</div><div class="line">        object_setClass(person, [Student <span class="keyword">class</span>]);</div><div class="line">        [person run]; <span class="comment">//è¿™é‡Œçš„ Person æ˜¯ (Student *) ç±»å‹ï¼Œisa æŒ‡å‘ Student ç±»å¯¹è±¡</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åˆ¤æ–­ä¸€ä¸ª OC å¯¹è±¡æ˜¯å¦ä¸º Class"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>, object_isClass(person), object_isClass([Person <span class="keyword">class</span>]), object_isClass(object_getClass([Person <span class="keyword">class</span>]))); <span class="comment">//å…ƒç±»å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å¯¹è±¡</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åˆ¤æ–­ä¸€ä¸ª Class æ˜¯å¦ä¸ºå…ƒç±»"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d"</span>, class_isMetaClass([Person <span class="keyword">class</span>]), class_isMetaClass(object_getClass([Person <span class="keyword">class</span>]))); <span class="comment">//å…ƒç±»å¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å¯¹è±¡</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å–çˆ¶ç±»"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@ç±»å¯¹è±¡ï¼š%p, %@å…ƒç±»å¯¹è±¡ï¼š%p"</span>, class_getSuperclass([Person <span class="keyword">class</span>]), class_getSuperclass([Person <span class="keyword">class</span>]),</div><div class="line">            class_getSuperclass(object_getClass([Person <span class="keyword">class</span>])), class_getSuperclass(object_getClass([Person <span class="keyword">class</span>])));</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//é”€æ¯ä¸€ä¸ªç±»"</span>);</div><div class="line">        <span class="keyword">id</span> teacher2 = [[Teacher alloc] init];</div><div class="line">        <span class="comment">//    person = nil; </span></div><div class="line">        <span class="comment">//    teacher = nil; </span></div><div class="line">        teacher2 = <span class="literal">nil</span>; <span class="comment">//å®ä¾‹ä¸­åªè¦æœ‰ä¸€ä¸ªç½®ä¸º nilï¼Œå°±å¯ä»¥è°ƒç”¨äº†ï¼â“</span></div><div class="line">        objc_disposeClassPair(Teacher); <span class="comment">//å½“ç±»æˆ–è€…å®ƒçš„å­ç±»çš„å®ä¾‹è¿˜å­˜åœ¨ï¼Œåˆ™ä¸èƒ½è°ƒç”¨ objc_disposeClassPair æ–¹æ³•</span></div><div class="line">        objc_disposeClassPair(Teacher); <span class="comment">//æŠ¥é”™â€œAttempt to use unknown class 0x1030b92a0.â€</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼Œæ³¨å†Œä¸€ä¸ªç±»</span></div><div class="line"><span class="ruby">Teacher çš„å†…å­˜å¤§å°<span class="number">8</span>ä¸ªå­—èŠ‚</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è·å– isa æŒ‡å‘çš„ Class</span></div><div class="line"><span class="ruby">ç±»å¯¹è±¡ï¼š<span class="number">0x100003228</span>ï¼Œç±»å¯¹è±¡ï¼š<span class="number">0x100003228</span></span></div><div class="line"><span class="ruby">ç±»å¯¹è±¡ï¼š<span class="number">0x100003228</span>ï¼Œå…ƒç±»å¯¹è±¡ï¼š<span class="number">0x100003200</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è®¾ç½® isa æŒ‡å‘çš„ Class</span></div><div class="line"><span class="ruby">-[Student run]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>åˆ¤æ–­ä¸€ä¸ª OC å¯¹è±¡æ˜¯å¦ä¸º Class</span></div><div class="line"><span class="ruby"><span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>åˆ¤æ–­ä¸€ä¸ª Class æ˜¯å¦ä¸ºå…ƒç±»</span></div><div class="line"><span class="ruby"><span class="number">0</span> <span class="number">1</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è·å–çˆ¶ç±»</span></div><div class="line"><span class="ruby">NSObjectç±»å¯¹è±¡ï¼š<span class="number">0x7fff94b06118</span>, NSObjectå…ƒç±»å¯¹è±¡ï¼š<span class="number">0x7fff94b060f0</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>é”€æ¯ä¸€ä¸ªç±»</span></div><div class="line"><span class="ruby">objc[<span class="number">15858</span>]: Attempt to use unknown <span class="class"><span class="keyword">class</span> 0<span class="title">x102905440</span>.</span></span></div></pre></td></tr></table></figure></p>
<h2 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h2><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ivar class_getInstanceVariable(Class cls, const char *name)</code></td>
<td>è·å–ä¸€ä¸ªå®ä¾‹å˜é‡ä¿¡æ¯</td>
</tr>
<tr>
<td><code>Ivar *class_copyIvarList(Class cls, unsigned int *outCount)</code></td>
<td>æ‹·è´å®ä¾‹å˜é‡åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰</td>
</tr>
<tr>
<td><code>void object_setIvar(id obj, Ivar ivar, id value)</code></td>
<td>è®¾ç½®æˆå‘˜å˜é‡çš„å€¼</td>
</tr>
<tr>
<td><code>id object_getIvar(id obj, Ivar ivar)</code></td>
<td>è·å–æˆå‘˜å˜é‡çš„å€¼</td>
</tr>
<tr>
<td><code>BOOL class_addIvar(Class cls, const char * name, size_t size, uint8_t alignment, const char * types)</code></td>
<td>åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå·²ç»æ³¨å†Œçš„ç±»æ˜¯ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡çš„ï¼‰</td>
</tr>
<tr>
<td><code>const char *ivar_getName(Ivar v)</code></td>
<td>è·å–æˆå‘˜å˜é‡çš„åå­—</td>
</tr>
<tr>
<td><code>const char *ivar_getTypeEncoding(Ivar v)</code></td>
<td>è·å–æˆå‘˜å˜é‡çš„ç±»å‹ç¼–ç </td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå·²ç»æ³¨å†Œçš„ç±»æ˜¯ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡çš„ï¼‰"</span>);</div><div class="line">        Class Teacher = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">"Teacher"</span>, <span class="number">0</span>); <span class="comment">//åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼ˆåŒ…æ‹¬ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡ï¼Œå‚æ•°ï¼šçˆ¶ç±»ï¼Œç±»åï¼Œé¢å¤–çš„å†…å­˜ç©ºé—´ï¼‰</span></div><div class="line">        </div><div class="line">        class_addIvar(Teacher, <span class="string">"_age"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="keyword">@encode</span>(<span class="keyword">int</span>)); <span class="comment">//åœ¨ç±»æ³¨å†Œä¹‹å‰æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå› ä¸ºç±»çš„æˆå‘˜å˜é‡åˆ—è¡¨æ˜¯åªè¯»çš„ï¼Œæ‰€æœ‰ç±»ä¸€æ—¦æ³¨å†Œåå°±ä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡åˆ—è¡¨äº†ï¼‰</span></div><div class="line">        class_addIvar(Teacher, <span class="string">"_weight"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="keyword">@encode</span>(<span class="keyword">int</span>));</div><div class="line"></div><div class="line">        <span class="comment">//æ·»åŠ æ–¹æ³•æ˜¯éšæ—¶å¯ä»¥æ“ä½œçš„ï¼Œæœ€å¥½æ˜¯å†™åœ¨æ³¨å†Œç±»å‰ï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°</span></div><div class="line">        class_addMethod(Teacher, <span class="keyword">@selector</span>(run), (IMP)run, <span class="string">"v@:"</span>);</div><div class="line">        </div><div class="line">        objc_registerClassPair(Teacher); <span class="comment">//æ³¨å†Œç±»</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, class_getInstanceSize(Teacher)); <span class="comment">//isa(8ä¸ªå­—èŠ‚) + _age(4ä¸ªå­—èŠ‚) + _weight(4ä¸ªå­—èŠ‚) = 16ä¸ªå­—èŠ‚</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//ä¿®æ”¹/è·å–æˆå‘˜å˜é‡çš„å€¼"</span>);</div><div class="line">        <span class="keyword">id</span> teacher = [[Teacher alloc] init];</div><div class="line">        [teacher setValue:@<span class="number">10</span> forKey:<span class="string">@"_age"</span>];</div><div class="line">        [teacher setValue:@<span class="number">20</span> forKey:<span class="string">@"_weight"</span>];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"_ageï¼š%@, _weightï¼š%@"</span>, [teacher valueForKey:<span class="string">@"_age"</span>], [teacher valueForKey:<span class="string">@"_weight"</span>]);</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è°ƒç”¨æ·»åŠ çš„æ–¹æ³•"</span>);</div><div class="line">        [teacher run];</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è®¾ç½® isa æŒ‡å‘çš„ Class"</span>);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        object_setClass(person, Teacher);</div><div class="line">        [person run];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å–æˆå‘˜å˜é‡çš„ç›¸å…³ä¿¡æ¯"</span>);</div><div class="line">        Ivar ageIvar = class_getInstanceVariable([Person <span class="keyword">class</span>], <span class="string">"_age"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, ivar_getName(ageIvar), ivar_getTypeEncoding(ageIvar));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è®¾ç½®å’Œè·å–æˆå‘˜å˜é‡çš„å€¼"</span>);</div><div class="line">        Ivar nameIvar = class_getInstanceVariable([Person <span class="keyword">class</span>], <span class="string">"_name"</span>);</div><div class="line">        Person *person2 = [[Person alloc] init];</div><div class="line">        object_setIvar(person2, nameIvar, <span class="string">@"name"</span>); <span class="comment">//è®¾ç½® _name</span></div><div class="line">        object_setIvar(person2, ageIvar, (__bridge <span class="keyword">id</span>)(<span class="keyword">void</span> *)<span class="number">10</span>); <span class="comment">//è®¾ç½® _ageï¼ˆä½¿ç”¨ runtime æ–¹æ³•ï¼Œåº•å±‚æ²¡æœ‰è½¬æ¢ç›´æ¥èµ‹å€¼ï¼Œå…ˆè½¬æˆæŒ‡é’ˆå˜é‡ï¼Œå†è½¬æˆ id ç±»å‹çš„å¯¹è±¡ï¼‰</span></div><div class="line">        <span class="comment">//[person2 setValue:@10 forKey:@"age"]; //NSNumber ç±»å‹çš„ 10 åœ¨èµ‹å€¼ç»™ age æ—¶ä¼šè½¬æˆ int ç±»å‹</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, object_getIvar(person2, nameIvar)); <span class="comment">//è·å– _name</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ‹·è´å®ä¾‹å˜é‡åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰+ è·å–æˆå‘˜å˜é‡çš„ç›¸å…³ä¿¡æ¯"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        Ivar *ivars = class_copyIvarList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            Ivar ivar = ivars[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, ivar_getName(ivar), ivar_getTypeEncoding(ivar));</div><div class="line">        &#125;</div><div class="line">        free(ivars);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨ <code>object_setIvar()</code> æ–¹æ³•è®¾ç½® int ç±»å‹çš„æˆå‘˜å˜é‡æ—¶ï¼Œå› ä¸ºæ•°å€¼ä¸èƒ½ç›´æ¥è½¬ä¸ºå¯¹è±¡ï¼Œæ‰€ä»¥å…ˆå°†æ•°å€¼è½¬æˆæŒ‡é’ˆï¼ˆæŒ‡é’ˆæ˜¯ç”¨æ¥å­˜å€¼çš„ï¼‰ï¼Œå†å°†æŒ‡é’ˆè½¬æˆ id ç±»å‹çš„å¯¹è±¡ã€‚</p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå·²ç»æ³¨å†Œçš„ç±»æ˜¯ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡çš„ï¼‰</span></div><div class="line"><span class="ruby"><span class="number">16</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>ä¿®æ”¹/è·å–æˆå‘˜å˜é‡çš„å€¼</span></div><div class="line"><span class="ruby">_ageï¼š<span class="number">10</span>, _weightï¼š<span class="number">20</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è°ƒç”¨æ·»åŠ çš„æ–¹æ³•</span></div><div class="line"><span class="ruby">&lt;<span class="symbol">Teacher:</span> <span class="number">0x100525bc0</span>&gt; - run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è®¾ç½® isa æŒ‡å‘çš„ Class</span></div><div class="line"><span class="ruby">&lt;<span class="symbol">Teacher:</span> <span class="number">0x10041dda0</span>&gt; - run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è·å–æˆå‘˜å˜é‡çš„ç›¸å…³ä¿¡æ¯</span></div><div class="line"><span class="ruby">_age i</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è®¾ç½®å’Œè·å–æˆå‘˜å˜é‡çš„å€¼</span></div><div class="line"><span class="ruby">name <span class="number">10</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ‹·è´å®ä¾‹å˜é‡åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰+ è·å–æˆå‘˜å˜é‡çš„ç›¸å…³ä¿¡æ¯</span></div><div class="line"><span class="ruby">_age i</span></div><div class="line"><span class="ruby">_name @<span class="string">"NSString"</span></span></div></pre></td></tr></table></figure></p>
<h2 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h2><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>objc_property_t class_getProperty(Class cls, const char *name)</code></td>
<td>è·å–ä¸€ä¸ªå±æ€§</td>
</tr>
<tr>
<td><code>objc_property_t *class_copyPropertyList(Class cls, unsigned int *outCount)</code></td>
<td>æ‹·è´å±æ€§åˆ—è¡¨</td>
</tr>
<tr>
<td><code>BOOL class_addProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</code></td>
<td>åŠ¨æ€æ·»åŠ å±æ€§</td>
</tr>
<tr>
<td><code>void class_replaceProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</code></td>
<td>åŠ¨æ€æ›¿æ¢å±æ€§</td>
</tr>
<tr>
<td><code>const char *property_getName(objc_property_t property)</code></td>
<td>è·å–å±æ€§å</td>
</tr>
<tr>
<td><code>const char *property_getAttributes(objc_property_t property)</code></td>
<td>è·å–å±æ€§çš„çœŸå®ç±»å‹</td>
</tr>
</tbody>
</table>
<p><code>test3()</code> å®ç°ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å–ä¸€ä¸ªå±æ€§"</span>);</div><div class="line">        objc_property_t name = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, property_getName(name));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ‹·è´å±æ€§åˆ—è¡¨"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        objc_property_t *propertys = class_copyPropertyList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            objc_property_t property = propertys[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(property), property_getAttributes(property));<span class="comment">//T åé¢æ˜¯è¯¥å±æ€§çš„æ•°æ®ç±»å‹ã€‚V åé¢æ˜¯è¯¥å±æ€§çš„å˜é‡åç§°ã€‚N æ˜¯å±æ€§çš„éåŸå­å±æ€§ nonatomic çš„æ ‡è¯†ã€‚C æ˜¯å±æ€§çš„ copy æ ‡è¯†ã€‚</span></div><div class="line">        &#125;</div><div class="line">        free(propertys);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€æ·»åŠ å±æ€§"</span>);</div><div class="line">        objc_property_attribute_t type = &#123; <span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;; <span class="comment">//æ•°æ®ç±»å‹</span></div><div class="line">        objc_property_attribute_t ownership1 = &#123; <span class="string">"C"</span>, <span class="string">""</span>&#125;; <span class="comment">//copy</span></div><div class="line">        objc_property_attribute_t ownership2 = &#123; <span class="string">"N"</span>, <span class="string">""</span>&#125;; <span class="comment">//nonatomic</span></div><div class="line">        objc_property_attribute_t backingivar = &#123; <span class="string">"V"</span>, <span class="string">"_newName"</span>&#125;; <span class="comment">//_newName</span></div><div class="line">        objc_property_attribute_t attrs[] = &#123;type, ownership1, ownership2, backingivar&#125;;</div><div class="line">        class_addProperty([Person <span class="keyword">class</span>], <span class="string">"newName"</span>, attrs, <span class="number">4</span>);</div><div class="line">        objc_property_t newName = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"newName"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(newName), property_getAttributes(newName));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€æ›¿æ¢å±æ€§"</span>);</div><div class="line">        objc_property_attribute_t type1 = &#123; <span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;; <span class="comment">//æ•°æ®ç±»å‹</span></div><div class="line">        objc_property_attribute_t ownership3 = &#123; <span class="string">"C"</span>, <span class="string">""</span>&#125;; <span class="comment">//copy</span></div><div class="line">        objc_property_attribute_t ownership4 = &#123; <span class="string">"N"</span>, <span class="string">""</span>&#125;; <span class="comment">//nonatomic</span></div><div class="line">        objc_property_attribute_t backingivar1 = &#123; <span class="string">"V"</span>, <span class="string">"_replaceName"</span>&#125;; <span class="comment">//_newName</span></div><div class="line">        objc_property_attribute_t attrs1[] = &#123;type1, ownership3, ownership4, backingivar1&#125;;</div><div class="line">        class_replaceProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>, attrs1, <span class="number">4</span>);</div><div class="line">        objc_property_t replaceName = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(replaceName), property_getAttributes(replaceName));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ‹·è´å±æ€§åˆ—è¡¨"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count1;</div><div class="line">        objc_property_t *propertys1 = class_copyPropertyList([Person <span class="keyword">class</span>], &amp;count1);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count1; i++) &#123;</div><div class="line">            objc_property_t property = propertys1[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(property), property_getAttributes(property));<span class="comment">//T åé¢æ˜¯è¯¥å±æ€§çš„æ•°æ®ç±»å‹ã€‚V åé¢æ˜¯è¯¥å±æ€§çš„å˜é‡åç§°ã€‚N æ˜¯å±æ€§çš„éåŸå­å±æ€§ nonatomic çš„æ ‡è¯†ã€‚C æ˜¯å±æ€§çš„ copy æ ‡è¯†ã€‚</span></div><div class="line">        &#125;</div><div class="line">        free(propertys1);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">---------------------------------------//è·å–ä¸€ä¸ªå±æ€§</div><div class="line">name</div><div class="line">---------------------------------------//æ‹·è´å±æ€§åˆ—è¡¨</div><div class="line">ID Ti,<span class="built_in">N</span>,V_ID</div><div class="line">age Ti,<span class="built_in">N</span>,V_age</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_name</div><div class="line">---------------------------------------//åŠ¨æ€æ·»åŠ å±æ€§</div><div class="line">newName <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_newName</div><div class="line">---------------------------------------//åŠ¨æ€æ›¿æ¢å±æ€§</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_replaceName</div><div class="line">---------------------------------------//æ‹·è´å±æ€§åˆ—è¡¨</div><div class="line">newName <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_newName</div><div class="line">ID Ti,<span class="built_in">N</span>,V_ID</div><div class="line">age Ti,<span class="built_in">N</span>,V_age</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_replaceName</div></pre></td></tr></table></figure></p>
<p>T åé¢æ˜¯è¯¥å±æ€§çš„æ•°æ®ç±»å‹ã€‚V åé¢æ˜¯è¯¥å±æ€§çš„å˜é‡åç§°ã€‚N æ˜¯å±æ€§çš„éåŸå­å±æ€§ nonatomic çš„æ ‡è¯†ã€‚C æ˜¯å±æ€§çš„ copy æ ‡è¯†ã€‚</p>
<p>å…³äº <code>property_getAttributes()</code> è·å–åˆ°çš„ç»“æœï¼Œå¯ä»¥å‚è€ƒ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW1" target="_blank" rel="external">Declared Properties</a>ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime38.png" alt="Runtime38"></p>
<p><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime39.png" alt="Runtime39"></p>
<h2 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h2><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ³¨é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Method class_getInstanceMethod(Class cls, SEL name)</code></td>
<td>è·å¾—ä¸€ä¸ªå®ä¾‹æ–¹æ³•</td>
</tr>
<tr>
<td><code>Method class_getClassMethod(Class cls, SEL name)</code></td>
<td>è·å¾—ä¸€ä¸ªç±»æ–¹æ³•</td>
</tr>
<tr>
<td><code>IMP class_getMethodImplementation(Class cls, SEL name)</code></td>
<td>æ ¹æ® Class å’Œ SEL è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ</td>
</tr>
<tr>
<td><code>IMP method_setImplementation(Method m, IMP imp)</code></td>
<td>ä¿®æ”¹æ–¹æ³•çš„ imp æŒ‡é’ˆ</td>
</tr>
<tr>
<td><code>void method_exchangeImplementations(Method m1, Method m2)</code></td>
<td>äº¤æ¢æ–¹æ³•çš„ imp æŒ‡é’ˆ</td>
</tr>
<tr>
<td><code>Method *class_copyMethodList(Class cls, unsigned int *outCount)</code></td>
<td>æ‹·è´æ–¹æ³•åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰</td>
</tr>
<tr>
<td><code>BOOL class_addMethod(Class cls, SEL name, IMP imp, const char *types)</code></td>
<td>åŠ¨æ€æ·»åŠ æ–¹æ³•</td>
</tr>
<tr>
<td><code>IMP class_replaceMethod(Class cls, SEL name, IMP imp, const char *types)</code></td>
<td>åŠ¨æ€æ›¿æ¢æ–¹æ³•</td>
</tr>
<tr>
<td><code>SEL method_getName(Method m)</code></td>
<td>è·å–æ–¹æ³•å</td>
</tr>
<tr>
<td><code>IMP method_getImplementation(Method m)</code></td>
<td>æ ¹æ® Method è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ</td>
</tr>
<tr>
<td><code>const char *method_getTypeEncoding(Method m)</code></td>
<td>è·å–æ–¹æ³•çš„ç±»å‹ç¼–ç </td>
</tr>
<tr>
<td><code>unsigned int method_getNumberOfArguments(Method m)</code></td>
<td>æ ¹æ® Method è·å–æ–¹æ³•çš„å‚æ•°ä¸ªæ•°</td>
</tr>
<tr>
<td><code>char *method_copyReturnType(Method m)</code></td>
<td>æ ¹æ® Method è·å–æ–¹æ³•çš„è¿”å›å€¼çš„ç±»å‹ç¼–ç ï¼ˆå¸¦æœ‰copyçš„éœ€è¦è°ƒç”¨freeå»é‡Šæ”¾ï¼‰</td>
</tr>
<tr>
<td><code>char *method_copyArgumentType(Method m, unsigned int index)</code></td>
<td>æ ¹æ® Method è·å–æ–¹æ³•çš„ç´¢å¼•ä½ç½®çš„å‚æ•°çš„ç±»å‹ç¼–ç ï¼ˆå¸¦æœ‰copyçš„éœ€è¦è°ƒç”¨freeå»é‡Šæ”¾ï¼‰</td>
</tr>
<tr>
<td><code>const char *sel_getName(SEL sel)</code></td>
<td>æ ¹æ® SEL è·å–æ–¹æ³•çš„åç§°</td>
</tr>
<tr>
<td><code>SEL sel_registerName(const char *str)</code></td>
<td>æ ¹æ®æ–¹æ³•åæ³¨å†Œ SEL</td>
</tr>
<tr>
<td><code>IMP imp_implementationWithBlock(id block)</code></td>
<td>ç”¨ block ä½œä¸ºæ–¹æ³•å®ç°</td>
</tr>
<tr>
<td><code>id imp_getBlock(IMP anImp)</code></td>
<td>æ ¹æ® block çš„ IMP ç”Ÿæˆ block å¯¹è±¡</td>
</tr>
<tr>
<td><code>BOOL imp_removeBlock(IMP anImp)</code></td>
<td>ç§»é™¤ imp_implementationWithBlock() ç”Ÿæˆçš„ IMP</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">void</span>)personRun;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run2;</div><div class="line">- (<span class="keyword">void</span>)test2;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run3;</div><div class="line">- (<span class="keyword">void</span>)test3;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)run4:(<span class="keyword">int</span>)age name:(<span class="built_in">NSString</span> *)name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">void</span>)personRun</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run2</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test2</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run3</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test3</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)run4:(<span class="keyword">int</span>)age name:(<span class="built_in">NSString</span> *)name</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> newRun()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"newRun"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> newTest()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"newTest"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^Block)(<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å¾—ä¸€ä¸ªå®ä¾‹æ–¹æ³•"</span>);</div><div class="line">        Method runMethod = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(runMethod)));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//è·å¾—ä¸€ä¸ªç±»æ–¹æ³•"</span>);</div><div class="line">        Method personRunMethod = class_getClassMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(personRun));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(personRunMethod)));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Class å’Œ SEL è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ"</span>);</div><div class="line">        IMP runIMP = class_getMethodImplementation([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, runIMP);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//ä¿®æ”¹æ–¹æ³•çš„ imp æŒ‡é’ˆ"</span>);</div><div class="line">        IMP testIMP = class_getMethodImplementation([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test));</div><div class="line">        method_setImplementation(runMethod, testIMP);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person run]; <span class="comment">//è°ƒç”¨ -test</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//äº¤æ¢æ–¹æ³•çš„ imp æŒ‡é’ˆ"</span>);</div><div class="line">        Method run2Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run2));</div><div class="line">        Method testMethod = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test2));</div><div class="line">        method_exchangeImplementations(runMethod, testMethod);</div><div class="line">        [person run2];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€æ·»åŠ æ–¹æ³•"</span>);</div><div class="line">        class_addMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(newRun), (IMP)newRun, <span class="string">"v@:"</span>);</div><div class="line">        [person performSelector:<span class="keyword">@selector</span>(newRun)];</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ‹·è´æ–¹æ³•åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        Method *methods = class_copyMethodList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            Method aMethod = methods[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(aMethod)));</div><div class="line">        &#125;</div><div class="line">        free(methods);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//åŠ¨æ€æ›¿æ¢æ–¹æ³•"</span>);</div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test3), (IMP)newTest, <span class="string">"v@:"</span>);</div><div class="line">        [person test3];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Method è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ"</span>);</div><div class="line">        Method run3Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run3));</div><div class="line">        IMP runIMP3 = method_getImplementation(run3Method);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, runIMP3);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Method è·å–æ–¹æ³•çš„ç±»å‹ç¼–ç "</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, method_getTypeEncoding(run3Method));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Method è·å–æ–¹æ³•çš„å‚æ•°ä¸ªæ•°"</span>);</div><div class="line">        Method run4Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run4:name:));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, method_getNumberOfArguments(run4Method)); <span class="comment">//selfã€_cmdã€age å’Œ name</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Method è·å–æ–¹æ³•çš„è¿”å›å€¼çš„ç±»å‹ç¼–ç "</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *returnType = method_copyReturnType(run4Method);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:returnType encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        free((<span class="keyword">void</span> *)returnType);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® Method è·å–æ–¹æ³•çš„ç´¢å¼•ä½ç½®çš„å‚æ•°çš„ç±»å‹ç¼–ç "</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *argumentType = method_copyArgumentType(run4Method, <span class="number">3</span>); <span class="comment">//nameï¼š@</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:argumentType encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        free((<span class="keyword">void</span> *)argumentType);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® SEL è·å–æ–¹æ³•å"</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(<span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:selName encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ®æ–¹æ³•åæ³¨å†Œ SEL"</span>);</div><div class="line">        SEL registerSel = sel_registerName(<span class="string">"registerSel"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(registerSel));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//ç”¨ block ä½œä¸ºæ–¹æ³•å®ç°"</span>);</div><div class="line">        IMP blockImp = imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;);</div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), blockImp, <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//æ ¹æ® block çš„ IMP ç”Ÿæˆ block å¯¹è±¡"</span>);</div><div class="line">        Block aBlock = imp_getBlock(blockImp);</div><div class="line">        aBlock();</div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//ç§»é™¤ imp_implementationWithBlock() ç”Ÿæˆçš„ IMP"</span>);</div><div class="line">        <span class="built_in">BOOL</span> isRemvoeBlockImpSucc = imp_removeBlock(blockImp);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"isRemvoeBlockImpSuccï¼š%d"</span>, isRemvoeBlockImpSucc);</div><div class="line">        Block aBlock2 = imp_getBlock(blockImp); <span class="comment">//blockImp å·²ç»ä¸å­˜åœ¨</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"aBlock2ï¼š%@"</span>, aBlock2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>è·å¾—ä¸€ä¸ªå®ä¾‹æ–¹æ³•</span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>è·å¾—ä¸€ä¸ªç±»æ–¹æ³•</span></div><div class="line"><span class="ruby">personRun</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Class å’Œ SEL è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ</span></div><div class="line"><span class="ruby"><span class="number">0x100001ad0</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>ä¿®æ”¹æ–¹æ³•çš„ imp æŒ‡é’ˆ</span></div><div class="line"><span class="ruby">-[Person test]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>äº¤æ¢æ–¹æ³•çš„ imp æŒ‡é’ˆ</span></div><div class="line"><span class="ruby">-[Person run2]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>åŠ¨æ€æ·»åŠ æ–¹æ³•</span></div><div class="line"><span class="ruby">newRun</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ‹·è´æ–¹æ³•åˆ—è¡¨ï¼ˆæœ€åéœ€è¦è°ƒç”¨freeé‡Šæ”¾ï¼‰</span></div><div class="line"><span class="ruby">newRun</span></div><div class="line"><span class="ruby">run2</span></div><div class="line"><span class="ruby">test2</span></div><div class="line"><span class="ruby">run3</span></div><div class="line"><span class="ruby">test3</span></div><div class="line"><span class="ruby"><span class="symbol">run4:</span><span class="symbol">name:</span></span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">test</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>åŠ¨æ€æ›¿æ¢æ–¹æ³•</span></div><div class="line"><span class="ruby">newTest</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Method è·å–æ–¹æ³•çš„ imp æŒ‡é’ˆ</span></div><div class="line"><span class="ruby"><span class="number">0x100001b90</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Method è·å–æ–¹æ³•çš„ç±»å‹ç¼–ç </span></div><div class="line"><span class="ruby">v16@0<span class="symbol">:</span><span class="number">8</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Method è·å–æ–¹æ³•çš„å‚æ•°ä¸ªæ•°</span></div><div class="line"><span class="ruby"><span class="number">4</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Method è·å–æ–¹æ³•çš„è¿”å›å€¼çš„ç±»å‹ç¼–ç </span></div><div class="line"><span class="ruby">i</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® Method è·å–æ–¹æ³•çš„ç´¢å¼•ä½ç½®çš„å‚æ•°çš„ç±»å‹ç¼–ç </span></div><div class="line"><span class="ruby">@</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® SEL è·å–æ–¹æ³•å</span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ®æ–¹æ³•åæ³¨å†Œ SEL</span></div><div class="line"><span class="ruby">registerSel</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>ç”¨ block ä½œä¸ºæ–¹æ³•å®ç°</span></div><div class="line"><span class="ruby">this is a block</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>æ ¹æ® block çš„ IMP ç”Ÿæˆ block å¯¹è±¡</span></div><div class="line"><span class="ruby">this is a block</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>ç§»é™¤ imp_implementationWithBlock() ç”Ÿæˆçš„ IMP</span></div><div class="line"><span class="ruby">isRemvoeBlockImpSuccï¼š<span class="number">1</span></span></div><div class="line"><span class="ruby">aBlock2ï¼š(null)</span></div></pre></td></tr></table></figure></p>
<h2 id="æ‹“å±•"><a href="#æ‹“å±•" class="headerlink" title="æ‹“å±•"></a>æ‹“å±•</h2><h3 id="class-rw-ext-t"><a href="#class-rw-ext-t" class="headerlink" title="class_rw_ext_t"></a>class_rw_ext_t</h3><p><code>class_rw_ext_t</code> é‡Œä¿å­˜ç€ <code>class_rw_t</code> çš„æ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨å’Œ <code>class_ro_t</code> ç­‰ä¿¡æ¯ã€‚<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_ext_t</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</div><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div><div class="line">    <span class="keyword">char</span> *demangledName;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></div><div class="line">    ......<span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">class_rw_ext_t</span> *ext() <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> get_ro_or_rwe().dyn_cast&lt;<span class="keyword">class_rw_ext_t</span> *&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">class_rw_ext_t</span> *extAllocIfNeeded() &#123;</div><div class="line">        <span class="keyword">auto</span> v = get_ro_or_rwe();</div><div class="line">        <span class="keyword">if</span> (fastpath(v.is&lt;<span class="keyword">class_rw_ext_t</span> *&gt;())) &#123;</div><div class="line">            <span class="keyword">return</span> v.get&lt;<span class="keyword">class_rw_ext_t</span> *&gt;();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> extAlloc(v.get&lt;<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *&gt;());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">class_rw_ext_t</span> *deepCopy(<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro) &#123;</div><div class="line">        <span class="keyword">return</span> extAlloc(ro, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ......<span class="comment">//çœç•¥</span></div></pre></td></tr></table></figure></p>
<h3 id="åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†"><a href="#åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†" class="headerlink" title="åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†?"></a>åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†?</h3><p>æŸ¥çœ‹ <code>class_addProperty()</code> çš„å®ç°<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">BOOL </div><div class="line">class_addProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                  <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _class_addProperty(cls, name, attrs, n, NO);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> </div><div class="line">class_replaceProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                      <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</div><div class="line">&#123;</div><div class="line">    _class_addProperty(cls, name, attrs, n, YES);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">bool</span> </div><div class="line">_class_addProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                   <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, </div><div class="line">                   <span class="keyword">bool</span> replace)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> NO;</div><div class="line">    <span class="keyword">if</span> (!name) <span class="keyword">return</span> NO;</div><div class="line"></div><div class="line">    <span class="keyword">property_t</span> *prop = class_getProperty(cls, name);</div><div class="line">    <span class="keyword">if</span> (prop  &amp;&amp;  !replace) &#123; <span class="comment">//å·²ç»å­˜åœ¨ &amp; æ›¿æ¢</span></div><div class="line">        <span class="comment">// already exists, refuse to replace</span></div><div class="line">        <span class="keyword">return</span> NO;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prop) &#123; <span class="comment">//å·²ç»å­˜åœ¨</span></div><div class="line">        <span class="comment">// replace existing</span></div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</div><div class="line">        try_free(prop-&gt;attributes);</div><div class="line">        prop-&gt;attributes = copyPropertyAttributeString(attrs, count);</div><div class="line">        <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(runtimeLock); </div><div class="line">        <span class="keyword">auto</span> rwe = cls-&gt;data()-&gt;extAllocIfNeeded(); <span class="comment">//class_rw_ext_t</span></div><div class="line">        </div><div class="line">        ASSERT(cls-&gt;isRealized());</div><div class="line">        </div><div class="line">        <span class="keyword">property_list_t</span> *proplist = (<span class="keyword">property_list_t</span> *)</div><div class="line">            <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*proplist));</div><div class="line">        proplist-&gt;count = <span class="number">1</span>;</div><div class="line">        proplist-&gt;entsizeAndFlags = <span class="keyword">sizeof</span>(proplist-&gt;first);</div><div class="line">        proplist-&gt;first.name = strdupIfMutable(name);</div><div class="line">        proplist-&gt;first.attributes = copyPropertyAttributeString(attrs, count);</div><div class="line">        </div><div class="line">        rwe-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>); <span class="comment">//ä¿å­˜åˆ° class_rw_ext_t çš„ properties é‡Œ</span></div><div class="line">        </div><div class="line">        <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ <code>class_addProperty()</code> çš„ Runtime å®ç°å¯ä»¥çœ‹åˆ°ï¼Œ<code>class_addProperty()</code> æ–¹æ³•å†…éƒ¨è°ƒç”¨çš„æ˜¯ <code>_class_addProperty()</code> æ–¹æ³•ã€‚<code>_class_addProperty()</code> æ–¹æ³•å†…éƒ¨å…ˆåˆ¤æ–­äº†æ–¹æ³•æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œåˆåˆ¤æ–­äº†æ˜¯å¦è¦æ›¿æ¢ã€‚å¦‚æœå³ä¸å­˜åœ¨ä¹Ÿä¸æ›¿æ¢ï¼Œå°±ä¿å­˜åˆ° <code>class_rw_ext_t</code> çš„ properties é‡Œï¼Œå³ç±»å¯¹è±¡çš„å±æ€§åˆ—è¡¨é‡Œã€‚ï¼ˆclass_rw_ext_tï¼šclass_read_write_extension_tableï¼Œå³ class_rw_t çš„æ‹“å±•è¡¨ï¼‰ã€‚</p>
<h4 id="åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†"><a href="#åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†" class="headerlink" title="åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†?"></a>åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†?</h4><p>æŸ¥çœ‹ <code>class_addMethod()</code> çš„å®ç°<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">BOOL </div><div class="line">class_addMethod(Class cls, SEL <span class="keyword">name</span>, IMP imp, const char *types)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cls) return NO;</div><div class="line"></div><div class="line">    mutex_locker_t lock(runtimeLock);</div><div class="line">    return ! addMethod(cls, <span class="keyword">name</span>, imp, types ?: <span class="string">""</span>, NO);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static IMP </div><div class="line">addMethod(Class cls, SEL <span class="keyword">name</span>, IMP imp, const char *types, bool replace)</div><div class="line">&#123;</div><div class="line">    IMP result = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    checkIsKnownClass(cls);</div><div class="line">    </div><div class="line">    ASSERT(types);</div><div class="line">    ASSERT(<span class="function"><span class="title">cls</span>-&gt;</span>isRealized());</div><div class="line"></div><div class="line">    method_t *m;</div><div class="line">    <span class="keyword">if</span> ((m = getMethodNoSuper_nolock(cls, <span class="keyword">name</span>))) &#123; <span class="comment">//æ˜¯å¦å­˜åœ¨</span></div><div class="line">        <span class="comment">// already exists</span></div><div class="line">        <span class="keyword">if</span> (!replace) &#123; <span class="comment">//æ˜¯å¦æ›¿æ¢</span></div><div class="line">            <span class="function"><span class="title">result</span> = m-&gt;</span>imp;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            result = _method_setImplementation(cls, m, imp);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="function"><span class="title">auto</span> rwe = cls-&gt;</span><span class="function"><span class="title">data</span>()-&gt;</span>extAllocIfNeeded(); <span class="comment">//class_rw_ext_t</span></div><div class="line"></div><div class="line">        <span class="comment">// fixme optimize</span></div><div class="line">        method_list_t *newlist;</div><div class="line">        newlist = (method_list_t *)calloc(sizeof(*newlist), <span class="number">1</span>);</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>entsizeAndFlags = </div><div class="line">            (uint32_t)sizeof(method_t) | fixed_up_method_list;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>count = <span class="number">1</span>;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.<span class="keyword">name</span> = <span class="keyword">name</span>;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.types = strdupIfMutable(types);</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.imp = imp;</div><div class="line"></div><div class="line">        prepareMethodLists(cls, &amp;newlist, <span class="number">1</span>, NO, NO);</div><div class="line">        <span class="function"><span class="title">rwe</span>-&gt;</span>methods.attachLists(&amp;newlist, <span class="number">1</span>); <span class="comment">//ä¿å­˜åˆ° class_rw_ext_t çš„ methods é‡Œ</span></div><div class="line">        flushCaches(cls);</div><div class="line"></div><div class="line">        result = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æŸ¥çœ‹ <code>class_addMethod()</code> çš„ Runtime å®ç°å¯ä»¥çœ‹åˆ° <code>class_addMethod()</code> æ–¹æ³•å†…éƒ¨è°ƒç”¨çš„æ˜¯ <code>addMethod()</code> æ–¹æ³•ã€‚<code>addMethod()</code> æ–¹æ³•å†…éƒ¨å…ˆåˆ¤æ–­äº†æ–¹æ³•æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œåˆåˆ¤æ–­äº†æ˜¯å¦è¦æ›¿æ¢ã€‚å¦‚æœå³ä¸å­˜ï¼Œå°±ä¿å­˜åˆ° <code>class_rw_ext_t</code> çš„ methods é‡Œï¼Œå³ç±»å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨é‡Œã€‚ï¼ˆclass_rw_ext_tï¼šclass_read_write_extension_tableï¼Œå³ class_rw_t çš„æ‹“å±•è¡¨ï¼‰ã€‚</p>
<h3 id="method-exchangeImplementations-çš„å®ç°åŸç†"><a href="#method-exchangeImplementations-çš„å®ç°åŸç†" class="headerlink" title="method_exchangeImplementations çš„å®ç°åŸç†"></a>method_exchangeImplementations çš„å®ç°åŸç†</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">method_exchangeImplementations</span><span class="params">(Method m1, Method m2)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!m1  ||  !m2) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</div><div class="line"></div><div class="line">    IMP m1_imp = m1-&gt;imp;</div><div class="line">    m1-&gt;imp = m2-&gt;imp;</div><div class="line">    m2-&gt;imp = m1_imp;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// RR/AWZ updates are slow because class is unknown</span></div><div class="line">    <span class="comment">// Cache updates are slow because class is unknown</span></div><div class="line">    <span class="comment">// fixme build list of classes whose Methods are known externally?</span></div><div class="line"></div><div class="line">    flushCaches(nil); <span class="comment">//æ¸…ç©ºæ–¹æ³•ç¼“å­˜</span></div><div class="line"></div><div class="line">    adjustCustomFlagsForMethodChange(nil, m1);</div><div class="line">    adjustCustomFlagsForMethodChange(nil, m2);</div><div class="line">&#125;</div><div class="line"></div><div class="line">......<span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">flushCaches</span><span class="params">(Class cls)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    <span class="keyword">mutex_locker_t</span> lock(cacheUpdateLock);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cls) &#123;</div><div class="line">        foreach_realized_class_and_subclass(cls, [](Class c)&#123;</div><div class="line">            cache_erase_nolock(c);</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        foreach_realized_class_and_metaclass([](Class c)&#123;</div><div class="line">            cache_erase_nolock(c);</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......<span class="comment">//çœç•¥</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_erase_nolock</span><span class="params">(Class cls)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t</span> *cache = getCache(cls);</div><div class="line"></div><div class="line">    <span class="keyword">mask_t</span> capacity = cache-&gt;capacity();</div><div class="line">    <span class="keyword">if</span> (capacity &gt; <span class="number">0</span>  &amp;&amp;  cache-&gt;occupied() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">auto</span> oldBuckets = cache-&gt;buckets();</div><div class="line">        <span class="keyword">auto</span> buckets = emptyBucketsForCapacity(capacity);</div><div class="line">        cache-&gt;setBucketsAndMask(buckets, capacity - <span class="number">1</span>); <span class="comment">// also clears occupied</span></div><div class="line"></div><div class="line">        cache_collect_free(oldBuckets, capacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>method_exchangeImplementations çš„åº•å±‚å®ç°æ˜¯äº¤æ¢äº†ä¸¤ä¸ªæ–¹æ³•çš„ <code>imp</code> æŒ‡é’ˆï¼Œç„¶åè°ƒç”¨ <code>flushCaches()</code> æ–¹æ³•æ¸…ç©ºäº†æ–¹æ³•ç¼“å­˜ã€‚<br><img src="/2020/06/12/OCåº•å±‚/åŸç†/Runtime/Runtime37.png" alt="Runtime37"></p>
<h2 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h2><h3 id="æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡"><a href="#æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡" class="headerlink" title="æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡"></a>æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡</h3><p>ä¿®æ”¹ UITextField å ä½æ–‡å­—çš„é¢œè‰²ï¼š</p>
<p>æ–¹æ¡ˆä¸€ï¼šæ­£å¸¸çš„ OC ä»£ç <br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span> *attrs = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    attrs[<span class="built_in">NSForegroundColorAttributeName</span>] = [<span class="built_in">UIColor</span> redColor];</div><div class="line">    <span class="keyword">self</span>.textField.attributedPlaceholder = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"è¯·è¾“å…¥ç”¨æˆ·å"</span> attributes:attrs];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ KVC ä¿®æ”¹ï¼ˆiOS 13 åç¦ç”¨ï¼‰<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.textField.placeholder = <span class="string">@"è¯·è¾“å…¥ç”¨æˆ·å"</span>;</div><div class="line">    <span class="built_in">UILabel</span> *placeholderLabel = [<span class="keyword">self</span>.textField valueForKeyPath:<span class="string">@"_placeholderLabel"</span>];</div><div class="line">    placeholderLabel.textColor = [<span class="built_in">UIColor</span> redColor];</div><div class="line"></div><div class="line">    <span class="comment">//ç®€åŒ–ç‰ˆï¼š[self.textField setValue:[UIColor redColor] forKeyPath:@"_placeholderLabel.textColor"];</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æŠ¥é”™ï¼š<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*** Terminating app due <span class="keyword">to</span> uncaught exception <span class="symbol">'NSGenericException</span>', reason: <span class="symbol">'Access</span> <span class="keyword">to</span> UITextField<span class="symbol">'s</span> _placeholderLabel ivar <span class="keyword">is</span> prohibited. This <span class="keyword">is</span> an application bug'</div></pre></td></tr></table></figure></p>
<p>æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ Runtimeï¼ˆè¿˜ä¸å¦‚ OC çœäº‹ï¼‰<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.textField.placeholder = <span class="string">@"è¯·è¾“å…¥ç”¨æˆ·å"</span>;</div><div class="line">    Ivar ivar = class_getInstanceVariable([<span class="built_in">UITextField</span> <span class="keyword">class</span>], <span class="string">"_placeholderLabel"</span>);</div><div class="line">    <span class="built_in">UILabel</span> *placeholderLabel = object_getIvar(<span class="keyword">self</span>.textField, ivar);</div><div class="line">    placeholderLabel.textColor = [<span class="built_in">UIColor</span> redColor];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="å­—å…¸è½¬æ¨¡å‹"><a href="#å­—å…¸è½¬æ¨¡å‹" class="headerlink" title="å­—å…¸è½¬æ¨¡å‹"></a>å­—å…¸è½¬æ¨¡å‹</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> ID;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Teacher</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> weight;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Teacher</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    <span class="keyword">id</span> obj = [[<span class="keyword">self</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:<span class="keyword">self</span> json:json];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)enumerateIvarsWithObject:(<span class="keyword">id</span>)obj <span class="keyword">class</span>:(Class)<span class="keyword">class</span> json:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    Class superclass = [<span class="keyword">class</span> superclass];</div><div class="line">    <span class="keyword">if</span> (superclass &amp;&amp; superclass != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123; <span class="comment">//å¤„ç†ç»§æ‰¿</span></div><div class="line">        [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:superclass json:json];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">class</span>, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        Ivar ivar = ivars[i]; <span class="comment">//å–å‡º i ä½ç½®çš„æˆå‘˜å˜é‡</span></div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)]; <span class="comment">//å»æ‰â€œ_â€</span></div><div class="line">        <span class="keyword">id</span> value = json[name]; <span class="comment">//è®¾ç½®</span></div><div class="line">        <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"ID"</span>]) &#123; <span class="comment">//å¤„ç†ç‰¹æ®Šæ•°æ®</span></div><div class="line">            value = json[<span class="string">@"id"</span>];</div><div class="line">        &#125;</div><div class="line">        [obj setValue:value forKey:name];</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *json = @&#123;</div><div class="line">            <span class="string">@"id"</span> : @<span class="number">10</span>,</div><div class="line">            <span class="string">@"age"</span> : @<span class="number">20</span>,</div><div class="line">            <span class="string">@"weight"</span> : @<span class="number">60</span>,</div><div class="line">            <span class="string">@"height"</span> : @<span class="number">160</span>,</div><div class="line">            <span class="string">@"name"</span> : <span class="string">@"Tom"</span></div><div class="line">        &#125;;</div><div class="line">        Teacher *teacher = [Teacher yq_objectWithJson:json];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d, %@"</span>, teacher.ID, teacher.age, teacher.weight, teacher.height, teacher.name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">10</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">160</span>, Tom</div></pre></td></tr></table></figure></p>
<h3 id="å½’æ¡£è§£æ¡£"><a href="#å½’æ¡£è§£æ¡£" class="headerlink" title="å½’æ¡£è§£æ¡£"></a>å½’æ¡£è§£æ¡£</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class;</div><div class="line">- (<span class="keyword">void</span>)decodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)archive;</div><div class="line">+ (<span class="keyword">instancetype</span>)unarchive;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    <span class="keyword">id</span> obj = [[<span class="keyword">self</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:<span class="keyword">self</span> json:json];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)enumerateIvarsWithObject:(<span class="keyword">id</span>)obj <span class="keyword">class</span>:(Class)<span class="keyword">class</span> json:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    Class superclass = [<span class="keyword">class</span> superclass];</div><div class="line">    <span class="keyword">if</span> (superclass &amp;&amp; superclass != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</div><div class="line">        [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:superclass json:json];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">class</span>, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//å–å‡ºæˆå‘˜å˜é‡</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="comment">//è®¾ç½®</span></div><div class="line">        <span class="keyword">id</span> value = json[name];</div><div class="line">        <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"ID"</span>]) &#123;</div><div class="line">            value = json[<span class="string">@"id"</span>];</div><div class="line">        &#125;</div><div class="line">        [obj setValue:value forKey:name];</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class</div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(Class, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//å–å‡ºæˆå‘˜å˜é‡</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSString</span> *typeEncode = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getTypeEncoding(ivar)];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"i"</span>]) &#123;</div><div class="line">            <span class="keyword">int</span> value = [[<span class="keyword">self</span> valueForKey:name] intValue];</div><div class="line">            [coder encodeInt:value forKey:name];</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"@\"NSString\""</span>]) &#123;</div><div class="line">            <span class="keyword">id</span> value = [<span class="keyword">self</span> valueForKey:name];</div><div class="line">            [coder encodeObject:value forKey:name];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)decodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class</div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(Class, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//å–å‡ºæˆå‘˜å˜é‡</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSString</span> *typeEncode = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getTypeEncoding(ivar)];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"i"</span>]) &#123;</div><div class="line">            <span class="keyword">int</span> value = [coder decodeIntForKey:name];</div><div class="line">            [<span class="keyword">self</span> setValue:@(value) forKey:name];</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"@\"NSString\""</span>]) &#123;</div><div class="line">            <span class="keyword">id</span> value = [coder decodeObjectForKey:name];</div><div class="line">            [<span class="keyword">self</span> setValue:value forKey:name];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)archive</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"obj.%@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])];</div><div class="line">    <span class="built_in">NSString</span> *temp = <span class="built_in">NSTemporaryDirectory</span>();</div><div class="line">    <span class="built_in">NSString</span> *filePath = [temp stringByAppendingPathComponent:name]; <span class="comment">//ä»¥ç±»åä½œä¸ºä¿å­˜æ–‡ä»¶çš„æ‰©å±•å</span></div><div class="line">    [<span class="built_in">NSKeyedArchiver</span> archiveRootObject:<span class="keyword">self</span> toFile:filePath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">instancetype</span>)unarchive</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"obj.%@"</span>, <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>)];</div><div class="line">    <span class="built_in">NSString</span> *filePath = [<span class="built_in">NSTemporaryDirectory</span>() stringByAppendingPathComponent:name];</div><div class="line">    <span class="keyword">id</span> obj = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:filePath];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCoding</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> ID;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> encodeIvarsWithCoder:coder Class:[Person <span class="keyword">class</span>]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> decodeIvarsWithCoder:coder Class:[Person <span class="keyword">class</span>]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Teacher</span> : <span class="title">Person</span>&lt;<span class="title">NSCoding</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> weight;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Teacher</span></span></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> encodeWithCoder:coder];</div><div class="line">    [<span class="keyword">self</span> encodeIvarsWithCoder:coder Class:[Teacher <span class="keyword">class</span>]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:coder];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> decodeIvarsWithCoder:coder Class:[Teacher <span class="keyword">class</span>]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">//å½’æ¡£</span></div><div class="line"><span class="comment">//        NSDictionary *json = @&#123;</span></div><div class="line"><span class="comment">//            @"id" : @100,</span></div><div class="line"><span class="comment">//            @"age" : @200,</span></div><div class="line"><span class="comment">//            @"weight" : @700,</span></div><div class="line"><span class="comment">//            @"height" : @1700,</span></div><div class="line"><span class="comment">//            @"name" : @"Tom"</span></div><div class="line"><span class="comment">//        &#125;;</span></div><div class="line"><span class="comment">//        Teacher *teacher = [Teacher yq_objectWithJson:json];</span></div><div class="line"><span class="comment">//        [teacher archive];</span></div><div class="line">        <span class="comment">//è§£æ¡£</span></div><div class="line">        Teacher *teacher = [Teacher unarchive];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d, %@"</span>, teacher.ID, teacher.age, teacher.weight, teacher.height, teacher.name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>, <span class="number">200</span>, <span class="number">700</span>, <span class="number">1700</span>, Tom</div></pre></td></tr></table></figure></p>
<h3 id="æ›¿æ¢æ–¹æ³•å®ç°"><a href="#æ›¿æ¢æ–¹æ³•å®ç°" class="headerlink" title="æ›¿æ¢æ–¹æ³•å®ç°"></a>æ›¿æ¢æ–¹æ³•å®ç°</h3><p>class_replaceMethod<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line">+ (<span class="keyword">void</span>)personRun;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)personRun</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> myRun()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"---myRun"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">//ä½¿ç”¨ myRun æ›¿æ¢ç±»æ–¹æ³• +personRunï¼Œä¼ å…¥å…ƒç±»å¯¹è±¡</span></div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), (IMP)myRun, <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        <span class="comment">//ä½¿ç”¨ block æ›¿æ¢ç±»æ–¹æ³• +personRun</span></div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;), <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        </div><div class="line">        <span class="comment">//ä½¿ç”¨ myRun æ›¿æ¢å¯¹è±¡æ–¹æ³• -runï¼Œä¼ å…¥ç±»å¯¹è±¡</span></div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run), (IMP)myRun, <span class="string">"v"</span>);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person run];</div><div class="line">        <span class="comment">//ä½¿ç”¨ block æ›¿æ¢å¯¹è±¡æ–¹æ³• -run</span></div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run), imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;), <span class="string">"v"</span>);</div><div class="line">        [person run];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">---myRun</div><div class="line"><span class="keyword">this</span> <span class="keyword">is</span> a block</div><div class="line">---myRun</div><div class="line"><span class="keyword">this</span> <span class="keyword">is</span> a block</div></pre></td></tr></table></figure></p>
<h3 id="æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"><a href="#æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶" class="headerlink" title="æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"></a>æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</h3><p>ä½¿ç”¨ method_exchangeImplementations äº¤æ¢ç³»ç»Ÿæ–¹æ³•å®ç°æ–¹æ³•æ‹¦æˆªï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIControl</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIControl</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Method method1 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(sendAction:to:forEvent:));</div><div class="line">        Method method2 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(yq_sendAction:to:forEvent:));</div><div class="line">        method_exchangeImplementations(method1, method2);        </div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@-%@-%@"</span>, <span class="keyword">self</span>, target, <span class="built_in">NSStringFromSelector</span>(action));</div><div class="line">    <span class="comment">//è°ƒç”¨ç³»ç»ŸåŸæ¥çš„å®ç°</span></div><div class="line">    [<span class="keyword">self</span> yq_sendAction:action to:target forEvent:event];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> : <span class="title">UIViewController</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">IBAction</span>)click1:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">IBAction</span>)click2:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">IBAction</span>)click3:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>æ‰“å°ç»“æœï¼š<br><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ad093e0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">332</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001bd0560</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click1:</span></div><div class="line"><span class="xml">-[ViewController click1:]</span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ae0c4f0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">411</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001be5740</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click2:</span></div><div class="line"><span class="xml">-[ViewController click2:]</span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ad096b0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">492</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001bd06e0</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click3:</span></div><div class="line"><span class="xml">-[ViewController click3:]</span></div></pre></td></tr></table></figure></p>
<h3 id="æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•"><a href="#æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•" class="headerlink" title="æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•"></a>æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•</h3><p>æ•°ç»„çš„ <code>addObject:</code> å’Œ <code>insertObject:</code> æ–¹æ³•è°ƒç”¨çš„éƒ½æ˜¯ <code>insertObject:atIndex:</code> æ–¹æ³•ã€‚æ‹¦æˆª <code>insertObject:atIndex:</code> æ–¹æ³•ï¼Œå¯ä»¥è§£å†³æ·»åŠ ç©ºæ•°æ®å¯¼è‡´çš„å´©æºƒã€‚</p>
<p>ç±»ç°‡ï¼šNSDataã€NSArrayã€NSDictionary å’Œ NSStringã€‚å®ƒä»¬çš„ç±»å¹¶ä¸ä¸€æ ·ï¼Œæ¯”å¦‚ NSMutableArray çš„ç±»æ˜¯ <code>__NSArrayM</code>ã€‚</p>
<p>ä½¿ç”¨ method_exchangeImplementations äº¤æ¢ç³»ç»Ÿæ–¹æ³•å®ç°æ–¹æ³•æ‹¦æˆªï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableArray</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSArrayM"</span>);</div><div class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(insertObject:atIndex:));</div><div class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(yq_insertObject:atIndex:));</div><div class="line">        method_exchangeImplementations(method1, method2);        </div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_insertObject:(<span class="keyword">id</span>)anObject atIndex:(<span class="built_in">NSUInteger</span>)index</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (anObject == <span class="literal">nil</span>) <span class="keyword">return</span>;</div><div class="line">    [<span class="keyword">self</span> yq_insertObject:anObject atIndex:index];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *arrayM = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    <span class="built_in">NSString</span> *obj = <span class="literal">nil</span>;</div><div class="line">    [arrayM addObject:obj];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•"><a href="#æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•" class="headerlink" title="æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•"></a>æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•</h3><p>å­—å…¸èµ‹å€¼çš„ <code>setObject:forKey:</code> æ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„æ˜¯ <code>setObject:forKeyedSubscript:</code>ã€‚æ‹¦æˆª <code>setObject:forKeyedSubscript:</code> æ–¹æ³•ï¼Œå¯ä»¥è§£å†³æ·»åŠ ç©ºæ•°æ®å¯¼è‡´çš„å´©æºƒã€‚</p>
<p>ä½¿ç”¨ method_exchangeImplementations äº¤æ¢ç³»ç»Ÿæ–¹æ³•å®ç°æ–¹æ³•æ‹¦æˆªï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableDictionary</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableDictionary</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryM"</span>);</div><div class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(setObject:forKeyedSubscript:));</div><div class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(yq_setObject:forKeyedSubscript:));</div><div class="line">        method_exchangeImplementations(method1, method2);</div><div class="line">        </div><div class="line">        Class cls2 = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryI"</span>);</div><div class="line">        Method method3 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(objectForKeyedSubscript:));</div><div class="line">        Method method4 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(yq_objectForKeyedSubscript:));</div><div class="line">        method_exchangeImplementations(method3, method4);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_setObject:(<span class="keyword">id</span>)obj forKeyedSubscript:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!key || !obj) <span class="keyword">return</span>;</div><div class="line">    [<span class="keyword">self</span> yq_setObject:obj forKeyedSubscript:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)yq_objectForKeyedSubscript:(<span class="keyword">id</span>)key</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yq_objectForKeyedSubscript:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span> *dictionaryM = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    dictionaryM[obj] = obj;</div><div class="line">    <span class="built_in">NSString</span> *obj2 = dictionaryM[obj];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul>
<li><p>è®²ä¸€ä¸‹ OC çš„æ¶ˆæ¯æœºåˆ¶<br>OC ä¸­çš„æ–¹æ³•è°ƒç”¨å…¶å®éƒ½æ˜¯è½¬æˆäº† objc_msgSend å‡½æ•°çš„è°ƒç”¨ï¼Œç»™ receiverï¼ˆæ–¹æ³•è°ƒç”¨è€…ï¼‰å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼ˆselector(æ–¹æ³•å)ï¼‰ã€‚<br>objc_msgSend åº•å±‚æœ‰ä¸‰å¤§é˜¶æ®µï¼š  </p>
<ul>
<li>æ¶ˆæ¯å‘é€ï¼šå…ˆè°ƒåœ¨å½“å‰ç±»çš„ cache é‡Œæ‰¾ï¼Œå†åˆ°å½“å‰ç±»çš„ methods é‡Œæ‰¾ã€‚å¦‚æœåœ¨å½“å‰ç±»æ²¡æœ‰æ‰¾åˆ°ï¼Œå†éå†çˆ¶ç±»æŸ¥æ‰¾ï¼Œå…ˆåœ¨çˆ¶ç±»çš„ cache é‡Œæ‰¾ï¼Œå†åˆ°çˆ¶ç±»çš„ methods é‡Œæ‰¾ã€‚</li>
<li>åŠ¨æ€æ–¹æ³•è§£æï¼šåœ¨å½“å‰ç±»åŠå…¶çˆ¶ç±»é‡Œæ²¡æœ‰æ‰¾åˆ°æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨ <code>resolveInstanceMethod:</code> æˆ–è€… <code>resolveClassMethod:</code> æ–¹æ³•åŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚  </li>
<li>æ¶ˆæ¯è½¬å‘ï¼šå¦‚æœæ²¡æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œä¼šè°ƒç”¨ <code>forwardingTargetForSelector:</code> æ–¹æ³•è·å–å¯ä»¥å¤„ç†æ¶ˆæ¯çš„å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å®ç°  <code>forwardingTargetForSelector:</code> æ–¹æ³•æˆ–è€…è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ nilï¼Œä¼šè°ƒç”¨ <code>methodSignatureForSelector:</code> æ–¹æ³•è·å–ç±»å‹ç¼–ç ï¼Œåœ¨è·å–ç±»å‹ç¼–ç æˆåŠŸåå†è°ƒç”¨ <code>forwardInvocation:</code> æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰æ“ä½œã€‚å¦‚æœæ²¡æœ‰å®ç° <code>methodSignatureForSelector:</code> æ–¹æ³•æˆ–è€…è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ nilï¼Œä¼šè°ƒç”¨ <code>doesNotRecognizeSelector:</code> æ–¹æ³•ç»ˆæ­¢æµç¨‹ã€‚ </li>
</ul>
</li>
<li><p>æ¶ˆæ¯è½¬å‘æœºåˆ¶æµç¨‹<br>å¦‚æœæ²¡æœ‰åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼Œä¼šè°ƒç”¨ <code>forwardingTargetForSelector:</code> æ–¹æ³•è·å–å¯ä»¥å¤„ç†æ¶ˆæ¯çš„å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å®ç°  <code>forwardingTargetForSelector:</code> æ–¹æ³•æˆ–è€…è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ nilï¼Œä¼šè°ƒç”¨ <code>methodSignatureForSelector:</code> æ–¹æ³•è·å–ç±»å‹ç¼–ç ï¼Œåœ¨è·å–ç±»å‹ç¼–ç æˆåŠŸåå†è°ƒç”¨ <code>forwardInvocation:</code> æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰æ“ä½œã€‚å¦‚æœæ²¡æœ‰å®ç° <code>methodSignatureForSelector:</code> æ–¹æ³•æˆ–è€…è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ nilï¼Œä¼šè°ƒç”¨ <code>doesNotRecognizeSelector:</code> æ–¹æ³•ç»ˆæ­¢æµç¨‹ã€‚ </p>
</li>
<li><p>ä»€ä¹ˆæ˜¯ Runtime ï¼Ÿå¹³æ—¶é¡¹ç›®ä¸­æœ‰ç”¨è¿‡ä¹ˆï¼Ÿ<br>OC æ˜¯ä¸€é—¨åŠ¨æ€æ€§æ¯”è¾ƒå¼ºçš„ç¼–ç¨‹è¯­è¨€ï¼Œå…è®¸å¾ˆå¤šæ“ä½œæ¨è¿Ÿåˆ°ç¨‹åºè¿è¡Œæ—¶å†è¿›è¡Œã€‚OC çš„åŠ¨æ€æ€§å°±æ˜¯ç”± Runtime æ¥æ”¯æ’‘å’Œå®ç°çš„ï¼ŒRuntime æ˜¯ä¸€å¥— C è¯­è¨€çš„ APIï¼Œå°è£…äº†å¾ˆå¤šåŠ¨æ€æ€§ç›¸å…³çš„å‡½æ•°ï¼Œå¹³æ—¶ç¼–å†™çš„OCä»£ç ï¼Œåº•å±‚éƒ½æ˜¯è½¬æ¢æˆäº† Runtime API è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>å…·ä½“åº”ç”¨<br>1ã€åˆ©ç”¨å…³è”å¯¹è±¡ï¼ˆAssociatedObjectï¼‰ç»™åˆ†ç±»æ·»åŠ å±æ€§ï¼›<br>2ã€éå†ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼ˆä¿®æ”¹textfieldçš„å ä½æ–‡å­—é¢œè‰²ã€å­—å…¸è½¬æ¨¡å‹ã€è‡ªåŠ¨å½’æ¡£è§£æ¡£ï¼‰ï¼›<br>3ã€äº¤æ¢æ–¹æ³•å®ç°ï¼ˆäº¤æ¢ç³»ç»Ÿçš„æ–¹æ³•ï¼‰ï¼›<br>4ã€åˆ©ç”¨æ¶ˆæ¯è½¬å‘æœºåˆ¶è§£å†³æ–¹æ³•æ‰¾ä¸åˆ°çš„å¼‚å¸¸é—®é¢˜ï¼›<br>â€¦â€¦</p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OCåº•å±‚åŸç†/" rel="tag"># OCåº•å±‚åŸç†</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/31/OCåº•å±‚/åŸç†/block/" rel="next" title="block">
                <i class="fa fa-chevron-left"></i> block
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/02/OCåº•å±‚/åŸç†/RunLoop/" rel="prev" title="RunLoop">
                RunLoop <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/myAvatar.gif"
              alt="Kevin" />
          
            <p class="site-author-name" itemprop="name">Kevin</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/KevinYangGit" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_YangQI" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>Twitter</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#isa-è¯¦è§£"><span class="nav-number">1.</span> <span class="nav-text">isa è¯¦è§£</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½è¿ç®—"><span class="nav-number">1.1.</span> <span class="nav-text">ä½è¿ç®—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¾è®¡"><span class="nav-number">1.1.1.</span> <span class="nav-text">è®¾è®¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å–å€¼"><span class="nav-number">1.1.2.</span> <span class="nav-text">å–å€¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ©ç "><span class="nav-number">1.1.3.</span> <span class="nav-text">æ©ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¾å€¼"><span class="nav-number">1.1.4.</span> <span class="nav-text">è®¾å€¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½åŸŸ"><span class="nav-number">1.2.</span> <span class="nav-text">ä½åŸŸ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…±ç”¨ä½“ï¼ˆunionï¼‰"><span class="nav-number">1.3.</span> <span class="nav-text">å…±ç”¨ä½“ï¼ˆunionï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#struct"><span class="nav-number">1.3.1.</span> <span class="nav-text">struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#union"><span class="nav-number">1.3.2.</span> <span class="nav-text">union</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®ç°"><span class="nav-number">1.3.3.</span> <span class="nav-text">å®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#isa"><span class="nav-number">1.4.</span> <span class="nav-text">isa</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#isa-t"><span class="nav-number">1.4.1.</span> <span class="nav-text">isa_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½åŸŸ-1"><span class="nav-number">1.4.2.</span> <span class="nav-text">ä½åŸŸ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#has-assoc-å’Œ-weakly-referenced"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">has_assoc å’Œ weakly_referenced</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">å¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ISA-MASK"><span class="nav-number">1.4.3.</span> <span class="nav-text">ISA_MASK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½è¿ç®—è¡¥å……"><span class="nav-number">1.5.</span> <span class="nav-text">ä½è¿ç®—è¡¥å……</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Class-çš„ç»“æ„"><span class="nav-number">2.</span> <span class="nav-text">Class çš„ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#class-rw-t"><span class="nav-number">2.1.</span> <span class="nav-text">class_rw_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#method-array-t"><span class="nav-number">2.1.1.</span> <span class="nav-text">method_array_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#property-array-t"><span class="nav-number">2.1.2.</span> <span class="nav-text">property_array_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#protocol-array-t"><span class="nav-number">2.1.3.</span> <span class="nav-text">protocol_array_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-ro-t"><span class="nav-number">2.2.</span> <span class="nav-text">class_ro_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#method-list-tã€ivar-list-t-å’Œ-property-list-t"><span class="nav-number">2.2.1.</span> <span class="nav-text">method_list_tã€ivar_list_t å’Œ property_list_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#method-t"><span class="nav-number">2.3.</span> <span class="nav-text">method_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IMP"><span class="nav-number">2.3.1.</span> <span class="nav-text">IMP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SEL"><span class="nav-number">2.3.2.</span> <span class="nav-text">SEL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#types"><span class="nav-number">2.3.3.</span> <span class="nav-text">types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-Encoding"><span class="nav-number">2.3.4.</span> <span class="nav-text">Type Encoding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ–¹æ³•ç¼“å­˜"><span class="nav-number">2.4.</span> <span class="nav-text">æ–¹æ³•ç¼“å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mask"><span class="nav-number">2.4.1.</span> <span class="nav-text">_mask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buckets"><span class="nav-number">2.4.2.</span> <span class="nav-text">_buckets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç©ºé—´æ¢æ—¶é—´"><span class="nav-number">2.4.3.</span> <span class="nav-text">ç©ºé—´æ¢æ—¶é—´</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¾‹1ï¼š"><span class="nav-number">2.4.3.1.</span> <span class="nav-text">ä¾‹1ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¾‹2ï¼š"><span class="nav-number">2.4.3.2.</span> <span class="nav-text">ä¾‹2ï¼š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¾‹3"><span class="nav-number">2.4.3.3.</span> <span class="nav-text">ä¾‹3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å°ç»“"><span class="nav-number">2.4.3.4.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#objc-msgSend"><span class="nav-number">3.</span> <span class="nav-text">objc_msgSend</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSend-æ‰§è¡Œæµç¨‹"><span class="nav-number">3.1.</span> <span class="nav-text">objc_msgSend æ‰§è¡Œæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-msgSend-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">_objc_msgSend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lookUpImpOrForward"><span class="nav-number">3.1.2.</span> <span class="nav-text">_lookUpImpOrForward</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveMethod-locked"><span class="nav-number">3.1.3.</span> <span class="nav-text">resolveMethod_locked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-msgForward-impcache"><span class="nav-number">3.1.4.</span> <span class="nav-text">__objc_msgForward_impcache</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¶ˆæ¯å‘é€"><span class="nav-number">3.2.</span> <span class="nav-text">æ¶ˆæ¯å‘é€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åŠ¨æ€æ–¹æ³•è§£æ"><span class="nav-number">3.3.</span> <span class="nav-text">åŠ¨æ€æ–¹æ³•è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•"><span class="nav-number">3.3.1.</span> <span class="nav-text">åŠ¨æ€æ·»åŠ å¯¹è±¡æ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°"><span class="nav-number">3.3.2.</span> <span class="nav-text">åŠ¨æ€æ·»åŠ Cè¯­è¨€å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•"><span class="nav-number">3.3.3.</span> <span class="nav-text">åŠ¨æ€æ·»åŠ ç±»æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¶ˆæ¯è½¬å‘"><span class="nav-number">3.4.</span> <span class="nav-text">æ¶ˆæ¯è½¬å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"><span class="nav-number">3.4.1.</span> <span class="nav-text">å¯¹è±¡æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#forwardingTargetForSelector-æ–¹æ³•"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">-forwardingTargetForSelector: æ–¹æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#methodSignatureForSelector-æ–¹æ³•"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">-methodSignatureForSelector: æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘"><span class="nav-number">3.4.2.</span> <span class="nav-text">ç±»æ–¹æ³•çš„æ¶ˆæ¯è½¬å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#forwardingTargetForSelector-æ–¹æ³•-1"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">+forwardingTargetForSelector: æ–¹æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#methodSignatureForSelector-æ–¹æ³•-1"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">+methodSignatureForSelector: æ–¹æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSInvocation"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">NSInvocation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synthesizeã€-dynamic"><span class="nav-number">3.4.3.</span> <span class="nav-text">@synthesizeã€@dynamic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å°ç»“-1"><span class="nav-number">3.4.4.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#super-çš„æœ¬è´¨"><span class="nav-number">4.</span> <span class="nav-text">super çš„æœ¬è´¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-super-ç»“æ„ä½“"><span class="nav-number">4.1.</span> <span class="nav-text">objc_super ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSendSuper-æ–¹æ³•"><span class="nav-number">4.2.</span> <span class="nav-text">objc_msgSendSuper() æ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSendSuper2"><span class="nav-number">4.3.</span> <span class="nav-text">objc_msgSendSuper2()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æŸ¥çœ‹æ±‡ç¼–ä»£ç "><span class="nav-number">4.3.1.</span> <span class="nav-text">æŸ¥çœ‹æ±‡ç¼–ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æŸ¥çœ‹-LLVM-çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰"><span class="nav-number">4.3.2.</span> <span class="nav-text">æŸ¥çœ‹ LLVM çš„ä¸­é—´ä»£ç ï¼ˆIRï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å°ç»“-2"><span class="nav-number">4.3.3.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#selfã€class-å’Œ-superclass-çš„åº•å±‚å®ç°"><span class="nav-number">4.4.</span> <span class="nav-text">selfã€class å’Œ superclass çš„åº•å±‚å®ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#isKindOfClass-å’Œ-isMemberOfClass"><span class="nav-number">4.5.</span> <span class="nav-text">isKindOfClass: å’Œ isMemberOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#isMemberOfClass-å’Œ-isKindOfClass"><span class="nav-number">4.5.1.</span> <span class="nav-text">+isMemberOfClass: å’Œ +isKindOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å°ç»“-3"><span class="nav-number">4.5.1.1.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isMemberOfClass-å’Œ-isKindOfClass-1"><span class="nav-number">4.5.2.</span> <span class="nav-text">-isMemberOfClass: å’Œ -isKindOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å°ç»“-4"><span class="nav-number">4.5.2.1.</span> <span class="nav-text">å°ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†"><span class="nav-number">4.6.</span> <span class="nav-text">å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­£å¸¸è°ƒç”¨"><span class="nav-number">4.6.1.</span> <span class="nav-text">æ­£å¸¸è°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è‡ªå®šä¹‰è°ƒç”¨"><span class="nav-number">4.6.2.</span> <span class="nav-text">è‡ªå®šä¹‰è°ƒç”¨</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Runtime-API"><span class="nav-number">5.</span> <span class="nav-text">Runtime API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç±»"><span class="nav-number">5.1.</span> <span class="nav-text">ç±»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æˆå‘˜å˜é‡"><span class="nav-number">5.2.</span> <span class="nav-text">æˆå‘˜å˜é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å±æ€§"><span class="nav-number">5.3.</span> <span class="nav-text">å±æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ–¹æ³•"><span class="nav-number">5.4.</span> <span class="nav-text">æ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ‹“å±•"><span class="nav-number">5.5.</span> <span class="nav-text">æ‹“å±•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#class-rw-ext-t"><span class="nav-number">5.5.1.</span> <span class="nav-text">class_rw_ext_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†"><span class="nav-number">5.5.2.</span> <span class="nav-text">åŠ¨æ€æ·»åŠ çš„å±æ€§å­˜åˆ°å“ªäº†?</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†"><span class="nav-number">5.5.2.1.</span> <span class="nav-text">åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å­˜åˆ°å“ªäº†?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#method-exchangeImplementations-çš„å®ç°åŸç†"><span class="nav-number">5.5.3.</span> <span class="nav-text">method_exchangeImplementations çš„å®ç°åŸç†</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åº”ç”¨"><span class="nav-number">5.6.</span> <span class="nav-text">åº”ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡"><span class="nav-number">5.6.1.</span> <span class="nav-text">æŸ¥çœ‹ç§æœ‰æˆå‘˜å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å­—å…¸è½¬æ¨¡å‹"><span class="nav-number">5.6.2.</span> <span class="nav-text">å­—å…¸è½¬æ¨¡å‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å½’æ¡£è§£æ¡£"><span class="nav-number">5.6.3.</span> <span class="nav-text">å½’æ¡£è§£æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ›¿æ¢æ–¹æ³•å®ç°"><span class="nav-number">5.6.4.</span> <span class="nav-text">æ›¿æ¢æ–¹æ³•å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"><span class="nav-number">5.6.5.</span> <span class="nav-text">æ‹¦æˆªæ‰€æœ‰æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•"><span class="nav-number">5.6.6.</span> <span class="nav-text">æ‹¦æˆªæ•°ç»„æ·»åŠ æ•°æ®æ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•"><span class="nav-number">5.6.7.</span> <span class="nav-text">æ‹¦æˆªå­—å…¸æ·»åŠ æ•°æ®æ–¹æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">6.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://rawgit.com/qhh0205/78e9e0b1f3114db6737f3ed8cdd51d3a/raw/3894c5be5aa2378336b1f5ee0f296fa0b22d06e9/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '82b6ced795961ee1fcca',
          clientSecret: '4a2f24a39c6fcd85813d80031c6e0262a65404f5',
          repo: 'KevinYangGit.github.io',
          owner: '',
          admin: [''],
          id: md5(location.pathname),
          distractionFreeMode: ''
        })
        gitalk.render('gitalk-container')
    </script>

  





  

  

  

  

  

  

</body>
</html>
