<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="OC底层原理," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="思考：  讲一下 OC 的消息机制 消息转发机制流程 什么是 Runtime？平时项目中有用过么？ Runtime 的具体应用">
<meta name="keywords" content="OC底层原理">
<meta property="og:type" content="article">
<meta property="og:title" content="Runtime">
<meta property="og:url" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/index.html">
<meta property="og:site_name" content="Kevin&#39;s  blog">
<meta property="og:description" content="思考：  讲一下 OC 的消息机制 消息转发机制流程 什么是 Runtime？平时项目中有用过么？ Runtime 的具体应用">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime01.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime02.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime05.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime04.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime06.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime07.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime03.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime08.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime09.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime10.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime11.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime12.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime17.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime18.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime13.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime14.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime19.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime15.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime16.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime20.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime21.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime22.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime26.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime23.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime24.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime25.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime27.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime28.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime29.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime30.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime31.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime32.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime33.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime35.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime36.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime34.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime38.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime39.png">
<meta property="og:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime37.png">
<meta property="og:updated_time" content="2020-08-12T16:35:04.440Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Runtime">
<meta name="twitter:description" content="思考：  讲一下 OC 的消息机制 消息转发机制流程 什么是 Runtime？平时项目中有用过么？ Runtime 的具体应用">
<meta name="twitter:image" content="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/Runtime01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/"/>





  <title>Runtime | Kevin's  blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kevin's  blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/12/OC底层/原理/Runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kevin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/myAvatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kevin's  blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Runtime</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-12T18:27:54+08:00">
                2020-06-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考：</p>
<ul>
<li>讲一下 OC 的消息机制</li>
<li>消息转发机制流程</li>
<li>什么是 Runtime？平时项目中有用过么？</li>
<li>Runtime 的具体应用</li>
</ul>
<a id="more"></a>
<ul>
<li><p>打印结果分别是什么？</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//打印1</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self class] = %@"</span>, [<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super class] = %@"</span>, [<span class="keyword">super</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self superclass] = %@"</span>, [<span class="keyword">self</span> superclass]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super superclass] = %@"</span>, [<span class="keyword">super</span> superclass]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">//打印2</span></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">BOOL</span> res1 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res2 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res3 = [[Person <span class="keyword">class</span>] isKindOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res4 = [[Person <span class="keyword">class</span>] isMemberOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d %d"</span>, res1, res2, res3, res4);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>以下代码能不能执行成功？如果可以，打印结果是什么？</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)print;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)print &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"my name's %@"</span>, <span class="keyword">self</span>.name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj print];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>Objective-C 是一门动态性比较强的编程语言，跟 C、C++ 等语言有着很大的不同，Objective-C 的动态性是由 Runtime API 来支撑的，Runtime API 提供的接口基本都是 C 语言的，源码由 C\C++\汇编语言编写。</p>
<h1 id="isa-详解"><a href="#isa-详解" class="headerlink" title="isa 详解"></a>isa 详解</h1><p>学习 Runtime，首先要了解它底层的一些常用数据结构，比如 isa 指针。在 arm64 架构之前，isa 就是一个普通的指针，存储着 Class、Meta-Class 对象的内存地址。从 arm64 架构开始，对 isa 进行了优化，变成了一个共用体（union）结构，还使用位域来存储更多的信息。</p>
<h2 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isTall) <span class="built_in">BOOL</span> tall;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isRich) <span class="built_in">BOOL</span> rich;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span>=isHandsome) <span class="built_in">BOOL</span> handsome;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        person.rich = <span class="literal">YES</span>;</div><div class="line">        person.handsome = <span class="literal">YES</span>;</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tall：%d, rich：%d, handsome：%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"person的大小：%zd"</span>, class_getInstanceSize([person <span class="keyword">class</span>]));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">1</span>, rich：<span class="number">1</span>, handsome：<span class="number">1</span></div><div class="line">person的大小：<span class="number">16</span></div></pre></td></tr></table></figure></p>
<p>tall（1个字节）+ rich（1个字节）+ handsome（1个字节）+ isa（8个字节）= 11个字节。根据内存对齐原则，person 的内存大小是16个字节。</p>
<p>因为 tall、rich 和 handsome 都是 BOOL 类型，它们的值只有0和1，所以可以用3个二进制位来存储他们的值。</p>
<h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><p>定义一个 char 类型的变量 _tallRichHandsome 用来存储3个 BOOL 类型变量的值：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome; <span class="comment">//0b 0000 0000</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>_tallRichHandsome 占1个字节（8位：<code>0b 0000 0000</code>），让它最右边的3位（<code>0b00000111</code>）分别存储 tall、rich 和 handsome：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0111</span> <span class="comment">//_tallRichHandsome（tall：YES, rich：YES, handsome：YES）</span></div><div class="line"></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0001</span> <span class="comment">//tall</span></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0010</span> <span class="comment">//rich</span></div><div class="line"><span class="number">0</span>b <span class="number">0000</span> <span class="number">0100</span> <span class="comment">//handsome</span></div></pre></td></tr></table></figure></p>
<h3 id="取值"><a href="#取值" class="headerlink" title="取值"></a>取值</h3><ul>
<li>按位与运算符（<code>&amp;</code>）<br>定义：参加运算的两个数据，按二进制位进行“与”运算。<br>运算规则：<code>0&amp;0=0</code>，<code>0&amp;1=0</code>，<code>1&amp;0=0</code>，<code>1&amp;1=1</code>。<br>总结：两位同时为1，结果才为1，否则结果为0。 </li>
</ul>
<p>因为“与”运算可以获取到特定位的值，所以可以通过“与”运算分别获取三个变量的值：</p>
<p>初始化 _tallRichHandsome<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_tallRichHandsome = <span class="number">0b00000101</span>; //（tall：YES, rich：NO, handsome：YES）</div></pre></td></tr></table></figure></p>
<p>获取 tall（<code>_tallRichHandsome &amp; 0b00000001</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000001</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000001</span></div></pre></td></tr></table></figure></p>
<p>获取 rich（<code>_tallRichHandsome &amp; 0b00000010</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000010</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000000</span></div></pre></td></tr></table></figure></p>
<p>获取 handsome（<code>_tallRichHandsome &amp; 0b00000100</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000101</span></div><div class="line">&amp; <span class="number">0b00000100</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000100</span></div></pre></td></tr></table></figure></p>
<p>代码实现：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="built_in">BOOL</span>)isTall;</div><div class="line">- (<span class="built_in">BOOL</span>)isRich;</div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        _tallRichHandsome = <span class="number">0</span>b00000101;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">1</span>); <span class="comment">//1（十进制）== 0b 0000 0001（二进制）</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">2</span>); <span class="comment">//2（十进制）== 0b 0000 0010（二进制）</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome &amp; <span class="number">4</span>); <span class="comment">//4（十进制）== 0b 0000 0100（二进制）</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tall：%d, rich：%d, handsome：%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">1</span>, rich：<span class="number">0</span>, handsome：<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>因为返回的是 BOOL 类型，而“与”运算取出的是有值（<code>0b00000001</code>、<code>0b00000100</code>）和0（<code>0b00000000</code>），所以为了可以获取到 YES 和 NO，可以在“与”运算的结果前加<code>!!</code>取反两次：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">!(<span class="number">0b00000000</span>)   YES</div><div class="line">!!(<span class="number">0b00000000</span>)  NO   //!!(_tallRichHandsome &amp; <span class="number">2</span>)</div><div class="line"> </div><div class="line">!(<span class="number">0b00000001</span>)   NO</div><div class="line">!!(<span class="number">0b00000001</span>)  YES  //!!(_tallRichHandsome &amp; <span class="number">1</span>)</div><div class="line"></div><div class="line">!(<span class="number">0b00000100</span>)   NO</div><div class="line">!!(<span class="number">0b00000100</span>)  YES  //!!(_tallRichHandsome &amp; <span class="number">4</span>)</div></pre></td></tr></table></figure></p>
<h3 id="掩码"><a href="#掩码" class="headerlink" title="掩码"></a>掩码</h3><p>上面👆的实现太抽象，可以使用掩码增加可读性：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask 4</span></div></pre></td></tr></table></figure></p>
<p>直接使用二进制定义掩码会更直观：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask <span class="number">0b00000001</span></div><div class="line">#<span class="built_in">define</span> RichMask <span class="number">0b00000010</span></div><div class="line">#<span class="built_in">define</span> HandsomeMask <span class="number">0b00000100</span></div></pre></td></tr></table></figure></p>
<p>使用位移运算符，简化代码：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask (<span class="number">1</span>&lt;&lt;<span class="number">0</span>)     //左移<span class="number">0</span>位：<span class="number">0b00000001</span>（二进制），<span class="number">1</span>（十进制）</div><div class="line">#<span class="built_in">define</span> RichMask (<span class="number">1</span>&lt;&lt;<span class="number">1</span>)     //左移<span class="number">1</span>位：<span class="number">0b00000010</span>（二进制），<span class="number">2</span>（十进制）</div><div class="line">#<span class="built_in">define</span> HandsomeMask (<span class="number">1</span>&lt;&lt;<span class="number">2</span>) //左移<span class="number">2</span>位：<span class="number">0b00000100</span>（二进制），<span class="number">4</span>（十进制）</div></pre></td></tr></table></figure></p>
<ul>
<li>左移运算符（<code>&lt;&lt;</code>）<br>定义：将一个运算对象的各二进制位全部左移若干位（左边的二进制位丢弃，右边补0）。</li>
</ul>
<p>最终实现：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">TallMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">0</span>)</div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">RichMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">1</span>)</div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">HandsomeMask</span> (<span class="number">1</span>&lt;&lt;<span class="number">2</span>)</div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isTall</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isRich</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">isHandsome</span> &#123;</div><div class="line">    <span class="selector-tag">return</span> !!(_tallRichHandsome &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<h3 id="设值"><a href="#设值" class="headerlink" title="设值"></a>设值</h3><ul>
<li><p>按位或运算符（<code>|</code>）<br>定义：参加运算的两个对象，按二进制位进行“或”运算。<br>运算规则：<code>0|0=0</code>，<code>0|1=1</code>，<code>1|0=1</code>，<code>1|1=1</code>。<br>总结：参加运算的两个对象只要有一个为1，其值为1。</p>
</li>
<li><p>取反运算符 (<code>~</code>)<br>定义：参加运算的一个数据，按二进制进行“取反”运算。<br>运算规则：<code>~1=0</code>，<code>~0=1</code>。<br>总结：对一个二进制数按位取反，即将0变1，1变0。</p>
</li>
</ul>
<p>设置 YES 时，跟 _tallRichHandsome 进行按位“或”运算，修改特定位置的值。<br>设置 NO 时，先对 rich 的二进制数按位取反，再跟 _tallRichHandsome 进行按位“与”运算。</p>
<p>初始化 _tallRichHandsome<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">_tallRichHandsome = <span class="number">0b00000010</span>; //（tall：NO, rich：YES, handsome：NO）</div></pre></td></tr></table></figure></p>
<p>设置 tall 为 YES（<code>_tallRichHandsome |= 0b00000001</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">| <span class="number">0b00000001</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000011</span></div></pre></td></tr></table></figure></p>
<p>设置 rich 为 NO（<code>_tallRichHandsome &amp;= ~0b00000010</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">&amp; <span class="number">0b11111101</span>  //~<span class="number">0b00000010</span>（按位取反） </div><div class="line">-------------</div><div class="line">  <span class="number">0b00000000</span></div></pre></td></tr></table></figure></p>
<p>设置 handsome 为 YES（<code>_tallRichHandsome |= 0b00000001</code>）<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b00000010</span></div><div class="line">| <span class="number">0b00000100</span></div><div class="line">-------------</div><div class="line">  <span class="number">0b00000110</span></div></pre></td></tr></table></figure></p>
<p>代码实现：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall;</div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich;</div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome;</div><div class="line">- (BOOL)isTall;</div><div class="line">- (BOOL)isRich;</div><div class="line">- (BOOL)isHandsome;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (1&lt;&lt;1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (1&lt;&lt;2)</span></div><div class="line"></div><div class="line"></div><div class="line">@interface Person()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> _tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line">@implementation Person</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall &#123;</div><div class="line">    <span class="built_in">if</span> (tall) &#123;</div><div class="line">        _tallRichHandsome |= TallMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~TallMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich &#123;</div><div class="line">    <span class="built_in">if</span> (rich) &#123;</div><div class="line">        _tallRichHandsome |= RichMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~RichMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome &#123;</div><div class="line">    <span class="built_in">if</span> (handsome) &#123;</div><div class="line">        _tallRichHandsome |= HandsomeMask;</div><div class="line">    &#125; <span class="built_in">else</span> &#123;</div><div class="line">        _tallRichHandsome &amp;= ~HandsomeMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isTall &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isRich &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isHandsome &#123;</div><div class="line">    <span class="built_in">return</span> !!(_tallRichHandsome &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@<span class="built_in">end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = YES;</div><div class="line">        person.rich = NO;</div><div class="line">        person.handsome = YES;</div><div class="line">        NSLog(@<span class="string">"tall：%d, rich：%d, handsome：%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">1</span>, rich：<span class="number">0</span>, handsome：<span class="number">1</span></div></pre></td></tr></table></figure></p>
<h2 id="位域"><a href="#位域" class="headerlink" title="位域"></a>位域</h2><p>位域，C 语言允许在一个结构体中以位为单位来指定其成员所占内存长度，这种以位为单位的成员称为“位段”或称“位域”( bit field) 。利用位段能够用较少的位数存储数据。</p>
<p>机构体的第一个成员变量在结构体内存的最右边一个二进制位，其它变量依次从左往右排。</p>
<p>使用位域增加可读性。定义结构体 _tallRichHandsome，成员变量 tall，并通过“<code>:</code>”设置 tall 在内存中只占1位。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">char</span> tall : <span class="number">1</span>; <span class="comment">//1位</span></div><div class="line">    &#125; _tallRichHandsome; <span class="comment">//1个字节</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall &#123;</div><div class="line">    _tallRichHandsome.tall = tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="built_in">BOOL</span> ret = _tallRichHandsome.tall;</div><div class="line">    <span class="keyword">return</span> ret; <span class="comment">//断点2</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tall：%d"</span>, person.isTall); <span class="comment">//断点1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">-1</span></div></pre></td></tr></table></figure></p>
<p>在断点1处查看 _tallRichHandsome 的内存：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp;(person-&gt;_tallRichHandsome)</div><div class="line">((anonymous struct) *) $0 = 0x0000000100493d98</div><div class="line">(lldb) x 0x0000000100493d98</div><div class="line">0x100493d98:<span class="number"> 01 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 2d 5b 4e<span class="number"> 53 </span>54<span class="number"> 61 </span>62<span class="number"> 50 </span> ........-[NSTabP</div><div class="line">0x100493da8:<span class="number"> 69 </span>63 6b<span class="number"> 65 </span>72<span class="number"> 56 </span>69<span class="number"> 65 </span>77<span class="number"> 43 </span>6f 6e<span class="number"> 74 </span>72 6f 6c  ickerViewControl</div></pre></td></tr></table></figure></p>
<p>内存中的“01”是十六进制的，转成二进制就是<code>0b 0000 0001</code>。即 tall：YES。</p>
<p>在断点2处查看 ret 的内存：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp; ret</div><div class="line">(BOOL *) <span class="variable">$0</span> = 0x00007ffeefbff4ff 255</div><div class="line">(lldb) x 0x00007ffeefbff4ff</div><div class="line">0x7ffeefbff4ff: ff b1 4e cb 5e ff 7f 00 00 90 81 16 03 01 00 00  <span class="built_in">..</span>N.^<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</div><div class="line">0x7ffeefbff50f: 00 50 f5 bf ef fe 7f 00 00 90 0c 00 00 01 00 00  .P<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></div></pre></td></tr></table></figure></p>
<p>内存中的“ff”是十六进制的（0xFF），转成二进制就是<code>0b11111111</code>，转成十进制是255（无符号）或-1（有符号）。这是因为 tall 原本是一个二进制位，即 tall：0b1，而返回值要求的是 BOOL 类型的值（8位：<code>0b00000000</code>），所以在返回时 tall 强转成了一个8位的值：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0b1</span> -&gt; <span class="number">0b</span> <span class="number">1111</span> <span class="number">1111</span>（二进制） //<span class="number">0xff</span>（十六进制）</div></pre></td></tr></table></figure></p>
<p>因为在系统中整数是以补码形式存放的，所以要想找到打印结果为“-1”的原因需要先算出 <code>0b11111111</code> 的原码。</p>
<ul>
<li>补码求原码<br>如果补码的符号位为“0”，表示是一个正数，其原码就是补码。<br>如果补码的符号位为“1”，表示是一个负数，那么求给定的这个补码的补码就是要求的原码。  </li>
</ul>
<p>因为 tall 是一个 char 类型的整型变量，是有符号的（LLVM），所以此时的 <code>0b11111111</code> 是有符号的。</p>
<p>因为 <code>0b11111111</code> 的最高位是符号位为“1”，表示是一个负数，所以该位不变，仍为“1”。其余七位取反后为 <code>0b10000000</code>；再加1，所以是 <code>0b10000001</code>，十进制就是 -1。所以 tall 在设置为 YES 时，打印结果是 -1。</p>
<p>如果将 tall 设置为 NO 的话，_tallRichHandsome 和 ret 的内存都是 <code>0b00000000</code>。<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x &amp;(person-&gt;_tallRichHandsome)</div><div class="line">((anonymous struct) *) $1 = 0x0000000102c6fb28</div><div class="line">(lldb) x 0x0000000102c6fb28</div><div class="line">0x102c6fb28:<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00<span class="number"> 00 </span>00 2d 5b 4e<span class="number"> 53 </span>56<span class="number"> 69 </span>62<span class="number"> 72 </span> ........-[NSVibr</div><div class="line">0x102c6fb38:<span class="number"> 61 </span>6e<span class="number"> 74 </span>53<span class="number"> 70 </span>6c<span class="number"> 69 </span>74<span class="number"> 44 </span>69<span class="number"> 76 </span>69<span class="number"> 64 </span>65<span class="number"> 72 </span>56  antSplitDividerV</div><div class="line"></div><div class="line">(lldb) p/x &amp; ret</div><div class="line">(BOOL *) $0 = 0x00007ffeefbff4ff NO</div><div class="line">(lldb) x 0x00007ffeefbff4ff</div><div class="line">0x7ffeefbff4ff:<span class="number"> 00 </span>b1 4e cb 5e ff 7f<span class="number"> 00 </span>00<span class="number"> 20 </span>fb c6<span class="number"> 02 </span>01<span class="number"> 00 </span>00  ..N.^.... ......</div><div class="line">0x7ffeefbff50f:<span class="number"> 00 </span>50 f5 bf ef fe 7f<span class="number"> 00 </span>00 8d 0c<span class="number"> 00 </span>00<span class="number"> 01 </span>00<span class="number"> 00 </span> .P..............</div></pre></td></tr></table></figure></p>
<p>综上所述，在对 tall 进行修改时，会有两个返回值“-1”和“0”。为了保证返回的结果正确，可以使用上面👆提到过的取反两次<code>!!</code>。</p>
<p>最终实现：<br>定义结构体 _tallRichHandsome，同时定义成员变量 tall、rich 和 handsome，并通过“:”设置她们在内存中只占1位：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>()</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">char</span> tall : <span class="number">1</span>; <span class="comment">//只占1位</span></div><div class="line">        <span class="keyword">char</span> rich : <span class="number">1</span>;</div><div class="line">        <span class="keyword">char</span> handsome : <span class="number">1</span>;</div><div class="line">    &#125; _tallRichHandsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall &#123;</div><div class="line">    _tallRichHandsome.tall = tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(<span class="built_in">BOOL</span>)rich &#123;</div><div class="line">    _tallRichHandsome.rich = rich;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(<span class="built_in">BOOL</span>)handsome &#123;</div><div class="line">    _tallRichHandsome.handsome = handsome;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.tall;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.rich;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!_tallRichHandsome.handsome;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = <span class="literal">YES</span>;</div><div class="line">        person.rich = <span class="literal">NO</span>;</div><div class="line">        person.handsome = <span class="literal">YES</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"tall：%d, rich：%d, handsome：%d"</span>, person.isTall, person.isRich, person.isHandsome); <span class="comment">//断点1</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">1</span>, rich：<span class="number">0</span>, handsome：<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>_tallRichHandsome 的二级制就是<code>0b00000111</code>，tall 是第一个成员变量在最右边，然后依次从左往右排。</p>
<h2 id="共用体（union）"><a href="#共用体（union）" class="headerlink" title="共用体（union）"></a>共用体（union）</h2><h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><p>struct 结构体里的成员变量各自拥有一块内存，单独存在：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime01.png" alt="Runtime01"></p>
<p>定义一个结构体 Date，内部有三个 int 类型的成员变量 year、month 和 day：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct Date &#123;</div><div class="line">    <span class="built_in">int</span> <span class="built_in">year</span>;  <span class="comment">//4个字节</span></div><div class="line">    <span class="built_in">int</span> <span class="built_in">month</span>; <span class="comment">//4个字节</span></div><div class="line">    <span class="built_in">int</span> <span class="built_in">day</span>;   <span class="comment">//4个字节</span></div><div class="line">&#125;; <span class="comment">//12个字节</span></div><div class="line"></div><div class="line"><span class="built_in">int</span> main(<span class="built_in">int</span> argc, <span class="keyword">const</span> <span class="built_in">char</span> * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="comment">//struct Date date = &#123;2020, 6, 17&#125;;</span></div><div class="line">        struct Date date;</div><div class="line">        date.<span class="built_in">year</span> = <span class="number">2020</span>;</div><div class="line">        date.<span class="built_in">month</span> = <span class="number">6</span>;</div><div class="line">        date.<span class="built_in">day</span> = <span class="number">17</span>;</div><div class="line">        NSLog(@<span class="string">"year：%d, month：%d, day：%d"</span>, date.<span class="built_in">year</span>, date.<span class="built_in">month</span>, date.<span class="built_in">day</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>：<span class="number">2020</span>, <span class="built_in">month</span>：<span class="number">6</span>, <span class="built_in">day</span>：<span class="number">17</span></div></pre></td></tr></table></figure></p>
<p>因为三个变量各自拥有自己的内存，所以打印结果各不相同。</p>
<h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><p>union 共用体里的成员变量共用一块内存，共用体的内存大小以成员变量的最大内存为准：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime02.png" alt="Runtime02"></p>
<p>定义共用体 Date，内部有三个 int 类型的变量 year、month 和 day：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">union</span> <span class="title">Date</span> &#123;</span></div><div class="line">    int year;  <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line">    int month; <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line">    int day;   <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line">&#125;; <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="class"><span class="keyword">union</span> <span class="title">Date</span> <span class="title">date</span>;</span></div><div class="line">        date.year = <span class="number">2020</span>;</div><div class="line">        NSLog(@<span class="string">"year：%d, month：%d, day：%d"</span>, date.year, date.month, date.day);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>：<span class="number">2020</span>, <span class="built_in">month</span>：<span class="number">2020</span>, <span class="built_in">day</span>：<span class="number">2020</span></div></pre></td></tr></table></figure></p>
<p>因为三个变量共用一块内存，所以三个变量访问的内存是同一块内存地址。</p>
<p>定义共用体 Date，内部有一个 int 类型的变量 year 和一个 char 类型的变量 month：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">union</span> <span class="title">Date</span> &#123;</span></div><div class="line">    int year;   <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line">    char month; <span class="regexp">//</span><span class="number">1</span>个字节</div><div class="line">&#125;; <span class="regexp">//</span><span class="number">4</span>个字节</div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="class"><span class="keyword">union</span> <span class="title">Date</span> <span class="title">date</span>;</span></div><div class="line">        date.year = <span class="number">2020</span>;</div><div class="line">        NSLog(@<span class="string">"year：%d, month：%d"</span>, date.year, date.month);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">year</span>：<span class="number">2020</span>, <span class="built_in">month</span>：<span class="number">2020</span></div></pre></td></tr></table></figure></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>将位运算和位域结合在一起定义一个共用体，用位运算读取/写入变量的值，用位域增加可读性：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (1&lt;&lt;1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (1&lt;&lt;2)</span></div><div class="line"></div><div class="line">@<span class="function">interface <span class="title">Person</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">char</span> bits;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            <span class="keyword">char</span> tall : <span class="number">1</span>;</div><div class="line">            <span class="keyword">char</span> rich : <span class="number">1</span>;</div><div class="line">            <span class="keyword">char</span> handsome : <span class="number">1</span>;</div><div class="line">        &#125;;</div><div class="line">    &#125;_tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Person</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setTall:(BOOL)tall &#123;</div><div class="line">    <span class="keyword">if</span> (tall) &#123;</div><div class="line">        _tallRichHandsome.bits |= TallMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~TallMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setRich:(BOOL)rich &#123;</div><div class="line">    <span class="keyword">if</span> (rich) &#123;</div><div class="line">        _tallRichHandsome.bits |= RichMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~RichMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setHandsome:(BOOL)handsome &#123;</div><div class="line">    <span class="keyword">if</span> (handsome) &#123;</div><div class="line">        _tallRichHandsome.bits |= HandsomeMask;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        _tallRichHandsome.bits &amp;= ~HandsomeMask;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isTall &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; TallMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isRich &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; RichMask);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isHandsome &#123;</div><div class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; HandsomeMask);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        person.tall = NO;</div><div class="line">        person.rich = NO;</div><div class="line">        person.handsome = YES;</div><div class="line">        NSLog(@<span class="string">"tall：%d, rich：%d, handsome：%d"</span>, person.isTall, person.isRich, person.isHandsome);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tall：<span class="number">0</span>, rich：<span class="number">0</span>, handsome：<span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>这里定义的 tall、rich 和 handsome 都是占1个二进制位的，如果想要修改它们占二进制位的个数，bits 也要修改为相应的定义：</p>
<p>tall、rich 和 handsome 都是占4个二进制位，那 bits 就需要定义成 int 类型（4个字节），掩码也需要占4个二进制位：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define TallMask (1&lt;&lt;0)</span></div><div class="line"><span class="comment">#define RichMask (1&lt;&lt;4)</span></div><div class="line"><span class="comment">#define HandsomeMask (1&lt;&lt;8)</span></div><div class="line"></div><div class="line">@interface Person()</div><div class="line">&#123;</div><div class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></div><div class="line">        int bits;</div><div class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">            char tall : <span class="number">4</span>;</div><div class="line">            char rich : <span class="number">4</span>;</div><div class="line">            char handsome : <span class="number">4</span>;</div><div class="line">        &#125;;</div><div class="line">    &#125;_tallRichHandsome;</div><div class="line">&#125;</div><div class="line">@<span class="keyword">end</span></div></pre></td></tr></table></figure></p>
<p>掩码也可以写成：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#<span class="built_in">define</span> TallMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">0</span>)</div><div class="line">#<span class="built_in">define</span> RichMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">4</span>)</div><div class="line">#<span class="built_in">define</span> HandsomeMask (<span class="number">0b1111</span>&lt;&lt;<span class="number">8</span>)</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> TallMask (15&lt;&lt;0)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RichMask (15&lt;&lt;4)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HandsomeMask (15&lt;&lt;8)</span></div></pre></td></tr></table></figure></p>
<h2 id="isa"><a href="#isa" class="headerlink" title="isa"></a>isa</h2><p>在源码 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 中查找 isa 的定义。  </p>
<p>找到 OC 对象的结构体 objc_object：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line">    </div><div class="line">    ··· <span class="comment">//省略一堆方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="isa-t"><a href="#isa-t" class="headerlink" title="isa_t"></a>isa_t</h3><p>可以看到 isa 是一个 isa_t 类型的变量，Jump To Definition -&gt; isa_t：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">union</span> <span class="keyword">isa_t</span> &#123;</div><div class="line">    <span class="keyword">isa_t</span>() &#123; &#125;</div><div class="line">    <span class="keyword">isa_t</span>(<span class="keyword">uintptr_t</span> value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    <span class="keyword">uintptr_t</span> bits;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ISA_BITFIELD)</span></div><div class="line">    <span class="comment">//位域</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> </div><div class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></div><div class="line">    &#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>位域中是一个宏 ISA_BITFIELD，ISA_BITFIELD 在 <code>__arm64__</code>（真机） 和 <code>__x86_64__</code>（mac电脑/模拟器） 架构有不同的定义：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># <span class="meta-keyword">if</span> __arm64__ <span class="comment">//真机上市 arm64</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                      \</span></div><div class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</div><div class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                       \</div><div class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">19</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></div><div class="line"></div><div class="line"><span class="meta"># <span class="meta-keyword">elif</span> __x86_64__ <span class="comment">//模拟器是 x86 架构</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x00007ffffffffff8ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x001f800000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x001d800000000001ULL</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                        \</span></div><div class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">44</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/</span> \</div><div class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                         \</div><div class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">8</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;56)</span></div><div class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;7)</span></div><div class="line"></div><div class="line"><span class="meta"># <span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#   <span class="meta-keyword">error</span> unknown architecture for packed isa</span></div><div class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure></p>
<p>将宏 <code>ISA_BITFIELD</code> 替换掉，保留真机（arm64）代码，可以看到一个比较完整的 isa_t：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime05.png" alt="Runtime05"></p>
<p> 因为 isa 指针的定义区分 <code>__arm64__</code>（真机）和 <code>__x86_64__</code>（mac/模拟器），所以需要用真机运行项目才能看到 <code>ISA_BITFIELD</code> 正确的成员变量的值：<br> <figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看 person 对象的 isa 指针的内存：<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x person-&gt;isa</div><div class="line">(<span class="keyword">Class</span>) $<span class="number">0</span> = <span class="number">0x1A100455641</span> Person</div></pre></td></tr></table></figure></p>
<p>转成二进制：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime04.png" alt="Runtime04"></p>
<h3 id="位域-1"><a href="#位域-1" class="headerlink" title="位域"></a>位域</h3><ul>
<li>nonpointer<br>0，代表普通的指针，isa 只存储着 Class、Meta-Class 对象的内存地址<br>1，代表优化过，isa 使用位域存储更多的信息</li>
<li>has_assoc<br>是否有设置过关联对象，如果没有，释放时会更快</li>
<li>has_cxx_dtor<br>是否有 C++ 的析构函数（.cxx_destruct），如果没有，释放时会更快</li>
<li>shiftcls<br>存储着 Class、Meta-Class 对象的内存地址信息</li>
<li>magic<br>用于在调试时分辨对象是否未完成初始化</li>
<li>weakly_referenced<br>是否有被弱引用指向过，如果没有，释放时会更快</li>
<li>deallocating<br>对象是否正在释放</li>
<li>extra_rc<br>里面存储的值是引用计数器减1</li>
<li>has_sidetable_rc<br>引用计数器是否过大无法存储在 isa 中，如果为1，那么引用计数会存储在一个叫 SideTable 的类的属性中</li>
</ul>
<p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime06.png" alt="Runtime06"><br>nonpointer：占1个二进制位，在最低位为1（第0位）。<br>has_assoc（has_associate）：占1个二进制位，为0（第1位）。<br>has_cxx_dtor：占1个二进制位，为0（第2位）。<br>shiftcls：占33个二进制位（从第3位到第35位）。<br>magic：占6个二进制位（从第36位到第41位）。magic 的值可以从宏 <code>ISA_MAGIC_VALUE</code> 看到（1a）。magic == 1a 表示初始化成功。<br>weakly_referenced：占1个二进制位，为0（第42位）。<br>deallocating：占1个二进制位，为0（第43位）。<br>has_sidetable_rc：占1个二进制位，为0（第44位）。<br>extra_rc（extra_retain_count）：占19个二进制位，为0（从第45位到63位）。</p>
<h4 id="has-assoc-和-weakly-referenced"><a href="#has-assoc-和-weakly-referenced" class="headerlink" title="has_assoc 和 weakly_referenced"></a>has_assoc 和 weakly_referenced</h4><p>has_assoc 和 weakly_referenced 标记的是曾经是否设置过，如果添加了 __weak 和关联对象再移除掉，这两个变量的值依然是1：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    __<span class="keyword">weak</span> Person *weakPerson = person;</div><div class="line">    weakPerson = <span class="literal">nil</span>;</div><div class="line">    objc_setAssociatedObject(person, <span class="string">@"name"</span>, <span class="string">@"Tom"</span>, OBJC_ASSOCIATION_COPY_NONATOMIC); <span class="comment">//添加关联对象</span></div><div class="line">    objc_setAssociatedObject(person, <span class="string">@"name"</span>, <span class="literal">nil</span>, OBJC_ASSOCIATION_COPY_NONATOMIC); <span class="comment">//移除关联对象</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看内存：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime07.png" alt="Runtime07"></p>
<h4 id="如果没有，释放时会更快"><a href="#如果没有，释放时会更快" class="headerlink" title="如果没有，释放时会更快"></a>如果没有，释放时会更快</h4><p>如果 has_assoc、has_cxx_dtor 和 weakly_referenced 为0，即没有添加过关联对象、没有析构函数和没有被弱引用指向过，会让实例对象的释放变得更快。这点可以从源码里看出来。  </p>
<p>销毁实列对象的方法 objc_destructInstance：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>objc_destructInstance</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Destroys </span>an<span class="markdown"> instance without freeing memory. </span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Calls C++ destructors.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Calls ARC ivar cleanup.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Removes associative references.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="bullet">* </span>Returns <span class="code">`obj`</span>. Does nothing if <span class="code">`obj`</span> is nil.</span></span></div><div class="line"><span class="comment"><span class="markdown"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></div><div class="line"><span class="keyword">void</span> *objc_destructInstance(id obj) </div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (obj) &#123;</div><div class="line">        <span class="comment">// Read all of the flags at once for performance.</span></div><div class="line">        <span class="built_in">bool</span> cxx = obj-&gt;hasCxxDtor();</div><div class="line">        <span class="built_in">bool</span> assoc = obj-&gt;hasAssociatedObjects();</div><div class="line"></div><div class="line">        <span class="comment">// This order is important.</span></div><div class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);</div><div class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</div><div class="line">        obj-&gt;clearDeallocating();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到在销毁实例对象的方法里，判断了有没有析构函数和关联对象，如果有的话需要先处理析构函数和关联对象。</p>
<p>Jump To Definition -&gt; clearDeallocating：<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">inline void </div><div class="line">objc_object::clearDeallocating()</div><div class="line">&#123;</div><div class="line">   <span class="built_in"> if </span>(slowpath(!isa.nonpointer)) &#123;</div><div class="line">        // Slow path for raw pointer isa.</div><div class="line">        sidetable_clearDeallocating();</div><div class="line">    &#125;</div><div class="line">    else<span class="built_in"> if </span>(slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</div><div class="line">        // Slow path for non-pointer isa with weak refs<span class="built_in"> and/or </span>side table data.</div><div class="line">        clearDeallocating_slow();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    assert(!sidetable_present());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Jump To Definition -&gt; clearDeallocating_slow：<br><figure class="highlight verilog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Slow path of clearDeallocating() </span></div><div class="line"><span class="comment">// for objects with nonpointer isa</span></div><div class="line"><span class="comment">// that were ever weakly referenced </span></div><div class="line"><span class="comment">// or whose retain count ever overflowed to the side table.</span></div><div class="line">NEVER_INLINE <span class="keyword">void</span></div><div class="line">objc_object::clearDeallocating_slow()</div><div class="line">&#123;</div><div class="line">    ASSERT(isa<span class="variable">.nonpointer</span>  &amp;&amp;  (isa<span class="variable">.weakly_referenced</span> || isa<span class="variable">.has_sidetable_rc</span>));</div><div class="line"></div><div class="line">    SideTable&amp; <span class="keyword">table</span> = SideTables()[<span class="keyword">this</span>];</div><div class="line">    <span class="keyword">table</span><span class="variable">.lock</span>();</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.weakly_referenced</span>) &#123;</div><div class="line">        weak_clear_no_lock(&amp;<span class="keyword">table</span><span class="variable">.weak_table</span>, (id)<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isa<span class="variable">.has_sidetable_rc</span>) &#123;</div><div class="line">        <span class="keyword">table</span><span class="variable">.refcnts</span><span class="variable">.erase</span>(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">table</span><span class="variable">.unlock</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 <code>clearDeallocating()</code> 方法里判断了是否有弱引用指向过，如果有的话需要在 <code>clearDeallocating_slow()</code> 方法里处理 weakly_referenced。</p>
<h3 id="ISA-MASK"><a href="#ISA-MASK" class="headerlink" title="ISA_MASK"></a>ISA_MASK</h3><p>通过 <code>isa &amp; ISA_MASK</code> 能够取出 shiftcls 的值（Class、Meta-Class 对象的内存地址信息）。因为 <code>ISA_MASK</code> 最后面三位都是0，所以获取到的 Class、Meta-Class 对象的内存地址的最后三位肯定也为0。<code>ISA_MASK</code>：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime03.png" alt="Runtime03"></p>
<p>证明：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> ViewController()</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> ViewController</div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    <span class="selector-attr">[super viewDidLoad]</span>;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, [ViewController class]);</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, object_getClass([ViewController class]));</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, [Person class]);</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%p"</span>, object_getClass([Person class]));</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>x<span class="number">1007d5550</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d5578</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d5618</span></div><div class="line"><span class="number">0</span>x<span class="number">1007d55f0</span></div></pre></td></tr></table></figure></p>
<p>可以看到打印结果的最后一位都是”8“或”0“，即”<code>1000</code>“或”<code>0000</code>“。所以 Class、Meta-Class 对象的内存地址的最后三为为0。</p>
<h2 id="位运算补充"><a href="#位运算补充" class="headerlink" title="位运算补充"></a>位运算补充</h2><p>用左移定义枚举的成员变量，用”或“运算传入多个值，用”与“运算获取传入的都有哪些值：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</div><div class="line">    OptionsOne = <span class="number">1</span>&lt;&lt;<span class="number">0</span>,</div><div class="line">    OptionsTwo = <span class="number">1</span>&lt;&lt;<span class="number">1</span>,</div><div class="line">    OptionsThree = <span class="number">1</span>&lt;&lt;<span class="number">2</span>,</div><div class="line">    OptionsFour = <span class="number">1</span>&lt;&lt;<span class="number">3</span></div><div class="line">&#125; Options;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)setOptions:(Options)option &#123;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsOne) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsOne"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsTwo) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsTwo"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsThree) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsThree"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (option &amp; OptionsFour) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"OptionsFour"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    [<span class="keyword">self</span> setOptions:OptionsOne | OptionsTwo | OptionsFour];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">OptionsOne</span></div><div class="line"><span class="attribute">OptionsTwo</span></div><div class="line"><span class="attribute">OptionsFour</span></div></pre></td></tr></table></figure></p>
<h1 id="Class-的结构"><a href="#Class-的结构" class="headerlink" title="Class 的结构"></a>Class 的结构</h1><p>类对象和元类对象都是 Class 类型的对象，元类对象是一种特殊的类对象。</p>
<p>在源码 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 中查找 objc_class 的定义。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">isa_t</span> isa;</div><div class="line"></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</div><div class="line">    <span class="comment">// Class ISA;</span></div><div class="line">    Class superclass;</div><div class="line">    <span class="keyword">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></div><div class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></div><div class="line"></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结构图：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime08.png" alt="Runtime08"></p>
<p>结构图里出现的 <code>rw</code>和 <code>ro</code> 分别表示 readwrite 和 readonly。</p>
<h2 id="class-rw-t"><a href="#class-rw-t" class="headerlink" title="class_rw_t"></a>class_rw_t</h2><p>class_rw_t 里面的 methods、properties、protocols 是二维数组，是可读可写的，包含了类的初始内容、分类的内容。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_ext_t</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</div><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div><div class="line">    <span class="keyword">char</span> *demangledName;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line"></div><div class="line">    explicit_atomic&lt;<span class="keyword">uintptr_t</span>&gt; ro_or_rw_ext;</div><div class="line"></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime09.png" alt="Runtime09"></p>
<p>类的信息在编译时是放在 class_ro_t 里的，在程序运行时，会将类的 class_ro_t 里的信息和分类的信息（注意顺序）合并起来放到 class_rw_t 里。找到合并分类信息的方法 <code>realizeClassWithoutSwift()</code>：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">static Class realizeClassWithoutSwift(Class cls, Class previously)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    class_rw_t *rw;</div><div class="line">    Class supercls;</div><div class="line">    Class metacls;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!cls) return <span class="literal">nil</span>;</div><div class="line">    <span class="function"><span class="title">if</span> (cls-&gt;</span>isRealized()) return cls;</div><div class="line">    ASSERT(cls == remapClass(cls));</div><div class="line"></div><div class="line">    <span class="comment">// fixme verify class is not in an un-dlopened part of the shared cache?</span></div><div class="line"></div><div class="line">    <span class="function"><span class="title">auto</span> ro = (const class_ro_t *)cls-&gt;</span><span class="keyword">data</span>(); <span class="comment">//取出类信息 ro</span></div><div class="line">    <span class="function"><span class="title">auto</span> isMeta = ro-&gt;</span>flags &amp; RO_META;</div><div class="line">    <span class="function"><span class="title">if</span> (ro-&gt;</span>flags &amp; RO_FUTURE) &#123;</div><div class="line">        <span class="comment">// This was a future class. rw data is already allocated.</span></div><div class="line">        <span class="function"><span class="title">rw</span> = cls-&gt;</span><span class="keyword">data</span>();</div><div class="line">        <span class="function"><span class="title">ro</span> = cls-&gt;</span><span class="function"><span class="title">data</span>()-&gt;</span>ro();</div><div class="line">        ASSERT(!isMeta);</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Normal class. Allocate writeable class data.</span></div><div class="line">        rw = objc::zalloc&lt;class_rw_t&gt;(); <span class="comment">//初始化 rw</span></div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>set_ro(ro); <span class="comment">//添加类信息 ro</span></div><div class="line">        <span class="function"><span class="title">rw</span>-&gt;</span>flags = RW_REALIZED|RW_REALIZING|isMeta;</div><div class="line">        <span class="function"><span class="title">cls</span>-&gt;</span>setData(rw);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...<span class="comment">//一堆方法</span></div><div class="line"></div><div class="line">    <span class="comment">// Attach categories</span></div><div class="line">    methodizeClass(cls, previously); <span class="comment">//添加分类信息</span></div><div class="line"></div><div class="line">    return cls;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到在处理分类的信息之前，先从类里取出了类信息 ro，然后初始化了 rw，再将 ro 保存到 rw 里。</p>
<h3 id="method-array-t"><a href="#method-array-t" class="headerlink" title="method_array_t"></a>method_array_t</h3><p>methods 是用 method_array_t 定义的，method_array_t 是一个 list_array_tt 类型的二维数组，method_array_t 里存储的是数组 method_list_t，数组 method_list_t 里存储的是 method_t：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">method_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">method_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">method_array_t</span>(<span class="keyword">method_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">method_list_t</span> * <span class="function"><span class="keyword">const</span> *<span class="title">beginCategoryMethodLists</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> beginLists();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">method_list_t</span> * <span class="function"><span class="keyword">const</span> *<span class="title">endCategoryMethodLists</span><span class="params">(Class cls)</span> <span class="keyword">const</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">method_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">method_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>如果是类对象，methods 里保存的是对象方法，如果是元类对象，methods 里保存的是类方法。  </p>
<h3 id="property-array-t"><a href="#property-array-t" class="headerlink" title="property_array_t"></a>property_array_t</h3><p>properties 是用 property_array_t 定义的，property_array_t 是一个 list_array_tt 类型的二维数组，property_array_t 里存储的是数组 property_t，数组 property_t 存储的是 property_t：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">property_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">property_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">property_array_t</span>(<span class="keyword">property_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">property_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">property_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="protocol-array-t"><a href="#protocol-array-t" class="headerlink" title="protocol_array_t"></a>protocol_array_t</h3><p>protocols 是用 protocol_array_t 定义的，protocol_array_t 是一个 list_array_tt 类型的二维数组，protocol_array_t 里存储的是数组 protocol_ref_t，数组 protocol_ref_t 存储的是 protocol_ref_t：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">protocol_array_t</span> :</span> </div><div class="line">    <span class="keyword">public</span> list_array_tt&lt;<span class="keyword">protocol_ref_t</span>, <span class="keyword">protocol_list_t</span>&gt; <span class="comment">//list_array_tt&lt;Element, List&gt;</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">protocol_ref_t</span>, <span class="keyword">protocol_list_t</span>&gt; Super;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">protocol_array_t</span>() : Super() &#123; &#125;</div><div class="line">    <span class="keyword">protocol_array_t</span>(<span class="keyword">protocol_list_t</span> *l) : Super(l) &#123; &#125;</div><div class="line"></div><div class="line">    <span class="keyword">protocol_array_t</span> duplicate() &#123;</div><div class="line">        <span class="keyword">return</span> Super::duplicate&lt;<span class="keyword">protocol_array_t</span>&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="class-ro-t"><a href="#class-ro-t" class="headerlink" title="class_ro_t"></a>class_ro_t</h2><p>class_ro_t 里面的 baseMethodList、baseProtocols、ivars、baseProperties 是一维数组，是只读的，包含了类的初始内容。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line"></div><div class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</div><div class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</div><div class="line">    </div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line"></div><div class="line">    <span class="keyword">property_list_t</span> *baseProperties;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime10.png" alt="Runtime10"></p>
<h3 id="method-list-t、ivar-list-t-和-property-list-t"><a href="#method-list-t、ivar-list-t-和-property-list-t" class="headerlink" title="method_list_t、ivar_list_t 和 property_list_t"></a>method_list_t、ivar_list_t 和 property_list_t</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>, <span class="number">0x3</span>&gt; &#123;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isUniqued</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isFixedUp</span><span class="params">()</span> <span class="keyword">const</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setFixedUp</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">uint32_t</span> indexOfMethod(<span class="keyword">const</span> <span class="keyword">method_t</span> *meth) <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">uint32_t</span> i = </div><div class="line">            (<span class="keyword">uint32_t</span>)(((<span class="keyword">uintptr_t</span>)meth - (<span class="keyword">uintptr_t</span>)<span class="keyword">this</span>) / entsize());</div><div class="line">        ASSERT(i &lt; count);</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ivar_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">ivar_t</span>, <span class="keyword">ivar_list_t</span>, <span class="number">0</span>&gt; &#123;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">containsIvar</span><span class="params">(Ivar ivar)</span> <span class="keyword">const</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (ivar &gt;= (Ivar)&amp;*begin()  &amp;&amp;  ivar &lt; (Ivar)&amp;*end());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">property_list_t</span> :</span> entsize_list_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>, <span class="number">0</span>&gt; &#123;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="method-t"><a href="#method-t" class="headerlink" title="method_t"></a>method_t</h2><p>method_t 是对方法\函数的封装。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> MethodListIMP = IMP;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">method_t</span> &#123;</span></div><div class="line">    SEL name;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *types;</div><div class="line">    MethodListIMP imp;</div><div class="line"></div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime11.png" alt="Runtime11"></p>
<h3 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h3><p><code>IMP</code> 代表函数的具体实现：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime12.png" alt="Runtime12"></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__); <span class="comment">//断点2</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    </div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    </div><div class="line">    [person test]; <span class="comment">//断点1</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>断点1打印 imp：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime17.png" alt="Runtime17"></p>
<p>断点2查看 <code>-(void)test</code> 的内存（选择 Debug -&gt; Debug Workflow -&gt; Always Show Disassembly）：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime18.png" alt="Runtime10"></p>
<p>从打印结果可以看到，imp 指向的内存地址就是 <code>-(void)test</code> 方法的内存地址。</p>
<h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><p><code>SEL</code> 代表方法\函数名，一般叫做选择器，底层结构跟 <code>char *</code> 类似。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime13.png" alt="Runtime13"></p>
<ul>
<li>可以通过 <code>@selector()</code> 和 <code>sel_registerName()</code> 获得。</li>
<li>可以通过 <code>sel_getName()</code> 和 <code>NSStringFromSelector()</code> 转成字符串。</li>
<li>不同类中相同名字的方法，所对应的方法选择器是相同的</li>
</ul>
<p>下面的代码需要用到 ClassInfo.h，并且需要真机运行：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">int main(<span class="name">int</span> argc, char * argv[]) &#123;</div><div class="line">    NSString * appDelegateClassName<span class="comment">;</span></div><div class="line">    @autoreleasepool &#123;</div><div class="line">        appDelegateClassName = NSStringFromClass([AppDelegate class])<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //SEL（@selector()）就是字符串</div><div class="line">    NSLog(@<span class="string">"%s, %s"</span>, <span class="string">"test"</span>, @selector(<span class="name">test</span>))<span class="comment">;</span></div><div class="line">    </div><div class="line">    //可以通过@selector()和sel_registerName()获得</div><div class="line">    SEL sel1 = @selector(<span class="name">test</span>)<span class="comment">;</span></div><div class="line">    SEL sel2 = sel_registerName(<span class="string">"test"</span>)<span class="comment">;</span></div><div class="line">    NSLog(@<span class="string">"sel1：%s, sel2：%s"</span>, sel1, sel2)<span class="comment">;</span></div><div class="line">    </div><div class="line">    //可以通过sel_getName()和NSStringFromSelector()转成字符串</div><div class="line">    char *selString1 = sel_getName(sel1);</div><div class="line">    NSString *selString2 = NSStringFromSelector(<span class="name">sel2</span>)<span class="comment">;</span></div><div class="line">    NSLog(@<span class="string">"selString1：%s, selString2：%@"</span>, selString1, selString2)<span class="comment">;</span></div><div class="line">    </div><div class="line">    //不同类中相同名字的方法，所对应的方法选择器是相同的</div><div class="line">    NSLog(@<span class="string">"%p, %p, %p"</span>, @selector(<span class="name">test</span>), @selector(<span class="name">test</span>), sel_registerName(<span class="string">"test"</span>))<span class="comment">;</span></div><div class="line">    </div><div class="line">    return UIApplicationMain(<span class="name">argc</span>, argv, <span class="literal">nil</span>, appDelegateClassName)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">test</span>, <span class="keyword">test</span></div><div class="line">sel1：<span class="keyword">test</span>, sel2：<span class="keyword">test</span></div><div class="line">selString1：<span class="keyword">test</span>, selString2：<span class="keyword">test</span></div><div class="line"><span class="number">0x7fff5281ed06</span>, <span class="number">0x7fff5281ed06</span>, <span class="number">0x7fff5281ed06</span></div></pre></td></tr></table></figure></p>
<h3 id="types"><a href="#types" class="headerlink" title="types"></a>types</h3><p>types 包含了函数返回值、参数编码的字符串。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime14.png" alt="Runtime14"></p>
<p>下面的代码需要用到 ClassInfo.h，并且需要真机运行，将 main.m 改成 main.mm：<br>例1：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    </div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    [person test]; <span class="comment">//断点1</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>断点1出打印 types：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime19.png" alt="Runtime19"><br>“v16@0:8” 是类型编码：<code>v</code>：返回值类型 void，<code>16</code>：参数占的字节数之和（id（8个字节） + SEL（8个字节）），<code>@</code>：第一个参数的类型 id，<code>0</code>：第一个参数内存的开始位置，<code>:</code>：第二个参数的类型 SEL，<code>8</code>：第二个参数内存的开始位置（id 占了8个字节）。  </p>
<p>下面的代码需要用到 ClassInfo.h，并且需要真机运行，将 main.m 改成 main.mm：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// v 16 @ 0 : 8</span></div><div class="line"><span class="comment">//- (void)test:(id)self _cmd:(SEL)_cmd</span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>例2：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">int</span>)test:(<span class="keyword">int</span>)age height:(<span class="keyword">float</span>)height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">int</span>)test:(<span class="keyword">int</span>)age height:(<span class="keyword">float</span>)height &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    test_objc_class *cls = (__bridge test_objc_class*)[Person <span class="keyword">class</span>];</div><div class="line">    class_rw_t *data = cls-&gt;data();</div><div class="line">    [person test:<span class="number">20</span> height:<span class="number">30</span>]; <span class="comment">//断点1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>断点1出打印 types：：<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">P<span class="function"><span class="title">rinting</span> description of <span class="keyword">data</span>-&gt;</span><span class="function"><span class="title">methods</span>-&gt;</span>first.types:</div><div class="line">(const char *) types = <span class="number">0</span>x0000000100087d4d <span class="string">"i24@0:8i16f20"</span></div></pre></td></tr></table></figure></p>
<p>“i24@0:8i16f20” 是类型编码：<code>i</code>：范围值类型 int，<code>24</code>：参数占的字节数之和（id（8个字节） + SEL（8个字节）+ int（4个字节）+ float（4个字节）），<code>@</code>：第一个参数的类型 id，<code>0</code>：第一个参数内存的开始位置，<code>:</code>：第二个参数的类型 SEL，<code>8</code>：第二个参数内存的开始位置（id 占了8个字节），<code>i</code>：第三个参数的类型 int，<code>16</code>：第三个参数的开始位置（id 占了8个字节 + SEL 占了8个字节），<code>f</code>：第四个参数的类型 float，<code>20</code>：第四个参数的开始位置（id 占了8个字节 + SEL 占了8个字节 + int 占了4个字节）。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="comment">// i 24 @ 0 : 8 i 16 f 20</span></div><div class="line"><span class="comment">// int test:(id self, SEL _cmd, int age, float height)</span></div><div class="line">- (<span class="keyword">void</span>)test &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="Type-Encoding"><a href="#Type-Encoding" class="headerlink" title="Type Encoding"></a>Type Encoding</h3><p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">Type Encodings</a> 是 iOS 中提供的一个叫做 @encode 的指令，可以将具体的类型表示成字符串编码。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime15.png" alt="Runtime15"></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="built_in">NSString</span> * appDelegateClassName;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        appDelegateClassName = <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"id == %s，SEL == %s"</span>, <span class="keyword">@encode</span>(<span class="keyword">id</span>), <span class="keyword">@encode</span>(SEL));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, appDelegateClassName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">id</span> == @，SEL == :</div></pre></td></tr></table></figure></p>
<h2 id="方法缓存"><a href="#方法缓存" class="headerlink" title="方法缓存"></a>方法缓存</h2><p>Class 内部结构中有个方法缓存 cache（cache_t），用散列表（哈希表）来缓存曾经调用过的方法，可以提高方法的查找速度。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime16.png" alt="Runtime16"></p>
<p>缓存查找：objc-cache.mm -&gt; <code>bucket_t * cache_t::find(cache_key_t k, id receiver)</code></p>
<p>cache_t 里通过 _buckets 缓存方法，通过 _mask 计算索引，通过 _occupied 统计已经缓存的方法的数量。_buckets 里缓存的是 bucke_t 结构体：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">_key</span> = @selector(方法名)</div><div class="line"><span class="attr">_imp</span> = 方法的函数地址</div></pre></td></tr></table></figure></p>
<h3 id="mask"><a href="#mask" class="headerlink" title="_mask"></a>_mask</h3><p>_mask 的值是散列表的长度-1，保证“与”运算的结果不会超出散列表的长度（&amp;_mask &lt;= _mask），即计算出的索引不会越界。</p>
<p>假设 _mask = 0b0000 1000：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">  <span class="number">0b0100</span> <span class="number">1101</span></div><div class="line">&amp; <span class="number">0b0000</span> <span class="number">1000</span></div><div class="line">--------------</div><div class="line">  <span class="number">0b0000</span> <span class="number">1000</span></div></pre></td></tr></table></figure></p>
<p>散列表（哈希表）的实现逻辑：<br>1、实现一个方法1可以计算出索引；<br>2、实现一个方法2可以解决索引冲突（如：对索引减 1 计算出新的索引值）；</p>
<p>使用求余 <code>%</code> 也可以实现散列表（哈希表），通过求余计算出的索引也可以保证不越界。</p>
<h3 id="buckets"><a href="#buckets" class="headerlink" title="_buckets"></a>_buckets</h3><p>_buckets 在初始化时的空间大小是指定好的，并且内部的数据都是 NULL（空间换时间）。如果 _buckets 里的数据满了，_buckets 会将数据清空 -&gt; 扩容x2（一倍）-&gt; 重新缓存。</p>
<p>先通过 <code>mask_t begin = cache_hash(sel, m)</code> 计算出索引 begin：<br>如果 begin 处没有值，缓存。<br>如果 begin 处有值，是当前需要缓存的方法，表示已经缓存过了直接返回。<br>如果 begin 处有值，不是当前需要缓存的方法，通过 <code>(i = cache_next(i, m)</code> 计算出新的索引，如果新的索引不等于 begin 则重新判断，如果新的索引等于 begin 则去扩容（bad_cache()）。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">void cache_t:<span class="type"></span>:insert(Class cls, SEL sel, IMP imp, id receiver)</div><div class="line">&#123;</div><div class="line">    ...... <span class="comment">//省略</span></div><div class="line"></div><div class="line">    <span class="comment">// Use the cache as-is if it is less than 3/4 full</span></div><div class="line">    mask_t <span class="keyword">new</span><span class="type">Occupied</span> = occupied() + <span class="number">1</span>; <span class="comment">//occupied() 散列表长度，newOccupied 添加后的长度</span></div><div class="line">    unsigned oldCapacity = capacity(), capacity = oldCapacity;</div><div class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123; <span class="comment">//第一次</span></div><div class="line">        <span class="comment">// Cache is read-only. Replace it.</span></div><div class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(<span class="keyword">new</span><span class="type">Occupied</span> + CACHE_END_MARKER &lt;= capacity / <span class="number">4</span> * <span class="number">3</span>)) &#123; <span class="comment">//已经缓存的数据不足3/4</span></div><div class="line">        <span class="comment">// Cache is less than 3/4 full. Use it as-is.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        capacity = capacity ? capacity * <span class="number">2</span> : <span class="type">INIT_CACHE_SIZE</span>; <span class="comment">//扩容x2</span></div><div class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</div><div class="line">            capacity = MAX_CACHE_SIZE;</div><div class="line">        &#125;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>); <span class="comment">//清空数据 -&gt; 扩容</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bucket_t *b = buckets();</div><div class="line">    mask_t m = capacity - <span class="number">1</span>;</div><div class="line">    mask_t begin = cache_hash(sel, m); <span class="comment">//计算出索引</span></div><div class="line">    mask_t i = begin;</div><div class="line"></div><div class="line">    <span class="comment">// Scan for the first unused slot and insert there.</span></div><div class="line">    <span class="comment">// There is guaranteed to be an empty slot because the</span></div><div class="line">    <span class="comment">// minimum size is 4 and we resized at 3/4 full.</span></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (fastpath(b[i].sel() == <span class="number">0</span>)) &#123; <span class="comment">//如果 begin 处没有值，缓存</span></div><div class="line">            incrementOccupied();</div><div class="line">            b[i].<span class="keyword">set</span>&lt;Atomic, Encoded&gt;(sel, imp, cls);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (b[i].sel() == sel) &#123; <span class="comment">//索引处有值，是当前需要缓存的方法</span></div><div class="line">            <span class="comment">// The entry was added to the cache by some other thread</span></div><div class="line">            <span class="comment">// before we grabbed the cacheUpdateLock.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (fastpath((i = cache_next(i, m)) != begin)); <span class="comment">//计算出新的索引，判断新的索引是否等于 begin，如果等于 begin 则重新判断，如果不等于 begin 则调用 bad_cache() 处理异常缓存</span></div><div class="line"></div><div class="line">    cache_t:<span class="type"></span>:bad_cache(receiver, (SEL)sel, cls);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line">void cache_t:<span class="type"></span>:reallocate(mask_t oldCapacity, mask_t <span class="keyword">new</span><span class="type">Capacity</span>, bool freeOld)</div><div class="line">&#123;</div><div class="line">    bucket_t *oldBuckets = buckets(); <span class="comment">//旧的散列表</span></div><div class="line">    bucket_t *<span class="keyword">new</span><span class="type">Buckets</span> = allocateBuckets(<span class="keyword">new</span><span class="type">Capacity</span>); <span class="comment">//新的散列表</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache's old contents are not propagated. </span></div><div class="line">    <span class="comment">// This is thought to save cache memory at the cost of extra cache fills.</span></div><div class="line">    <span class="comment">// fixme re-measure this</span></div><div class="line"></div><div class="line">    ASSERT(<span class="keyword">new</span><span class="type">Capacity</span> &gt; <span class="number">0</span>);</div><div class="line">    ASSERT((uintptr_t)(mask_t)(<span class="keyword">new</span><span class="type">Capacity</span>-<span class="number">1</span>) == <span class="keyword">new</span><span class="type">Capacity</span>-<span class="number">1</span>);</div><div class="line"></div><div class="line">    setBucketsAndMask(<span class="keyword">new</span><span class="type">Buckets</span>, <span class="keyword">new</span><span class="type">Capacity</span> - <span class="number">1</span>); <span class="comment">//使用新的散列表，_mask = newCapacity - 1</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (freeOld) &#123;</div><div class="line">        cache_collect_free(oldBuckets, oldCapacity); <span class="comment">//清空旧的数据</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>__arm64__</code> 下的 cache_next 方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> mask_t <span class="title">cache_next</span><span class="params">(<span class="keyword">mask_t</span> i, <span class="keyword">mask_t</span> mask)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> i ? i<span class="number">-1</span> : mask;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="空间换时间"><a href="#空间换时间" class="headerlink" title="空间换时间"></a>空间换时间</h3><p>散列表（哈希表）遍历元素的效率比数组高的原因是牺牲了一定的空间换取了时间。  </p>
<h4 id="例1："><a href="#例1：" class="headerlink" title="例1："></a>例1：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init]<span class="comment">;</span></div><div class="line">        test_objc_class *cls = (__bridge test_objc_class*)[Person class]<span class="comment">;</span></div><div class="line"></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line"></div><div class="line">        NSLog(@<span class="string">"--------"</span>)<span class="comment">; //断点</span></div><div class="line"></div><div class="line">        <span class="keyword">cache_t </span><span class="keyword">cache </span>= cls-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>       <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>       for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">            <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>           if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">10</span>) &#123;</div><div class="line">                NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125; else &#123;</div><div class="line">                NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--------</div><div class="line">init <span class="number">0x7ffe558b5aa</span></div><div class="line">testPerson <span class="number">0xc5e8</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x600000781640</span></div></pre></td></tr></table></figure></p>
<p>断点处查看 _mask 和 _occupied：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime20.png" alt="Runtime20"></p>
<table>
<thead>
<tr>
<th>索引</th>
<th>缓存的方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bucket_t（_key = @selector(init), _imp）</td>
</tr>
<tr>
<td>1</td>
<td>bucket_t（_key = @selector(testPerson), _imp）</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>第一次调用 <code>[person testPerson]</code> 即 <code>objc_msgSend(objc_getClass(&quot;Person&quot;), sel_registerName(&quot;testPerson&quot;))</code> 向 person 实例对象发送一条 <code>sel_registerName(&quot;testPerson&quot;)</code> 消息，person 会通过 isa 找到 Person 类对象查找 <code>-(void)testPerson</code> 方法，先查 cache（_buckets），没查到，再通过 bits 找到 class_rw_t 里的 methods 查，查到后返回。（如果没有找到，再通过 superclass 找到父类的类对象继续查找（查找方式相同）。假设在查找到基类的类对象时找到了 <code>-(void)testPerson</code> 方法，实列对象 person 会把 <code>-(void)testPerson</code> 方法缓存到 _buckets 里然后返回。）</p>
<p>在缓存 <code>@selector(testPerson)</code> 方法时，先计算出索引（1），然后检查索引处是否有值，没值，将 <code>@selector(testPerson)</code> 缓存到对象的索引处。</p>
<p>第二次调用 <code>[person testPerson]</code> 会先去实例对象 person 的 _buckets 里找，找到对应的索引处的值判断是否是当前方法 <code>@selector(testPerson)</code>，如果是就直接返回。（如果不是就将索引减 1 继续在 _buckets 里查找，找到了就直接返回。如果找了一圈还没有找到，会同第一次一样去类对象和父类的类对象查找，找到后缓存到 _buckets 里并返回。）</p>
<h4 id="例2："><a href="#例2：" class="headerlink" title="例2："></a>例2：</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *person = [[Person alloc] init]<span class="comment">;</span></div><div class="line">        test_objc_class *cls = (__bridge test_objc_class*)[Person class]<span class="comment">;</span></div><div class="line"></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testPerson]<span class="comment">;</span></div><div class="line">        [person testStudent]<span class="comment">;</span></div><div class="line">        [person testStudent2]<span class="comment">;</span></div><div class="line"></div><div class="line">        NSLog(@<span class="string">"--------"</span>)<span class="comment">; //断点</span></div><div class="line"></div><div class="line">        <span class="keyword">cache_t </span><span class="keyword">cache </span>= cls-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>       <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>       for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">            <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>           if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">10</span>) &#123;</div><div class="line">                NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125; else &#123;</div><div class="line">                NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">--------</div><div class="line">testStudent2 <span class="number">0xc5</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">testStudent <span class="number">0xc5d</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x600001008500</span></div></pre></td></tr></table></figure></p>
<p>断点处查看 _mask 和 _occupied：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime21.png" alt="Runtime21"></p>
<table>
<thead>
<tr>
<th>索引</th>
<th>缓存的方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bucket_t（_key = @selector(testStudent2), _imp）</td>
</tr>
<tr>
<td>1</td>
<td>NULL</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>bucket_t（_key = @selector(testStudent), _imp）</td>
</tr>
<tr>
<td>4</td>
<td>NULL</td>
</tr>
<tr>
<td>5</td>
<td>NULL</td>
</tr>
<tr>
<td>6</td>
<td>NULL</td>
</tr>
<tr>
<td>7</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>在缓存 <code>@selector(testStudent)</code> 方法时，_buckets 的空间不够了，_buckets 清空数据 -&gt; 扩容x2（8） -&gt; 重新缓存。先计算出索引（3），然后检查索引处是否有值，没值，将 <code>@selector(testPerson)</code> 缓存到对象的索引处。</p>
<p>在缓存 <code>@selector(testStudent2)</code> 方法时，先计算出索引（0），然后检查索引处是否有值，没值，将 <code>@selector(testStudent2)</code> 缓存到对象的索引处。（如果索引值与 <code>@selector(testStudent)</code> 相同（3），检查到索引处有值，然后将索引减 1 获取到新的索引（2），再检查新的索引处是否有值，没值，将 <code>@selector(testStudent2)</code> 缓存到对象的索引处。）</p>
<h4 id="例3"><a href="#例3" class="headerlink" title="例3"></a>例3</h4><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    NSString * appDelegateClassName<span class="comment">;</span></div><div class="line">    @autoreleasepool &#123;</div><div class="line">        appDelegateClassName = NSStringFromClass([AppDelegate class])<span class="comment">;</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Teacher *teacher = [[Teacher alloc] init]<span class="comment">;</span></div><div class="line">    test_objc_class *teacherClass = (__bridge test_objc_class *)[Teacher class]<span class="comment">;</span></div><div class="line"></div><div class="line">    [teacher teacherTest]<span class="comment">;</span></div><div class="line">    [teacher studentTest]<span class="comment">;</span></div><div class="line">    [teacher personTest]<span class="comment">;</span></div><div class="line"></div><div class="line">    NSLog(@<span class="string">"--------"</span>)<span class="comment">; //断点</span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t </span><span class="keyword">cache </span>= teacherClass-&gt;<span class="keyword">cache;</span></div><div class="line"><span class="keyword"> </span>   <span class="keyword">bucket_t </span>*<span class="keyword">buckets </span>= <span class="keyword">cache._buckets;</span></div><div class="line"><span class="keyword"> </span>   for (int i = <span class="number">0</span><span class="comment">; i &lt;= cache._mask; i++) &#123;</span></div><div class="line">        <span class="keyword">bucket_t </span><span class="keyword">bucket </span>= <span class="keyword">buckets[i];</span></div><div class="line"><span class="keyword"> </span>       if (<span class="keyword">bucket._key </span>&amp;&amp; <span class="keyword">bucket._key </span>&gt; <span class="number">1</span>) &#123;</div><div class="line">            NSLog(@<span class="string">"%s %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>       &#125; else &#123;</div><div class="line">            NSLog(@<span class="string">"%lu %p"</span>, <span class="keyword">bucket._key, </span><span class="keyword">bucket._imp);</span></div><div class="line"><span class="keyword"> </span>       &#125;</div><div class="line">    &#125;</div><div class="line">    return UIApplicationMain(argc, argv, nil, appDelegateClassName)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">studentTest <span class="number">0x5aa</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line">personTest <span class="number">0x44c8</span></div><div class="line"><span class="number">0</span> <span class="number">0x0</span></div><div class="line"><span class="number">1</span> <span class="number">0x6000025f8380</span></div></pre></td></tr></table></figure></p>
<p>断点处查看 _mask 和 _occupied：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime22.png" alt="Runtime22"></p>
<table>
<thead>
<tr>
<th>索引</th>
<th>缓存的方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>NULL</td>
</tr>
<tr>
<td>1</td>
<td>bucket_t（_key = @selector(studentTest), _imp）</td>
</tr>
<tr>
<td>2</td>
<td>NULL</td>
</tr>
<tr>
<td>3</td>
<td>NULL</td>
</tr>
<tr>
<td>4</td>
<td>NULL</td>
</tr>
<tr>
<td>5</td>
<td>bucket_t（_key = @selector(personTest), _imp）</td>
</tr>
<tr>
<td>6</td>
<td>NULL</td>
</tr>
<tr>
<td>7</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>调用 <code>[teacher teacherTest]</code> 即 <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;teacherTest&quot;))</code> 向 teacher 实例对象发送一条 <code>sel_registerName(&quot;teacherTest&quot;)</code> 消息，teacher 会通过 isa 找到 Teacher 类对象查找 <code>-(void)teacherTest</code> 方法，先查 cache（_buckets），没查到，再通过 bits 找到 class_rw_t 里的 methods 查，查到后缓存到 _buckets 里并返回。</p>
<p>调用 <code>[teacher studentTest]</code> 即 <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;studentTest&quot;))</code> 向 teacher 实例对象发送一条 <code>sel_registerName(&quot;studentTest&quot;)</code> 消息，teacher 会通过 isa 找到 Teacher 类对象查找 <code>-(void)studentTest</code> 方法，先查 cache（_buckets），没查到，再通过 bits 找到 class_rw_t 里的 methods 查，没查到。 Teacher 类对象通过 superclass 找到父类 Student 类对象，并在 Student 类对象的 _buckets 里查找，没找到，再通过到 class_rw_t 里查找，查到后缓存到 Teacher 类对象的 _buckets 里并返回。</p>
<p>调用 <code>[teacher personTest]</code> 即 <code>objc_msgSend(objc_getClass(&quot;Teacher&quot;), sel_registerName(&quot;personTest&quot;))</code> 向 teacher 实例对象发送一条 <code>sel_registerName(&quot;personTest&quot;)</code> 消息，teacher 会通过 isa 找到 Teacher 类对象查找，先查找 _buckets，没查到，再到 class_rw_t 里的方法列表 methods 查找，没查到。Teacher 类对象会通过 superclass 找到父类 Student 类对象，并在 Student 类对象的 _buckets 里查找，没找到，再到 class_rw_t 里查找，没查到。 Student 类对象会通过 superclass 找到父类 Person 类对象，并在 Person 类对象的 _buckets 里查找，没查到，再到 class_rw_t 里查找，查到后缓存到 Teacher 类对象的 _buckets 里并返回。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><ol>
<li>先查当前类对象的缓存 _buckets，再查当前类对象的方法列表 class_rw_t -&gt; methods;</li>
<li>先查父类类对象的缓存 _buckets，再查父类类对象的方法列表 class_rw_t -&gt; methods;</li>
<li>在当前类对象的缓存 _buckets 里查到后直接返回；</li>
<li>在当前类对象的方法列表 class_rw_t -&gt; methods 里查到后，先缓存到当前类对象的 _buckets 里，再返回；</li>
<li>在父类类对象的缓存 _buckets 里查到后，先缓存到当前类对象的 _buckets 里，再返回；</li>
<li>在父类类对象的方法列表 class_rw_t -&gt; methods 里查到后，先缓存到当前类对象的 _buckets 里，再返回；</li>
</ol>
<h1 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h1><p>OC 中的方法调用，其实都是转换为 objc_msgSend 函数的调用。objc_msgSend 的执行流程可以分为三大阶段，即消息发送、动态方法解析和消息转发。</p>
<h2 id="objc-msgSend-执行流程"><a href="#objc-msgSend-执行流程" class="headerlink" title="objc_msgSend 执行流程"></a>objc_msgSend 执行流程</h2><p>_objc_msgSend 的入口在汇编文件 objc-msg-arm64.s 里。runtime 的实现是用 c、c++ 和汇编语言组成的，对于一些调用频次比较高的方法一般使用汇编语言实现。对于 _objc_msgSend 等方法，为了提高效率都是使用汇编语言实现的。</p>
<p>在源码 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 中查找 _objc_msgSend 的实现。  </p>
<h3 id="objc-msgSend-1"><a href="#objc-msgSend-1" class="headerlink" title="_objc_msgSend"></a>_objc_msgSend</h3><p>ENTRY 的定义，ENTRY 是一个宏：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//macro 是宏的意思</span></div><div class="line"><span class="selector-class">.macro</span> ENTRY <span class="comment">/* name */</span></div><div class="line">	<span class="selector-class">.text</span>         <span class="comment">//数据段</span></div><div class="line">	<span class="selector-class">.align</span> <span class="number">5</span></div><div class="line">	<span class="selector-class">.globl</span>    $<span class="number">0</span>  <span class="comment">//全局名字</span></div><div class="line">$<span class="number">0</span>:</div><div class="line">.endmacro</div></pre></td></tr></table></figure></p>
<p>_objc_msgSend 的定义，从 ENTRY 开始，到 END_ENTRY 结束：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">ENTRY _objc_msgSend</div><div class="line">    //---------------------------- 消息发送 start ----------------------------</div><div class="line">	UNWIND _objc_msgSend, NoFrame</div><div class="line">        //p<span class="number">0</span>寄存器：消息接受者，receiver（_objc_msgSend 的第一个参数）</div><div class="line">	cmp	p<span class="number">0</span>, <span class="symbol">#0</span>			// nil check <span class="keyword">and</span> tagged pointer check</div><div class="line">#if SUPPORT_TAGGED_POINTERS</div><div class="line">        //b：跳转、调用。le：小于等于。如果 p<span class="number">0</span> 小于等于 <span class="number">0</span>，就跳转到 LNilOrTagged 方法（如果消息接收者是 nil 就跳转到 LNilOrTagged）</div><div class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</div><div class="line">#else</div><div class="line">	b.<span class="keyword">eq</span>	LReturnZero</div><div class="line">#endif</div><div class="line">	ldr	p<span class="number">13</span>, [<span class="keyword">x</span><span class="number">0</span>]		// p<span class="number">13</span> = isa</div><div class="line">	GetClassFromIsa_p<span class="number">16</span> p<span class="number">13</span>		// p<span class="number">16</span> = class</div><div class="line">LGetIsaDone:</div><div class="line">	// calls imp <span class="keyword">or</span> objc_msgSend_uncached</div><div class="line">	CacheLookup NORMAL, _objc_msgSend //查找缓存，参数 NORMAL。（实现👇）</div><div class="line"></div><div class="line">#if SUPPORT_TAGGED_POINTERS</div><div class="line">LNilOrTagged:</div><div class="line">        // 跳转到 LReturnZero 方法</div><div class="line">	b.<span class="keyword">eq</span>	LReturnZero		// nil check</div><div class="line"></div><div class="line">	// tagged</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_classes<span class="title">@PAGEOFF</span></div><div class="line">	ubfx	<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#60</span>, <span class="symbol">#4</span></div><div class="line">	ldr	<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer<span class="title">@PAGEOFF</span></div><div class="line">	cmp	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">16</span></div><div class="line">	b.<span class="keyword">ne</span>	LGetIsaDone</div><div class="line"></div><div class="line">	// ext tagged</div><div class="line">	adrp	<span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGE</span></div><div class="line">	<span class="keyword">add</span>	<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">10</span>, _objc_debug_taggedpointer_ext_classes<span class="title">@PAGEOFF</span></div><div class="line">	ubfx	<span class="keyword">x</span><span class="number">11</span>, <span class="keyword">x</span><span class="number">0</span>, <span class="symbol">#52</span>, <span class="symbol">#8</span></div><div class="line">	ldr	<span class="keyword">x</span><span class="number">16</span>, [<span class="keyword">x</span><span class="number">10</span>, <span class="keyword">x</span><span class="number">11</span>, LSL <span class="symbol">#3</span>]</div><div class="line">	b	LGetIsaDone</div><div class="line">// SUPPORT_TAGGED_POINTERS</div><div class="line">#endif</div><div class="line"></div><div class="line">LReturnZero:</div><div class="line">	// <span class="keyword">x</span><span class="number">0</span> is already zero</div><div class="line">	mov	<span class="keyword">x</span><span class="number">1</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">0</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">1</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">2</span>, <span class="symbol">#0</span></div><div class="line">	movi	d<span class="number">3</span>, <span class="symbol">#0</span></div><div class="line">	<span class="keyword">ret</span> //相当于 <span class="keyword">c</span> 语言的 return</div><div class="line"></div><div class="line">	END_ENTRY _objc_msgSend</div></pre></td></tr></table></figure></p>
<p>_objc_msgSend 涉及相关方法的实现<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//👉 CacheLookup 的实现，查找缓存（在当前类对象的 cache 中查找）</span></div><div class="line">.macro CacheLookup</div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">// Restart protocol:</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   As soon as we're past the LLookupStart$1 label we may have loaded</span></div><div class="line">	<span class="comment">//   an invalid cache pointer or mask.</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   When task_restartable_ranges_synchronize() is called,</span></div><div class="line">	<span class="comment">//   (or when a signal hits us) before we're past LLookupEnd$1,</span></div><div class="line">	<span class="comment">//   then our PC will be reset to LLookupRecover$1 which forcefully</span></div><div class="line">	<span class="comment">//   jumps to the cache-miss codepath which have the following</span></div><div class="line">	<span class="comment">//   requirements:</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   GETIMP:</span></div><div class="line">	<span class="comment">//     The cache-miss is just returning NULL (setting x0 to 0)</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">//   NORMAL and LOOKUP:</span></div><div class="line">	<span class="comment">//   - x0 contains the receiver</span></div><div class="line">	<span class="comment">//   - x1 contains the selector</span></div><div class="line">	<span class="comment">//   - x16 contains the isa</span></div><div class="line">	<span class="comment">//   - other registers are set as per calling conventions</span></div><div class="line">	<span class="comment">//</span></div><div class="line">LLookupStart$<span class="number">1</span>:</div><div class="line"></div><div class="line">	<span class="comment">// p1 = SEL, p16 = isa</span></div><div class="line">	ldr	p11, [x16, <span class="meta">#CACHE]				<span class="comment">// p11 = mask|buckets</span></span></div><div class="line"></div><div class="line"><span class="meta">#if CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_HIGH_16</span></div><div class="line">	<span class="keyword">and</span>	p10, p11, <span class="meta">#0x0000ffffffffffff	<span class="comment">// p10 = buckets (缓存)</span></span></div><div class="line">	<span class="keyword">and</span>	p12, p1, p11, LSR <span class="meta">#48		<span class="comment">// x12 = _cmd &amp; mask (通过“与”运算计算索引)</span></span></div><div class="line"><span class="meta">#elif CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_LOW_4</span></div><div class="line">	<span class="keyword">and</span>	p10, p11, <span class="meta">#~0xf			<span class="comment">// p10 = buckets</span></span></div><div class="line">	<span class="keyword">and</span>	p11, p11, <span class="meta">#0xf			<span class="comment">// p11 = maskShift</span></span></div><div class="line">	mov	p12, <span class="meta">#0xffff</span></div><div class="line">	lsr	p11, p12, p11				<span class="comment">// p11 = mask = 0xffff &gt;&gt; p11</span></div><div class="line">	<span class="keyword">and</span>	p12, p1, p11				<span class="comment">// x12 = _cmd &amp; mask</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#error Unsupported cache mask storage for ARM64.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"></div><div class="line">	add	p12, p10, p12, LSL <span class="meta">#(1+PTRSHIFT)</span></div><div class="line">		             <span class="comment">// p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span></div><div class="line"></div><div class="line">	ldp	p17, p9, [x12]		<span class="comment">// &#123;imp, sel&#125; = *bucket</span></div><div class="line"><span class="number">1</span>:	cmp	p9, p1			<span class="comment">// if (bucket-&gt;sel != _cmd)</span></div><div class="line">	b.ne	<span class="number">2</span>f			<span class="comment">//     scan more</span></div><div class="line">	CacheHit $<span class="number">0</span>			<span class="comment">// call or return imp (查找到函数地址，调用或者返回。hit：命中，找到。)</span></div><div class="line">	</div><div class="line"><span class="number">2</span>:	<span class="comment">// not hit: p12 = not-hit bucket（没有查找到）</span></div><div class="line">	CheckMiss $<span class="number">0</span>			<span class="comment">// miss if bucket-&gt;sel == 0 (实现👇)</span></div><div class="line">	cmp	p12, p10		<span class="comment">// wrap if bucket == buckets</span></div><div class="line">	b.eq	<span class="number">3</span>f</div><div class="line">	ldp	p17, p9, [x12, <span class="meta">#-BUCKET_SIZE]!	<span class="comment">// &#123;imp, sel&#125; = *--bucket</span></span></div><div class="line">	b	<span class="number">1</span>b			<span class="comment">// loop</span></div><div class="line"></div><div class="line"><span class="number">3</span>:	<span class="comment">// wrap: p12 = first bucket, w11 = mask</span></div><div class="line"><span class="meta">#if CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_HIGH_16</span></div><div class="line">	add	p12, p12, p11, LSR <span class="meta">#(48 - (1+PTRSHIFT))</span></div><div class="line">					<span class="comment">// p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span></div><div class="line"><span class="meta">#elif CACHE_MASK_STORAGE == CACHE_MASK_STORAGE_LOW_4</span></div><div class="line">	add	p12, p12, p11, LSL <span class="meta">#(1+PTRSHIFT)</span></div><div class="line">					<span class="comment">// p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#error Unsupported cache mask storage for ARM64.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">	<span class="comment">// Clone scanning loop to miss instead of hang when cache is corrupt.</span></div><div class="line">	<span class="comment">// The slow path may detect any corruption and halt later.</span></div><div class="line"></div><div class="line">	ldp	p17, p9, [x12]		<span class="comment">// &#123;imp, sel&#125; = *bucket</span></div><div class="line"><span class="number">1</span>:	cmp	p9, p1			<span class="comment">// if (bucket-&gt;sel != _cmd)</span></div><div class="line">	b.ne	<span class="number">2</span>f			<span class="comment">//     scan more</span></div><div class="line">	CacheHit $<span class="number">0</span>			<span class="comment">// call or return imp</span></div><div class="line">	</div><div class="line"><span class="number">2</span>:	<span class="comment">// not hit: p12 = not-hit bucket</span></div><div class="line">	CheckMiss $<span class="number">0</span>			<span class="comment">// miss if bucket-&gt;sel == 0</span></div><div class="line">	cmp	p12, p10		<span class="comment">// wrap if bucket == buckets</span></div><div class="line">	b.eq	<span class="number">3</span>f</div><div class="line">	ldp	p17, p9, [x12, <span class="meta">#-BUCKET_SIZE]!	<span class="comment">// &#123;imp, sel&#125; = *--bucket</span></span></div><div class="line">	b	<span class="number">1</span>b			<span class="comment">// loop</span></div><div class="line"></div><div class="line">LLookupEnd$<span class="number">1</span>:</div><div class="line">LLookupRecover$<span class="number">1</span>:</div><div class="line"><span class="number">3</span>:	<span class="comment">// double wrap</span></div><div class="line">	JumpMiss $<span class="number">0</span></div><div class="line"></div><div class="line">.endmacro</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 CheckMiss 的实现</span></div><div class="line">.macro CheckMiss</div><div class="line">	<span class="comment">// miss if bucket-&gt;sel == 0</span></div><div class="line">.<span class="keyword">if</span> $<span class="number">0</span> == GETIMP</div><div class="line">	cbz	p9, LGetImpMiss</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == NORMAL <span class="comment">//调用 CacheLookup 时传入的参数是 NORMAL</span></div><div class="line">	cbz	p9, __objc_msgSend_uncached <span class="comment">//调用 __objc_msgSend_uncached 方法（实现👇）</span></div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == LOOKUP</div><div class="line">	cbz	p9, __objc_msgLookup_uncached</div><div class="line">.<span class="keyword">else</span></div><div class="line">.abort oops</div><div class="line">.<span class="keyword">endif</span></div><div class="line">.endmacro</div><div class="line"></div><div class="line">.macro JumpMiss</div><div class="line">.<span class="keyword">if</span> $<span class="number">0</span> == GETIMP</div><div class="line">	b	LGetImpMiss</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == NORMAL</div><div class="line">	b	__objc_msgSend_uncached</div><div class="line">.<span class="keyword">elseif</span> $<span class="number">0</span> == LOOKUP</div><div class="line">	b	__objc_msgLookup_uncached</div><div class="line">.<span class="keyword">else</span></div><div class="line">.abort oops</div><div class="line">.<span class="keyword">endif</span></div><div class="line">.endmacro</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 __objc_msgSend_uncached 的实现</span></div><div class="line">STATIC_ENTRY __objc_msgSend_uncached</div><div class="line">UNWIND __objc_msgSend_uncached, FrameWithNoSaves</div><div class="line"></div><div class="line"><span class="comment">// THIS IS NOT A CALLABLE C FUNCTION</span></div><div class="line"><span class="comment">// Out-of-band p16 is the class to search</span></div><div class="line"></div><div class="line">MethodTableLookup <span class="comment">//查找方法列表（实现👇）</span></div><div class="line">TailCallFunctionPointer x17</div><div class="line"></div><div class="line">END_ENTRY __objc_msgSend_uncached</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 MethodTableLookup 的实现</span></div><div class="line">.macro MethodTableLookup</div><div class="line">	</div><div class="line">	<span class="comment">// push frame</span></div><div class="line">	SignLR</div><div class="line">	stp	fp, lr, [sp, <span class="meta">#-16]!</span></div><div class="line">	mov	fp, sp</div><div class="line"></div><div class="line">	<span class="comment">// save parameter registers: x0..x8, q0..q7</span></div><div class="line">	sub	sp, sp, <span class="meta">#(10*8 + 8*16)</span></div><div class="line">	stp	q0, q1, [sp, <span class="meta">#(0*16)]</span></div><div class="line">	stp	q2, q3, [sp, <span class="meta">#(2*16)]</span></div><div class="line">	stp	q4, q5, [sp, <span class="meta">#(4*16)]</span></div><div class="line">	stp	q6, q7, [sp, <span class="meta">#(6*16)]</span></div><div class="line">	stp	x0, x1, [sp, <span class="meta">#(8*16+0*8)]</span></div><div class="line">	stp	x2, x3, [sp, <span class="meta">#(8*16+2*8)]</span></div><div class="line">	stp	x4, x5, [sp, <span class="meta">#(8*16+4*8)]</span></div><div class="line">	stp	x6, x7, [sp, <span class="meta">#(8*16+6*8)]</span></div><div class="line">	str	x8,     [sp, <span class="meta">#(8*16+8*8)]</span></div><div class="line"></div><div class="line">        <span class="comment">// 这条注释可以看到在调用 lookUpImpOrForward 函数时的参数    </span></div><div class="line">	<span class="comment">// lookUpImpOrForward(obj, sel, cls, LOOKUP_INITIALIZE | LOOKUP_RESOLVER)</span></div><div class="line">	<span class="comment">// receiver and selector already in x0 and x1</span></div><div class="line">	mov	x2, x16</div><div class="line">	mov	x3, <span class="meta">#3</span></div><div class="line">	bl	_lookUpImpOrForward <span class="comment">//_lookUpImpOrForward 方法返回的是函数地址 imp，bl imp：跳转\调用imp。（实现👇）</span></div><div class="line"></div><div class="line">	<span class="comment">// IMP in x0</span></div><div class="line">	mov	x17, x0</div><div class="line">	</div><div class="line">	<span class="comment">// restore registers and return</span></div><div class="line">	ldp	q0, q1, [sp, <span class="meta">#(0*16)]</span></div><div class="line">	ldp	q2, q3, [sp, <span class="meta">#(2*16)]</span></div><div class="line">	ldp	q4, q5, [sp, <span class="meta">#(4*16)]</span></div><div class="line">	ldp	q6, q7, [sp, <span class="meta">#(6*16)]</span></div><div class="line">	ldp	x0, x1, [sp, <span class="meta">#(8*16+0*8)]</span></div><div class="line">	ldp	x2, x3, [sp, <span class="meta">#(8*16+2*8)]</span></div><div class="line">	ldp	x4, x5, [sp, <span class="meta">#(8*16+4*8)]</span></div><div class="line">	ldp	x6, x7, [sp, <span class="meta">#(8*16+6*8)]</span></div><div class="line">	ldr	x8,     [sp, <span class="meta">#(8*16+8*8)]</span></div><div class="line"></div><div class="line">	mov	sp, fp</div><div class="line">	ldp	fp, lr, [sp], <span class="meta">#16</span></div><div class="line">	AuthenticateLR</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure></p>
<h3 id="lookUpImpOrForward"><a href="#lookUpImpOrForward" class="headerlink" title="_lookUpImpOrForward"></a>_lookUpImpOrForward</h3><p>👉 _lookUpImpOrForward 的实现在 objc-runtime-new.mm 文件。老版本的 runtime 源码在这里调用的是 <code>__class_lookupMethodAndLoadCache3</code>，<code>_class_lookupMethodAndLoadCache3</code> 函数里调用的才是 lookUpImpOrForward：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">IMP _class_lookupMethodAndLoadCache3(<span class="keyword">id</span> obj, SEL sel, Class cls) &#123;</div><div class="line">    <span class="keyword">return</span> lookUpImpOrForward(cls, sel, obj, <span class="literal">YES</span><span class="comment">/*initalize*/</span>, <span class="literal">NO</span><span class="comment">/*cache*/</span>, <span class="literal">YES</span><span class="comment">/*reslover*/</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>_lookUpImpOrForward 是一个通过 c 语言实现的函数（对于函数名，汇编语言转 c 语言需要去掉一个“<code>_</code>”）。<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">IMP lookUpImpOrForward(id inst, SEL sel, Class <span class="keyword">cls</span>, int behavior)</div><div class="line">&#123;</div><div class="line">    const IMP forward_imp = (IMP)_objc_msgForward_impcache; <span class="comment">//默认消息转发（实现👇）</span></div><div class="line">    IMP imp = nil;</div><div class="line">    Class curClass;</div><div class="line"></div><div class="line">    runtimeLock.assertUnlocked();</div><div class="line"></div><div class="line">    <span class="comment">// Optimistic cache lookup</span></div><div class="line">    <span class="keyword">if</span> (fastpath(behavior &amp; LOOKUP_CACHE)) &#123; <span class="comment">//传入的 behavior 是 LOOKUP_INITIALIZE | LOOKUP_RESOLVER，条件不成立</span></div><div class="line">        imp = cache_getImp(<span class="keyword">cls</span>, sel); <span class="comment">//在缓存里查找</span></div><div class="line">        <span class="keyword">if</span> (imp) <span class="keyword">goto</span> done_nolock; <span class="comment">//跳转到 done_nolock 方法</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// runtimeLock is held during isRealized and isInitialized checking</span></div><div class="line">    <span class="comment">// to prevent races against concurrent realization.</span></div><div class="line"></div><div class="line">    <span class="comment">// runtimeLock is held during method search to make</span></div><div class="line">    <span class="comment">// method-lookup + cache-fill atomic with respect to method addition.</span></div><div class="line">    <span class="comment">// Otherwise, a category could be added but ignored indefinitely because</span></div><div class="line">    <span class="comment">// the cache was re-filled with the old value after the cache flush on</span></div><div class="line">    <span class="comment">// behalf of the category.</span></div><div class="line"></div><div class="line">    runtimeLock.lock();</div><div class="line"></div><div class="line">    <span class="comment">// We don't want people to be able to craft a binary blob that looks like</span></div><div class="line">    <span class="comment">// a class but really isn't one and do a CFI attack.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// To make these harder we want to make sure this is a class that was</span></div><div class="line">    <span class="comment">// either built into the binary or legitimately registered through</span></div><div class="line">    <span class="comment">// objc_duplicateClass, objc_initializeClassPair or objc_allocateClassPair.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> this check is quite costly during process startup.</span></div><div class="line">    checkIsKnownClass(<span class="keyword">cls</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath(!<span class="keyword">cls</span>-&gt;isRealized())) &#123;</div><div class="line">        <span class="keyword">cls</span> = realizeClassMaybeSwiftAndLeaveLocked(<span class="keyword">cls</span>, runtimeLock);</div><div class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (slowpath((behavior &amp; LOOKUP_INITIALIZE) &amp;&amp; !<span class="keyword">cls</span>-&gt;isInitialized())) &#123;</div><div class="line">        <span class="keyword">cls</span> = initializeAndLeaveLocked(<span class="keyword">cls</span>, inst, runtimeLock);</div><div class="line">        <span class="comment">// runtimeLock may have been dropped but is now locked again</span></div><div class="line"></div><div class="line">        <span class="comment">// If sel == initialize, class_initialize will send +initialize and </span></div><div class="line">        <span class="comment">// then the messenger will send +initialize again after this </span></div><div class="line">        <span class="comment">// procedure finishes. Of course, if this is not being called </span></div><div class="line">        <span class="comment">// from the messenger then it won't happen. 2778172</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    runtimeLock.assertLocked();</div><div class="line">    curClass = <span class="keyword">cls</span>;</div><div class="line"></div><div class="line">    <span class="comment">// The code used to lookpu the class's cache again right after</span></div><div class="line">    <span class="comment">// we take the lock but for the vast majority of the cases</span></div><div class="line">    <span class="comment">// evidence shows this is a miss most of the time, hence a time loss.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// The only codepath calling into this without having performed some</span></div><div class="line">    <span class="comment">// kind of cache lookup is class_getInstanceMethod().</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (unsigned attempts = unreasonableClassCount();;) &#123;</div><div class="line">        <span class="comment">// curClass method list.（curClass 的方法列表）</span></div><div class="line">        <span class="comment">// for 循环第一次时，curClass 代表当前类</span></div><div class="line">        <span class="comment">// for 循环非第一次时，curClass 代表父类</span></div><div class="line">        Method meth = getMethodNoSuper_nolock(curClass, sel); <span class="comment">//到 curClass 的方法列表里面找（实现👇）</span></div><div class="line">        <span class="keyword">if</span> (meth) &#123; <span class="comment">//如果找到了</span></div><div class="line">            imp = meth-&gt;imp; <span class="comment">//取出方法的函数地址</span></div><div class="line">            <span class="keyword">goto</span> done; <span class="comment">//跳转到 done 方法</span></div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 执行 curClass = curClass-&gt;superclass，找到更上层父类，并判断新赋值的 curClass 是否为 nil（通过 for 循环重复执行，遍历父类）</span></div><div class="line">        <span class="keyword">if</span> (slowpath((curClass = curClass-&gt;superclass) == nil)) &#123; </div><div class="line">            <span class="comment">// No implementation found, and method resolver didn't help.</span></div><div class="line">            <span class="comment">// Use forwarding.</span></div><div class="line">            imp = forward_imp; <span class="comment">//如果新赋值的 curClass 为 nil，说明没有更上层父类了，则设置 imp = forward_imp（消息转发）</span></div><div class="line">            <span class="keyword">break</span>; <span class="comment">//跳出 for 循环</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Halt if there is a cycle in the superclass chain.</span></div><div class="line">        <span class="keyword">if</span> (slowpath(--attempts == <span class="number">0</span>)) &#123; <span class="comment">//判断 attempts - 1 后是否等于 0</span></div><div class="line">            _objc_fatal(<span class="string">"Memory corruption in class list."</span>); <span class="comment">//如果等于 0 报错</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Superclass cache.</span></div><div class="line">        imp = cache_getImp(curClass, sel); <span class="comment">//到父类的缓存里查找（此时 curClass 代表父类）</span></div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (slowpath(imp == forward_imp)) &#123;</div><div class="line">            <span class="comment">// Found a forward:: entry in a superclass.</span></div><div class="line">            <span class="comment">// Stop searching, but don't cache yet; call method</span></div><div class="line">            <span class="comment">// resolver for this class first.</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (fastpath(imp)) &#123;</div><div class="line">            <span class="comment">// Found the method in a superclass. Cache it in this class.</span></div><div class="line">            <span class="keyword">goto</span> done; <span class="comment">//如果在父类的缓存里找到了，跳转到 done 方法</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//---------------------------- 消息发送 end ----------------------------</span></div><div class="line"></div><div class="line">    <span class="comment">//---------------------------- 动态方法解析 start ----------------------------</span></div><div class="line">    <span class="comment">// No implementation found. Try method resolver once.</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (slowpath(behavior &amp; LOOKUP_RESOLVER)) &#123; <span class="comment">//behavior 里是否包含 LOOKUP_RESOLVER，判断是否有过动态方法解析了（传入的 behavior 是 LOOKUP_INITIALIZE | LOOKUP_RESOLVER）</span></div><div class="line">        behavior ^= LOOKUP_RESOLVER; <span class="comment">//再加一个 LOOKUP_RESOLVER（动态方法解析执行完成后，会再走一遍 lookUpImpOrForward，保证只操作一次动态方法解析）</span></div><div class="line">        <span class="keyword">return</span> resolveMethod_locked(inst, sel, <span class="keyword">cls</span>, behavior); <span class="comment">//实现👇</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//---------------------------- 动态方法解析 end ----------------------------</span></div><div class="line"></div><div class="line"> done:</div><div class="line">    log_and_fill_cache(<span class="keyword">cls</span>, imp, sel, inst, curClass); <span class="comment">//将从 curClass 类里找到的函数地址 imp 填充到 cls（objc_msgSend的接收者）的缓存里（实现👇）</span></div><div class="line">    runtimeLock.unlock();</div><div class="line"> done_nolock:</div><div class="line">    <span class="keyword">if</span> (slowpath((behavior &amp; LOOKUP_NIL) &amp;&amp; imp == forward_imp)) &#123;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> imp; <span class="comment">//返回函数地址</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>消息发送相关方法实现<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//👉 getMethodNoSuper_nolock 的实现</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">getMethodNoSuper_nolock(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    ASSERT(cls-&gt;isRealized());</div><div class="line">    <span class="comment">// fixme nil cls? </span></div><div class="line">    <span class="comment">// fixme nil sel?</span></div><div class="line"></div><div class="line">    <span class="keyword">auto</span> <span class="keyword">const</span> methods = cls-&gt;data()-&gt;methods(); <span class="comment">//cls-&gt;data() 返回到是 class_rw_t，即 class_rw_t-&gt;methods()</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> mlists = methods.beginLists(),</div><div class="line">              end = methods.endLists();</div><div class="line">         mlists != end;</div><div class="line">         ++mlists)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// &lt;rdar://problem/46904873&gt; getMethodNoSuper_nolock is the hottest</span></div><div class="line">        <span class="comment">// caller of search_method_list, inlining it turns</span></div><div class="line">        <span class="comment">// getMethodNoSuper_nolock into a frame-less function and eliminates</span></div><div class="line">        <span class="comment">// any store from this codepath.</span></div><div class="line">        <span class="keyword">method_t</span> *m = search_method_list_inline(*mlists, sel); <span class="comment">//到方法列表里查找（实现👇）</span></div><div class="line">        <span class="keyword">if</span> (m) <span class="keyword">return</span> m;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 search_method_list_inline 的实现</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">search_method_list_inline(<span class="keyword">const</span> <span class="keyword">method_list_t</span> *mlist, SEL sel)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> methodListIsFixedUp = mlist-&gt;isFixedUp();</div><div class="line">    <span class="keyword">int</span> methodListHasExpectedSize = mlist-&gt;entsize() == <span class="keyword">sizeof</span>(<span class="keyword">method_t</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (fastpath(methodListIsFixedUp &amp;&amp; methodListHasExpectedSize)) &#123; <span class="comment">//是否是排好序的方法列表</span></div><div class="line">        <span class="keyword">return</span> findMethodInSortedMethodList(sel, mlist); <span class="comment">//在已经排好序的方法列表里面查找（二分查找）（实现👇）</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 在没有排好序的方法列表里遍历查找</span></div><div class="line">        <span class="comment">// Linear search of unsorted method list</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; meth : *mlist) &#123; </div><div class="line">            <span class="keyword">if</span> (meth.name == sel) <span class="keyword">return</span> &amp;meth;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> DEBUG</span></div><div class="line">    <span class="comment">// sanity-check negative results</span></div><div class="line">    <span class="keyword">if</span> (mlist-&gt;isFixedUp()) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; meth : *mlist) &#123;</div><div class="line">            <span class="keyword">if</span> (meth.name == sel) &#123;</div><div class="line">                _objc_fatal(<span class="string">"linear search worked when binary search did not"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 findMethodInSortedMethodList 的实现</span></div><div class="line">ALWAYS_INLINE <span class="keyword">static</span> <span class="keyword">method_t</span> *</div><div class="line">findMethodInSortedMethodList(SEL key, <span class="keyword">const</span> <span class="keyword">method_list_t</span> *<span class="built_in">list</span>)</div><div class="line">&#123;</div><div class="line">    ASSERT(<span class="built_in">list</span>);</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> * <span class="keyword">const</span> first = &amp;<span class="built_in">list</span>-&gt;first;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> *base = first;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">method_t</span> *probe;</div><div class="line">    <span class="keyword">uintptr_t</span> keyValue = (<span class="keyword">uintptr_t</span>)key;</div><div class="line">    <span class="keyword">uint32_t</span> count;</div><div class="line">    <span class="comment">//二分查找</span></div><div class="line">    <span class="keyword">for</span> (count = <span class="built_in">list</span>-&gt;count; count != <span class="number">0</span>; count &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">        probe = base + (count &gt;&gt; <span class="number">1</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">uintptr_t</span> probeValue = (<span class="keyword">uintptr_t</span>)probe-&gt;name;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (keyValue == probeValue) &#123;</div><div class="line">            <span class="comment">// `probe` is a match.</span></div><div class="line">            <span class="comment">// Rewind looking for the *first* occurrence of this value.</span></div><div class="line">            <span class="comment">// This is required for correct category overrides.</span></div><div class="line">            <span class="keyword">while</span> (probe &gt; first &amp;&amp; keyValue == (<span class="keyword">uintptr_t</span>)probe[<span class="number">-1</span>].name) &#123;</div><div class="line">                probe--;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">method_t</span> *)probe;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (keyValue &gt; probeValue) &#123;</div><div class="line">            base = probe + <span class="number">1</span>;</div><div class="line">            count--;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 log_and_fill_cache 的实现</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span></div><div class="line">log_and_fill_cache(Class cls, IMP imp, SEL sel, id receiver, Class implementer)</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_MESSAGE_LOGGING</span></div><div class="line">    <span class="keyword">if</span> (slowpath(objcMsgLogEnabled &amp;&amp; implementer)) &#123;</div><div class="line">        <span class="keyword">bool</span> cacheIt = logMessageSend(implementer-&gt;isMetaClass(), </div><div class="line">                                      cls-&gt;nameForLogging(),</div><div class="line">                                      implementer-&gt;nameForLogging(), </div><div class="line">                                      sel);</div><div class="line">        <span class="keyword">if</span> (!cacheIt) <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    cache_fill(cls, sel, imp, receiver); <span class="comment">//填充到缓存</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//cache_fill 的实现在 objc-cache.mm 文件</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_fill</span><span class="params">(Class cls, SEL sel, IMP imp, id receiver)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !DEBUG_TASK_THREADS</span></div><div class="line">    <span class="comment">// Never cache before +initialize is done</span></div><div class="line">    <span class="keyword">if</span> (cls-&gt;isInitialized()) &#123;</div><div class="line">        <span class="keyword">cache_t</span> *cache = getCache(cls);</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(cacheUpdateLock);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">        cache-&gt;insert(cls, sel, imp, receiver); <span class="comment">//填充到缓存的具体实现（实现👇）</span></div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    _collecting_in_critical();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line">...... <span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="comment">//👉 cache_t::insert 的实现</span></div><div class="line">ALWAYS_INLINE</div><div class="line"><span class="keyword">void</span> <span class="keyword">cache_t</span>::insert(Class cls, SEL sel, IMP imp, id receiver)</div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    ASSERT(sel != <span class="number">0</span> &amp;&amp; cls-&gt;isInitialized());</div><div class="line"></div><div class="line">    <span class="comment">// Use the cache as-is if it is less than 3/4 full</span></div><div class="line">    <span class="keyword">mask_t</span> newOccupied = occupied() + <span class="number">1</span>;</div><div class="line">    <span class="keyword">unsigned</span> oldCapacity = capacity(), capacity = oldCapacity;</div><div class="line">    <span class="keyword">if</span> (slowpath(isConstantEmptyCache())) &#123;</div><div class="line">        <span class="comment">// Cache is read-only. Replace it.</span></div><div class="line">        <span class="keyword">if</span> (!capacity) capacity = INIT_CACHE_SIZE;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="comment">/* freeOld */</span><span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (fastpath(newOccupied + CACHE_END_MARKER &lt;= capacity / <span class="number">4</span> * <span class="number">3</span>)) &#123; <span class="comment">//判断添加后的剩余空间</span></div><div class="line">        <span class="comment">// Cache is less than 3/4 full. Use it as-is.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123; <span class="comment">//扩容x2</span></div><div class="line">        capacity = capacity ? capacity * <span class="number">2</span> : INIT_CACHE_SIZE;</div><div class="line">        <span class="keyword">if</span> (capacity &gt; MAX_CACHE_SIZE) &#123;</div><div class="line">            capacity = MAX_CACHE_SIZE;</div><div class="line">        &#125;</div><div class="line">        reallocate(oldCapacity, capacity, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">bucket_t</span> *b = buckets();</div><div class="line">    <span class="keyword">mask_t</span> m = capacity - <span class="number">1</span>;</div><div class="line">    <span class="keyword">mask_t</span> begin = cache_hash(sel, m); <span class="comment">//计算索引</span></div><div class="line">    <span class="keyword">mask_t</span> i = begin;</div><div class="line"></div><div class="line">    <span class="comment">// Scan for the first unused slot and insert there.</span></div><div class="line">    <span class="comment">// There is guaranteed to be an empty slot because the</span></div><div class="line">    <span class="comment">// minimum size is 4 and we resized at 3/4 full.</span></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">if</span> (fastpath(b[i].sel() == <span class="number">0</span>)) &#123; <span class="comment">//索引处没有方法</span></div><div class="line">            incrementOccupied();</div><div class="line">            b[i].<span class="built_in">set</span>&lt;Atomic, Encoded&gt;(sel, imp, cls); <span class="comment">//添加到缓存中对应的索引处</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (b[i].sel() == sel) &#123;  <span class="comment">//索引处有方法并且是同一个方法，表示已经存储过了，返回</span></div><div class="line">            <span class="comment">// The entry was added to the cache by some other thread</span></div><div class="line">            <span class="comment">// before we grabbed the cacheUpdateLock.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">while</span> (fastpath((i = cache_next(i, m)) != begin)); <span class="comment">//重新计算索引（当前索引减 1），判断是否查了一圈了</span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t</span>::bad_cache(receiver, (SEL)sel, cls);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="resolveMethod-locked"><a href="#resolveMethod-locked" class="headerlink" title="resolveMethod_locked()"></a>resolveMethod_locked()</h3><p>动态方法解析相关方法实现<br><figure class="highlight hsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//👉 resolveMethod_locked 的实现</span></div><div class="line">static NEVER_INLINE IMP</div><div class="line">resolveMethod_locked(id inst, SEL sel, Class <span class="keyword">cls</span>, <span class="keyword">int</span> behavior)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertLocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line"></div><div class="line">    runtimeLock.unlock()<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">cls</span>-&gt;isMetaClass()) &#123; </div><div class="line">        <span class="comment">// 不是元类对象</span></div><div class="line">        <span class="comment">// try [cls resolveInstanceMethod:sel]</span></div><div class="line">        resolveInstanceMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //实现👇</span></div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 是元类对象</span></div><div class="line">        <span class="comment">// try [nonMetaClass resolveClassMethod:sel]</span></div><div class="line">        <span class="comment">// and [cls resolveInstanceMethod:sel]</span></div><div class="line">        resolveClassMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //实现👇</span></div><div class="line">        <span class="keyword">if</span> (!lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)) &#123;</div><div class="line">            resolveInstanceMethod(inst, sel, <span class="keyword">cls</span>)<span class="comment">; //实现👇</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// chances are that calling the resolver have populated the cache</span></div><div class="line">    <span class="comment">// so attempt using it</span></div><div class="line">    <span class="keyword">return</span> lookUpImpOrForward(inst, sel, <span class="keyword">cls</span>, behavior | LOOKUP_CACHE)<span class="comment">; //动态方法解析相关方法调用完成后，会再走一遍 lookUpImpOrForward 方法，即消息发送的第二步（实现👆）</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//👉 resolveInstanceMethod 的实现</span></div><div class="line">static void resolveInstanceMethod(id inst, SEL sel, Class <span class="keyword">cls</span>)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertUnlocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line">    SEL resolve_sel = @selector(resolveInstanceMethod:)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!lookUpImpOrNil(<span class="keyword">cls</span>, resolve_sel, <span class="keyword">cls</span>-&gt;ISA())) &#123;</div><div class="line">        <span class="comment">// Resolver not implemented.</span></div><div class="line">        <span class="keyword">return</span><span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend<span class="comment">;</span></div><div class="line">    bool resolved = msg(<span class="keyword">cls</span>, resolve_sel, sel)<span class="comment">; //让 cls 调用 resolve_sel 方法</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache the result (good or bad) so the resolver doesn't fire next time.</span></div><div class="line">    <span class="comment">// +resolveInstanceMethod adds to self a.k.a. cls</span></div><div class="line">    IMP imp = lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (resolved  &amp;&amp;  PrintResolving) &#123;</div><div class="line">        <span class="keyword">if</span> (imp) &#123;</div><div class="line">            _objc_inform(<span class="string">"RESOLVE: method %c[%s %s] "</span></div><div class="line">                         <span class="string">"dynamically resolved to %p"</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), imp)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Method resolver didn't add anything?</span></div><div class="line">            _objc_inform(<span class="string">"RESOLVE: +[%s resolveInstanceMethod:%s] returned YES"</span></div><div class="line">                         <span class="string">", but no new implementation of %c[%s %s] was found"</span>,</div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel))<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//👉 resolveClassMethod 的实现</span></div><div class="line">static void resolveClassMethod(id inst, SEL sel, Class <span class="keyword">cls</span>)</div><div class="line">&#123;</div><div class="line">    runtimeLock.assertUnlocked()<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isRealized())<span class="comment">;</span></div><div class="line">    <span class="keyword">ASSERT</span>(<span class="keyword">cls</span>-&gt;isMetaClass())<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!lookUpImpOrNil(inst, @selector(resolveClassMethod:), <span class="keyword">cls</span>)) &#123;</div><div class="line">        <span class="comment">// Resolver not implemented.</span></div><div class="line">        <span class="keyword">return</span><span class="comment">;</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Class nonmeta<span class="comment">;</span></div><div class="line">    &#123;</div><div class="line">        mutex_locker_t lock(runtimeLock)<span class="comment">;</span></div><div class="line">        nonmeta = getMaybeUnrealizedNonMetaClass(<span class="keyword">cls</span>, inst)<span class="comment">;</span></div><div class="line">        <span class="comment">// +initialize path should have realized nonmeta already</span></div><div class="line">        <span class="keyword">if</span> (!nonmeta-&gt;isRealized()) &#123;</div><div class="line">            _objc_fatal(<span class="string">"nonmeta class %s (%p) unexpectedly not realized"</span>,</div><div class="line">                        nonmeta-&gt;nameForLogging(), nonmeta)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend<span class="comment">;</span></div><div class="line">    bool resolved = msg(nonmeta, @selector(resolveClassMethod:), sel)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="comment">// Cache the result (good or bad) so the resolver doesn't fire next time.</span></div><div class="line">    <span class="comment">// +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls</span></div><div class="line">    IMP imp = lookUpImpOrNil(inst, sel, <span class="keyword">cls</span>)<span class="comment">;</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (resolved  &amp;&amp;  PrintResolving) &#123;</div><div class="line">        <span class="keyword">if</span> (imp) &#123;</div><div class="line">            _objc_inform(<span class="string">"RESOLVE: method %c[%s %s] "</span></div><div class="line">                         <span class="string">"dynamically resolved to %p"</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), imp)<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Method resolver didn't add anything?</span></div><div class="line">            _objc_inform(<span class="string">"RESOLVE: +[%s resolveClassMethod:%s] returned YES"</span></div><div class="line">                         <span class="string">", but no new implementation of %c[%s %s] was found"</span>,</div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel), </div><div class="line">                         <span class="keyword">cls</span>-&gt;isMetaClass() ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                         <span class="keyword">cls</span>-&gt;nameForLogging(), sel_getName(sel))<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="objc-msgForward-impcache"><a href="#objc-msgForward-impcache" class="headerlink" title="__objc_msgForward_impcache"></a>__objc_msgForward_impcache</h3><p>消息转发相关方法的实现<br>👉 __objc_msgForward_impcache 方法的实现在汇编文件 objc-msg-arm64.s<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">STATIC_ENTRY <span class="variable">__objc_msgForward_impcache</span></div><div class="line"></div><div class="line"><span class="comment">// No stret specialization.</span></div><div class="line">b	<span class="variable">__objc_msgForward</span></div><div class="line"></div><div class="line">END_ENTRY <span class="variable">__objc_msgForward_impcache</span></div><div class="line"></div><div class="line"></div><div class="line">ENTRY <span class="variable">__objc_msgForward</span></div><div class="line"></div><div class="line">adrp	x17, <span class="variable">__objc_forward_handler</span>@PAGE</div><div class="line">ldr	p17, [x17, <span class="variable">__objc_forward_handler</span>@PAGEOFF] <span class="comment">//实现👇</span></div><div class="line">TailCallFunctionPointer x17</div><div class="line"></div><div class="line">END_ENTRY <span class="variable">__objc_msgForward</span></div></pre></td></tr></table></figure></p>
<p>👉 _objc_forward_handler 的实现在 C 语言文件 objc-runtime.mm。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#if !__OBJC2__</span></div><div class="line"></div><div class="line"><span class="comment">// Default forward handler (nil) goes to forward:: dispatch.</span></div><div class="line"><span class="keyword">void</span> *_objc_forward_handler = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">void</span> *_objc_forward_stret_handler = <span class="literal">nil</span>;</div><div class="line"></div><div class="line"><span class="meta">#else</span></div><div class="line"></div><div class="line"><span class="comment">// Default forward handler halts the process.</span></div><div class="line">__attribute__((noreturn, cold)) <span class="keyword">void</span></div><div class="line">objc_defaultForwardHandler(<span class="keyword">id</span> <span class="keyword">self</span>, SEL sel)</div><div class="line">&#123;</div><div class="line">    _objc_fatal(<span class="string">"%c[%s %s]: unrecognized selector sent to instance %p "</span></div><div class="line">                <span class="string">"(no message forward handler is installed)"</span>, </div><div class="line">                class_isMetaClass(object_getClass(<span class="keyword">self</span>)) ? <span class="string">'+'</span> : <span class="string">'-'</span>, </div><div class="line">                object_getClassName(<span class="keyword">self</span>), sel_getName(sel), <span class="keyword">self</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> *_objc_forward_handler = (<span class="keyword">void</span>*)objc_defaultForwardHandler;</div></pre></td></tr></table></figure></p>
<p>这里的 _objc_forward_handler 指针存储的是 objc_defaultForwardHandler 的函数地址。因为 _objc_forward_handler 没有开源，所以看不到其具体的内部实现，即无法知道该方法在消息转发阶段具体做了什么。在报错信息里可以看到消息转发最后调用了 <code>__forwarding__</code> 方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>报错信息：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime26.png" alt="Runtime26"></p>
<p>通过反编译可以看到 _objc_forward_handler 的具体实现，这里有一份根据汇编代码翻译成的 C 语言伪代码 <code>__forwarding__.c</code>：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 伪代码</span></div><div class="line"><span class="keyword">int</span> __forwarding__(<span class="keyword">void</span> *frameStackPointer, <span class="keyword">int</span> isStret) &#123;</div><div class="line">    <span class="keyword">id</span> receiver = *(<span class="keyword">id</span> *)frameStackPointer;</div><div class="line">    SEL sel = *(SEL *)(frameStackPointer + <span class="number">8</span>);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(sel);</div><div class="line">    Class receiverClass = object_getClass(receiver);</div><div class="line"></div><div class="line">    <span class="comment">// 调用 forwardingTargetForSelector:</span></div><div class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardingTargetForSelector:))) &#123;</div><div class="line">        <span class="keyword">id</span> forwardingTarget = [receiver forwardingTargetForSelector:sel]; <span class="comment">//实例对象 - 对象方法，类对象 - 类方法</span></div><div class="line">        <span class="keyword">if</span> (forwardingTarget &amp;&amp; forwardingTarget != receiver) &#123;</div><div class="line">            <span class="keyword">if</span> (isStret == <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">int</span> ret;</div><div class="line">                objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</div><div class="line">                <span class="keyword">return</span> ret;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> objc_msgSend(forwardingTarget, sel, ...); <span class="comment">//返回值 forwardingTarget 调用方法</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 僵尸对象</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *className = class_getName(receiverClass);</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *zombiePrefix = <span class="string">"_NSZombie_"</span>;</div><div class="line">    size_t prefixLen = strlen(zombiePrefix); <span class="comment">// 0xa</span></div><div class="line">    <span class="keyword">if</span> (strncmp(className, zombiePrefix, prefixLen) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelError,</div><div class="line">              <span class="string">@"*** -[%s %s]: message sent to deallocated instance %p"</span>,</div><div class="line">              className + prefixLen,</div><div class="line">              selName,</div><div class="line">              receiver);</div><div class="line">        &lt;breakpoint-interrupt&gt;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用 methodSignatureForSelector 获取类型编码后再调用 forwardInvocation</span></div><div class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(methodSignatureForSelector:))) &#123;</div><div class="line">        <span class="built_in">NSMethodSignature</span> *methodSignature = [receiver methodSignatureForSelector:sel]; <span class="comment">//实例对象 - 对象方法，类对象 - 类方法</span></div><div class="line">        <span class="keyword">if</span> (methodSignature) &#123;</div><div class="line">            <span class="built_in">BOOL</span> signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</div><div class="line">            <span class="keyword">if</span> (signatureIsStret != isStret) &#123;</div><div class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">                      <span class="string">@"*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of '%s'.  Signature thinks it does%s return a struct, and compiler thinks it does%s."</span>,</div><div class="line">                      selName,</div><div class="line">                      signatureIsStret ? <span class="string">""</span> : not,</div><div class="line">                      isStret ? <span class="string">""</span> : not);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardInvocation:))) &#123;</div><div class="line">                <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</div><div class="line"></div><div class="line">                [receiver forwardInvocation:invocation];</div><div class="line"></div><div class="line">                <span class="keyword">void</span> *returnValue = <span class="literal">NULL</span>;</div><div class="line">                [invocation getReturnValue:&amp;value];</div><div class="line">                <span class="keyword">return</span> returnValue;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">                      <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement forwardInvocation: -- dropping message"</span>,</div><div class="line">                      receiver,</div><div class="line">                      className);</div><div class="line">                <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SEL *registeredSel = sel_getUid(selName);</div><div class="line"></div><div class="line">    <span class="comment">// selector 是否已经在 Runtime 注册过</span></div><div class="line">    <span class="keyword">if</span> (sel != registeredSel) &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">              <span class="string">@"*** NSForwarding: warning: selector (%p) for message '%s' does not match selector known to Objective C runtime (%p)-- abort"</span>,</div><div class="line">              sel,</div><div class="line">              selName,</div><div class="line">              registeredSel);</div><div class="line">    &#125; <span class="comment">// doesNotRecognizeSelector</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (class_respondsToSelector(receiverClass,<span class="keyword">@selector</span>(doesNotRecognizeSelector:))) &#123;</div><div class="line">        [receiver doesNotRecognizeSelector:sel];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</div><div class="line">              <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement doesNotRecognizeSelector: -- abort"</span>,</div><div class="line">              receiver,</div><div class="line">              className);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The point of no return.</span></div><div class="line">    kill(getpid(), <span class="number">9</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h2><p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime23.png" alt="Runtime23"></p>
<ul>
<li>receiver 通过 isa 指针找到 receiverClass，receiverClass 通过superclass 指针找到 superClass</li>
<li>如果是从class_rw_t中查找方法<br>已经排序的，二分查找<br>没有排序的，遍历查找</li>
</ul>
<p>流程解析：</p>
<ol>
<li>首先判断 receiver 是否为空，如果 receiver 为空直接退出，如果 receiver 不为空则到 receiverClass 的 cache 中查找方法；  </li>
<li>从 receiverClass 的 cache 中查找方法，找到了方法，则调用方法结束查找。没找到方法，则从 receiverClass 的 class_rw_t 中查找方法；</li>
<li>从 receiverClass 的 class_rw_t 中查找方法，找到了方法，则将方法缓存到 receiverClass 的 cache 中，并调用方法结束查找。没有找到方法，则从 superclass 的 cache 中查找方法；</li>
<li>从 superclass 的 cache 中查找方法，找到了方法，将方法缓存到 receiverClass 的 cache 中，并调用方法结束查找。没找到方法，则从 superclass 的 class_rw_t 中查找方法；</li>
<li>从 superclass 的 class_rw_t 中查找方法，找到了方法，则将方法缓存到 receiverClass 的 cache 中，并调用方法结束查找。没有找到方法，则判断上层是否还有 superclass；</li>
<li>判断上层是否还有 superclass，有，则回到第4步。没有，则开始动态方法解析；</li>
</ol>
<h2 id="动态方法解析"><a href="#动态方法解析" class="headerlink" title="动态方法解析"></a>动态方法解析</h2><p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime24.png" alt="Runtime24"></p>
<ul>
<li><p>开发者可以实现以下方法，来动态添加方法实现</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</div><div class="line">+ (<span class="selector-tag">BOOL</span>)<span class="selector-tag">resolveClassMethod</span><span class="selector-pseudo">:(SEL)sel</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>动态解析过后，会重新走“消息发送”的流程（“从 receiverClass的cache 中查找方法”这一步开始执行）</p>
</li>
</ul>
<h3 id="动态添加对象方法"><a href="#动态添加对象方法" class="headerlink" title="动态添加对象方法"></a>动态添加对象方法</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//获取其它方法</span></div><div class="line">        Method method = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="comment">//动态添加方法</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, method_getImplementation(method), method_getTypeEncoding(method));</div><div class="line">        <span class="comment">//返回YES代表有动态添加方法</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Person other]</span></div></pre></td></tr></table></figure></p>
<p>Method 是指向结构体 method_t 的指针，即 struct objc_method == struct method_t，所以 <code>class_getInstanceMethod(self, @selector(other))</code> 返回的是结构体 method_t。Method 的定义：<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_method *<span class="function"><span class="keyword">Method</span>;</span></div></pre></td></tr></table></figure></p>
<p>证明：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> method_t &#123;</div><div class="line">    SEL sel;</div><div class="line">    <span class="keyword">char</span> *types;</div><div class="line">    IMP imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//获取其它方法</span></div><div class="line">        <span class="keyword">struct</span> method_t *method = (<span class="keyword">struct</span> method_t *)class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s %p"</span>, method-&gt;sel, method-&gt;types, method-&gt;imp);</div><div class="line">        <span class="comment">//动态添加方法</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, method-&gt;imp, method-&gt;types);</div><div class="line">        <span class="comment">//返回YES代表有动态添加方法</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">other</span> <span class="selector-tag">v16</span>@<span class="selector-tag">0</span><span class="selector-pseudo">:8</span> <span class="selector-tag">0x100000b40</span></div><div class="line"><span class="selector-tag">-</span><span class="selector-attr">[Person other]</span></div></pre></td></tr></table></figure></p>
<h3 id="动态添加C语言函数"><a href="#动态添加C语言函数" class="headerlink" title="动态添加C语言函数"></a>动态添加C语言函数</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">void</span> c_other(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"c_other - %@ - %@"</span>, <span class="keyword">self</span>, <span class="built_in">NSStringFromSelector</span>(_cmd));</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//动态添加方法，C语言的函数地址==函数名，函数编码"v16@0:8"（也可以写成 v@:）</span></div><div class="line">        class_addMethod(<span class="keyword">self</span>, sel, (IMP)c_other, <span class="string">"v16@0:8"</span>);</div><div class="line">        <span class="comment">//返回YES代表有动态添加方法</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="动态添加类方法"><a href="#动态添加类方法" class="headerlink" title="动态添加类方法"></a>动态添加类方法</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">void</span>)other</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="built_in">BOOL</span>)resolveClassMethod:(SEL)sel</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="comment">//获取其它方法</span></div><div class="line">        Method method = class_getClassMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(other));</div><div class="line">        <span class="comment">//动态添加方法</span></div><div class="line">        class_addMethod(object_getClass(<span class="keyword">self</span>), sel, method_getImplementation(method), method_getTypeEncoding(method));</div><div class="line">        <span class="comment">//返回YES代表有动态添加方法</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveClassMethod:sel];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        [Person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Person other]</span></div></pre></td></tr></table></figure></p>
<h2 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h2><p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime25.png" alt="Runtime25"></p>
<ul>
<li>开发者可以在 forwardInvocation: 方法中自定义任何逻辑</li>
<li>以上方法都有对象方法、类方法2个版本（前面可以是加号+，也可以是减号-）</li>
</ul>
<h3 id="对象方法的消息转发"><a href="#对象方法的消息转发" class="headerlink" title="对象方法的消息转发"></a>对象方法的消息转发</h3><h4 id="forwardingTargetForSelector-方法"><a href="#forwardingTargetForSelector-方法" class="headerlink" title="-forwardingTargetForSelector: 方法"></a>-forwardingTargetForSelector: 方法</h4><p><code>-forwardingTargetForSelector:</code> 方法有返回值时，返回值调用方法：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> [[Student alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<h4 id="methodSignatureForSelector-方法"><a href="#methodSignatureForSelector-方法" class="headerlink" title="-methodSignatureForSelector: 方法"></a>-methodSignatureForSelector: 方法</h4><p><code>-forwardingTargetForSelector:</code> 方法没有返回值时，会调用 <code>-methodSignatureForSelector:</code> 方法获取类型编码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//类型编码：返回值类型、参数类型</span></div><div class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">"v16@0:8"</span>]; <span class="comment">//也可以写成 v@:</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation &#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     anInvocation.target = [[Student alloc] init];</span></div><div class="line"><span class="comment">     [anInvocation invoke]; //调用</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    [anInvocation invokeWithTarget:[[Student alloc] init]]; <span class="comment">//传入 Target 调用</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person test];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>如果 <code>-methodSignatureForSelector:</code> 方法没有返回类型编码，则会报错：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime27.png" alt="Runtime27"></p>
<p>从调用栈可以看到停留在了 <code>doesNotRecognizeSelector:</code> 方法：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime28.png" alt="Runtime28"></p>
<p>类型编码的另一种返回方式：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (NSMethodSignature *)<span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(<span class="attribute">test</span>:)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[[[Student alloc]</span> <span class="selector-tag">init</span>] <span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:aSelector</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super methodSignatureForSelector:aSelector]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为 Student 实现了 <code>-(void)test:(int)age</code> 方法，所以调用 Student 的 <code>methodSignatureForSelector:</code> 方法可以返回 <code>-(void)test:(int)age</code> 方法的类型编码。</p>
<h3 id="类方法的消息转发"><a href="#类方法的消息转发" class="headerlink" title="类方法的消息转发"></a>类方法的消息转发</h3><h4 id="forwardingTargetForSelector-方法-1"><a href="#forwardingTargetForSelector-方法-1" class="headerlink" title="+forwardingTargetForSelector: 方法"></a>+forwardingTargetForSelector: 方法</h4><p>在 <code>+forwardingTargetForSelector:</code> 方法里返回类对象：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">+ (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">+ (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123; <span class="comment">//类方法和对象方法的方法名都是 "test"</span></div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[Student class]</span>;         <span class="comment">//objc_msgSend([Student class], @selector("test"))</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">main</span>(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>在 <code>+forwardingTargetForSelector:</code> 方法里返回实列对象：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">- (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">- (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123; <span class="comment">//类方法和对象方法的方法名都是 "test"</span></div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[[Student alloc]</span> <span class="selector-tag">init</span>];  <span class="comment">//objc_msgSend([[Student alloc] init], @selector("test"))</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">main</span>(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<h4 id="methodSignatureForSelector-方法-1"><a href="#methodSignatureForSelector-方法-1" class="headerlink" title="+methodSignatureForSelector: 方法"></a>+methodSignatureForSelector: 方法</h4><p><code>+forwardingTargetForSelector:</code> 方法没有返回值时，会调用 <code>+methodSignatureForSelector:</code> 方法获取类型编码：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line">+ (void)test;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line">+ (void)test</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Person</span> : <span class="selector-tag">NSObject</span></div><div class="line">+ (void)<span class="selector-tag">test</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Person</span></div><div class="line">+ (id)<span class="selector-tag">forwardingTargetForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-tag">nil</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super forwardingTargetForSelector:aSelector]</span>;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSMethodSignature *)<span class="selector-tag">methodSignatureForSelector</span><span class="selector-pseudo">:(SEL)aSelector</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (aSelector == <span class="variable">@selector</span>(test)) &#123;</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-attr">[NSMethodSignature signatureWithObjCTypes:"v16@0:8"]</span>; <span class="comment">//也可以写成 v@:</span></div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super methodSignatureForSelector:aSelector]</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (void)<span class="selector-tag">forwardInvocation</span><span class="selector-pseudo">:(NSInvocation</span> *)<span class="selector-tag">anInvocation</span> &#123;</div><div class="line">    <span class="selector-attr">[anInvocation invokeWithTarget:[Student class]</span>];</div><div class="line">&#125;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    <span class="variable">@autoreleasepool</span> &#123;</div><div class="line">        <span class="selector-attr">[Person test]</span>;</div><div class="line">    &#125;</div><div class="line">    return <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+<span class="string">[Student test]</span></div></pre></td></tr></table></figure></p>
<p>[Person test] 的本质是 objc_msgSend([Person class], @selector(test))，会先走一遍“消息发送”流程。因为 Person 没有实现 <code>-(void)test</code> 方法，所以</p>
<h4 id="NSInvocation"><a href="#NSInvocation" class="headerlink" title="NSInvocation"></a>NSInvocation</h4><p>NSInvocation 封装了一个方法调用，包括：方法调用者、方法名、方法参数和返回值（类型编码决定 NSInvocation 的方法参数和返回值）。<br>anInvocation.target 方法调用者<br>anInvocation.selector 方法名<br>[anInvocation getArgument:NULL atIndex:0] 方法参数</p>
<p>示例代码：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> <span class="string">Student :</span> NSObject</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Student</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age</div><div class="line">&#123;</div><div class="line">    NSLog(@<span class="string">"%s，age == %d"</span>, __func__, age);</div><div class="line">    <span class="keyword">return</span> age * <span class="number">2</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@interface</span> <span class="string">Person :</span> NSObject</div><div class="line">- (<span class="keyword">int</span>)<span class="string">test:</span>(<span class="keyword">int</span>)age;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"></div><div class="line">- (id)<span class="string">forwardingTargetForSelector:</span>(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="meta">@selector</span>(<span class="string">test:</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">forwardingTargetForSelector:</span>aSelector];;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector &#123;</div><div class="line">    <span class="keyword">if</span> (aSelector == <span class="meta">@selector</span>(<span class="string">test:</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> [NSMethodSignature <span class="string">signatureWithObjCTypes:</span><span class="string">"i24@0:8i16"</span>];;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> <span class="string">methodSignatureForSelector:</span>aSelector];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    <span class="comment">// to do 👇</span></div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, const <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person <span class="string">test:</span><span class="number">15</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>👉 通过 <code>getArgument:atIndex:</code> 方法获取参数：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    <span class="keyword">int</span> age;</div><div class="line">    [anInvocation <span class="string">getArgument:</span>&amp;age <span class="string">atIndex:</span><span class="number">2</span>]; <span class="comment">//传入 age 的地址和下标</span></div><div class="line">    NSLog(@<span class="string">"age == %d"</span>, age);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">age</span> == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<p>因为 <code>-(void)test:(int)age</code> 的 C 语言实现是 <code>void test(id self, SEL _cmd, int age)</code>，一共有三个参数，参数顺序：receiver、selector 和 other argument，所以参数 age 的下标是 2。</p>
<p>👉 调用 <code>invokeWithTarget:</code> 方法，将消息转发给 Student 的实例对象：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</div><div class="line">    /**</div><div class="line">     anInvocation.target == person对象</div><div class="line">     anInvocation.selector == test:</div><div class="line">     anInvocation 的参数：<span class="number">15</span></div><div class="line">     */</div><div class="line">    [anInvocation invokeWithTarget:<span class="string">[[Student alloc] init]]</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="string">[Student test:]</span>，age == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<p>在调用 <code>invokeWithTarget:</code> 方法前，anInvocation 的 target 是 person 对象，selector 是 <code>-(void)test:(int)age</code> 方法，参数是 15。在调用 <code>invokeWithTarget:</code> 方法后， anInvocation 的 target 就变成了 student 对象了。相当于向 student 对象发送了一条“test:”消息 <code>objc_msgSend([[Student alloc] init], @selector(test:))</code>。</p>
<p>👉 调用 <code>getReturnValue:</code> 方法获取返回值：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation &#123;</div><div class="line">    [anInvocation <span class="string">invokeWithTarget:</span>[[Student alloc] init]];</div><div class="line">    <span class="keyword">int</span> returnAge;</div><div class="line">    [anInvocation <span class="string">getReturnValue:</span>&amp;returnAge];</div><div class="line">    NSLog(@<span class="string">"returnAge == %d"</span>, returnAge);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">[Student <span class="symbol">test:</span>]，age == <span class="number">15</span></span></div><div class="line"><span class="ruby">returnAge == <span class="number">30</span></span></div></pre></td></tr></table></figure></p>
<h3 id="synthesize、-dynamic"><a href="#synthesize、-dynamic" class="headerlink" title="@synthesize、@dynamic"></a>@synthesize、@dynamic</h3><p>@synthesize 会自动生成属性 age 的成员变量 _age，同时生成属性 age 的 setter 和 getter 方法的实现。现在的 xcode 都是默认生成了，不用手写了。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line"><span class="keyword">@synthesize</span> age = _age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *student = [[Student alloc] init];</div><div class="line">        student.age = <span class="number">20</span>;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"student.age == %d"</span>, student.age);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">student<span class="selector-class">.age</span> == <span class="number">20</span></div></pre></td></tr></table></figure></p>
<p>@dynamic 是告诉编译器不需要自动生成属性 age 的成员变量 _age，也不需要生成属性 age 的 setter 和 getter 方法的实现。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age; <span class="comment">//声明 age 的 setter 和 getter 方法</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line"><span class="keyword">@dynamic</span> age;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *student = [[Student alloc] init];</div><div class="line">        student.age = <span class="number">20</span>; <span class="comment">//[student setAge:20]，有 setter 和 getter 方法的声明，没有 setter 和 getter 方法的实现</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"student.age == %d"</span>, student.age);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>报错：unrecognized selector sent to instance<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime29.png" alt="Runtime29"></p>
<p>使用动态方法解析解决这个问题：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Student </span>: NSObject</div><div class="line"><span class="variable">@property</span> (nonatomic, assign) int age;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Student</div><div class="line"></div><div class="line"><span class="variable">@dynamic</span> age;</div><div class="line"></div><div class="line"><span class="selector-tag">void</span> <span class="selector-tag">setAge</span>(id self, SEL _cmd, int age)</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"age is %d"</span>, age);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">int</span> <span class="selector-tag">age</span>(id self, SEL _cmd)</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-tag">15</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (BOOL)<span class="selector-tag">resolveInstanceMethod</span><span class="selector-pseudo">:(SEL)sel</span> &#123;</div><div class="line">    <span class="selector-tag">if</span> (sel == <span class="variable">@selector</span>(<span class="attribute">setAge</span>:)) &#123;</div><div class="line">        <span class="selector-tag">class_addMethod</span>(self, sel, (IMP)setAge, <span class="string">"v@:i"</span>);</div><div class="line">        <span class="selector-tag">return</span> <span class="selector-tag">YES</span>;</div><div class="line">    &#125; <span class="selector-tag">else</span> <span class="selector-tag">if</span> (sel == <span class="variable">@selector</span>(age)) &#123;</div><div class="line">        <span class="selector-tag">class_addMethod</span>(self, sel, (IMP)age, <span class="string">"i@:"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="selector-tag">return</span> <span class="selector-attr">[super resolveInstanceMethod:sel]</span>;</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">age is <span class="number">20</span></div><div class="line">student.age == <span class="number">15</span></div></pre></td></tr></table></figure></p>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><ul>
<li><code>forwardingTargetForSelector:</code>、<code>methodSignatureForSelector:</code> 和 <code>forwardInvocation:</code> 方法本身并没有区分对象方法和类方法，但是在 _objc_forward_handler 的实现中，receiver （实列对象/类对象）会调用对应的方法（对象方法/类方法），所以实现的方法类型需要跟返回的类型统一。消息转发中，不要在意方法是对象方法还是类方法，本质还是 objc_msgSend 的消息接收者和方法名（实例对象 - 对象方法，类对象 - 类方法）。</li>
</ul>
<h1 id="super-的本质"><a href="#super-的本质" class="headerlink" title="super 的本质"></a>super 的本质</h1><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self class] = %@"</span>, [<span class="keyword">self</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[self superclass] = %@"</span>, [<span class="keyword">self</span> superclass]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"----------------------------"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super class] = %@"</span>, [<span class="keyword">super</span> <span class="keyword">class</span>]);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"[super superclass] = %@"</span>, [<span class="keyword">super</span> superclass]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        Student *stu = [[Student alloc] init];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>] = <span class="title">Student</span></span></div><div class="line">[<span class="built_in">self</span> superclass] = Person</div><div class="line">----------------------------</div><div class="line">[<span class="built_in">super</span> <span class="class"><span class="keyword">class</span>] = <span class="title">Student</span></span></div><div class="line">[<span class="built_in">super</span> superclass] = Person</div></pre></td></tr></table></figure></p>
<p>这里的 self 就是 person 实例对象，<code>[self class]</code> 返回的是 person 实例对象的类对象，<code>[self superclass]</code> 返回的是父类 Person 的类对象。  </p>
<p>思考：<br>super 代表的是 student 的父类 person，那么 <code>[super class]</code> 应该就等于 <code>[person class]</code>，打印结果应该是 Person，而 <code>[super class]</code>  的打印结果却是 Student❓同样的 <code>[super superclass]</code> 应该就等于 <code>[person superclass]</code>，打印结果应该是 NSObject，而 <code>[super superclass]</code> 打印结果却是 Person❓</p>
<h2 id="objc-super-结构体"><a href="#objc-super-结构体" class="headerlink" title="objc_super 结构体"></a>objc_super 结构体</h2><p>定义一个 <code>-(void)run</code> 方法：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</div><div class="line">- (void)run;</div><div class="line"><span class="variable">@end</span></div><div class="line"></div><div class="line"><span class="variable">@implementation</span> Person</div><div class="line">- (void)run</div><div class="line">&#123;</div><div class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">"%@"</span>, __func__);</div><div class="line">&#125;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">interface</span> <span class="selector-tag">Student</span> : <span class="selector-tag">Person</span></div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">run</span>;</div><div class="line">@<span class="selector-tag">end</span></div><div class="line"></div><div class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Student</span></div><div class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">run</span></div><div class="line">&#123;</div><div class="line">    <span class="selector-attr">[super run]</span>;</div><div class="line">&#125;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure></p>
<p>通过终端命令 <code>xcrun -sdk iphoneos clang -arch arm64  -rewrite-objc Student.m</code> 生成 c++ 代码 Student.cpp，查看 <code>-(void)run</code> 方法的 c++ 实现：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_Student_run(Student * <span class="keyword">self</span>, SEL _cmd) &#123;</div><div class="line">    <span class="comment">//[super run];</span></div><div class="line">    ((<span class="keyword">void</span> (*)(__rw_objc_super *, SEL))(<span class="keyword">void</span> *)objc_msgSendSuper)((__rw_objc_super)&#123;(<span class="keyword">id</span>)<span class="keyword">self</span>, (<span class="keyword">id</span>)class_getSuperclass(objc_getClass(<span class="string">"Student"</span>))&#125;, sel_registerName(<span class="string">"run"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>简化后的 <code>[super run]</code>：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">objc_msgSendSuper</span><span class="params">( (__rw_objc_super)</span></span>&#123;</div><div class="line">                        self, <span class="comment">//student 实例对象</span></div><div class="line">                        class_getSuperclass(objc_getClass(<span class="string">"Student"</span>)) <span class="comment">//[Person class]</span></div><div class="line">                    &#125;, <span class="comment">//__rw_objc_super 结构体</span></div><div class="line">                    sel_registerName(<span class="string">"run"</span>) <span class="comment">//@selector(run)) );</span></div></pre></td></tr></table></figure></p>
<p>可以看到 <code>[super run]</code> 的底层实现调用的是 <code>objc_msgSendSuper()</code> 方法，第一个参数是 <code>__rw_objc_super</code> 结构体，第二参数是 <code>@selector(run)</code>。所以 super 的本质就是 <code>__rw_objc_super</code> 结构体：<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__rw_objc_super</span></span> &#123; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *object; </div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *superClass; </div><div class="line">	__rw_objc_super(<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *o, <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *s) : object(o), superClass(s) &#123;&#125; </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>__rw_objc_super</code> 结构体是在编译时生成的，并将参数传入 objc_msgSendSuper() 方法。但是 objc_msgSendSuper() 在定义时该位置的参数是一个 objc_super 结构体：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct objc_super &#123;</div><div class="line">    <span class="comment">/// Specifies an instance of a class.</span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> id receiver;</div><div class="line"></div><div class="line">    <span class="comment">/// Specifies the particular superclass of the instance to message. </span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span></div><div class="line">    <span class="comment">/* For compatibility with old objc-runtime.h header */</span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> Class class;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="variable">__unsafe_unretained</span> <span class="variable">_Nonnull</span> Class super_class;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    <span class="comment">/* super_class is the first class to search */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>因为 <code>__rw_objc_super</code> 和 objc_super 的结构基本一致，所以 <code>__rw_objc_super</code> 结构体算是一个自定的 objc_super，作为参数传给 objc_msgSendSuper()。</p>
<p>因为现在使用的是 <code>__OBJC2__</code>，所以 objc_super 可以简化为：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> objc_super &#123;</div><div class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull <span class="keyword">id</span> receiver; <span class="comment">//消息接收者</span></div><div class="line">    __<span class="keyword">unsafe_unretained</span> _Nonnull Class super_class; <span class="comment">//消息接收者的父类</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>可以看到 objc_super 结构体的第一个参数是消息接收者，第二个参数是消息接收者的父类。所以 <code>[super run]</code> 的底层实现就是：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> __rw_objc_super arg = &#123; </div><div class="line">    <span class="keyword">self</span>, <span class="comment">//消息接收者</span></div><div class="line">    [Person <span class="keyword">class</span>] <span class="comment">//消息接收者的父类 </span></div><div class="line">&#125;;</div><div class="line">objc_msgSendSuper(arg, <span class="keyword">@selector</span>(run));</div></pre></td></tr></table></figure></p>
<h2 id="objc-msgSendSuper-方法"><a href="#objc-msgSendSuper-方法" class="headerlink" title="objc_msgSendSuper() 方法"></a>objc_msgSendSuper() 方法</h2><p>通过终端命令 <code>xcrun -sdk iphoneos clang -arch arm64  -rewrite-objc Student.m</code> 生成的 c++ 代码 Student.cpp，查看 <code>[super run]</code> 的 c++ 实现是调用的 objc_msgSendSuper() 方法。  </p>
<p>关于 <code>[super run]</code> 调用的方法 objc_msgSendSuper()：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"><span class="comment"> * Sends a message with a simple return value to the superclass of an instance of a class.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> super A pointer to an \c objc_super data structure. Pass values identifying the</span></div><div class="line"><span class="comment"> *  context the message was sent to, including the instance of the class that is to receive the</span></div><div class="line"><span class="comment"> *  message and the superclass at which to start searching for the method implementation.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> op A pointer of type SEL. Pass the selector of the method that will handle the message.</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> ...</span></div><div class="line"><span class="comment"> *   A variable argument list containing the arguments to the method.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> The return value of the method identified by \e op.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> objc_msgSend</span></div><div class="line"><span class="comment"> */</span></div><div class="line">OBJC_EXPORT id _Nullable</div><div class="line">objc_msgSendSuper(struct objc_super * _Nonnull super, SEL _Nonnull op, ...)</div><div class="line">    OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</div></pre></td></tr></table></figure></p>
<p>objc_msgSendSuper：向实例对象的 super 发送带有简单返回值的消息。第一个参数：super，第二个参数：op（方法的选择器 SEL）。  </p>
<ul>
<li>super：是一个指向 <code>objc_super</code> 结构体的指针，在结构体的内部有接收消息的实例对象和开始搜索方法实现的类对象（从该类对象开始搜索方法的实现）。  </li>
<li>op：SEL 类型的指针。传递方法的选择器（@selector(run)），该方法就是要处理的消息。</li>
</ul>
<p>通过注释，可以知道 objc_msgSendSuper() 有两个参数 super 和 SEL，其中 super 里有一个消息接收者和一个类对象。objc_msgSendSuper() 会从 super 里的类对象开始查找 SEL，找到后交给 super 里的消息接收者处理。</p>
<p>综上所述：<br><code>[super run]</code>：设置消息接收者是 self（student 实例对象），并从 Person 类对象开始查找 <code>-(void)run</code> 方法：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; <span class="keyword">self</span>, [Person <span class="class"><span class="keyword">class</span>] &#125;, @<span class="title">selector</span>(<span class="title">run</span>));</span></div></pre></td></tr></table></figure></p>
<p><code>[super method]</code> 流程图：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime30.png" alt="Runtime30"></p>
<h2 id="objc-msgSendSuper2"><a href="#objc-msgSendSuper2" class="headerlink" title="objc_msgSendSuper2()"></a>objc_msgSendSuper2()</h2><h3 id="查看汇编代码"><a href="#查看汇编代码" class="headerlink" title="查看汇编代码"></a>查看汇编代码</h3><p>在 <code>[super superclass];</code> 处添加断点，选择 Debug -&gt; Debug Workflow -&gt; Always Show Disassembly：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime31.png" alt="Runtime31"><br>可以看到 <code>[super class]</code> 和 <code>[super superclass]</code> 底层实现调用的并不是 <code>objc_msgSendSuper()</code> 方法而是 <code>objc_msgSendSuper2()</code> 方法。</p>
<p><code>objc_msgSendSuper2()</code> 方法的具体实现在汇编文件 objc-msg-arm64.s 里：<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ENTRY _objc_msgSendSuper2</div><div class="line">UNWIND _objc_msgSendSuper2, NoFrame</div><div class="line"></div><div class="line">ldp	p0, p16, <span class="selector-attr">[x0]</span>		<span class="comment">// p0 = real receiver, p16 = class</span></div><div class="line">ldr	p16, <span class="selector-attr">[x16, #SUPERCLASS]</span>	<span class="comment">// p16 = class-&gt;superclass</span></div><div class="line">CacheLookup <span class="attribute">NORMAL</span>, _objc_msgSendSuper2</div><div class="line"></div><div class="line">END_ENTRY _objc_msgSendSuper2</div></pre></td></tr></table></figure></p>
<p>也可以通过选择 Product -&gt; Perform Action -&gt; Assemble “Student.m” 将 OC 代码转成汇编代码，搜索 “:21”（第21行）找到具体的代码实现：<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">......<span class="comment">//省略</span></div><div class="line"></div><div class="line">Ltmp0:</div><div class="line">	.loc	<span class="number">3</span> <span class="number">21</span> <span class="number">5</span> prologue_end     ## Runtime-test2/Student.m:<span class="number">21</span>:<span class="number">5</span> <span class="comment">//Student.m 文件的第 21 行</span></div><div class="line">	movq	<span class="number">-8</span>(%rbp), %rax</div><div class="line">	movq	%rax, <span class="number">-32</span>(%rbp)</div><div class="line">	movq	_OBJC_CLASSLIST_SUP_REFS_$_(%rip), %rax</div><div class="line">	movq	%rax, <span class="number">-24</span>(%rbp)</div><div class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</div><div class="line">	leaq	<span class="number">-32</span>(%rbp), %rdi</div><div class="line">	callq	_objc_msgSendSuper2</div><div class="line">	.loc	<span class="number">3</span> <span class="number">22</span> <span class="number">1</span>                  ## Runtime-test2/Student.m:<span class="number">22</span>:<span class="number">1</span></div><div class="line">	addq	$32, %rsp</div><div class="line">	popq	%rbp</div><div class="line">	retq</div><div class="line"></div><div class="line">......<span class="comment">//省略</span></div></pre></td></tr></table></figure></p>
<p>右边的注释代表的是 Student.m 第21行（:21）。在这里也可以看到 <code>[super run]</code> 调用的是 <code>_objc_msgSendSuper2</code> 方法。</p>
<h3 id="查看-LLVM-的中间代码（IR）"><a href="#查看-LLVM-的中间代码（IR）" class="headerlink" title="查看 LLVM 的中间代码（IR）"></a>查看 LLVM 的中间代码（IR）</h3><p>Objective-C 在变为机器代码之前，会被 LLVM 编译器转换为<a href="https://llvm.org/docs/LangRef.html" target="_blank" rel="external">中间代码（Intermediate Representation）</a>。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td>@</td>
<td>全局变量</td>
</tr>
<tr>
<td>%</td>
<td>局部变量</td>
</tr>
<tr>
<td>alloca</td>
<td>在当前执行的函数的堆栈帧中分配内存，当该函数返回到其调用者时，将自动释放内存</td>
</tr>
<tr>
<td>i32</td>
<td>32位4字节的整数</td>
</tr>
<tr>
<td>align</td>
<td>对齐</td>
</tr>
<tr>
<td>load</td>
<td>读出</td>
</tr>
<tr>
<td>store</td>
<td>写入</td>
</tr>
<tr>
<td>icmp</td>
<td>两个整数值比较，返回布尔值</td>
</tr>
<tr>
<td>br</td>
<td>选择分支，根据条件来转向 label，不根据条件跳转的话类似 goto</td>
</tr>
<tr>
<td>label</td>
<td>代码标签</td>
</tr>
<tr>
<td>call</td>
<td>调用函数</td>
</tr>
</tbody>
</table>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@interface</span> <span class="string">Person :</span> NSObject</div><div class="line"><span class="meta">@end</span></div><div class="line"></div><div class="line"><span class="meta">@implementation</span> Person</div><div class="line"><span class="keyword">void</span> test(<span class="keyword">int</span> param)</div><div class="line">&#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSMethodSignature *)<span class="string">methodSignatureForSelector:</span>(SEL)aSelector</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [NSMethodSignature <span class="string">signatureWithObjCTypes:</span>@<span class="string">"v@:"</span>];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">forwardInvocation:</span>(NSInvocation *)anInvocation</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> <span class="string">forwardInvocation:</span>anInvocation];</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</div><div class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</div><div class="line">    <span class="keyword">int</span> c = a + b;</div><div class="line">    test(c);</div><div class="line">&#125;</div><div class="line"><span class="meta">@end</span></div></pre></td></tr></table></figure>
<p>使用以下命令行指令生成中间代码 Person.ll：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">clang</span> <span class="selector-tag">-emit-llvm</span> <span class="selector-tag">-S</span> <span class="selector-tag">Person</span><span class="selector-class">.m</span></div></pre></td></tr></table></figure></p>
<p>找到对应的方法实现：<br><figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">......//省略</div><div class="line">//<span class="symbol">%1</span>*：self，<span class="keyword">i8</span>*：_cmd，<span class="symbol">%2</span>*：anInvocation</div><div class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void @<span class="string">"\01-[Person forwardInvocation:]"</span>(<span class="symbol">%1</span>*, <span class="keyword">i8</span>*, <span class="symbol">%2</span>*) <span class="symbol">#2</span> &#123;</div><div class="line">  <span class="symbol">%4</span> = <span class="keyword">alloca</span> <span class="symbol">%1</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%5</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%6</span> = <span class="keyword">alloca</span> <span class="symbol">%2</span>*, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%7</span> = <span class="keyword">alloca</span> <span class="symbol">%struct._objc_super</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%8</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="symbol">%9</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="symbol">%10</span> = <span class="keyword">alloca</span> <span class="keyword">i32</span>, <span class="keyword">align</span> <span class="number">4</span></div><div class="line">  <span class="keyword">store</span> <span class="symbol">%1</span>* <span class="symbol">%0</span>, <span class="symbol">%1</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%1</span>, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="keyword">store</span> <span class="symbol">%2</span>* <span class="symbol">%2</span>, <span class="symbol">%2</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%11</span> = <span class="keyword">load</span> <span class="symbol">%1</span>*, <span class="symbol">%1</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%12</span> = <span class="keyword">load</span> <span class="symbol">%2</span>*, <span class="symbol">%2</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%13</span> = <span class="keyword">bitcast</span> <span class="symbol">%1</span>* <span class="symbol">%11</span> <span class="keyword">to</span> <span class="keyword">i8</span>*</div><div class="line">  <span class="symbol">%14</span> = <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="symbol">%struct._objc_super</span>, <span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i32</span> <span class="number">0</span>, <span class="keyword">i32</span> <span class="number">0</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%13</span>, <span class="keyword">i8</span>** <span class="symbol">%14</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%15</span> = <span class="keyword">load</span> <span class="symbol">%struct._class_t</span>*, <span class="symbol">%struct._class_t</span>** @<span class="string">"OBJC_CLASSLIST_SUP_REFS_$_"</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%16</span> = <span class="keyword">bitcast</span> <span class="symbol">%struct._class_t</span>* <span class="symbol">%15</span> <span class="keyword">to</span> <span class="keyword">i8</span>*</div><div class="line">  <span class="symbol">%17</span> = <span class="keyword">getelementptr</span> <span class="keyword">inbounds</span> <span class="symbol">%struct._objc_super</span>, <span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i32</span> <span class="number">0</span>, <span class="keyword">i32</span> <span class="number">1</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%16</span>, <span class="keyword">i8</span>** <span class="symbol">%17</span>, <span class="keyword">align</span> <span class="number">8</span></div><div class="line">  <span class="symbol">%18</span> = <span class="keyword">load</span> <span class="keyword">i8</span>*, <span class="keyword">i8</span>** <span class="title">@OBJC_SELECTOR_REFERENCES_.2</span>, <span class="keyword">align</span> <span class="number">8</span>, <span class="title">!invariant.load</span> !<span class="number">9</span></div><div class="line">  //调用 objc_msgSendSuper<span class="number">2</span>，参数一：_objc_super，参数二：<span class="keyword">i8</span>* _cmd</div><div class="line">  <span class="keyword">call</span> void <span class="keyword">bitcast</span> (<span class="keyword">i8</span>* (<span class="symbol">%struct._objc_super</span>*, <span class="keyword">i8</span>*, ...)* <span class="title">@objc_msgSendSuper2</span> <span class="keyword">to</span> void (<span class="symbol">%struct._objc_super</span>*, <span class="keyword">i8</span>*, <span class="symbol">%2</span>*)*)(<span class="symbol">%struct._objc_super</span>* <span class="symbol">%7</span>, <span class="keyword">i8</span>* <span class="symbol">%18</span>, <span class="symbol">%2</span>* <span class="symbol">%12</span>)</div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="number">10</span>, <span class="keyword">i32</span>* <span class="symbol">%8</span>, <span class="keyword">align</span> <span class="number">4</span>    //将<span class="number">10</span>写入到<span class="symbol">%8</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="number">20</span>, <span class="keyword">i32</span>* <span class="symbol">%9</span>, <span class="keyword">align</span> <span class="number">4</span>    //将<span class="number">20</span>写入到<span class="symbol">%9</span></div><div class="line">  <span class="symbol">%19</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%8</span>, <span class="keyword">align</span> <span class="number">4</span>  //将<span class="symbol">%8</span>读出到<span class="symbol">%19</span></div><div class="line">  <span class="symbol">%20</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%9</span>, <span class="keyword">align</span> <span class="number">4</span>  //将<span class="symbol">%9</span>读出到<span class="symbol">%20</span></div><div class="line">  <span class="symbol">%21</span> = <span class="keyword">add</span> <span class="keyword">nsw</span> <span class="keyword">i32</span> <span class="symbol">%19</span>, <span class="symbol">%20</span>        //将<span class="symbol">%19</span>加上<span class="symbol">%20</span>赋值给<span class="symbol">%21</span></div><div class="line">  <span class="keyword">store</span> <span class="keyword">i32</span> <span class="symbol">%21</span>, <span class="keyword">i32</span>* <span class="symbol">%10</span>, <span class="keyword">align</span> <span class="number">4</span>  //将<span class="symbol">%21</span>写入到<span class="symbol">%10</span></div><div class="line">  <span class="symbol">%22</span> = <span class="keyword">load</span> <span class="keyword">i32</span>, <span class="keyword">i32</span>* <span class="symbol">%10</span>, <span class="keyword">align</span> <span class="number">4</span> //将<span class="symbol">%10</span>读出到<span class="symbol">%22</span></div><div class="line">  <span class="keyword">call</span> void <span class="title">@test</span>(<span class="keyword">i32</span> <span class="symbol">%22</span>)          //调用 test(<span class="symbol">%22</span>)</div><div class="line">  <span class="keyword">ret</span> void</div><div class="line">&#125;</div><div class="line"></div><div class="line">......//省略</div></pre></td></tr></table></figure></p>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>通过终端命令行生成的 c++ 代码中 <code>[super run]</code> 的底层实现是 <code>objc_msgSendSuper()</code> 方法，通过查看汇编代码和 LLVM 的中间代码可以看到 <code>[super run]</code> 的底层实现是 <code>objc_msgSendSuper2()</code> 方法。这个问题还是之前提到过的，通过终端命令生成的编译文件很运行时生成的编译文件相比，在某些细节的地方还是有区别的。不过并不影响理解具体的实现逻辑。</p>
<h2 id="self、class-和-superclass-的底层实现"><a href="#self、class-和-superclass-的底层实现" class="headerlink" title="self、class 和 superclass 的底层实现"></a>self、class 和 superclass 的底层实现</h2><p>self、class 和 superclass 的底层实现在源码 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 NSObject.mm 文件。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">+ (id)<span class="built_in">self</span> &#123;</div><div class="line">    <span class="keyword">return</span> (id)<span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)<span class="built_in">self</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="class"><span class="keyword">Class</span>)<span class="title">class</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="class"><span class="keyword">Class</span>)<span class="title">class</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> object_getClass(<span class="built_in">self</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>-&gt;superclass;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> [<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>]-&gt;<span class="title">superclass</span>;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>[super class]</code> 设置的消息接收者是 self（student 实例对象），并从 Person 类对象开始查找对象方法 <code>-(Class)class</code>。在 Person 类对象里没有找到，通过 superclass 指针找到父类的类对象 NSObject，在 NSObject 类对象里找到了对象方法 <code>-(Class)class</code> 后交给消息接收者处理。因为是由消息接收者处理对象方法 <code>-(Class)class</code>，所以对象方法 <code>- (Class)class</code> 的参数 self 自然就是消息接收者本身了。所以 <code>[super class]</code> 最终的返回值就是 Student（<code>[student class]</code>）。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; self, [Person <span class="class"><span class="keyword">class</span>] &#125;, <span class="type">@selector</span></span>(<span class="class"><span class="keyword">class</span>));</span></div></pre></td></tr></table></figure></p>
<p><code>[super superclass]</code> 设置的消息接收者是 self（student 实例对象），并从 Person 类对象开始查找对象方法 <code>-(Class)superclass</code>。在 Person 类对象里没有找到，通过 superclass 指针找到父类的类对象 NSObject，在 NSObject 类对象里找到了对象方法 <code>-(Class)superclass</code> 后交给消息接收者处理。因为是由消息接收者处理对象方法 <code>-(Class)superclass</code>，所以对象方法 <code>- (Class)superclass</code> 的参数 self 自然就是消息接收者本身了。所以 <code>[super superclass]</code> 的返回值就是 Person（<code>[student superclass]</code>）。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">objc_msgSendSuper(&#123; <span class="keyword">self</span>, [Person <span class="class"><span class="keyword">class</span>] &#125;, @<span class="title">selector</span>(<span class="title">superclass</span>));</span></div></pre></td></tr></table></figure></p>
<p>现在再看这四个方法，就很清晰了：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> <span class="keyword">class</span>];       <span class="comment">//消息接收者：student，调用方法：-(void)class</span></div><div class="line">        [<span class="keyword">self</span> superclass];  <span class="comment">//消息接收者：student，调用方法：-(void)superclass</span></div><div class="line"></div><div class="line">        [<span class="keyword">super</span> <span class="keyword">class</span>];      <span class="comment">//消息接收者：student，调用方法：-(void)class</span></div><div class="line">        [<span class="keyword">super</span> superclass]; <span class="comment">//消息接收者：student，调用方法：-(void)superclass</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="isKindOfClass-和-isMemberOfClass"><a href="#isKindOfClass-和-isMemberOfClass" class="headerlink" title="isKindOfClass: 和 isMemberOfClass:"></a>isKindOfClass: 和 isMemberOfClass:</h2><p><code>isKindOfClass:</code> 和 <code>isMemberOfClass:</code> 的底层实现在源码 <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">objc4-781</a> 的 NSObject.mm 文件。<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+ (BOOL)isMemberOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> <span class="built_in">self</span>-&gt;ISA() == cls;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isMemberOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">return</span> [<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>] == <span class="title">cls</span>;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (BOOL)isKindOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">for</span> (<span class="class"><span class="keyword">Class</span> <span class="title">tcls</span> = <span class="title">self</span>-&gt;<span class="title">ISA</span>(); <span class="title">tcls</span>; <span class="title">tcls</span> = <span class="title">tcls</span>-&gt;<span class="title">superclass</span>) &#123;</span></div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> NO;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (BOOL)isKindOfClass:(<span class="class"><span class="keyword">Class</span>)<span class="title">cls</span> &#123;</span></div><div class="line">    <span class="keyword">for</span> (<span class="class"><span class="keyword">Class</span> <span class="title">tcls</span> = [<span class="title">self</span> <span class="title">class</span>]; <span class="title">tcls</span>; <span class="title">tcls</span> = <span class="title">tcls</span>-&gt;<span class="title">superclass</span>) &#123;</span></div><div class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><p><code>-isMemberOfClass:</code>：获取 self 的类对象与传入的 cls 进行比较。</p>
</li>
<li><p><code>+isMemberOfClass:</code>：因为自身是类方法，所以这里是拿 self-&gt;ISA()（元类）作为 tcls 与传入的 cls 进行比较。</p>
</li>
<li><p><code>+isKindOfClass:</code>：方法内部是一个 for 循环，因为自身是类方法，所以这里是拿 self-&gt;ISA()（元类）与传入的 cls 进行比较。如果不相等再遍历 tcls 的 superclass 与传入的 cls 进行比较。遍历过程中有一个相等就结束遍历返回 YES，遍历结束后没有找到相等的类就返回 NO。</p>
</li>
<li><p><code>-isKindOfClass:</code>：方法内部是一个 for 循环，先获取到 self 的类对象 tcls 与传入的 cls 进行比较。如果不相等再遍历 tcls 的 superclass 与传入的 cls 进行比较。遍历过程中有一个相等就结束遍历返回 YES，遍历结束后没有找到相等的类就返回 NO。</p>
</li>
</ul>
<h3 id="isMemberOfClass-和-isKindOfClass"><a href="#isMemberOfClass-和-isKindOfClass" class="headerlink" title="+isMemberOfClass: 和 +isKindOfClass:"></a>+isMemberOfClass: 和 +isKindOfClass:</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="built_in">BOOL</span> res1 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];   <span class="comment">//1</span></div><div class="line">        <span class="built_in">BOOL</span> res2 = [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]; <span class="comment">//2</span></div><div class="line">        <span class="built_in">BOOL</span> res3 = [[Person <span class="keyword">class</span>] isKindOfClass:[Person <span class="keyword">class</span>]];       <span class="comment">//3</span></div><div class="line">        <span class="built_in">BOOL</span> res4 = [[Person <span class="keyword">class</span>] isMemberOfClass:[Person <span class="keyword">class</span>]];     <span class="comment">//4</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d"</span>, res1, res2, res3, res4);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>打印结果解析：<br><code>+isKindOfClass:</code> 方法，先通过 self-&gt;ISA() 找到 NSObject 元类对象，不等于 NSObject 类对象。再通过 NSObject 元类对象的 superclass 指针找到 NSObject 类对象，等于 NSObject 类对象。所以结果等于 YES：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//1</span></div><div class="line"></div><div class="line"><span class="comment">//等于</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [<span class="built_in">NSObject</span> isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>+isMemberOfClass:</code> 方法，通过 self-&gt;ISA() 找到 NSObject 元类对象，不等于 NSObject 类对象。所以结果等于 NO：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//0</span></div><div class="line"><span class="comment">//等于</span></div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, [<span class="built_in">NSObject</span> isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]]); <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<p><code>+isKindOfClass:</code> 方法，先通过 self-&gt;ISA() 找到 Person 元类对象，不等于 Person 类对象。再通过 Person 元类对象的 superclass 指针找到 NSObject 元类对象，不等于 Person 类对象。再通过 NSObject 元类对象的 superclass 指针找到 NSObject 类对象，不等于 Person 类对象。所以结果等于 NO：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>] <span class="title">isKindOfClass</span></span>:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div><div class="line"><span class="comment">//等于</span></div><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="type">Person</span> isKindOfClass:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<p><code>+isMemberOfClass:</code> 方法，通过 self-&gt;ISA() 找到 Person 元类对象，不等于 Person 类对象。所以结果等于 NO：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>] <span class="title">isMemberOfClass</span></span>:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div><div class="line"><span class="comment">//等于</span></div><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="type">Person</span> isMemberOfClass:[<span class="type">Person</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//0</span></div></pre></td></tr></table></figure></p>
<h4 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h4><p>因为当类对象调用类方法 <code>+isMemberOfClass:</code> 和 <code>+isKindOfClass:</code> 时，是拿类对象的元类对象跟传入的对象做对比，所以除 NSObject 外，其它类对象调用这两个类方法时，右边传入的至少应该是元类对象才有意义。</p>
<h3 id="isMemberOfClass-和-isKindOfClass-1"><a href="#isMemberOfClass-和-isKindOfClass-1" class="headerlink" title="-isMemberOfClass: 和 -isKindOfClass:"></a>-isMemberOfClass: 和 -isKindOfClass:</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        <span class="built_in">NSObject</span> *object = [[<span class="built_in">NSObject</span> alloc] init];</div><div class="line">        <span class="built_in">BOOL</span> res5 = [object isKindOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res6 = [object isMemberOfClass:[<span class="built_in">NSObject</span> <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res7 = [person isKindOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">BOOL</span> res8 = [person isMemberOfClass:[Person <span class="keyword">class</span>]];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d"</span>, res5, res6, res7, res8);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p><code>-isKindOfClass:</code> 方法，通过 [self class] 找到 NSObject 类对象，所以结果等于 YES：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="class"><span class="keyword">object</span> <span class="title">isKindOfClass</span></span>:[<span class="type">NSObject</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isMemberOfClass:</code> 方法，通过 [self class] 找到 NSObject 类对象，所以结果等于 YES：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="type">NSLog</span>(@<span class="string">"%d"</span>, [<span class="class"><span class="keyword">object</span> <span class="title">isMemberOfClass</span></span>:[<span class="type">NSObject</span> <span class="class"><span class="keyword">class</span>]])</span>; <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isKindOfClass:</code> 方法，通过 [self class] 找到 Person 类对象，所以结果等于 YES：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"%d"</span>, [person <span class="attribute">isKindOfClass</span>:[Person class]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<p><code>-isMemberOfClass:</code> 方法，通过 [self class] 找到 Person 类对象，所以结果等于 YES：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"%d"</span>, [person <span class="attribute">isMemberOfClass</span>:[Person class]]); <span class="comment">//1</span></div></pre></td></tr></table></figure></p>
<h4 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h4><p>因为当实例对象调用对象方法 <code>-isMemberOfClass:</code> 和 <code>-isKindOfClass:</code> 时，是拿实例对象的类对象跟传入的对象做对比，所以在实例对象调用这两个对象方法时，右边传入的至少应该是类对象才有意义。</p>
<h2 id="对象方法的调用原理"><a href="#对象方法的调用原理" class="headerlink" title="对象方法的调用原理"></a>对象方法的调用原理</h2><h3 id="正常调用"><a href="#正常调用" class="headerlink" title="正常调用"></a>正常调用</h3><p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime32.png" alt="Runtime32"><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person -run %@"</span>, <span class="keyword">self</span>-&gt;_name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    Person *person = [[Person alloc] init];</div><div class="line">    [person run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="builtin-name">run</span> (<span class="literal">null</span>)</div></pre></td></tr></table></figure></p>
<p>指针 person 存储着 person 实例对象的地址（person 实例对象的 isa 地址），而 person 实例对象的 isa 指针里存储着 Person 类对象的地址（Person 类对象的 isa 地址）。<code>[person run]</code> 是通过 person 实例对象的 isa 指针找到 Person 类对象查找 <code>-(void)run</code> 方法，<code>-(void)run</code> 方法内部的 self 就是消息接收者（person 实例对象）。person 实例对象内部存储着 isa 指针和成员变量，<code>self-&gt;_name</code> 是从 isa 的地址开始在 person 实例对象的内存里向下查找成员变量 _name。</p>
<h3 id="自定义调用"><a href="#自定义调用" class="headerlink" title="自定义调用"></a>自定义调用</h3><p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime33.png" alt="Runtime33"><br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Person -run %@"</span>, <span class="keyword">self</span>.name);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad]; <span class="comment">//高地址</span></div><div class="line">    </div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="keyword">run</span><span class="bash"> &lt;ViewController: 0x7fd88fb0a400&gt;</span></div></pre></td></tr></table></figure></p>
<p>思考：  </p>
<ol>
<li><code>[(__bridge id)obj run]</code> 为什么能够调用成功？  </li>
<li>为什么 self.name 变成了 ViewController?  </li>
</ol>
<p>局部变量的内存分配在栈空间，从高地址到低地址：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> test()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> a = <span class="number">1</span>; <span class="comment">//0x7ffeefbff518（高地址）</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> b = <span class="number">2</span>; <span class="comment">//0x7ffeefbff510   ↓</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> c = <span class="number">3</span>; <span class="comment">//0x7ffeefbff508   ↓</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> d = <span class="number">4</span>; <span class="comment">//0x7ffeefbff500（低地址）</span></div><div class="line">    NSLog(@<span class="string">"%p, %p, %p, %p"</span>, &amp;a, &amp;b, &amp;c, &amp;d);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</div><div class="line">    <span class="meta">@autoreleasepool</span> &#123;</div><div class="line">        test();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x7ffeefbff</span>518, <span class="number">0x7ffeefbff</span>510, <span class="number">0x7ffeefbff</span>508, <span class="number">0x7ffeefbff</span>500</div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到 a、b、c、d 的内存分配顺序是从高地址到低地址。</p>
<p><code>[(__bridge id)obj run]</code> 图解：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime35.png" alt="Runtime35"> </p>
<p>图中可以看到 obj、cls 和 self 的内存都分配在栈空间，<code>[UIViewController class]</code> 在全局区，self 的地址值最大，obj 的地址值最小。self 和 <code>[UIViewController class]</code> 来自 <code>[super viewDidLoad]</code> 的结构体 <code>__rw_objc_super</code>，<code>__rw_objc_super</code> 也是一个临时变量：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">rw_objc_super</span> <span class="title">arg</span> = &#123;</span> </div><div class="line">    self, </div><div class="line">    [ViewController <span class="class"><span class="keyword">class</span>] </span></div><div class="line"><span class="class">&#125;;</span></div><div class="line">objc_msgSendSuper(arg, @selector(viewDidLoad));</div></pre></td></tr></table></figure></p>
<p>这一点可以通过打印内存进行验证（<code>x/4g</code>：打印4个数据，每个数据8个字节）：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(lldb) p/x obj</div><div class="line">(Person *) <span class="number">$0</span> = <span class="number">0x00007ffeea236178</span></div><div class="line">(lldb) x/4g <span class="number">0x00007ffeea236178</span></div><div class="line"><span class="number">0x7ffeea236178</span>: <span class="number">0x00000001059cb5c0</span> <span class="number">0x00007fc0cb00a9b0</span></div><div class="line"><span class="number">0x7ffeea236188</span>: <span class="number">0x00000001059cb4f8</span> <span class="number">0x00007fff51ec8b0c</span></div><div class="line">(lldb) p (Class)<span class="number">0x00000001059cb5c0</span></div><div class="line">(Class) <span class="number">$1</span> = Person</div><div class="line">(lldb) po <span class="number">0x00007fc0cb00a9b0</span></div><div class="line">&lt;ViewController: <span class="number">0x7fc0cb00a9b0</span>&gt;</div><div class="line"></div><div class="line">(lldb) p (Class)<span class="number">0x00000001059cb4f8</span></div><div class="line">(Class) <span class="number">$3</span> = ViewController</div></pre></td></tr></table></figure></p>
<p>从打印结果可以看到，依次是 Person 类对象、<viewcontroller: 0x7fc0cb00a9b0=""> 实列对象和 ViewController 类对象。</viewcontroller:></p>
<p>注释掉 <code>[super viewDidLoad]</code> 就会报坏内存访问的错误：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime36.png" alt="Runtime36"></p>
<p>修改 ViewController.m 实现，添加成员变量 test：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSString</span> *test = <span class="string">@"123"</span>;</div><div class="line">    <span class="keyword">id</span> cls = [Person <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">void</span> *obj = &amp;cls;</div><div class="line">    [(__bridge <span class="keyword">id</span>)obj run];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Person -<span class="keyword">run</span><span class="bash"> 123</span></div></pre></td></tr></table></figure></p>
<p>指针 obj 存储着 cls 的地址，而 cls 存储着 Person 类对象的地址（Person 类对象的 isa 地址）。<code>[(__bridge id)obj run]</code> 是通过 cls 找到 Person 类对象查找 <code>-(void)run</code> 方法，<code>-(void)run</code> 方法内部的 self 就是消息接收者 obj。从 obj 的内存开始在 obj 所在的内存中向下查找成员变量 _name，最后找到的却是 cls 下面的局部变量 test：<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime34.png" alt="Runtime34"> </p>
<p>从图中可以看到 obj、cls 和 test 三个变量的内存都分配在栈空间，test 的地址值最大，obj 的地址值最小。</p>
<ul>
<li><code>[(__bridge id)obj run]</code> 为什么能够调用成功？<br>因为指针 obj 存储着 cls 的地址，而 cls 存储着 Person 类对象的地址（Person 类对象的 isa 地址），所以 <code>[(__bridge id)obj run]</code> 是通过 cls 找到 Person 类对象查找 <code>-(void)run</code> 方法(这里的 cls 相当于 person 实例对象的 isa)。</li>
<li>为什么 self.name 变成了 ViewController？<br>因为 <code>-(void)run</code> 方法内部的 self 就是消息接收者 obj，<code>obj-&gt;_name</code> 是在 obj 所在的内存中从 obj 的地址开始向下查找成员变量 _name，而 obj 所在的内存（栈区）向下找到的是 cls 下面的指针 self（ViewController 实例对象），所以最终的打印结果是 <code>&lt;ViewController: 0x7fd88fb0a400&gt;</code>。</li>
</ul>
<h1 id="Runtime-API"><a href="#Runtime-API" class="headerlink" title="Runtime API"></a>Runtime API</h1><h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><table>
<thead>
<tr>
<th>方法</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</code></td>
<td>动态创建一个类（参数：父类，类名，额外的内存空间）</td>
</tr>
<tr>
<td><code>void objc_registerClassPair(Class cls)</code></td>
<td>注册一个类（要在类注册之前添加成员变量）</td>
</tr>
<tr>
<td><code>void objc_disposeClassPair(Class cls)</code></td>
<td>销毁一个类</td>
</tr>
<tr>
<td><code>Class object_getClass(id obj)</code></td>
<td>获取 isa 指向的 Class</td>
</tr>
<tr>
<td><code>Class object_setClass(id obj, Class cls)</code></td>
<td>设置 isa 指向的 Class</td>
</tr>
<tr>
<td><code>BOOL object_isClass(id obj)</code></td>
<td>判断一个 OC 对象是否为 Class</td>
</tr>
<tr>
<td><code>BOOL class_isMetaClass(Class cls)</code></td>
<td>判断一个 Class 是否为元类</td>
</tr>
<tr>
<td><code>Class class_getSuperclass(Class cls)</code></td>
<td>获取父类</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态创建一个类，注册一个类"</span>);</div><div class="line">        Class Teacher = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">"Teacher"</span>, <span class="number">0</span>); <span class="comment">//创建类对象和元类对象</span></div><div class="line">        objc_registerClassPair(Teacher); <span class="comment">//注册类</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Teacher 的内存大小%zd个字节"</span>, class_getInstanceSize(Teacher)); <span class="comment">//8个字节</span></div><div class="line">        </div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获取 isa 指向的 Class"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"类对象：%p，类对象：%p"</span>, [Person <span class="keyword">class</span>], object_getClass(person));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"类对象：%p，元类对象：%p"</span>, [Person <span class="keyword">class</span>], object_getClass([Person <span class="keyword">class</span>]));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//设置 isa 指向的 Class"</span>);</div><div class="line">        object_setClass(person, [Student <span class="keyword">class</span>]);</div><div class="line">        [person run]; <span class="comment">//这里的 Person 是 (Student *) 类型，isa 指向 Student 类对象</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//判断一个 OC 对象是否为 Class"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d %d"</span>, object_isClass(person), object_isClass([Person <span class="keyword">class</span>]), object_isClass(object_getClass([Person <span class="keyword">class</span>]))); <span class="comment">//元类对象是一种特殊的类对象</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//判断一个 Class 是否为元类"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d %d"</span>, class_isMetaClass([Person <span class="keyword">class</span>]), class_isMetaClass(object_getClass([Person <span class="keyword">class</span>]))); <span class="comment">//元类对象是一种特殊的类对象</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获取父类"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@类对象：%p, %@元类对象：%p"</span>, class_getSuperclass([Person <span class="keyword">class</span>]), class_getSuperclass([Person <span class="keyword">class</span>]),</div><div class="line">            class_getSuperclass(object_getClass([Person <span class="keyword">class</span>])), class_getSuperclass(object_getClass([Person <span class="keyword">class</span>])));</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//销毁一个类"</span>);</div><div class="line">        <span class="keyword">id</span> teacher2 = [[Teacher alloc] init];</div><div class="line">        <span class="comment">//    person = nil; </span></div><div class="line">        <span class="comment">//    teacher = nil; </span></div><div class="line">        teacher2 = <span class="literal">nil</span>; <span class="comment">//实例中只要有一个置为 nil，就可以调用了！❓</span></div><div class="line">        objc_disposeClassPair(Teacher); <span class="comment">//当类或者它的子类的实例还存在，则不能调用 objc_disposeClassPair 方法</span></div><div class="line">        objc_disposeClassPair(Teacher); <span class="comment">//报错“Attempt to use unknown class 0x1030b92a0.”</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>动态创建一个类，注册一个类</span></div><div class="line"><span class="ruby">Teacher 的内存大小<span class="number">8</span>个字节</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>获取 isa 指向的 Class</span></div><div class="line"><span class="ruby">类对象：<span class="number">0x100003228</span>，类对象：<span class="number">0x100003228</span></span></div><div class="line"><span class="ruby">类对象：<span class="number">0x100003228</span>，元类对象：<span class="number">0x100003200</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>设置 isa 指向的 Class</span></div><div class="line"><span class="ruby">-[Student run]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>判断一个 OC 对象是否为 Class</span></div><div class="line"><span class="ruby"><span class="number">0</span> <span class="number">1</span> <span class="number">1</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>判断一个 Class 是否为元类</span></div><div class="line"><span class="ruby"><span class="number">0</span> <span class="number">1</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>获取父类</span></div><div class="line"><span class="ruby">NSObject类对象：<span class="number">0x7fff94b06118</span>, NSObject元类对象：<span class="number">0x7fff94b060f0</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>销毁一个类</span></div><div class="line"><span class="ruby">objc[<span class="number">15858</span>]: Attempt to use unknown <span class="class"><span class="keyword">class</span> 0<span class="title">x102905440</span>.</span></span></div></pre></td></tr></table></figure></p>
<h2 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h2><table>
<thead>
<tr>
<th>方法</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Ivar class_getInstanceVariable(Class cls, const char *name)</code></td>
<td>获取一个实例变量信息</td>
</tr>
<tr>
<td><code>Ivar *class_copyIvarList(Class cls, unsigned int *outCount)</code></td>
<td>拷贝实例变量列表（最后需要调用free释放）</td>
</tr>
<tr>
<td><code>void object_setIvar(id obj, Ivar ivar, id value)</code></td>
<td>设置成员变量的值</td>
</tr>
<tr>
<td><code>id object_getIvar(id obj, Ivar ivar)</code></td>
<td>获取成员变量的值</td>
</tr>
<tr>
<td><code>BOOL class_addIvar(Class cls, const char * name, size_t size, uint8_t alignment, const char * types)</code></td>
<td>动态添加成员变量（已经注册的类是不能动态添加成员变量的）</td>
</tr>
<tr>
<td><code>const char *ivar_getName(Ivar v)</code></td>
<td>获取成员变量的名字</td>
</tr>
<tr>
<td><code>const char *ivar_getTypeEncoding(Ivar v)</code></td>
<td>获取成员变量的类型编码</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态添加成员变量（已经注册的类是不能动态添加成员变量的）"</span>);</div><div class="line">        Class Teacher = objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], <span class="string">"Teacher"</span>, <span class="number">0</span>); <span class="comment">//动态创建一个类（包括类对象和元类对象，参数：父类，类名，额外的内存空间）</span></div><div class="line">        </div><div class="line">        class_addIvar(Teacher, <span class="string">"_age"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="keyword">@encode</span>(<span class="keyword">int</span>)); <span class="comment">//在类注册之前添加成员变量（因为类的成员变量列表是只读的，所有类一旦注册后就不能修改成员变量列表了）</span></div><div class="line">        class_addIvar(Teacher, <span class="string">"_weight"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="keyword">@encode</span>(<span class="keyword">int</span>));</div><div class="line"></div><div class="line">        <span class="comment">//添加方法是随时可以操作的，最好是写在注册类前，逻辑比较清晰</span></div><div class="line">        class_addMethod(Teacher, <span class="keyword">@selector</span>(run), (IMP)run, <span class="string">"v@:"</span>);</div><div class="line">        </div><div class="line">        objc_registerClassPair(Teacher); <span class="comment">//注册类</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>, class_getInstanceSize(Teacher)); <span class="comment">//isa(8个字节) + _age(4个字节) + _weight(4个字节) = 16个字节</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//修改/获取成员变量的值"</span>);</div><div class="line">        <span class="keyword">id</span> teacher = [[Teacher alloc] init];</div><div class="line">        [teacher setValue:@<span class="number">10</span> forKey:<span class="string">@"_age"</span>];</div><div class="line">        [teacher setValue:@<span class="number">20</span> forKey:<span class="string">@"_weight"</span>];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"_age：%@, _weight：%@"</span>, [teacher valueForKey:<span class="string">@"_age"</span>], [teacher valueForKey:<span class="string">@"_weight"</span>]);</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//调用添加的方法"</span>);</div><div class="line">        [teacher run];</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//设置 isa 指向的 Class"</span>);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        object_setClass(person, Teacher);</div><div class="line">        [person run];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获取成员变量的相关信息"</span>);</div><div class="line">        Ivar ageIvar = class_getInstanceVariable([Person <span class="keyword">class</span>], <span class="string">"_age"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, ivar_getName(ageIvar), ivar_getTypeEncoding(ageIvar));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//设置和获取成员变量的值"</span>);</div><div class="line">        Ivar nameIvar = class_getInstanceVariable([Person <span class="keyword">class</span>], <span class="string">"_name"</span>);</div><div class="line">        Person *person2 = [[Person alloc] init];</div><div class="line">        object_setIvar(person2, nameIvar, <span class="string">@"name"</span>); <span class="comment">//设置 _name</span></div><div class="line">        object_setIvar(person2, ageIvar, (__bridge <span class="keyword">id</span>)(<span class="keyword">void</span> *)<span class="number">10</span>); <span class="comment">//设置 _age（使用 runtime 方法，底层没有转换直接赋值，先转成指针变量，再转成 id 类型的对象）</span></div><div class="line">        <span class="comment">//[person2 setValue:@10 forKey:@"age"]; //NSNumber 类型的 10 在赋值给 age 时会转成 int 类型</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, object_getIvar(person2, nameIvar)); <span class="comment">//获取 _name</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//拷贝实例变量列表（最后需要调用free释放）+ 获取成员变量的相关信息"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        Ivar *ivars = class_copyIvarList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            Ivar ivar = ivars[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, ivar_getName(ivar), ivar_getTypeEncoding(ivar));</div><div class="line">        &#125;</div><div class="line">        free(ivars);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在使用 <code>object_setIvar()</code> 方法设置 int 类型的成员变量时，因为数值不能直接转为对象，所以先将数值转成指针（指针是用来存值的），再将指针转成 id 类型的对象。</p>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>动态添加成员变量（已经注册的类是不能动态添加成员变量的）</span></div><div class="line"><span class="ruby"><span class="number">16</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>修改/获取成员变量的值</span></div><div class="line"><span class="ruby">_age：<span class="number">10</span>, _weight：<span class="number">20</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>调用添加的方法</span></div><div class="line"><span class="ruby">&lt;<span class="symbol">Teacher:</span> <span class="number">0x100525bc0</span>&gt; - run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>设置 isa 指向的 Class</span></div><div class="line"><span class="ruby">&lt;<span class="symbol">Teacher:</span> <span class="number">0x10041dda0</span>&gt; - run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>获取成员变量的相关信息</span></div><div class="line"><span class="ruby">_age i</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>设置和获取成员变量的值</span></div><div class="line"><span class="ruby">name <span class="number">10</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>拷贝实例变量列表（最后需要调用free释放）+ 获取成员变量的相关信息</span></div><div class="line"><span class="ruby">_age i</span></div><div class="line"><span class="ruby">_name @<span class="string">"NSString"</span></span></div></pre></td></tr></table></figure></p>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><table>
<thead>
<tr>
<th>方法</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>objc_property_t class_getProperty(Class cls, const char *name)</code></td>
<td>获取一个属性</td>
</tr>
<tr>
<td><code>objc_property_t *class_copyPropertyList(Class cls, unsigned int *outCount)</code></td>
<td>拷贝属性列表</td>
</tr>
<tr>
<td><code>BOOL class_addProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</code></td>
<td>动态添加属性</td>
</tr>
<tr>
<td><code>void class_replaceProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</code></td>
<td>动态替换属性</td>
</tr>
<tr>
<td><code>const char *property_getName(objc_property_t property)</code></td>
<td>获取属性名</td>
</tr>
<tr>
<td><code>const char *property_getAttributes(objc_property_t property)</code></td>
<td>获取属性的真实类型</td>
</tr>
</tbody>
</table>
<p><code>test3()</code> 实现：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获取一个属性"</span>);</div><div class="line">        objc_property_t name = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, property_getName(name));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//拷贝属性列表"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        objc_property_t *propertys = class_copyPropertyList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            objc_property_t property = propertys[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(property), property_getAttributes(property));<span class="comment">//T 后面是该属性的数据类型。V 后面是该属性的变量名称。N 是属性的非原子属性 nonatomic 的标识。C 是属性的 copy 标识。</span></div><div class="line">        &#125;</div><div class="line">        free(propertys);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态添加属性"</span>);</div><div class="line">        objc_property_attribute_t type = &#123; <span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;; <span class="comment">//数据类型</span></div><div class="line">        objc_property_attribute_t ownership1 = &#123; <span class="string">"C"</span>, <span class="string">""</span>&#125;; <span class="comment">//copy</span></div><div class="line">        objc_property_attribute_t ownership2 = &#123; <span class="string">"N"</span>, <span class="string">""</span>&#125;; <span class="comment">//nonatomic</span></div><div class="line">        objc_property_attribute_t backingivar = &#123; <span class="string">"V"</span>, <span class="string">"_newName"</span>&#125;; <span class="comment">//_newName</span></div><div class="line">        objc_property_attribute_t attrs[] = &#123;type, ownership1, ownership2, backingivar&#125;;</div><div class="line">        class_addProperty([Person <span class="keyword">class</span>], <span class="string">"newName"</span>, attrs, <span class="number">4</span>);</div><div class="line">        objc_property_t newName = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"newName"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(newName), property_getAttributes(newName));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态替换属性"</span>);</div><div class="line">        objc_property_attribute_t type1 = &#123; <span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;; <span class="comment">//数据类型</span></div><div class="line">        objc_property_attribute_t ownership3 = &#123; <span class="string">"C"</span>, <span class="string">""</span>&#125;; <span class="comment">//copy</span></div><div class="line">        objc_property_attribute_t ownership4 = &#123; <span class="string">"N"</span>, <span class="string">""</span>&#125;; <span class="comment">//nonatomic</span></div><div class="line">        objc_property_attribute_t backingivar1 = &#123; <span class="string">"V"</span>, <span class="string">"_replaceName"</span>&#125;; <span class="comment">//_newName</span></div><div class="line">        objc_property_attribute_t attrs1[] = &#123;type1, ownership3, ownership4, backingivar1&#125;;</div><div class="line">        class_replaceProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>, attrs1, <span class="number">4</span>);</div><div class="line">        objc_property_t replaceName = class_getProperty([Person <span class="keyword">class</span>], <span class="string">"name"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(replaceName), property_getAttributes(replaceName));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//拷贝属性列表"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count1;</div><div class="line">        objc_property_t *propertys1 = class_copyPropertyList([Person <span class="keyword">class</span>], &amp;count1);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count1; i++) &#123;</div><div class="line">            objc_property_t property = propertys1[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%s %s"</span>, property_getName(property), property_getAttributes(property));<span class="comment">//T 后面是该属性的数据类型。V 后面是该属性的变量名称。N 是属性的非原子属性 nonatomic 的标识。C 是属性的 copy 标识。</span></div><div class="line">        &#125;</div><div class="line">        free(propertys1);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">---------------------------------------//获取一个属性</div><div class="line">name</div><div class="line">---------------------------------------//拷贝属性列表</div><div class="line">ID Ti,<span class="built_in">N</span>,V_ID</div><div class="line">age Ti,<span class="built_in">N</span>,V_age</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_name</div><div class="line">---------------------------------------//动态添加属性</div><div class="line">newName <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_newName</div><div class="line">---------------------------------------//动态替换属性</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_replaceName</div><div class="line">---------------------------------------//拷贝属性列表</div><div class="line">newName <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_newName</div><div class="line">ID Ti,<span class="built_in">N</span>,V_ID</div><div class="line">age Ti,<span class="built_in">N</span>,V_age</div><div class="line">name <span class="built_in">T</span>@<span class="string">"NSString"</span>,C,<span class="built_in">N</span>,V_replaceName</div></pre></td></tr></table></figure></p>
<p>T 后面是该属性的数据类型。V 后面是该属性的变量名称。N 是属性的非原子属性 nonatomic 的标识。C 是属性的 copy 标识。</p>
<p>关于 <code>property_getAttributes()</code> 获取到的结果，可以参考 <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html#//apple_ref/doc/uid/TP40008048-CH101-SW1" target="_blank" rel="external">Declared Properties</a>。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime38.png" alt="Runtime38"></p>
<p><img src="/2020/06/12/OC底层/原理/Runtime/Runtime39.png" alt="Runtime39"></p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><table>
<thead>
<tr>
<th>方法</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Method class_getInstanceMethod(Class cls, SEL name)</code></td>
<td>获得一个实例方法</td>
</tr>
<tr>
<td><code>Method class_getClassMethod(Class cls, SEL name)</code></td>
<td>获得一个类方法</td>
</tr>
<tr>
<td><code>IMP class_getMethodImplementation(Class cls, SEL name)</code></td>
<td>根据 Class 和 SEL 获取方法的 imp 指针</td>
</tr>
<tr>
<td><code>IMP method_setImplementation(Method m, IMP imp)</code></td>
<td>修改方法的 imp 指针</td>
</tr>
<tr>
<td><code>void method_exchangeImplementations(Method m1, Method m2)</code></td>
<td>交换方法的 imp 指针</td>
</tr>
<tr>
<td><code>Method *class_copyMethodList(Class cls, unsigned int *outCount)</code></td>
<td>拷贝方法列表（最后需要调用free释放）</td>
</tr>
<tr>
<td><code>BOOL class_addMethod(Class cls, SEL name, IMP imp, const char *types)</code></td>
<td>动态添加方法</td>
</tr>
<tr>
<td><code>IMP class_replaceMethod(Class cls, SEL name, IMP imp, const char *types)</code></td>
<td>动态替换方法</td>
</tr>
<tr>
<td><code>SEL method_getName(Method m)</code></td>
<td>获取方法名</td>
</tr>
<tr>
<td><code>IMP method_getImplementation(Method m)</code></td>
<td>根据 Method 获取方法的 imp 指针</td>
</tr>
<tr>
<td><code>const char *method_getTypeEncoding(Method m)</code></td>
<td>获取方法的类型编码</td>
</tr>
<tr>
<td><code>unsigned int method_getNumberOfArguments(Method m)</code></td>
<td>根据 Method 获取方法的参数个数</td>
</tr>
<tr>
<td><code>char *method_copyReturnType(Method m)</code></td>
<td>根据 Method 获取方法的返回值的类型编码（带有copy的需要调用free去释放）</td>
</tr>
<tr>
<td><code>char *method_copyArgumentType(Method m, unsigned int index)</code></td>
<td>根据 Method 获取方法的索引位置的参数的类型编码（带有copy的需要调用free去释放）</td>
</tr>
<tr>
<td><code>const char *sel_getName(SEL sel)</code></td>
<td>根据 SEL 获取方法的名称</td>
</tr>
<tr>
<td><code>SEL sel_registerName(const char *str)</code></td>
<td>根据方法名注册 SEL</td>
</tr>
<tr>
<td><code>IMP imp_implementationWithBlock(id block)</code></td>
<td>用 block 作为方法实现</td>
</tr>
<tr>
<td><code>id imp_getBlock(IMP anImp)</code></td>
<td>根据 block 的 IMP 生成 block 对象</td>
</tr>
<tr>
<td><code>BOOL imp_removeBlock(IMP anImp)</code></td>
<td>移除 imp_implementationWithBlock() 生成的 IMP</td>
</tr>
</tbody>
</table>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">+ (<span class="keyword">void</span>)personRun;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line">- (<span class="keyword">void</span>)test;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run2;</div><div class="line">- (<span class="keyword">void</span>)test2;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run3;</div><div class="line">- (<span class="keyword">void</span>)test3;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)run4:(<span class="keyword">int</span>)age name:(<span class="built_in">NSString</span> *)name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">+ (<span class="keyword">void</span>)personRun</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run2</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test2</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)run3</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)test3</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">int</span>)run4:(<span class="keyword">int</span>)age name:(<span class="built_in">NSString</span> *)name</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">    <span class="keyword">return</span> <span class="number">10</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> newRun()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"newRun"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> newTest()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"newTest"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^Block)(<span class="keyword">void</span>);</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获得一个实例方法"</span>);</div><div class="line">        Method runMethod = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(runMethod)));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//获得一个类方法"</span>);</div><div class="line">        Method personRunMethod = class_getClassMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(personRun));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(personRunMethod)));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Class 和 SEL 获取方法的 imp 指针"</span>);</div><div class="line">        IMP runIMP = class_getMethodImplementation([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, runIMP);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//修改方法的 imp 指针"</span>);</div><div class="line">        IMP testIMP = class_getMethodImplementation([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test));</div><div class="line">        method_setImplementation(runMethod, testIMP);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person run]; <span class="comment">//调用 -test</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//交换方法的 imp 指针"</span>);</div><div class="line">        Method run2Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run2));</div><div class="line">        Method testMethod = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test2));</div><div class="line">        method_exchangeImplementations(runMethod, testMethod);</div><div class="line">        [person run2];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态添加方法"</span>);</div><div class="line">        class_addMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(newRun), (IMP)newRun, <span class="string">"v@:"</span>);</div><div class="line">        [person performSelector:<span class="keyword">@selector</span>(newRun)];</div><div class="line"></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//拷贝方法列表（最后需要调用free释放）"</span>);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">        Method *methods = class_copyMethodList([Person <span class="keyword">class</span>], &amp;count);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">            Method aMethod = methods[i];</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(method_getName(aMethod)));</div><div class="line">        &#125;</div><div class="line">        free(methods);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//动态替换方法"</span>);</div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(test3), (IMP)newTest, <span class="string">"v@:"</span>);</div><div class="line">        [person test3];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Method 获取方法的 imp 指针"</span>);</div><div class="line">        Method run3Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run3));</div><div class="line">        IMP runIMP3 = method_getImplementation(run3Method);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%p"</span>, runIMP3);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Method 获取方法的类型编码"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, method_getTypeEncoding(run3Method));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Method 获取方法的参数个数"</span>);</div><div class="line">        Method run4Method = class_getInstanceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run4:name:));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>, method_getNumberOfArguments(run4Method)); <span class="comment">//self、_cmd、age 和 name</span></div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Method 获取方法的返回值的类型编码"</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *returnType = method_copyReturnType(run4Method);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:returnType encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        free((<span class="keyword">void</span> *)returnType);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 Method 获取方法的索引位置的参数的类型编码"</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *argumentType = method_copyArgumentType(run4Method, <span class="number">3</span>); <span class="comment">//name：@</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:argumentType encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        free((<span class="keyword">void</span> *)argumentType);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 SEL 获取方法名"</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(<span class="keyword">@selector</span>(run));</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [[<span class="built_in">NSString</span> alloc] initWithCString:selName encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据方法名注册 SEL"</span>);</div><div class="line">        SEL registerSel = sel_registerName(<span class="string">"registerSel"</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSStringFromSelector</span>(registerSel));</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//用 block 作为方法实现"</span>);</div><div class="line">        IMP blockImp = imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;);</div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), blockImp, <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//根据 block 的 IMP 生成 block 对象"</span>);</div><div class="line">        Block aBlock = imp_getBlock(blockImp);</div><div class="line">        aBlock();</div><div class="line">        </div><div class="line">        </div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"---------------------------------------//移除 imp_implementationWithBlock() 生成的 IMP"</span>);</div><div class="line">        <span class="built_in">BOOL</span> isRemvoeBlockImpSucc = imp_removeBlock(blockImp);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"isRemvoeBlockImpSucc：%d"</span>, isRemvoeBlockImpSucc);</div><div class="line">        Block aBlock2 = imp_getBlock(blockImp); <span class="comment">//blockImp 已经不存在</span></div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"aBlock2：%@"</span>, aBlock2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">--------------------------------------<span class="regexp">//</span>获得一个实例方法</span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>获得一个类方法</span></div><div class="line"><span class="ruby">personRun</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Class 和 SEL 获取方法的 imp 指针</span></div><div class="line"><span class="ruby"><span class="number">0x100001ad0</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>修改方法的 imp 指针</span></div><div class="line"><span class="ruby">-[Person test]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>交换方法的 imp 指针</span></div><div class="line"><span class="ruby">-[Person run2]</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>动态添加方法</span></div><div class="line"><span class="ruby">newRun</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>拷贝方法列表（最后需要调用free释放）</span></div><div class="line"><span class="ruby">newRun</span></div><div class="line"><span class="ruby">run2</span></div><div class="line"><span class="ruby">test2</span></div><div class="line"><span class="ruby">run3</span></div><div class="line"><span class="ruby">test3</span></div><div class="line"><span class="ruby"><span class="symbol">run4:</span><span class="symbol">name:</span></span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">test</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>动态替换方法</span></div><div class="line"><span class="ruby">newTest</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Method 获取方法的 imp 指针</span></div><div class="line"><span class="ruby"><span class="number">0x100001b90</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Method 获取方法的类型编码</span></div><div class="line"><span class="ruby">v16@0<span class="symbol">:</span><span class="number">8</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Method 获取方法的参数个数</span></div><div class="line"><span class="ruby"><span class="number">4</span></span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Method 获取方法的返回值的类型编码</span></div><div class="line"><span class="ruby">i</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 Method 获取方法的索引位置的参数的类型编码</span></div><div class="line"><span class="ruby">@</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 SEL 获取方法名</span></div><div class="line"><span class="ruby">run</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据方法名注册 SEL</span></div><div class="line"><span class="ruby">registerSel</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>用 block 作为方法实现</span></div><div class="line"><span class="ruby">this is a block</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>根据 block 的 IMP 生成 block 对象</span></div><div class="line"><span class="ruby">this is a block</span></div><div class="line"><span class="ruby">---------------------------------------<span class="regexp">//</span>移除 imp_implementationWithBlock() 生成的 IMP</span></div><div class="line"><span class="ruby">isRemvoeBlockImpSucc：<span class="number">1</span></span></div><div class="line"><span class="ruby">aBlock2：(null)</span></div></pre></td></tr></table></figure></p>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><h3 id="class-rw-ext-t"><a href="#class-rw-ext-t" class="headerlink" title="class_rw_ext_t"></a>class_rw_ext_t</h3><p><code>class_rw_ext_t</code> 里保存着 <code>class_rw_t</code> 的方法列表、属性列表、协议列表和 <code>class_ro_t</code> 等信息。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_ext_t</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</div><div class="line">    <span class="keyword">method_array_t</span> methods;</div><div class="line">    <span class="keyword">property_array_t</span> properties;</div><div class="line">    <span class="keyword">protocol_array_t</span> protocols;</div><div class="line">    <span class="keyword">char</span> *demangledName;</div><div class="line">    <span class="keyword">uint32_t</span> version;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></div><div class="line">    ......<span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">class_rw_ext_t</span> *ext() <span class="keyword">const</span> &#123;</div><div class="line">        <span class="keyword">return</span> get_ro_or_rwe().dyn_cast&lt;<span class="keyword">class_rw_ext_t</span> *&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">class_rw_ext_t</span> *extAllocIfNeeded() &#123;</div><div class="line">        <span class="keyword">auto</span> v = get_ro_or_rwe();</div><div class="line">        <span class="keyword">if</span> (fastpath(v.is&lt;<span class="keyword">class_rw_ext_t</span> *&gt;())) &#123;</div><div class="line">            <span class="keyword">return</span> v.get&lt;<span class="keyword">class_rw_ext_t</span> *&gt;();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> extAlloc(v.get&lt;<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *&gt;());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">class_rw_ext_t</span> *deepCopy(<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro) &#123;</div><div class="line">        <span class="keyword">return</span> extAlloc(ro, <span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ......<span class="comment">//省略</span></div></pre></td></tr></table></figure></p>
<h3 id="动态添加的属性存到哪了"><a href="#动态添加的属性存到哪了" class="headerlink" title="动态添加的属性存到哪了?"></a>动态添加的属性存到哪了?</h3><p>查看 <code>class_addProperty()</code> 的实现<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">BOOL </div><div class="line">class_addProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                  <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> _class_addProperty(cls, name, attrs, n, NO);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> </div><div class="line">class_replaceProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                      <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> n)</div><div class="line">&#123;</div><div class="line">    _class_addProperty(cls, name, attrs, n, YES);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">bool</span> </div><div class="line">_class_addProperty(Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, </div><div class="line">                   <span class="keyword">const</span> <span class="keyword">objc_property_attribute_t</span> *attrs, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, </div><div class="line">                   <span class="keyword">bool</span> replace)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> NO;</div><div class="line">    <span class="keyword">if</span> (!name) <span class="keyword">return</span> NO;</div><div class="line"></div><div class="line">    <span class="keyword">property_t</span> *prop = class_getProperty(cls, name);</div><div class="line">    <span class="keyword">if</span> (prop  &amp;&amp;  !replace) &#123; <span class="comment">//已经存在 &amp; 替换</span></div><div class="line">        <span class="comment">// already exists, refuse to replace</span></div><div class="line">        <span class="keyword">return</span> NO;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (prop) &#123; <span class="comment">//已经存在</span></div><div class="line">        <span class="comment">// replace existing</span></div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</div><div class="line">        try_free(prop-&gt;attributes);</div><div class="line">        prop-&gt;attributes = copyPropertyAttributeString(attrs, count);</div><div class="line">        <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">mutex_locker_t</span> lock(runtimeLock); </div><div class="line">        <span class="keyword">auto</span> rwe = cls-&gt;data()-&gt;extAllocIfNeeded(); <span class="comment">//class_rw_ext_t</span></div><div class="line">        </div><div class="line">        ASSERT(cls-&gt;isRealized());</div><div class="line">        </div><div class="line">        <span class="keyword">property_list_t</span> *proplist = (<span class="keyword">property_list_t</span> *)</div><div class="line">            <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*proplist));</div><div class="line">        proplist-&gt;count = <span class="number">1</span>;</div><div class="line">        proplist-&gt;entsizeAndFlags = <span class="keyword">sizeof</span>(proplist-&gt;first);</div><div class="line">        proplist-&gt;first.name = strdupIfMutable(name);</div><div class="line">        proplist-&gt;first.attributes = copyPropertyAttributeString(attrs, count);</div><div class="line">        </div><div class="line">        rwe-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>); <span class="comment">//保存到 class_rw_ext_t 的 properties 里</span></div><div class="line">        </div><div class="line">        <span class="keyword">return</span> YES;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看 <code>class_addProperty()</code> 的 Runtime 实现可以看到，<code>class_addProperty()</code> 方法内部调用的是 <code>_class_addProperty()</code> 方法。<code>_class_addProperty()</code> 方法内部先判断了方法是否已经存在，又判断了是否要替换。如果即不存在也不替换，就保存到 <code>class_rw_ext_t</code> 的 properties 里，即类对象的属性列表里。（class_rw_ext_t：class_read_write_extension_table，即 class_rw_t 的拓展表）。</p>
<h4 id="动态添加的方法存到哪了"><a href="#动态添加的方法存到哪了" class="headerlink" title="动态添加的方法存到哪了?"></a>动态添加的方法存到哪了?</h4><p>查看 <code>class_addMethod()</code> 的实现<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">BOOL </div><div class="line">class_addMethod(Class cls, SEL <span class="keyword">name</span>, IMP imp, const char *types)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!cls) return NO;</div><div class="line"></div><div class="line">    mutex_locker_t lock(runtimeLock);</div><div class="line">    return ! addMethod(cls, <span class="keyword">name</span>, imp, types ?: <span class="string">""</span>, NO);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static IMP </div><div class="line">addMethod(Class cls, SEL <span class="keyword">name</span>, IMP imp, const char *types, bool replace)</div><div class="line">&#123;</div><div class="line">    IMP result = <span class="literal">nil</span>;</div><div class="line"></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"></div><div class="line">    checkIsKnownClass(cls);</div><div class="line">    </div><div class="line">    ASSERT(types);</div><div class="line">    ASSERT(<span class="function"><span class="title">cls</span>-&gt;</span>isRealized());</div><div class="line"></div><div class="line">    method_t *m;</div><div class="line">    <span class="keyword">if</span> ((m = getMethodNoSuper_nolock(cls, <span class="keyword">name</span>))) &#123; <span class="comment">//是否存在</span></div><div class="line">        <span class="comment">// already exists</span></div><div class="line">        <span class="keyword">if</span> (!replace) &#123; <span class="comment">//是否替换</span></div><div class="line">            <span class="function"><span class="title">result</span> = m-&gt;</span>imp;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            result = _method_setImplementation(cls, m, imp);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="function"><span class="title">auto</span> rwe = cls-&gt;</span><span class="function"><span class="title">data</span>()-&gt;</span>extAllocIfNeeded(); <span class="comment">//class_rw_ext_t</span></div><div class="line"></div><div class="line">        <span class="comment">// fixme optimize</span></div><div class="line">        method_list_t *newlist;</div><div class="line">        newlist = (method_list_t *)calloc(sizeof(*newlist), <span class="number">1</span>);</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>entsizeAndFlags = </div><div class="line">            (uint32_t)sizeof(method_t) | fixed_up_method_list;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>count = <span class="number">1</span>;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.<span class="keyword">name</span> = <span class="keyword">name</span>;</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.types = strdupIfMutable(types);</div><div class="line">        <span class="function"><span class="title">newlist</span>-&gt;</span>first.imp = imp;</div><div class="line"></div><div class="line">        prepareMethodLists(cls, &amp;newlist, <span class="number">1</span>, NO, NO);</div><div class="line">        <span class="function"><span class="title">rwe</span>-&gt;</span>methods.attachLists(&amp;newlist, <span class="number">1</span>); <span class="comment">//保存到 class_rw_ext_t 的 methods 里</span></div><div class="line">        flushCaches(cls);</div><div class="line"></div><div class="line">        result = <span class="literal">nil</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看 <code>class_addMethod()</code> 的 Runtime 实现可以看到 <code>class_addMethod()</code> 方法内部调用的是 <code>addMethod()</code> 方法。<code>addMethod()</code> 方法内部先判断了方法是否已经存在，又判断了是否要替换。如果即不存，就保存到 <code>class_rw_ext_t</code> 的 methods 里，即类对象的方法列表里。（class_rw_ext_t：class_read_write_extension_table，即 class_rw_t 的拓展表）。</p>
<h3 id="method-exchangeImplementations-的实现原理"><a href="#method-exchangeImplementations-的实现原理" class="headerlink" title="method_exchangeImplementations 的实现原理"></a>method_exchangeImplementations 的实现原理</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">method_exchangeImplementations</span><span class="params">(Method m1, Method m2)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">if</span> (!m1  ||  !m2) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">mutex_locker_t</span> lock(runtimeLock);</div><div class="line"></div><div class="line">    IMP m1_imp = m1-&gt;imp;</div><div class="line">    m1-&gt;imp = m2-&gt;imp;</div><div class="line">    m2-&gt;imp = m1_imp;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// RR/AWZ updates are slow because class is unknown</span></div><div class="line">    <span class="comment">// Cache updates are slow because class is unknown</span></div><div class="line">    <span class="comment">// fixme build list of classes whose Methods are known externally?</span></div><div class="line"></div><div class="line">    flushCaches(nil); <span class="comment">//清空方法缓存</span></div><div class="line"></div><div class="line">    adjustCustomFlagsForMethodChange(nil, m1);</div><div class="line">    adjustCustomFlagsForMethodChange(nil, m2);</div><div class="line">&#125;</div><div class="line"></div><div class="line">......<span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">flushCaches</span><span class="params">(Class cls)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    <span class="keyword">mutex_locker_t</span> lock(cacheUpdateLock);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (cls) &#123;</div><div class="line">        foreach_realized_class_and_subclass(cls, [](Class c)&#123;</div><div class="line">            cache_erase_nolock(c);</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        foreach_realized_class_and_metaclass([](Class c)&#123;</div><div class="line">            cache_erase_nolock(c);</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">......<span class="comment">//省略</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">cache_erase_nolock</span><span class="params">(Class cls)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_USE_CACHE_LOCK</span></div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    runtimeLock.assertLocked();</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">cache_t</span> *cache = getCache(cls);</div><div class="line"></div><div class="line">    <span class="keyword">mask_t</span> capacity = cache-&gt;capacity();</div><div class="line">    <span class="keyword">if</span> (capacity &gt; <span class="number">0</span>  &amp;&amp;  cache-&gt;occupied() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">auto</span> oldBuckets = cache-&gt;buckets();</div><div class="line">        <span class="keyword">auto</span> buckets = emptyBucketsForCapacity(capacity);</div><div class="line">        cache-&gt;setBucketsAndMask(buckets, capacity - <span class="number">1</span>); <span class="comment">// also clears occupied</span></div><div class="line"></div><div class="line">        cache_collect_free(oldBuckets, capacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>method_exchangeImplementations 的底层实现是交换了两个方法的 <code>imp</code> 指针，然后调用 <code>flushCaches()</code> 方法清空了方法缓存。<br><img src="/2020/06/12/OC底层/原理/Runtime/Runtime37.png" alt="Runtime37"></p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="查看私有成员变量"><a href="#查看私有成员变量" class="headerlink" title="查看私有成员变量"></a>查看私有成员变量</h3><p>修改 UITextField 占位文字的颜色：</p>
<p>方案一：正常的 OC 代码<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span> *attrs = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    attrs[<span class="built_in">NSForegroundColorAttributeName</span>] = [<span class="built_in">UIColor</span> redColor];</div><div class="line">    <span class="keyword">self</span>.textField.attributedPlaceholder = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="string">@"请输入用户名"</span> attributes:attrs];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>方案二：使用 KVC 修改（iOS 13 后禁用）<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.textField.placeholder = <span class="string">@"请输入用户名"</span>;</div><div class="line">    <span class="built_in">UILabel</span> *placeholderLabel = [<span class="keyword">self</span>.textField valueForKeyPath:<span class="string">@"_placeholderLabel"</span>];</div><div class="line">    placeholderLabel.textColor = [<span class="built_in">UIColor</span> redColor];</div><div class="line"></div><div class="line">    <span class="comment">//简化版：[self.textField setValue:[UIColor redColor] forKeyPath:@"_placeholderLabel.textColor"];</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>报错：<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*** Terminating app due <span class="keyword">to</span> uncaught exception <span class="symbol">'NSGenericException</span>', reason: <span class="symbol">'Access</span> <span class="keyword">to</span> UITextField<span class="symbol">'s</span> _placeholderLabel ivar <span class="keyword">is</span> prohibited. This <span class="keyword">is</span> an application bug'</div></pre></td></tr></table></figure></p>
<p>方案三：使用 Runtime（还不如 OC 省事）<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *textField;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.textField.placeholder = <span class="string">@"请输入用户名"</span>;</div><div class="line">    Ivar ivar = class_getInstanceVariable([<span class="built_in">UITextField</span> <span class="keyword">class</span>], <span class="string">"_placeholderLabel"</span>);</div><div class="line">    <span class="built_in">UILabel</span> *placeholderLabel = object_getIvar(<span class="keyword">self</span>.textField, ivar);</div><div class="line">    placeholderLabel.textColor = [<span class="built_in">UIColor</span> redColor];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="字典转模型"><a href="#字典转模型" class="headerlink" title="字典转模型"></a>字典转模型</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> ID;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Teacher</span> : <span class="title">Person</span></span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> weight;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Teacher</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    <span class="keyword">id</span> obj = [[<span class="keyword">self</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:<span class="keyword">self</span> json:json];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)enumerateIvarsWithObject:(<span class="keyword">id</span>)obj <span class="keyword">class</span>:(Class)<span class="keyword">class</span> json:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    Class superclass = [<span class="keyword">class</span> superclass];</div><div class="line">    <span class="keyword">if</span> (superclass &amp;&amp; superclass != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123; <span class="comment">//处理继承</span></div><div class="line">        [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:superclass json:json];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">class</span>, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        Ivar ivar = ivars[i]; <span class="comment">//取出 i 位置的成员变量</span></div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)]; <span class="comment">//去掉“_”</span></div><div class="line">        <span class="keyword">id</span> value = json[name]; <span class="comment">//设置</span></div><div class="line">        <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"ID"</span>]) &#123; <span class="comment">//处理特殊数据</span></div><div class="line">            value = json[<span class="string">@"id"</span>];</div><div class="line">        &#125;</div><div class="line">        [obj setValue:value forKey:name];</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *json = @&#123;</div><div class="line">            <span class="string">@"id"</span> : @<span class="number">10</span>,</div><div class="line">            <span class="string">@"age"</span> : @<span class="number">20</span>,</div><div class="line">            <span class="string">@"weight"</span> : @<span class="number">60</span>,</div><div class="line">            <span class="string">@"height"</span> : @<span class="number">160</span>,</div><div class="line">            <span class="string">@"name"</span> : <span class="string">@"Tom"</span></div><div class="line">        &#125;;</div><div class="line">        Teacher *teacher = [Teacher yq_objectWithJson:json];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d, %@"</span>, teacher.ID, teacher.age, teacher.weight, teacher.height, teacher.name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">10</span>, <span class="number">20</span>, <span class="number">60</span>, <span class="number">160</span>, Tom</div></pre></td></tr></table></figure></p>
<h3 id="归档解档"><a href="#归档解档" class="headerlink" title="归档解档"></a>归档解档</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class;</div><div class="line">- (<span class="keyword">void</span>)decodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)archive;</div><div class="line">+ (<span class="keyword">instancetype</span>)unarchive;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></div><div class="line">+ (<span class="keyword">instancetype</span>)yq_objectWithJson:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    <span class="keyword">id</span> obj = [[<span class="keyword">self</span> alloc] init];</div><div class="line">    [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:<span class="keyword">self</span> json:json];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)enumerateIvarsWithObject:(<span class="keyword">id</span>)obj <span class="keyword">class</span>:(Class)<span class="keyword">class</span> json:(<span class="built_in">NSDictionary</span> *)json</div><div class="line">&#123;</div><div class="line">    Class superclass = [<span class="keyword">class</span> superclass];</div><div class="line">    <span class="keyword">if</span> (superclass &amp;&amp; superclass != [<span class="built_in">NSObject</span> <span class="keyword">class</span>]) &#123;</div><div class="line">        [<span class="keyword">self</span> enumerateIvarsWithObject:obj <span class="keyword">class</span>:superclass json:json];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">class</span>, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//取出成员变量</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="comment">//设置</span></div><div class="line">        <span class="keyword">id</span> value = json[name];</div><div class="line">        <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"ID"</span>]) &#123;</div><div class="line">            value = json[<span class="string">@"id"</span>];</div><div class="line">        &#125;</div><div class="line">        [obj setValue:value forKey:name];</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)encodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class</div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(Class, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//取出成员变量</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSString</span> *typeEncode = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getTypeEncoding(ivar)];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"i"</span>]) &#123;</div><div class="line">            <span class="keyword">int</span> value = [[<span class="keyword">self</span> valueForKey:name] intValue];</div><div class="line">            [coder encodeInt:value forKey:name];</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"@\"NSString\""</span>]) &#123;</div><div class="line">            <span class="keyword">id</span> value = [<span class="keyword">self</span> valueForKey:name];</div><div class="line">            [coder encodeObject:value forKey:name];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)decodeIvarsWithCoder:(<span class="built_in">NSCoder</span> *)coder Class:(Class)Class</div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</div><div class="line">    Ivar *ivars = class_copyIvarList(Class, &amp;count);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++) &#123;</div><div class="line">        <span class="comment">//取出成员变量</span></div><div class="line">        Ivar ivar = ivars[i];</div><div class="line">        <span class="built_in">NSString</span> *typeEncode = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getTypeEncoding(ivar)];</div><div class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</div><div class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</div><div class="line">        <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"i"</span>]) &#123;</div><div class="line">            <span class="keyword">int</span> value = [coder decodeIntForKey:name];</div><div class="line">            [<span class="keyword">self</span> setValue:@(value) forKey:name];</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([typeEncode isEqualToString:<span class="string">@"@\"NSString\""</span>]) &#123;</div><div class="line">            <span class="keyword">id</span> value = [coder decodeObjectForKey:name];</div><div class="line">            [<span class="keyword">self</span> setValue:value forKey:name];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    free(ivars);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)archive</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"obj.%@"</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])];</div><div class="line">    <span class="built_in">NSString</span> *temp = <span class="built_in">NSTemporaryDirectory</span>();</div><div class="line">    <span class="built_in">NSString</span> *filePath = [temp stringByAppendingPathComponent:name]; <span class="comment">//以类名作为保存文件的扩展名</span></div><div class="line">    [<span class="built_in">NSKeyedArchiver</span> archiveRootObject:<span class="keyword">self</span> toFile:filePath];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">instancetype</span>)unarchive</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"obj.%@"</span>, <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>)];</div><div class="line">    <span class="built_in">NSString</span> *filePath = [<span class="built_in">NSTemporaryDirectory</span>() stringByAppendingPathComponent:name];</div><div class="line">    <span class="keyword">id</span> obj = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:filePath];</div><div class="line">    <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span>&lt;<span class="title">NSCoding</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> ID;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> encodeIvarsWithCoder:coder Class:[Person <span class="keyword">class</span>]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> decodeIvarsWithCoder:coder Class:[Person <span class="keyword">class</span>]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Teacher</span> : <span class="title">Person</span>&lt;<span class="title">NSCoding</span>&gt;</span></div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> weight;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> height;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Teacher</span></span></div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">super</span> encodeWithCoder:coder];</div><div class="line">    [<span class="keyword">self</span> encodeIvarsWithCoder:coder Class:[Teacher <span class="keyword">class</span>]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:coder];</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</div><div class="line">        [<span class="keyword">self</span> decodeIvarsWithCoder:coder Class:[Teacher <span class="keyword">class</span>]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">//归档</span></div><div class="line"><span class="comment">//        NSDictionary *json = @&#123;</span></div><div class="line"><span class="comment">//            @"id" : @100,</span></div><div class="line"><span class="comment">//            @"age" : @200,</span></div><div class="line"><span class="comment">//            @"weight" : @700,</span></div><div class="line"><span class="comment">//            @"height" : @1700,</span></div><div class="line"><span class="comment">//            @"name" : @"Tom"</span></div><div class="line"><span class="comment">//        &#125;;</span></div><div class="line"><span class="comment">//        Teacher *teacher = [Teacher yq_objectWithJson:json];</span></div><div class="line"><span class="comment">//        [teacher archive];</span></div><div class="line">        <span class="comment">//解档</span></div><div class="line">        Teacher *teacher = [Teacher unarchive];</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%d, %d, %d, %d, %@"</span>, teacher.ID, teacher.age, teacher.weight, teacher.height, teacher.name);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>打印结果：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>, <span class="number">200</span>, <span class="number">700</span>, <span class="number">1700</span>, Tom</div></pre></td></tr></table></figure></p>
<h3 id="替换方法实现"><a href="#替换方法实现" class="headerlink" title="替换方法实现"></a>替换方法实现</h3><p>class_replaceMethod<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></div><div class="line">- (<span class="keyword">void</span>)run;</div><div class="line">+ (<span class="keyword">void</span>)personRun;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></div><div class="line">- (<span class="keyword">void</span>)run</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>)personRun</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> myRun()</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"---myRun"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</div><div class="line">    <span class="keyword">@autoreleasepool</span> &#123;</div><div class="line">        <span class="comment">//使用 myRun 替换类方法 +personRun，传入元类对象</span></div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), (IMP)myRun, <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        <span class="comment">//使用 block 替换类方法 +personRun</span></div><div class="line">        class_replaceMethod(object_getClass([Person <span class="keyword">class</span>]), <span class="keyword">@selector</span>(personRun), imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;), <span class="string">"v"</span>);</div><div class="line">        [Person personRun];</div><div class="line">        </div><div class="line">        <span class="comment">//使用 myRun 替换对象方法 -run，传入类对象</span></div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run), (IMP)myRun, <span class="string">"v"</span>);</div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        [person run];</div><div class="line">        <span class="comment">//使用 block 替换对象方法 -run</span></div><div class="line">        class_replaceMethod([Person <span class="keyword">class</span>], <span class="keyword">@selector</span>(run), imp_implementationWithBlock(^&#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"this is a block"</span>);</div><div class="line">        &#125;), <span class="string">"v"</span>);</div><div class="line">        [person run];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">---myRun</div><div class="line"><span class="keyword">this</span> <span class="keyword">is</span> a block</div><div class="line">---myRun</div><div class="line"><span class="keyword">this</span> <span class="keyword">is</span> a block</div></pre></td></tr></table></figure></p>
<h3 id="拦截所有按钮的点击事件"><a href="#拦截所有按钮的点击事件" class="headerlink" title="拦截所有按钮的点击事件"></a>拦截所有按钮的点击事件</h3><p>使用 method_exchangeImplementations 交换系统方法实现方法拦截：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIControl</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIControl</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Method method1 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(sendAction:to:forEvent:));</div><div class="line">        Method method2 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(yq_sendAction:to:forEvent:));</div><div class="line">        method_exchangeImplementations(method1, method2);        </div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@-%@-%@"</span>, <span class="keyword">self</span>, target, <span class="built_in">NSStringFromSelector</span>(action));</div><div class="line">    <span class="comment">//调用系统原来的实现</span></div><div class="line">    [<span class="keyword">self</span> yq_sendAction:action to:target forEvent:event];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> : <span class="title">UIViewController</span></span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">IBAction</span>)click1:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">IBAction</span>)click2:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">IBAction</span>)click3:(<span class="keyword">id</span>)sender</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%s"</span>, __func__);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<p>打印结果：<br><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ad093e0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">332</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001bd0560</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click1:</span></div><div class="line"><span class="xml">-[ViewController click1:]</span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ae0c4f0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">411</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001be5740</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click2:</span></div><div class="line"><span class="xml">-[ViewController click2:]</span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">UIButton:</span> <span class="attr">0x7f8d0ad096b0</span>; <span class="attr">frame</span> = <span class="string">(148</span> <span class="attr">492</span>; <span class="attr">46</span> <span class="attr">30</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">RM+BM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x600001bd06e0</span>&gt;</span>&gt;-<span class="tag">&lt;<span class="name">ViewController:</span> <span class="attr">0x7f8d0ac06850</span>&gt;</span>-click3:</span></div><div class="line"><span class="xml">-[ViewController click3:]</span></div></pre></td></tr></table></figure></p>
<h3 id="拦截数组添加数据方法"><a href="#拦截数组添加数据方法" class="headerlink" title="拦截数组添加数据方法"></a>拦截数组添加数据方法</h3><p>数组的 <code>addObject:</code> 和 <code>insertObject:</code> 方法调用的都是 <code>insertObject:atIndex:</code> 方法。拦截 <code>insertObject:atIndex:</code> 方法，可以解决添加空数据导致的崩溃。</p>
<p>类簇：NSData、NSArray、NSDictionary 和 NSString。它们的类并不一样，比如 NSMutableArray 的类是 <code>__NSArrayM</code>。</p>
<p>使用 method_exchangeImplementations 交换系统方法实现方法拦截：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableArray</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSArrayM"</span>);</div><div class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(insertObject:atIndex:));</div><div class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(yq_insertObject:atIndex:));</div><div class="line">        method_exchangeImplementations(method1, method2);        </div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_insertObject:(<span class="keyword">id</span>)anObject atIndex:(<span class="built_in">NSUInteger</span>)index</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (anObject == <span class="literal">nil</span>) <span class="keyword">return</span>;</div><div class="line">    [<span class="keyword">self</span> yq_insertObject:anObject atIndex:index];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *arrayM = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    <span class="built_in">NSString</span> *obj = <span class="literal">nil</span>;</div><div class="line">    [arrayM addObject:obj];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h3 id="拦截字典添加数据方法"><a href="#拦截字典添加数据方法" class="headerlink" title="拦截字典添加数据方法"></a>拦截字典添加数据方法</h3><p>字典赋值的 <code>setObject:forKey:</code> 方法最终调用的是 <code>setObject:forKeyedSubscript:</code>。拦截 <code>setObject:forKeyedSubscript:</code> 方法，可以解决添加空数据导致的崩溃。</p>
<p>使用 method_exchangeImplementations 交换系统方法实现方法拦截：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableDictionary</span> (<span class="title">Extension</span>)</span></div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableDictionary</span> (<span class="title">Extension</span>)</span></div><div class="line">+ (<span class="keyword">void</span>)load</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryM"</span>);</div><div class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(setObject:forKeyedSubscript:));</div><div class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(yq_setObject:forKeyedSubscript:));</div><div class="line">        method_exchangeImplementations(method1, method2);</div><div class="line">        </div><div class="line">        Class cls2 = <span class="built_in">NSClassFromString</span>(<span class="string">@"__NSDictionaryI"</span>);</div><div class="line">        Method method3 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(objectForKeyedSubscript:));</div><div class="line">        Method method4 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(yq_objectForKeyedSubscript:));</div><div class="line">        method_exchangeImplementations(method3, method4);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)yq_setObject:(<span class="keyword">id</span>)obj forKeyedSubscript:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!key || !obj) <span class="keyword">return</span>;</div><div class="line">    [<span class="keyword">self</span> yq_setObject:obj forKeyedSubscript:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">id</span>)yq_objectForKeyedSubscript:(<span class="keyword">id</span>)key</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> yq_objectForKeyedSubscript:key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableDictionary</span> *dictionaryM = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">    dictionaryM[obj] = obj;</div><div class="line">    <span class="built_in">NSString</span> *obj2 = dictionaryM[obj];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>讲一下 OC 的消息机制<br>OC 中的方法调用其实都是转成了 objc_msgSend 函数的调用，给 receiver（方法调用者）发送了一条消息（selector(方法名)）。<br>objc_msgSend 底层有三大阶段：  </p>
<ul>
<li>消息发送：先调在当前类的 cache 里找，再到当前类的 methods 里找。如果在当前类没有找到，再遍历父类查找，先在父类的 cache 里找，再到父类的 methods 里找。</li>
<li>动态方法解析：在当前类及其父类里没有找到方法时，会调用 <code>resolveInstanceMethod:</code> 或者 <code>resolveClassMethod:</code> 方法动态添加方法。  </li>
<li>消息转发：如果没有动态添加方法，会调用 <code>forwardingTargetForSelector:</code> 方法获取可以处理消息的对象。如果没有实现  <code>forwardingTargetForSelector:</code> 方法或者该方法返回的是 nil，会调用 <code>methodSignatureForSelector:</code> 方法获取类型编码，在获取类型编码成功后再调用 <code>forwardInvocation:</code> 方法进行自定义操作。如果没有实现 <code>methodSignatureForSelector:</code> 方法或者该方法返回的是 nil，会调用 <code>doesNotRecognizeSelector:</code> 方法终止流程。 </li>
</ul>
</li>
<li><p>消息转发机制流程<br>如果没有动态添加方法，会调用 <code>forwardingTargetForSelector:</code> 方法获取可以处理消息的对象。如果没有实现  <code>forwardingTargetForSelector:</code> 方法或者该方法返回的是 nil，会调用 <code>methodSignatureForSelector:</code> 方法获取类型编码，在获取类型编码成功后再调用 <code>forwardInvocation:</code> 方法进行自定义操作。如果没有实现 <code>methodSignatureForSelector:</code> 方法或者该方法返回的是 nil，会调用 <code>doesNotRecognizeSelector:</code> 方法终止流程。 </p>
</li>
<li><p>什么是 Runtime ？平时项目中有用过么？<br>OC 是一门动态性比较强的编程语言，允许很多操作推迟到程序运行时再进行。OC 的动态性就是由 Runtime 来支撑和实现的，Runtime 是一套 C 语言的 API，封装了很多动态性相关的函数，平时编写的OC代码，底层都是转换成了 Runtime API 进行调用。</p>
<p>具体应用<br>1、利用关联对象（AssociatedObject）给分类添加属性；<br>2、遍历类的所有成员变量（修改textfield的占位文字颜色、字典转模型、自动归档解档）；<br>3、交换方法实现（交换系统的方法）；<br>4、利用消息转发机制解决方法找不到的异常问题；<br>……</p>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/OC底层原理/" rel="tag"># OC底层原理</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/31/OC底层/原理/block/" rel="next" title="block">
                <i class="fa fa-chevron-left"></i> block
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/02/OC底层/原理/RunLoop/" rel="prev" title="RunLoop">
                RunLoop <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/myAvatar.gif"
              alt="Kevin" />
          
            <p class="site-author-name" itemprop="name">Kevin</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/KevinYangGit" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/_YangQI" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>Twitter</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#isa-详解"><span class="nav-number">1.</span> <span class="nav-text">isa 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#位运算"><span class="nav-number">1.1.</span> <span class="nav-text">位运算</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设计"><span class="nav-number">1.1.1.</span> <span class="nav-text">设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#取值"><span class="nav-number">1.1.2.</span> <span class="nav-text">取值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#掩码"><span class="nav-number">1.1.3.</span> <span class="nav-text">掩码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设值"><span class="nav-number">1.1.4.</span> <span class="nav-text">设值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#位域"><span class="nav-number">1.2.</span> <span class="nav-text">位域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#共用体（union）"><span class="nav-number">1.3.</span> <span class="nav-text">共用体（union）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#struct"><span class="nav-number">1.3.1.</span> <span class="nav-text">struct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#union"><span class="nav-number">1.3.2.</span> <span class="nav-text">union</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现"><span class="nav-number">1.3.3.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#isa"><span class="nav-number">1.4.</span> <span class="nav-text">isa</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#isa-t"><span class="nav-number">1.4.1.</span> <span class="nav-text">isa_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#位域-1"><span class="nav-number">1.4.2.</span> <span class="nav-text">位域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#has-assoc-和-weakly-referenced"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">has_assoc 和 weakly_referenced</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如果没有，释放时会更快"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">如果没有，释放时会更快</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ISA-MASK"><span class="nav-number">1.4.3.</span> <span class="nav-text">ISA_MASK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#位运算补充"><span class="nav-number">1.5.</span> <span class="nav-text">位运算补充</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Class-的结构"><span class="nav-number">2.</span> <span class="nav-text">Class 的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#class-rw-t"><span class="nav-number">2.1.</span> <span class="nav-text">class_rw_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#method-array-t"><span class="nav-number">2.1.1.</span> <span class="nav-text">method_array_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#property-array-t"><span class="nav-number">2.1.2.</span> <span class="nav-text">property_array_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#protocol-array-t"><span class="nav-number">2.1.3.</span> <span class="nav-text">protocol_array_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-ro-t"><span class="nav-number">2.2.</span> <span class="nav-text">class_ro_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#method-list-t、ivar-list-t-和-property-list-t"><span class="nav-number">2.2.1.</span> <span class="nav-text">method_list_t、ivar_list_t 和 property_list_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#method-t"><span class="nav-number">2.3.</span> <span class="nav-text">method_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IMP"><span class="nav-number">2.3.1.</span> <span class="nav-text">IMP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SEL"><span class="nav-number">2.3.2.</span> <span class="nav-text">SEL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#types"><span class="nav-number">2.3.3.</span> <span class="nav-text">types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-Encoding"><span class="nav-number">2.3.4.</span> <span class="nav-text">Type Encoding</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方法缓存"><span class="nav-number">2.4.</span> <span class="nav-text">方法缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mask"><span class="nav-number">2.4.1.</span> <span class="nav-text">_mask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#buckets"><span class="nav-number">2.4.2.</span> <span class="nav-text">_buckets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#空间换时间"><span class="nav-number">2.4.3.</span> <span class="nav-text">空间换时间</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#例1："><span class="nav-number">2.4.3.1.</span> <span class="nav-text">例1：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例2："><span class="nav-number">2.4.3.2.</span> <span class="nav-text">例2：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#例3"><span class="nav-number">2.4.3.3.</span> <span class="nav-text">例3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小结"><span class="nav-number">2.4.3.4.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#objc-msgSend"><span class="nav-number">3.</span> <span class="nav-text">objc_msgSend</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSend-执行流程"><span class="nav-number">3.1.</span> <span class="nav-text">objc_msgSend 执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-msgSend-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">_objc_msgSend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lookUpImpOrForward"><span class="nav-number">3.1.2.</span> <span class="nav-text">_lookUpImpOrForward</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#resolveMethod-locked"><span class="nav-number">3.1.3.</span> <span class="nav-text">resolveMethod_locked()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#objc-msgForward-impcache"><span class="nav-number">3.1.4.</span> <span class="nav-text">__objc_msgForward_impcache</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息发送"><span class="nav-number">3.2.</span> <span class="nav-text">消息发送</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态方法解析"><span class="nav-number">3.3.</span> <span class="nav-text">动态方法解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态添加对象方法"><span class="nav-number">3.3.1.</span> <span class="nav-text">动态添加对象方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态添加C语言函数"><span class="nav-number">3.3.2.</span> <span class="nav-text">动态添加C语言函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态添加类方法"><span class="nav-number">3.3.3.</span> <span class="nav-text">动态添加类方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息转发"><span class="nav-number">3.4.</span> <span class="nav-text">消息转发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对象方法的消息转发"><span class="nav-number">3.4.1.</span> <span class="nav-text">对象方法的消息转发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#forwardingTargetForSelector-方法"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">-forwardingTargetForSelector: 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#methodSignatureForSelector-方法"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">-methodSignatureForSelector: 方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类方法的消息转发"><span class="nav-number">3.4.2.</span> <span class="nav-text">类方法的消息转发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#forwardingTargetForSelector-方法-1"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">+forwardingTargetForSelector: 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#methodSignatureForSelector-方法-1"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">+methodSignatureForSelector: 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSInvocation"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">NSInvocation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synthesize、-dynamic"><span class="nav-number">3.4.3.</span> <span class="nav-text">@synthesize、@dynamic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-1"><span class="nav-number">3.4.4.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#super-的本质"><span class="nav-number">4.</span> <span class="nav-text">super 的本质</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-super-结构体"><span class="nav-number">4.1.</span> <span class="nav-text">objc_super 结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSendSuper-方法"><span class="nav-number">4.2.</span> <span class="nav-text">objc_msgSendSuper() 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSendSuper2"><span class="nav-number">4.3.</span> <span class="nav-text">objc_msgSendSuper2()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看汇编代码"><span class="nav-number">4.3.1.</span> <span class="nav-text">查看汇编代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看-LLVM-的中间代码（IR）"><span class="nav-number">4.3.2.</span> <span class="nav-text">查看 LLVM 的中间代码（IR）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-2"><span class="nav-number">4.3.3.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#self、class-和-superclass-的底层实现"><span class="nav-number">4.4.</span> <span class="nav-text">self、class 和 superclass 的底层实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#isKindOfClass-和-isMemberOfClass"><span class="nav-number">4.5.</span> <span class="nav-text">isKindOfClass: 和 isMemberOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#isMemberOfClass-和-isKindOfClass"><span class="nav-number">4.5.1.</span> <span class="nav-text">+isMemberOfClass: 和 +isKindOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-3"><span class="nav-number">4.5.1.1.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isMemberOfClass-和-isKindOfClass-1"><span class="nav-number">4.5.2.</span> <span class="nav-text">-isMemberOfClass: 和 -isKindOfClass:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#小结-4"><span class="nav-number">4.5.2.1.</span> <span class="nav-text">小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象方法的调用原理"><span class="nav-number">4.6.</span> <span class="nav-text">对象方法的调用原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#正常调用"><span class="nav-number">4.6.1.</span> <span class="nav-text">正常调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义调用"><span class="nav-number">4.6.2.</span> <span class="nav-text">自定义调用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Runtime-API"><span class="nav-number">5.</span> <span class="nav-text">Runtime API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#类"><span class="nav-number">5.1.</span> <span class="nav-text">类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#成员变量"><span class="nav-number">5.2.</span> <span class="nav-text">成员变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#属性"><span class="nav-number">5.3.</span> <span class="nav-text">属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方法"><span class="nav-number">5.4.</span> <span class="nav-text">方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拓展"><span class="nav-number">5.5.</span> <span class="nav-text">拓展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#class-rw-ext-t"><span class="nav-number">5.5.1.</span> <span class="nav-text">class_rw_ext_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态添加的属性存到哪了"><span class="nav-number">5.5.2.</span> <span class="nav-text">动态添加的属性存到哪了?</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#动态添加的方法存到哪了"><span class="nav-number">5.5.2.1.</span> <span class="nav-text">动态添加的方法存到哪了?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#method-exchangeImplementations-的实现原理"><span class="nav-number">5.5.3.</span> <span class="nav-text">method_exchangeImplementations 的实现原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用"><span class="nav-number">5.6.</span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看私有成员变量"><span class="nav-number">5.6.1.</span> <span class="nav-text">查看私有成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字典转模型"><span class="nav-number">5.6.2.</span> <span class="nav-text">字典转模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#归档解档"><span class="nav-number">5.6.3.</span> <span class="nav-text">归档解档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#替换方法实现"><span class="nav-number">5.6.4.</span> <span class="nav-text">替换方法实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拦截所有按钮的点击事件"><span class="nav-number">5.6.5.</span> <span class="nav-text">拦截所有按钮的点击事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拦截数组添加数据方法"><span class="nav-number">5.6.6.</span> <span class="nav-text">拦截数组添加数据方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拦截字典添加数据方法"><span class="nav-number">5.6.7.</span> <span class="nav-text">拦截字典添加数据方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kevin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://rawgit.com/qhh0205/78e9e0b1f3114db6737f3ed8cdd51d3a/raw/3894c5be5aa2378336b1f5ee0f296fa0b22d06e9/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '82b6ced795961ee1fcca',
          clientSecret: '4a2f24a39c6fcd85813d80031c6e0262a65404f5',
          repo: 'KevinYangGit.github.io',
          owner: '',
          admin: [''],
          id: md5(location.pathname),
          distractionFreeMode: ''
        })
        gitalk.render('gitalk-container')
    </script>

  





  

  

  

  

  

  

</body>
</html>
